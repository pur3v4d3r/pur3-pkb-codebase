/*! smart-connections-early-release v4.2.4 | (c) 2025 ðŸŒ´ Brian */
var cC=Object.create;var Ti=Object.defineProperty;var lC=Object.getOwnPropertyDescriptor;var dC=Object.getOwnPropertyNames;var _C=Object.getPrototypeOf,uC=Object.prototype.hasOwnProperty;var r=(n,e)=>Ti(n,"name",{value:e,configurable:!0});var ha=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),mC=(n,e)=>{for(var t in e)Ti(n,t,{get:e[t],enumerable:!0})},Gg=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of dC(e))!uC.call(n,i)&&i!==t&&Ti(n,i,{get:()=>e[i],enumerable:!(s=lC(e,i))||s.enumerable});return n};var Y=(n,e,t)=>(t=n!=null?cC(_C(n)):{},Gg(e||!n||!n.__esModule?Ti(t,"default",{value:n,enumerable:!0}):t,n)),pC=n=>Gg(Ti({},"__esModule",{value:!0}),n);var by=ha(Ya=>{"use strict";Ya.byteLength=BC;Ya.toByteArray=WC;Ya.fromByteArray=VC;var et=[],Ce=[],FC=typeof Uint8Array<"u"?Uint8Array:Array,rm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(ys=0,gy=rm.length;ys<gy;++ys)et[ys]=rm[ys],Ce[rm.charCodeAt(ys)]=ys;var ys,gy;Ce[45]=62;Ce[95]=63;function yy(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(yy,"getLens");function BC(n){var e=yy(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(BC,"byteLength");function UC(n,e,t){return(e+t)*3/4-t}r(UC,"_byteLength");function WC(n){var e,t=yy(n),s=t[0],i=t[1],o=new FC(UC(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Ce[n.charCodeAt(l)]<<18|Ce[n.charCodeAt(l+1)]<<12|Ce[n.charCodeAt(l+2)]<<6|Ce[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Ce[n.charCodeAt(l)]<<2|Ce[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Ce[n.charCodeAt(l)]<<10|Ce[n.charCodeAt(l+1)]<<4|Ce[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(WC,"toByteArray");function GC(n){return et[n>>18&63]+et[n>>12&63]+et[n>>6&63]+et[n&63]}r(GC,"tripletToBase64");function HC(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(GC(s));return i.join("")}r(HC,"encodeChunk");function VC(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(HC(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(et[e>>2]+et[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(et[e>>10]+et[e>>4&63]+et[e<<2&63]+"=")),i.join("")}r(VC,"fromByteArray")});var Yw=ha(Gl=>{"use strict";Gl.byteLength=cj;Gl.toByteArray=dj;Gl.fromByteArray=mj;var rt=[],je=[],aj=typeof Uint8Array<"u"?Uint8Array:Array,Lp="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Ns=0,Jw=Lp.length;Ns<Jw;++Ns)rt[Ns]=Lp[Ns],je[Lp.charCodeAt(Ns)]=Ns;var Ns,Jw;je[45]=62;je[95]=63;function Kw(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(Kw,"getLens");function cj(n){var e=Kw(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(cj,"byteLength");function lj(n,e,t){return(e+t)*3/4-t}r(lj,"_byteLength");function dj(n){var e,t=Kw(n),s=t[0],i=t[1],o=new aj(lj(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=je[n.charCodeAt(l)]<<18|je[n.charCodeAt(l+1)]<<12|je[n.charCodeAt(l+2)]<<6|je[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=je[n.charCodeAt(l)]<<2|je[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=je[n.charCodeAt(l)]<<10|je[n.charCodeAt(l+1)]<<4|je[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(dj,"toByteArray");function _j(n){return rt[n>>18&63]+rt[n>>12&63]+rt[n>>6&63]+rt[n&63]}r(_j,"tripletToBase64");function uj(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(_j(s));return i.join("")}r(uj,"encodeChunk");function mj(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(uj(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(rt[e>>2]+rt[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(rt[e>>10]+rt[e>>4&63]+rt[e<<2&63]+"=")),i.join("")}r(mj,"fromByteArray")});var A1=ha(L_=>{"use strict";L_.byteLength=rI;L_.toByteArray=cI;L_.fromByteArray=_I;var ut=[],Pe=[],oI=typeof Uint8Array<"u"?Uint8Array:Array,df="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Ks=0,x1=df.length;Ks<x1;++Ks)ut[Ks]=df[Ks],Pe[df.charCodeAt(Ks)]=Ks;var Ks,x1;Pe[45]=62;Pe[95]=63;function E1(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(E1,"getLens");function rI(n){var e=E1(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(rI,"byteLength");function aI(n,e,t){return(e+t)*3/4-t}r(aI,"_byteLength");function cI(n){var e,t=E1(n),s=t[0],i=t[1],o=new oI(aI(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Pe[n.charCodeAt(l)]<<18|Pe[n.charCodeAt(l+1)]<<12|Pe[n.charCodeAt(l+2)]<<6|Pe[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Pe[n.charCodeAt(l)]<<2|Pe[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Pe[n.charCodeAt(l)]<<10|Pe[n.charCodeAt(l+1)]<<4|Pe[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(cI,"toByteArray");function lI(n){return ut[n>>18&63]+ut[n>>12&63]+ut[n>>6&63]+ut[n&63]}r(lI,"tripletToBase64");function dI(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(lI(s));return i.join("")}r(dI,"encodeChunk");function _I(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(dI(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(ut[e>>2]+ut[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(ut[e>>10]+ut[e>>4&63]+ut[e<<2&63]+"=")),i.join("")}r(_I,"fromByteArray")});var NS=ha(Cu=>{"use strict";Cu.byteLength=TM;Cu.toByteArray=PM;Cu.fromByteArray=LM;var ht=[],Ie=[],jM=typeof Uint8Array<"u"?Uint8Array:Array,Kf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(en=0,jS=Kf.length;en<jS;++en)ht[en]=Kf[en],Ie[Kf.charCodeAt(en)]=en;var en,jS;Ie[45]=62;Ie[95]=63;function TS(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(TS,"getLens");function TM(n){var e=TS(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(TM,"byteLength");function NM(n,e,t){return(e+t)*3/4-t}r(NM,"_byteLength");function PM(n){var e,t=TS(n),s=t[0],i=t[1],o=new jM(NM(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Ie[n.charCodeAt(l)]<<18|Ie[n.charCodeAt(l+1)]<<12|Ie[n.charCodeAt(l+2)]<<6|Ie[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Ie[n.charCodeAt(l)]<<2|Ie[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Ie[n.charCodeAt(l)]<<10|Ie[n.charCodeAt(l+1)]<<4|Ie[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(PM,"toByteArray");function IM(n){return ht[n>>18&63]+ht[n>>12&63]+ht[n>>6&63]+ht[n&63]}r(IM,"tripletToBase64");function MM(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(IM(s));return i.join("")}r(MM,"encodeChunk");function LM(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(MM(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(ht[e>>2]+ht[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(ht[e>>10]+ht[e>>4&63]+ht[e<<2&63]+"=")),i.join("")}r(LM,"fromByteArray")});var hL={};mC(hL,{default:()=>Wu});module.exports=pC(hL);var zg=require("obsidian");var tp=Y(require("obsidian"),1);var vt=require("obsidian");var fa=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var ga=class extends fa{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var ds=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new ga(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};async function hC(n,e={}){let t=Object.entries(n.settings_config).map(([o,a])=>(a.setting||(a.setting=o),this.render_setting_html(a))).join(`
`),s=Object.entries(n.collections).map(([o,a])=>`<div data-smart-settings="${o}"></div>`).join(`
`);return`
<div class="">
${t}
${s}
</div>
`}r(hC,"build_html");async function Hg(n,e={}){let t=await hC.call(this,n,e),s=this.create_doc_fragment(t);return await fC.call(this,n,s,e)}r(Hg,"render");async function fC(n,e,t={}){await this.render_setting_components(e,{scope:n});let s=e.querySelectorAll("[data-smart-settings]");for(let i of s){let o=i.dataset.smartSettings;await n[o].render_settings(i)}return e}r(fC,"post_process");var ya=class{static{r(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let s=new this(e,t);return await s.load(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}static create_sync(e,t={}){let s=new this(e,t);return s.load_sync(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}get settings(){return gC(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",yC(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function gC(n,e){let t=new WeakMap,s=new WeakMap,i=r((a,c)=>{if(!Vu(a)||s.has(a))return a;if(t.has(a))return t.get(a);let l=o(a,c);return t.set(a,l),s.set(l,a),l},"wrap_value"),o=r((a,c)=>new Proxy(a,{set(l,d,_){let u=[...c,d],p=Hu(l[d]),f=Hu(_);return l[d]=i(_,u),bC(p,f)&&e({type:"set",path:u,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],u=Hu(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:u}),!0}}),"create_proxy");return i(n,[])}r(gC,"observe_object");function yC(n){let e=Array.isArray(n.path)?n.path:[];return{type:n.type,path:e,path_string:e.join("."),value:n.value,previous_value:n.previous_value}}r(yC,"build_settings_changed_event");function Hu(n){if(!Vu(n))return n;if(typeof structuredClone=="function")try{return structuredClone(n)}catch{}try{return JSON.parse(JSON.stringify(n))}catch{return n}}r(Hu,"snapshot_value");function bC(n,e){return Vg(n)!==Vg(e)}r(bC,"has_changed");function Vg(n){if(n===void 0)return"undefined";if(Number.isNaN(n))return"number:NaN";if(n===1/0)return"number:Infinity";if(n===-1/0)return"number:-Infinity";if(!Vu(n))return`${typeof n}:${String(n)}`;try{return`object:${JSON.stringify(n)}`}catch{return`object:${String(n)}`}}r(Vg,"serialize_value");function Vu(n){return typeof n=="object"&&n!==null}r(Vu,"is_observable");function Xe(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Jg(e[t])&&Jg(n[t])?Xe(n[t],e[t]):n[t]=e[t]);return n}r(Xe,"deep_merge");function Jg(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Jg,"is_plain_object");function be(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(be,"camel_case_to_snake_case");function Kg(n){return n.collections||(n.collections={}),n.modules||(n.modules={}),n.items||(n.items={}),Object.entries(n.collections).forEach(([e,t])=>{typeof t=="function"&&(n.collections[e]={class:t});let s=be(e);s!==e&&(n.collections[s]=n.collections[e],delete n.collections[e]),n.collections[s].collection_key||(n.collections[s].collection_key=s),t.item_type&&(n.items[t.item_type.key||be(t.item_type.name)]={class:t.item_type})}),Object.entries(n.modules).forEach(([e,t])=>{typeof t=="function"&&(n.modules[e]={class:t});let s=be(e);s!==e&&(n.modules[s]=n.modules[e],delete n.modules[e])}),n.item_types||(n.item_types={}),n.items||(n.items={}),Object.entries(n.item_types).forEach(([e,t])=>{if(typeof t=="function"){let s=be(e);n.items[s]={class:t,actions:{},...n.items[s]||{}}}}),n}r(Kg,"normalize_opts");function vC(n){if(!n||typeof n!="object")return!1;let e=Object.getPrototypeOf(n);return e===Object.prototype||e===null}r(vC,"is_plain_object");function ba(n){if(Array.isArray(n))return n.map(e=>ba(e));if(vC(n)){let e={};for(let[t,s]of Object.entries(n))e[t]=ba(s);return e}return n}r(ba,"deep_clone_config");function rn(n,e){let t=Yg(n),s=Yg(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(rn,"compare_versions");function Yg(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(Yg,"normalize_version_value");function Ni(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Ni,"is_plain_object");function gt(n,e,t=[]){if(!Ni(n)||!Ni(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Ni(i)?(Ni(n[s])||(n[s]={}),gt(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(gt,"deep_merge_no_overwrite");function _s(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(rn(d,_)>0){let p={...c};gt(p,l),n.collections[a]=p}else gt(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;rn(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):gt(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),gt(n[i],o)):n[i]=o}return n}r(_s,"merge_env_config");function Xg(n={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:s}=n;return(e!==void 0||t!==void 0||s!==void 0)&&(n.smart_sources=n.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!n.smart_sources?.file_exclusions?.length||n.smart_sources?.file_exclusions==="Untitled")&&(n.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!n.smart_sources.folder_exclusions?.length&&(n.smart_sources.folder_exclusions=t),s!==void 0&&s.length&&!n.smart_sources.excluded_headings?.length&&(n.smart_sources.excluded_headings=s)),delete n.file_exclusions,delete n.folder_exclusions,delete n.excluded_headings,n}r(Xg,"migrate_exclusion_settings_2025_08_22");var kC=typeof globalThis<"u"?globalThis:Function("return this")(),Pi=class{static{r(this,"SmartEnv")}static version="2.2.4";scope_name="smart_env";static global_ref=kC;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=ds.create(this,xC(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([s])=>this.primary_main_key&&s===this.primary_main_key?-1:0);for(let[s,i]of t){if(!i?.main){console.warn(`SmartEnv: '${s}' unloaded, skipping`),delete this.smart_env_configs[s];continue}if(!i?.opts){console.warn(`SmartEnv: '${s}' opts missing, skipping`);continue}_s(this._config,ba(Kg(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:s}=t||{};if(s)for(let[i,o]of Object.entries(s.collections||{})){let a=o?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:rn(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,wC(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let s=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(s),t(this.global_env))},1e3)}else{let s=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(s),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let s={};this.global_env&&rn(this.version,this.global_env.constructor?.version||0)>0&&(s.primary_main_key=be(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(s);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let s=be(e.constructor.name);this.smart_env_configs[s]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:r(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await ya.create(this),this.config.default_settings&&gt(this.settings,this.config.default_settings),Xg(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:s}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let s=e.collections[t]?.class;s&&(s.default_settings&&gt(this.settings,{[t]:s.default_settings}),typeof s.init=="function"&&(await s.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((s,i)=>{let o=this.config.collections?.[s]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return o-a});for(let s of t){let i=Date.now();typeof this[s]?.process_load_queue=="function"&&(await this[s].process_load_queue(),this[s].load_time_ms=Date.now()-i,this.collections[s]="loaded",console.log(`Loaded ${this[s].collection_key} in ${this[s].load_time_ms}ms`))}}static unload_main(e){let t=be(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let s=this.opts.modules[e];return s?(t={...s,class:null,...t},new s.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||Hg}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,s={}){let i=this.get_component(e,t);return i?await i(t,s):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let s=t.collection_key??t.scope_name,i=s?`${s}-${e}`:e;if(!this._components[i])try{if(this.opts.components[s]?.[e]){let o=this.opts.components[s][e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let o=this.opts.components[e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${s}`)}catch(o){console.error("Error getting component",o),console.log(`scope_name: ${s}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[s]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.opts.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(s=>s.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let s=e.map(i=>{let o=i.split("/").slice(-2,-1)[0];return{dir:o,count:this.fs.file_paths.filter(a=>a.includes(o)).length}});t=s.reduce((i,o)=>o.count>i.count?o:i,s[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(Xe(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(s=>s.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((s,i,o)=>o.indexOf(s)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function wC(n){return{items:Object.fromEntries(Object.entries(n.items||{}).map(([e,t])=>[e,t.data]))}}r(wC,"collection_to_plain");function xC(n){if(!n)return{};if(typeof n=="function")return{adapter_class:n};let e=n.adapter_class||n.adapter;return e?{adapter_class:e}:{}}r(xC,"build_events_opts");function EC(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=SC(n,t),o=AC(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(EC,"create_regex");function AC(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(AC,"adjust_for_windows_paths");function SC(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(SC,"glob_to_regex_pattern");function Zg(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:EC(n,s)}r(Zg,"glob_to_regex");function Qg(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(Qg,"fuzzy_search");var va=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(Zg(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return Qg(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var CC=Y(require("obsidian"),1);var ka=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=CC,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function wa(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(wa,"empty");var ey=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var ty=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var qC=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,xa=r((n,e)=>{let t=e.trim();(qC.test(t)?ty:ey)(n,t)},"safe_inner_html");function Le(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(Le,"escape_html");function sy(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=an(l,o),l=Ju(l,15),l=an(l,a),i^=l,i=Ju(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=an(l,o),l=Ju(l,15),l=an(l,a),i^=l;break}return i^=n.length,i=OC(i),i|0}r(sy,"murmur_hash_32");function te(n,e=0){return(sy(n,e)>>>0).toString(36)}r(te,"murmur_hash_32_alphanumeric");function an(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(an,"multiply_32");function Ju(n,e){return n<<e|n>>>32-e}r(Ju,"rotate_left_32");function OC(n){return n^=n>>>16,n=an(n,2246822507),n^=n>>>13,n=an(n,3266489909),n^=n>>>16,n|0}r(OC,"fmix_32");function Ku(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(Ku,"convert_to_time_ago");function us(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(us,"cos_sim");function Ae(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(Ae,"get_by_path");function Se(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(Se,"set_by_path");function Yu(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(Yu,"delete_by_path");function Xu(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(Xu,"compute_centroid");function Zu(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);s[a]+=u,s[l]+=u}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(Zu,"compute_medoid");var Ea=new WeakMap,Aa=new WeakMap,Sa=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return Ae(e,t,s)}set_by_path(e,t,s,i=null){Se(e,t,s,i)}delete_by_path(e,t,s=null){Yu(e,t,s)}escape_html(e){return Le(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||Aa.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");Aa.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=Aa.get(i);c&&(i.removeEventListener("change",c),Aa.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=te(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){wa(e)}safe_inner_html(e,t){xa(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=Ea.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},Ea.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}Ea.get(e)===c&&Ea.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var Ca=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===s,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let w=document.createElement("div");w.className="array-item-row";let x=document.createElement("input");x.type="text",x.value=y,x.placeholder="Value";let b=document.createElement("button");b.textContent="\u2715",b.title="Remove",x.addEventListener("change",()=>{c[g]=x.value,f()}),b.addEventListener("click",()=>{c.splice(g,1),d(),f()}),w.appendChild(x),w.appendChild(b),l.appendChild(w)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=u.value.trim();y&&(c.push(y),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,w],x)=>{let b=document.createElement("div");b.className="json-pair-row";let C=document.createElement("input");C.type="text",C.value=g,C.placeholder="Property";let k=document.createElement("input");k.type="text",k.value=w,k.placeholder="Value";let A=document.createElement("button");A.textContent="\u2715",A.title="Remove",C.addEventListener("change",()=>{let q=C.value.trim();q&&q!==g&&(c[q]=c[g],delete c[g],d(),y())}),k.addEventListener("change",()=>{c[C.value]=k.value,y()}),A.addEventListener("click",()=>{delete c[C.value],d(),y()}),b.appendChild(C),b.appendChild(k),b.appendChild(A),l.appendChild(b)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),y())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){wa(e)}safe_inner_html(e,t){xa(e,t)}};var Ze=require("obsidian");var qa=class extends Ca{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return Ze.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new Ze.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await Ze.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,Ze.getIcon)(e).outerHTML}is_mod_event(e){return Ze.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function Oa(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Oa,"collection_instance_name_from");function ny(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(ny,"create_uid");function $a(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>$a(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>$a(n[o],e[o],t))}return n===e}r($a,"deep_equal");function ja(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(ja,"get_item_display_name");function Ta(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let v of Reflect.ownKeys(m)){let j=Object.getOwnPropertyDescriptor(m,v);if(!j)continue;let E={...j};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let v=!1;for(let j of h){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E){let $=E.value;if(c($)){v=!0;continue}if(s($)){if(_($)){v=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),v=new Map;for(let j of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E&&_(E.value)){v.set(j,d(E.value));continue}try{Object.defineProperty(h,j,u(E))}catch{h[j]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),w=Object.create(null),x=r((m,h,v=[])=>{if(!m||!h)return;let j=new Set([...l,...v]);for(let E of Reflect.ownKeys(m)){if(j.has(E))continue;let $=Object.getOwnPropertyDescriptor(m,E);if($)try{Object.defineProperty(h,E,$)}catch{h[E]=$.value}}},"copy_metadata"),b=r(m=>{let h=new m(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let j=v.bind(h);return x(m,j),x(h,j),j.instance=h,j}return x(m,h),h},"instantiate_class"),C=r(m=>{if(o(m))return b(m);if(a(m)){let h=m.action.bind(n);return x(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return x(m,h),h}return s(m)?d(m):m},"bind_or_clone"),k=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&s(h)?h:null},"scope_actions_for"),A=r((m,h,v)=>(m[h]=v,v),"cache_result"),q=r((m,h)=>{let v=k();return v&&g(v,h)?A(m,h,C(v[h])):g(f,h)?A(m,h,C(f[h])):A(m,h,void 0)},"compute_and_cache"),O=r(()=>{let m=k(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(m)for(let v of Reflect.ownKeys(m))h.add(v);return Array.from(h)},"union_keys"),S=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(w,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:q(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let v=k();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return S(m,h);let v=k();if(v&&g(v,h)||g(f,h))return g(m,h)||q(m,h),S(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,v)=>"value"in v?(m[h]=v.value,!0):!1,"defineProperty"),set:r((m,h,v)=>(m[h]=v,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(Ta,"create_actions_proxy");var se=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Xe(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return ny(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return Xe(s,t),!$a(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Ta(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Oa(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Oa(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),be(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return ja(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var $C=Object.getPrototypeOf(async function(){}).constructor,ne=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof $C?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Xe(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Ta(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var Na=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},Pa=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function Ia(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=iy(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=iy(n.results);n.min=s,n.minResult=i}}r(Ia,"results_acc");function ry(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=oy(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=oy(n.results);n.max=s,n.maxResult=i}}r(ry,"furthest_acc");function iy(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(iy,"find_min");function oy(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(oy,"find_max");function ze(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(ze,"sort_by_score");function Ma(n,e){return ze(n,e)}r(Ma,"sort_by_score_descending");function ay(n,e){return ze(n,e)*-1}r(ay,"sort_by_score_ascending");var La=class extends Na{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:us(e,a.vec)};return Ia(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(Ma)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:us(e,a.vec)};return ry(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(ay)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},za=class extends Pa{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var jC="---frontmatter---",cy=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),TC=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),NC=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),PC=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(jC),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),IC=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=cy(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=cy(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),Qu=r((n,e={})=>{let t=TC(n,e),s=NC(t),i=PC(s);return IC(i,n)},"create_find_connections_filter_opts");async function cn(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=Qu(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+te(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(ze).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(cn,"find_connections");cn.action_type="connections";var ms=class extends se{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new za(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var ps=class extends ne{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new La(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(ze).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return ly}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return MC}},ly={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},MC={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function em(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await cn.call(this,n);let o=Qu(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+te(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(ze).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(ze).slice(0,s)}return i}r(em,"find_connections");em.action_type="connections";var ln=class extends ms{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=Xu(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=Zu(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},dy={class:ln,actions:{find_connections:em}};var Ii=class extends ps{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(ze)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(LC),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},LC={};var Ra=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Mi;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Mi=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Da=class extends Ra{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Li;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Li=class extends Mi{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var _y={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Pt=class extends Da{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=yt;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},yt=class extends Li{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+u]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(u);if(d.key||(d.key=u),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return _y[s]&&(s=_y[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var zi=class extends Pt{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=tm},tm=class extends yt{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var Fa=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return te(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return uy(this.constructor.name)}static get adapter_key(){return uy(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function uy(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(uy,"to_snake");function Ba(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},y=null,g=null,w=!1,x=!1,b="#",C=!1,k=[],A=null;_[b]=0;for(let O=0;O<i.length;O++){let S=O+t,m=i[O],h=m.trim();if(h==="---"){if(!x&&S===1){x=!0,w=!0,l["#---frontmatter---"]=[S,null];continue}else if(w){w=!1,l["#---frontmatter---"][1]=S;continue}}if(w)continue;if(!C&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(S),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(S)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(S)),h.startsWith("```")){if(C=!C,C&&!A?A=S:!C&&A&&(k.push([A,S]),A=null),!g){let E=c.length>0?c[c.length-1].key:b;if(E===b&&!l[b]&&(l[b]=[S,null]),E===b)g={key:b,start_line:S},(l[b][1]===null||l[b][1]<S)&&(l[b][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let $=_[E],N=`${E}#{${$}}`;l[N]=[S,null],g={key:N,start_line:S}}}continue}let v=h.match(/^(#{1,6})\s*(.+)$/);if(v&&!C){let E=v[1].length,$=v[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=S-1)}c.length===0&&l[b]&&l[b][1]===null&&(l[b][1]=S-1),g&&(l[g.key][1]===null&&(l[g.key][1]=S-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null);let N="",M=0;if(c.length>0?(N=c[c.length-1].key,M=c[c.length-1].level):(N="",M=0),c.length===0)d[$]=(d[$]||0)+1,d[$]>1&&($+=`[${d[$]}]`);else{u[N]||(u[N]={}),u[N][$]=(u[N][$]||0)+1;let X=u[N][$];X>1&&($+=`#{${X}}`)}let ue=E-M,ge="#".repeat(ue),ye=N+ge+$;l[ye]=[S,null],_[ye]=0,c.push({level:E,title:$,key:ye});continue}let j=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(j&&!C){if(j[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null),g&&g.key!==b&&(l[g.key][1]===null&&(l[g.key][1]=S-1),g=null);let $=c.length>0?c[c.length-1].key:b;$===b&&!l[b]&&(l[b]=[S,null]),_[$]===void 0&&(_[$]=0),_[$]+=1;let N=_[$],M;if(s){let ue=j[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=zC(ue,o);M=`${$}#${ge}`}else M=`${$}#{${N}}`;l[M]=[S,null],y={key:M,start_line:S};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null);let E=c.length>0?c[c.length-1].key:b;if(E===b)l[b]||(l[b]=[S,null]),(l[b][1]===null||l[b][1]<S)&&(l[b][1]=null),g={key:b,start_line:S};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let $=_[E],N=`${E}#{${$}}`;l[N]=[S,null],g={key:N,start_line:S}}}}let q=i.length;for(;c.length>0;){let O=c.pop();l[O.key][1]===null&&(l[O.key][1]=q+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=q+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=q+t-1),g=null),l[b]&&l[b][1]===null&&(l[b][1]=q+t-1);for(let O in l)a[O]=l[O];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:k}}r(Ba,"parse_markdown_blocks");function zC(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(zC,"get_longest_words_in_order");var It=class extends Fa{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=Ba(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);s==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:u,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let w=this.item.block_collection.get(u);if(await this.create_hash(p)!==w.last_read?.hash){o.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function Ua(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,u=o(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(Ua,"get_markdown_links");function sm(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(sm,"parse_value");function RC(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=sm(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(sm(u)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=sm(c)}return t}r(RC,"parse_yaml_block");function my(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=RC(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(my,"parse_frontmatter");var py=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Ri=class extends It{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!!e)return Ua(e)}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=my(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),py(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Mt=require("obsidian");function DC(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(DC,"merge_tags");var hs=class extends Ri{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=DC(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!Mt.MarkdownRenderer||!Mt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Mt.MarkdownRenderer.render(s,t,i,this.item.path,new Mt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Mt.htmlToMarkdown)(i)}};var Wa=class extends It{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var Ga=class extends It{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){}};var Ha=class extends hs{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function hy(n,e){let[t,...s]=n.split("#").filter(Boolean),i=ja(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(hy,"get_block_display_name");var dn=class extends ms{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return hy(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},fy={class:dn,actions:{find_connections:cn}};var Di=class extends ps{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var Va=class extends Pt{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=nm;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},nm=class extends yt{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var Ja=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return te(e)}};function Ka(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(Ka,"get_line_range");var _n=class extends Ja{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return Ka(e,t,s)}async _reparse_source(){await this.item.source.import()}};var un=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Fi=class extends un{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var mn=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var fs=class extends mn{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var Qe=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var pn=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},hn=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var fn=class extends pn{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new im(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},im=class extends hn{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var gs=class extends pn{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new om(i)}},om=class extends hn{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var vy=Y(by(),1);var JC=Object.defineProperty,KC=r((n,e,t)=>e in n?JC(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),YC=r((n,e,t)=>(KC(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function XC(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(XC,"bytePairMerge");function ZC(n,e){return n.length===1?[e.get(n.join(","))]:XC(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(ZC,"bytePairEncode");function QC(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(QC,"escapeRegex");var am=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=vy.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=am.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=am.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??n.length;for(let f of n.substring(l,u).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...ZC(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},Xa=am;YC(Xa,"specialTokenRegex",n=>new RegExp(n.map(e=>QC(e)).join("|"),"g"));async function wy(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await ky(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await ky(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(wy,"fetch_json_cached");async function ky(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(ky,"do_fetch");function lm(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(lm):e==="object"?Object.values(n).every(lm):!1}r(lm,"is_json_compatible");function Za(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||lm(i)&&(t[s]=i);return t}r(Za,"extract_json_details");function Bi(n){return Object.keys(n).length===0}r(Bi,"is_empty_object");function e2(n,e){return Bi(n)?e:Bi(e)?n:{...n,...e}}r(e2,"merge_details");function cm(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(cm,"get_message_from_object");function Z(n,e=null){if(Array.isArray(n)&&n.length>0)return Z(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Za(n,["message"]);return{message:t,details:Bi(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=cm(o),c=Za(o,["message"]),l=Za(t,["message","error"]),d=e2(l,c);return{message:a||cm(t)||"Unknown error",details:Bi(d)?null:d,http_status:e}}return Z(i)}let s=cm(t);if(s){let i=Za(t,["message"]);return{message:s,details:Bi(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(Z,"normalize_error");var t2="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",tt=class extends fs{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Re}get res_adapter(){return De}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Qe({adapter:gs})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:Z(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await wy(t2,"cl100k_base.json");this.tiktoken=new Xa(e)}},Re=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},De=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Qa=class extends tt{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return dm}get res_adapter(){return _m}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},dm=class extends Re{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},_m=class extends De{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var ec=class extends fs{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var tc=class extends ec{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var xy=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var Ey={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:um};var um={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},Ay={},mm={};var gn=class extends tc{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=Ey;constructor(e){super(e),this.connector=xy.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...Ay}}get_models(){return Promise.resolve(this.models)}get models(){return um}};var sc=class extends tt{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{},model_key:"nomic-embed-text"};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return pm}get res_adapter(){return hm}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of n2(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},pm=class extends Re{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},hm=class extends De{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},s2=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),n2=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(s2)},"filter_embedding_models");var nc=class extends tt{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return fm}get res_adapter(){return gm}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"models/gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}},fm=class extends Re{static{r(this,"SmartEmbedGeminiRequestAdapter")}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},gm=class extends De{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:500})}};function i2(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(i2,"parse_lm_studio_models");var ic=class extends tt{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return ym}get res_adapter(){return bm}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return i2(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},ym=class extends Re{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},bm=class extends De{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Ui=class extends un{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw Z(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var oc=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#e(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#r.bind(this)),this.xhr.addEventListener("error",this.#t.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#e(this.CLOSED))}#e(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#t(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#t(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#e(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#r(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#e(this.CLOSED)}};var rc=class extends mn{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var yn={},Lt={data:null,fetched_at:0},D=class extends rc{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return F}get res_adapter(){return L}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Qe({adapter:gs})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Lt.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=Z(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new oc(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=Z({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=Z(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=Z(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Lt?.data&&t-Lt?.fetched_at<e)return Lt.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Lt.data=o,Lt.fetched_at=t,console.log({MODELS_DEV_CACHE:Lt}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Lt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return yn[this.constructor.key]||(yn[this.constructor.key]={}),yn[this.constructor.key]}set model_data(e){yn[this.constructor.key]||(yn[this.constructor.key]={}),yn[this.constructor.key]=e}},F=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},L=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Wi=class extends D{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Gi}res_adapter=Hi;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Gi=class extends F{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Hi=class extends L{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var o2=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],bs=class extends D{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=vm;parse_model_data(e){return e.data.filter(t=>!o2.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:r2(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function r2(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(r2,"get_max_input_tokens");var vm=class extends L{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Vi=class extends bs{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var bn=class extends D{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Ji;res_adapter=Ki;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Ji=class extends F{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Ki=class extends L{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:Z(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},Yi=class extends bn{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var Xi=class extends D{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return km}get res_adapter(){return wm}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},km=class extends F{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},wm=class extends L{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Zi=class extends D{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Qi}get res_adapter(){return eo}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Qi=class extends F{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},eo=class extends L{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var to=class extends D{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=so;res_adapter=no;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},so=class extends F{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},no=class extends L{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var xm={openai:{req:F,res:L},anthropic:{req:Gi,res:Hi},gemini:{req:Ji,res:Ki},lm_studio:{req:Qi,res:eo},ollama:{req:so,res:no}},io=class extends D{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=xm[e];return t&&t.req?t.req:F}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=xm[e];return t&&t.res?t.res:L}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(xm).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var oo=class extends D{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Em}get res_adapter(){return Am}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},Em=class extends F{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Am=class extends L{static{r(this,"SmartChatModelGroqResponseAdapter")}};var ro=class extends D{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return F}get res_adapter(){return L}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var ao=class extends D{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Sm}get res_adapter(){return Cm}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Sm=class extends F{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Cm=class extends L{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var Wm=require("obsidian");function Sy(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=Ba(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),u=Ka(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=Ua(u),f={key:d,lines:l,size:u.length,outlinks:p,last_read:{at:a,hash:te(u)}};if(!_||_?.data.last_read?.hash!==f.last_read.hash){let y=new n.block_collection.item_type(n.env,f);n.block_collection.set(y)}else _.data={..._.data,...f}}a2(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(Sy,"parse_blocks");function a2(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(a2,"clean_and_update_source_blocks");function qm(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():Cy(a)?n[o]=qm(Cy(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(qm,"ajson_merge");function Cy(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(Cy,"is_object");var qy={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function c2(n){let e=!1,[t,...s]=n.split(":");return qy[t]&&(t=qy[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(c2,"_parse_ajson_key");var zt=class extends Pt{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:y,item_key:g,changed:w}=c2(p),x=`${y}:${g}`;f?(i[x]=f,(w||x!==p)&&(delete i[p],t=!0)):(delete i[x],(w||x!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=qm(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Om=class extends yt{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},co={collection:zt,item:Om};var lo=class extends se{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function l2(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(l2,"parse_component_properties");async function d2(n,e){let{scope_key:t,component_key:s}=l2(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await te(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(d2,"build_component_data");var ac=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await d2(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var cc=class extends ac{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function Oy(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&Oy(i,o,t)}}),t}r(Oy,"flatten_components_config");var lc=class extends ne{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=Oy(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},$y={class:lc,item_type:lo,data_adapter:co,component_adapters:{SmartViewComponentAdapter:cc}};var jy=$y;function Ty(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(Ty,"filter_redundant_context_items");var _o=class extends se{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e){!e||!this.data?.context_items?.[e]||(this.data.context_items[e].folder?this.data.context_items[e].exclude=!0:delete this.data.context_items[e],this.queue_save(),this.emit_event("context:updated",{removed_key:e}))}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,s):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this.on_event("context:updated",()=>{this._context_items=null})}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return Ty(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var dc=class extends ne{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var _2={class:dc,data_adapter:zt,item_type:_o};var Ny=_2;var _c=class extends se{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var st=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var uc=class extends st{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var mc=class extends st{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var Py=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var pc=class extends st{static{r(this,"ImageContextItemAdapter")}static detect(e){return Py.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var hc=class extends st{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var $m=class extends ne{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},Iy={version:1,class:$m,collection_key:"context_items",item_type:_c,context_item_adapters:{BlockContextItemAdapter:uc,SourceContextItemAdapter:mc,ImageContextItemAdapter:pc,PdfContextItemAdapter:hc}};function My(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(My,"next_log_stats");var vn=class extends se{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var u2={"collection:save_started":!0,"collection:save_completed":!0},jm=class extends ne{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return vn}init(){this.env?.events||ds.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!u2[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new vn(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=My({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},Ly={class:jm,collection_key:"event_logs",data_adapter:zt,item_type:vn};var vs=require("obsidian");var fc=class extends vs.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available"}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&this.selectActiveSuggestion(t);let s=this.inputEl.selectionStart===this.inputEl.value.length;if(t.target!==this.inputEl||!this.inputEl.value||s||vs.Keymap.isModEvent(t)){if(t.key==="ArrowLeft"){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&(s||t.target!==this.inputEl||!this.inputEl.value)){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return this.default_suggest_action_keys.map(e=>{let t=this.env.config.actions[e];if(!t)return null;let s=t.display_name||e;return{select_action:r(()=>{this.update_suggestions(e)},"select_action"),key:e,display:s}}).filter(Boolean)}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e))}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,vs.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=vs.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let l=this.inputEl.value.length;this.inputEl.setSelectionRange(l,l)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):c&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var BB=require("obsidian");var gc=class extends fc{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var zy=require("obsidian");var yc=class extends zy.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var Ry=require("obsidian");var bc=class extends Ry.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Milestones"),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var Dy={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var uo=class extends se{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var vc=class extends ne{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function Fy(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(Fy,"settings_config");var ks=class extends uo{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Tm=class extends vc{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var m2={class:Tm,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:co,item_type:ks,providers:{},settings_config:Fy},Nm=m2;var Pm=class extends gn{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"intfloat/multilingual-e5-small":{id:"intfloat/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},By={class:Pm,settings_config:mm};Nm.providers={transformers:By};var Uy=Nm;var Rt=class extends se{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(Ia(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(Ma);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};function Wy(n){return{type:"heading",name:`${n}`}}r(Wy,"create_settings_section_heading");var Gy={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},Im=class extends ne{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=p2(new Date),i=te(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new Rt(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...Gy}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function p2(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(p2,"format_ymd");var Hy={class:Im,collection_key:"lookup_lists",item_type:Rt,settings_config:Gy};function mo(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(mo,"format_collection_name");async function h2(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${mo(n.collection_key)}</h2>
${t}
</div></div></div>`}r(h2,"build_html");async function Vy(n,e={}){let t=await h2.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(Vy,"render");var kn=require("obsidian");function Jy(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(kn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new kn.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");kn.MarkdownRenderer.render(o,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(Jy,"register_block_hover_popover");var Ky=require("obsidian");function kc(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),Ky.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):Jy(n.parentElement,n,e.env,e.key)}r(kc,"register_item_hover_popover");var Xy=require("obsidian");function f2(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(f2,"format_score");function g2(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(g2,"format_size");function Yy(n,e){return n?`<span class="${e}">${n}</span>`:""}r(Yy,"build_badge_html");function y2(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=f2(n?.data?.score),i=g2(n?.size||n?.data?.size),o=Yy(s,"sc-context-item-score"),a=Yy(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(y2,"build_html");async function Zy(n,e={}){let t=y2(n,e),i=this.create_doc_fragment(t).firstElementChild;return b2.call(this,n,i,e),i}r(Zy,"render");async function b2(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${Xy.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),kc(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(b2,"post_process");async function v2(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${mo(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=w2(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(v2,"build_html");async function Qy(n,e={}){let t=await v2.call(this,n,e),s=this.create_doc_fragment(t);return await k2.call(this,n,s,e)}r(Qy,"render");async function k2(n,e,t={}){return e}r(k2,"post_process");function w2(n,e){let t=Object.values(n.items).length,s=mo(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=x2(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=E2(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(w2,"generate_collection_stats");function x2(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(x2,"get_generic_collection_stats");function E2(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(E2,"calculate_embed_coverage");var eb=require("obsidian");function A2(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(A2,"build_html");async function Mm(n,e={}){let t=A2.call(this,n,e),s=this.create_doc_fragment(t);return await S2.call(this,n,s,e)}r(Mm,"render");async function S2(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new eb.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Ae(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),o.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):Se(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(S2,"post_process");Mm.version=.2;var tb=require("obsidian");function C2(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(C2,"build_html");function sb(n,e={}){let t=C2.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,tb.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),q2.call(this,n,i,e),i}r(sb,"render");function q2(n,e){}r(q2,"post_process");var nb=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
`;var lb=require("obsidian");var ib=require("obsidian");function ob(n){n.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in po){let s=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",o=document.createElement("p");o.textContent=i,s.appendChild(o);let a=document.createElement("p");a.textContent=`\u2705 ${po[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",s.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{n.open_milestones_modal()}),s.appendChild(c),new ib.Notice(s,7e3)}})}r(ob,"register_first_of_event_notifications");var po={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Inline connections",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Inline connections",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Inline connections",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},$2=["Environment","Connections","Lookup","Context","Chat","Pro","Inline connections"];function rb(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=$2.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(rb,"derive_events_checklist_groups");function Lm(n,e){return!!n.event_logs.items[e]}r(Lm,"check_if_event_emitted");function j2(n,e={}){let t=rb(po),s=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(Lm(n,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(Lm(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=Lm(n,u.event_key)===!0;return N2(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Le(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Le(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Le(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(j2,"build_html");async function db(n,e={}){this.apply_style_sheet(nb);let t=j2.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return T2.call(this,n,i,e),i}r(db,"render");async function T2(n,e,t={}){return P2(e),I2(e),e}r(T2,"post_process");function N2(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Le(n.event_key)}"
data-link="${Le(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${Le(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Le(n.milestone)}</span>
</div>
</li>
`}r(N2,"build_item_html");function P2(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=cb(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||ab(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=cb(n,e);s&&(e.preventDefault(),ab(s))}))}r(P2,"attach_item_link_listeners");function ab(n){let e=z2(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(ab,"open_item_link");function I2(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&M2(i,s)})}r(I2,"render_item_state_icons");function M2(n,e){L2(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(M2,"set_item_icon");function L2(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,lb.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(L2,"set_icon_with_fallback");function cb(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(cb,"get_item_el_from_event");function z2(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=po[t];return!s||typeof s.link!="string"?"":s.link}r(z2,"get_item_link");function R2(){return`<div>
<button class="copy-all-notifications-btn">Copy All Notifications</button>
<div class="smart-env-notifications-feed"></div>
</div>`}r(R2,"build_html");async function _b(n,e={}){let t=this.create_doc_fragment(R2()),s=t.firstElementChild;return D2.call(this,n,s,e),t}r(_b,"render");async function D2(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed");this.empty(s);let i=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!i.length){let a=s.ownerDocument.createElement("p");a.className="smart-env-notifications-empty",a.textContent="No Smart Env notifications yet.",s.appendChild(a);return}i.slice(-100).reverse().forEach(a=>{B2(s,a)});let o=e.querySelector(".copy-all-notifications-btn");o.addEventListener("click",()=>{let a=s.textContent;navigator.clipboard.writeText(a).then(()=>{o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy All Notifications"},2e3)})})}r(D2,"post_process");function F2(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(F2,"get_level");function B2(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=F2(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${U2(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(B2,"append_entry");function U2(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(U2,"to_time_ago");var bt=require("obsidian");var ho=require("obsidian");function fo(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(fo,"get_smart_server_url");function W2(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(W2,"try_get_zlib");function G2(n){let e=W2();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(G2,"inflate_deflate_data");async function ub(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let w=new Uint8Array(n.slice(t,t+y)),x=new TextDecoder("utf-8").decode(w);t+=y,t+=g;let b=(l&8)!==0,C=t,k;if(!b)k=C+p;else{let O=C,S=!1;for(;O+4<=s;){let m=e.getUint32(O,!0);if(m===134695760||m===67324752||m===33639248){S=!0;break}O++}k=S?O:s}if(k>s)break;let A=new Uint8Array(n.slice(C,k));if(t=k,b&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let q;if(d===0)q=A;else if(d===8)q=G2(A);else continue;if(i.push({fileName:x,data:q}),x.toLowerCase().endsWith("manifest.json")&&!x.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(q))}catch{}}return{files:i,pluginManifest:o}}r(ub,"parse_zip_into_files");function mb(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(mb,"validate_zip_buffer");async function pb(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(pb,"write_files_with_adapter");function hb(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(hb,"is_server_version_newer");async function fb(n,e){let t=await(0,ho.requestUrl)({url:`${fo()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return mb(t.arrayBuffer,"Smart Plugins server")}r(fb,"fetch_plugin_zip");async function gb(n,e=ho.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return mb(t.arrayBuffer,"Download")}r(gb,"fetch_zip_from_url");async function yb(n,e,t=ho.requestUrl){let s=await t({url:`${fo()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(yb,"fetch_plugin_readme");async function bb(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(bb,"enable_plugin");function vb(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(vb,"get_oauth_storage_prefix");async function kb(n){let e=await(0,ho.requestUrl)({url:`${fo()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(kb,"fetch_server_plugin_list");var wb=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var V2='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',J2='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function K2(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(K2,"derive_fallback_plugins");function Y2(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${V2}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${J2}</p>
</div>
</div>
`}r(Y2,"build_html");async function xb(n,e={}){this.apply_style_sheet(wb);let t=Y2.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await X2.call(this,n,i,e),i}r(xb,"render");async function X2(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=vb(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".pro-plugins-list"),l=K2(),d=0,_="",u=null,p=r(k=>{if(!a||!k)return;(!u||!u.isConnected)&&(u=document.createElement("div"),u.classList.add("smart-plugins-login-manual"),a.appendChild(u)),u.innerHTML="";let A=document.createElement("div");A.classList.add("smart-plugins-login-manual-instructions"),A.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",u.appendChild(A);let q=document.createElement("div");q.classList.add("smart-plugins-login-manual-controls"),u.appendChild(q);let O=document.createElement("input");O.classList.add("smart-plugins-login-manual-input"),O.type="text",O.value=k,O.readOnly=!0,O.addEventListener("focus",()=>O.select()),q.appendChild(O);let S=document.createElement("button");S.classList.add("mod-cta"),S.textContent="Copy",S.addEventListener("click",async()=>{await Q2(k)?new bt.Notice("Copied login link to clipboard."):new bt.Notice("Copy failed. Please select and copy the link manually.")}),q.appendChild(S)},"render_manual_login_link"),f=r(async()=>{let k={},{manifests:A}=i.plugins;for(;Object.keys(A).length===0;)A=i.plugins.manifests,await new Promise(q=>setTimeout(q,100));for(let q in A){if(!Object.prototype.hasOwnProperty.call(A,q))continue;let{name:O,version:S}=A[q];k[q]={name:O,version:S}}return k},"get_installed_info"),y=r(async()=>{d++,d>=2&&_&&p(_),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(_=Z2()),new bt.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),g=r(()=>{if(this.empty(a),u=null,!(localStorage.getItem(o+"token")||"")){new bt.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(O=>{O.setButtonText("Login"),O.onClick(async()=>{await y()})});return}let A=new bt.Setting(a);A.setDesc("Signed in to Smart Plugins Pro account."),A.addButton(q=>{q.setButtonText("Logout"),q.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new bt.Notice("Logged out of Smart Plugins"),g(),b()})})},"render_oauth_login_section"),w=r(async()=>{if(this.empty(c),!(!c||l.length===0))for(let k of l){let A=await n.smart_components.render_component("pro_plugins_list_item",k,{env:n,app:i,installed_map:{}});c.appendChild(A)}},"render_fallback_plugin_list"),x=r(()=>{let k=new bt.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");k.addButton(A=>{A.setButtonText("Get Pro"),A.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),k.addButton(A=>{A.setButtonText("Update subscription"),A.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),k.addButton(A=>{A.setButtonText("Refresh"),A.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),b=r(async()=>{this.empty(c);let k=localStorage.getItem(o+"token")||"";if(!k){await w();return}try{let A=await f(),q=await kb(k),{list:O=[],unauthorized:S=[],sub_exp:m}=q;if(typeof m=="number"&&m<Date.now()){x(),await w();return}if(!Array.isArray(O)||O.length===0){await w();return}for(let h of O){let v=await n.smart_components.render_component("pro_plugins_list_item",h,{env:n,app:i,token:k,installed_map:A,on_installed:b});c.appendChild(v)}}catch(A){console.error("[pro-plugins:list] Failed to fetch plugin list:",A),c.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),C=r(async()=>{g(),await b()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{C()}),await C(),e}r(X2,"post_process");function Z2(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${fo()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(Z2,"initiate_smart_plugins_oauth");var Q2=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var pe=require("obsidian");var eq="https://smartconnections.app/pro-plugins/";function tq(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(tq,"build_html");function sq(n){return!n||!n.repo}r(sq,"is_fallback_item");function nq(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,hb(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(nq,"compute_display_state");async function Eb(n,e={}){let t=tq(n,e),i=this.create_doc_fragment(t).firstElementChild;return await iq.call(this,n,i,e),i}r(Eb,"render");async function iq(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(sq(n)){let u=new pe.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(eq,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=nq(n,l),_=new pe.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>rq(n,{app:s,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),n.docs_url?u.onClick(()=>window.open(n.docs_url,"_external")):u.onClick(()=>aq(n,{app:s,token:i,display_name:d.display_name}))}),e}r(iq,"post_process");var oq=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return gb(t);if(!e)throw new Error("Login required to install this plugin.");return fb(n.repo,e)},"download_plugin_zip"),rq=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new pe.Notice(`Installing "${n.repo}" ...`);let o=await oq(n,s),{files:a,pluginManifest:c}=await ub(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await pb(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await bb(t,_),new pe.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new pe.Notice(`Install failed: ${o.message}`)}},"install_plugin"),aq=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await yb(n.repo,s),a=new pe.Modal(t);a.setTitle(i||n.name||n.repo),await pe.MarkdownRenderer.render(t,o,a.contentEl,"",new pe.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new pe.Notice("Failed to load README")}},"show_plugin_readme");var Ab=require("obsidian");var ws=class extends Ab.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var Sb=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}`;var Cb=require("obsidian");function lq(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${Ob(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(lq,"build_html");async function qb(n,e){this.apply_style_sheet(Sb);let s=this.create_doc_fragment(lq.call(this,n,e)).firstElementChild;return dq.call(this,n,s,e),s}r(qb,"render");async function dq(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,Cb.setIcon)(o,Ob(n)),s.addEventListener("click",()=>{new ws(n).open()}),i.addEventListener("click",()=>{new ws(n,{test_on_open:!0}).open()}),e}r(dq,"post_process");function Ob(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(Ob,"get_test_result_icon_name");var jb=require("obsidian");var $b={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function wc(n,e,t={}){let s=($b[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new jb.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new ws(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(wc,"show_new_model_menu");var Ec=require("obsidian");var xc=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new Ec.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function xs(n,e,t,s={}){let{default_group_name:i="Settings"}=s;n=Nb(n,e);let o=Object.entries(n||{}).reduce((c,[l,d])=>{let _=d.group||i;return c[_]||(c[_]={}),c[_][l]=d,c},{[i]:{}});return Object.entries(o).sort(([c],[l])=>c===i?-1:l===i?1:0).filter(([,c])=>Object.keys(c).length>0).map(([c,l])=>{let d=t.createDiv(),_={...s,...s.group_params?.[c]||{}};return _q(c,e,l,d,_)})}r(xs,"render_settings_config");function _q(n,e,t,s,i={}){let o;try{let l=require("obsidian");l.SettingGroup?o=l.SettingGroup:o=xc}catch{o=xc}t=Nb(t,e);let{heading_btn:a=null}=i,c=new o(s);if(a&&typeof a=="object")if(Array.isArray(a))for(let l of a)Tb(c,e,l);else Tb(c,e,a);c.setHeading(n);for(let[l,d]of Object.entries(t)){if(!d||typeof d!="object"){console.warn(`Invalid setting config for ${l}:`,d);continue}c.addSetting(_=>{switch(d.name&&_.setName(d.name),_.setClass(l.replace(/[^a-zA-Z0-9]/g,"-")),d.type&&_.setClass(`setting-type-${d.type}`),d.description&&_.setDesc(d.description),d.type){case"button":_.addButton(u=>{u.setButtonText(d.name||"Run"),u.onClick(async p=>{typeof d.callback=="function"&&await wn(_,p,d.callback,{scope:e})})});break;case"toggle":_.addToggle(u=>{u.setValue(Ae(e.settings,l)||!1),u.onChange(p=>{Se(e.settings,l,p),typeof d.callback=="function"&&wn(_,p,d.callback,{scope:e})})});break;case"text":_.addText(u=>{u.setValue(String(Ae(e.settings,l)||"")),u.onChange(p=>{Se(e.settings,l,p)})});break;case"number":_.addText(u=>{u.setValue(String(Ae(e.settings,l)||"")),u.inputEl.setAttribute("type","number"),u.onChange(p=>{let f=Number(p);isNaN(f)||Se(e.settings,l,f),typeof d.callback=="function"&&wn(_,f,d.callback,{scope:e})})});break;case"dropdown":_.addDropdown(u=>{let p=d.options_callback;typeof p=="function"&&p.call(e,e).forEach(y=>{let g=y.label||y.name||y.value;u.addOption(y.value,g)}),u.setValue(Ae(e.settings,l)||""),u.onChange(f=>{Se(e.settings,l,f),typeof d.callback=="function"&&wn(_,f,d.callback,{scope:e})})});break;case"textarea":_.addTextArea(u=>{u.setValue(String(Ae(e.settings,l)||"")),u.onChange(p=>{Se(e.settings,l,p)})});break;case"slider":_.addSlider(u=>{let p=d.min||0,f=d.max||100,y=d.step||1;u.setLimits(p,f,y),u.setValue(Ae(e.settings,l)||p),u.setDynamicTooltip(),u.onChange(g=>{Se(e.settings,l,g),typeof d.callback=="function"&&wn(_,g,d.callback,{scope:e})})});break;case"heading":_.setHeading();break;case"html":d.value&&_.descEl.replaceChildren(document.createRange().createContextualFragment(d.value));break;default:console.warn(`Unsupported setting type for ${l}:`,d.type);break}d.scope_class&&_.settingEl.addClass(d.scope_class)})}return c}r(_q,"render_settings_group");function Tb(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,Ec.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await wn(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(Tb,"render_heading_button");async function wn(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(wn,"handle_config_callback");function Nb(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(Nb,"ensure_settings_config");function uq(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(uq,"build_html");async function Pb(n,e){let s=this.create_doc_fragment(uq.call(this,n,e)).firstElementChild;return mq.call(this,n,s,e),s}r(Pb,"render");async function mq(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=xs(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{wc(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(mq,"post_process");function pq(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(pq,"build_html");async function Ib(n,e){let s=this.create_doc_fragment(pq(n,e)).firstElementChild;return hq.call(this,n,s,e),s}r(Ib,"render");async function hq(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(hq,"post_process");var zb=require("obsidian");function Ac(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(Ac,"ensure_smart_sources_settings");function go(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(go,"parse_exclusions_csv");function Mb(n,e){let t=(e??"").trim();if(!t)return n||"";let s=go(n);return s.includes(t)||s.push(t),s.join(",")}r(Mb,"add_exclusion");function Lb(n,e){let t=(e??"").trim();return t?go(n).filter(i=>i!==t).join(","):n?.trim()||""}r(Lb,"remove_exclusion");var Sc=class extends zb.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Ac(this.env),t=go(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Ac(this.env);t.folder_exclusions=Mb(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Ac(this.env),t=go(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=Lb(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var Rb=require("obsidian");var Cc=class extends Rb.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function fq(n,e={}){return`
<div class="sources-settings">
</div>
`}r(fq,"build_html");async function Db(n,e={}){let t=await fq.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return gq.call(this,n,i,e),i}r(Db,"render");async function gq(n,e,t={}){xs({folder_exclusions:bq,view_exclusions:vq,re_import_sources:kq},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",yq(n,e))),this.attach_disposer(e,i),e}r(gq,"post_process");function yq(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(yq,"highlight_reset_data");var bq={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new Sc(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},vq={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new Cc(t.main.app,t).open()},"callback")},kq={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"})},"callback")};function wq(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(wq,"build_html");async function Fb(n,e={}){let s=this.create_doc_fragment(wq(n,e)).firstElementChild;return xq.call(this,n,s,e),s}r(Fb,"render");async function xq(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),wc(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(xq,"post_process");async function Eq(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(Eq,"build_html");async function Bb(n,e={}){let t=await Eq.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return Aq.call(this,n,i,e),i}r(Bb,"render");async function Aq(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(Aq,"post_process");var Ub=`.sc-env-settings-container {\r
margin: 1rem 0;\r
}\r
\r
.smart-env-settings-header {\r
display: flex;\r
align-items: center;\r
justify-content: space-between;\r
margin-bottom: 0.5rem;\r
}\r
\r
.toggle-env-settings-btn {\r
cursor: pointer;\r
}\r
\r
\r
.setting-group .setting-items .setting-item.env-setting-highlight {\r
border: 1px solid var(--interactive-accent);\r
background-color: var(--interactive-hover);\r
padding: 0.5rem;\r
margin: 0.5rem 0;\r
}\r
\r
.settings-group {\r
.setting-item {\r
border-top: none;\r
}\r
}`;async function Cq(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(Cq,"build_html");async function Wb(n,e={}){this.apply_style_sheet(Ub);let t=await Cq.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return qq.call(this,n,i,e),i}r(Wb,"render");async function qq(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return zm.call(this,"settings_env_sources",n,i),zm.call(this,"settings_env_models",n,s),zm.call(this,"settings_notifications",n,o),e}r(qq,"post_process");function zm(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(zm,"render_if_available");var Gb=require("obsidian");function Oq(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(Oq,"build_html");async function Hb(n,e={}){let t=Oq(),i=this.create_doc_fragment(t).firstElementChild;return $q.call(this,n,i,e),i}r(Hb,"render");async function $q(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),jq(n,a),Tq(n,a),Nq(n,a),Pq(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r($q,"post_process");function jq(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(jq,"render_btn_open_selector");function Tq(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(Tq,"render_btn_copy_context");function Nq(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(Nq,"render_btn_clear_context");function Pq(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,Gb.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(Pq,"render_btn_help");var Vb=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var yo=require("obsidian");async function nt(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(yo.Platform.isMobile)new yo.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new yo.Notice("Failed to copy.")}}r(nt,"copy_to_clipboard");function Mq(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(Mq,"build_html");async function Jb(n,e={}){let t=Mq(n,e);this.apply_style_sheet(Vb);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return Lq.call(this,n,i,e),i}r(Jb,"render");async function Lq(n,e,t={}){let s=[],i=r(async()=>{let l=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(u=>{this.empty(l),l.appendChild(u)});let d=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(u=>{this.empty(d),d.appendChild(u)});let _=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(u=>{this.empty(_),_.appendChild(u)})},"render_children"),o=n.env.plugin,a=o?.app||window.app;return(o?.registerDomEvent?.bind(o)||((l,d,_)=>l.addEventListener(d,_)))(e,"contextmenu",l=>{if(l.preventDefault(),l.stopPropagation(),!a)return;let d=new Menu(a);d.addItem(_=>_.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let u=zq(e);await nt(u)})),d.showAtMouseEvent(l)}),await i(),s.push(n.on_event("context:updated",i)),this.attach_disposer(e,s),e}r(Lq,"post_process");function zq(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(zq,"tree_dom_to_wikilinks");function Rq(n){return Math.ceil((n||0)/4)}r(Rq,"estimate_tokens");function Dq(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(Dq,"build_html");async function Kb(n,e={}){let t=Dq(),i=this.create_doc_fragment(t).firstElementChild;return Fq.call(this,n,i,e),i}r(Kb,"render");async function Fq(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=Rq(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Fq,"post_process");function Yb(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-tree-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let u=["sc-tree-label"];return n.exists===!1&&u.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${a?l:""}
<span class="${u.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(Yb,"build_tree_item");function Xb(n){let e=Bq(n),t=new Set(n.map(i=>i.key||i.path));return Zb(e,t)}r(Xb,"build_tree_html");function Bq(n=[]){let e=r(o=>{let a=/#\{\d+\}$/u,c=o,l=null,d=null,_=!1,u=c.match(a);u&&(l=u[0],c=c.slice(0,-l.length),_=!0);let p=c.indexOf("##");p!==-1&&(d=c.slice(p),c=c.slice(0,p),_=!0);let f=[];if(c){let y="",g=!1;for(let w=0;w<c.length;w++)!g&&c.slice(w,w+2)==="[["?(g=!0,y+="[[",w++):g&&c.slice(w,w+2)==="]]"?(g=!1,y+="]]",w++):!g&&c[w]==="/"?(f.push(y),y=""):y+=c[w];y&&f.push(y)}return d&&f.push(d),l&&f.push(l),{segments:f,has_block:_}},"split_path_segments"),t={name:"",children:{},selected:!1},s=r((o,a)=>a.some(c=>o.startsWith(`${c}/`)),"is_redundant"),i=n.filter(o=>!(o.key.includes("#")?o.key.split("#")[0]:o.key).match(/\.[a-zA-Z0-9]+$/u)).map(o=>o.key);for(let{key:o,exists:a}of n){if(s(o,i.filter(u=>u!==o)))continue;let{segments:c,has_block:l}=e(o),d=t,_="";c.forEach((u,p)=>{if(_=_?`${_}/${u}`:u,u.startsWith("external:.."))return;let f=p===c.length-1,y=f&&l;d.children[u]||(d.children[u]={name:u,path:y?o:_,children:y?[]:{},selected:!1,is_file:y||f&&u.includes(".")}),d=d.children[u],f&&(d.selected=!0,d.exists=a)})}return t}r(Bq,"build_path_tree");function Zb(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>Yb(s,e,Zb(s,e))).join("")}</ul>`}r(Zb,"tree_to_html");var Qb=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;function Wq(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(Wq,"build_html");async function ev(n,e={}){this.apply_style_sheet(Qb);let t=Wq(n,e),i=this.create_doc_fragment(t).firstElementChild;return Gq.call(this,n,i,e),i}r(ev,"render");async function Gq(n,e,t={}){let s=r(()=>{let o=n.env,a=n.context_items.filter(t.filter),c=Xb(a),l=this.create_doc_fragment(c);this.empty(e),e.appendChild(l);for(let d=0;d<a.length;d++){let _=a[d],u=e.querySelector(`.sc-tree-item[data-path="${_.key}"]`);if(!u){console.warn(`Smart Context: Could not find tree item for path: ${_.key}`);continue}o.smart_components.render_component("context_item_leaf",_).then(p=>{this.empty(u),u.appendChild(p)})}},"render_tree_leaves");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Gq,"post_process");var tv=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function Vq(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(Vq,"build_html");async function sv(n,e={}){let t=Vq(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(tv),await Jq.call(this,n,s,e),s}r(sv,"render");async function Jq(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let u=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',w=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',x="",b="";try{let k=await p.read();x=k.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),b=(await p.get_embed_input(k)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(k){console.error("[source_inspector] Error reading block:",k),x='<em style="color:red;">Error reading block content</em>'}let C=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${w}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${b}</pre>
</details>
<blockquote>${x}</blockquote>
<hr>
`);s.appendChild(C)}return e}r(Jq,"post_process");var av=require("obsidian");var xn=require("obsidian");var nv=require("obsidian");var qc=class extends nv.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var iv=require("obsidian");var Oc=class extends iv.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function ov(n,e,t={}){let{Menu:s=xn.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new xn.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new xn.Notice("Active note is not indexed by Smart Environment");return}new qc(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Oc(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new xn.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(ov,"register_status_bar_context_menu");var rv=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function Yq(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(Yq,"build_html");async function cv(n,e={}){this.apply_style_sheet(rv);let s=this.create_doc_fragment(Yq()).firstElementChild;return Xq.call(this,n,s,e),s}r(cv,"render");function Xq(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",w=c(),x=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",x="attention"),s&&(0,av.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=b=>{b.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),w>0?i.dataset.count=String(w):delete i.dataset.count,x?i.dataset.level=String(x):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=b=>{if(l()>0)b.preventDefault(),b.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let k=new MouseEvent("contextmenu",b);e.dispatchEvent?.(k)}},e.addEventListener("click",e._click_handler))},"render_status_elm");ov(n,e),d();let _=null,u=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",u)),this.attach_disposer(e,p)}r(Xq,"post_process");var lv=require("obsidian");function Zq(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(Zq,"build_html");function dv(n,e={}){let t=Zq.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return Qq.call(this,n,i,e),i}r(dv,"render");async function Qq(n,e){let t=e.querySelector(".callout-icon"),s=(0,lv.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(Qq,"post_process");var _v=require("obsidian");function eO(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(eO,"build_html");function uv(n,e={}){let t=eO.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,_v.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),tO.call(this,n,i,e),i}r(uv,"render");function tO(n,e){}r(tO,"post_process");var Rm=require("obsidian");async function mv(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new Rm.Notice("No context items to copy.");let t=await this.get_text(n);await nt(t);let s=sO({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new Rm.Notice(s)}r(mv,"copy_to_clipboard");function sO(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${nO(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=iO(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(sO,"format_stats_message");function nO(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(nO,"format_char_count");function iO(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(iO,"sum_exclusions");async function pv(n,e){let t={KEY:this.key,TIME_AGO:Ku(this.mtime)||"Missing",LINK_DEPTH:this.data.d||0},s=r(async a=>{let c=/{{([\w_]+)}}/g,l=(a.match(c)||[]).length;for(let d=0;d<l;d++)a=a.replace(/{{(\w+)}}/g,(_,u)=>t[u]||"");return a},"replace_vars"),i=await s(this.settings.template_before||$c.template_before),o=await s(this.settings.template_after||$c.template_after);return["",i,n,o,""].join(`
`)}r(pv,"merge_template");var hv={item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
</ul>
`},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content."},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content."}},$c={template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function En(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=oO(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return jc(e),fv(e).trimEnd()}r(En,"build_file_tree_string");function oO(n){return typeof n=="string"&&n.endsWith("/")}r(oO,"is_folder_path");function jc(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,jc(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],jc(n[i])}else jc(t)}}}r(jc,"compress_single_child_dirs");function fv(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=fv(o,e+(c?"    ":"\u2502   ")))}),t}r(fv,"build_tree_string");async function gv(n,e){let t={FILE_TREE:r(()=>En(e.map(a=>a.key)),"FILE_TREE")},s=r(async a=>{let c=(a.match(/{{(\w+)}}/g)||[]).length;for(let l=0;l<c;l++)a=a.replace(/{{(\w+)}}/gi,(d,_)=>t[_]?.()||"");return a},"replace_vars"),i=await s(this.settings.template_before||Tc.template_before),o=await s(this.settings.template_after||Tc.template_after);return[i,n,o].join(`
`)}r(gv,"merge_template");var yv={context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context."},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context."}},Tc={template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function bo(n={}){let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:rO(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action")}))}r(bo,"context_suggest_blocks");function rO(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(rO,"get_block_display_name");var bv="Add blocks";function vv(n={}){return Object.values(this.env.smart_sources.items).map(t=>({key:t.key,display:t.key,select_action:r(()=>{this.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",bo.call(this,{source_key:t.key})),"mod_select_action"),arrow_right_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",bo.call(this,{source_key:t.key})),"arrow_right_action")}))}r(vv,"context_suggest_sources");var kv="Add sources";async function Nc(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(Nc,"pre_process");function Dm(n){return this.vec?n.to_item?.vec?{score:us(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(Dm,"similarity");Dm.action_type="score";var Fm="Cosine Similarity",Bm="Ranks by cosine similarity between the current note and candidates.",wv={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${Fm} algorithm`,value:`${Bm}`}};var Um=require("obsidian");async function Pc(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=Um.Keymap.isModEvent(e),l=Um.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(Pc,"open_source");async function xv(n=null){await Pc(this,n)}r(xv,"source_open");var Ev={collections:{embedding_models:Uy,lookup_lists:Hy},item_types:{EmbeddingModel:ks,LookupList:Rt},items:{embedding_model:{class:ks},lookup_list:{class:Rt}},modules:{},components:{collection_settings:{render:Vy},context_item_leaf:{render:Zy},env_stats:{render:Qy},form_dropdown:{render:Mm},lean_coffee_callout:{render:sb},milestones:{render:db},notifications_feed:{render:_b},pro_plugins_list:{render:xb},pro_plugins_list_item:{render:Eb},settings_env_model:{render:qb},settings_env_model_type:{render:Pb},settings_env_models:{render:Ib},settings_env_sources:{render:Db},settings_model_actions:{render:Fb},settings_notifications:{render:Bb},settings_smart_env:{render:Wb},smart_context_actions:{render:Hb},smart_context_item:{render:Jb},smart_context_meta:{render:Kb},smart_context_tree:{render:ev},source_inspector:{render:sv},status_bar:{render:cv},supporter_callout:{render:dv},user_agreement_callout:{render:uv}},actions:{context_copy_to_clipboard:{action:mv},context_item_merge_template:{action:pv,settings_config:hv,default_settings:$c},context_merge_template:{action:gv,settings_config:yv,default_settings:Tc},context_suggest_blocks:{action:bo,display_name:bv},context_suggest_sources:{action:vv,display_name:kv},lookup_list_pre_process:{action:Nc,pre_process:Nc},similarity:{action:Dm,settings_config:wv,display_name:Fm,display_description:Bm},source_open:{action:xv}}};var Av={env_path:"",modules:{smart_fs:{class:va,adapter:ka},smart_view:{class:Sa,adapter:qa},smart_embed_model:{class:Fi,adapters:{transformers:gn,openai:Qa,ollama:sc,gemini:nc,lm_studio:ic}},smart_chat_model:{class:Ui,adapters:{anthropic:Wi,azure:Vi,custom:io,google:bn,gemini:Yi,groq:oo,lm_studio:Zi,ollama:to,open_router:Xi,openai:bs,xai:ro,deepseek:ao},http_adapter:new Qe({adapter:fn,obsidian_request_url:Wm.requestUrl})},http_adapter:{class:Qe,adapter:fn,obsidian_request_url:Wm.requestUrl}},collections:{context_items:Iy,event_logs:Ly,smart_components:jy,smart_contexts:Ny,smart_sources:{collection_key:"smart_sources",class:Ii,data_adapter:zi,source_adapters:{md:hs,txt:hs,"excalidraw.md":Ha,base:Wa,canvas:Ga},content_parsers:[Sy],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:Di,data_adapter:Va,block_adapters:{md:_n,txt:_n,"excalidraw.md":_n}}},item_types:{SmartSource:ln,SmartBlock:dn},items:{smart_source:dy,smart_block:fy},default_settings:Dy,modals:{context_selector:{class:gc,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:bc},notifications_feed_modal:{class:yc}}};_s(Av,Ev);var Sv=Av;var Ic=require("obsidian");function Cv(){(0,Ic.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}r(Cv,"add_smart_chat_icon");function qv(){(0,Ic.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}r(qv,"add_smart_connections_icon");function Ov(){(0,Ic.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}r(Ov,"add_smart_lookup_icon");var $v=require("obsidian");var Mc={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function aO(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(aO,"define_default_create_methods");var Lc=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,aO(Mc)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=Mc[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,$v.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,Mc["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var jv=require("obsidian");var cO=require("obsidian");function zc(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(zc,"get_smart_server_url");var lO="smart-plugins-op",dO="smart-plugins-op-secret";function _O({access_token:n,refresh_token:e},t){localStorage.setItem(t+"token",n),e&&localStorage.setItem(t+"refresh",e)}r(_O,"set_local_storage_token");async function Tv(n,e){let t=mO(e.app.vault.getName()),s=`${zc()}/auth/oauth_exchange2`,i=await(0,jv.requestUrl)({url:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:lO,client_secret:dO,code:n})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:o,refresh_token:a}=i.json;if(!o)throw new Error("No access_token in response");_O({access_token:o,refresh_token:a},t)}r(Tv,"exchange_code_for_tokens");var uO="_smart_plugins_oauth_";function mO(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${uO}`}r(mO,"build_oauth_storage_prefix");function Nv(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let s=En([...new Set(t)]);return n.replace(/{{\s*folder_tree\s*}}/gi,s)}r(Nv,"replace_folder_tree_var");function Pv(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let s=En([...new Set(t)]);return n.replace(/{{\s*folders_top\s*}}/gi,s)}r(Pv,"replace_folders_top_var");function Iv(n){console.log("replace_recent_n_var",n);let e=this;return n.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,s)=>{let i=parseInt(s,10)||0,o=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,o),o?`
- ${o}`:""}).trim()}r(Iv,"replace_recent_n_var");function Mv(n){let t=this.app?.metadataCache?.getTags?.()||{},s=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return n.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${s}
`).trim()}r(Mv,"replace_vault_tags_var");function Lv(n){n.register(e=>/{{\s*folder_tree\s*}}/i.test(e),Nv,"{{ folder_tree }}"),n.register(e=>/{{\s*folders_top\s*}}/i.test(e),Pv,"{{ folders_top }}"),n.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),Mv,"{{ tags }}"),n.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),Iv,"{{ recent_10 }}")}r(Lv,"register_completion_variable_adapter_replacements");async function Rc({app:n,plugin_ids:e=[]}={}){if(!n)return;let t=n.vault?.adapter;for(let s of e)await pO(n.plugins,s)&&console.warn(`Disabled legacy plugin: ${s}`),await hO(t,s)&&console.warn(`Removed legacy plugin: ${s}`)}r(Rc,"remove_smart_plugins_plugin");async function pO(n,e){if(!(!n||!(n.plugins?.[e]||n.enabledPlugins?.has?.(e)||n.manifests&&e in n.manifests)))return n.plugins?.[e]&&await n.unloadPlugin?.(e),n.disablePluginAndSave&&await n.disablePluginAndSave(e),n.enabledPlugins?.has?.(e)&&n.enabledPlugins.delete(e),n.manifests&&e in n.manifests&&delete n.manifests[e],await n.loadManifests?.(),!0}r(pO,"disable_plugin_if_present");async function hO(n,e){if(!n?.exists)return;let t=`.obsidian/plugins/${e}`;if(await n.exists(t)){if(n.rmdir){await n.rmdir(t,!0);return}if(n.list&&n.remove){let i=[t];for(;i.length;){let o=i.pop(),a=await n.list(o);for(let c of a?.files||[])await n.remove(`${o}/${c}`);for(let c of a?.folders||[])i.push(`${o}/${c}`)}return await n.remove(t),!0}}}r(hO,"remove_plugin_folder");var vo=class extends Pi{static{r(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,Cv(),qv(),Ov(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new vt.Notice(i,0),window.smart_env=null}let s=_s(t,Sv);return s.env_path="",await super.create(e,s)}async load(e=!1){if(this.run_migrations(),!vt.Platform.isMobile&&!this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")&&this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),vt.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new vt.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i.view?.file?.path;this.emit_source_opened(o,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i?.path;this.emit_source_opened(o,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&Lv(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),ob(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let s=this.smart_sources.get(e);s&&(this._current_opened_source=e,s.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new Lc(this,{adapter:vt.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),s=`${zc()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(s,"_external"),s}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new vt.Notice("No OAuth code provided in URL. Login failed.");return}try{await Tv(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(s){console.error("OAuth callback error",s),new vt.Notice(`OAuth callback error: ${s.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&fO(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){Rc({app:this.plugin.app,plugin_ids:["smart-plugins"]}),Rc({app:this.plugin.app,plugin_ids:["smart-editor"]}),Rc({app:this.plugin.app,plugin_ids:["smart-sources"]})}};function fO(n,e){let t=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}r(fO,"download_json");var Vm=require("obsidian");var zv=require("obsidian");async function Rv(n,e={}){let{wait_for_states:t=["loaded"]}=e,s=n.container||n.containerEl;if(!t.includes(n.env?.state)){let i=!1;for(;n.env.state==="init"&&zv.Platform.isMobile&&!i;)s?(s.empty(),n.env.smart_view.safe_inner_html(s,"<button>Load Smart Environment</button>"),s.querySelector("button").addEventListener("click",()=>{n.env.load(!0),i=!0})):console.log("Waiting for env to load (mobile)..."),await new Promise(o=>setTimeout(o,2e3));for(;!t.includes(n.env.state);){if(s){let o=n.env?.obsidian_is_syncing?"Waiting for Obsidian Sync to finish...":"Loading Obsidian Smart Environment...";s.empty(),n.env.smart_view.safe_inner_html(s,o)}else console.log("Waiting for env to load...");await new Promise(o=>setTimeout(o,2e3))}}}r(Rv,"wait_for_env_to_load");var Gm=`/* 1) Host elements that should get a PRO badge */\r
:is(\r
.pro-setting .setting-item-name\r
) {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
:is(\r
.pro-setting .setting-item-name:not(:empty)\r
)::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
:is(\r
.pro-setting .setting-item-name\r
):hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
.pro-plugins-container {\r
border: 1px solid var(--interactive-accent);\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-top: 1rem;\r
background-color: var(--background-secondary);\r
}\r
\r
.smart-plugin-settings-header .actions-container {\r
display: flex;\r
flex-wrap: wrap;\r
gap: var(--pill-padding-y);\r
}\r
\r
.setting-component:has(.dropdown-no-options) {\r
display: none;\r
}\r
\r
/* wrap Obsidian native styles within smart plugin settings main class */\r
.smart-plugin-settings-main, .smart-plugin-settings-env {\r
.setting-group {\r
margin-top: var(--size-4-6);\r
margin-bottom: var(--size-4-6);\r
}\r
/* polyfill */\r
.setting-group .setting-items {\r
background-color: var(--setting-items-background, var(--background-primary-alt));\r
padding: var(--setting-items-padding, var(--size-4-5));\r
border-radius: var(--setting-items-radius, var(--radius-l));\r
border: var(--setting-items-border-width, 0) solid var(--setting-items-border-color, var(--background-modifier-border));\r
}\r
}\r
`;var ko=class extends Vm.PluginSettingTab{static{r(this,"SmartPluginSettingsTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.env.is_pro&&!this.env_settings_tab&&this.plugin.addSettingTab(new Hm(this.plugin.app,this.plugin)),this.icon="smart-connections",this.env.is_pro&&(this.name=this.name.replace("Smart ",""))}get smart_view(){return this.env?.smart_view}async display(){await this.render()}async render(){this.containerEl.empty(),Dv(this),await this.env.constructor.wait_for({loaded:!0}),this.prepare_layout(),await this.render_header(this.header_container),await this.render_plugin_settings(this.plugin_container),await this.render_global_settings(this.global_settings_container)}prepare_layout(){this.smart_view.apply_style_sheet(Gm),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.global_settings_container=this.containerEl.createDiv({cls:"smart-plugin-settings-env"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"})}async render_header(e){}async render_plugin_settings(e){}async render_global_settings(e){if(!e||(e.empty?.(),!this.env))return;if(this.env.is_pro){let s=e.createDiv({cls:"setting-item"}),i=s.createDiv({cls:"setting-item-info"});i.createDiv({cls:"setting-item-name",text:"Smart Environment"}),i.createDiv({cls:"setting-item-description",text:"Manage global settings in the dedicated Smart Environment settings tab."}),s.createDiv({cls:"setting-item-control"}).createEl("button",{text:"Open settings"}).addEventListener("click",()=>{this.app.setting.openTabById("smart-environment")})}else{let s=await this.render_component("settings_smart_env",this.env);s&&e.appendChild(s)}let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}async render_component(e,t,s={}){return await this.env.smart_components.render_component(e,t,s)}get env_settings_tab(){return(this.plugin.app||window.app).setting.pluginTabs.find(t=>t.id==="smart-environment")}},Hm=class extends Vm.PluginSettingTab{static{r(this,"SmartEnvSettingTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.plugin=t,this.name="Smart Env Pro",this.id="smart-environment",this.icon="smart-connections"}get smart_view(){return this.env?.smart_view}display(){this.render()}async render_component(e,t,s={}){return await this.env.smart_components.render_component(e,t,s)}async render(){this.containerEl.empty(),this.smart_view.apply_style_sheet(Gm),Dv(this),await this.env.constructor.wait_for({loaded:!0}),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"}),this.header_container.createEl("p",{text:"Manage all global Smart Environment settings from one tab. These settings apply to all Smart Plugins."});let e=await this.render_component("settings_smart_env",this.env);e&&this.plugin_container.appendChild(e);let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}};function Dv(n){let e=n.containerEl,t=n.env;if(t.state!=="loaded")if(t.state==="loading")e.createEl("p",{text:"Smart Environment is loading\u2026"});else{e.createEl("p",{text:"Smart Environment not yet initialized."});let s=e.createEl("button",{text:"Load Smart Environment"});s.addEventListener("click",async()=>{s.disabled=!0,s.textContent="Loading Smart Environment\u2026",await t.load(!0)})}}r(Dv,"render_pre_env_load");var Fv=require("obsidian");var wo=class extends Fv.Plugin{static{r(this,"SmartPlugin")}get commands(){return{show_release_notes:{id:"show-release-notes",name:"Show release notes",callback:r(()=>this.show_release_notes(),"callback")}}}register_commands(){Object.values(this.commands).forEach(e=>{this.addCommand(e)})}get ribbon_icons(){return{}}register_ribbon_icons(){let e=Object.values(this.ribbon_icons);for(let t=0;t<e.length;t++){let s=e[t];this.addRibbonIcon(s.icon_name,s.description,s.callback)}}get item_views(){return{}}register_item_views(){let e=Object.values(this.item_views);for(let t=0;t<e.length;t++){let s=e[t];typeof s.register_item_view=="function"&&s.register_item_view(this)}}async is_new_user(){let e=await this.loadData()||{};return e.installed_at?!1:(e.installed_at=Date.now(),await this.saveData(e),!0)}async get_last_known_version(){return(await this.loadData()||{}).last_version||""}async set_last_known_version(e){let t=await this.loadData()||{};t.last_version=e,await this.saveData(t)}async is_new_plugin_version(e){return await this.get_last_known_version()!==e}};function Dc(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Dc,"collection_instance_name_from");function Es(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Bv(e[t])&&Bv(n[t])?Es(n[t],e[t]):n[t]=e[t]);return n}r(Es,"deep_merge");function Bv(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Bv,"is_plain_object");function Uv(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Uv,"create_uid");function Wv(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(Wv,"camel_case_to_snake_case");function Fc(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Fc(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Fc(n[o],e[o],t))}return n===e}r(Fc,"deep_equal");function Gv(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(Gv,"get_item_display_name");function Bc(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let v of Reflect.ownKeys(m)){let j=Object.getOwnPropertyDescriptor(m,v);if(!j)continue;let E={...j};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let v=!1;for(let j of h){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E){let $=E.value;if(c($)){v=!0;continue}if(s($)){if(_($)){v=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),v=new Map;for(let j of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E&&_(E.value)){v.set(j,d(E.value));continue}try{Object.defineProperty(h,j,u(E))}catch{h[j]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),w=Object.create(null),x=r((m,h,v=[])=>{if(!m||!h)return;let j=new Set([...l,...v]);for(let E of Reflect.ownKeys(m)){if(j.has(E))continue;let $=Object.getOwnPropertyDescriptor(m,E);if($)try{Object.defineProperty(h,E,$)}catch{h[E]=$.value}}},"copy_metadata"),b=r(m=>{let h=new m(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let j=v.bind(h);return x(m,j),x(h,j),j.instance=h,j}return x(m,h),h},"instantiate_class"),C=r(m=>{if(o(m))return b(m);if(a(m)){let h=m.action.bind(n);return x(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return x(m,h),h}return s(m)?d(m):m},"bind_or_clone"),k=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&s(h)?h:null},"scope_actions_for"),A=r((m,h,v)=>(m[h]=v,v),"cache_result"),q=r((m,h)=>{let v=k();return v&&g(v,h)?A(m,h,C(v[h])):g(f,h)?A(m,h,C(f[h])):A(m,h,void 0)},"compute_and_cache"),O=r(()=>{let m=k(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(m)for(let v of Reflect.ownKeys(m))h.add(v);return Array.from(h)},"union_keys"),S=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(w,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:q(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let v=k();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return S(m,h);let v=k();if(v&&g(v,h)||g(f,h))return g(m,h)||q(m,h),S(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,v)=>"value"in v?(m[h]=v.value,!0):!1,"defineProperty"),set:r((m,h,v)=>(m[h]=v,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(Bc,"create_actions_proxy");var xo=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Es(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Uv(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return Es(s,t),!Fc(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Bc(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Dc(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Dc(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Wv(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Gv(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var yO=Object.getPrototypeOf(async function(){}).constructor,Eo=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof yO?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Es(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Bc(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};function Vv(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=Hv(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=Hv(n.results);n.min=s,n.minResult=i}}r(Vv,"results_acc");function Hv(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(Hv,"find_min");function bO(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(bO,"sort_by_score");function Jv(n,e){return bO(n,e)}r(Jv,"sort_by_score_descending");function Kv(n,e){if(!e.pinned?.length)return n;let t=new Set(e.pinned_keys||e.pinned.map(o=>o.key)),s=e.pinned.map(o=>({item:o,...o.score?.(e)||{}})),i=n.filter(o=>{let a=o?.item?.key;return a?!t.has(a):!0});return[...s,...i]}r(Kv,"merge_pinned_results");var vO="smart_sources",kO="smart_blocks";function Yv(n){return!!n&&typeof n=="object"&&!Array.isArray(n)}r(Yv,"is_plain_object");function wO(n){return Yv(n)?Object.entries(n).filter(([,e])=>e!=null):[]}r(wO,"select_hidden_entries");function xO(n){return n.includes("#")?kO:vO}r(xO,"get_collection_prefix");function EO(n){return typeof n!="string"||n.includes(":")?n:`${xO(n)}:${n}`}r(EO,"ensure_prefixed_key");function Xv(n){let e=wO(n?.data?.hidden_connections);if(!e.length)return!1;Yv(n.data.connections)||(n.data.connections={});let t=!1;return e.forEach(([s,i])=>{let o=EO(s);if(typeof o!="string")return;let a=n.data.connections[o]||{};(a.hidden===void 0||a.hidden===null)&&(a.hidden=i,t=!0),n.data.connections[o]=a}),t&&delete n.data.hidden_connections,t||e.length>0}r(Xv,"migrate_hidden_connections");var qe=class extends xo{static{r(this,"ConnectionsList")}static key="connections_list";static get defaults(){return{data:{}}}get_key(){return`${this.data.collection_key}:${this.data.item_key}`}async pre_process(e){Xv(this.item),typeof this.actions.connections_list_pre_process=="function"&&await this.actions.connections_list_pre_process(e),typeof this.env.config?.actions?.[e.score_algo_key]?.pre_process=="function"&&await this.env.config.actions[e.score_algo_key].pre_process.call(this.item,e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return t=await this.post_process(t,e),t=Kv(t,e),t=t.map(s=>Object.assign(s,{connections_list:this})),this.results=t,t}filter_and_score(e={}){let t=this.env[e.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(Vv(a,l,e.limit),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(Jv);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){if(!e?.length)return console.warn("No results to post-process, received:",e),[];let s=this.settings.connections_post_process,i=this.actions[s],o=e;if(typeof i=="function"){let a=await i(e,t);Array.isArray(a)?(o=a.filter(Boolean),o.length||(o=e)):a!=null&&console.warn(`connections post_process '${s}' returned non-array`,a)}else s&&s!=="none"&&console.warn(`Post-process action "${s}" not found, falling back to base results.`);return o}get item(){return this.env[this.data.collection_key]?.items[this.data.item_key]}get connections_list_component_key(){let e=this.data.connections_list_component_key||this.settings?.connections_list_component_key;return this.env.config.components[e]?e:"connections_list_v3"}};var AO=["inline_connections","inline_connections_score_threshold","footer_connections"];function Zv(n){let e=n?.settings;if(!e)return!1;let t=e.connections_pro;if(!t)return!1;let s=e.connections_lists||={},i=!1;for(let o of AO)o in t&&(o in s||(s[o]=t[o],i=!0),delete t[o]);return"rank_model"in t&&(s.actions||(s.actions={}),"rank_connections"in s.actions||(s.actions.rank_connections=t.rank_model,i=!0),delete t.rank_model),i}r(Zv,"migrate_connections_lists_settings");function Uc(n,e,t){let s=Object.entries({...e}),i=s.findIndex(([o])=>o===n);if(i!==-1&&t&&Object.keys(t).length>0){let o=Object.entries(t);s.splice(i+1,0,...o)}return Object.fromEntries(s)}r(Uc,"insert_settings_after");var Ao=class extends Eo{static{r(this,"ConnectionsLists")}static version=1;process_load_queue(){}constructor(e,t={}){Zv(e),super(e,t)}static get default_settings(){return{results_collection_key:"smart_sources",score_algo_key:"similarity",connections_post_process:"none",results_limit:20,exclude_frontmatter_blocks:!0,connections_list_item_component_key:"connections_list_item_v3",components:{connections_list_item_v3:{render_markdown:!0,show_full_path:!1}}}}get settings_config(){return Wc(this)}new_item(e){let t=new this.item_type(this.env,{collection_key:e.collection_key,item_key:e.key});return this.set(t),Object.defineProperty(e,"connections",{get:r(()=>t,"get"),configurable:!0}),t}get_connections_list_item_options(){return Object.entries(this.env.config.components||{}).filter(([e,t])=>e.startsWith("connections_list_item_")).map(([e,t])=>({value:e,name:t.display_name||e,description:t.display_description}))}get score_algo_key(){let e=this.settings?.score_algo_key;return this.env.config?.actions?.[e]?e:"similarity"}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env[e]?e:"smart_sources"}};function Wc(n){let e={results_collection_key:{name:"Connection results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(()=>{let t=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&t.push({value:"smart_blocks",name:"Blocks"}),t},"options_callback")},results_limit:{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20)."}};return n.env.smart_blocks.settings.embed_blocks||(e.results_collection_key={type:"html",value:Wy("Connection results type",'Enable "Embed blocks" in Smart Blocks settings to use block connections.'),name:"Connection results type"}),e}r(Wc,"settings_config");var Qv={class:Ao,collection_key:"connections_lists",item_type:qe,settings_config:Wc};var ek=`.connections-codeblock {\r
.connections-top-bar {\r
display: flex;\r
gap: 0.5rem 1rem;\r
\r
.connections-actions {\r
display: flex;\r
flex-direction: row;\r
flex-wrap: wrap;\r
align-items: center;\r
gap: 0.5rem;\r
span {\r
font-weight: 600;\r
justify-self: end;\r
}\r
}\r
}\r
.connections-list {\r
padding-top: 0.85rem;\r
\r
> .sc-collapsed ul {\r
display: none;\r
}\r
> .sc-collapsed span svg {\r
transform: rotate(-90deg);\r
}\r
> .sc-result-pinned {\r
box-shadow: 0 0 0 1px var(--interactive-accent);\r
border-radius: var(--radius-s);\r
background-color: var(--background-modifier-hover);\r
}\r
}\r
}`;var Sn=require("obsidian");var Gc=require("obsidian");function Jm(n,e){let t=n.app.internalPlugins?.plugins?.webviewer?.instance;window.open(e,t?"_external":"_blank")}r(Jm,"open_url_externally");var Fe=class n extends Gc.Modal{static{r(this,"StoryModal")}constructor(e,{title:t,url:s}){super(e.app),this.plugin=e,this.title=t,this.url=s}static open(e,t){new n(e,t).open()}onOpen(){this.titleEl.setText(this.title),this.modalEl.addClass("sc-story-modal");let e=this.contentEl.createEl("div",{cls:"sc-story-container"});if(Gc.Platform.isMobile){e.createEl("button",{text:"Open in browser"}).addEventListener("click",()=>{Jm(this.plugin,this.url),this.close()});return}else{let t=e.createEl("webview",{attr:{src:this.url,allowpopups:""}});t.style.width="100%",t.style.height="100%",t.addEventListener("did-navigate",s=>{let i=s.url||t.getAttribute("src");i&&i!==this.url&&(Jm(this.plugin,i),this.close())})}}onClose(){this.contentEl.empty()}};function An(n=[]){return!Array.isArray(n)||!n.length?"":n.map(({item:e})=>{let t;e.key.endsWith("}")&&(t=`Lines: ${e.lines.join("-")}`);let s=CO(e);return s?t?`${s.replace(/\#\{\d+\}/,"")} (${t})`:s:""}).filter(Boolean).join(`
`)}r(An,"format_connections_as_links");function CO(n){if(!n?.key)return"";let[e,...t]=n.key.split("#"),s=e.split("/").pop().replace(/\.md$/i,"");if(t.length){let i=t.pop();return`- [[${s}#${i}]]`}return`- [[${s}]]`}r(CO,"get_wikilink");function Dt(n,e){return typeof e!="string"||!e.length||e.includes(":")||typeof n!="string"||!n.length?e:`${n}:${e}`}r(Dt,"build_prefixed_connection_key");function tk(n,e,t=Date.now()){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return n;let s=n[e]||{};return s.hidden=t,n[e]=s,n}r(tk,"apply_hidden_state");function sk(n,e,t=Date.now()){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return n;let s=n[e]||{};return s.pinned=t,n[e]=s,n}r(sk,"apply_pinned_state");function nk(n,e){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return n;let t=n[e];return!t||typeof t!="object"||(delete t.pinned,Object.keys(t).length||delete n[e]),n}r(nk,"remove_pinned_state");function ik(n){if(!n||typeof n!="object")return!1;let e=!1;return Object.entries(n).forEach(([t,s])=>{!s||typeof s!="object"||s.hidden===void 0||s.hidden===null||(delete s.hidden,Object.keys(s).length||delete n[t],e=!0)}),e}r(ik,"remove_all_hidden_states");function ok(n){if(!n||typeof n!="object")return!1;let e=!1;return Object.entries(n).forEach(([t,s])=>{!s||typeof s!="object"||s.pinned===void 0||s.pinned===null||(delete s.pinned,Object.keys(s).length||delete n[t],e=!0)}),e}r(ok,"remove_all_pinned_states");function rk(n){return!n||typeof n!="object"?0:Object.values(n).reduce((e,t)=>t&&typeof t=="object"&&t.hidden!==void 0&&t.hidden!==null?e+1:e,0)}r(rk,"count_hidden_connections");function ak(n){return!n||typeof n!="object"?0:Object.values(n).reduce((e,t)=>t&&typeof t=="object"&&t.pinned!==void 0&&t.pinned!==null?e+1:e,0)}r(ak,"count_pinned_connections");function So(n,e){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return!1;let t=n[e];return!t||typeof t!="object"?!1:t.pinned!==void 0&&t.pinned!==null}r(So,"is_connection_pinned");function Hc(n,e){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return!1;let t=n[e];return!t||typeof t!="object"?!1:t.hidden!==void 0&&t.hidden!==null}r(Hc,"is_connection_hidden");function Co(n=[],e={}){return!Array.isArray(n)||!n.length?[]:!e||typeof e!="object"?n:n.filter(t=>{let s=t?.item;if(!s)return!1;let i=Dt(s.collection_key,s.key),o=e[i];if(!o||typeof o!="object")return!0;let a=o.hidden!==void 0&&o.hidden!==null,c=o.pinned!==void 0&&o.pinned!==null;return!(a&&!c)})}r(Co,"filter_hidden_results");async function qO(n,e={}){return`<div class="connections-codeblock connections-item-view sc-connections-view">
<div class="connections-top-bar">
<div class="connections-actions">
${[{title:"Refresh connections",icon:"refresh-cw",attrs:'data-action="refresh-connections"'},{title:"Expand all",icon:"unfold-vertical",attrs:'data-action="expand-all"'},{title:"Collapse all",icon:"fold-vertical",attrs:'data-action="collapse-all"'},{title:"Send results to Smart Context",icon:"briefcase",attrs:'data-action="send-to-smart-context"'},{title:"Copy as list of links",icon:"copy",attrs:'data-action="copy-as-links"'},{title:"Connections settings",icon:"settings",attrs:'data-action="open-settings"'},{title:"Help & getting started",icon:"help-circle",attrs:'data-action="open-help"'}].map(i=>`
<button
aria-label="${i.title}"
${i.attrs??""}
>
${this.get_icon_html(i.icon)}
</button>
`).join("")}
<span>Smart Connections</span>
</div>
</div>
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div>`}r(qO,"build_html");async function lk(n,e={}){let t=await qO.call(this,n,e),s=this.create_doc_fragment(t);this.apply_style_sheet(ek);let i=s.firstElementChild;return OO.call(this,n,i,e),s}r(lk,"render");async function OO(n,e,t={}){let s=e.querySelector(".connections-list-container"),i=n.env,o=i.plugin.app||window.app,a=r(async()=>{console.log("Rendering connections list in codeblock view");let c=t.connections_list_component_key||n.connections_list_component_key||"connections_list_v3",l=await i.smart_components.render_component(c,n,t);this.empty(s),s.appendChild(l)},"render_list");if(!e._has_listeners){e._has_listeners=!0,e.querySelector('[data-action="refresh-connections"]')?.addEventListener("click",async()=>{let g=n.item;g?(await g.read(),g.queue_import(),await g.collection.process_source_import_queue?.(),a()):console.warn("No entity found for refresh")}),e.querySelector('[data-action="expand-all"]')?.addEventListener("click",()=>{e.querySelectorAll(".sc-result").forEach(g=>{g.classList.remove("sc-collapsed")})}),e.querySelector('[data-action="collapse-all"]')?.addEventListener("click",()=>{e.querySelectorAll(".sc-result").forEach(g=>{g.classList.add("sc-collapsed")})}),e.querySelector('[data-action="send-to-smart-context"]')?.addEventListener("click",async()=>{let g=await ck(n,t);if(!g.length)return new Sn.Notice("No connection results to send to Smart Context");let w=n?.item?.data?.connections||{},x=Co(g,w);if(!x.length)return new Sn.Notice("No visible connection results to send to Smart Context");let b=i.smart_contexts.new_context();b.add_items(x.map(C=>({key:C.item.key,score:C.score}))),b.emit_event("context_selector:open"),n.emit_event("connections:sent_to_context")}),e.querySelector('[data-action="copy-as-links"]')?.addEventListener("click",async()=>{let g=await ck(n,t);if(!g.length)return new Sn.Notice("No connection results to copy");let w=n?.item?.data?.connections||{},x=Co(g,w),b=An(x);if(!b)return new Sn.Notice("No visible connection results to copy");await nt(b),new Sn.Notice("Copied connections as list of links"),n.emit_event("connections:copied_list")}),e.querySelector('[data-action="open-settings"]')?.addEventListener("click",()=>{o.setting.open(),o.setting.openTabById("smart-connections")});let f=r(()=>{Fe.open(i.plugin,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=connections-view-help#page=understanding-connections-1"})},"open_help");e.querySelector('[data-action="open-help"]')?.addEventListener("click",f)}return a(),e}r(OO,"post_process");async function ck(n,e={}){let t=Array.isArray(n?.results)?n.results:[];if(t.length)return t;try{let s=await n.get_results({...e});return Array.isArray(s)?s:[]}catch(s){return console.error("Failed to fetch connections results",s),[]}}r(ck,"get_results_fallback");var Ft=require("obsidian");var dk=new CSSStyleSheet;dk.replaceSync(`a.sc-result-file-title{text-decoration:none!important}a.sc-result-file-title>.sc-score{display:inline-block;width:4.5ch;height:1.7em;line-height:1.7em;text-align:center;font-weight:600!important;font-size:.8em!important;color:var(--nav-item-color)!important;background:var(--background-modifier-hover);border-radius:6px}a.sc-result-file-title>.sc-path{margin-right:-3px}a.sc-result-file-title>.sc-path,a.sc-result-file-title>.sc-title{font-weight:700!important;text-decoration:underline}a.sc-result-file-title>.sc-breadcrumb:not(.sc-path,.sc-title,.sc-score){font-style:italic}a.sc-result-file-title>.sc-breadcrumb-separator{color:color-mix(in srgb,var(--text-normal) 50%,transparent)!important}.sc-result.sc-result-graph-focus{outline:2px solid color-mix(in srgb,var(--interactive-accent) 70%,transparent);border-radius:var(--radius-s);box-shadow:0 0 0 1px color-mix(in srgb,var(--background-primary) 80%,transparent),0 0 .5rem color-mix(in srgb,var(--interactive-accent) 45%,transparent);transition:outline .12s ease,box-shadow .12s ease}
`);var _k=dk;function qo(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();return s.push(a),o.length&&s.push(o.pop()),s.join(" > ")}r(qo,"get_item_display_name");function uk(n){if(!n)return"";let[e,...t]=n.split("#"),s=e.split("/").pop().replace(/\.md$/,"");if(!t.length)return`[[${s}]]`;let i=t.filter(o=>!o.startsWith("{")).pop();return i?`[[${s}#${i}]]`:`[[${s}]]`}r(uk,"parse_item_key_to_wikilink");function $O(n,e,t,s){let i=n.dragManager,o=uk(e.key),a=i.dragLink(s,o);i.onDragStart(s,a),t.drag_event_key?e.emit_event(t.drag_event_key):e.emit_event("connections:drag_result")}r($O,"handle_connection_drag");function mk(n,e,t={}){let i=e.env.obsidian_app;n.setAttribute("draggable","true"),n.addEventListener("dragstart",$O.bind(null,i,e,t))}r(mk,"register_item_drag");async function jO(n,e={}){let t=n.item,s=t.env,i=n.score,o=e.connections_settings??s.connections_lists.settings,a=o.components?.connections_list_item_v3||{},c=NO(i,t,a);return`<div class="temp-container">
<div
class="sc-result ${o.expanded_view?"":"sc-collapsed"}"
data-path="${t.path.replace(/"/g,"&quot;")}"
data-link="${t.link?.replace(/"/g,"&quot;")||""}"
data-collection="${t.collection_key}"
data-score="${i}"
data-key="${t.key}"
draggable="true"
>
<span class="header">
${this.get_icon_html("right-triangle")}
<a class="sc-result-file-title" href="#" title="${t.path.replace(/"/g,"&quot;")}" draggable="true">
${c}
</a>
</span>
<ul draggable="true">
<li class="sc-result-file-title" title="${t.path.replace(/"/g,"&quot;")}" data-collection="${t.collection_key}" data-key="${t.key}"></li>
</ul>
</div>
</div>`}r(jO,"build_html");async function pk(n,e={}){this.apply_style_sheet(_k);let t=await jO.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".sc-result");return TO.call(this,n,i,e),i}r(pk,"render");async function TO(n,e,t={}){let{item:s}=n,i=s.env,o=i.smart_connections_plugin,a=o.app,l=(t.connections_settings??i.connections_lists.settings).components?.connections_list_item_v3||{},d=l?.render_markdown??!0;d||e.classList.add("sc-result-plaintext");let _=n.connections_list?.item,u=Dt(s.collection_key,s.key);e.dataset.prefixedKey=u;let p=_?.data?.connections;Hc(p,u)&&(e.style.display="none",e.dataset.hidden="true"),So(p,u)&&(e.classList.add("sc-result-pinned"),e.dataset.pinned="true");let f=r(async b=>{if(!b.querySelector("li").innerHTML){let C=b.dataset.collection,k=i[C].get(b.dataset.path),A;IO(k)?A=`${k.embed_link}

${await k.read()}`:A=MO(await k.read());let q;d?q=await this.render_markdown(A,k):q=this.create_doc_fragment(A),e.querySelector("li").appendChild(q)}},"render_result");e.querySelector(".header .svg-icon.right-triangle").addEventListener("click",LO);let g=t.event_key_domain||"connections",w=`${g}:drag_result`;return mk(e,s,{drag_event_key:w}),kc(e,s,{event_key_domain:g}),e.addEventListener("click",b=>{Pc(s,b),s.emit_event(`${g}:open_result`,{event_source:"connections-list-item-v3"})}),new MutationObserver(b=>{b.some(k=>{let A=k.target;return k.attributeName==="class"&&k.oldValue?.includes("sc-collapsed")!==A.classList.contains("sc-collapsed")})&&!b[0].target.classList.contains("sc-collapsed")&&f(b[0].target)}).observe(e,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),o.registerDomEvent(e,"contextmenu",b=>{if(b.preventDefault(),b.stopPropagation(),!_)return;_.data.connections||={};let C=Dt(s.collection_key,s.key),k=So(_.data.connections,C),A=rk(_.data.connections),q=ak(_.data.connections),O=n.connections_list?.results||[],S=qo(s,l)||s.key;console.log({target_name:S,item:s});let m=new Ft.Menu(a);m.addItem(v=>{v.setTitle(`Hide ${S}`).setIcon("eye-off").onClick(()=>{try{tk(_.data.connections,C,Date.now()),_.data.hidden_connections&&(delete _.data.hidden_connections[s.key],Object.keys(_.data.hidden_connections).length||delete _.data.hidden_connections),_.queue_save(),e.style.display="none",e.dataset.hidden="true",_.collection.save()}catch(j){new Ft.Notice("Hide failed \u2013 check console"),console.error(j)}})}),m.addItem(v=>{let j=k?"Unpin":"Pin";v.setTitle(`${j} ${S}`).setIcon(k?"pin-off":"pin").onClick(()=>{try{k?(nk(_.data.connections,C),e.classList.remove("sc-result-pinned"),e.removeAttribute("data-pinned")):(sk(_.data.connections,C,Date.now()),e.classList.add("sc-result-pinned"),e.dataset.pinned="true"),_.queue_save(),_.collection.save()}catch(E){new Ft.Notice(`${j} failed \u2013 check console`),console.error(E)}})}),m.addSeparator();let h=An(O);h&&m.addItem(v=>{v.setTitle("Copy as list of links").setIcon("copy").onClick(async()=>{await nt(h),new Ft.Notice("Connections links copied to clipboard"),n.connections_list.emit_event("connections:copied_list")})}),m.addSeparator(),m.addItem(v=>{v.setTitle(`Unhide All (${A})`).setIcon("eye").setDisabled(!A).onClick(()=>{try{if(!_.data.connections||!ik(_.data.connections))return;_.data.hidden_connections&&delete _.data.hidden_connections,_.queue_save(),e.closest(".sc-connections-view")?.querySelector('[title="Refresh"]')?.click(),_.collection.save()}catch(j){new Ft.Notice("Unhide failed \u2013 check console"),console.error(j)}})}),m.addItem(v=>{v.setTitle(`Unpin All (${q})`).setIcon("pin-off").setDisabled(!q).onClick(()=>{try{if(!_.data.connections||!ok(_.data.connections))return;e.closest(".connections-list")?.querySelectorAll(".sc-result[data-pinned]").forEach($=>{$.classList.remove("sc-result-pinned"),$.removeAttribute("data-pinned")}),_.queue_save(),_.collection.save()}catch(j){new Ft.Notice("Unpin failed \u2013 check console"),console.error(j)}})}),m.showAtMouseEvent(b)}),e.classList.contains("sc-collapsed")||f(e),e}r(TO,"post_process");function NO(n,e,t={}){let s=qo(e,t).split(" > ").filter(Boolean),i=PO(s,e?.lines),o=i.pop(),a=typeof n=="number"?n.toFixed(2):"",c='<small class="sc-breadcrumb-separator"> &gt; </small>',l=i.map(d=>`<small class="sc-breadcrumb">${d}</small>`).join(c);return[`<small class="sc-breadcrumb sc-score">${a}</small>`,`${l}${c}`,`<small class="sc-breadcrumb sc-title">${o}</small>`].join("")}r(NO,"get_result_header_html");function PO(n,e=[]){if(!Array.isArray(n)||!n.length)return[];let t=Array.isArray(e)&&e.length;return n.map(s=>t&&s.startsWith("{")?`Lines: ${e.join("-")}`:s)}r(PO,"format_item_parts");function IO(n){return n?!!n.is_media:!1}r(IO,"should_render_embed");function MO(n){return n.includes("```dataview")&&(n=n.replace(/```dataview/g,"```\\dataview")),n.includes("```smart-context")&&(n=n.replace(/```smart-context/g,"```\\smart-context")),n.includes("```smart-chatgpt")&&(n=n.replace(/```smart-chatgpt/g,"```\\smart-chatgpt")),n.includes("![[")&&(n=n.replace(/\!\[\[/g,"! [[")),n}r(MO,"process_for_rendering");function LO(n){n.preventDefault(),n.stopPropagation(),n.target.closest(".sc-result").classList.toggle("sc-collapsed")}r(LO,"toggle_result");var hk={show_full_path:{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results.",default:!0},render_markdown:{name:"Render markdown",type:"toggle",description:"Turn off to prevent rendering markdown and display connection results as plain text.",default:!0}};async function zO(n,e={}){return`<div><div class="connections-list sc-list" data-key="${n.item.key}"></div></div>`}r(zO,"build_html");async function fk(n,e={}){let t=await zO.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".connections-list");return RO.call(this,n,i,e),i}r(fk,"render");async function RO(n,e,t={}){e.dataset.key=n.item.key;let s=await n.get_results(t);if(!s||!Array.isArray(s)||s.length===0){let a=this.create_doc_fragment(`<p class="sc-no-results">No results found.<br><em>Try using the refresh button. If that doesn't work, try running "Clear sources data" and then "Reload sources" in the Smart Environment settings.</em></p>`);return e.appendChild(a),e}let i=n.env.smart_components;return(await Promise.all(s.map(a=>i.render_component("connections_list_item_v3",a,{...t})))).forEach(a=>e.appendChild(a)),e}r(RO,"post_process");var gk="List only";var bk=require("obsidian");async function DO(n){return`
<div>
<div data-user-agreement></div>
<div class="actions-container">
<button class="sc-getting-started-button">Getting started guide</button>
<button class="sc-report-bug-button">Report a bug</button>
<button class="sc-request-feature-button">Request a feature</button>
<button class="sc-share-workflow-button">Share workflow \u2B50</button>
</div>
</div>
`}r(DO,"build_html");async function yk(n){let e=await DO.call(this,n),s=this.create_doc_fragment(e).firstElementChild;return FO.call(this,n,s),s}r(yk,"render");async function FO(n,e){let t=e.querySelector("[data-user-agreement]");if(t){let i=await n.env.render_component("user_agreement_callout",n);t.appendChild(i)}let s=e.querySelector("#header-callout a");return s&&s.addEventListener("click",i=>{i.preventDefault(),window.open(s.href,"_external")}),e.querySelector(".sc-getting-started-button")?.addEventListener("click",()=>{Fe.open(n,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-settings"})}),e.querySelector(".sc-report-bug-button")?.addEventListener("click",()=>{if(n.env?.is_pro){new Km(n.app).open();return}window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=bug_report.yml","_external")}),e.querySelector(".sc-request-feature-button")?.addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=feature_request.yml","_external")}),e.querySelector(".sc-share-workflow-button")?.addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/discussions/new?category=showcase","_external")}),e}r(FO,"post_process");var Km=class extends bk.Modal{static{r(this,"ScProSupportModal")}open(){super.open(),this.titleEl.setText("Need help and support?");let e=this.contentEl.createDiv({cls:"sc-pro-support-modal"});e.createEl("p",{text:"Reply to your Smart Environment Pro welcome email for priority support."}),e.createEl("button",{text:"Report a bug",cls:"mod-warning"}).addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=bug_report.yml","_external")}),e.createEl("button",{text:"Close"}).addEventListener("click",()=>{this.close()})}};var vk=`.connections-view-early {
.connections-top-bar {
display: flex;
gap: 0.5rem 1rem;

.connections-actions {
display: flex;
flex-direction: row;
flex-wrap: wrap;
flex: 0 0 auto;
}

.sc-context {
display: flex;
flex-direction: column;
margin: 0;
gap: 0.1rem;
width: auto;
flex: 1 1 auto;

.sc-context-line {
line-height: 1.1;
}

.sc-context-line--parent {
color: var(--text-muted);
font-size: 0.85em;
}

.sc-context-line--focus {
color: var(--text-normal);
font-size: 1.05em;
font-weight: 600;
}
}
}
.connections-list {
padding-top: 0.85rem;

> .sc-collapsed ul {
display: none;
}
> .sc-collapsed span svg {
transform: rotate(-90deg);
}
> .sc-result-pinned {
box-shadow: 0 0 0 1px var(--interactive-accent);
border-radius: var(--radius-s);
background-color: var(--background-modifier-hover);
}
}
}`;var Cn=require("obsidian");function kk(n){let e=n.key,t="",s="",i=[];if(e.includes("#")){if(i=e.split("#"),s=i.pop().trim(),s[0]==="{"){let o=n.lines.join("-");s=i.pop().trim()+` Lines: ${o}`}t=i.filter(Boolean).join("#")}else e.includes("/")&&(i=e.split("/"),s=i.pop().trim());return t=i.filter(Boolean).join(" \u203A "),[t,s]}r(kk,"get_context_lines");async function wk(n){let s=n.target.closest(".connections-view")?.querySelector(".connections-list")?.dataset?.key;console.log(`Refreshing smart connections view entity ${s}`);let i=this.env.smart_sources.get(s);i?(await i.read(),i.queue_import(),await i.collection.process_source_import_queue?.(),this.render_view(i)):console.warn("No entity found for refresh")}r(wk,"connections_view_refresh_handler");async function UO(n,e={}){let t=!!n.paused;return`<div><div class="connections-view connections-item-view sc-connections-view connections-view-early">
<div class="sc-top-bar connections-top-bar">
<div class="connections-actions">
${[{title:t?"Resume auto-refresh":"Pause auto-refresh",icon:t?"play-circle":"pause-circle",attrs:`data-action="toggle-pause" aria-pressed="${t}"`},{title:"More actions",icon:"menu",attrs:'data-action="open-menu"'}].map(a=>`
<button
aria-label="${a.title}"
${a.attrs??""}
>
${this.get_icon_html(a.icon)}
</button>
`).join("")}
</div>
<p class="sc-context" data-key="">
Loading...
</p>
</div>
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div></div>`}r(UO,"build_html");async function xk(n,e={}){let t=await UO.call(this,n,e),s=this.create_doc_fragment(t);this.apply_style_sheet(vk);let i=s.querySelector(".sc-connections-view");return WO.call(this,n,i,e),s}r(xk,"render");async function WO(n,e,t={}){let s=e.querySelector(".connections-list-container"),i=e.querySelector(".sc-top-bar .sc-context"),o=n.env,a=t.connections_item;if(!a)return s.textContent="No source item detected for current active view.",e;let c=a.connections||o.connections_lists.new_item(a);if(!e._has_listeners){e._has_listeners=!0,e.querySelector('[data-action="toggle-pause"]')?.addEventListener("click",()=>{n.toggle_connections_paused()});let x=r(()=>{Fe.open(n.plugin,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=connections-view-help#page=understanding-connections-1"})},"open_help");e.querySelector('[data-action="open-menu"]')?.addEventListener("click",C=>{let k=new Cn.Menu(n.plugin.app),A=Array.isArray(c?.results)?c.results:[],q=c?.item?.data?.connections||{},O=Co(A,q);k.addItem(S=>{S.setTitle("Refresh connections").setIcon("refresh-cw").onClick(()=>{wk.call(n,{target:e})})}),k.addItem(S=>{S.setTitle("Send results to Smart Context").setIcon("briefcase").setDisabled(!O.length).onClick(async()=>{if(!O.length)return new Cn.Notice("No connection results to send to Smart Context");let m=o.smart_contexts.new_context();m.add_items(O.map(h=>({key:h.item.key,score:h.score}))),m.emit_event("context_selector:open"),c.emit_event("connections:sent_to_context")})}),k.addItem(S=>{let m=An(O);S.setTitle("Copy as list of links").setIcon("copy").setDisabled(!m).onClick(async()=>{if(!m)return new Cn.Notice("No connection results to copy");await nt(m),new Cn.Notice("Connections links copied to clipboard"),c.emit_event("connections:copied_list")})}),k.addItem(S=>{let h=(t.connections_settings??c?.settings)?.expanded_view,v=h?"Collapse all results":"Expand all results",j=h?"fold-vertical":"unfold-vertical";S.setTitle(v).setIcon(j).onClick(()=>{let E=t.connections_settings??c?.settings,$=E?.expanded_view;E&&(E.expanded_view=!$),e.querySelectorAll(".sc-result").forEach(N=>{$?N.classList.add("sc-collapsed"):N.classList.remove("sc-collapsed")})})}),k.addSeparator(),k.addItem(S=>{S.setTitle("Connections settings").setIcon("settings").onClick(()=>{n.open_settings()})}),k.addItem(S=>{S.setTitle("Help & getting started").setIcon("help-circle").onClick(x)}),k.showAtMouseEvent(C)})}let l=t.connections_list_component_key||c.connections_list_component_key||"connections_list_v3",d=await o.smart_components.render_component(l,c,t);this.empty(s),s.appendChild(d);let _=c?.item||a,[u,p]=kk(_);this.empty(i);let f=i.ownerDocument;[{text:u,class_name:"sc-context-line sc-context-line--parent"},{text:p,class_name:"sc-context-line sc-context-line--focus"}].forEach(w=>{let x=f.createElement("span");x.className=w.class_name,x.textContent=w.text||"\xA0",i.appendChild(x)}),i.dataset.key=a.key;let g=e.querySelector('[data-action="toggle-pause"]');if(g){let w=r(x=>{let b=x?"Resume auto-refresh":"Pause auto-refresh";g.title=b,g.setAttribute("aria-label",`${b}`),g.setAttribute("aria-pressed",String(x)),this.safe_inner_html(g,this.get_icon_html(x?"play-circle":"pause-circle"))},"update_pause_button");w(!!n.paused),n.register_pause_controls({update:w})}return e}r(WO,"post_process");var Ek=new CSSStyleSheet;Ek.replaceSync(`.lookup-item-view{display:flex;flex-direction:column;gap:1rem}.lookup-item-view .lookup-query-form{display:flex;flex-direction:column;gap:.5rem}.lookup-item-view .lookup-query-label{font-size:.75rem;font-weight:600;letter-spacing:.03em;text-transform:uppercase;color:var(--text-muted)}.lookup-item-view .lookup-query-input{resize:vertical;min-height:5rem;padding:.75rem;border-radius:var(--radius-m);border:1px solid var(--background-modifier-border);background-color:var(--background-secondary);color:var(--text-normal);font-size:.95rem;line-height:1.5}.lookup-item-view .lookup-query-input:focus{outline:none;border-color:var(--interactive-accent);box-shadow:0 0 0 2px color-mix(in srgb,var(--interactive-accent) 30%,transparent)}.lookup-item-view .lookup-list-container{display:flex;flex-direction:column;gap:.5rem}
`);var Ak=Ek;var GO=300,HO="Enter a lookup query to continue.",VO="Describe the idea, topic, or question you want to explore\u2026",Ym="Use semantic (embeddings) search to surface relevant notes. Results are sorted by similarity to your query. Note: returns different results than lexical (keyword) search.";async function JO(n,e={}){return`<div><div class="lookup-item-view sc-connections-view connections-view-early">
<form class="lookup-query-form" novalidate>
<label class="lookup-query-label" for="lookup-query-input" title="${Ym}">Smart Lookup</label>
<textarea
class="lookup-query-input"
id="lookup-query-input"
name="lookup-query"
rows="4"
placeholder="${VO}"
required
></textarea>
</form>
<div class="lookup-list-container">
<p>${Ym}</p>
</div>
</div></div>`}r(JO,"build_html");async function Sk(n,e={}){this.apply_style_sheet(Ak);let t=await JO.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".lookup-item-view");return KO.call(this,n,i,e),i}r(Sk,"render");async function KO(n,e,t={}){let s=e.querySelector(".lookup-query-input"),i=e.querySelector(".lookup-query-form"),o=e.querySelector(".lookup-list-container"),a={last_query:null},c=r(async d=>{let _=XO(d);if(ZO({input_el:s,query:_}),!_){this.empty(o),o.innerHTML=`<p>${Ym}</p>`;return}if(_===a.last_query)return;a.last_query=_;let u={...t,query:_},p=n.env.lookup_lists.new_item(u),f=await n.env.render_component("lookup_list",p,u);this.empty(o),o.appendChild(f)},"submit_query"),l=YO(c);return s.addEventListener("input",()=>{l(s.value)}),i.addEventListener("submit",d=>{d.preventDefault(),l.cancel?.(),c(s.value)}),e}r(KO,"post_process");function YO(n,e=GO){let t,s=r(i=>{t&&clearTimeout(t),t=setTimeout(()=>{t=void 0,n(i)},e)},"schedule");return s.cancel=()=>{t&&(clearTimeout(t),t=void 0)},s}r(YO,"create_debounced_submit");function XO(n){return typeof n!="string"?"":n.trim()}r(XO,"sanitize_query");function ZO({input_el:n,query:e}){n?.setCustomValidity&&(e?n.setCustomValidity(""):n.setCustomValidity(HO))}r(ZO,"update_query_validity");async function QO(n,e={}){return`<div><div class="lookup-list connections-list sc-list" data-key="${n.item.key}"></div></div>`}r(QO,"build_html");async function Ck(n,e={}){let t=await QO.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".lookup-list");return e$.call(this,n,i,e),i}r(Ck,"render");async function e$(n,e,t={}){e.dataset.key=n.key;let s=await n.get_results(t);if(!s||!Array.isArray(s)||s.length===0){let a=this.create_doc_fragment('<p class="sc-no-results">No results found</p>');return e.appendChild(a),e}let i=n.env.smart_components;return(await Promise.all(s.map(a=>i.render_component("connections_list_item_v3",a,{event_key_domain:"lookup",...t})))).forEach(a=>e.appendChild(a)),e}r(e$,"post_process");function Vc(n){n.limit||(n.limit=this.settings?.results_limit??20),n.results_collection_key||(n.results_collection_key=this.collection.results_collection_key),n.filter||(n.filter={}),n.score_algo_key||(n.score_algo_key=this.collection.score_algo_key),n.to_item=this.item,n.filter.exclude_keys||(n.filter.exclude_keys=[]),n.filter.exclude_key_starts_with_any||(n.filter.exclude_key_starts_with_any=[]),t$(this,n);let e=new Set(n.filter.exclude_keys);if(e.add(this.item.key),n.hidden_keys.forEach(t=>e.add(t)),n.pinned_keys.forEach(t=>e.add(t)),n.filter.exclude_keys=Array.from(e),n.results_collection_key==="smart_blocks"){let t=new Set(n.filter.exclude_key_starts_with_any);t.add(this.item.key),n.hidden_keys.forEach(s=>t.add(s)),n.pinned_keys.forEach(s=>t.add(s)),n.filter.exclude_key_starts_with_any=Array.from(t),this.collection.settings.exclude_frontmatter_blocks&&((!n.filter.exclude_key_ends_with_any||!Array.isArray(n.filter.exclude_key_ends_with_any))&&(n.filter.exclude_key_ends_with_any=[]),n.filter.exclude_key_ends_with_any.push("---frontmatter---"))}}r(Vc,"pre_process");function t$(n,e){e.hidden=[],e.hidden_keys=[],e.pinned=[],e.pinned_keys=[];let t=n.item.data?.connections||{};Object.entries(t).forEach(([s,i])=>{if(!i||i.hidden==null&&i.pinned==null)return;let[o,...a]=s.split(":");if(!o||!a.length)return;let c=a.join(":"),l=n.env[o];if(!l)return;let d=l.get(c);d&&(i.hidden&&!i.pinned&&(e.hidden.push(d),e.hidden_keys.push(c)),i.pinned&&(e.pinned.push(d),e.pinned_keys.push(c)))})}r(t$,"get_connections_feedback_items");var qk={collections:{connections_lists:Qv},item_types:{ConnectionsList:qe},items:{connections_list:{class:qe}},modules:{},components:{connections_codeblock:{render:lk},connections_list_item_v3:{render:pk,settings_config:hk},connections_list_v3:{render:fk,display_name:gk},connections_settings_header:{render:yk},connections_view_v3:{render:xk},lookup_item_view:{render:Sk},lookup_list:{render:Ck}},actions:{connections_list_pre_process:{action:Vc,pre_process:Vc}}};var Xm=require("obsidian");async function Ok(n,e,t=null,s={}){let{new_tab:i=!1}=s,o=n.env;e.endsWith("#")&&(e=e.slice(0,-1));let a,c=null;if(e.includes("#")){let[d]=e.split("#");a=n.app.metadataCache.getFirstLinkpathDest(d,""),c=o.smart_blocks.get(e)}else a=n.app.metadataCache.getFirstLinkpathDest(e,"");if(!a){console.warn(`[open_note] Unable to resolve file for ${e}`);return}let l;if(t){let d=Xm.Keymap.isModEvent(t),_=Xm.Keymap.isModifier(t,"Alt");d&&_?l=n.app.workspace.splitActiveLeaf("vertical"):d||i?l=n.app.workspace.getLeaf(!0):l=n.app.workspace.getMostRecentLeaf()}else l=n.app.workspace.getMostRecentLeaf();if(await l.openFile(a),typeof c?.line_start=="number"){let{editor:d}=l.view,_={line:c.line_start,ch:0};d.setCursor(_),d.scrollIntoView({to:_,from:_},!0)}}r(Ok,"open_note");var $k=require("obsidian");var Jc={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function s$(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(s$,"define_default_create_methods");var Kc=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,s$(Jc)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=Jc[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,$k.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,Jc["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var Yc=class extends ko{static{r(this,"ScEarlySettingsTab")}constructor(e,t){super(e,t),this.plugin=t}hide(){super.hide?.(),this.plugin_container?.empty?.(),this.turn_off_listener?.()}async render_header(e){let t=await this.env.smart_components.render_component("connections_settings_header",this.plugin);e.appendChild(t)}async render_plugin_settings(e){if(!e)return;e.empty?.(),e.innerHTML='<div class="sc-loading">Loading main settings...</div>',e.empty?.();let t=e.createDiv({cls:"sc-settings-tab__section",attr:{"data-section-key":"connections_lists"}});t.createEl("h1",{text:"Connections"});let s=this.env.config.collections.connections_lists.settings_config;xs(s,this.env.connections_lists,t,{default_group_name:"Connections lists",group_params:{"Connections lists":{heading_btn:[{label:"Learn about Connections Lists",btn_text:"Learn more",callback:r(()=>window.open("https://smartconnections.app/smart-connections/list-feature/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for Connections Lists",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#connections-lists","_external"),"callback")}]},Display:{heading_btn:{label:"Settings documentation for Display",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#display","_external"),"callback")}},"Score algorithm":{heading_btn:{label:"Settings documentation for Score Algorithms",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#score-algorithm","_external"),"callback")}},"Ranking algorithm":{heading_btn:{label:"Settings documentation for Ranking Algorithms",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#ranking-algorithm","_external"),"callback")}},Filters:{heading_btn:{label:"Settings documentation for Filters",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#filters","_external"),"callback")}},"Inline connections":{heading_btn:[{label:"Learn about the inline connections feature",btn_text:"Learn more",callback:r(()=>window.open("https://smartconnections.app/smart-connections/inline/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for inline connections",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#inline-connections","_external"),"callback")}]},"Footer connections":{heading_btn:{label:"Settings documentation for Footer Connections",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#footer-connections","_external"),"callback")}}}});let i=e.createDiv({cls:"sc-settings-tab__section",attr:{"data-section-key":"lookup_lists"}}),o=this.env.config.collections.lookup_lists.settings_config;xs(o,this.env.lookup_lists,i,{default_group_name:"Lookup lists",group_params:{"Lookup lists":{heading_btn:[{label:"Learn about Lookup Lists",btn_text:"Learn more",callback:r(()=>window.open("https://smartconnections.app/smart-connections/lookup/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for Lookup Lists",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#lookup-lists","_external"),"callback")}]}}}),this.register_env_events()}register_env_events(){this.turn_off_listener||!this.env?.events||(this.turn_off_listener=this.env.events.on("settings:changed",e=>{(e.path?.includes("connections_post_process")||e.path?.includes("score_algo_key")||e.path?.includes("connections_list_item"))&&this.render_plugin_settings(this.plugin_container)}))}};var Tk=require("obsidian");var Xc=require("obsidian");var Bt=class extends Xc.ItemView{static{r(this,"SmartItemView")}constructor(e,t){super(e),this.app=t.app,this.plugin=t}static get view_type(){throw new Error("view_type must be implemented in subclass")}static get display_text(){throw new Error("display_text must be implemented in subclass")}static get icon_name(){return"smart-connections"}static register_item_view(e){let t=this;e.registerView(t.view_type,l=>new t(l,e)),e.addCommand({id:t.view_type,name:"Open: "+t.display_text+" view",callback:r(()=>{t.open(e.app.workspace)},"callback")});let s=t.view_type.replace(/^smart-/,"").replace(/-/g,"_"),i="open_"+s;Object.getOwnPropertyDescriptor(e,s)||Object.defineProperty(e,s,{configurable:!0,enumerable:!1,get:r(()=>t.get_view(e.app.workspace),"get")}),e[i]=()=>t.open(e.app.workspace);let o=`${s}:open`,a=r(l=>{let d=typeof l?.active=="boolean"?l.active:!0;t.open(e.app.workspace,d)},"handler"),c=e?.env?.events.on(o,a);return typeof e.register=="function"&&typeof c=="function"&&e.register(()=>c()),{method_name:s,open_method_name:i,event_name:o}}static get_leaf(e){return e.getLeavesOfType(this.view_type)[0]}static get_view(e){let t=this.get_leaf(e);return t?t.view:void 0}static open(e,t={}){let{active:s=!0}=t,i=this.get_leaf(e);this.default_open_location==="root"?i?i.setViewState({type:this.view_type,active:s}):e.getLeaf(!1).setViewState({type:this.view_type,active:s}):(i?i.setViewState({type:this.view_type,active:s}):e.getRightLeaf(!1).setViewState({type:this.view_type,active:s}),e.rightSplit?.collapsed&&e.rightSplit.toggle()),setTimeout(()=>{this.get_view(e)?.render_view(t)},100)}static is_open(e){return this.get_leaf(e)?.view instanceof this}getViewType(){return this.constructor.view_type}getDisplayText(){return this.constructor.display_text}getIcon(){return this.constructor.icon_name}async onOpen(){this.app.workspace.onLayoutReady(this.initialize.bind(this))}async initialize(){if(await Rv(this),this.container.empty(),this.register_plugin_events(),this.app.workspace.registerHoverLinkSource(this.constructor.view_type,{display:this.getDisplayText(),defaultMod:!0}),this.render_view(),Xc.Platform.isMobile){let e=this.containerEl.querySelector(".status-bar-mobile")??this.containerEl.createDiv({cls:"status-bar-mobile"});e.empty();let t=e.createDiv({cls:"status-bar-item"});this.env.smart_components.render_component("status_bar",this.env).then(s=>t.appendChild(s))}}register_plugin_events(){}render_view(e={}){throw new Error("render_view must be implemented in subclass")}get container(){return this.containerEl.children[1]}get env(){return this.plugin.env}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}};var jk=`> [!NOTE] Patch v4.1.6
> - Added: milestones feature with modal and checklist components
> - Added: connections view menu option to copy results as links
> - Added: multilingual-e5-small embedding model support
> - Improved: settings tab with added "learn more" and "help" buttons to settings groups
> - Fixed: markdown parser should handle frontmatter correctly (prevent false-positive frontmatter detection)

> [!NOTE]- Previous patches
> > [!NOTE]- v4.1.4
> > - Added fallback for opening Pro login in case the button doesn't automatically open the browser as expected
>
> > [!NOTE]- v4.1.3
> > - Added link to documentation in settings for easier access
> > - Fixed highlight "Reset data" after embedding model change
>
> > [!NOTE]- v4.1.2
> > - Improved model configuration UX
> >   - Added "Delete" functionality to better manage models
> > - Enhanced UI for settings and improved styling
> > - Pro: Updated score algorithm settings to clarify descriptions
>
> > [!NOTE]- v4.1.1
> > - Connections codeblock view should render as expected without errors
>
>
# Smart Connections \`v4\`\r
\r
## What's new in v4\r
\r
Smart Connections v4 focuses the core plugin on a simple promise: install, enable, and AI-powered connections just work. Advanced configuration and power-user workflows now live in Pro plugins. Read [Introducing Pro Plugins](https://smartconnections.app/introducing-pro-plugins/?utm_source=connections-release-notes) to learn more.\r
\r
### Pause connections\r
\r
Use the new Connections "pause" button to freeze the connections results. This allows you to move through your vault while keeping the connections to a specific note visible while you work.\r
\r
### Copy connections as list of links\r
\r
Right-click the connections results to *copy all links* to clipboard.\r
\r
### Copy all connections content (Context Engineering)\r
\r
Click the connections view menu button and "Send to Smart Context" (briefcase icon) option. This allows you to quickly copy *all content from the connections* to clipboard for use as context with any AI chat! The Smart Context view also lets you add or remove items before copying all to the clipboard in one-click!\r
\r
### Pinned connections\r
\r
In addition to "hiding" connections, you can now "Pin" connections. This ensures the pinned connections are always visible in the connections view. **Connections Pro:** *Hidden and pinned connections are used by new connections algorithms (available in Pro) to improve results!*\r
\r
### Events and notifications\r
\r
Important events are now surfaced in a dedicated notifications modal:\r
\r
- On desktop, click the Smart Env item in the status bar to open the notifications modal.  \r
- On mobile, a Smart Environment notice appears at the bottom of the Connections view; tap it to review events.\r
\r
Examples of events you might see:\r
\r
- Initial indexing complete for your vault  \r
- Sources reimported after model changes  \r
- Warnings when exclusions block indexing on specific folders or files  \r
\r
Objectives of the new Events system:\r
\r
- make the environment inspectable and understandable\r
- reduce the number of Obsidian native notifications\r
\r
### Connections Pro\r
\r
Connections Pro builds on the core plugin and Smart Environment to give power users more control.\r
\r
![](https://smartconnections.app/assets/connections-view-pro-notes.gif)\r
\r
Examples of Pro features:\r
\r
- **Inline connections**  \r
Small badges in the editor that show how many strong matches a block has, with a pop-over of related blocks and notes.  \r
- **Footer connections**  \r
A persistent panel that updates as you type so high value connections stay visible while you write.  \r
- **Configurable scoring and ranking**  \r
Choose different algorithms for how results are scored and optionally add a rerank stage.  \r
- **Connections in Bases**  \r
Use \`score_connection\` and \`list_connections\` in Obsidian Bases to show similarity columns and related note lists in tables.  \r
- **Advanced filters and models**  \r
Extra Smart Environment controls for embeddings, collections, and include or exclude rules.  \r
- **Early release experiments**  \r
New ideas launch in Early channels first so supporters can shape how they evolve.\r
\r
Connections Pro is part of the [Pro plugins](https://smartconnections.app/pro-plugins/?utm_source=connections-release-notes) family and is available to active project supporters. It is still built on the same open Smart Environment. Supporting Pro helps fund development of all Smart Plugins and the free core.
`;var qn=class n extends Bt{static{r(this,"ReleaseNotesView")}static get view_type(){return"smart-release-notes-view"}static get display_text(){return"Release Notes"}static get icon_name(){return"file-text"}static open(e,t,s=!0){e.getLeaf("tab").setViewState({type:this.view_type,active:s,state:{version:t}})}getViewType(){return n.view_type}getDisplayText(){return n.display_text}getIcon(){return n.icon_name}onOpen(){this.titleEl.setText(`What\u2019s new in v${this.version}`),this.render()}get container(){let e=this.containerEl?.querySelector(".view-content"),t=e?.querySelector(".markdown-preview-view");return t||(t=e?.createDiv("cm-scroller is-readable-line-width")?.createDiv("markdown-preview-view markdown-rendered")),t}async render(){for(;!this.container;)await new Promise(e=>setTimeout(e,100)),console.warn("Waiting for containerEl to be ready...",this.container);await Tk.MarkdownRenderer.render(this.app,jk,this.container,"",this),this.container.querySelectorAll("a").forEach(e=>{e.setAttribute("target","_external")}),requestAnimationFrame(()=>this.#e(this.container,this.version))}get version(){return this.leaf.viewState?.state?.version??this.app.plugins.getPlugin("smart-connections")?.manifest.version??""}#e(e,t){if(!t)return;let s=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`\\bv?${s}\\b`,"i");e.querySelectorAll("h1,h2,h3,h4,h5,h6").forEach(o=>{i.test(o.textContent??"")&&o.scrollIntoView({behavior:"smooth",block:"start"})})}};async function Nk(n,e,{rng:t=Math.random}={}){if(!n?.smart_sources||!e)return null;let s=n.smart_sources.get(e);if(!s?.should_embed)return null;let i=await s.connections.get_results({limit:20});return!Array.isArray(i)||i.length===0?null:n$(i,{rng:t})}r(Nk,"get_random_connection");function n$(n,{rng:e}){let t=n.map(a=>({connection:a,score:Math.max(0,typeof a?.score=="number"?a.score:0)})),s=t.reduce((a,{score:c})=>a+c,0);if(s===0)return n[0];let i=e()*s,o=0;for(let{connection:a,score:c}of t)if(o+=c,i<o)return a;return n.at(-1)}r(n$,"pick_weighted_connection");var Pk=require("obsidian");function Ik(){(0,Pk.addIcon)("smart-dice",`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
<rect x="1" y="1" width="22" height="22" rx="2" fill="none"/>

<g transform="translate(12 10) scale(0.18) translate(-50 -50)">
<path d="M50 20 L80 40 L80 60 L50 100" fill="none" stroke="currentColor" stroke-width="4"/>
<path d="M30 50 L55 70" fill="none" stroke="currentColor" stroke-width="5"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="75" cy="40" r="9" fill="currentColor"/>
<circle cx="75" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="25" cy="50" r="9" fill="currentColor"/>
</g>
</svg>
`)}r(Ik,"add_smart_dice_icon");function Mk(n,e){let t=!!e;return n.paused=t,n.pause_controls?.update?.(t),t}r(Mk,"apply_pause_state");function Lk(n){let e=!n.paused;return n.paused=e,n.pause_controls?.update?.(e),e}r(Lk,"toggle_pause_state");var Qc=class extends Bt{static{r(this,"ConnectionsItemView")}static get view_type(){return"smart-connections-view"}static get display_text(){return"Connections"}static get icon_name(){return"smart-connections"}constructor(e,t){super(e,t),this.paused=!1,this.pause_controls=null,this.current=null}async render_view(e={},t=this.container){if(!e.connections_item){let i=this.plugin.app.workspace.getActiveFile()?.path;e.connections_item=this.env.smart_sources.get(i)}this.current=e.connections_item,this.pause_controls=null;let s=await this.env.smart_components.render_component("connections_view_v3",this,{connections_item:e.connections_item});t.empty(),t.appendChild(s),this.register_env_listeners(),this.env.events.emit("connections:opened")}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}register_env_listeners(){let e;Zc(this,"sources:opened",(t={})=>{if(this.paused||!Zm(this.container))return;let s=this.env[t.collection_key||"smart_sources"]?.get(t.item_key||t.key);s.key!==this.current?.key&&(e&&clearTimeout(e),e=setTimeout(()=>{this.render_view({connections_item:s})},250))}),Zc(this,"settings:changed",t=>{t.path?.includes("expanded_view")||t.path?.includes("connections_lists")&&Zm(this.container)&&this.render_view({connections_item:this.current})}),Zc(this,"connections:show",t=>{if(console.log("connections:show event received",{event:t}),t.collection_key&&t.item_key){let s=this.env[t.collection_key],i=s.get(t.item_key);console.log({collection:s,item:i}),i&&(this.set_connections_paused(!0),this.render_view({connections_item:i}))}}),Zc(this,"item:embedded",t=>{t.item_key===this.current?.key&&Zm(this.container)&&this.render_view({connections_item:this.current})})}register_pause_controls(e){this.pause_controls=e,this.pause_controls?.update(this.paused)}set_connections_paused(e){return Mk(this,e)}toggle_connections_paused(){return Lk(this)}};function Zm(n){return n?n.isConnected?typeof n.checkVisibility=="function"&&n.checkVisibility()===!1?(console.log("Connections container is not visible"),!1):!0:(console.warn("Connections container is not connected to DOM"),!1):!1}r(Zm,"is_visible");var Qm=new WeakMap,i$=r(n=>(Qm.has(n)||Qm.set(n,new Map),Qm.get(n)),"get_registry"),Zc=r((n,e,t)=>{if(!n||typeof n.env?.events?.on!="function")return console.warn("View or event system not available for registering event listener"),()=>{};let s=i$(n),i=s.get(e);typeof i=="function"&&i();let o=n.env.events.on(e,l=>{t(l)}),a=!0,c=r(()=>{a&&(a=!1,o?.(),s.get(e)===c&&s.delete(e))},"dispose");return s.set(e,c),typeof n.register=="function"&&n.register(()=>c()),c},"register_env_event_listener");var el=class extends Bt{static{r(this,"LookupItemView")}static get view_type(){return"smart-lookup-view"}static get display_text(){return"Lookup"}static get icon_name(){return"smart-lookup"}async render_view(e,t=this.container){let s=await this.env.render_component("lookup_item_view",this,e);t.empty(),t.appendChild(s)}};async function zk(n){n.registerMarkdownCodeBlockProcessor("smart-connections",async(e,t,s)=>{t.empty(),t.createEl("span",{text:"Loading\u2026"});let i=JSON.parse(e.trim()||"{}"),o=n.env,a=o.smart_sources.get(s.sourcePath)??o.smart_sources.init_file_path(s.sourcePath),c=o.smart_view;if(!a){t.empty(),t.createEl("p",{text:"Entity not found: "+s.sourcePath});return}let l=r(async()=>{let d=a.connections;if(!d?.env){t.empty(),t.createEl("p",{text:"Smart Environment / Connections loading\u2026"}),t.createEl("button",{text:"Retry"}).addEventListener("click",()=>{l()});return}let _=await n.env.smart_components.render_component("connections_codeblock",d,{...i});t.empty(),t.appendChild(_)},"render_codeblock");if(!t._has_listeners){t._has_listeners=!0;let d=[];d.push(o.events.on("settings:changed",_=>{console.log("connections codeblock view detected settings change",_),_.path?.includes("connections_lists")&&l()})),c.attach_disposer(t,d)}l()})}r(zk,"register_smart_connections_codeblock");function Rk(n=null){return`\`\`\`smart-connections
${n?JSON.stringify(n,null,2):""}
\`\`\`
`}r(Rk,"build_connections_codeblock");var{Notice:ep,Plugin:bY,requestUrl:o$,Platform:vY}=tp.default,Oo=class extends wo{static{r(this,"SmartConnectionsPlugin")}SmartEnv=vo;get smart_env_config(){return this._smart_env_config||(this._smart_env_config=qk),this._smart_env_config}ConnectionsSettingsTab=Yc;get item_views(){return{ConnectionsItemView:Qc,LookupItemView:el,ReleaseNotesView:qn}}get obsidian(){return tp.default}get api(){return this._api}onload(){this.app.workspace.onLayoutReady(this.initialize.bind(this)),this.SmartEnv.create(this,this.smart_env_config),this.addSettingTab(new this.ConnectionsSettingsTab(this.app,this)),Ik(),this.register_commands(),this.register_item_views(),this.register_ribbon_icons()}onunload(){console.log("Unloading Smart Connections plugin"),this.notices?.unload(),this.env?.unload_main?.(this)}async initialize(){this.smart_connections_view=null,this.is_new_user().then(async e=>{e&&(setTimeout(()=>{Fe.open(this,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-new-user"})},1e3),await this.SmartEnv.wait_for({loaded:!0}),setTimeout(()=>{this.open_connections_view(),this.app.workspace.rightSplit.collapsed&&this.app.workspace.rightSplit.toggle()},1e3),this.add_to_gitignore(`

# Ignore Smart Environment folder
.smart-env`))}),await this.SmartEnv.wait_for({loaded:!0}),zk(this),await this.check_for_updates()}get ribbon_icons(){return{connections:{icon_name:"smart-connections",description:"Smart Connections: Open connections view",callback:r(()=>{this.open_connections_view()},"callback")},lookup:{icon_name:"smart-lookup",description:"Smart Lookup: Open lookup view",callback:r(()=>{this.open_lookup_view()},"callback")},random_note:{icon_name:"smart-dice",description:"Smart Connections: Open random connection",callback:r(()=>{this.open_random_connection()},"callback")}}}get settings(){return this.env?.settings||{}}async check_for_updates(){if(await this.is_new_plugin_version(this.manifest.version)){console.log("opening release notes modal");try{qn.open(this.app.workspace,this.manifest.version)}catch(e){console.error("Failed to open ReleaseNotesView",e)}await this.set_last_known_version(this.manifest.version)}setTimeout(this.check_for_update.bind(this),3e3),setInterval(this.check_for_update.bind(this),108e5)}async check_for_update(){try{let{json:e}=await o$({url:"https://api.github.com/repos/brianpetro/obsidian-smart-connections/releases/latest",method:"GET",headers:{"Content-Type":"application/json"},contentType:"application/json"}),t=e.tag_name;t!==this.manifest.version&&(this.env?.events?.emit("plugin:new_version_available",{version:t}),this.notices?.show("new_version_available",{version:t}),this.update_available=!0)}catch(e){console.error(e)}}async restart_plugin(){this.env?.unload_main?.(this),await new Promise(e=>setTimeout(e,3e3)),window.restart_plugin=async e=>{await window.app.plugins.disablePlugin(e),await window.app.plugins.enablePlugin(e)},await window.restart_plugin(this.manifest.id)}get commands(){return{...super.commands,random_connection:{id:"smart-connections-random",name:"Open: Random note from connections",callback:r(async()=>{await this.open_random_connection()},"callback")},getting_started:{id:"smart-connections-getting-started",name:"Show: Getting started slideshow",callback:r(()=>{Fe.open(this,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-command"})},"callback")},insert_connections_codeblock:{id:"insert-connections-codeblock",name:"Insert: Connections codeblock",editorCallback:r(e=>{e.replaceSelection(Rk())},"editorCallback")}}}show_release_notes(){return qn.open(this.app.workspace,this.manifest.version)}async open_random_connection(){let e=this.app.workspace.getActiveFile();if(!e){new ep("No active file to find connections for");return}let t=await Nk(this.env,e.path);if(!t){new ep("Cannot open random connection for non-embedded source: "+e.path);return}this.open_note(t.item.path)}async open_note(e,t=null){await Ok(this,e,t)}async add_to_gitignore(e,t=null){if(!await this.app.vault.adapter.exists(".gitignore"))return;(await this.app.vault.adapter.read(".gitignore")).indexOf(e)<0&&(await this.app.vault.adapter.append(".gitignore",`

${t?"# "+t+`
`:""}${e}`),console.log("Added to .gitignore: "+e))}get notices(){return this.env?.notices?this.env.notices:(this._notices||(this._notices=new Kc(this.env,ep)),this._notices)}};var Dk=require("@codemirror/view"),Fk=require("@codemirror/state"),As=Fk.StateEffect.define(),Bk=Dk.ViewPlugin.fromClass(class{constructor(n){this.view=n,this.connections_pro_frag=null,this.container_el=null,this.collapsed_notice_el=null,this.pro_header=null,this.search_result_container=null}destroy(){this.container_el?.isConnected&&this.container_el.remove()}update(n){for(let e of n.transactions)for(let t of e.effects)t.is(As)&&(t.value===null?this.container_el&&(this.container_el.style.display="none"):this.render_pro(t.value))}render_pro(n=null){n&&(this.container_el&&this.container_el!==n&&this.container_el.isConnected&&this.container_el.remove(),this.connections_pro_frag=n,this.container_el=n,this._listeners_bound=!1,this.#e(),this.#t()),this.container_el&&(this.container_el.style.display=this.connections_pro_frag?"block":"none")}#e(){this.search_result_container=this.container_el?.querySelector(".search-result-container"),this.pro_header=this.container_el?.querySelector(".tree-item-self"),this.collapsed_notice_el=this.container_el?.querySelector(".collapsed-notice"),this.collapse_icon_btn=this.container_el?.querySelector(".nav-action-button")}#t(){if(!this.container_el||this.container_el.isConnected)return;let n=this.view.dom.querySelector(".cm-contentContainer");n?.parentNode?.insertBefore(this.container_el,n.nextSibling)}});var tl=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var sl=class extends tl{static{r(this,"SmartRankModel")}static defaults={adapter:"cohere",model_key:"rerank-v3.5"};async rank(e,t,s={}){return await this.invoke_adapter_method("rank",e,t,s)}get default_model_key(){return"jinaai/jina-reranker-v1-tiny-en"}get settings_config(){let e={adapter:{name:"Ranking Model Platform",type:"dropdown",description:"Select a ranking model platform.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}};var Ut=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var sp={"[ADAPTER].model_key":{name:"Ranking Model",type:"dropdown",description:"Select a ranking model to use.",options_callback:"adapter.get_models_as_options",callback:"reload_model"}},nl=class extends Ut{static{r(this,"SmartRankAdapter")}constructor(e){super(e),this.smart_rank=e}async rank(e,t){throw new Error("rank method not implemented")}get settings_config(){return sp}};var Be=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var On=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},$n=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var $o=class extends On{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new np(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},np=class extends $n{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var kt=class extends On{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new ip(i)}},ip=class extends $n{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var il=class extends nl{static{r(this,"SmartRankModelApiAdapter")}get endpoint(){return this.model.data.endpoint||this.constructor.defaults.endpoint}get api_key(){return this.model.data.api_key}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Be({adapter:kt})),this._http_adapter}async load(){this.model.model_loaded=!0,this.api_key&&this.set_state("loaded")}async request(e,t=0){try{e.throw=!1,e.url=this.endpoint,console.log("API Request:",e);let s=await this.http_adapter.request(e);return console.log("API Response:",s),await this.get_resp_json(s)}catch(s){return await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.rank("test query",["Test document"]);return Array.isArray(e)&&e.length>0&&e[0].score!==null}},ol=class{static{r(this,"SmartRankModelRequestAdapter")}constructor(e,t,s){this.adapter=e,this.query=t,this.documents=s}get_headers(){let e={"Content-Type":"application/json"};return this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`),e}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},rl=class{static{r(this,"SmartRankModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_standard(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var jn=class extends il{static{r(this,"SmartRankCohereAdapter")}static defaults={adapter:"cohere",description:"Cohere",default_model:"rerank-v3.5",endpoint:"https://api.cohere.ai/v2/rerank"};get req_adapter(){return op}get res_adapter(){return rp}async load(){this.model.model_loaded=!0,this.set_state("loaded")}async rank(e,t){let i=new this.req_adapter(this,e,t).to_platform(),o=await this.request(i);return!o||!o.results?{message:o?.message||"Invalid response from Cohere API",resp:o}:new this.res_adapter(this,o).to_standard()}async handle_request_err(e,t,s){if(e&&e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Cohere API rate limit exceeded. Retrying in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error("Cohere API Error:",e),null}get settings_config(){return r$}get models(){return a$}},r$={...sp,"[ADAPTER].api_key":{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},a$={"rerank-v3.5":{id:"rerank-v3.5",description:"State-of-the-art performance in English and non-English languages. Supports documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-english-v3.0":{id:"rerank-english-v3.0",description:"English language documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-multilingual-v3.0":{id:"rerank-multilingual-v3.0",description:"Non-English documents and semi-structured data (JSON). Supports same languages as embed-multilingual-v3.0. Context length: 4096 tokens"}},op=class extends ol{static{r(this,"SmartRankCohereRequestAdapter")}prepare_request_body(){return{query:this.query,documents:this.documents,model:this.adapter.model_key,top_n:1e3,max_tokens_per_doc:4096}}},rp=class extends rl{static{r(this,"SmartRankCohereResponseAdapter")}parse_response(){return this.response.results?this.response.results.map(e=>({index:e.index,score:e.relevance_score})):(console.error("Invalid response format from Cohere API:",this.response),[])}};var c$={score_algo_key:{group:"Score algorithm",name:"Scoring algorithm",description:"Calculates a score by comparing each item with the current context.",type:"dropdown",options_callback:r(n=>{console.log("getting score algo options for",{scope:n,_this:void 0});let e=n.get_score_algo_key_options.call(n);return console.log("options",e),e},"options_callback"),scope_class:"pro-setting"},connections_post_process:{group:"Ranking algorithm",name:"Ranking algorithm",description:"Modifies the ranking of connection results after initial scoring. Useful for heavy-processing algorithms that should only be applied to a subset of results produced by the main scoring algorithm (ex. re-ranking models).",type:"dropdown",options_callback:r(n=>n.get_connections_post_process_options(),"options_callback"),scope_class:"pro-setting"},filters_helper:{group:"Filters",type:"html",value:['<p class="setting-item-description"><strong>Filter tips:</strong> Use comma-separated folder or file path fragments such as <code>Projects/Clients</code>. Values are trimmed automatically and compared using case-sensitive substring matches.</p>','<p class="setting-item-description"><strong>Result vs ingestion:</strong> Connections filters only hide results after Smart Environment builds its dataset. To stop notes from being indexed, adjust Smart Environment include/exclude settings in the Environment window or plugin settings.</p>','<p class="setting-item-description"><strong>Precedence:</strong> Entries in the exclude filter always win when they match, even if the same path fragment appears in the include filter.</p>'].join("")},exclude_inlinks:{group:"Filters",name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},exclude_outlinks:{group:"Filters",name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},include_filter:{group:"Filters",name:"Include filter",type:"text",description:"Comma-separated path fragments that must appear in the note path. Matches use case-sensitive substring checks; trim spaces or wrap folder names like `Daily/`. This only affects the results list; Smart Environment still embeds matching notes unless excluded there."},exclude_filter:{group:"Filters",name:"Exclude filter",type:"text",description:"Comma-separated path fragments to omit from results. Exclusions run before includes, so any matching fragment removes the note even if it also appears in `Include filter`. Use Smart Environment include/exclude settings to stop notes from being embedded altogether."},connections_list_component_key:{group:"Display",name:"Connections List Component",type:"dropdown",description:"Select the component used to render the connections list.",options_callback:r(n=>n.get_connections_list_component_options(),"options_callback")},connections_list_item_component_key:{group:"Display",name:"Connections list item",type:"dropdown",description:"Settings for individual connections list items.",options_callback:r(n=>n.get_connections_list_item_options(),"options_callback")},exclude_frontmatter_blocks:{group:"Display",name:"Hide frontmatter blocks in results",type:"toggle",description:"Show only sources in the connections results (no frontmatter blocks)."},inline_connections:{group:"Inline connections",name:"Show inline connections",type:"toggle",description:"Shows connections for each block within the note. Hover connections icon to see list of connections."},inline_connections_score_threshold:{group:"Inline connections",name:"Inline connections score threshold",type:"text",description:"Minimum score (0-1) required before inline connections are displayed."},inline_connections_skip_codeblocks:{group:"Inline connections",name:"Skip code blocks",type:"toggle",description:"Do not show inline connections for blocks inside code blocks."},footer_connections:{group:"Footer connections",name:"Show footer connections",type:"toggle",description:"Show connections at the bottom of each note."}},ap=class extends Ao{static{r(this,"ConnectionsLists")}static version=2;process_load_queue(){}static get default_settings(){return{results_collection_key:"smart_sources",score_algo_key:"similarity",connections_post_process:"none",results_limit:20,inline_connections:!0,inline_connections_score_threshold:"0.77",footer_connections:!1,exclude_frontmatter_blocks:!0,connections_list_component_key:"connections_list_v4",connections_list_item_component_key:"connections_list_item_v3"}}get settings_config(){return Uk(this)}new_item(e){let t=new this.item_type(this.env,{collection_key:e.collection_key,item_key:e.key});return this.set(t),Object.defineProperty(e,"connections",{get:r(()=>t,"get"),configurable:!0}),t}get_score_algo_key_options(){return Object.entries(this.env.config.actions||{}).filter(([,e])=>(e.action?.action_type??e.action_type)==="score").map(([e,t])=>{let s=t.display_name||e;return{value:e,name:s,label:s,description:t.display_description}})}get_connections_post_process_options(){let e=Object.entries(this.env.config.actions||{}).filter(([t,s])=>t.startsWith("connections_list_post_process")).map(([t,s])=>({value:t,name:s.display_name||t,description:s.display_description}));return[{value:"none",name:"None"},...e]}get_connections_list_component_options(){return Object.entries(this.env.config.components||{}).filter(([e,t])=>e.startsWith("connections_list_")&&!e.startsWith("connections_list_item_")).map(([e,t])=>({value:e,name:t.display_name||e,description:t.display_description}))}get score_algo_settings_config(){let e=this.settings.score_algo_key,t=this.env.config.actions[e],s=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return s?Object.fromEntries(Object.entries(s).map(([i,o])=>[`actions.${e}.${i}`,o])):null}get connections_post_process_settings_config(){let e=this.settings.connections_post_process;if(e==="none")return null;let t=this.env.config.actions[e],s=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return s?Object.fromEntries(Object.entries(s).map(([i,o])=>[`actions.${e}.${i}`,o])):null}get connections_list_item_settings_config(){let e=this.settings.connections_list_item_component_key;if(!e||e==="none")return null;let t=this.env.config.components?.[e],s=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return s?Object.fromEntries(Object.entries(s).map(([i,o])=>[`components.${e}.${i}`,o])):null}get rank_model(){return this.env.ranking_models.default.instance}};function Uk(n){let e={...c$};n.connections_post_process_settings_config&&(e=Uc("connections_post_process",e,n.connections_post_process_settings_config)),n.score_algo_settings_config&&(e=Uc("score_algo_key",e,n.score_algo_settings_config)),n.connections_list_item_settings_config&&(e=Uc("connections_list_item_component_key",e,n.connections_list_item_settings_config));let t=Object.fromEntries(Object.entries(e).map(([s,i])=>s.endsWith("similarity_algo_description")?[s,i]:(i.scope_class="pro-setting",[s,i])));return{...Wc(n),...t}}r(Uk,"settings_config");var Wk={class:ap,collection_key:"connections_lists",item_type:qe,settings_config:Uk};function al(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(al,"collection_instance_name_from");function wt(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Gk(e[t])&&Gk(n[t])?wt(n[t],e[t]):n[t]=e[t]);return n}r(wt,"deep_merge");function Gk(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Gk,"is_plain_object");function Hk(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Hk,"create_uid");function Tn(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(Tn,"camel_case_to_snake_case");function cl(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>cl(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>cl(n[o],e[o],t))}return n===e}r(cl,"deep_equal");function ll(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(ll,"get_item_display_name");function dl(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let v of Reflect.ownKeys(m)){let j=Object.getOwnPropertyDescriptor(m,v);if(!j)continue;let E={...j};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let v=!1;for(let j of h){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E){let $=E.value;if(c($)){v=!0;continue}if(s($)){if(_($)){v=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),v=new Map;for(let j of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E&&_(E.value)){v.set(j,d(E.value));continue}try{Object.defineProperty(h,j,u(E))}catch{h[j]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),w=Object.create(null),x=r((m,h,v=[])=>{if(!m||!h)return;let j=new Set([...l,...v]);for(let E of Reflect.ownKeys(m)){if(j.has(E))continue;let $=Object.getOwnPropertyDescriptor(m,E);if($)try{Object.defineProperty(h,E,$)}catch{h[E]=$.value}}},"copy_metadata"),b=r(m=>{let h=new m(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let j=v.bind(h);return x(m,j),x(h,j),j.instance=h,j}return x(m,h),h},"instantiate_class"),C=r(m=>{if(o(m))return b(m);if(a(m)){let h=m.action.bind(n);return x(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return x(m,h),h}return s(m)?d(m):m},"bind_or_clone"),k=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&s(h)?h:null},"scope_actions_for"),A=r((m,h,v)=>(m[h]=v,v),"cache_result"),q=r((m,h)=>{let v=k();return v&&g(v,h)?A(m,h,C(v[h])):g(f,h)?A(m,h,C(f[h])):A(m,h,void 0)},"compute_and_cache"),O=r(()=>{let m=k(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(m)for(let v of Reflect.ownKeys(m))h.add(v);return Array.from(h)},"union_keys"),S=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(w,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:q(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let v=k();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return S(m,h);let v=k();if(v&&g(v,h)||g(f,h))return g(m,h)||q(m,h),S(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,v)=>"value"in v?(m[h]=v.value,!0):!1,"defineProperty"),set:r((m,h,v)=>(m[h]=v,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(dl,"create_actions_proxy");var ie=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&wt(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Hk(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return wt(s,t),!cl(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=dl(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),al(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),al(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Tn(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return ll(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var l$=Object.getPrototypeOf(async function(){}).constructor,oe=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof l$?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return wt(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=dl(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};function _l(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=Vk(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=Vk(n.results);n.min=s,n.minResult=i}}r(_l,"results_acc");function Kk(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=Jk(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=Jk(n.results);n.max=s,n.maxResult=i}}r(Kk,"furthest_acc");function Vk(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(Vk,"find_min");function Jk(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(Jk,"find_max");function Ue(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Ue,"sort_by_score");function ul(n,e){return Ue(n,e)}r(ul,"sort_by_score_descending");function Yk(n,e){return Ue(n,e)*-1}r(Yk,"sort_by_score_ascending");var Wt=class extends ie{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(_l(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(ul);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};function Xk(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Nn(l,o),l=cp(l,15),l=Nn(l,a),i^=l,i=cp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Nn(l,o),l=cp(l,15),l=Nn(l,a),i^=l;break}return i^=n.length,i=d$(i),i|0}r(Xk,"murmur_hash_32");function re(n,e=0){return(Xk(n,e)>>>0).toString(36)}r(re,"murmur_hash_32_alphanumeric");function Nn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Nn,"multiply_32");function cp(n,e){return n<<e|n>>>32-e}r(cp,"rotate_left_32");function d$(n){return n^=n>>>16,n=Nn(n,2246822507),n^=n>>>13,n=Nn(n,3266489909),n^=n>>>16,n|0}r(d$,"fmix_32");var ml={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},lp=class extends oe{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=_$(new Date),i=re(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new Wt(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...ml}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function _$(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(_$,"format_ymd");var Pn={class:lp,collection_key:"lookup_lists",item_type:Wt,settings_config:ml};var u$={...ml,results_limit:{type:"number",name:"Results limit",description:"Adjust the number of lookup results displayed (default 20).",scope_class:"pro-setting"}};Pn.settings_config=u$;Pn.version=2;var Zk=Pn;var Qk=new CSSStyleSheet;Qk.replaceSync(`.connections-view-early{.connections-top-bar{display:flex;gap:.5rem 1rem;.connections-actions{display:flex;flex-direction:row;flex-wrap:wrap;flex:0 0 auto}.sc-context{display:flex;flex-direction:column;margin:0;gap:.1rem;width:auto;flex:1 1 auto;.sc-context-line{line-height:1.1}.sc-context-line--parent{color:var(--text-muted);font-size:.85em}.sc-context-line--focus{color:var(--text-normal);font-size:1.05em;font-weight:600}}}.connections-list{padding-top:.85rem;>.sc-collapsed ul{display:none}>.sc-collapsed span svg{transform:rotate(-90deg)}>.sc-result-pinned{box-shadow:0 0 0 1px var(--interactive-accent);border-radius:var(--radius-s);background-color:var(--background-modifier-hover)}}}
`);var ew=Qk;async function m$(n,e={}){return`<div class="embedded-backlinks">
<div class="backlink-pane" style="position: relative;">
<div class="tree-item-self is-clickable" aria-label="Click to collapse">
<div class="tree-item-inner">Smart Connections</div>
<div class="tree-item-flair-outer">
<span class="tree-item-flair">Pro</span>
</div>
</div>
<div class="search-result-container">
<div class="sc-connections-wrapper">
<div class="connections-view connections-footer-view sc-connections-view connections-view-early">
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div>
</div>
</div>
</div>
</div>`}r(m$,"build_html");async function tw(n,e={}){let t=await m$.call(this,n,e),s=this.create_doc_fragment(t);this.apply_style_sheet(ew);let i=s.firstElementChild;return p$.call(this,n,i,e),i}r(tw,"render");async function p$(n,e,t={}){let s=e.querySelector(".connections-list-container"),i=r(()=>localStorage.getItem("sc_footer_connections_folded")==="true","is_folded"),o=e.querySelector(".is-clickable");o.addEventListener("click",_=>{_.preventDefault(),_.stopPropagation();let u=!i();localStorage.setItem("sc_footer_connections_folded",String(u)),u?(o.setAttribute("aria-label","Click to expand"),o.classList.add("is-collapsed"),s.style.display="none"):(o.setAttribute("aria-label","Click to collapse"),o.classList.remove("is-collapsed"),s.style.display="block")});let a=n.env,c=t.connections_item,l=c.connections||a.connections_lists.new_item(c),d=await a.smart_components.render_component("connections_list_v3",l,t);return this.empty(s),s.appendChild(d),e}r(p$,"post_process");var sw=new CSSStyleSheet;sw.replaceSync(`.connections-graph{position:relative;width:100%;block-size:auto;container-type:inline-size}.sc-graph-svg{width:100%;aspect-ratio:1 / 1;height:auto;display:block;border-radius:var(--radius-m);border:1px solid var(--background-modifier-border);background:var(--background-secondary);box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--background-modifier-hover) 50%,transparent)}.sc-graph-details{margin-block-start:10px}.sc-graph-node .sc-graph-node-dot{fill:var(--background-primary);stroke:var(--color-base-100);stroke-width:1.25px;transition:stroke-width .12s ease,stroke .12s ease,fill .12s ease}.sc-graph-node-center .sc-graph-node-dot{fill:color-mix(in srgb,var(--interactive-accent) 18%,var(--background-primary));stroke:var(--interactive-accent);stroke-width:1.5px}.sc-graph-node-hover .sc-graph-node-dot{fill:var(--background-modifier-hover);stroke:var(--text-accent);stroke-width:2px}.sc-score-text{font-size:.8em;fill:var(--text-muted);opacity:.95;pointer-events:none;user-select:none}.sc-graph-node-hover .sc-score-text{display:none}.sc-node-label{font-size:.85em;font-weight:500;fill:var(--nav-item-color);opacity:0;pointer-events:none;user-select:none;paint-order:stroke fill;stroke:color-mix(in srgb,var(--background-primary) 65%,transparent);stroke-width:2px;transition:opacity .12s ease-in-out}.sc-graph-node-hover .sc-node-label{opacity:.96;fill:var(--nav-item-color-active)}.connections-graph .sc-graph-node-center .sc-node-label{display:none!important}.sc-graph-node.sc-result-pinned .sc-graph-node-dot{fill:color-mix(in srgb,var(--interactive-accent) 12%,var(--background-primary));stroke:var(--interactive-accent);stroke-width:2px;filter:drop-shadow(0 0 .25rem color-mix(in srgb,var(--interactive-accent) 50%,transparent))}.sc-graph-node.sc-result-hidden .sc-graph-node-dot{fill:color-mix(in srgb,var(--background-modifier-border) 40%,transparent);stroke:color-mix(in srgb,var(--text-muted) 65%,transparent);stroke-width:1px;opacity:.6}.sc-graph-node.sc-result-hidden .sc-score-text{opacity:.4;fill:var(--text-faint)}.sc-graph-node.sc-result-hidden.sc-graph-node-hover .sc-node-label{opacity:.85;fill:var(--text-faint)}
`);var nw=sw;function me(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(me,"cos_sim");function pl(n=""){let e=2166136261;for(let t=0;t<n.length;t++)e^=n.charCodeAt(t),e=Math.imul(e,16777619);return e+=e<<13,e^=e>>>7,e+=e<<3,e^=e>>>17,e+=e<<5,(e>>>0)/4294967295}r(pl,"hash_to_unit");function iw(n="",e=-Math.PI/2){let t=pl(n);return e+t*Math.PI*2}r(iw,"seeded_angle");function ow(n=[]){let e=n.map(c=>Number.isFinite(c)?+c:null),t=e.filter(c=>c!==null);if(!t.length)return{norm:e.map(()=>.5),min:0,max:1};let s=Math.min(...t),i=Math.max(...t),o=i-s||1;return{norm:e.map(c=>c===null?.5:(c-s)/o),min:s,max:i}}r(ow,"normalize_scores");function dp(n,e,t){let s=Math.max(0,Math.min(1,Number(n)||0));return Math.round(e+(1-s)*(t-e))}r(dp,"score_to_radius");function _p(n){return Array.isArray(n)&&n.length>0}r(_p,"is_vec");function h$(n=[]){let e=0;for(let t=0;t<n.length;t++){let s=n[t]||0;e+=s*s}return Math.sqrt(e)}r(h$,"norm");function jo(n=[]){let e=h$(n);return!Number.isFinite(e)||e===0?null:n.map(t=>t/e)}r(jo,"to_unit");function f$(n=[]){if(!n.length)return null;let e=n[0].length,t=new Array(e).fill(0),s=0;for(let o of n)if(o){for(let a=0;a<e;a++)t[a]+=o[a]||0;s++}if(!s)return null;let i=t.map(o=>o/s);return jo(i)}r(f$,"mean_unit");function g$(n){let e=n>>>0;return r(function(){e|=0,e=e+1831565813|0;let s=Math.imul(e^e>>>15,1|e);return s^=s+Math.imul(s^s>>>7,61|s),((s^s>>>14)>>>0)/4294967296},"rand")}r(g$,"prng_from_seed");function rw(n=[],e=4,t=100,s=1337){let i=n.map(y=>y?jo(y):null),o=i.map((y,g)=>y?g:-1).filter(y=>y>=0),a=o.length;if(a===0)return{centers:[],assign:new Array(n.length).fill(-1),sims:new Array(n.length).fill(0)};let c=g$(s),l=new Array(a).fill(1),d=[];for(d.push(i[o[Math.floor(c()*a)]]);d.length<Math.min(e,a);){for(let x=0;x<a;x++){let b=i[o[x]],C=-1/0;for(let A of d){let q=me(b,A);q>C&&(C=q)}let k=1-Math.max(0,Math.min(1,C));l[x]=k*k}let y=l.reduce((x,b)=>x+b,0)||1,g=c()*y,w=0;for(let x=0;x<a;x++)if(g-=l[x],g<=0){w=x;break}d.push(i[o[w]])}let _=new Array(a).fill(-1),u=new Array(a).fill(0);for(let y=0;y<t;y++){let g=!1;for(let b=0;b<a;b++){let C=i[o[b]],k=0,A=-1/0;for(let q=0;q<d.length;q++){let O=me(C,d[q]);O>A&&(A=O,k=q)}_[b]!==k&&(_[b]=k,g=!0),u[b]=Math.max(0,Math.min(1,A))}let w=d.map(()=>[]);for(let b=0;b<a;b++)w[_[b]].push(i[o[b]]);let x=d.map((b,C)=>f$(w[C]));for(let b=0;b<d.length;b++)x[b]||(x[b]=d[b]),d[b]=x[b];if(!g)break}let p=new Array(n.length).fill(-1),f=new Array(n.length).fill(0);for(let y=0;y<a;y++)p[o[y]]=_[y],f[o[y]]=u[y];return{centers:d,assign:p,sims:f}}r(rw,"kmeans_cosine_unit");function aw(n,e,t=[100,100,100,100]){return[Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4].map((i,o)=>{let a=t[o]??t[t.length-1]??100;return{x:Math.round(n+a*Math.cos(i)),y:Math.round(e+a*Math.sin(i))}})}r(aw,"quadrant_anchors");function cw(n,e,t){if(!Number.isFinite(n)||!Number.isFinite(e)||!Number.isFinite(t)||e>=t)return .45;let s=1-(n-e)/(t-e);return .45+.55*Math.max(0,Math.min(1,s))}r(cw,"radial_strength_for");function lw(n,e,t=24){let s=Math.max(1,Number(n)||100),i=Math.max(1,Number(e)||s),o=Math.min(s,i)/2,a=Math.round(o*.18),c=Math.max(12,a),l=Math.round(s*.45),d=Math.max(c+8,l);return{min_r:c,outer_r:d,half_min:o}}r(lw,"compute_radii");function dw(n="",e=70){let t=String(n??""),s=Math.max(0,Number.isFinite(e)?Math.floor(e):0);if(!s)return"";if(t.length<=s)return t;if(s<=3)return t.slice(0,s);let i="\u2026",o=s-i.length,a=Math.ceil(o/2),c=o-a;return`${t.slice(0,a)}${i}${t.slice(t.length-c)}`}r(dw,"truncate_middle");function _w(n,e={}){let{center_x:t=0,label_width:s=0,view_width:i=0,radius:o=0,margin:a=10}=e,c=Math.max(2,a),l=c,d=Math.max(l,i-c),_=n>=t?"start":"end",u=o+c;if(_==="start"){let g=u,w=n+g,x=w+s;if(x>d){let b=x-d;g-=b,w-=b}return w<l&&(g+=l-w),{anchor:_,offset:g}}let p=-u,f=n+p,y=f-s;if(y<l){let g=l-y;p+=g,f+=g}return f>d&&(p-=f-d),{anchor:_,offset:p}}r(_w,"label_anchor_offset");function uw(n,e,t,s,i){let o=t-n,a=s-e,c=Math.hypot(o,a)||1,l=o/c,d=a/c;return{x:Math.round(n+l*i),y:Math.round(e+d*i)}}r(uw,"project_anchor_to_ring");function y$(n=[]){let e=new Set;for(let t of n){let s=mp(t?.item);s&&e.add(s)}return e}r(y$,"build_prefixed_key_set");function mp(n){if(n)return Dt(n.collection_key,n.key)}r(mp,"prefixed_key_for_item");function b$({connections_state:n={},existing_keys:e=new Set,resolve_item:t}={}){if(typeof t!="function")return[];let s=[];for(let[i,o]of Object.entries(n)){if(!o?.hidden||o?.pinned||e.has(i))continue;let a=v$(i);if(!a)continue;let c=t(a.collection_key,a.item_key);c&&(e.add(i),s.push({item:c,score:null,is_hidden:!0,prefixed_key:i}))}return s}r(b$,"collect_hidden_entries");function mw({is_center:n=!1,is_hidden:e=!1,is_pinned:t=!1}={}){let s=["sc-graph-node"];return n&&s.push("sc-graph-node-center"),t&&s.push("sc-result-pinned"),e&&s.push("sc-result-hidden"),s.join(" ").trim()}r(mw,"build_node_classname");function v$(n){if(typeof n!="string"||!n.includes(":"))return null;let[e,...t]=n.split(":");return!e||!t.length?null:{collection_key:e,item_key:t.join(":")}}r(v$,"parse_prefixed_key");var k$="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js",pw="7.",w$=typeof globalThis<"u"&&globalThis.SC_D3_INTEGRITY_SHA256||"";function up(n){if(!n)return;let e=String(n.version||"");e&&!e.startsWith(pw)&&console.warn(`[connections_graph] Loaded d3 version "${e}" but expected v${pw}x`)}r(up,"validate_d3_instance");async function x$(){let n=typeof globalThis<"u"?globalThis:window;if(n.d3||(typeof document<"u"?document.querySelector("script[data-sc-d3]"):null)&&n.d3)return up(n.d3),n.d3;let t=await new Promise((s,i)=>{if(typeof document>"u"||!document.head){i(new Error("D3 loader: document.head not available"));return}let o=document.createElement("script");o.src=k$,o.async=!0,o.setAttribute("data-sc-d3","true");let a=String(w$||"").trim();a&&(o.integrity=a,o.crossOrigin="anonymous"),o.onload=()=>{if(!n.d3){i(new Error("D3 loader: script loaded but window.d3 is missing"));return}s(n.d3)},o.onerror=()=>{i(new Error("D3 loader: failed to load d3 from CDN"))},document.head.appendChild(o)});return up(t),t}r(x$,"load_d3");async function E$(n,e={}){let t=e?.to_item||n?.item,s=e.width??100,i=e.height??100;return`
<div class="connections-graph sc-graph"
data-center-key="${t?.key||""}"
data-center-collection="${t?.collection_key||""}">
<svg class="sc-graph-svg"
width="${s}" height="${i}"
viewBox="0 0 ${s} ${i}"
preserveAspectRatio="xMidYMid meet">
<g class="sc-graph-viewport">
<g class="nodes"></g>
</g>
</svg>
<div class="sc-graph-details" aria-live="polite"></div>
</div>
`}r(E$,"build_html");async function hw(n,e={}){this.apply_style_sheet(nw);let t=await E$.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".connections-graph");return A$.call(this,n,i,e),i}r(hw,"render");async function A$(n,e,t={}){let s=await n.get_results(t);try{let i=await x$(),o=t.to_item||n?.item;if(!o)throw new Error("connections_graph: could not resolve center item.");let a=o.env,c=t.connections_settings??a.connections_lists.settings,l=o?.data?.connections||{},d=y$(s),_=b$({connections_state:l,existing_keys:d,resolve_item:r((m,h)=>n?.env?.[m]?.get(h),"resolve_item")}),u=[...s,..._],p=e.querySelector("svg.sc-graph-svg"),y=p.querySelector("g.sc-graph-viewport").querySelector("g.nodes"),g=8,w=5,x=24,b=10,C=null,k=null,A=r(m=>{let h=qo(m,{show_full_path:!1})||m?.key||"";return dw(h,70)},"build_label_text"),q=+p.getAttribute("width")||100,O=r(()=>{let m=e.clientWidth||+p.getAttribute("width")||100,h=m;q=m,p.setAttribute("viewBox",`0 0 ${m} ${h}`),p.setAttribute("width",m),p.setAttribute("height",h);let v=Math.round(m*.5),j=Math.round(h*.5),{min_r:E,outer_r:$,half_min:N}=lw(m,h,x),M=_p(o?.vec)?jo(o.vec):null,ue=u.map(T=>_p(T?.item?.vec)?jo(T.item.vec):null),ge=ue.map(T=>M&&T?Math.max(0,Math.min(1,me(M,T))):null),{norm:ye}=ow(ge),X={id:"__center__",item:o,score:1,radius:g,isCenter:!0,x:v,y:j,fx:v,fy:j},eC=Math.floor(pl(u.map(T=>T?.item?.key||"").join("|"))*1e9),{centers:Gu,assign:Rg}=rw(ue,4,300,eC),Dg=(Gu.length?Gu:[null,null,null,null]).slice(0,4).map(T=>M&&T?Math.max(0,Math.min(1,me(M,T))):.5),Oi=Dg.map(T=>dp(T,E,$));for(;Oi.length<4;)Oi.push(Oi[Oi.length-1]||Math.round((E+$)/2));let tC=aw(v,j,Oi),sC=u.map((T,J)=>{let P=T?.item;if(!P)return null;let ls=ye[J]??.5,ft=dp(ls,E,$),tn=iw(P.key||String(J),-Math.PI/2),sn=Math.round(v+ft*Math.cos(tn)),$i=Math.round(j+ft*Math.sin(tn)),Ee=Number.isInteger(Rg[J])?Rg[J]:Math.floor(pl(P.key||String(J))*4),nn=ue[J],on=Gu[Ee]||null,ji=nn&&on?Math.max(0,Math.min(1,me(nn,on))):0,Tt=mp(P),rC=Tt?So(l,Tt):!1,aC=!!T?.is_hidden||(Tt?Hc(l,Tt):!1);return{id:P.key,item:P,score:Number.isFinite(T?.score)?+T.score:M&&nn?me(M,nn):null,ring_r:ft,angle:tn,radius:w,isCenter:!1,x:sn,y:$i,cluster:Ee,node_to_cluster_sim:ji,label_text:A(P),prefixed_key:Tt,isPinned:rC,isHidden:aC}}).filter(Boolean),cs=[X,...sC];k=i.select(y).selectAll("g.sc-graph-node").data(cs,T=>T.id).join(T=>{let J=T.append("g").attr("class",P=>mw({is_center:P.isCenter,is_hidden:P.isHidden,is_pinned:P.isPinned})).attr("title",P=>(P.item.path||"").replace(/"/g,"&quot;")).attr("data-collection",P=>P.item.collection_key).attr("data-key",P=>P.item.key).attr("data-path",P=>(P.item.path||"").replace(/"/g,"&quot;")).attr("data-link",P=>(P.item.link||"").replace(/"/g,"&quot;")).attr("data-score",P=>`${P.score??""}`).attr("data-cluster",P=>P.isCenter?"":String(P.cluster)).attr("data-hidden",P=>P.isHidden?"true":null).attr("data-pinned",P=>P.isPinned?"true":null).attr("data-prefixed-key",P=>P.prefixed_key||"");return J.append("circle").attr("r",P=>P.radius).attr("class","sc-graph-node-dot"),J.append("text").attr("class","sc-score-text").attr("y",-w-6).attr("text-anchor","middle").attr("alignment-baseline","baseline").text(P=>typeof P.score=="number"&&!P.isCenter?P.score.toFixed(2):""),J.filter(P=>!P.isCenter).append("text").attr("class","sc-node-label").attr("y",-w-6).attr("text-anchor","middle").attr("alignment-baseline","baseline").text(P=>P.label_text.replace(".md","")),J}),k.attr("class",T=>mw({is_center:T.isCenter,is_hidden:T.isHidden,is_pinned:T.isPinned})).attr("data-hidden",T=>T.isHidden?"true":null).attr("data-pinned",T=>T.isPinned?"true":null).attr("data-prefixed-key",T=>T.prefixed_key||"").attr("transform",T=>`translate(${T.x},${T.y})`);let nC=r(()=>{k.classed("sc-graph-node-hover",!1)},"clear_hover");k.on("mouseenter",function(){nC(),i.select(this).classed("sc-graph-node-hover",!0)}).on("mouseleave",function(){i.select(this).classed("sc-graph-node-hover",!1)}).on("click",function(T,J){S$({node:J,container:e,env:a,center_item:o})});let Fg=i.forceRadial(T=>T.isCenter?0:T.ring_r,v,j).strength(T=>T.isCenter?1:cw(T.ring_r,E,$)),Bg=i.forceCollide(T=>T.radius+16).strength(.9).iterations(2),Ug=i.forceManyBody().strength(-80).distanceMax(N),iC=r(T=>{if(T.isCenter)return 0;let J=.04,P=Math.max(0,Math.min(1,T.node_to_cluster_sim||0)),ls=Dg[(T.cluster??0)%4]||.5;return J+.28*P*(.5+.5*ls)},"cluster_strength_fn");function oC(T=[],J=()=>.2,P=0,ls=0){let ft=[];function tn(sn){for(let $i=0;$i<ft.length;$i++){let Ee=ft[$i];if(Ee.isCenter)continue;let nn=Number.isInteger(Ee.cluster)?Ee.cluster%T.length:0,on=T[nn],ji=Math.max(0,Math.min(1,J(Ee)));if(!on||ji<=0)continue;let Tt=uw(P,ls,on.x,on.y,Ee.ring_r);Ee.vx+=(Tt.x-Ee.x)*ji*sn,Ee.vy+=(Tt.y-Ee.y)*ji*sn}}return r(tn,"force"),tn.initialize=function(sn){ft=sn},tn}r(oC,"force_cluster");let Wg=oC(tC,iC,v,j);C?(C.nodes(cs),C.force("radial",Fg),C.force("cluster",Wg),C.force("collide",Bg),C.force("charge",Ug),cs[0].fx=v,cs[0].fy=j,C.alpha(.8).restart()):C=i.forceSimulation(cs).alpha(.95).alphaDecay(.08).force("radial",Fg).force("cluster",Wg).force("collide",Bg).force("charge",Ug).on("tick",()=>{cs[0].fx=v,cs[0].fy=j,k.attr("transform",T=>`translate(${T.x},${T.y})`),k.select("text.sc-node-label").each(function(T){if(T.isCenter)return;let J=this,P=typeof J.getComputedTextLength=="function"?J.getComputedTextLength():0,{anchor:ls,offset:ft}=_w(T.x,{center_x:v,label_width:P,view_width:q,radius:T.radius,margin:b});i.select(J).attr("text-anchor",ls).attr("x",ft)})})},"layout");O(),new ResizeObserver(()=>O()).observe(e)}catch(i){console.error("[connections_graph] post_process error:",i);let o=document.createElement("p");o.className="sc-no-results",o.textContent="Unable to render graph. See console for details.",e.appendChild(o)}return e}r(A$,"post_process");function S$({node:n,container:e,env:t,center_item:s}){if(!n?.item)return;let i=C$(n,s);i&&(typeof CustomEvent=="function"&&e?.dispatchEvent&&e.dispatchEvent(new CustomEvent("connections:result",{detail:i,bubbles:!0})),t?.events?.emit?.("connections:result",i),n.item.emit_event?.("connections:result",i),n.item.emit_event?.("connections:open_result",i))}r(S$,"handle_node_click");function C$(n,e){let t=n?.item?.collection_key,s=n?.item?.key;return!t||!s?null:{collection_key:t,item_key:s,prefixed_key:n.prefixed_key||mp(n.item)||Dt(t,s),score:typeof n.score=="number"?n.score:null,is_hidden:!!n.isHidden,is_pinned:!!n.isPinned,event_source:"connections-graph-v1",center_key:e?.key}}r(C$,"build_result_detail");async function q$(n,e={}){return`<div>
<div class="connections-graph-container"></div>
<div class="connections-list sc-list" data-key="${n.item.key}"></div>
</div>`}r(q$,"build_html");async function gw(n,e={}){let t=await q$.call(this,n,e),i=this.create_doc_fragment(t).querySelector("div");return O$.call(this,n,i,e),i}r(gw,"render");async function O$(n,e,t={}){let s=n.env,i=e.querySelector(".connections-graph-container"),o=e.querySelector(".connections-list.sc-list");e.dataset.key=n.item.key;let a=await n.get_results(t),c=await s.smart_components.render_component("connections_graph_v1",n,t);if(this.empty(i),i.appendChild(c),j$(c,o),!a||!Array.isArray(a)||a.length===0){let _=this.create_doc_fragment(`<p class="sc-no-results">No results found.<br><em>Try using the refresh button. If that doesn't work, try running "Clear sources data" and then "Reload sources" in the Smart Environment settings.</em></p>`);return o.appendChild(_),e}let l=n.env.smart_components;return(await Promise.all(a.map(_=>l.render_component("connections_list_item_v3",_,{...t})))).forEach(_=>o.appendChild(_)),e}r(O$,"post_process");var fw="sc-result-graph-focus",$$=2400;function j$(n,e){!n||!e||n.addEventListener("connections:result",t=>{T$(e,t?.detail||{})})}r(j$,"register_graph_events");function T$(n,e={}){let t=N$(n,e);if(!t)return;t.classList.contains("sc-collapsed")&&t.classList.remove("sc-collapsed"),t.scrollIntoView?.({block:"center",behavior:"smooth"}),t.classList.add(fw),(typeof window<"u"?window.setTimeout:setTimeout)?.(()=>t.classList.remove(fw),$$)}r(T$,"focus_result_from_graph");function N$(n,e={}){if(!n)return null;let{collection_key:t,item_key:s}=e;return!t||!s?null:Array.from(n.querySelectorAll(".sc-result")).find(i=>i.dataset.collection===t&&i.dataset.key===s)||null}r(N$,"find_result_element");var yw="PRO: Graph + List";function bw(n,e){if(typeof n!="string"||typeof e!="string")throw new TypeError("Both parameters must be strings.");let t=e.match(/\b[\w\s]+\b/g)||[],s="";for(;s.length<10&&t.length>0;)s=t.shift().trim();let i="";for(;i.length<10&&t.length>0;)i=t.pop().trim();let o;if(!i||s===i)o=encodeURIComponent(s);else{let c=encodeURIComponent(s),l=encodeURIComponent(i);o=`${c},${l}`}let a=new URL(n,"http://dummy");if(a.hash){let c=a.hash.slice(1);if(c.includes(":~:text="))return`${a.origin}${a.pathname}#${c}&text=${o}`;a.hash=`${c}:~:text=${o}`}else a.hash=`:~:text=${o}`;return a.toString()}r(bw,"create_highlight_url");async function P$(n,e={}){return`<div><div class="sc-connections-web-view">
<div class="sc-list"><ul></ul></div>
</div></div>`}r(P$,"build_html");async function vw(n,e={}){let t=await P$.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".sc-connections-web-view");return I$.call(this,n,i,e),i}r(vw,"render");async function I$(n,e,t={}){let i=e.querySelector(".sc-list").querySelector("ul");return await r(async()=>{let a=Object.keys(n.data.hidden_connections||{}),c=await n.find_connections({exclude_key_ends_with:"---frontmatter---",exclude_keys:a,...t.filter||{}});console.log("render_results",c);for(let l of c){let _="https://wfhbrian.com/"+((l.item.source?.metadata||l.item.metadata||{})["wfhbrian.com"]?.replace(/\.html$/,"").replace(/\s/g,"-")||""),u=await l.item.read(),f=(u.split(`
`).map(C=>C.trim()).filter(C=>C.length>0)[0]||"").replace(/^\W+([a-zA-Z\s\d\-]+).*/,"$1").trim(),y=bw(_,u),g,w=l.item.key.split("#"),x=w.pop();x.startsWith("{")?g=(w.pop()+x).trim():g=x;let b=g.startsWith("{")?f:g;i.appendChild(this.create_doc_fragment('<li data-key="'+l.item.key+'" data-score="'+l.score+'"><a href="'+y+'">'+b+"</a></li>"))}},"render_results")(),e}r(I$,"post_process");var kw=new CSSStyleSheet;kw.replaceSync(`.sc-inline-pop{position:absolute;z-index:var(--layer-popover);background-color:var(--background-secondary);border:1px solid var(--background-modifier-border);border-radius:var(--radius-m);box-shadow:var(--shadow-s);max-width:340px;font-size:.875rem;overflow-y:auto}.sc-inline-pop .sc-inline-header{font-weight:700;border-bottom:1px solid var(--background-modifier-border);display:flex;justify-content:space-between;align-items:center;padding:.5rem .77rem}.sc-inline-pop .sc-inline-items{display:flex;flex-direction:column}.sc-inline-pop .sc-inline-item:hover{background-color:var(--background-primary)}.sc-inline-pop .sc-inline-item{display:flex;justify-content:space-between;align-items:center;gap:.5rem;cursor:pointer;padding:.5rem .77rem}
`);var ww=kw;var In=require("obsidian");function xw(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(In.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new In.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");In.MarkdownRenderer.render(o,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(xw,"register_block_hover_popover");var Ew=require("obsidian");function hl(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),Ew.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):xw(n.parentElement,n,e.env,e.key)}r(hl,"register_item_hover_popover");function Aw(n){if(!n)return"";let[e,...t]=n.split("#"),s=e.split("/").pop().replace(/\.md$/,"");if(!t.length)return`[[${s}]]`;let i=t.filter(o=>!o.startsWith("{")).pop();return i?`[[${s}#${i}]]`:`[[${s}]]`}r(Aw,"parse_item_key_to_wikilink");function M$(n,e,t,s){let i=n.dragManager,o=Aw(e.key),a=i.dragLink(s,o);i.onDragStart(s,a),t.drag_event_key?e.emit_event(t.drag_event_key):e.emit_event("connections:drag_result")}r(M$,"handle_connection_drag");function Sw(n,e,t={}){let i=e.env.obsidian_app;n.setAttribute("draggable","true"),n.addEventListener("dragstart",M$.bind(null,i,e,t))}r(Sw,"register_item_drag");var pp=require("obsidian");async function fl(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=pp.Keymap.isModEvent(e),l=pp.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(fl,"open_source");function L$(n,e={}){return`<div>
<div class="sc-inline-pop">
<div class="sc-inline-header">
<span class="sc-inline-title">Connections</span>
<span>Lines ${n.block.line_start}\u2013${n.block.line_end}</span>
</div>
<div class="sc-inline-items">Loading...</div>
</div>
</div>`}r(L$,"build_html");async function Cw(n,e={}){this.apply_style_sheet(ww);let t=L$.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".sc-inline-pop");return z$.call(this,n,i,e),i}r(Cw,"render");async function z$(n,e,t={}){let s=n.env?.connections_lists,i=s?.settings,o=i?.inline_connections_score_threshold?parseFloat(i.inline_connections_score_threshold):.8,a=Array.isArray(t.precomputed_items)?t.precomputed_items.slice(0,10):null;a||(a=n.connections_list.filter_and_score({limit:10,score_algo_key:s.score_algo_key,results_collection_key:s.results_collection_key,to_item:n.block,filter:{exclude_keys:[n.block.source_key],exclude_key_starts_with_any:[n.block.source_key]}})),a=a.filter(d=>d.score>=o);let c=e.querySelector(".sc-inline-items");if(!c)return;if(!a.length){c.textContent="No connections found above threshold "+o;return}this.empty(c),a.forEach(d=>{let _=document.createElement("div");_.className="sc-inline-item";let u=document.createElement("span");u.textContent=d.item.name??d.item.path.split("/").pop(),_.appendChild(u);let p=document.createElement("span");p.textContent=d.score.toFixed(2),_.appendChild(p),c.appendChild(_),hl(_,d.item),_.addEventListener("click",f=>{fl(d.item,f),d.item.emit_event("inline_connections:open_result",{event_source:"inline-connections-popover"})}),Sw(_,d.item,{drag_event_key:"inline_connections:drag_result"})}),e.querySelector(".sc-inline-header")?.addEventListener("click",()=>{n.plugin.connections_view_early?.container?.isShown?.()?n.block.emit_event("connections:show"):(n.plugin.open_connections_view(),setTimeout(()=>{n.block.emit_event("connections:show")},300))}),n.connections_list.emit_event("inline_connections:show")}r(z$,"post_process");function qw(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Mn(l,o),l=hp(l,15),l=Mn(l,a),i^=l,i=hp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Mn(l,o),l=hp(l,15),l=Mn(l,a),i^=l;break}return i^=n.length,i=R$(i),i|0}r(qw,"murmur_hash_32");function gl(n,e=0){return(qw(n,e)>>>0).toString(36)}r(gl,"murmur_hash_32_alphanumeric");function Mn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Mn,"multiply_32");function hp(n,e){return n<<e|n>>>32-e}r(hp,"rotate_left_32");function R$(n){return n^=n>>>16,n=Mn(n,2246822507),n^=n>>>13,n=Mn(n,3266489909),n^=n>>>16,n|0}r(R$,"fmix_32");var F$=`What is the most relevant to the following? Today is {{DATE}}.
{{CURRENT}}`;async function gp(n,e={}){if(!n.length)return console.warn("No results to rank"),n;if(!this.collection.rank_model)throw new Error("[rank_connections] Rank model not available.");let{rank_query:t=this.data.rank_query||this.settings.rank_query||F$}=e;console.log("rank model loaded");let s=new Date().toLocaleDateString(),i=t.replace("{{DATE}}",s).replace("{{CURRENT}}",(await this.item.get_embed_input()).slice(0,500)),o=await Promise.all(n.map(async l=>{let d=`mtime: ${new Date(l.item.mtime).toLocaleDateString()}
`;return d+=await l.item.get_embed_input(),d.slice(0,500)})),a=await this.collection.rank_model.rank(i,o);if(console.log("Ranked results:",a),!Array.isArray(a)||!a.length)return console.warn("Ranking failed, received:",a),n;let c=Math.max(...a.map(l=>l.score));return a.map(({index:l,score:d})=>({...n[l],score:d,og_score:n[l].score})).sort((l,d)=>d.score-l.score)}r(gp,"rank_connections");gp.action_type="connections_post_process";var yp="Re-ranking model",bp="Uses re-ranking model to adjust the order of connection results.";function Ow(n){return{connections_post_process_description:{group:"Ranking algorithm",type:"html",name:`${yp} algorithm`,value:[`${bp}`,"<p><i>Configure the default ranking model in the Smart Environment Pro settings.</i></p>"].join(`
`)}}}r(Ow,"settings_config");function vp(n={}){if(!this.vec)return{score:null,error:`Missing this.vec for ${this.key}`};if(!n.to_item?.vec)return{score:null,error:"Missing params.to_item.vec"};let e=me(this.vec,n.to_item.vec),s=(Array.isArray(n.hidden)?n.hidden:[]).reduce((o,a)=>{if(!a?.vec)return o;let c=me(a.vec,this.vec);return c>o?c:o},0);return{score:e-s,base_score:e}}r(vp,"sim_feedback_adjusted");vp.action_type="score";var kp="Similarity Adjusted by Feedback",wp="Penalizes candidates similar to hidden notes before ranking.",$w={score_algo_description:{group:"Score algorithm",type:"html",name:`${kp} algorithm`,value:`${wp}`}};var B$=.25,U$=.5;function W$(n){return Number.isNaN(n)||n<0?0:n>1?1:n}r(W$,"clamp_score");function jw(n,e){return!Array.isArray(n)||!n.length?0:n.reduce((t,s)=>{if(!s?.vec)return t;let i=me(e,s.vec);return i>t?i:t},0)}r(jw,"max_similarity");function xp(n={}){if(!this.vec)return{score:null,error:`Missing this.vec for ${this.key}`};if(!n.to_item?.vec)return{score:null,error:"Missing params.to_item.vec"};let e=this.vec,t=me(e,n.to_item.vec),s=jw(n.pinned,e),i=jw(n.hidden,e),o=t+s*B$-i*U$;return{score:W$(o),base_score:t,pinned_boost:s,hidden_penalty:i}}r(xp,"sim_feedback_weighted");xp.action_type="score";var Ep="Similarity Weighted by Feedback",Ap="Boosts candidates similar to pinned notes while damping those that resemble hidden notes.",Tw={score_algo_description:{group:"Score algorithm",type:"html",name:`${Ep} algorithm`,value:`${Ap}`}};var Nw={collections:{connections_lists:Wk,lookup_lists:Zk},item_types:{ConnectionsList:qe},items:{connections_list:{class:qe}},modules:{},components:{connections_footer_view:{render:tw},connections_graph_v1:{render:hw},connections_list_v4:{render:gw,display_name:yw},connections_web:{render:vw},inline_connections_popover:{render:Cw}},actions:{connections_list_post_process_rank_connections:{action:gp,settings_config:Ow,display_name:yp,display_description:bp},sim_feedback_adjusted:{action:vp,settings_config:$w,display_name:kp,display_description:wp},sim_feedback_weighted:{action:xp,settings_config:Tw,display_name:Ep,display_description:Ap}}};var X0=require("obsidian");var yl=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var bl=class extends yl{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Ln=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new bl(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};function vl(n,e){let t=Pw(n),s=Pw(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(vl,"compare_versions");function Pw(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(Pw,"normalize_version_value");function To(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(To,"is_plain_object");function Ss(n,e,t=[]){if(!To(n)||!To(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else To(i)?(To(n[s])||(n[s]={}),Ss(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(Ss,"deep_merge_no_overwrite");function xt(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(vl(d,_)>0){let p={...c};Ss(p,l),n.collections[a]=p}else Ss(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;vl(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):Ss(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),Ss(n[i],o)):n[i]=o}return n}r(xt,"merge_env_config");var jte=typeof globalThis<"u"?globalThis:Function("return this")();function H$(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=J$(n,t),o=V$(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(H$,"create_regex");function V$(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(V$,"adjust_for_windows_paths");function J$(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(J$,"glob_to_regex_pattern");function Iw(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:H$(n,s)}r(Iw,"glob_to_regex");function Mw(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(Mw,"fuzzy_search");var kl=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(Iw(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return Mw(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var K$=Y(require("obsidian"),1);var wl=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=K$,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function xl(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(xl,"empty");var Lw=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var zw=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var Y$=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,El=r((n,e)=>{let t=e.trim();(Y$.test(t)?zw:Lw)(n,t)},"safe_inner_html");function We(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(We,"escape_html");function Sp(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(Sp,"convert_to_time_ago");function Cs(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Cs,"cos_sim");function Oe(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(Oe,"get_by_path");function $e(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r($e,"set_by_path");function Cp(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(Cp,"delete_by_path");function qp(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(qp,"compute_centroid");function Op(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);s[a]+=u,s[l]+=u}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(Op,"compute_medoid");var Al=new WeakMap,Sl=new WeakMap,Cl=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return Oe(e,t,s)}set_by_path(e,t,s,i=null){$e(e,t,s,i)}delete_by_path(e,t,s=null){Cp(e,t,s)}escape_html(e){return We(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||Sl.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");Sl.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=Sl.get(i);c&&(i.removeEventListener("change",c),Sl.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=re(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){xl(e)}safe_inner_html(e,t){El(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=Al.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},Al.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}Al.get(e)===c&&Al.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var ql=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===s,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let w=document.createElement("div");w.className="array-item-row";let x=document.createElement("input");x.type="text",x.value=y,x.placeholder="Value";let b=document.createElement("button");b.textContent="\u2715",b.title="Remove",x.addEventListener("change",()=>{c[g]=x.value,f()}),b.addEventListener("click",()=>{c.splice(g,1),d(),f()}),w.appendChild(x),w.appendChild(b),l.appendChild(w)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=u.value.trim();y&&(c.push(y),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,w],x)=>{let b=document.createElement("div");b.className="json-pair-row";let C=document.createElement("input");C.type="text",C.value=g,C.placeholder="Property";let k=document.createElement("input");k.type="text",k.value=w,k.placeholder="Value";let A=document.createElement("button");A.textContent="\u2715",A.title="Remove",C.addEventListener("change",()=>{let q=C.value.trim();q&&q!==g&&(c[q]=c[g],delete c[g],d(),y())}),k.addEventListener("change",()=>{c[C.value]=k.value,y()}),A.addEventListener("click",()=>{delete c[C.value],d(),y()}),b.appendChild(C),b.appendChild(k),b.appendChild(A),l.appendChild(b)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),y())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){xl(e)}safe_inner_html(e,t){El(e,t)}};var it=require("obsidian");var Ol=class extends ql{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return it.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new it.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await it.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,it.getIcon)(e).outerHTML}is_mod_event(e){return it.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};var $l=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},jl=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};var Tl=class extends $l{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Cs(e,a.vec)};return _l(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(ul)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Cs(e,a.vec)};return Kk(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(Yk)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},Nl=class extends jl{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var X$="---frontmatter---",Rw=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),Z$=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),Q$=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),ej=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(X$),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),tj=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=Rw(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=Rw(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),$p=r((n,e={})=>{let t=Z$(n,e),s=Q$(t),i=ej(s);return tj(i,n)},"create_find_connections_filter_opts");async function zn(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=$p(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+re(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Ue).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(zn,"find_connections");zn.action_type="connections";var qs=class extends ie{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new Nl(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Os=class extends oe{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Tl(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(Ue).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return Dw}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return sj}},Dw={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},sj={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function jp(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await zn.call(this,n);let o=$p(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+re(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Ue).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Ue).slice(0,s)}return i}r(jp,"find_connections");jp.action_type="connections";var Rn=class extends qs{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=qp(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=Op(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},Fw={class:Rn,actions:{find_connections:jp}};var No=class extends Os{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Ue)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(nj),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},nj={};var Pl=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Po;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Po=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Il=class extends Pl{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Io;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Io=class extends Po{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var Bw={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Ht=class extends Il{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=Et;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},Et=class extends Io{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+u]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(u);if(d.key||(d.key=u),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return Bw[s]&&(s=Bw[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Mo=class extends Ht{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=Tp},Tp=class extends Et{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var Ml=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return re(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return Uw(this.constructor.name)}static get adapter_key(){return Uw(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function Uw(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(Uw,"to_snake");function Ll(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},y=null,g=null,w=!1,x=!1,b="#",C=!1,k=[],A=null;_[b]=0;for(let O=0;O<i.length;O++){let S=O+t,m=i[O],h=m.trim();if(h==="---"){if(!x&&S===1){x=!0,w=!0,l["#---frontmatter---"]=[S,null];continue}else if(w){w=!1,l["#---frontmatter---"][1]=S;continue}}if(w)continue;if(!C&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(S),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(S)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(S)),h.startsWith("```")){if(C=!C,C&&!A?A=S:!C&&A&&(k.push([A,S]),A=null),!g){let E=c.length>0?c[c.length-1].key:b;if(E===b&&!l[b]&&(l[b]=[S,null]),E===b)g={key:b,start_line:S},(l[b][1]===null||l[b][1]<S)&&(l[b][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let $=_[E],N=`${E}#{${$}}`;l[N]=[S,null],g={key:N,start_line:S}}}continue}let v=h.match(/^(#{1,6})\s*(.+)$/);if(v&&!C){let E=v[1].length,$=v[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=S-1)}c.length===0&&l[b]&&l[b][1]===null&&(l[b][1]=S-1),g&&(l[g.key][1]===null&&(l[g.key][1]=S-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null);let N="",M=0;if(c.length>0?(N=c[c.length-1].key,M=c[c.length-1].level):(N="",M=0),c.length===0)d[$]=(d[$]||0)+1,d[$]>1&&($+=`[${d[$]}]`);else{u[N]||(u[N]={}),u[N][$]=(u[N][$]||0)+1;let X=u[N][$];X>1&&($+=`#{${X}}`)}let ue=E-M,ge="#".repeat(ue),ye=N+ge+$;l[ye]=[S,null],_[ye]=0,c.push({level:E,title:$,key:ye});continue}let j=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(j&&!C){if(j[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null),g&&g.key!==b&&(l[g.key][1]===null&&(l[g.key][1]=S-1),g=null);let $=c.length>0?c[c.length-1].key:b;$===b&&!l[b]&&(l[b]=[S,null]),_[$]===void 0&&(_[$]=0),_[$]+=1;let N=_[$],M;if(s){let ue=j[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=ij(ue,o);M=`${$}#${ge}`}else M=`${$}#{${N}}`;l[M]=[S,null],y={key:M,start_line:S};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null);let E=c.length>0?c[c.length-1].key:b;if(E===b)l[b]||(l[b]=[S,null]),(l[b][1]===null||l[b][1]<S)&&(l[b][1]=null),g={key:b,start_line:S};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let $=_[E],N=`${E}#{${$}}`;l[N]=[S,null],g={key:N,start_line:S}}}}let q=i.length;for(;c.length>0;){let O=c.pop();l[O.key][1]===null&&(l[O.key][1]=q+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=q+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=q+t-1),g=null),l[b]&&l[b][1]===null&&(l[b][1]=q+t-1);for(let O in l)a[O]=l[O];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:k}}r(Ll,"parse_markdown_blocks");function ij(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(ij,"get_longest_words_in_order");var Vt=class extends Ml{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=Ll(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);s==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:u,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let w=this.item.block_collection.get(u);if(await this.create_hash(p)!==w.last_read?.hash){o.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function zl(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,u=o(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(zl,"get_markdown_links");function Np(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(Np,"parse_value");function oj(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=Np(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(Np(u)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=Np(c)}return t}r(oj,"parse_yaml_block");function Ww(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=oj(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(Ww,"parse_frontmatter");var Gw=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Lo=class extends Vt{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!!e)return zl(e)}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=Ww(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),Gw(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Jt=require("obsidian");function rj(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(rj,"merge_tags");var $s=class extends Lo{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=rj(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!Jt.MarkdownRenderer||!Jt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Jt.MarkdownRenderer.render(s,t,i,this.item.path,new Jt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Jt.htmlToMarkdown)(i)}};var Rl=class extends Vt{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var Dl=class extends Vt{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){}};var Fl=class extends $s{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function Hw(n,e){let[t,...s]=n.split("#").filter(Boolean),i=ll(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(Hw,"get_block_display_name");var Dn=class extends qs{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return Hw(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},Vw={class:Dn,actions:{find_connections:zn}};var zo=class extends Os{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var Bl=class extends Ht{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=Pp;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},Pp=class extends Et{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var Ul=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return re(e)}};function Wl(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(Wl,"get_line_range");var Fn=class extends Ul{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return Wl(e,t,s)}async _reparse_source(){await this.item.source.import()}};var Bn=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Ro=class extends Bn{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var Un=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var js=class extends Un{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var ot=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var Wn=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},Gn=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var Hn=class extends Wn{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new Ip(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},Ip=class extends Gn{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Ts=class extends Wn{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new Mp(i)}},Mp=class extends Gn{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var Xw=Y(Yw(),1);var pj=Object.defineProperty,hj=r((n,e,t)=>e in n?pj(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),fj=r((n,e,t)=>(hj(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function gj(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(gj,"bytePairMerge");function yj(n,e){return n.length===1?[e.get(n.join(","))]:gj(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(yj,"bytePairEncode");function bj(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(bj,"escapeRegex");var zp=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=Xw.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=zp.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=zp.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??n.length;for(let f of n.substring(l,u).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...yj(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},Hl=zp;fj(Hl,"specialTokenRegex",n=>new RegExp(n.map(e=>bj(e)).join("|"),"g"));async function Qw(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await Zw(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await Zw(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(Qw,"fetch_json_cached");async function Zw(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(Zw,"do_fetch");function Dp(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(Dp):e==="object"?Object.values(n).every(Dp):!1}r(Dp,"is_json_compatible");function Vl(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||Dp(i)&&(t[s]=i);return t}r(Vl,"extract_json_details");function Do(n){return Object.keys(n).length===0}r(Do,"is_empty_object");function vj(n,e){return Do(n)?e:Do(e)?n:{...n,...e}}r(vj,"merge_details");function Rp(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(Rp,"get_message_from_object");function Q(n,e=null){if(Array.isArray(n)&&n.length>0)return Q(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Vl(n,["message"]);return{message:t,details:Do(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=Rp(o),c=Vl(o,["message"]),l=Vl(t,["message","error"]),d=vj(l,c);return{message:a||Rp(t)||"Unknown error",details:Do(d)?null:d,http_status:e}}return Q(i)}let s=Rp(t);if(s){let i=Vl(t,["message"]);return{message:s,details:Do(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(Q,"normalize_error");var kj="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",at=class extends js{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Ge}get res_adapter(){return He}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new ot({adapter:Ts})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:Q(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await Qw(kj,"cl100k_base.json");this.tiktoken=new Hl(e)}},Ge=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},He=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Jl=class extends at{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Fp}get res_adapter(){return Bp}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Fp=class extends Ge{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Bp=class extends He{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var Kl=class extends js{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var Yl=class extends Kl{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var ex=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var tx={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:Up};var Up={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},sx={},Wp={};var Vn=class extends Yl{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=tx;constructor(e){super(e),this.connector=ex.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...sx}}get_models(){return Promise.resolve(this.models)}get models(){return Up}};var Xl=class extends at{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{},model_key:"nomic-embed-text"};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Gp}get res_adapter(){return Hp}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of xj(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Gp=class extends Ge{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},Hp=class extends He{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},wj=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),xj=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(wj)},"filter_embedding_models");var Zl=class extends at{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Vp}get res_adapter(){return Jp}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"models/gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}},Vp=class extends Ge{static{r(this,"SmartEmbedGeminiRequestAdapter")}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Jp=class extends He{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:500})}};function Ej(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(Ej,"parse_lm_studio_models");var Ql=class extends at{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Kp}get res_adapter(){return Yp}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return Ej(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},Kp=class extends Ge{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Yp=class extends He{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Fo=class extends Bn{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw Q(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var ed=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#e(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#r.bind(this)),this.xhr.addEventListener("error",this.#t.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#e(this.CLOSED))}#e(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#t(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#t(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#e(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#r(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#e(this.CLOSED)}};var td=class extends Un{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var Jn={},Kt={data:null,fetched_at:0},B=class extends td{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return U}get res_adapter(){return z}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new ot({adapter:Ts})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Kt.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=Q(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new ed(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=Q({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=Q(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=Q(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Kt?.data&&t-Kt?.fetched_at<e)return Kt.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Kt.data=o,Kt.fetched_at=t,console.log({MODELS_DEV_CACHE:Kt}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Kt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return Jn[this.constructor.key]||(Jn[this.constructor.key]={}),Jn[this.constructor.key]}set model_data(e){Jn[this.constructor.key]||(Jn[this.constructor.key]={}),Jn[this.constructor.key]=e}},U=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},z=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Bo=class extends B{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Uo}res_adapter=Wo;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Uo=class extends U{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Wo=class extends z{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var Aj=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Ps=class extends B{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Xp;parse_model_data(e){return e.data.filter(t=>!Aj.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:Sj(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function Sj(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(Sj,"get_max_input_tokens");var Xp=class extends z{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Go=class extends Ps{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var Kn=class extends B{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Ho;res_adapter=Vo;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Ho=class extends U{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Vo=class extends z{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:Q(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},Jo=class extends Kn{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var Ko=class extends B{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Zp}get res_adapter(){return Qp}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Zp=class extends U{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Qp=class extends z{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Yo=class extends B{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Xo}get res_adapter(){return Zo}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Xo=class extends U{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},Zo=class extends z{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var Qo=class extends B{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=er;res_adapter=tr;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},er=class extends U{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},tr=class extends z{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var eh={openai:{req:U,res:z},anthropic:{req:Uo,res:Wo},gemini:{req:Ho,res:Vo},lm_studio:{req:Xo,res:Zo},ollama:{req:er,res:tr}},sr=class extends B{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=eh[e];return t&&t.req?t.req:U}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=eh[e];return t&&t.res?t.res:z}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(eh).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var nr=class extends B{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return th}get res_adapter(){return sh}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},th=class extends U{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},sh=class extends z{static{r(this,"SmartChatModelGroqResponseAdapter")}};var ir=class extends B{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return U}get res_adapter(){return z}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var or=class extends B{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return nh}get res_adapter(){return ih}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},nh=class extends U{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},ih=class extends z{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var vh=require("obsidian");function nx(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=Ll(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),u=Wl(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=zl(u),f={key:d,lines:l,size:u.length,outlinks:p,last_read:{at:a,hash:re(u)}};if(!_||_?.data.last_read?.hash!==f.last_read.hash){let y=new n.block_collection.item_type(n.env,f);n.block_collection.set(y)}else _.data={..._.data,...f}}Cj(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(nx,"parse_blocks");function Cj(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(Cj,"clean_and_update_source_blocks");function oh(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():ix(a)?n[o]=oh(ix(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(oh,"ajson_merge");function ix(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(ix,"is_object");var ox={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function qj(n){let e=!1,[t,...s]=n.split(":");return ox[t]&&(t=ox[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(qj,"_parse_ajson_key");var Yt=class extends Ht{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:y,item_key:g,changed:w}=qj(p),x=`${y}:${g}`;f?(i[x]=f,(w||x!==p)&&(delete i[p],t=!0)):(delete i[x],(w||x!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=oh(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},rh=class extends Et{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},rr={collection:Yt,item:rh};var ar=class extends ie{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function Oj(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(Oj,"parse_component_properties");async function $j(n,e){let{scope_key:t,component_key:s}=Oj(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await re(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r($j,"build_component_data");var sd=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await $j(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var nd=class extends sd{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function rx(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&rx(i,o,t)}}),t}r(rx,"flatten_components_config");var id=class extends oe{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=rx(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},ax={class:id,item_type:ar,data_adapter:rr,component_adapters:{SmartViewComponentAdapter:nd}};var cx=ax;function lx(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(lx,"filter_redundant_context_items");var cr=class extends ie{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e){!e||!this.data?.context_items?.[e]||(this.data.context_items[e].folder?this.data.context_items[e].exclude=!0:delete this.data.context_items[e],this.queue_save(),this.emit_event("context:updated",{removed_key:e}))}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,s):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this.on_event("context:updated",()=>{this._context_items=null})}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return lx(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var od=class extends oe{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var jj={class:od,data_adapter:Yt,item_type:cr};var dx=jj;var rd=class extends ie{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var ct=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var ad=class extends ct{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var cd=class extends ct{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var _x=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var ld=class extends ct{static{r(this,"ImageContextItemAdapter")}static detect(e){return _x.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var dd=class extends ct{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var ah=class extends oe{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},ux={version:1,class:ah,collection_key:"context_items",item_type:rd,context_item_adapters:{BlockContextItemAdapter:ad,SourceContextItemAdapter:cd,ImageContextItemAdapter:ld,PdfContextItemAdapter:dd}};function mx(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(mx,"next_log_stats");var Yn=class extends ie{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var Tj={"collection:save_started":!0,"collection:save_completed":!0},ch=class extends oe{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return Yn}init(){this.env?.events||Ln.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!Tj[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new Yn(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=mx({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},px={class:ch,collection_key:"event_logs",data_adapter:Yt,item_type:Yn};var Is=require("obsidian");var _d=class extends Is.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available"}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&this.selectActiveSuggestion(t);let s=this.inputEl.selectionStart===this.inputEl.value.length;if(t.target!==this.inputEl||!this.inputEl.value||s||Is.Keymap.isModEvent(t)){if(t.key==="ArrowLeft"){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&(s||t.target!==this.inputEl||!this.inputEl.value)){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return this.default_suggest_action_keys.map(e=>{let t=this.env.config.actions[e];if(!t)return null;let s=t.display_name||e;return{select_action:r(()=>{this.update_suggestions(e)},"select_action"),key:e,display:s}}).filter(Boolean)}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e))}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,Is.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=Is.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let l=this.inputEl.value.length;this.inputEl.setSelectionRange(l,l)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):c&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var $le=require("obsidian");var ud=class extends _d{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var hx=require("obsidian");var md=class extends hx.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var fx=require("obsidian");var pd=class extends fx.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Milestones"),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var gx={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var lr=class extends ie{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var hd=class extends oe{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function yx(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(yx,"settings_config");var Ms=class extends lr{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var lh=class extends hd{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var Nj={class:lh,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:rr,item_type:Ms,providers:{},settings_config:yx},dh=Nj;var _h=class extends Vn{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"intfloat/multilingual-e5-small":{id:"intfloat/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},bx={class:_h,settings_config:Wp};dh.providers={transformers:bx};var vx=dh;function dr(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(dr,"format_collection_name");async function Pj(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${dr(n.collection_key)}</h2>
${t}
</div></div></div>`}r(Pj,"build_html");async function kx(n,e={}){let t=await Pj.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(kx,"render");var xx=require("obsidian");function Ij(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(Ij,"format_score");function Mj(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(Mj,"format_size");function wx(n,e){return n?`<span class="${e}">${n}</span>`:""}r(wx,"build_badge_html");function Lj(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=Ij(n?.data?.score),i=Mj(n?.size||n?.data?.size),o=wx(s,"sc-context-item-score"),a=wx(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(Lj,"build_html");async function Ex(n,e={}){let t=Lj(n,e),i=this.create_doc_fragment(t).firstElementChild;return zj.call(this,n,i,e),i}r(Ex,"render");async function zj(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${xx.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),hl(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(zj,"post_process");async function Rj(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${dr(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=Fj(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(Rj,"build_html");async function Ax(n,e={}){let t=await Rj.call(this,n,e),s=this.create_doc_fragment(t);return await Dj.call(this,n,s,e)}r(Ax,"render");async function Dj(n,e,t={}){return e}r(Dj,"post_process");function Fj(n,e){let t=Object.values(n.items).length,s=dr(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=Bj(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=Uj(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(Fj,"generate_collection_stats");function Bj(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(Bj,"get_generic_collection_stats");function Uj(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(Uj,"calculate_embed_coverage");var Sx=require("obsidian");function Wj(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(Wj,"build_html");async function uh(n,e={}){let t=Wj.call(this,n,e),s=this.create_doc_fragment(t);return await Gj.call(this,n,s,e)}r(uh,"render");async function Gj(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new Sx.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Oe(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),o.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):$e(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(Gj,"post_process");uh.version=.2;var Cx=require("obsidian");function Hj(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(Hj,"build_html");function qx(n,e={}){let t=Hj.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,Cx.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),Vj.call(this,n,i,e),i}r(qx,"render");function Vj(n,e){}r(Vj,"post_process");var Ox=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
`;var Nx=require("obsidian");var Kj=require("obsidian");var mh={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Inline connections",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Inline connections",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Inline connections",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},Yj=["Environment","Connections","Lookup","Context","Chat","Pro","Inline connections"];function $x(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=Yj.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r($x,"derive_events_checklist_groups");function ph(n,e){return!!n.event_logs.items[e]}r(ph,"check_if_event_emitted");function Xj(n,e={}){let t=$x(mh),s=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(ph(n,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(ph(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=ph(n,u.event_key)===!0;return Qj(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${We(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${We(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${We(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(Xj,"build_html");async function Px(n,e={}){this.apply_style_sheet(Ox);let t=Xj.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return Zj.call(this,n,i,e),i}r(Px,"render");async function Zj(n,e,t={}){return eT(e),tT(e),e}r(Zj,"post_process");function Qj(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${We(n.event_key)}"
data-link="${We(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${We(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${We(n.milestone)}</span>
</div>
</li>
`}r(Qj,"build_item_html");function eT(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=Tx(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||jx(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=Tx(n,e);s&&(e.preventDefault(),jx(s))}))}r(eT,"attach_item_link_listeners");function jx(n){let e=iT(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(jx,"open_item_link");function tT(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&sT(i,s)})}r(tT,"render_item_state_icons");function sT(n,e){nT(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(sT,"set_item_icon");function nT(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,Nx.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(nT,"set_icon_with_fallback");function Tx(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(Tx,"get_item_el_from_event");function iT(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=mh[t];return!s||typeof s.link!="string"?"":s.link}r(iT,"get_item_link");function oT(){return`<div>
<button class="copy-all-notifications-btn">Copy All Notifications</button>
<div class="smart-env-notifications-feed"></div>
</div>`}r(oT,"build_html");async function Ix(n,e={}){let t=this.create_doc_fragment(oT()),s=t.firstElementChild;return rT.call(this,n,s,e),t}r(Ix,"render");async function rT(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed");this.empty(s);let i=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!i.length){let a=s.ownerDocument.createElement("p");a.className="smart-env-notifications-empty",a.textContent="No Smart Env notifications yet.",s.appendChild(a);return}i.slice(-100).reverse().forEach(a=>{cT(s,a)});let o=e.querySelector(".copy-all-notifications-btn");o.addEventListener("click",()=>{let a=s.textContent;navigator.clipboard.writeText(a).then(()=>{o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy All Notifications"},2e3)})})}r(rT,"post_process");function aT(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(aT,"get_level");function cT(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=aT(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${lT(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(cT,"append_entry");function lT(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(lT,"to_time_ago");var At=require("obsidian");var _r=require("obsidian");function ur(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(ur,"get_smart_server_url");function dT(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(dT,"try_get_zlib");function _T(n){let e=dT();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(_T,"inflate_deflate_data");async function Mx(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let w=new Uint8Array(n.slice(t,t+y)),x=new TextDecoder("utf-8").decode(w);t+=y,t+=g;let b=(l&8)!==0,C=t,k;if(!b)k=C+p;else{let O=C,S=!1;for(;O+4<=s;){let m=e.getUint32(O,!0);if(m===134695760||m===67324752||m===33639248){S=!0;break}O++}k=S?O:s}if(k>s)break;let A=new Uint8Array(n.slice(C,k));if(t=k,b&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let q;if(d===0)q=A;else if(d===8)q=_T(A);else continue;if(i.push({fileName:x,data:q}),x.toLowerCase().endsWith("manifest.json")&&!x.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(q))}catch{}}return{files:i,pluginManifest:o}}r(Mx,"parse_zip_into_files");function Lx(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(Lx,"validate_zip_buffer");async function zx(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(zx,"write_files_with_adapter");function Rx(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(Rx,"is_server_version_newer");async function Dx(n,e){let t=await(0,_r.requestUrl)({url:`${ur()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return Lx(t.arrayBuffer,"Smart Plugins server")}r(Dx,"fetch_plugin_zip");async function Fx(n,e=_r.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return Lx(t.arrayBuffer,"Download")}r(Fx,"fetch_zip_from_url");async function Bx(n,e,t=_r.requestUrl){let s=await t({url:`${ur()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(Bx,"fetch_plugin_readme");async function Ux(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(Ux,"enable_plugin");function Wx(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(Wx,"get_oauth_storage_prefix");async function Gx(n){let e=await(0,_r.requestUrl)({url:`${ur()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(Gx,"fetch_server_plugin_list");var Hx=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var mT='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',pT='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function hT(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(hT,"derive_fallback_plugins");function fT(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${mT}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${pT}</p>
</div>
</div>
`}r(fT,"build_html");async function Vx(n,e={}){this.apply_style_sheet(Hx);let t=fT.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await gT.call(this,n,i,e),i}r(Vx,"render");async function gT(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=Wx(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".pro-plugins-list"),l=hT(),d=0,_="",u=null,p=r(k=>{if(!a||!k)return;(!u||!u.isConnected)&&(u=document.createElement("div"),u.classList.add("smart-plugins-login-manual"),a.appendChild(u)),u.innerHTML="";let A=document.createElement("div");A.classList.add("smart-plugins-login-manual-instructions"),A.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",u.appendChild(A);let q=document.createElement("div");q.classList.add("smart-plugins-login-manual-controls"),u.appendChild(q);let O=document.createElement("input");O.classList.add("smart-plugins-login-manual-input"),O.type="text",O.value=k,O.readOnly=!0,O.addEventListener("focus",()=>O.select()),q.appendChild(O);let S=document.createElement("button");S.classList.add("mod-cta"),S.textContent="Copy",S.addEventListener("click",async()=>{await bT(k)?new At.Notice("Copied login link to clipboard."):new At.Notice("Copy failed. Please select and copy the link manually.")}),q.appendChild(S)},"render_manual_login_link"),f=r(async()=>{let k={},{manifests:A}=i.plugins;for(;Object.keys(A).length===0;)A=i.plugins.manifests,await new Promise(q=>setTimeout(q,100));for(let q in A){if(!Object.prototype.hasOwnProperty.call(A,q))continue;let{name:O,version:S}=A[q];k[q]={name:O,version:S}}return k},"get_installed_info"),y=r(async()=>{d++,d>=2&&_&&p(_),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(_=yT()),new At.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),g=r(()=>{if(this.empty(a),u=null,!(localStorage.getItem(o+"token")||"")){new At.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(O=>{O.setButtonText("Login"),O.onClick(async()=>{await y()})});return}let A=new At.Setting(a);A.setDesc("Signed in to Smart Plugins Pro account."),A.addButton(q=>{q.setButtonText("Logout"),q.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new At.Notice("Logged out of Smart Plugins"),g(),b()})})},"render_oauth_login_section"),w=r(async()=>{if(this.empty(c),!(!c||l.length===0))for(let k of l){let A=await n.smart_components.render_component("pro_plugins_list_item",k,{env:n,app:i,installed_map:{}});c.appendChild(A)}},"render_fallback_plugin_list"),x=r(()=>{let k=new At.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");k.addButton(A=>{A.setButtonText("Get Pro"),A.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),k.addButton(A=>{A.setButtonText("Update subscription"),A.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),k.addButton(A=>{A.setButtonText("Refresh"),A.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),b=r(async()=>{this.empty(c);let k=localStorage.getItem(o+"token")||"";if(!k){await w();return}try{let A=await f(),q=await Gx(k),{list:O=[],unauthorized:S=[],sub_exp:m}=q;if(typeof m=="number"&&m<Date.now()){x(),await w();return}if(!Array.isArray(O)||O.length===0){await w();return}for(let h of O){let v=await n.smart_components.render_component("pro_plugins_list_item",h,{env:n,app:i,token:k,installed_map:A,on_installed:b});c.appendChild(v)}}catch(A){console.error("[pro-plugins:list] Failed to fetch plugin list:",A),c.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),C=r(async()=>{g(),await b()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{C()}),await C(),e}r(gT,"post_process");function yT(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${ur()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(yT,"initiate_smart_plugins_oauth");var bT=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var he=require("obsidian");var vT="https://smartconnections.app/pro-plugins/";function kT(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(kT,"build_html");function wT(n){return!n||!n.repo}r(wT,"is_fallback_item");function xT(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,Rx(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(xT,"compute_display_state");async function Jx(n,e={}){let t=kT(n,e),i=this.create_doc_fragment(t).firstElementChild;return await ET.call(this,n,i,e),i}r(Jx,"render");async function ET(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(wT(n)){let u=new he.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(vT,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=xT(n,l),_=new he.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>ST(n,{app:s,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),n.docs_url?u.onClick(()=>window.open(n.docs_url,"_external")):u.onClick(()=>CT(n,{app:s,token:i,display_name:d.display_name}))}),e}r(ET,"post_process");var AT=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return Fx(t);if(!e)throw new Error("Login required to install this plugin.");return Dx(n.repo,e)},"download_plugin_zip"),ST=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new he.Notice(`Installing "${n.repo}" ...`);let o=await AT(n,s),{files:a,pluginManifest:c}=await Mx(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await zx(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await Ux(t,_),new he.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new he.Notice(`Install failed: ${o.message}`)}},"install_plugin"),CT=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await Bx(n.repo,s),a=new he.Modal(t);a.setTitle(i||n.name||n.repo),await he.MarkdownRenderer.render(t,o,a.contentEl,"",new he.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new he.Notice("Failed to load README")}},"show_plugin_readme");var Kx=require("obsidian");var Ls=class extends Kx.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var Yx=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}`;var Xx=require("obsidian");function OT(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${Qx(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(OT,"build_html");async function Zx(n,e){this.apply_style_sheet(Yx);let s=this.create_doc_fragment(OT.call(this,n,e)).firstElementChild;return $T.call(this,n,s,e),s}r(Zx,"render");async function $T(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,Xx.setIcon)(o,Qx(n)),s.addEventListener("click",()=>{new Ls(n).open()}),i.addEventListener("click",()=>{new Ls(n,{test_on_open:!0}).open()}),e}r($T,"post_process");function Qx(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(Qx,"get_test_result_icon_name");var t0=require("obsidian");var e0={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function fd(n,e,t={}){let s=(e0[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new t0.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new Ls(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(fd,"show_new_model_menu");var yd=require("obsidian");var gd=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new yd.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function bd(n,e,t,s={}){let{default_group_name:i="Settings"}=s;n=n0(n,e);let o=Object.entries(n||{}).reduce((c,[l,d])=>{let _=d.group||i;return c[_]||(c[_]={}),c[_][l]=d,c},{[i]:{}});return Object.entries(o).sort(([c],[l])=>c===i?-1:l===i?1:0).filter(([,c])=>Object.keys(c).length>0).map(([c,l])=>{let d=t.createDiv(),_={...s,...s.group_params?.[c]||{}};return jT(c,e,l,d,_)})}r(bd,"render_settings_config");function jT(n,e,t,s,i={}){let o;try{let l=require("obsidian");l.SettingGroup?o=l.SettingGroup:o=gd}catch{o=gd}t=n0(t,e);let{heading_btn:a=null}=i,c=new o(s);if(a&&typeof a=="object")if(Array.isArray(a))for(let l of a)s0(c,e,l);else s0(c,e,a);c.setHeading(n);for(let[l,d]of Object.entries(t)){if(!d||typeof d!="object"){console.warn(`Invalid setting config for ${l}:`,d);continue}c.addSetting(_=>{switch(d.name&&_.setName(d.name),_.setClass(l.replace(/[^a-zA-Z0-9]/g,"-")),d.type&&_.setClass(`setting-type-${d.type}`),d.description&&_.setDesc(d.description),d.type){case"button":_.addButton(u=>{u.setButtonText(d.name||"Run"),u.onClick(async p=>{typeof d.callback=="function"&&await Xn(_,p,d.callback,{scope:e})})});break;case"toggle":_.addToggle(u=>{u.setValue(Oe(e.settings,l)||!1),u.onChange(p=>{$e(e.settings,l,p),typeof d.callback=="function"&&Xn(_,p,d.callback,{scope:e})})});break;case"text":_.addText(u=>{u.setValue(String(Oe(e.settings,l)||"")),u.onChange(p=>{$e(e.settings,l,p)})});break;case"number":_.addText(u=>{u.setValue(String(Oe(e.settings,l)||"")),u.inputEl.setAttribute("type","number"),u.onChange(p=>{let f=Number(p);isNaN(f)||$e(e.settings,l,f),typeof d.callback=="function"&&Xn(_,f,d.callback,{scope:e})})});break;case"dropdown":_.addDropdown(u=>{let p=d.options_callback;typeof p=="function"&&p.call(e,e).forEach(y=>{let g=y.label||y.name||y.value;u.addOption(y.value,g)}),u.setValue(Oe(e.settings,l)||""),u.onChange(f=>{$e(e.settings,l,f),typeof d.callback=="function"&&Xn(_,f,d.callback,{scope:e})})});break;case"textarea":_.addTextArea(u=>{u.setValue(String(Oe(e.settings,l)||"")),u.onChange(p=>{$e(e.settings,l,p)})});break;case"slider":_.addSlider(u=>{let p=d.min||0,f=d.max||100,y=d.step||1;u.setLimits(p,f,y),u.setValue(Oe(e.settings,l)||p),u.setDynamicTooltip(),u.onChange(g=>{$e(e.settings,l,g),typeof d.callback=="function"&&Xn(_,g,d.callback,{scope:e})})});break;case"heading":_.setHeading();break;case"html":d.value&&_.descEl.replaceChildren(document.createRange().createContextualFragment(d.value));break;default:console.warn(`Unsupported setting type for ${l}:`,d.type);break}d.scope_class&&_.settingEl.addClass(d.scope_class)})}return c}r(jT,"render_settings_group");function s0(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,yd.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await Xn(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(s0,"render_heading_button");async function Xn(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(Xn,"handle_config_callback");function n0(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(n0,"ensure_settings_config");function TT(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(TT,"build_html");async function i0(n,e){let s=this.create_doc_fragment(TT.call(this,n,e)).firstElementChild;return NT.call(this,n,s,e),s}r(i0,"render");async function NT(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=bd(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{fd(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(NT,"post_process");function PT(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(PT,"build_html");async function o0(n,e){let s=this.create_doc_fragment(PT(n,e)).firstElementChild;return IT.call(this,n,s,e),s}r(o0,"render");async function IT(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(IT,"post_process");var c0=require("obsidian");function vd(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(vd,"ensure_smart_sources_settings");function mr(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(mr,"parse_exclusions_csv");function r0(n,e){let t=(e??"").trim();if(!t)return n||"";let s=mr(n);return s.includes(t)||s.push(t),s.join(",")}r(r0,"add_exclusion");function a0(n,e){let t=(e??"").trim();return t?mr(n).filter(i=>i!==t).join(","):n?.trim()||""}r(a0,"remove_exclusion");var kd=class extends c0.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=vd(this.env),t=mr(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=vd(this.env);t.folder_exclusions=r0(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=vd(this.env),t=mr(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=a0(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var l0=require("obsidian");var wd=class extends l0.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function MT(n,e={}){return`
<div class="sources-settings">
</div>
`}r(MT,"build_html");async function d0(n,e={}){let t=await MT.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return LT.call(this,n,i,e),i}r(d0,"render");async function LT(n,e,t={}){bd({folder_exclusions:RT,view_exclusions:DT,re_import_sources:FT},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",zT(n,e))),this.attach_disposer(e,i),e}r(LT,"post_process");function zT(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(zT,"highlight_reset_data");var RT={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new kd(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},DT={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new wd(t.main.app,t).open()},"callback")},FT={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"})},"callback")};function BT(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(BT,"build_html");async function _0(n,e={}){let s=this.create_doc_fragment(BT(n,e)).firstElementChild;return UT.call(this,n,s,e),s}r(_0,"render");async function UT(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),fd(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(UT,"post_process");async function WT(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(WT,"build_html");async function u0(n,e={}){let t=await WT.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return GT.call(this,n,i,e),i}r(u0,"render");async function GT(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(GT,"post_process");var m0=`.sc-env-settings-container {\r
margin: 1rem 0;\r
}\r
\r
.smart-env-settings-header {\r
display: flex;\r
align-items: center;\r
justify-content: space-between;\r
margin-bottom: 0.5rem;\r
}\r
\r
.toggle-env-settings-btn {\r
cursor: pointer;\r
}\r
\r
\r
.setting-group .setting-items .setting-item.env-setting-highlight {\r
border: 1px solid var(--interactive-accent);\r
background-color: var(--interactive-hover);\r
padding: 0.5rem;\r
margin: 0.5rem 0;\r
}\r
\r
.settings-group {\r
.setting-item {\r
border-top: none;\r
}\r
}`;async function VT(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(VT,"build_html");async function p0(n,e={}){this.apply_style_sheet(m0);let t=await VT.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return JT.call(this,n,i,e),i}r(p0,"render");async function JT(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return hh.call(this,"settings_env_sources",n,i),hh.call(this,"settings_env_models",n,s),hh.call(this,"settings_notifications",n,o),e}r(JT,"post_process");function hh(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(hh,"render_if_available");var h0=require("obsidian");function KT(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(KT,"build_html");async function f0(n,e={}){let t=KT(),i=this.create_doc_fragment(t).firstElementChild;return YT.call(this,n,i,e),i}r(f0,"render");async function YT(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),XT(n,a),ZT(n,a),QT(n,a),eN(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(YT,"post_process");function XT(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(XT,"render_btn_open_selector");function ZT(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(ZT,"render_btn_copy_context");function QT(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(QT,"render_btn_clear_context");function eN(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,h0.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(eN,"render_btn_help");var g0=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var pr=require("obsidian");async function xd(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(pr.Platform.isMobile)new pr.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new pr.Notice("Failed to copy.")}}r(xd,"copy_to_clipboard");function sN(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(sN,"build_html");async function y0(n,e={}){let t=sN(n,e);this.apply_style_sheet(g0);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return nN.call(this,n,i,e),i}r(y0,"render");async function nN(n,e,t={}){let s=[],i=r(async()=>{let l=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(u=>{this.empty(l),l.appendChild(u)});let d=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(u=>{this.empty(d),d.appendChild(u)});let _=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(u=>{this.empty(_),_.appendChild(u)})},"render_children"),o=n.env.plugin,a=o?.app||window.app;return(o?.registerDomEvent?.bind(o)||((l,d,_)=>l.addEventListener(d,_)))(e,"contextmenu",l=>{if(l.preventDefault(),l.stopPropagation(),!a)return;let d=new Menu(a);d.addItem(_=>_.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let u=iN(e);await xd(u)})),d.showAtMouseEvent(l)}),await i(),s.push(n.on_event("context:updated",i)),this.attach_disposer(e,s),e}r(nN,"post_process");function iN(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(iN,"tree_dom_to_wikilinks");function oN(n){return Math.ceil((n||0)/4)}r(oN,"estimate_tokens");function rN(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(rN,"build_html");async function b0(n,e={}){let t=rN(),i=this.create_doc_fragment(t).firstElementChild;return aN.call(this,n,i,e),i}r(b0,"render");async function aN(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=oN(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(aN,"post_process");function v0(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-tree-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let u=["sc-tree-label"];return n.exists===!1&&u.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${a?l:""}
<span class="${u.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(v0,"build_tree_item");function k0(n){let e=cN(n),t=new Set(n.map(i=>i.key||i.path));return w0(e,t)}r(k0,"build_tree_html");function cN(n=[]){let e=r(o=>{let a=/#\{\d+\}$/u,c=o,l=null,d=null,_=!1,u=c.match(a);u&&(l=u[0],c=c.slice(0,-l.length),_=!0);let p=c.indexOf("##");p!==-1&&(d=c.slice(p),c=c.slice(0,p),_=!0);let f=[];if(c){let y="",g=!1;for(let w=0;w<c.length;w++)!g&&c.slice(w,w+2)==="[["?(g=!0,y+="[[",w++):g&&c.slice(w,w+2)==="]]"?(g=!1,y+="]]",w++):!g&&c[w]==="/"?(f.push(y),y=""):y+=c[w];y&&f.push(y)}return d&&f.push(d),l&&f.push(l),{segments:f,has_block:_}},"split_path_segments"),t={name:"",children:{},selected:!1},s=r((o,a)=>a.some(c=>o.startsWith(`${c}/`)),"is_redundant"),i=n.filter(o=>!(o.key.includes("#")?o.key.split("#")[0]:o.key).match(/\.[a-zA-Z0-9]+$/u)).map(o=>o.key);for(let{key:o,exists:a}of n){if(s(o,i.filter(u=>u!==o)))continue;let{segments:c,has_block:l}=e(o),d=t,_="";c.forEach((u,p)=>{if(_=_?`${_}/${u}`:u,u.startsWith("external:.."))return;let f=p===c.length-1,y=f&&l;d.children[u]||(d.children[u]={name:u,path:y?o:_,children:y?[]:{},selected:!1,is_file:y||f&&u.includes(".")}),d=d.children[u],f&&(d.selected=!0,d.exists=a)})}return t}r(cN,"build_path_tree");function w0(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>v0(s,e,w0(s,e))).join("")}</ul>`}r(w0,"tree_to_html");var x0=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;function dN(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(dN,"build_html");async function E0(n,e={}){this.apply_style_sheet(x0);let t=dN(n,e),i=this.create_doc_fragment(t).firstElementChild;return _N.call(this,n,i,e),i}r(E0,"render");async function _N(n,e,t={}){let s=r(()=>{let o=n.env,a=n.context_items.filter(t.filter),c=k0(a),l=this.create_doc_fragment(c);this.empty(e),e.appendChild(l);for(let d=0;d<a.length;d++){let _=a[d],u=e.querySelector(`.sc-tree-item[data-path="${_.key}"]`);if(!u){console.warn(`Smart Context: Could not find tree item for path: ${_.key}`);continue}o.smart_components.render_component("context_item_leaf",_).then(p=>{this.empty(u),u.appendChild(p)})}},"render_tree_leaves");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(_N,"post_process");var A0=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function mN(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(mN,"build_html");async function S0(n,e={}){let t=mN(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(A0),await pN.call(this,n,s,e),s}r(S0,"render");async function pN(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let u=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',w=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',x="",b="";try{let k=await p.read();x=k.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),b=(await p.get_embed_input(k)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(k){console.error("[source_inspector] Error reading block:",k),x='<em style="color:red;">Error reading block content</em>'}let C=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${w}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${b}</pre>
</details>
<blockquote>${x}</blockquote>
<hr>
`);s.appendChild(C)}return e}r(pN,"post_process");var j0=require("obsidian");var Zn=require("obsidian");var C0=require("obsidian");var Ed=class extends C0.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var q0=require("obsidian");var Ad=class extends q0.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function O0(n,e,t={}){let{Menu:s=Zn.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new Zn.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new Zn.Notice("Active note is not indexed by Smart Environment");return}new Ed(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Ad(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new Zn.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(O0,"register_status_bar_context_menu");var $0=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function fN(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(fN,"build_html");async function T0(n,e={}){this.apply_style_sheet($0);let s=this.create_doc_fragment(fN()).firstElementChild;return gN.call(this,n,s,e),s}r(T0,"render");function gN(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",w=c(),x=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",x="attention"),s&&(0,j0.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=b=>{b.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),w>0?i.dataset.count=String(w):delete i.dataset.count,x?i.dataset.level=String(x):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=b=>{if(l()>0)b.preventDefault(),b.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let k=new MouseEvent("contextmenu",b);e.dispatchEvent?.(k)}},e.addEventListener("click",e._click_handler))},"render_status_elm");O0(n,e),d();let _=null,u=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",u)),this.attach_disposer(e,p)}r(gN,"post_process");var N0=require("obsidian");function yN(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(yN,"build_html");function P0(n,e={}){let t=yN.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return bN.call(this,n,i,e),i}r(P0,"render");async function bN(n,e){let t=e.querySelector(".callout-icon"),s=(0,N0.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(bN,"post_process");var I0=require("obsidian");function vN(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(vN,"build_html");function M0(n,e={}){let t=vN.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,I0.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),kN.call(this,n,i,e),i}r(M0,"render");function kN(n,e){}r(kN,"post_process");var fh=require("obsidian");async function L0(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new fh.Notice("No context items to copy.");let t=await this.get_text(n);await xd(t);let s=wN({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new fh.Notice(s)}r(L0,"copy_to_clipboard");function wN(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${xN(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=EN(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(wN,"format_stats_message");function xN(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(xN,"format_char_count");function EN(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(EN,"sum_exclusions");async function z0(n,e){let t={KEY:this.key,TIME_AGO:Sp(this.mtime)||"Missing",LINK_DEPTH:this.data.d||0},s=r(async a=>{let c=/{{([\w_]+)}}/g,l=(a.match(c)||[]).length;for(let d=0;d<l;d++)a=a.replace(/{{(\w+)}}/g,(_,u)=>t[u]||"");return a},"replace_vars"),i=await s(this.settings.template_before||Sd.template_before),o=await s(this.settings.template_after||Sd.template_after);return["",i,n,o,""].join(`
`)}r(z0,"merge_template");var R0={item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
</ul>
`},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content."},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content."}},Sd={template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function qd(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=AN(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Cd(e),D0(e).trimEnd()}r(qd,"build_file_tree_string");function AN(n){return typeof n=="string"&&n.endsWith("/")}r(AN,"is_folder_path");function Cd(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Cd(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Cd(n[i])}else Cd(t)}}}r(Cd,"compress_single_child_dirs");function D0(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=D0(o,e+(c?"    ":"\u2502   ")))}),t}r(D0,"build_tree_string");async function F0(n,e){let t={FILE_TREE:r(()=>qd(e.map(a=>a.key)),"FILE_TREE")},s=r(async a=>{let c=(a.match(/{{(\w+)}}/g)||[]).length;for(let l=0;l<c;l++)a=a.replace(/{{(\w+)}}/gi,(d,_)=>t[_]?.()||"");return a},"replace_vars"),i=await s(this.settings.template_before||Od.template_before),o=await s(this.settings.template_after||Od.template_after);return[i,n,o].join(`
`)}r(F0,"merge_template");var B0={context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context."},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context."}},Od={template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function hr(n={}){let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:SN(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action")}))}r(hr,"context_suggest_blocks");function SN(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(SN,"get_block_display_name");var U0="Add blocks";function W0(n={}){return Object.values(this.env.smart_sources.items).map(t=>({key:t.key,display:t.key,select_action:r(()=>{this.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",hr.call(this,{source_key:t.key})),"mod_select_action"),arrow_right_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",hr.call(this,{source_key:t.key})),"arrow_right_action")}))}r(W0,"context_suggest_sources");var G0="Add sources";async function $d(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r($d,"pre_process");function gh(n){return this.vec?n.to_item?.vec?{score:Cs(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(gh,"similarity");gh.action_type="score";var yh="Cosine Similarity",bh="Ranks by cosine similarity between the current note and candidates.",H0={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${yh} algorithm`,value:`${bh}`}};async function V0(n=null){await fl(this,n)}r(V0,"source_open");var J0={collections:{embedding_models:vx,lookup_lists:Pn},item_types:{EmbeddingModel:Ms,LookupList:Wt},items:{embedding_model:{class:Ms},lookup_list:{class:Wt}},modules:{},components:{collection_settings:{render:kx},context_item_leaf:{render:Ex},env_stats:{render:Ax},form_dropdown:{render:uh},lean_coffee_callout:{render:qx},milestones:{render:Px},notifications_feed:{render:Ix},pro_plugins_list:{render:Vx},pro_plugins_list_item:{render:Jx},settings_env_model:{render:Zx},settings_env_model_type:{render:i0},settings_env_models:{render:o0},settings_env_sources:{render:d0},settings_model_actions:{render:_0},settings_notifications:{render:u0},settings_smart_env:{render:p0},smart_context_actions:{render:f0},smart_context_item:{render:y0},smart_context_meta:{render:b0},smart_context_tree:{render:E0},source_inspector:{render:S0},status_bar:{render:T0},supporter_callout:{render:P0},user_agreement_callout:{render:M0}},actions:{context_copy_to_clipboard:{action:L0},context_item_merge_template:{action:z0,settings_config:R0,default_settings:Sd},context_merge_template:{action:F0,settings_config:B0,default_settings:Od},context_suggest_blocks:{action:hr,display_name:U0},context_suggest_sources:{action:W0,display_name:G0},lookup_list_pre_process:{action:$d,pre_process:$d},similarity:{action:gh,settings_config:H0,display_name:yh,display_description:bh},source_open:{action:V0}}};var CN={env_path:"",modules:{smart_fs:{class:kl,adapter:wl},smart_view:{class:Cl,adapter:Ol},smart_embed_model:{class:Ro,adapters:{transformers:Vn,openai:Jl,ollama:Xl,gemini:Zl,lm_studio:Ql}},smart_chat_model:{class:Fo,adapters:{anthropic:Bo,azure:Go,custom:sr,google:Kn,gemini:Jo,groq:nr,lm_studio:Yo,ollama:Qo,open_router:Ko,openai:Ps,xai:ir,deepseek:or},http_adapter:new ot({adapter:Hn,obsidian_request_url:vh.requestUrl})},http_adapter:{class:ot,adapter:Hn,obsidian_request_url:vh.requestUrl}},collections:{context_items:ux,event_logs:px,smart_components:cx,smart_contexts:dx,smart_sources:{collection_key:"smart_sources",class:No,data_adapter:Mo,source_adapters:{md:$s,txt:$s,"excalidraw.md":Fl,base:Rl,canvas:Dl},content_parsers:[nx],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:zo,data_adapter:Bl,block_adapters:{md:Fn,txt:Fn,"excalidraw.md":Fn}}},item_types:{SmartSource:Rn,SmartBlock:Dn},items:{smart_source:Fw,smart_block:Vw},default_settings:gx,modals:{context_selector:{class:ud,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:pd},notifications_feed_modal:{class:md}}};xt(CN,J0);var qN=require("obsidian");var ON=require("obsidian");var jN=require("obsidian");var $N=require("obsidian");function jd(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(jd,"get_smart_server_url");function K0(n){return{token:localStorage.getItem(n+"token")||"",refresh:localStorage.getItem(n+"refresh")||""}}r(K0,"get_local_storage_token");var TN="_smart_plugins_oauth_";function Y0(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${TN}`}r(Y0,"build_oauth_storage_prefix");var PN=require("obsidian");var NN=require("obsidian");var IN=require("obsidian");var nE=require("obsidian"),ve=require("@codemirror/view"),Nd=require("@codemirror/state");var kh=r((n,e)=>Number.isInteger(e)&&e>0&&e<=n.lines,"line_exists");function Z0(n={}){let e=typeof n.ttl_ms=="number"?n.ttl_ms:1e4,t=new Map;return{set:r(({key:o,value:a})=>{t.set(o,{timestamp:Date.now(),value:a})},"write_entry"),get:r(({key:o})=>{if(!t.has(o))return null;let a=t.get(o);return Date.now()-a.timestamp>e?(t.delete(o),null):a.value},"read_entry"),clear:r(()=>t.clear(),"clear")}}r(Z0,"create_inline_cache");function Q0(n){let e=n.settings??{},t=e.inline_connections_score_threshold??"",s=e.score_algo_key??"",i=e.results_collection_key??"";return`${n.block_key}|${n.block_hash}|${s}|${i}|${t}`}r(Q0,"make_cache_key");function eE(n){let e=typeof n?.buffer=="number"?n.buffer:0,t=e>0?Math.floor(e):0,s=n?.doc;if(!s||typeof s.length!="number"||typeof s.lineAt!="function")return{min_line:1,max_line:1};let i=Number(s.length)||0;if(i===0)return{min_line:1,max_line:1};let o=r(_=>(_=Number(_),!Number.isFinite(_)||_<0?0:_>i?i:_),"clamp"),c=(Array.isArray(n.ranges)&&n.ranges.length?n.ranges:[{from:0,to:i}]).reduce((_,u)=>{let p=o(u.from),f=o(u.to),y=s.lineAt(p).number,g=s.lineAt(f).number;return{start:Math.min(_.start,y),end:Math.max(_.end,g)}},{start:Number.POSITIVE_INFINITY,end:0}),l=Math.max(1,c.start-t),d=c.end+t;return{min_line:l,max_line:d}}r(eE,"get_visible_window");function MN(n,e){if(!n||!e)return!1;let t=Number(n.start),s=Number(n.end),i=Number(e.start),o=Number(e.end);return!Number.isFinite(t)||!Number.isFinite(s)||!Number.isFinite(i)||!Number.isFinite(o)||t>s||i>o?!1:t<=o&&i<=s}r(MN,"ranges_overlap");function tE(n,e){if(!Array.isArray(n)||!n.length)return!1;for(let t of n){if(!Array.isArray(t)||t.length<2)continue;let[s,i]=t;if(MN({start:s,end:i},e))return!0}return!1}r(tE,"any_range_overlaps");var LN=typeof window<"u"?window:globalThis,zN=r(n=>{let e=LN?.requestIdleCallback;return typeof e=="function"?e(n,{timeout:250}):setTimeout(()=>n({timeRemaining:r(()=>0,"timeRemaining"),didTimeout:!0}),16)},"request_idle_default"),sE=r(({request_idle_fn:n=zN,max_concurrent:e=1}={})=>{let t=0,s=[],i=r(()=>{if(t>=e||!s.length)return;let{job:a,resolve:c,reject:l}=s.shift();t+=1,n(()=>{Promise.resolve().then(a).then(c,l).finally(()=>{t-=1,i()})})},"drain_queue");return{enqueue_job:r(a=>new Promise((c,l)=>{s.push({job:a,resolve:c,reject:l}),i()}),"enqueue_job")}},"create_job_scheduler");var wh=Nd.StateEffect.define(),RN=Nd.StateField.define({create:r(()=>ve.Decoration.none,"create"),update:r((n,e)=>{for(let t of e.effects)if(t.is(wh))return t.value;return e.docChanged?n.map(e.changes):n},"update"),provide:r(n=>ve.EditorView.decorations.from(n),"provide")}),{enqueue_job:DN}=sE({max_concurrent:2}),FN=1e4,BN=40,Td=Z0({ttl_ms:FN}),xh=class extends ve.WidgetType{static{r(this,"BadgeWidget")}constructor({block_key:e,plugin:t,block_hash:s}){super(),this.block_key=e,this.block_hash=s,this.plugin=t,this.plugin.env.create_env_getter(this),this._checked=!1,this._pending=null}eq(e){return e.block_key===this.block_key&&e.block_hash===this.block_hash}toDOM(){let e=document.createElement("span");e.className="sc-block-badge sc-loading",e.title="Connections",e.dataset.blockKey=this.block_key,e.style.cssText="cursor:pointer;user-select:none;opacity:0;position:absolute;top:0;right:-1rem;",e.appendChild((0,nE.getIcon)("smart-connections"));let t=new IntersectionObserver(s=>{s[0].isIntersecting&&(t.disconnect(),this._check_connections(e))},{root:null,threshold:0,rootMargin:"200px 0px"});return t.observe(e),requestAnimationFrame(()=>{if(!e.isConnected)return;let s=e.getBoundingClientRect();s.bottom>0&&s.top<window.innerHeight&&s.right>0&&s.left<window.innerWidth&&this._check_connections(e)}),e.addEventListener("mouseenter",async()=>{this._checked||await this._check_connections(e),e.classList.contains("sc-has-hits")&&this._show_popover(e)}),e}ignoreEvent(){return!1}get connections_list(){return this.block?.connections||this.env.connections_lists.new_item(this.block)}async _check_connections(e){if(!this._checked){this._pending||(this._pending=DN(()=>this.#e(e)));try{await this._pending}finally{this._pending=null}}}async#e(e){if(!this.block||!e.isConnected){try{e.remove()}catch{}return}let t=this.env?.connections_lists,s=t?.settings||{},i=s.inline_connections_score_threshold?parseFloat(s.inline_connections_score_threshold):.8,o=Q0({block_key:this.block_key,block_hash:this.block_hash,settings:s}),a=Td.get({key:o});if(a){this.#t(e,a.ok,a.items);return}let l=this.connections_list.filter_and_score({limit:10,score_algo_key:t.score_algo_key,results_collection_key:t.results_collection_key,to_item:this.block,filter:{exclude_keys:[this.block.source_key],exclude_key_starts_with_any:[this.block.source_key]}}).filter(_=>_.score>=i),d=l.length>0;Td.set({key:o,value:{ok:d,items:l}}),this.#t(e,d,l)}#t(e,t,s){if(this._checked=!0,!t){e.style.display="none";try{e.remove()}catch{}return}e.style.transition="opacity 0.5s ease-in-out",e.style.opacity=1,e.classList.remove("sc-loading"),e.classList.add("sc-has-hits"),e._inline_results=s}get block(){return this.env.smart_blocks.get(this.block_key)}async _show_popover(e){if(e._popover||!this.block)return;let t=await this.env.render_component("inline_connections_popover",this,{precomputed_items:e._inline_results});document.body.appendChild(t),UN(t,e),e._popover=t;let s=null,i=r(()=>s=setTimeout(a,300),"schedule_hide"),o=r(()=>s&&clearTimeout(s),"cancel_hide"),a=r(()=>{try{t.remove()}catch{}e._popover=null},"close");e.addEventListener("mouseleave",i,{once:!0}),t.addEventListener("mouseenter",o),t.addEventListener("mouseleave",i),e.removeAttribute("title")}},Eh=ve.ViewPlugin.fromClass(class{constructor(n){this.view=n,window.smart_env.create_env_getter(this),this.plugin=this.env?.smart_connections_plugin,this.badges=ve.Decoration.none,this.is_ready=!1,this.off_settings=this.env?.events?.on?.("settings:changed",()=>Td.clear()),this.off_opened=this.env?.events?.on?.("sources:opened",()=>{Td.clear(),this.schedule_refresh(0)}),setTimeout(()=>{this.is_ready=!0,this.schedule_refresh(0)},1300)}schedule_refresh(n=300){clearTimeout(this.timer),this.timer=setTimeout(()=>this.refresh(),n)}update(n){(n.docChanged||n.selectionSet||n.viewportChanged)&&this.schedule_refresh(150)}async refresh(){let{plugin:n,view:e}=this;if(!this.is_ready){this.schedule_refresh(200);return}let t=n?.env?.connections_lists?.settings;if(!t?.inline_connections){this.badges=ve.Decoration.none;try{requestAnimationFrame(()=>e.dispatch({effects:[wh.of(this.badges)]}))}catch(d){console.error("[Smart Connections] Decoration clear failed",d)}return}if(!this.env||this.env.state!=="loaded"){this.schedule_refresh();return}let s=n.app.workspace.getActiveFile();if(!s)return;let i=this.env.smart_sources.items[s.path],o=Array.isArray(i?.data?.codeblock_ranges)?i.data.codeblock_ranges:[],a=(i?.blocks??[]).filter(d=>d.vec),c=eE({doc:e.state.doc,ranges:e.visibleRanges,buffer:BN}),l=[];for(let d of a){let _=d.line_start;if(_<c.min_line||_>c.max_line||!kh(e.state.doc,_))continue;let u=d.line_end??_+1;if(!kh(e.state.doc,u)||t?.inline_connections_skip_codeblocks&&tE(o,{start:_,end:u}))continue;let p=e.state.doc.line(_),f=p.to;if(f>e.state.doc.length)continue;let y=e.state.doc.line(u),g=e.state.doc.sliceString(p.from,y.to),w=gl(g);d.data.last_read?.hash===w&&l.push(ve.Decoration.widget({side:1,widget:new xh({block_key:d.key,plugin:n,block_hash:w})}).range(f))}this.badges=l.length?ve.Decoration.set(l,!0):ve.Decoration.none;try{requestAnimationFrame(()=>this.view.dispatch({effects:[wh.of(this.badges)]}))}catch(d){console.error("[Smart Connections] Decoration dispatch failed",d)}}destroy(){clearTimeout(this.timer);try{this.off_settings?.()}catch{}try{this.off_opened?.()}catch{}}});function UN(n,e){let t=e.getBoundingClientRect(),s=n.getBoundingClientRect(),i=t.right+6,o=t.top;i+s.width>window.innerWidth&&(i=Math.max(t.left-s.width-6,0)),o+s.height>window.innerHeight&&(o=Math.max(window.innerHeight-s.height-8,0)),n.style.left=`${i}px`,n.style.top=`${o}px`}r(UN,"show_popover_relative_to_anchor");var iE=r(()=>[RN,Eh],"connections_inline_extension");var I=require("obsidian");function WN(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(WN,"sort_by_score");function oE(n,e){return WN(n,e)}r(oE,"sort_by_score_descending");function aE(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=rE(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=rE(n.results);n.min=s,n.minResult=i}}r(aE,"results_acc");function rE(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(rE,"find_min");var fr="score_connection",cE="Returns the connection score between two files.",lE="Score Connection",dE=r(n=>{if(!n.app.internalPlugins.plugins?.bases?.enabled)return;let t=r((c,l)=>{try{let d=globalThis.smart_env||{};if(d.state!=="loaded")return new I.StringValue("Smart Env not ready.");let _=d.smart_sources;if(!_)return new I.StringValue("Smart Sources not ready.");let u=Ah(c),p=Ah(l);if(!u)return new I.StringValue("Missing item a.");if(!p)return new I.StringValue("Missing item b.");let{metadata_cache:f}=n.app,y=n.app.vault.getAbstractFileByPath(u)??f.getFirstLinkpathDest(u,""),g=n.app.vault.getAbstractFileByPath(p)??f.getFirstLinkpathDest(p,"");if(!y)return new I.StringValue(`File not found: ${u}`);if(!g)return new I.StringValue(`File not found: ${p}`);let w=_.get(y.path),x=_.get(g.path);if(!w)return new I.StringValue(`No Smart Source for: ${u}`);if(!x)return new I.StringValue(`No Smart Source for: ${p}`);if(!w.vec)return new I.StringValue(`No embedding for: ${u}`);if(!x.vec)return new I.StringValue(`No embedding for: ${p}`);let b=d.connections_lists.score_algo_key,C={to_item:x,score_algo_key:b},{score:k}=w.score(C);return new I.NumberValue(Number.isFinite(k)?Math.round(k*100)/100:0)}catch(d){return console.error("Error in score_connection:",d),new I.StringValue("Error computing connection score, see console for details.")}},"score_connections_handler");n.registerGlobalFunc({name:fr,params:[{name:"file",type:[I.Value,I.FileValue,I.StringValue]},{name:"compared_to",type:[I.Value,I.FileValue,I.StringValue]}],docString:cE,ctx:null,applyWithContext(c,...l){return t(...l)}}),n.registerInstanceFunc(I.FileValue,{name:fr,params:[{name:"self",type:[I.Value,I.FileValue]},{name:"compared_to",type:[I.Value,I.FileValue,I.StringValue]}],docString:cE,ctx:null,applyWithContext(c,...l){return console.log("score_connections_handler ctx and args:",{_ctx:c,args:l}),t(...l)}});let s=r(c=>{try{let d=globalThis.smart_env||{};if(d.state!=="loaded")return new I.StringValue("Smart Env not ready.");let _=d.smart_sources;if(!_)return new I.StringValue("Smart Sources not ready.");let u=Ah(c);if(!u)return new I.StringValue("Missing item.");let{metadata_cache:p}=n.app,f=n.app.vault.getAbstractFileByPath(u)??p.getFirstLinkpathDest(u,"");if(!f)return new I.StringValue(`File not found: ${u}`);let y=_.get(f.path);if(!y)return new I.StringValue(`No Smart Source for: ${u}`);if(!y.vec)return new I.StringValue(`No embedding for: ${u}`);let g=d.connections_lists.score_algo_key,w={to_item:y,score_algo_key:g},x=[],{results:b}=Object.values(_.items).reduce((q,O)=>{let S=O.filter_and_score({...w,filter:{exclude_keys:[y.key]}});return S?.score?(aE(q,S,5),q):(S?.error&&x.push(S.error),q)},{min:0,results:new Set}),C=Array.from(b).sort(oE);console.log("connections_list_handler results:",C);let k=C.map(q=>I.LinkValue.parseFromString(n.app,`[[${q.item.key}|${q.score?.toFixed(2)??"n/a"} ${q.item.name}]]`));console.log("connections_list_handler links:",k);let A=new I.ListValue(k);return console.log("connections_list_handler list:",A),A}catch(d){return console.error("Error in connections_list:",d),new I.StringValue("Error retrieving connections list, see console for details.")}},"connections_list_handler");n.registerGlobalFunc({name:"list_connections",params:[{name:"file",type:[I.Value,I.FileValue,I.StringValue]}],docString:"Returns a list of top 5 connections for the given file.",ctx:null,applyWithContext(c,...l){return s(...l)}}),n.registerInstanceFunc(I.FileValue,{name:"list_connections",params:[{name:"self",type:[I.Value,I.FileValue]}],docString:"Returns a list of top 5 connections for the given file.",ctx:null,applyWithContext(c,...l){return s(...l)}});let i=n.app.workspace,o=i.operatorFuncConfigs?.bases||[];o.some(c=>c?.funcName===fr)||i.registerOperatorFuncConfigs("bases",[...o,{funcName:fr,display:lE,inverseDisplay:"Inverse "+lE}]),n.register(()=>{i?.unregisterOperatorFuncConfigs?.("bases",[fr])})},"register_bases_integration"),Ah=r(n=>{if(n){if(typeof n=="string")return n;if(typeof n=="object"){let e=n;if(typeof e.path=="string")return e.path;if(typeof e.value=="string")return e.value;if(typeof e.file=="string")return e.file;if(e.file&&typeof e.file.path=="string")return e.file.path;if(e.file?.file&&typeof e.file.file.path=="string")return e.file.file.path;if(typeof e.data=="string")return e.data}}},"value_to_path");var Nfe=Object.getPrototypeOf(async function(){}).constructor;var uE=require("obsidian");var JN=r((n,e)=>{let t=e.getActiveFile();return t&&n.smart_sources?.get(t.path)||null},"get_active_entity"),_E=r(n=>{try{if(!n?.state?.doc)return!1;let e=n.state.doc,t=e.line(e.lines),s=t.from,i=t.to;return(Array.isArray(n.visibleRanges)?n.visibleRanges:[]).some(o=>o.from<=i&&o.to>=s)}catch(e){return console.warn("[Smart Connections] last-line visibility check failed",e),!1}},"is_last_line_visible"),Pd=class{static{r(this,"ConnectionsFooterView")}constructor(e){this.plugin=e,this.app=e.app,this.register_env_listeners(),this.container_map={},this._detach_visibility_guard=null}get env(){return this.plugin.env}attach_visibility_guard(e){if(this.detach_visibility_guard(),!e)return;let t=e.scrollDOM||e.dom||null;if(!t)return;let s=!1,i=r(()=>{s||(s=!0,requestAnimationFrame(()=>{s=!1,_E(e)&&(this.detach_visibility_guard(),this.render_view())}))},"check_and_render"),o=r(()=>i(),"on_scroll"),a=r(()=>i(),"on_resize");t.addEventListener("scroll",o,{passive:!0}),window.addEventListener("resize",a),this._detach_visibility_guard=()=>{try{t.removeEventListener("scroll",o)}catch{}try{window.removeEventListener("resize",a)}catch{}this._detach_visibility_guard=null}}detach_visibility_guard(){typeof this._detach_visibility_guard=="function"&&this._detach_visibility_guard()}async render_view(){if(!this.env.connections_lists?.settings?.footer_connections)return this.remove();let e=this.plugin.get_editor_view();if(!e)return;if(!_E(e)){try{e.dispatch({effects:[As.of(null)]})}catch(i){console.warn("[Smart Connections] footer hide dispatch failed",i)}this.attach_visibility_guard(e);return}this.detach_visibility_guard();let t=JN(this.env,this.app.workspace);if(!t){e.dispatch({effects:[As.of(null)]});return}if(this.container_map[t.key]?.isConnected){e.dispatch({effects:[As.of(this.container_map[t.key])]});return}let s=await this.env.render_component("connections_footer_view",this,{connections_item:t});if(this.container_map[t.key]&&this.container_map[t.key]instanceof HTMLElement&&this.container_map[t.key].remove(),this.container_map[t.key]=s,e.dispatch({effects:[As.of(s)]}),uE.Platform.isMobile){let i=this.container_map[t.key],o=i.querySelector(".status-bar-mobile")??i.createDiv({cls:"status-bar-mobile"});o.empty();let a=o.createDiv({cls:"status-bar-item"});this.env.smart_components.render_component("status_bar",this.env).then(c=>a.appendChild(c))}}remove(){let e=this.plugin.get_editor_view();if(this.detach_visibility_guard(),e)try{e.dispatch({effects:[As.of(null)]})}catch(t){console.warn("[Smart Connections] footer remove dispatch failed",t)}}register_env_listeners(){let e;this.register_env_listener("sources:opened",(t={})=>{e&&clearTimeout(e),e=setTimeout(()=>{this.render_view()},250)}),this.register_env_listener("settings:changed",t=>{t.path?.includes("connections_lists")&&this.render_view()})}register_env_listener(e,t){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on(e,t))}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}unload(){this.detach_visibility_guard(),this.env_listeners&&(this.env_listeners.forEach(e=>e()),this.env_listeners=[])}};var mE=require("obsidian");var Id=class{static{r(this,"ConnectionsCodeblock")}constructor(e){this.plugin=e,this.app=e.app,this.plugin.env.create_env_getter(this),this.register_env_listeners()}async render(e,t,s){t.empty(),t.createEl("span",{text:"Loading\u2026"});let i=this.env.smart_sources.get(s.sourcePath)??this.env.smart_sources.init_file_path(s.sourcePath);if(!i){t.empty(),t.createEl("p",{text:"Entity not found: "+s.sourcePath});return}let o=e,a=JSON.parse(e.trim()||"{}"),c=await this.env.smart_components.render_component("connections_codeblock",this,{connections_item:i,connections_settings:a});t.empty(),t.appendChild(c),o!==e&&KN(s,o)}register_env_listeners(){this.register_env_listener("settings:changed",e=>{e.path?.includes("connections_lists")&&this.render()})}register_env_listener(e,t){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on(e,t))}open_settings(){new Sh(this.app,this.env,this.connections_settings).open()}};function KN(n,e){if(typeof n.replaceCode=="function")return n.replaceCode(e.trim()+`
`)}r(KN,"update_codeblock");var Sh=class extends mE.Modal{static{r(this,"ConnectionsCodeblockModal")}constructor(e,t,s={}){super(e),this.env=t,this.connections_settings=s}async onOpen(){this.titleEl.setText("Connections Codeblock"),this.contentEl.empty(),console.log("Opening ConnectionsCodeblockModal with codeblock_ctx:",this.connections_settings);let e=await this.env.smart_view.render_settings(this.env.connections_lists.settings_config,{scope:{settings:this.connections_settings}});this.contentEl.appendChild(e)}};function YN(n){return n?String(n).trim().replace(/^v/i,""):""}r(YN,"normalize_version");function pE(n){let e=YN(n);if(!e)return{core:[],prerelease:""};let[t,s=""]=e.split("-",2);return{core:t.split(".").map(o=>{let a=Number.parseInt(o,10);return Number.isNaN(a)?0:a}),prerelease:s}}r(pE,"split_version");function XN(n,e){let t=pE(n),s=pE(e);if(!(s.core.length>0||s.prerelease.length>0))return 0;if(!(t.core.length>0||t.prerelease.length>0))return 1;let a=Math.max(t.core.length,s.core.length);for(let d=0;d<a;d+=1){let _=t.core[d]??0,u=s.core[d]??0;if(u>_)return 1;if(u<_)return-1}let c=t.prerelease.length>0,l=s.prerelease.length>0;return c&&!l?1:!c&&l?-1:!c&&!l||s.prerelease===t.prerelease?0:s.prerelease>t.prerelease?1:-1}r(XN,"compare_versions");function hE(n,e){return XN(n,e)>0}r(hE,"should_notify_update");var ae=require("obsidian");var gr="smart_tasks",fE="Smart Tasks",gE="Returns number of tasks using Smart Environment.",yE=r(n=>{if(!n.app.internalPlugins.plugins?.bases?.enabled)return;let t=r(a=>{try{let l=globalThis.smart_env||{};if(l.state!=="loaded")return new ae.StringValue("Smart Env not ready.");let d=l.smart_sources;if(!d)return new ae.StringValue("Smart Sources not ready.");let _=ZN(a);if(!_)return new ae.StringValue("Missing item.");let{metadata_cache:u}=n.app,p=n.app.vault.getAbstractFileByPath(_)??u.getFirstLinkpathDest(_,"");if(!p)return new ae.StringValue(`File not found: ${_}`);let f=d.get(p.path);if(!f)return new ae.StringValue(`No Smart Source for: ${_}`);let y=f.data?.tasks?.incomplete?.top||[],g=Object.entries(f.data?.blocks||{}).filter(([b,C])=>!!b.includes("next")),w=y.filter(b=>g.some(([C,k])=>b>=k[0]&&b<=k[1])),x={all:f.data?.task_lines?.length||0,incomplete:f.data?.tasks?.incomplete?.all?.length||0,incomplete_top:y?.length||0,next:w?.length||0};return new ae.ObjectValue(x)}catch(l){return console.error("Error in smart_tasks:",l),new ae.StringValue("Error retrieving tasks count, see console for details.")}},"tasks_count");n.registerGlobalFunc({name:gr,params:[{name:"file",type:[ae.Value,ae.FileValue,ae.StringValue]}],docString:gE,ctx:null,applyWithContext(a,...c){return t(...c)}}),n.registerInstanceFunc(ae.FileValue,{name:gr,params:[{name:"self",type:[ae.Value,ae.FileValue]}],docString:gE,ctx:null,applyWithContext(a,...c){return t(...c)}});let s=n.app.workspace,i=s.operatorFuncConfigs?.bases||[];i.some(a=>a?.funcName===gr)||s.registerOperatorFuncConfigs("bases",[...i,{funcName:gr,display:fE,inverseDisplay:"Inverse "+fE}]),n.register(()=>{s?.unregisterOperatorFuncConfigs?.("bases",[gr])})},"register_bases_tasks_integration"),ZN=r(n=>{if(n){if(typeof n=="string")return n;if(typeof n=="object"){let e=n;if(typeof e.path=="string")return e.path;if(typeof e.value=="string")return e.value;if(typeof e.file=="string")return e.file;if(e.file&&typeof e.file.path=="string")return e.file.path;if(e.file?.file&&typeof e.file.file.path=="string")return e.file.file.path;if(typeof e.data=="string")return e.data}}},"value_to_path");var Qn=require("obsidian");function bE(n="",e,t=""){if(!e)return n??"";let s=t||e.split("/").pop().replace(/\.md$/i,""),i=e==="this.file.file"?"this.file.file":`"${e}"`,o=`  ${s}: score_connection(file.file, ${i})`,a=`  formula.${s}: ${s}`,c=`      - formula.${s}`,l=(n??"").split(/\r?\n/),d=l.findIndex(_=>/^formulas:\s*$/i.test(_));if(d===-1?l.unshift("formulas:",o):l.some(_=>_.trimStart()===o.trimStart())||(d=Ch(l,d,/^\s{2}\S/),l.splice(d+1,0,o)),d=l.findIndex(_=>/^display:\s*$/i.test(_)),d===-1){let _=l.findIndex(p=>/^formulas:\s*$/i.test(p)),u=Ch(l,_,/^\s{2}\S/)+1;l.splice(u,0,"display:",a)}else l.some(_=>_.trimStart()===a.trimStart())||(d=Ch(l,d,/^\s{2}\S/),l.splice(d+1,0,a));if(d=l.findIndex(_=>/^views:\s*$/i.test(_)),d===-1)l.push("views:","  - type: table","    name: Table","    order:","      - file.name",c);else{let _=-1;for(let u=d+1;u<l.length;u++)if(/^\s*-\s+type:\s+table/i.test(l[u])){if(_=l.findIndex((p,f)=>f>u&&/^\s*order:\s*$/i.test(p)),_===-1){let p=l.findIndex((y,g)=>g>u&&/^\s*name:\s+/i.test(y)),f=p!==-1?p+1:u+1;l.splice(f,0,"    order:","      - file.name",c)}break}_!==-1&&!l.some(u=>u.trimStart()===c.trimStart())&&l.splice(_+1,0,c)}return l.filter(_=>_.trim()).join(`
`).trim()}r(bE,"insert_score_connection_column");var Ch=r((n,e,t)=>{let s=e+1;for(;s<n.length&&t.test(n[s]);)s++;return s-1},"find_block_end"),qh=r(n=>!!n&&n.extension==="base","is_base_file");var Oh=class extends Qn.FuzzySuggestModal{static{r(this,"ConnectionsScoreColumnModal")}constructor(e){super(e),this.items=["Current/active file (dynamic)",...Object.keys(window.smart_env?.smart_sources?.items||{})],this.setPlaceholder("Select note for similarity\u2026")}getItems(){return this.items}getItemText(e){return e}onChooseItem(e){this.#e(e)}async#e(e){let t=this.app.workspace.getActiveFile();if(!qh(t)){new Qn.Notice("No active .base file");return}let s;e==="Current/active file (dynamic)"&&(e="this.file.file",s="score");let i=await this.app.vault.read(t),o=bE(i,e,s);if(i===o){new Qn.Notice("Connections score column already present");return}await this.app.vault.modify(t,o),this.#t(),new Qn.Notice(`Added score_connection column for ${e}`)}#t(){this.app.workspace.getLeavesOfType("bases").forEach(e=>e.isVisible()&&e.rebuildView())}};function vE(n){n.addCommand({id:"sc-add-connections-score-column",name:"Add: Connections score bases column",checkCallback:r(e=>{let t=qh(n.app.workspace.getActiveFile());return e?t:t?(new Oh(n.app).open(),!0):!1},"checkCallback")})}r(vE,"register_connections_score_command");function Md(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Md,"collection_instance_name_from");function zs(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(kE(e[t])&&kE(n[t])?zs(n[t],e[t]):n[t]=e[t]);return n}r(zs,"deep_merge");function kE(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(kE,"is_plain_object");function wE(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(wE,"create_uid");function xE(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(xE,"camel_case_to_snake_case");function Ld(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Ld(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Ld(n[o],e[o],t))}return n===e}r(Ld,"deep_equal");function $h(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r($h,"get_item_display_name");function zd(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let v of Reflect.ownKeys(m)){let j=Object.getOwnPropertyDescriptor(m,v);if(!j)continue;let E={...j};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let v=!1;for(let j of h){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E){let $=E.value;if(c($)){v=!0;continue}if(s($)){if(_($)){v=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),v=new Map;for(let j of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E&&_(E.value)){v.set(j,d(E.value));continue}try{Object.defineProperty(h,j,u(E))}catch{h[j]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),w=Object.create(null),x=r((m,h,v=[])=>{if(!m||!h)return;let j=new Set([...l,...v]);for(let E of Reflect.ownKeys(m)){if(j.has(E))continue;let $=Object.getOwnPropertyDescriptor(m,E);if($)try{Object.defineProperty(h,E,$)}catch{h[E]=$.value}}},"copy_metadata"),b=r(m=>{let h=new m(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let j=v.bind(h);return x(m,j),x(h,j),j.instance=h,j}return x(m,h),h},"instantiate_class"),C=r(m=>{if(o(m))return b(m);if(a(m)){let h=m.action.bind(n);return x(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return x(m,h),h}return s(m)?d(m):m},"bind_or_clone"),k=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&s(h)?h:null},"scope_actions_for"),A=r((m,h,v)=>(m[h]=v,v),"cache_result"),q=r((m,h)=>{let v=k();return v&&g(v,h)?A(m,h,C(v[h])):g(f,h)?A(m,h,C(f[h])):A(m,h,void 0)},"compute_and_cache"),O=r(()=>{let m=k(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(m)for(let v of Reflect.ownKeys(m))h.add(v);return Array.from(h)},"union_keys"),S=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(w,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:q(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let v=k();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return S(m,h);let v=k();if(v&&g(v,h)||g(f,h))return g(m,h)||q(m,h),S(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,v)=>"value"in v?(m[h]=v.value,!0):!1,"defineProperty"),set:r((m,h,v)=>(m[h]=v,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(zd,"create_actions_proxy");var Xt=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&zs(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return wE(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return zs(s,t),!Ld(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=zd(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Md(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Md(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),xE(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return $h(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var QN=Object.getPrototypeOf(async function(){}).constructor,St=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof QN?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return zs(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=zd(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var Rd=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=yr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},yr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Dd=class extends Rd{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=br;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},br=class extends yr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var EE={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},vr=class extends Dd{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=ei;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},ei=class extends br{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+u]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(u);if(d.key||(d.key=u),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return EE[s]&&(s=EE[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function jh(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():AE(a)?n[o]=jh(AE(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(jh,"ajson_merge");function AE(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(AE,"is_object");var SE={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function eP(n){let e=!1,[t,...s]=n.split(":");return SE[t]&&(t=SE[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(eP,"_parse_ajson_key");var kr=class extends vr{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:y,item_key:g,changed:w}=eP(p),x=`${y}:${g}`;f?(i[x]=f,(w||x!==p)&&(delete i[p],t=!0)):(delete i[x],(w||x!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=jh(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Th=class extends ei{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},wr={collection:kr,item:Th};function tP(n){if(n==null)return"";let e;if(Array.isArray(n))e=n.map(t=>t==null?"":String(t)).join(", ");else if(typeof n=="object")try{e=JSON.stringify(n)}catch{e=String(n)}else e=String(n);return e.startsWith("formula.")&&(e=e.replace("formula.","")),e.startsWith("note.")&&(e=e.replace("note.","")),e.startsWith("file.")&&(e=e.replace("file.","")),e.replace(/\|/g,"\\|").replace(/\r?\n/g,"<br>")}r(tP,"stringify_cell");function sP(n){if(!Array.isArray(n)||n.length===0)return[];let e=n.map(s=>Array.isArray(s)?s:[s]),t=e.reduce((s,i)=>Math.max(s,i.length),0);return e.map(s=>Array.from({length:t},(i,o)=>tP(s[o])))}r(sP,"normalize_table");function nP(n){if(n.length===0)return[];let e=n[0].length,t=Array.from({length:e},()=>0);return n.forEach(s=>{for(let i=0;i<e;i++){let o=(s[i]??"").length;o>t[i]&&(t[i]=o)}}),t.map(s=>Math.max(s,3))}r(nP,"compute_col_widths");function iP(n,e){let t=n??"";return t.length>=e?t:t+" ".repeat(e-t.length)}r(iP,"pad_cell");function Nh(n,e){return`| ${n.map((s,i)=>iP(s,e[i])).join(" | ")} |`}r(Nh,"build_row");function oP(n){let e=sP(n);if(e.length===0)return"";let t=nP(e),s=Nh(e[0],t),i=t.map(c=>"-".repeat(c)),o=Nh(i,t),a=e.slice(1).map(c=>Nh(c,t));return[s,o,...a].join(`
`)}r(oP,"to_markdown_table");function rP(n,e){return e.split(".").reduce((t,s)=>{if(t!=null)return["formula"].includes(s)?t.formulaResults.cachedFormulaOutputs:["note"].includes(s)&&t.note?.data?t.note.data:["size","mtime","ctime"].includes(s)?t.stat[s]:["links"].includes(s)?(smart_env.smart_sources.get(n.file.path)?.outlinks||[]).map(o=>`[[${o.key}]]`).join(", "):["name"].includes(s)?`[[${t.name}]]`:t[s]},n)}r(rP,"get_value_from_path");function aP(n){return n?.linkText?.includes(".base")??!1}r(aP,"is_bases_child");async function cP(n){await new Promise(t=>setTimeout(t,300));let e=n?._children?.[0]?.view;return e?.data?e:null}r(cP,"get_base_file_view");function CE(n){if(!n?.propertiesCache||!Array.isArray(n.data))return[];let e=n.propertiesCache,t=e.map(a=>a),s=n.groupedDataCache||[],i=s[s.length-1];if(!i?.entries)return[t];let o=i.entries.map(a=>e.map(c=>{let l=rP(a,c);return Array.isArray(l?.data)&&typeof l.data?.[0]?.data=="string"?l.data.map(d=>d.sourcePath?`[[${d.data}]]`:d.data).join(", "):l?.data??(typeof l!="object"?l:"")??""}));return[t,...o]}r(CE,"get_bases_output");var xr=class extends Xt{static{r(this,"BasesCache")}get collection(){return this.env.bases_caches}get markdown_table(){let e=this.data?.bases_output;return oP(e)}},Ph=class extends St{static{r(this,"BasesCaches")}static version=1;#e=null;#t=new Map;#o="";#n=new WeakSet;#i=null;#s=200;#r=3e4;#a=3e4;init(){let e=app.workspace,t=r(()=>this.start_watchers(),"handler");this.env.plugin.registerEvent(e.on("active-leaf-change",t)),typeof this.env.plugin.register=="function"&&this.env.plugin.register(()=>this.stop_watchers()),this.start_watchers()}start_watchers(){this.stop_watchers();let e=app.workspace.getActiveFileView();if(!e)return console.warn("No file view");let t=e.file?this.env.smart_sources?.get(e.file.path):null;this.#o=t?.key||e.file?.path||"",this.#n=new WeakSet;let s=e?.editor?.editorComponent;if(s){let i=r(()=>{let o=s._children||[],a=new Set;o.forEach(c=>{aP(c)&&(a.add(c),!this.#n.has(c)&&(this.#n.add(c),this.watch_base_child(c)))}),this.sweep_orphan_watchers(a)},"scan_children");i(),this.#e=this.set_interval(i,this.#s)}cP(e).then(i=>{i?(this.#i=i,this.watch_base_file(i)):(this.#i=null,console.warn("No bases view"))})}set_interval(e,t){return setInterval(e,t)}clear_interval(e){clearInterval(e)}sweep_orphan_watchers(e){let t=new Set(e);this.#i&&t.add(this.#i),this.#t.forEach((s,i)=>{let o=t.has(i),a=!0;try{let c=i?.containerEl||i?._children?.[0]?.viewContainerEl||i?.viewContainerEl||null;c&&typeof c.isConnected=="boolean"&&(a=c.isConnected)}catch{a=!1}(!o||!a)&&(this.clear_interval(s.id),this.#t.delete(i))})}watch_base_child(e){let t=e.linkText,s=Date.now(),i=this.set_interval(()=>{let o=e?.containerEl||e?._children?.[0]?.viewContainerEl||null;if(o&&o.isConnected===!1){this.clear_interval(i),this.#t.delete(e);return}if(Date.now()-s>this.#r){this.clear_interval(i),this.#t.delete(e);return}let a=e?._children?.[0]?.view?.data;if(!a)return;let c=CE(a);if(c.length){this.clear_interval(i),this.#t.delete(e);let l=new xr(this.env,{key:`${this.#o}#${t}`,bases_output:c});this.set(l),l.queue_save(),this.process_save_queue()}},this.#s);this.#t.set(e,{id:i,started:s})}watch_base_file(e){let t=Date.now(),s=this.set_interval(()=>{let i=e?.containerEl||e?.viewContainerEl||null;if(i&&i.isConnected===!1){this.clear_interval(s),this.#t.delete(e);return}if(Date.now()-t>this.#a){this.clear_interval(s),this.#t.delete(e);return}let o=e?.data;if(!o)return;let a=CE(o);if(a.length){this.clear_interval(s),this.#t.delete(e);let c=new xr(this.env,{key:this.#o,bases_output:a});this.set(c),c.queue_save(),this.process_save_queue()}},this.#s);this.#t.set(e,{id:s,started:t})}stop_watchers(){this.#e&&(this.clear_interval(this.#e),this.#e=null),this.#t.forEach(e=>this.clear_interval(e.id)),this.#t.clear(),this.#i=null}},qE={class:Ph,collection_key:"bases_caches",data_adapter:kr,item_type:xr};var Rs=class extends Xt{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var ti=class extends St{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function Fd(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(Fd,"settings_config");var Ds=class extends Rs{static{r(this,"ChatCompletionModel")}async complete(e){return this.instance.complete(e)}async stream(e,t={}){return this.instance.stream(e,t)}async test_model(){try{let e=await this.complete({messages:[{role:"user",content:"2+2="}]}),t=!e.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Bd=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#e(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#r.bind(this)),this.xhr.addEventListener("error",this.#t.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#e(this.CLOSED))}#e(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#t(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#t(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#e(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#r(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#e(this.CLOSED)}};var Ud=class extends Ut{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};function Mh(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(Mh):e==="object"?Object.values(n).every(Mh):!1}r(Mh,"is_json_compatible");function Wd(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||Mh(i)&&(t[s]=i);return t}r(Wd,"extract_json_details");function Er(n){return Object.keys(n).length===0}r(Er,"is_empty_object");function lP(n,e){return Er(n)?e:Er(e)?n:{...n,...e}}r(lP,"merge_details");function Ih(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(Ih,"get_message_from_object");function _e(n,e=null){if(Array.isArray(n)&&n.length>0)return _e(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Wd(n,["message"]);return{message:t,details:Er(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=Ih(o),c=Wd(o,["message"]),l=Wd(t,["message","error"]),d=lP(l,c);return{message:a||Ih(t)||"Unknown error",details:Er(d)?null:d,http_status:e}}return _e(i)}let s=Ih(t);if(s){let i=Wd(t,["message"]);return{message:s,details:Er(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(_e,"normalize_error");var si={},Zt={data:null,fetched_at:0},V=class extends Ud{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return K}get res_adapter(){return W}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Be({adapter:kt})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Zt.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=_e(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new Bd(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=_e({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=_e(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=_e(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Zt?.data&&t-Zt?.fetched_at<e)return Zt.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Zt.data=o,Zt.fetched_at=t,console.log({MODELS_DEV_CACHE:Zt}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Zt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return si[this.constructor.key]||(si[this.constructor.key]={}),si[this.constructor.key]}set model_data(e){si[this.constructor.key]||(si[this.constructor.key]={}),si[this.constructor.key]=e}},K=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},W=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:_e(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Gd=class extends V{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Lh}get res_adapter(){return zh}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Lh=class extends K{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},zh=class extends W{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Rh=class extends Gd{static{r(this,"OpenRouterChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},dP={api_key:{name:"API Key",type:"password",description:"Enter your API key for the chat model provider."}},Hd={class:Rh,settings_config:dP};var Dh=class extends ti{static{r(this,"ChatCompletionModels")}model_type="Chat";get default_provider_key(){return"open_router"}};var _P={class:Dh,data_dir:"chat_completion_models",collection_key:"chat_completion_models",data_adapter:wr,item_type:Ds,providers:{open_router:Hd},settings_config:Fd},OE=_P;var $E=OE;var Fs=class extends Rs{static{r(this,"RankingModel")}static get defaults(){return{data:{api_key:"",provider_key:"cohere",model_key:"rerank-v3.5"}}}async rank(e,t,s={}){return this.instance.rank(e,t,s)}async test_model(){try{let e=await this.rank("alphabetical order",["z","y","x","a","b","c"]),t=!!(!e.error&&Array.isArray(e)&&e.length);return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Fh=class extends jn{static{r(this,"CohereRankingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get_models(){return this.models}},uP={api_key:{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},jE={class:Fh,settings_config:uP};var Bh=class extends ti{static{r(this,"RankingModels")}model_type="Ranking";get default_provider_key(){return"cohere"}},mP={class:Bh,data_dir:"ranking_models",collection_key:"ranking_models",data_adapter:wr,item_type:Fs,providers:{cohere:jE},settings_config:Fd},TE=mP;var NE=TE;var Vd=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}};function Jd(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Jd,"cos_sim");function ME(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=PE(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=PE(n.results);n.min=s,n.minResult=i}}r(ME,"results_acc");function LE(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=IE(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=IE(n.results);n.max=s,n.maxResult=i}}r(LE,"furthest_acc");function PE(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(PE,"find_min");function IE(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(IE,"find_max");function ni(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(ni,"sort_by_score");function zE(n,e){return ni(n,e)}r(zE,"sort_by_score_descending");function RE(n,e){return ni(n,e)*-1}r(RE,"sort_by_score_ascending");var Kd=class extends Vd{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Jd(e,a.vec)};return ME(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(zE)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Jd(e,a.vec)};return LE(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(RE)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}};function pP(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=ii(l,o),l=Uh(l,15),l=ii(l,a),i^=l,i=Uh(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=ii(l,o),l=Uh(l,15),l=ii(l,a),i^=l;break}return i^=n.length,i=hP(i),i|0}r(pP,"murmur_hash_32");function DE(n,e=0){return(pP(n,e)>>>0).toString(36)}r(DE,"murmur_hash_32_alphanumeric");function ii(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(ii,"multiply_32");function Uh(n,e){return n<<e|n>>>32-e}r(Uh,"rotate_left_32");function hP(n){return n^=n>>>16,n=ii(n,2246822507),n^=n>>>13,n=ii(n,3266489909),n^=n>>>16,n|0}r(hP,"fmix_32");var fP="---frontmatter---",FE=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),gP=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),yP=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),bP=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(fP),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),vP=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=FE(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=FE(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),kP=r((n,e={})=>{let t=gP(n,e),s=yP(t),i=bP(s);return vP(i,n)},"create_find_connections_filter_opts");async function Wh(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=kP(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+DE(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(ni).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(Wh,"find_connections");Wh.action_type="connections";var Ar=class extends St{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Kd(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(ni).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return Yd}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return wP}},Yd={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},wP={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};var Sr=class extends Ar{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var EP=r(n=>{let e={embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...Yd};return n.settings.embed_blocks===!1&&e.min_chars&&(e.min_chars.disabled=!0),e},"settings_config"),BE={class:Sr,collection_key:"smart_blocks",settings_config:EP};var Zd=require("obsidian");function Ve(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(Ve,"escape_html");function UE(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=oi(l,o),l=Gh(l,15),l=oi(l,a),i^=l,i=Gh(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=oi(l,o),l=Gh(l,15),l=oi(l,a),i^=l;break}return i^=n.length,i=AP(i),i|0}r(UE,"murmur_hash_32");function ce(n,e=0){return(UE(n,e)>>>0).toString(36)}r(ce,"murmur_hash_32_alphanumeric");function oi(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(oi,"multiply_32");function Gh(n,e){return n<<e|n>>>32-e}r(Gh,"rotate_left_32");function AP(n){return n^=n>>>16,n=oi(n,2246822507),n^=n>>>13,n=oi(n,3266489909),n^=n>>>16,n|0}r(AP,"fmix_32");function ke(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(ke,"camel_case_to_snake_case");function Hh(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(Hh,"convert_to_time_ago");function lt(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(WE(e[t])&&WE(n[t])?lt(n[t],e[t]):n[t]=e[t]);return n}r(lt,"deep_merge");function WE(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(WE,"is_plain_object");function Bs(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Bs,"cos_sim");function Te(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(Te,"get_by_path");function Ne(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(Ne,"set_by_path");function Vh(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(Vh,"delete_by_path");function Jh(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(Jh,"compute_centroid");function Kh(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);s[a]+=u,s[l]+=u}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(Kh,"compute_medoid");var Xd=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new Zd.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function ai(n,e,t,s={}){let{default_group_name:i="Settings"}=s;n=HE(n,e);let o=Object.entries(n||{}).reduce((c,[l,d])=>{let _=d.group||i;return c[_]||(c[_]={}),c[_][l]=d,c},{[i]:{}});return Object.entries(o).sort(([c],[l])=>c===i?-1:l===i?1:0).filter(([,c])=>Object.keys(c).length>0).map(([c,l])=>{let d=t.createDiv(),_={...s,...s.group_params?.[c]||{}};return SP(c,e,l,d,_)})}r(ai,"render_settings_config");function SP(n,e,t,s,i={}){let o;try{let l=require("obsidian");l.SettingGroup?o=l.SettingGroup:o=Xd}catch{o=Xd}t=HE(t,e);let{heading_btn:a=null}=i,c=new o(s);if(a&&typeof a=="object")if(Array.isArray(a))for(let l of a)GE(c,e,l);else GE(c,e,a);c.setHeading(n);for(let[l,d]of Object.entries(t)){if(!d||typeof d!="object"){console.warn(`Invalid setting config for ${l}:`,d);continue}c.addSetting(_=>{switch(d.name&&_.setName(d.name),_.setClass(l.replace(/[^a-zA-Z0-9]/g,"-")),d.type&&_.setClass(`setting-type-${d.type}`),d.description&&_.setDesc(d.description),d.type){case"button":_.addButton(u=>{u.setButtonText(d.name||"Run"),u.onClick(async p=>{typeof d.callback=="function"&&await ri(_,p,d.callback,{scope:e})})});break;case"toggle":_.addToggle(u=>{u.setValue(Te(e.settings,l)||!1),u.onChange(p=>{Ne(e.settings,l,p),typeof d.callback=="function"&&ri(_,p,d.callback,{scope:e})})});break;case"text":_.addText(u=>{u.setValue(String(Te(e.settings,l)||"")),u.onChange(p=>{Ne(e.settings,l,p)})});break;case"number":_.addText(u=>{u.setValue(String(Te(e.settings,l)||"")),u.inputEl.setAttribute("type","number"),u.onChange(p=>{let f=Number(p);isNaN(f)||Ne(e.settings,l,f),typeof d.callback=="function"&&ri(_,f,d.callback,{scope:e})})});break;case"dropdown":_.addDropdown(u=>{let p=d.options_callback;typeof p=="function"&&p.call(e,e).forEach(y=>{let g=y.label||y.name||y.value;u.addOption(y.value,g)}),u.setValue(Te(e.settings,l)||""),u.onChange(f=>{Ne(e.settings,l,f),typeof d.callback=="function"&&ri(_,f,d.callback,{scope:e})})});break;case"textarea":_.addTextArea(u=>{u.setValue(String(Te(e.settings,l)||"")),u.onChange(p=>{Ne(e.settings,l,p)})});break;case"slider":_.addSlider(u=>{let p=d.min||0,f=d.max||100,y=d.step||1;u.setLimits(p,f,y),u.setValue(Te(e.settings,l)||p),u.setDynamicTooltip(),u.onChange(g=>{Ne(e.settings,l,g),typeof d.callback=="function"&&ri(_,g,d.callback,{scope:e})})});break;case"heading":_.setHeading();break;case"html":d.value&&_.descEl.replaceChildren(document.createRange().createContextualFragment(d.value));break;default:console.warn(`Unsupported setting type for ${l}:`,d.type);break}d.scope_class&&_.settingEl.addClass(d.scope_class)})}return c}r(SP,"render_settings_group");function GE(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,Zd.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await ri(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(GE,"render_heading_button");async function ri(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(ri,"handle_config_callback");function HE(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(HE,"ensure_settings_config");var VE=require("obsidian");function Qt(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(Qt,"ensure_smart_sources_settings");function es(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(es,"parse_exclusions_csv");function Qd(n,e){let t=(e??"").trim();if(!t)return n||"";let s=es(n);return s.includes(t)||s.push(t),s.join(",")}r(Qd,"add_exclusion");function e_(n,e){let t=(e??"").trim();return t?es(n).filter(i=>i!==t).join(","):n?.trim()||""}r(e_,"remove_exclusion");var t_=class extends VE.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Qt(this.env),t=es(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Qt(this.env);t.folder_exclusions=Qd(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Qt(this.env),t=es(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=e_(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var JE=require("obsidian");var s_=class extends JE.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function CP(n,e={}){return`
<div class="sources-settings">
</div>
`}r(CP,"build_html");async function KE(n,e={}){let t=await CP.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return qP.call(this,n,i,e),i}r(KE,"render");async function qP(n,e,t={}){ai({folder_exclusions:Xh,view_exclusions:Zh,re_import_sources:Qh},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",Yh(n,e))),this.attach_disposer(e,i),e}r(qP,"post_process");function Yh(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(Yh,"highlight_reset_data");var Xh={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new t_(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},Zh={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new s_(t.main.app,t).open()},"callback")},Qh={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"})},"callback")};var YE=require("obsidian");var ci=class extends YE.FuzzySuggestModal{static{r(this,"ExcludedFilesFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a file to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Qt(this.env),t=es(e.file_exclusions);return(this.env.smart_sources?.fs?.file_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Qt(this.env);t.file_exclusions=Qd(t.file_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Qt(this.env),t=es(e.file_exclusions),s=this.modalEl.querySelector(".sc-excluded-files-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-files-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded files"),!t.length){s.createEl("p").setText("No files excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-file-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-file-btn"}).addEventListener("click",()=>{e.file_exclusions=e_(e.file_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};async function OP(n,e={}){return`
<div class="sources-pro-settings">
</div>
`}r(OP,"build_html");async function XE(n,e={}){let t=await OP.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return $P.call(this,n,i,e),i}r(XE,"render");async function $P(n,e,t={}){ai({folder_exclusions:Xh,file_exclusions:jP,view_exclusions:Zh,re_import_wait_time:{type:"number",name:"Re-import wait time",description:"Time in seconds to wait before re-importing a file after modification.",scope_class:"pro-setting"},"smart_blocks.embed_blocks":{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Embedding allows more granular results in semantic lookups.",scope_class:"pro-setting"},"smart_sources.min_chars":{name:"Minimum length to embed (Sources)",type:"number",description:"Minimum number of characters a source must have to be embedded.",scope_class:"pro-setting"},"smart_blocks.min_chars":{name:"Minimum length to embed (Blocks)",type:"number",description:"Minimum number of characters a block must have to be embedded.",scope_class:"pro-setting"},re_import_sources:Qh},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",Yh(n,e))),this.attach_disposer(e,i),e}r($P,"post_process");var jP={type:"button",name:"Manage excluded files",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",scope_class:"pro-setting",callback:r(async function(n,e){let t=this,s=new ci(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")};async function TP(n,e={}){return`
<div class="setting-component pro-setting">
<div class="setting-item">
<div class="info setting-item-info">
<div class="setting-item-name">Excluded files</div>
<div class="setting-item-description">Manage files to exclude from the environment.</div>
</div>
<div class="control setting-item-control">
<button class="sc-add-excluded-file-btn" type="button">Edit excluded files</button>
</div>
</div>
</div>
`}r(TP,"build_html");async function ZE(n,e={}){let t=await TP.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return NP.call(this,n,i,e),i}r(ZE,"render");async function NP(n,e,t={}){let s=e.querySelector(".sc-add-excluded-file-btn");return s&&s.addEventListener("click",()=>{new ci(n.main.app,n).open(()=>{n.update_exclusions()})}),e}r(NP,"post_process");var QE={collections:{bases_caches:qE,chat_completion_models:$E,ranking_models:NE,smart_blocks:BE},item_types:{ChatCompletionModel:Ds,RankingModel:Fs},items:{chat_completion_model:{class:Ds},ranking_model:{class:Fs}},modules:{},components:{settings_env_sources:{render:XE},settings_sources_file_exclusions:{render:ZE}},actions:{}};var jt=require("obsidian");var n_=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var i_=class extends n_{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Us=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new i_(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};async function PP(n,e={}){let t=Object.entries(n.settings_config).map(([o,a])=>(a.setting||(a.setting=o),this.render_setting_html(a))).join(`
`),s=Object.entries(n.collections).map(([o,a])=>`<div data-smart-settings="${o}"></div>`).join(`
`);return`
<div class="">
${t}
${s}
</div>
`}r(PP,"build_html");async function e1(n,e={}){let t=await PP.call(this,n,e),s=this.create_doc_fragment(t);return await IP.call(this,n,s,e)}r(e1,"render");async function IP(n,e,t={}){await this.render_setting_components(e,{scope:n});let s=e.querySelectorAll("[data-smart-settings]");for(let i of s){let o=i.dataset.smartSettings;await n[o].render_settings(i)}return e}r(IP,"post_process");var o_=class{static{r(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let s=new this(e,t);return await s.load(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}static create_sync(e,t={}){let s=new this(e,t);return s.load_sync(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}get settings(){return MP(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",LP(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function MP(n,e){let t=new WeakMap,s=new WeakMap,i=r((a,c)=>{if(!tf(a)||s.has(a))return a;if(t.has(a))return t.get(a);let l=o(a,c);return t.set(a,l),s.set(l,a),l},"wrap_value"),o=r((a,c)=>new Proxy(a,{set(l,d,_){let u=[...c,d],p=ef(l[d]),f=ef(_);return l[d]=i(_,u),zP(p,f)&&e({type:"set",path:u,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],u=ef(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:u}),!0}}),"create_proxy");return i(n,[])}r(MP,"observe_object");function LP(n){let e=Array.isArray(n.path)?n.path:[];return{type:n.type,path:e,path_string:e.join("."),value:n.value,previous_value:n.previous_value}}r(LP,"build_settings_changed_event");function ef(n){if(!tf(n))return n;if(typeof structuredClone=="function")try{return structuredClone(n)}catch{}try{return JSON.parse(JSON.stringify(n))}catch{return n}}r(ef,"snapshot_value");function zP(n,e){return t1(n)!==t1(e)}r(zP,"has_changed");function t1(n){if(n===void 0)return"undefined";if(Number.isNaN(n))return"number:NaN";if(n===1/0)return"number:Infinity";if(n===-1/0)return"number:-Infinity";if(!tf(n))return`${typeof n}:${String(n)}`;try{return`object:${JSON.stringify(n)}`}catch{return`object:${String(n)}`}}r(t1,"serialize_value");function tf(n){return typeof n=="object"&&n!==null}r(tf,"is_observable");function s1(n){return n.collections||(n.collections={}),n.modules||(n.modules={}),n.items||(n.items={}),Object.entries(n.collections).forEach(([e,t])=>{typeof t=="function"&&(n.collections[e]={class:t});let s=ke(e);s!==e&&(n.collections[s]=n.collections[e],delete n.collections[e]),n.collections[s].collection_key||(n.collections[s].collection_key=s),t.item_type&&(n.items[t.item_type.key||ke(t.item_type.name)]={class:t.item_type})}),Object.entries(n.modules).forEach(([e,t])=>{typeof t=="function"&&(n.modules[e]={class:t});let s=ke(e);s!==e&&(n.modules[s]=n.modules[e],delete n.modules[e])}),n.item_types||(n.item_types={}),n.items||(n.items={}),Object.entries(n.item_types).forEach(([e,t])=>{if(typeof t=="function"){let s=ke(e);n.items[s]={class:t,actions:{},...n.items[s]||{}}}}),n}r(s1,"normalize_opts");function RP(n){if(!n||typeof n!="object")return!1;let e=Object.getPrototypeOf(n);return e===Object.prototype||e===null}r(RP,"is_plain_object");function r_(n){if(Array.isArray(n))return n.map(e=>r_(e));if(RP(n)){let e={};for(let[t,s]of Object.entries(n))e[t]=r_(s);return e}return n}r(r_,"deep_clone_config");function li(n,e){let t=n1(n),s=n1(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(li,"compare_versions");function n1(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(n1,"normalize_version_value");function Cr(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Cr,"is_plain_object");function Ct(n,e,t=[]){if(!Cr(n)||!Cr(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Cr(i)?(Cr(n[s])||(n[s]={}),Ct(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(Ct,"deep_merge_no_overwrite");function qt(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(li(d,_)>0){let p={...c};Ct(p,l),n.collections[a]=p}else Ct(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;li(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):Ct(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),Ct(n[i],o)):n[i]=o}return n}r(qt,"merge_env_config");function i1(n={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:s}=n;return(e!==void 0||t!==void 0||s!==void 0)&&(n.smart_sources=n.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!n.smart_sources?.file_exclusions?.length||n.smart_sources?.file_exclusions==="Untitled")&&(n.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!n.smart_sources.folder_exclusions?.length&&(n.smart_sources.folder_exclusions=t),s!==void 0&&s.length&&!n.smart_sources.excluded_headings?.length&&(n.smart_sources.excluded_headings=s)),delete n.file_exclusions,delete n.folder_exclusions,delete n.excluded_headings,n}r(i1,"migrate_exclusion_settings_2025_08_22");var DP=typeof globalThis<"u"?globalThis:Function("return this")(),qr=class{static{r(this,"SmartEnv")}static version="2.2.4";scope_name="smart_env";static global_ref=DP;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=Us.create(this,BP(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([s])=>this.primary_main_key&&s===this.primary_main_key?-1:0);for(let[s,i]of t){if(!i?.main){console.warn(`SmartEnv: '${s}' unloaded, skipping`),delete this.smart_env_configs[s];continue}if(!i?.opts){console.warn(`SmartEnv: '${s}' opts missing, skipping`);continue}qt(this._config,r_(s1(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:s}=t||{};if(s)for(let[i,o]of Object.entries(s.collections||{})){let a=o?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:li(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,FP(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let s=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(s),t(this.global_env))},1e3)}else{let s=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(s),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let s={};this.global_env&&li(this.version,this.global_env.constructor?.version||0)>0&&(s.primary_main_key=ke(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(s);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let s=ke(e.constructor.name);this.smart_env_configs[s]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:r(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await o_.create(this),this.config.default_settings&&Ct(this.settings,this.config.default_settings),i1(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:s}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let s=e.collections[t]?.class;s&&(s.default_settings&&Ct(this.settings,{[t]:s.default_settings}),typeof s.init=="function"&&(await s.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((s,i)=>{let o=this.config.collections?.[s]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return o-a});for(let s of t){let i=Date.now();typeof this[s]?.process_load_queue=="function"&&(await this[s].process_load_queue(),this[s].load_time_ms=Date.now()-i,this.collections[s]="loaded",console.log(`Loaded ${this[s].collection_key} in ${this[s].load_time_ms}ms`))}}static unload_main(e){let t=ke(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let s=this.opts.modules[e];return s?(t={...s,class:null,...t},new s.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||e1}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,s={}){let i=this.get_component(e,t);return i?await i(t,s):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let s=t.collection_key??t.scope_name,i=s?`${s}-${e}`:e;if(!this._components[i])try{if(this.opts.components[s]?.[e]){let o=this.opts.components[s][e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let o=this.opts.components[e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${s}`)}catch(o){console.error("Error getting component",o),console.log(`scope_name: ${s}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[s]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.opts.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(s=>s.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let s=e.map(i=>{let o=i.split("/").slice(-2,-1)[0];return{dir:o,count:this.fs.file_paths.filter(a=>a.includes(o)).length}});t=s.reduce((i,o)=>o.count>i.count?o:i,s[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(lt(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(s=>s.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((s,i,o)=>o.indexOf(s)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function FP(n){return{items:Object.fromEntries(Object.entries(n.items||{}).map(([e,t])=>[e,t.data]))}}r(FP,"collection_to_plain");function BP(n){if(!n)return{};if(typeof n=="function")return{adapter_class:n};let e=n.adapter_class||n.adapter;return e?{adapter_class:e}:{}}r(BP,"build_events_opts");function UP(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=GP(n,t),o=WP(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(UP,"create_regex");function WP(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(WP,"adjust_for_windows_paths");function GP(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(GP,"glob_to_regex_pattern");function o1(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:UP(n,s)}r(o1,"glob_to_regex");function r1(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(r1,"fuzzy_search");var a_=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(o1(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return r1(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var HP=Y(require("obsidian"),1);var c_=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=HP,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function l_(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(l_,"empty");var a1=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var c1=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var VP=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,d_=r((n,e)=>{let t=e.trim();(VP.test(t)?c1:a1)(n,t)},"safe_inner_html");var __=new WeakMap,u_=new WeakMap,m_=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return Te(e,t,s)}set_by_path(e,t,s,i=null){Ne(e,t,s,i)}delete_by_path(e,t,s=null){Vh(e,t,s)}escape_html(e){return Ve(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||u_.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");u_.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=u_.get(i);c&&(i.removeEventListener("change",c),u_.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=ce(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){l_(e)}safe_inner_html(e,t){d_(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=__.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},__.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}__.get(e)===c&&__.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var p_=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===s,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let w=document.createElement("div");w.className="array-item-row";let x=document.createElement("input");x.type="text",x.value=y,x.placeholder="Value";let b=document.createElement("button");b.textContent="\u2715",b.title="Remove",x.addEventListener("change",()=>{c[g]=x.value,f()}),b.addEventListener("click",()=>{c.splice(g,1),d(),f()}),w.appendChild(x),w.appendChild(b),l.appendChild(w)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=u.value.trim();y&&(c.push(y),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,w],x)=>{let b=document.createElement("div");b.className="json-pair-row";let C=document.createElement("input");C.type="text",C.value=g,C.placeholder="Property";let k=document.createElement("input");k.type="text",k.value=w,k.placeholder="Value";let A=document.createElement("button");A.textContent="\u2715",A.title="Remove",C.addEventListener("change",()=>{let q=C.value.trim();q&&q!==g&&(c[q]=c[g],delete c[g],d(),y())}),k.addEventListener("change",()=>{c[C.value]=k.value,y()}),A.addEventListener("click",()=>{delete c[C.value],d(),y()}),b.appendChild(C),b.appendChild(k),b.appendChild(A),l.appendChild(b)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),y())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){l_(e)}safe_inner_html(e,t){d_(e,t)}};var dt=require("obsidian");var h_=class extends p_{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return dt.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new dt.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await dt.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,dt.getIcon)(e).outerHTML}is_mod_event(e){return dt.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function f_(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(f_,"collection_instance_name_from");function l1(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(l1,"create_uid");function g_(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>g_(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>g_(n[o],e[o],t))}return n===e}r(g_,"deep_equal");function y_(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(y_,"get_item_display_name");function b_(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let v of Reflect.ownKeys(m)){let j=Object.getOwnPropertyDescriptor(m,v);if(!j)continue;let E={...j};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let v=!1;for(let j of h){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E){let $=E.value;if(c($)){v=!0;continue}if(s($)){if(_($)){v=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),v=new Map;for(let j of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,j);if(E){if("value"in E&&_(E.value)){v.set(j,d(E.value));continue}try{Object.defineProperty(h,j,u(E))}catch{h[j]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),w=Object.create(null),x=r((m,h,v=[])=>{if(!m||!h)return;let j=new Set([...l,...v]);for(let E of Reflect.ownKeys(m)){if(j.has(E))continue;let $=Object.getOwnPropertyDescriptor(m,E);if($)try{Object.defineProperty(h,E,$)}catch{h[E]=$.value}}},"copy_metadata"),b=r(m=>{let h=new m(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let j=v.bind(h);return x(m,j),x(h,j),j.instance=h,j}return x(m,h),h},"instantiate_class"),C=r(m=>{if(o(m))return b(m);if(a(m)){let h=m.action.bind(n);return x(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return x(m,h),h}return s(m)?d(m):m},"bind_or_clone"),k=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&s(h)?h:null},"scope_actions_for"),A=r((m,h,v)=>(m[h]=v,v),"cache_result"),q=r((m,h)=>{let v=k();return v&&g(v,h)?A(m,h,C(v[h])):g(f,h)?A(m,h,C(f[h])):A(m,h,void 0)},"compute_and_cache"),O=r(()=>{let m=k(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(m)for(let v of Reflect.ownKeys(m))h.add(v);return Array.from(h)},"union_keys"),S=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(w,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:q(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let v=k();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return S(m,h);let v=k();if(v&&g(v,h)||g(f,h))return g(m,h)||q(m,h),S(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,v)=>"value"in v?(m[h]=v.value,!0):!1,"defineProperty"),set:r((m,h,v)=>(m[h]=v,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(b_,"create_actions_proxy");var le=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&lt(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return l1(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return lt(s,t),!g_(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=b_(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),f_(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),f_(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),ke(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return y_(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var JP=Object.getPrototypeOf(async function(){}).constructor,de=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof JP?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return lt(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=b_(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var v_=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},k_=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function w_(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=d1(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=d1(n.results);n.min=s,n.minResult=i}}r(w_,"results_acc");function u1(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=_1(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=_1(n.results);n.max=s,n.maxResult=i}}r(u1,"furthest_acc");function d1(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(d1,"find_min");function _1(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(_1,"find_max");function Je(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Je,"sort_by_score");function x_(n,e){return Je(n,e)}r(x_,"sort_by_score_descending");function m1(n,e){return Je(n,e)*-1}r(m1,"sort_by_score_ascending");var E_=class extends v_{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Bs(e,a.vec)};return w_(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(x_)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Bs(e,a.vec)};return u1(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(m1)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},A_=class extends k_{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var KP="---frontmatter---",p1=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),YP=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),XP=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),ZP=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(KP),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),QP=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=p1(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=p1(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),sf=r((n,e={})=>{let t=YP(n,e),s=XP(t),i=ZP(s);return QP(i,n)},"create_find_connections_filter_opts");async function di(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=sf(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+ce(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Je).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(di,"find_connections");di.action_type="connections";var Ws=class extends le{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new A_(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Gs=class extends de{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new E_(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(Je).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return h1}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return eI}},h1={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},eI={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function nf(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await di.call(this,n);let o=sf(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+ce(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Je).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Je).slice(0,s)}return i}r(nf,"find_connections");nf.action_type="connections";var _i=class extends Ws{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=Jh(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=Kh(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},f1={class:_i,actions:{find_connections:nf}};var Or=class extends Gs{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Je)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(tI),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},tI={};var S_=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=$r;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},$r=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var C_=class extends S_{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=jr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},jr=class extends $r{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var g1={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},ss=class extends C_{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=Ot;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},Ot=class extends jr{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+u]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(u);if(d.key||(d.key=u),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return g1[s]&&(s=g1[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Tr=class extends ss{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=of},of=class extends Ot{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var q_=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return ce(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return y1(this.constructor.name)}static get adapter_key(){return y1(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function y1(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(y1,"to_snake");function O_(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},y=null,g=null,w=!1,x=!1,b="#",C=!1,k=[],A=null;_[b]=0;for(let O=0;O<i.length;O++){let S=O+t,m=i[O],h=m.trim();if(h==="---"){if(!x&&S===1){x=!0,w=!0,l["#---frontmatter---"]=[S,null];continue}else if(w){w=!1,l["#---frontmatter---"][1]=S;continue}}if(w)continue;if(!C&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(S),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(S)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(S)),h.startsWith("```")){if(C=!C,C&&!A?A=S:!C&&A&&(k.push([A,S]),A=null),!g){let E=c.length>0?c[c.length-1].key:b;if(E===b&&!l[b]&&(l[b]=[S,null]),E===b)g={key:b,start_line:S},(l[b][1]===null||l[b][1]<S)&&(l[b][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let $=_[E],N=`${E}#{${$}}`;l[N]=[S,null],g={key:N,start_line:S}}}continue}let v=h.match(/^(#{1,6})\s*(.+)$/);if(v&&!C){let E=v[1].length,$=v[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=S-1)}c.length===0&&l[b]&&l[b][1]===null&&(l[b][1]=S-1),g&&(l[g.key][1]===null&&(l[g.key][1]=S-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null);let N="",M=0;if(c.length>0?(N=c[c.length-1].key,M=c[c.length-1].level):(N="",M=0),c.length===0)d[$]=(d[$]||0)+1,d[$]>1&&($+=`[${d[$]}]`);else{u[N]||(u[N]={}),u[N][$]=(u[N][$]||0)+1;let X=u[N][$];X>1&&($+=`#{${X}}`)}let ue=E-M,ge="#".repeat(ue),ye=N+ge+$;l[ye]=[S,null],_[ye]=0,c.push({level:E,title:$,key:ye});continue}let j=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(j&&!C){if(j[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null),g&&g.key!==b&&(l[g.key][1]===null&&(l[g.key][1]=S-1),g=null);let $=c.length>0?c[c.length-1].key:b;$===b&&!l[b]&&(l[b]=[S,null]),_[$]===void 0&&(_[$]=0),_[$]+=1;let N=_[$],M;if(s){let ue=j[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=sI(ue,o);M=`${$}#${ge}`}else M=`${$}#{${N}}`;l[M]=[S,null],y={key:M,start_line:S};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=S-1),y=null);let E=c.length>0?c[c.length-1].key:b;if(E===b)l[b]||(l[b]=[S,null]),(l[b][1]===null||l[b][1]<S)&&(l[b][1]=null),g={key:b,start_line:S};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let $=_[E],N=`${E}#{${$}}`;l[N]=[S,null],g={key:N,start_line:S}}}}let q=i.length;for(;c.length>0;){let O=c.pop();l[O.key][1]===null&&(l[O.key][1]=q+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=q+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=q+t-1),g=null),l[b]&&l[b][1]===null&&(l[b][1]=q+t-1);for(let O in l)a[O]=l[O];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:k}}r(O_,"parse_markdown_blocks");function sI(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(sI,"get_longest_words_in_order");var ns=class extends q_{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=O_(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);s==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:u,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let w=this.item.block_collection.get(u);if(await this.create_hash(p)!==w.last_read?.hash){o.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function $_(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,u=o(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r($_,"get_markdown_links");function rf(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(rf,"parse_value");function nI(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=rf(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(rf(u)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=rf(c)}return t}r(nI,"parse_yaml_block");function b1(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=nI(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(b1,"parse_frontmatter");var v1=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Nr=class extends ns{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!!e)return $_(e)}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=b1(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),v1(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var is=require("obsidian");function iI(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(iI,"merge_tags");var Hs=class extends Nr{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=iI(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!is.MarkdownRenderer||!is.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await is.MarkdownRenderer.render(s,t,i,this.item.path,new is.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,is.htmlToMarkdown)(i)}};var j_=class extends ns{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var T_=class extends ns{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){}};var N_=class extends Hs{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function k1(n,e){let[t,...s]=n.split("#").filter(Boolean),i=y_(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(k1,"get_block_display_name");var ui=class extends Ws{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return k1(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},w1={class:ui,actions:{find_connections:di}};var Pr=class extends Gs{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var P_=class extends ss{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=af;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},af=class extends Ot{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var I_=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return ce(e)}};function M_(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(M_,"get_line_range");var mi=class extends I_{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return M_(e,t,s)}async _reparse_source(){await this.item.source.import()}};var pi=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Ir=class extends pi{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var hi=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Vs=class extends hi{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var _t=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var fi=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},gi=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var yi=class extends fi{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new cf(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},cf=class extends gi{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Js=class extends fi{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new lf(i)}},lf=class extends gi{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var S1=Y(A1(),1);var uI=Object.defineProperty,mI=r((n,e,t)=>e in n?uI(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),pI=r((n,e,t)=>(mI(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function hI(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(hI,"bytePairMerge");function fI(n,e){return n.length===1?[e.get(n.join(","))]:hI(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(fI,"bytePairEncode");function gI(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(gI,"escapeRegex");var _f=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=S1.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=_f.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=_f.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??n.length;for(let f of n.substring(l,u).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...fI(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},z_=_f;pI(z_,"specialTokenRegex",n=>new RegExp(n.map(e=>gI(e)).join("|"),"g"));async function q1(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await C1(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await C1(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(q1,"fetch_json_cached");async function C1(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(C1,"do_fetch");function mf(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(mf):e==="object"?Object.values(n).every(mf):!1}r(mf,"is_json_compatible");function R_(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||mf(i)&&(t[s]=i);return t}r(R_,"extract_json_details");function Mr(n){return Object.keys(n).length===0}r(Mr,"is_empty_object");function yI(n,e){return Mr(n)?e:Mr(e)?n:{...n,...e}}r(yI,"merge_details");function uf(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(uf,"get_message_from_object");function ee(n,e=null){if(Array.isArray(n)&&n.length>0)return ee(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=R_(n,["message"]);return{message:t,details:Mr(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=uf(o),c=R_(o,["message"]),l=R_(t,["message","error"]),d=yI(l,c);return{message:a||uf(t)||"Unknown error",details:Mr(d)?null:d,http_status:e}}return ee(i)}let s=uf(t);if(s){let i=R_(t,["message"]);return{message:s,details:Mr(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(ee,"normalize_error");var bI="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",mt=class extends Vs{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Ke}get res_adapter(){return Ye}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new _t({adapter:Js})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:ee(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await q1(bI,"cl100k_base.json");this.tiktoken=new z_(e)}},Ke=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Ye=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var D_=class extends mt{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return pf}get res_adapter(){return hf}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},pf=class extends Ke{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},hf=class extends Ye{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var F_=class extends Vs{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var B_=class extends F_{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var O1=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var $1={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:ff};var ff={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},j1={},gf={};var bi=class extends B_{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=$1;constructor(e){super(e),this.connector=O1.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...j1}}get_models(){return Promise.resolve(this.models)}get models(){return ff}};var U_=class extends mt{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{},model_key:"nomic-embed-text"};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return yf}get res_adapter(){return bf}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of kI(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},yf=class extends Ke{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},bf=class extends Ye{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},vI=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),kI=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(vI)},"filter_embedding_models");var W_=class extends mt{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return vf}get res_adapter(){return kf}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"models/gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}},vf=class extends Ke{static{r(this,"SmartEmbedGeminiRequestAdapter")}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},kf=class extends Ye{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:500})}};function wI(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(wI,"parse_lm_studio_models");var G_=class extends mt{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return wf}get res_adapter(){return xf}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return wI(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},wf=class extends Ke{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},xf=class extends Ye{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Lr=class extends pi{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw ee(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var H_=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#e(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#r.bind(this)),this.xhr.addEventListener("error",this.#t.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#e(this.CLOSED))}#e(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#t(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#t(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#e(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#r(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#e(this.CLOSED)}};var V_=class extends hi{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var vi={},os={data:null,fetched_at:0},G=class extends V_{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return H}get res_adapter(){return R}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new _t({adapter:Js})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=os.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=ee(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new H_(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=ee({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=ee(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=ee(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(os?.data&&t-os?.fetched_at<e)return os.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return os.data=o,os.fetched_at=t,console.log({MODELS_DEV_CACHE:os}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),os.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return vi[this.constructor.key]||(vi[this.constructor.key]={}),vi[this.constructor.key]}set model_data(e){vi[this.constructor.key]||(vi[this.constructor.key]={}),vi[this.constructor.key]=e}},H=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},R=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var zr=class extends G{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Rr}res_adapter=Dr;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Rr=class extends H{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Dr=class extends R{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var xI=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Ys=class extends G{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Ef;parse_model_data(e){return e.data.filter(t=>!xI.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:EI(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function EI(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(EI,"get_max_input_tokens");var Ef=class extends R{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Fr=class extends Ys{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var ki=class extends G{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Br;res_adapter=Ur;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Br=class extends H{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Ur=class extends R{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:ee(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},Wr=class extends ki{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var Gr=class extends G{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Af}get res_adapter(){return Sf}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Af=class extends H{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Sf=class extends R{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Hr=class extends G{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Vr}get res_adapter(){return Jr}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Vr=class extends H{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},Jr=class extends R{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var Kr=class extends G{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=Yr;res_adapter=Xr;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},Yr=class extends H{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},Xr=class extends R{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Cf={openai:{req:H,res:R},anthropic:{req:Rr,res:Dr},gemini:{req:Br,res:Ur},lm_studio:{req:Vr,res:Jr},ollama:{req:Yr,res:Xr}},Zr=class extends G{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Cf[e];return t&&t.req?t.req:H}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Cf[e];return t&&t.res?t.res:R}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(Cf).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var Qr=class extends G{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return qf}get res_adapter(){return Of}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},qf=class extends H{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Of=class extends R{static{r(this,"SmartChatModelGroqResponseAdapter")}};var ea=class extends G{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return H}get res_adapter(){return R}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var ta=class extends G{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return $f}get res_adapter(){return jf}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},$f=class extends H{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},jf=class extends R{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var Jf=require("obsidian");function T1(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=O_(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),u=M_(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=$_(u),f={key:d,lines:l,size:u.length,outlinks:p,last_read:{at:a,hash:ce(u)}};if(!_||_?.data.last_read?.hash!==f.last_read.hash){let y=new n.block_collection.item_type(n.env,f);n.block_collection.set(y)}else _.data={..._.data,...f}}AI(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(T1,"parse_blocks");function AI(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(AI,"clean_and_update_source_blocks");function Tf(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():N1(a)?n[o]=Tf(N1(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(Tf,"ajson_merge");function N1(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(N1,"is_object");var P1={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function SI(n){let e=!1,[t,...s]=n.split(":");return P1[t]&&(t=P1[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(SI,"_parse_ajson_key");var rs=class extends ss{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:y,item_key:g,changed:w}=SI(p),x=`${y}:${g}`;f?(i[x]=f,(w||x!==p)&&(delete i[p],t=!0)):(delete i[x],(w||x!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=Tf(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Nf=class extends Ot{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},sa={collection:rs,item:Nf};var na=class extends le{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function CI(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(CI,"parse_component_properties");async function qI(n,e){let{scope_key:t,component_key:s}=CI(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await ce(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(qI,"build_component_data");var J_=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await qI(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var K_=class extends J_{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function I1(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&I1(i,o,t)}}),t}r(I1,"flatten_components_config");var Y_=class extends de{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=I1(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},M1={class:Y_,item_type:na,data_adapter:sa,component_adapters:{SmartViewComponentAdapter:K_}};var L1=M1;function z1(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(z1,"filter_redundant_context_items");var ia=class extends le{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e){!e||!this.data?.context_items?.[e]||(this.data.context_items[e].folder?this.data.context_items[e].exclude=!0:delete this.data.context_items[e],this.queue_save(),this.emit_event("context:updated",{removed_key:e}))}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,s):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this.on_event("context:updated",()=>{this._context_items=null})}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return z1(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var X_=class extends de{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var OI={class:X_,data_adapter:rs,item_type:ia};var R1=OI;var Z_=class extends le{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var pt=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var Q_=class extends pt{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var eu=class extends pt{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var D1=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var tu=class extends pt{static{r(this,"ImageContextItemAdapter")}static detect(e){return D1.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var su=class extends pt{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var Pf=class extends de{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},F1={version:1,class:Pf,collection_key:"context_items",item_type:Z_,context_item_adapters:{BlockContextItemAdapter:Q_,SourceContextItemAdapter:eu,ImageContextItemAdapter:tu,PdfContextItemAdapter:su}};function B1(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(B1,"next_log_stats");var wi=class extends le{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var $I={"collection:save_started":!0,"collection:save_completed":!0},If=class extends de{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return wi}init(){this.env?.events||Us.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!$I[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new wi(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=B1({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},U1={class:If,collection_key:"event_logs",data_adapter:rs,item_type:wi};var Xs=require("obsidian");var nu=class extends Xs.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available"}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&this.selectActiveSuggestion(t);let s=this.inputEl.selectionStart===this.inputEl.value.length;if(t.target!==this.inputEl||!this.inputEl.value||s||Xs.Keymap.isModEvent(t)){if(t.key==="ArrowLeft"){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&(s||t.target!==this.inputEl||!this.inputEl.value)){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return this.default_suggest_action_keys.map(e=>{let t=this.env.config.actions[e];if(!t)return null;let s=t.display_name||e;return{select_action:r(()=>{this.update_suggestions(e)},"select_action"),key:e,display:s}}).filter(Boolean)}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e))}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,Xs.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=Xs.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let l=this.inputEl.value.length;this.inputEl.setSelectionRange(l,l)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):c&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var Rqe=require("obsidian");var iu=class extends nu{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var W1=require("obsidian");var ou=class extends W1.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var G1=require("obsidian");var ru=class extends G1.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Milestones"),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var H1={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var oa=class extends le{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var au=class extends de{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function V1(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(V1,"settings_config");var Zs=class extends oa{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Mf=class extends au{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var jI={class:Mf,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:sa,item_type:Zs,providers:{},settings_config:V1},Lf=jI;var zf=class extends bi{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"intfloat/multilingual-e5-small":{id:"intfloat/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},J1={class:zf,settings_config:gf};Lf.providers={transformers:J1};var K1=Lf;var as=class extends le{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(w_(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(x_);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var Y1={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},Rf=class extends de{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=TI(new Date),i=ce(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new as(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...Y1}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function TI(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(TI,"format_ymd");var X1={class:Rf,collection_key:"lookup_lists",item_type:as,settings_config:Y1};function ra(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(ra,"format_collection_name");async function NI(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${ra(n.collection_key)}</h2>
${t}
</div></div></div>`}r(NI,"build_html");async function Z1(n,e={}){let t=await NI.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(Z1,"render");var xi=require("obsidian");function Q1(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(xi.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new xi.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");xi.MarkdownRenderer.render(o,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(Q1,"register_block_hover_popover");var eA=require("obsidian");function tA(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),eA.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):Q1(n.parentElement,n,e.env,e.key)}r(tA,"register_item_hover_popover");var nA=require("obsidian");function PI(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(PI,"format_score");function II(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(II,"format_size");function sA(n,e){return n?`<span class="${e}">${n}</span>`:""}r(sA,"build_badge_html");function MI(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=PI(n?.data?.score),i=II(n?.size||n?.data?.size),o=sA(s,"sc-context-item-score"),a=sA(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(MI,"build_html");async function iA(n,e={}){let t=MI(n,e),i=this.create_doc_fragment(t).firstElementChild;return LI.call(this,n,i,e),i}r(iA,"render");async function LI(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${nA.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),tA(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(LI,"post_process");async function zI(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${ra(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=DI(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(zI,"build_html");async function oA(n,e={}){let t=await zI.call(this,n,e),s=this.create_doc_fragment(t);return await RI.call(this,n,s,e)}r(oA,"render");async function RI(n,e,t={}){return e}r(RI,"post_process");function DI(n,e){let t=Object.values(n.items).length,s=ra(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=FI(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=BI(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(DI,"generate_collection_stats");function FI(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(FI,"get_generic_collection_stats");function BI(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(BI,"calculate_embed_coverage");var rA=require("obsidian");function UI(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(UI,"build_html");async function Df(n,e={}){let t=UI.call(this,n,e),s=this.create_doc_fragment(t);return await WI.call(this,n,s,e)}r(Df,"render");async function WI(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new rA.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Te(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),o.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):Ne(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(WI,"post_process");Df.version=.2;var aA=require("obsidian");function GI(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(GI,"build_html");function cA(n,e={}){let t=GI.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,aA.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),HI.call(this,n,i,e),i}r(cA,"render");function HI(n,e){}r(HI,"post_process");var lA=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
`;var hA=require("obsidian");var dA=require("obsidian");function _A(n){n.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in aa){let s=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",o=document.createElement("p");o.textContent=i,s.appendChild(o);let a=document.createElement("p");a.textContent=`\u2705 ${aa[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",s.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{n.open_milestones_modal()}),s.appendChild(c),new dA.Notice(s,7e3)}})}r(_A,"register_first_of_event_notifications");var aa={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Inline connections",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Inline connections",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Inline connections",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},JI=["Environment","Connections","Lookup","Context","Chat","Pro","Inline connections"];function uA(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=JI.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(uA,"derive_events_checklist_groups");function Ff(n,e){return!!n.event_logs.items[e]}r(Ff,"check_if_event_emitted");function KI(n,e={}){let t=uA(aa),s=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(Ff(n,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(Ff(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=Ff(n,u.event_key)===!0;return XI(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Ve(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Ve(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Ve(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(KI,"build_html");async function fA(n,e={}){this.apply_style_sheet(lA);let t=KI.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return YI.call(this,n,i,e),i}r(fA,"render");async function YI(n,e,t={}){return ZI(e),QI(e),e}r(YI,"post_process");function XI(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Ve(n.event_key)}"
data-link="${Ve(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${Ve(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Ve(n.milestone)}</span>
</div>
</li>
`}r(XI,"build_item_html");function ZI(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=pA(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||mA(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=pA(n,e);s&&(e.preventDefault(),mA(s))}))}r(ZI,"attach_item_link_listeners");function mA(n){let e=s4(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(mA,"open_item_link");function QI(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&e4(i,s)})}r(QI,"render_item_state_icons");function e4(n,e){t4(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(e4,"set_item_icon");function t4(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,hA.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(t4,"set_icon_with_fallback");function pA(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(pA,"get_item_el_from_event");function s4(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=aa[t];return!s||typeof s.link!="string"?"":s.link}r(s4,"get_item_link");function n4(){return`<div>
<button class="copy-all-notifications-btn">Copy All Notifications</button>
<div class="smart-env-notifications-feed"></div>
</div>`}r(n4,"build_html");async function gA(n,e={}){let t=this.create_doc_fragment(n4()),s=t.firstElementChild;return i4.call(this,n,s,e),t}r(gA,"render");async function i4(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed");this.empty(s);let i=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!i.length){let a=s.ownerDocument.createElement("p");a.className="smart-env-notifications-empty",a.textContent="No Smart Env notifications yet.",s.appendChild(a);return}i.slice(-100).reverse().forEach(a=>{r4(s,a)});let o=e.querySelector(".copy-all-notifications-btn");o.addEventListener("click",()=>{let a=s.textContent;navigator.clipboard.writeText(a).then(()=>{o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy All Notifications"},2e3)})})}r(i4,"post_process");function o4(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(o4,"get_level");function r4(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=o4(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${a4(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(r4,"append_entry");function a4(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(a4,"to_time_ago");var $t=require("obsidian");var ca=require("obsidian");function la(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(la,"get_smart_server_url");function c4(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(c4,"try_get_zlib");function l4(n){let e=c4();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(l4,"inflate_deflate_data");async function da(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let w=new Uint8Array(n.slice(t,t+y)),x=new TextDecoder("utf-8").decode(w);t+=y,t+=g;let b=(l&8)!==0,C=t,k;if(!b)k=C+p;else{let O=C,S=!1;for(;O+4<=s;){let m=e.getUint32(O,!0);if(m===134695760||m===67324752||m===33639248){S=!0;break}O++}k=S?O:s}if(k>s)break;let A=new Uint8Array(n.slice(C,k));if(t=k,b&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let q;if(d===0)q=A;else if(d===8)q=l4(A);else continue;if(i.push({fileName:x,data:q}),x.toLowerCase().endsWith("manifest.json")&&!x.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(q))}catch{}}return{files:i,pluginManifest:o}}r(da,"parse_zip_into_files");function cu(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(cu,"validate_zip_buffer");async function _a(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(_a,"write_files_with_adapter");function lu(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(lu,"is_server_version_newer");async function du(n,e){let t=await(0,ca.requestUrl)({url:`${la()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return cu(t.arrayBuffer,"Smart Plugins server")}r(du,"fetch_plugin_zip");async function yA(n,e=ca.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return cu(t.arrayBuffer,"Download")}r(yA,"fetch_zip_from_url");async function bA(n,e,t=ca.requestUrl){let s=await t({url:`${la()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(bA,"fetch_plugin_readme");async function vA(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(vA,"enable_plugin");function _u(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(_u,"get_oauth_storage_prefix");async function uu(n){let e=await(0,ca.requestUrl)({url:`${la()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(uu,"fetch_server_plugin_list");var kA=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var _4='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',u4='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function m4(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(m4,"derive_fallback_plugins");function p4(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${_4}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${u4}</p>
</div>
</div>
`}r(p4,"build_html");async function wA(n,e={}){this.apply_style_sheet(kA);let t=p4.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await h4.call(this,n,i,e),i}r(wA,"render");async function h4(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=_u(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".pro-plugins-list"),l=m4(),d=0,_="",u=null,p=r(k=>{if(!a||!k)return;(!u||!u.isConnected)&&(u=document.createElement("div"),u.classList.add("smart-plugins-login-manual"),a.appendChild(u)),u.innerHTML="";let A=document.createElement("div");A.classList.add("smart-plugins-login-manual-instructions"),A.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",u.appendChild(A);let q=document.createElement("div");q.classList.add("smart-plugins-login-manual-controls"),u.appendChild(q);let O=document.createElement("input");O.classList.add("smart-plugins-login-manual-input"),O.type="text",O.value=k,O.readOnly=!0,O.addEventListener("focus",()=>O.select()),q.appendChild(O);let S=document.createElement("button");S.classList.add("mod-cta"),S.textContent="Copy",S.addEventListener("click",async()=>{await g4(k)?new $t.Notice("Copied login link to clipboard."):new $t.Notice("Copy failed. Please select and copy the link manually.")}),q.appendChild(S)},"render_manual_login_link"),f=r(async()=>{let k={},{manifests:A}=i.plugins;for(;Object.keys(A).length===0;)A=i.plugins.manifests,await new Promise(q=>setTimeout(q,100));for(let q in A){if(!Object.prototype.hasOwnProperty.call(A,q))continue;let{name:O,version:S}=A[q];k[q]={name:O,version:S}}return k},"get_installed_info"),y=r(async()=>{d++,d>=2&&_&&p(_),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(_=f4()),new $t.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),g=r(()=>{if(this.empty(a),u=null,!(localStorage.getItem(o+"token")||"")){new $t.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(O=>{O.setButtonText("Login"),O.onClick(async()=>{await y()})});return}let A=new $t.Setting(a);A.setDesc("Signed in to Smart Plugins Pro account."),A.addButton(q=>{q.setButtonText("Logout"),q.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new $t.Notice("Logged out of Smart Plugins"),g(),b()})})},"render_oauth_login_section"),w=r(async()=>{if(this.empty(c),!(!c||l.length===0))for(let k of l){let A=await n.smart_components.render_component("pro_plugins_list_item",k,{env:n,app:i,installed_map:{}});c.appendChild(A)}},"render_fallback_plugin_list"),x=r(()=>{let k=new $t.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");k.addButton(A=>{A.setButtonText("Get Pro"),A.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),k.addButton(A=>{A.setButtonText("Update subscription"),A.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),k.addButton(A=>{A.setButtonText("Refresh"),A.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),b=r(async()=>{this.empty(c);let k=localStorage.getItem(o+"token")||"";if(!k){await w();return}try{let A=await f(),q=await uu(k),{list:O=[],unauthorized:S=[],sub_exp:m}=q;if(typeof m=="number"&&m<Date.now()){x(),await w();return}if(!Array.isArray(O)||O.length===0){await w();return}for(let h of O){let v=await n.smart_components.render_component("pro_plugins_list_item",h,{env:n,app:i,token:k,installed_map:A,on_installed:b});c.appendChild(v)}}catch(A){console.error("[pro-plugins:list] Failed to fetch plugin list:",A),c.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),C=r(async()=>{g(),await b()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{C()}),await C(),e}r(h4,"post_process");function f4(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${la()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(f4,"initiate_smart_plugins_oauth");var g4=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var fe=require("obsidian");var y4="https://smartconnections.app/pro-plugins/";function b4(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(b4,"build_html");function v4(n){return!n||!n.repo}r(v4,"is_fallback_item");function k4(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,lu(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(k4,"compute_display_state");async function xA(n,e={}){let t=b4(n,e),i=this.create_doc_fragment(t).firstElementChild;return await w4.call(this,n,i,e),i}r(xA,"render");async function w4(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(v4(n)){let u=new fe.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(y4,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=k4(n,l),_=new fe.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>E4(n,{app:s,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),n.docs_url?u.onClick(()=>window.open(n.docs_url,"_external")):u.onClick(()=>A4(n,{app:s,token:i,display_name:d.display_name}))}),e}r(w4,"post_process");var x4=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return yA(t);if(!e)throw new Error("Login required to install this plugin.");return du(n.repo,e)},"download_plugin_zip"),E4=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new fe.Notice(`Installing "${n.repo}" ...`);let o=await x4(n,s),{files:a,pluginManifest:c}=await da(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await _a(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await vA(t,_),new fe.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new fe.Notice(`Install failed: ${o.message}`)}},"install_plugin"),A4=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await bA(n.repo,s),a=new fe.Modal(t);a.setTitle(i||n.name||n.repo),await fe.MarkdownRenderer.render(t,o,a.contentEl,"",new fe.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new fe.Notice("Failed to load README")}},"show_plugin_readme");var EA=require("obsidian");var Qs=class extends EA.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var AA=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}`;var SA=require("obsidian");function C4(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${qA(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(C4,"build_html");async function CA(n,e){this.apply_style_sheet(AA);let s=this.create_doc_fragment(C4.call(this,n,e)).firstElementChild;return q4.call(this,n,s,e),s}r(CA,"render");async function q4(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,SA.setIcon)(o,qA(n)),s.addEventListener("click",()=>{new Qs(n).open()}),i.addEventListener("click",()=>{new Qs(n,{test_on_open:!0}).open()}),e}r(q4,"post_process");function qA(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(qA,"get_test_result_icon_name");var $A=require("obsidian");var OA={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function mu(n,e,t={}){let s=(OA[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new $A.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new Qs(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(mu,"show_new_model_menu");function O4(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(O4,"build_html");async function jA(n,e){let s=this.create_doc_fragment(O4.call(this,n,e)).firstElementChild;return $4.call(this,n,s,e),s}r(jA,"render");async function $4(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=ai(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{mu(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r($4,"post_process");function j4(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(j4,"build_html");async function TA(n,e){let s=this.create_doc_fragment(j4(n,e)).firstElementChild;return T4.call(this,n,s,e),s}r(TA,"render");async function T4(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(T4,"post_process");function N4(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(N4,"build_html");async function NA(n,e={}){let s=this.create_doc_fragment(N4(n,e)).firstElementChild;return P4.call(this,n,s,e),s}r(NA,"render");async function P4(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),mu(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(P4,"post_process");async function I4(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(I4,"build_html");async function PA(n,e={}){let t=await I4.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return M4.call(this,n,i,e),i}r(PA,"render");async function M4(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(M4,"post_process");var IA=`.sc-env-settings-container {\r
margin: 1rem 0;\r
}\r
\r
.smart-env-settings-header {\r
display: flex;\r
align-items: center;\r
justify-content: space-between;\r
margin-bottom: 0.5rem;\r
}\r
\r
.toggle-env-settings-btn {\r
cursor: pointer;\r
}\r
\r
\r
.setting-group .setting-items .setting-item.env-setting-highlight {\r
border: 1px solid var(--interactive-accent);\r
background-color: var(--interactive-hover);\r
padding: 0.5rem;\r
margin: 0.5rem 0;\r
}\r
\r
.settings-group {\r
.setting-item {\r
border-top: none;\r
}\r
}`;async function z4(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(z4,"build_html");async function MA(n,e={}){this.apply_style_sheet(IA);let t=await z4.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return R4.call(this,n,i,e),i}r(MA,"render");async function R4(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return Bf.call(this,"settings_env_sources",n,i),Bf.call(this,"settings_env_models",n,s),Bf.call(this,"settings_notifications",n,o),e}r(R4,"post_process");function Bf(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(Bf,"render_if_available");var LA=require("obsidian");function D4(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(D4,"build_html");async function zA(n,e={}){let t=D4(),i=this.create_doc_fragment(t).firstElementChild;return F4.call(this,n,i,e),i}r(zA,"render");async function F4(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),B4(n,a),U4(n,a),W4(n,a),G4(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(F4,"post_process");function B4(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(B4,"render_btn_open_selector");function U4(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(U4,"render_btn_copy_context");function W4(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(W4,"render_btn_clear_context");function G4(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,LA.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(G4,"render_btn_help");var RA=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var ua=require("obsidian");async function pu(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(ua.Platform.isMobile)new ua.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new ua.Notice("Failed to copy.")}}r(pu,"copy_to_clipboard");function V4(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(V4,"build_html");async function DA(n,e={}){let t=V4(n,e);this.apply_style_sheet(RA);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return J4.call(this,n,i,e),i}r(DA,"render");async function J4(n,e,t={}){let s=[],i=r(async()=>{let l=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(u=>{this.empty(l),l.appendChild(u)});let d=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(u=>{this.empty(d),d.appendChild(u)});let _=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(u=>{this.empty(_),_.appendChild(u)})},"render_children"),o=n.env.plugin,a=o?.app||window.app;return(o?.registerDomEvent?.bind(o)||((l,d,_)=>l.addEventListener(d,_)))(e,"contextmenu",l=>{if(l.preventDefault(),l.stopPropagation(),!a)return;let d=new Menu(a);d.addItem(_=>_.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let u=K4(e);await pu(u)})),d.showAtMouseEvent(l)}),await i(),s.push(n.on_event("context:updated",i)),this.attach_disposer(e,s),e}r(J4,"post_process");function K4(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(K4,"tree_dom_to_wikilinks");function Y4(n){return Math.ceil((n||0)/4)}r(Y4,"estimate_tokens");function X4(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(X4,"build_html");async function FA(n,e={}){let t=X4(),i=this.create_doc_fragment(t).firstElementChild;return Z4.call(this,n,i,e),i}r(FA,"render");async function Z4(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=Y4(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Z4,"post_process");function BA(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-tree-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let u=["sc-tree-label"];return n.exists===!1&&u.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${a?l:""}
<span class="${u.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(BA,"build_tree_item");function UA(n){let e=Q4(n),t=new Set(n.map(i=>i.key||i.path));return WA(e,t)}r(UA,"build_tree_html");function Q4(n=[]){let e=r(o=>{let a=/#\{\d+\}$/u,c=o,l=null,d=null,_=!1,u=c.match(a);u&&(l=u[0],c=c.slice(0,-l.length),_=!0);let p=c.indexOf("##");p!==-1&&(d=c.slice(p),c=c.slice(0,p),_=!0);let f=[];if(c){let y="",g=!1;for(let w=0;w<c.length;w++)!g&&c.slice(w,w+2)==="[["?(g=!0,y+="[[",w++):g&&c.slice(w,w+2)==="]]"?(g=!1,y+="]]",w++):!g&&c[w]==="/"?(f.push(y),y=""):y+=c[w];y&&f.push(y)}return d&&f.push(d),l&&f.push(l),{segments:f,has_block:_}},"split_path_segments"),t={name:"",children:{},selected:!1},s=r((o,a)=>a.some(c=>o.startsWith(`${c}/`)),"is_redundant"),i=n.filter(o=>!(o.key.includes("#")?o.key.split("#")[0]:o.key).match(/\.[a-zA-Z0-9]+$/u)).map(o=>o.key);for(let{key:o,exists:a}of n){if(s(o,i.filter(u=>u!==o)))continue;let{segments:c,has_block:l}=e(o),d=t,_="";c.forEach((u,p)=>{if(_=_?`${_}/${u}`:u,u.startsWith("external:.."))return;let f=p===c.length-1,y=f&&l;d.children[u]||(d.children[u]={name:u,path:y?o:_,children:y?[]:{},selected:!1,is_file:y||f&&u.includes(".")}),d=d.children[u],f&&(d.selected=!0,d.exists=a)})}return t}r(Q4,"build_path_tree");function WA(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>BA(s,e,WA(s,e))).join("")}</ul>`}r(WA,"tree_to_html");var GA=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;function tM(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(tM,"build_html");async function HA(n,e={}){this.apply_style_sheet(GA);let t=tM(n,e),i=this.create_doc_fragment(t).firstElementChild;return sM.call(this,n,i,e),i}r(HA,"render");async function sM(n,e,t={}){let s=r(()=>{let o=n.env,a=n.context_items.filter(t.filter),c=UA(a),l=this.create_doc_fragment(c);this.empty(e),e.appendChild(l);for(let d=0;d<a.length;d++){let _=a[d],u=e.querySelector(`.sc-tree-item[data-path="${_.key}"]`);if(!u){console.warn(`Smart Context: Could not find tree item for path: ${_.key}`);continue}o.smart_components.render_component("context_item_leaf",_).then(p=>{this.empty(u),u.appendChild(p)})}},"render_tree_leaves");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(sM,"post_process");var VA=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function iM(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(iM,"build_html");async function JA(n,e={}){let t=iM(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(VA),await oM.call(this,n,s,e),s}r(JA,"render");async function oM(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let u=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',w=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',x="",b="";try{let k=await p.read();x=k.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),b=(await p.get_embed_input(k)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(k){console.error("[source_inspector] Error reading block:",k),x='<em style="color:red;">Error reading block content</em>'}let C=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${w}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${b}</pre>
</details>
<blockquote>${x}</blockquote>
<hr>
`);s.appendChild(C)}return e}r(oM,"post_process");var QA=require("obsidian");var Ei=require("obsidian");var KA=require("obsidian");var hu=class extends KA.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var YA=require("obsidian");var fu=class extends YA.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function XA(n,e,t={}){let{Menu:s=Ei.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new Ei.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new Ei.Notice("Active note is not indexed by Smart Environment");return}new hu(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new fu(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new Ei.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(XA,"register_status_bar_context_menu");var ZA=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function aM(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(aM,"build_html");async function eS(n,e={}){this.apply_style_sheet(ZA);let s=this.create_doc_fragment(aM()).firstElementChild;return cM.call(this,n,s,e),s}r(eS,"render");function cM(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",w=c(),x=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",x="attention"),s&&(0,QA.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=b=>{b.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),w>0?i.dataset.count=String(w):delete i.dataset.count,x?i.dataset.level=String(x):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=b=>{if(l()>0)b.preventDefault(),b.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let k=new MouseEvent("contextmenu",b);e.dispatchEvent?.(k)}},e.addEventListener("click",e._click_handler))},"render_status_elm");XA(n,e),d();let _=null,u=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",u)),this.attach_disposer(e,p)}r(cM,"post_process");var tS=require("obsidian");function lM(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(lM,"build_html");function sS(n,e={}){let t=lM.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return dM.call(this,n,i,e),i}r(sS,"render");async function dM(n,e){let t=e.querySelector(".callout-icon"),s=(0,tS.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(dM,"post_process");var nS=require("obsidian");function _M(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(_M,"build_html");function iS(n,e={}){let t=_M.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,nS.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),uM.call(this,n,i,e),i}r(iS,"render");function uM(n,e){}r(uM,"post_process");var Uf=require("obsidian");async function oS(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new Uf.Notice("No context items to copy.");let t=await this.get_text(n);await pu(t);let s=mM({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new Uf.Notice(s)}r(oS,"copy_to_clipboard");function mM(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${pM(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=hM(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(mM,"format_stats_message");function pM(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(pM,"format_char_count");function hM(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(hM,"sum_exclusions");async function rS(n,e){let t={KEY:this.key,TIME_AGO:Hh(this.mtime)||"Missing",LINK_DEPTH:this.data.d||0},s=r(async a=>{let c=/{{([\w_]+)}}/g,l=(a.match(c)||[]).length;for(let d=0;d<l;d++)a=a.replace(/{{(\w+)}}/g,(_,u)=>t[u]||"");return a},"replace_vars"),i=await s(this.settings.template_before||gu.template_before),o=await s(this.settings.template_after||gu.template_after);return["",i,n,o,""].join(`
`)}r(rS,"merge_template");var aS={item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
</ul>
`},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content."},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content."}},gu={template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Ai(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=fM(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return yu(e),cS(e).trimEnd()}r(Ai,"build_file_tree_string");function fM(n){return typeof n=="string"&&n.endsWith("/")}r(fM,"is_folder_path");function yu(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,yu(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],yu(n[i])}else yu(t)}}}r(yu,"compress_single_child_dirs");function cS(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=cS(o,e+(c?"    ":"\u2502   ")))}),t}r(cS,"build_tree_string");async function lS(n,e){let t={FILE_TREE:r(()=>Ai(e.map(a=>a.key)),"FILE_TREE")},s=r(async a=>{let c=(a.match(/{{(\w+)}}/g)||[]).length;for(let l=0;l<c;l++)a=a.replace(/{{(\w+)}}/gi,(d,_)=>t[_]?.()||"");return a},"replace_vars"),i=await s(this.settings.template_before||bu.template_before),o=await s(this.settings.template_after||bu.template_after);return[i,n,o].join(`
`)}r(lS,"merge_template");var dS={context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context."},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context."}},bu={template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function ma(n={}){let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:gM(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action")}))}r(ma,"context_suggest_blocks");function gM(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(gM,"get_block_display_name");var _S="Add blocks";function uS(n={}){return Object.values(this.env.smart_sources.items).map(t=>({key:t.key,display:t.key,select_action:r(()=>{this.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",ma.call(this,{source_key:t.key})),"mod_select_action"),arrow_right_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",ma.call(this,{source_key:t.key})),"arrow_right_action")}))}r(uS,"context_suggest_sources");var mS="Add sources";async function vu(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(vu,"pre_process");function Wf(n){return this.vec?n.to_item?.vec?{score:Bs(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(Wf,"similarity");Wf.action_type="score";var Gf="Cosine Similarity",Hf="Ranks by cosine similarity between the current note and candidates.",pS={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${Gf} algorithm`,value:`${Hf}`}};var Vf=require("obsidian");async function hS(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=Vf.Keymap.isModEvent(e),l=Vf.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(hS,"open_source");async function fS(n=null){await hS(this,n)}r(fS,"source_open");var gS={collections:{embedding_models:K1,lookup_lists:X1},item_types:{EmbeddingModel:Zs,LookupList:as},items:{embedding_model:{class:Zs},lookup_list:{class:as}},modules:{},components:{collection_settings:{render:Z1},context_item_leaf:{render:iA},env_stats:{render:oA},form_dropdown:{render:Df},lean_coffee_callout:{render:cA},milestones:{render:fA},notifications_feed:{render:gA},pro_plugins_list:{render:wA},pro_plugins_list_item:{render:xA},settings_env_model:{render:CA},settings_env_model_type:{render:jA},settings_env_models:{render:TA},settings_env_sources:{render:KE},settings_model_actions:{render:NA},settings_notifications:{render:PA},settings_smart_env:{render:MA},smart_context_actions:{render:zA},smart_context_item:{render:DA},smart_context_meta:{render:FA},smart_context_tree:{render:HA},source_inspector:{render:JA},status_bar:{render:eS},supporter_callout:{render:sS},user_agreement_callout:{render:iS}},actions:{context_copy_to_clipboard:{action:oS},context_item_merge_template:{action:rS,settings_config:aS,default_settings:gu},context_merge_template:{action:lS,settings_config:dS,default_settings:bu},context_suggest_blocks:{action:ma,display_name:_S},context_suggest_sources:{action:uS,display_name:mS},lookup_list_pre_process:{action:vu,pre_process:vu},similarity:{action:Wf,settings_config:pS,display_name:Gf,display_description:Hf},source_open:{action:fS}}};var yS={env_path:"",modules:{smart_fs:{class:a_,adapter:c_},smart_view:{class:m_,adapter:h_},smart_embed_model:{class:Ir,adapters:{transformers:bi,openai:D_,ollama:U_,gemini:W_,lm_studio:G_}},smart_chat_model:{class:Lr,adapters:{anthropic:zr,azure:Fr,custom:Zr,google:ki,gemini:Wr,groq:Qr,lm_studio:Hr,ollama:Kr,open_router:Gr,openai:Ys,xai:ea,deepseek:ta},http_adapter:new _t({adapter:yi,obsidian_request_url:Jf.requestUrl})},http_adapter:{class:_t,adapter:yi,obsidian_request_url:Jf.requestUrl}},collections:{context_items:F1,event_logs:U1,smart_components:L1,smart_contexts:R1,smart_sources:{collection_key:"smart_sources",class:Or,data_adapter:Tr,source_adapters:{md:Hs,txt:Hs,"excalidraw.md":N_,base:j_,canvas:T_},content_parsers:[T1],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:Pr,data_adapter:P_,block_adapters:{md:mi,txt:mi,"excalidraw.md":mi}}},item_types:{SmartSource:_i,SmartBlock:ui},items:{smart_source:f1,smart_block:w1},default_settings:H1,modals:{context_selector:{class:iu,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:ru},notifications_feed_modal:{class:ou}}};qt(yS,gS);var bS=yS;var ku=require("obsidian");function vS(){(0,ku.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}r(vS,"add_smart_chat_icon");function kS(){(0,ku.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}r(kS,"add_smart_connections_icon");function wS(){(0,ku.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}r(wS,"add_smart_lookup_icon");var xS=require("obsidian");var wu={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function yM(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(yM,"define_default_create_methods");var xu=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,yM(wu)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=wu[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,xS.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,wu["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var ES=require("obsidian");var bM=require("obsidian");function Eu(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Eu,"get_smart_server_url");var vM="smart-plugins-op",kM="smart-plugins-op-secret";function wM({access_token:n,refresh_token:e},t){localStorage.setItem(t+"token",n),e&&localStorage.setItem(t+"refresh",e)}r(wM,"set_local_storage_token");async function AS(n,e){let t=EM(e.app.vault.getName()),s=`${Eu()}/auth/oauth_exchange2`,i=await(0,ES.requestUrl)({url:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:vM,client_secret:kM,code:n})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:o,refresh_token:a}=i.json;if(!o)throw new Error("No access_token in response");wM({access_token:o,refresh_token:a},t)}r(AS,"exchange_code_for_tokens");var xM="_smart_plugins_oauth_";function EM(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${xM}`}r(EM,"build_oauth_storage_prefix");function SS(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let s=Ai([...new Set(t)]);return n.replace(/{{\s*folder_tree\s*}}/gi,s)}r(SS,"replace_folder_tree_var");function CS(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let s=Ai([...new Set(t)]);return n.replace(/{{\s*folders_top\s*}}/gi,s)}r(CS,"replace_folders_top_var");function qS(n){console.log("replace_recent_n_var",n);let e=this;return n.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,s)=>{let i=parseInt(s,10)||0,o=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,o),o?`
- ${o}`:""}).trim()}r(qS,"replace_recent_n_var");function OS(n){let t=this.app?.metadataCache?.getTags?.()||{},s=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return n.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${s}
`).trim()}r(OS,"replace_vault_tags_var");function $S(n){n.register(e=>/{{\s*folder_tree\s*}}/i.test(e),SS,"{{ folder_tree }}"),n.register(e=>/{{\s*folders_top\s*}}/i.test(e),CS,"{{ folders_top }}"),n.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),OS,"{{ tags }}"),n.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),qS,"{{ recent_10 }}")}r($S,"register_completion_variable_adapter_replacements");async function Au({app:n,plugin_ids:e=[]}={}){if(!n)return;let t=n.vault?.adapter;for(let s of e)await AM(n.plugins,s)&&console.warn(`Disabled legacy plugin: ${s}`),await SM(t,s)&&console.warn(`Removed legacy plugin: ${s}`)}r(Au,"remove_smart_plugins_plugin");async function AM(n,e){if(!(!n||!(n.plugins?.[e]||n.enabledPlugins?.has?.(e)||n.manifests&&e in n.manifests)))return n.plugins?.[e]&&await n.unloadPlugin?.(e),n.disablePluginAndSave&&await n.disablePluginAndSave(e),n.enabledPlugins?.has?.(e)&&n.enabledPlugins.delete(e),n.manifests&&e in n.manifests&&delete n.manifests[e],await n.loadManifests?.(),!0}r(AM,"disable_plugin_if_present");async function SM(n,e){if(!n?.exists)return;let t=`.obsidian/plugins/${e}`;if(await n.exists(t)){if(n.rmdir){await n.rmdir(t,!0);return}if(n.list&&n.remove){let i=[t];for(;i.length;){let o=i.pop(),a=await n.list(o);for(let c of a?.files||[])await n.remove(`${o}/${c}`);for(let c of a?.folders||[])i.push(`${o}/${c}`)}return await n.remove(t),!0}}}r(SM,"remove_plugin_folder");var pa=class extends qr{static{r(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,vS(),kS(),wS(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new jt.Notice(i,0),window.smart_env=null}let s=qt(t,bS);return s.env_path="",await super.create(e,s)}async load(e=!1){if(this.run_migrations(),!jt.Platform.isMobile&&!this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")&&this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),jt.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new jt.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i.view?.file?.path;this.emit_source_opened(o,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i?.path;this.emit_source_opened(o,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&$S(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),_A(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let s=this.smart_sources.get(e);s&&(this._current_opened_source=e,s.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new xu(this,{adapter:jt.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),s=`${Eu()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(s,"_external"),s}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new jt.Notice("No OAuth code provided in URL. Login failed.");return}try{await AS(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(s){console.error("OAuth callback error",s),new jt.Notice(`OAuth callback error: ${s.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&CM(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){Au({app:this.plugin.app,plugin_ids:["smart-plugins"]}),Au({app:this.plugin.app,plugin_ids:["smart-editor"]}),Au({app:this.plugin.app,plugin_ids:["smart-sources"]})}};function CM(n,e){let t=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}r(CM,"download_json");var OM=require("obsidian");var qM=require("obsidian");var $M=require("obsidian");var Su=class extends Ut{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var PS=Y(NS(),1);var zM=Object.defineProperty,RM=r((n,e,t)=>e in n?zM(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),DM=r((n,e,t)=>(RM(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function FM(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(FM,"bytePairMerge");function BM(n,e){return n.length===1?[e.get(n.join(","))]:FM(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(BM,"bytePairEncode");function UM(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(UM,"escapeRegex");var Yf=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=PS.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=Yf.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Yf.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??n.length;for(let f of n.substring(l,u).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...BM(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},qu=Yf;DM(qu,"specialTokenRegex",n=>new RegExp(n.map(e=>UM(e)).join("|"),"g"));async function MS(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await IS(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await IS(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(MS,"fetch_json_cached");async function IS(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(IS,"do_fetch");var WM="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",Me=class extends Su{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return we}get res_adapter(){return xe}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Be({adapter:kt})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:_e(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await MS(WM,"cl100k_base.json");this.tiktoken=new qu(e)}},we=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},xe=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Ou=class extends Me{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Xf}get res_adapter(){return Zf}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"models/gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}},Xf=class extends we{static{r(this,"SmartEmbedGeminiRequestAdapter")}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Zf=class extends xe{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:500})}};var Qf=class extends Ou{static{r(this,"GoogleGeminiEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},LS={class:Qf};function GM(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(GM,"parse_lm_studio_models");var $u=class extends Me{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return eg}get res_adapter(){return tg}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return GM(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},eg=class extends we{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},tg=class extends xe{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var sg=class extends $u{static{r(this,"LmStudioEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},zS={class:sg};var ju=class extends Me{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{},model_key:"nomic-embed-text"};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return ng}get res_adapter(){return ig}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of VM(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},ng=class extends we{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},ig=class extends xe{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},HM=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),VM=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(HM)},"filter_embedding_models");var og=class extends ju{static{r(this,"OllamaEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},JM={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},RS={class:og,settings_config:JM};var Tu=class extends Me{static{r(this,"SmartEmbedOpenRouterAdapter")}static key="open_router";static defaults={description:"OpenRouter (Embeddings)",type:"API",adapter:"OpenRouterEmbeddings",endpoint:"https://openrouter.ai/api/v1/embeddings",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"text-embedding-3-small",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys",streaming:!1,api_key:null,batch_size:50,max_tokens:8191};get req_adapter(){return rg}get res_adapter(){return ag}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenRouter API key for embeddings",type:"password",description:"Required for OpenRouter embedding models.",placeholder:"Enter OpenRouter API key"}}}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}get models_endpoint(){return this.constructor.defaults.models_endpoint}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;if(!this.api_key){console.warn("[SmartEmbedOpenRouterAdapter] API key missing; cannot fetch models from OpenRouter.");let t=this.constructor.defaults.default_model,s={[t]:{id:t,model_name:t,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=s,s}try{let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET",headers:{Authorization:`Bearer ${this.api_key}`}})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}catch(t){if(console.error("[SmartEmbedOpenRouterAdapter] Failed to fetch models:",t),this.model.data.provider_models)return this.model.data.provider_models;let s=this.constructor.defaults.default_model,i={[s]:{id:s,model_name:s,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=i,i}}parse_model_data(e){let t=[];if(Array.isArray(e?.data))t=e.data;else if(Array.isArray(e))t=e;else return console.error("[SmartEmbedOpenRouterAdapter] Invalid model data format from OpenRouter:",e),{_:{id:"No models found."}};let s={};for(let i of t){let o=i.id||i.name;o&&KM(o)&&(s[o]={id:o,model_name:o,max_tokens:i.context_length||this.max_tokens,description:i.name||i.description||`Model: ${o}`,adapter:this.constructor.key})}return Object.keys(s).length?s:{_:{id:"No embedding models found."}}}},rg=class extends we{static{r(this,"SmartEmbedOpenRouterRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},ag=class extends xe{static{r(this,"SmartEmbedOpenRouterResponseAdapter")}parse_response(){let e=this.response;if(!e||!Array.isArray(e.data))return console.error("[SmartEmbedOpenRouterResponseAdapter] Invalid embedding response format:",e),[];let t=null;return e.usage?.total_tokens&&e.data.length>0&&(t=e.usage.total_tokens/e.data.length),e.data.map(s=>({vec:s.embedding||s.data||[],tokens:t}))}},KM=r(n=>{let e=String(n||"").toLowerCase();return!!(e.split(/[-:/_]/).some(s=>["embed","embedding","bge"].includes(s))||e.includes("text-embedding"))},"is_embedding_model");var cg=class extends Tu{static{r(this,"OpenRouterEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},DS={class:cg};var Nu=class extends Me{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return lg}get res_adapter(){return dg}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},lg=class extends we{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},dg=class extends xe{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var _g=class extends Nu{static{r(this,"OpenAIEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get batch_size(){return 30}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},YM={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},dimensions:{name:"Embedding Dimensions",type:"dropdown",description:"Select the number of dimensions for the embeddings (only for text-embedding-3 models).",option_1:"256|256 (equivalent to ada using 'large' model)",option_2:"512|512 (equivalent to ada using 'small' model)",option_3:"1536|1536",option_4:"3072|3072 (uses >10X more RAM/storage than 256)",default:"512"}},FS={class:_g,settings_config:YM};var Pu=class extends V{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return ug}res_adapter=mg;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},ug=class extends K{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},mg=class extends W{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:_e(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var pg=class extends Pu{static{r(this,"AnthropicChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},XM={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."}},BS={class:pg,settings_config:XM};var ZM=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Si=class extends V{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=hg;parse_model_data(e){return e.data.filter(t=>!ZM.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:QM(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function QM(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(QM,"get_max_input_tokens");var hg=class extends W{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Iu=class extends Si{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var fg=class extends Iu{static{r(this,"AzureChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},eL={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."},azure_resource_name:{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},azure_deployment_name:{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},azure_api_version:{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}},US={class:fg,settings_config:eL};var Mu=class extends V{static{r(this,"SmartChatModelCohereAdapter")}static key="cohere";static defaults={description:"Cohere Command-R",type:"API",endpoint:"https://api.cohere.ai/v1/chat",streaming:!1,adapter:"Cohere",models_endpoint:"https://api.cohere.ai/v1/models",default_model:"command-r",signup_url:"https://dashboard.cohere.com/welcome/register?redirect_uri=%2Fapi-keys"};get req_adapter(){return gg}get res_adapter(){return yg}async count_tokens(e){let t={url:`${this.endpoint}/tokenize`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.api_key}`},body:JSON.stringify({text:typeof e=="string"?e:JSON.stringify(e)})};return(await this.http_adapter.request(t)).json.tokens.length}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("command-")).reduce((t,s)=>(t[s.name]={model_name:s.name,id:s.name,max_input_tokens:s.context_length,tokenizer_url:s.tokenizer_url,finetuned:s.finetuned,description:`Max input tokens: ${s.context_length}, Finetuned: ${s.finetuned}`,raw:s},t),{})}},gg=class extends K{static{r(this,"SmartChatModelCohereRequestAdapter")}to_platform(){return this.to_cohere()}to_cohere(){let e={model:this.model_id,message:this._get_latest_user_message(),chat_history:this._transform_messages_to_cohere_chat_history(),max_tokens:this.max_tokens,temperature:this.temperature,stream:this.stream,...this.tools&&{tools:this._transform_tools_to_cohere()},...this._req.tool_choice&&{tool_choice:this._req.tool_choice},...this._req.preamble&&{preamble:this._req.preamble},...this._req.conversation_id&&{conversation_id:this._req.conversation_id},...this._req.connectors&&{connectors:this._req.connectors},...this._req.documents&&{documents:this._req.documents}};return this._req.response_format&&(e.response_format={type:this._req.response_format.type,...this._req.response_format.schema&&{schema:this._req.response_format.schema}}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}_get_latest_user_message(){if(this.messages.some(t=>Array.isArray(t.content)&&t.content.some(s=>s.type==="image_url")))throw new Error("Cohere API does not support image input");let e=this.messages.filter(t=>t.role==="user");return e[e.length-1]?.content||""}_transform_messages_to_cohere_chat_history(){return this.messages.slice(0,-1).map(e=>({role:this._get_cohere_role(e.role),message:this._get_cohere_content(e.content)}))}_get_cohere_role(e){return{system:"SYSTEM",user:"USER",assistant:"CHATBOT",function:"CHATBOT"}[e]||e.toUpperCase()}_get_cohere_content(e){if(Array.isArray(e)){for(let t of e)if(t.type==="image_url")throw new Error("Cohere API does not support image input");return e.map(t=>t.type==="text"?t.text:JSON.stringify(t)).join(`
`)}return e}_transform_tools_to_cohere(){return this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}},yg=class extends W{static{r(this,"SmartChatModelCohereResponseAdapter")}to_openai(){if(this._res.message)throw new Error(this._res.message);return{id:this._res.generation_id||"cohere_"+Date.now(),object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.finish_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:this._res.text||""};return this._res.citations&&(e.citations=this._res.citations),this._res.documents&&(e.documents=this._res.documents),this._res.search_queries&&(e.search_queries=this._res.search_queries),this._res.search_results&&(e.search_results=this._res.search_results),e}_get_openai_finish_reason(e){return{COMPLETE:"stop",MAX_TOKENS:"length",ERROR:"error",STOP_SEQUENCE:"stop"}[e]||"stop"}_transform_usage_to_openai(){return!this._res.meta||!this._res.meta.billed_units?{prompt_tokens:null,completion_tokens:null,total_tokens:null}:{prompt_tokens:this._res.meta.billed_units.input_tokens||null,completion_tokens:this._res.meta.billed_units.output_tokens||null,total_tokens:(this._res.meta.billed_units.input_tokens||0)+(this._res.meta.billed_units.output_tokens||0)}}};var bg=class extends Mu{static{r(this,"CohereChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},tL={api_key:{name:"API Key",type:"password",description:"Enter your Cohere API key."}},WS={class:bg,settings_config:tL};var Lu=class extends V{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return vg}get res_adapter(){return kg}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},vg=class extends K{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},kg=class extends W{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var wg=class extends Lu{static{r(this,"DeepseekChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},sL={api_key:{name:"API Key",type:"password",description:"Enter your Deepseek API key."}},GS={class:wg,settings_config:sL};var zu=class extends V{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=xg;res_adapter=Eg;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},xg=class extends K{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Eg=class extends W{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:_e(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}};var Ag=class extends zu{static{r(this,"GoogleChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},nL={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."}},HS={class:Ag,settings_config:nL};var Ru=class extends V{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Sg}get res_adapter(){return Cg}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},Sg=class extends K{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Cg=class extends W{static{r(this,"SmartChatModelGroqResponseAdapter")}};var qg=class extends Ru{static{r(this,"GroqChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},iL={api_key:{name:"API Key",type:"password",description:"Enter your Groq API key."}},VS={class:qg,settings_config:iL};var Du=class extends V{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Og}get res_adapter(){return $g}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Og=class extends K{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},$g=class extends W{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var jg=class extends Du{static{r(this,"LmStudioChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},oL={},JS={class:jg,settings_config:oL};var Fu=class extends V{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=Tg;res_adapter=Ng;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},Tg=class extends K{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},Ng=class extends W{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:_e(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Pg=class extends Fu{static{r(this,"OllamaChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},rL={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},KS={class:Pg,settings_config:rL};var Ig=class extends Si{static{r(this,"OpenAIChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},aL={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},openai_note:{name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."}},YS={class:Ig,settings_config:aL};var Bu=class extends V{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return K}get res_adapter(){return W}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var Mg=class extends Bu{static{r(this,"XaiChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},cL={api_key:{name:"API Key",type:"password",description:"Enter your xAI API key."}},XS={class:Mg,settings_config:cL};var ZS={collections:{embedding_models:{providers:{gemini:LS,lm_studio:zS,ollama:RS,open_router:DS,openai:FS}},chat_completion_models:{providers:{anthropic:BS,azure:US,cohere:WS,deepseek:GS,google:HS,groq:VS,lm_studio:JS,ollama:KS,open_router:Hd,openai:YS,xai:XS}}}};var Ci=require("obsidian");async function Lg(n){let e=n.plugin?.app||window.app,t=_u(e),s=(typeof localStorage<"u"?localStorage.getItem(t+"token"):"")||"";if(!s){console.warn("[smart_plugins] No OAuth token found; skipping Smart Plugins auto\u2011update."),Uu("Smart Plugins: connect your Smart Plugins account to keep using Pro plugins.");let i=t+"auth_misses",o=parseInt(localStorage.getItem(i)||"0",10);return localStorage.setItem(i,(o+1).toString()),{updated:[],skipped:[],checked:0}}try{let i=await _L(e);console.log("[smart_plugins] Built installed plugins map:",i);let o=await uu(s);console.log("[smart_plugins] Fetched server plugin list:",o);let a=Array.isArray(o.list)?o.list:[],c=Array.isArray(o.unauthorized)?o.unauthorized:[],l=o.sub_exp,d=typeof l=="number"&&l<Date.now(),_=[],u=[],p=[];if(d){if(c.length){console.log("[smart_plugins] Subscription expired; handling unauthorized plugins.",{unauthorized_list:c});for(let b of c){if(!i[b.plugin_id]){p.push(b.plugin_id);continue}if(b.core_repo)await lL(e,b)&&u.push(b.plugin_id);else{await uL(e,b.plugin_id)&&_.push(b.plugin_id);continue}}}let x={updated:[],skipped:[],checked:0,removed:_,replaced:u,not_installed:p,unauthorized_count:c.length,sub_exp:l||null};return console.log({update_result:x}),x}let f=a.length,y=[];for(let x of a){if(!x||!x.repo)continue;let b=x.version||"unknown",C=(x.manifest_id||x.repo.replace("/","_")).trim(),k=i[C];!k||!k.version||lu(k.version,b)&&y.push({item:x,plugin_id:C,local_version:k.version,server_version:b})}if(!y.length)return{updated:[],skipped:[],checked:f};let g=[],w=[];for(let x of y){let{item:b,plugin_id:C,local_version:k,server_version:A}=x;try{let q=await du(b.repo,s),{files:O,pluginManifest:S}=await da(q),m=S.id,h=`${e.vault.configDir}/plugins/${m}`;await _a(e.vault.adapter,h,O),g.push(`${b.repo}@${A}`)}catch(q){console.error("[smart_plugins] Failed to auto\u2011update plugin:",{repo:b.repo,plugin_id:C,local_version:k,server_version:A,error:q}),w.push(b.repo)}}if(g.length){let x=g.length===1?"":"s";Uu(`Smart Plugins: updated ${g.length} plugin${x}. Please restart Obsidian to apply updates.`)}else w.length||Uu("Smart Plugins: no updates applied.");return{updated:g,skipped:w,checked:f}}catch(i){return console.error("[smart_plugins] update_installed_smart_plugins error:",i),Uu("Smart Plugins: failed to check for updates. See console for details."),{updated:[],skipped:[],checked:0}}}r(Lg,"update_installed_smart_plugins");async function lL(n,e){let t=await(0,Ci.requestUrl)({url:`https://api.github.com/repos/${e.core_repo}/releases/latest`,method:"GET"}),s=t?.json||{};if(!(s?.tag_name||null))return console.error("[smart_plugins] Failed to get latest core plugin version from GitHub:",{core_repo:e.core_repo,response:t}),null;try{let o=s?.assets?.find(u=>u.name.endsWith(".zip"))?.browser_download_url||null;if(!o)return console.error("[smart_plugins] Failed to find core plugin zip asset in GitHub release:",{core_repo:e.core_repo,release:s}),null;let a=await dL(o),{files:c,pluginManifest:l}=await da(a),d=e.plugin_id,_=`${n.vault.configDir}/plugins/${d}`;return await _a(n.vault.adapter,_,c),!0}catch(o){return console.error("[smart_plugins] Failed to install core plugin:",{core_repo:e.core_repo,error:o}),null}}r(lL,"replace_pro_with_core");async function dL(n){console.log(`[smart_plugins] download plugin from URL: ${n}`);let e=await(0,Ci.requestUrl)({url:n,method:"GET",headers:{Accept:"application/zip"}});if(e.status&&e.status!==200)throw new Error(`Download error ${e.status}: ${e.text||""}`);return cu(e.arrayBuffer,"Download")}r(dL,"fetch_zip_from_public_url");async function _L(n){let e={},t=n.plugins;if(!t)return e;await t.loadManifests();let s=t.manifests||{};for(let i in s){if(!Object.prototype.hasOwnProperty.call(s,i))continue;let o=s[i]||{};e[i]={id:o.id||i,name:o.name||i,version:o.version||""}}return e}r(_L,"build_installed_plugins_map");function Uu(n){try{typeof Ci.Notice=="function"?new Ci.Notice(n):console.log("[smart_plugins]",n)}catch(e){console.log("[smart_plugins] notice error",e,n)}}r(Uu,"show_notice");async function uL(n,e){let t=n?.vault?.adapter;if(!t)return!1;let s=`${n.vault.configDir}/plugins/${e}`,i=`${s}/main.js`,o=`${s}/manifest.json`;try{return await t.exists(i)&&await t.remove(i),await t.exists(o)&&await t.remove(o),!0}catch(a){console.error("[smart_plugins] Failed to remove main.js for unauthorized plugin",{plugin_id:e,error:a})}return!1}r(uL,"remove_main_js_for_plugin");var qi=class n extends pa{static{r(this,"SmartEnv")}static version="2.3.5";is_pro=!0;async load(e=!1){await super.load(e),n.wait_for({loaded:!0}).then(async()=>{console.warn("[smart_env] Checking for Smart Plugins updates..."),Lg(this),this._registered_refresh_event||(this._registered_refresh_event=!0,this.events.on("pro_plugins:refresh",async()=>{console.warn("[smart_env] Refreshing Smart Plugins list..."),Lg(this)}))})}},hMe=qi.version;var QS=qt(QE,ZS);var pL={modules:{smart_rank_model:{class:sl,adapters:{cohere:jn},http_adapter:new Be({adapter:$o,obsidian_request_url:zg.requestUrl})}}},Wu=class extends Oo{static{r(this,"SmartConnectionsPlugin")}SmartEnv=qi;get smart_env_config(){if(!this._smart_env_config){let e=super.smart_env_config;xt(e,QS),xt(e,Nw),xt(e,pL),this._smart_env_config=e}return this._smart_env_config}async initialize(){await this.remove_deprecated_plugin_if_present(),dE(this),yE(this),await super.initialize?.(),console.log("Loading Smart Connections Early Release plugin..."),this.registerEditorExtension(Bk),this.registerEditorExtension(iE(this)),this.connections_footer_view=new Pd(this),this.app.workspace.onLayoutReady(()=>{this.toggled_inline_connections()}),this.toggled_footer_connections(),this.register_env_event_listeners(),console.log("Smart Connections Early Release plugin loaded."),vE(this)}get oauth_storage_prefix(){if(!this._oauth_storage_prefix){let e=this.app.vault.getName();this._oauth_storage_prefix=Y0(e)}return this._oauth_storage_prefix}get_smart_plugins_token(){let{token:e}=K0(this.oauth_storage_prefix);return e||""}async remove_deprecated_plugin_if_present(){let e="smart-connections-early-release";try{let t=this.app.plugins;t.enabledPlugins?.has(e)&&await t.disablePlugin(e);let i=`${String(this.app.vault.configDir||"").replace(/\/$/,"")}/plugins/${e}`;await this.app.vault.adapter.exists(i)&&(await this.app.vault.adapter.rmdir(i,!0),await t.loadManifests())}catch(t){console.warn("Smart Connections Early Release: failed to clean up deprecated plugin",t)}}get commands(){return{...super.commands,toggle_inline_connections:{id:"toggle-inline-connections",name:"Toggle: Inline connections",callback:r(()=>{let e=this.env.connections_lists.settings;e.inline_connections=!e.inline_connections},"callback")},toggle_footer_connections:{id:"toggle-footer-connections",name:"Toggle: Footer connections",callback:r(()=>{let e=this.env.connections_lists.settings;e.footer_connections=!e.footer_connections},"callback")}}}register_code_blocks(){super.register_code_blocks?.(),this.registerMarkdownCodeBlockProcessor("smart-connections-web",this.render_web_code_block.bind(this)),this.registerMarkdownCodeBlockProcessor("connections",(e,t,s)=>{new Id(this).render(e,t,s)})}register_env_event_listeners(){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on("settings:changed",e=>{e.path?.includes("inline_connections")&&this.toggled_inline_connections()})),this.env_listeners.push(this.env.events.on("settings:changed",e=>{e.path?.includes("footer_connections")&&this.toggled_footer_connections()}))}onunload(){console.log("Unloading Smart Connections Early Release plugin..."),this.env_listeners.forEach(e=>e()),this.connections_footer_view?.unload(),super.onunload?.()}get_editor_view(){if(!this.app.workspace.getActiveFile())return console.log("Smart Connections: No active file found"),null;let t=this.app.workspace.getActiveFileView();return t?t.editor?.cm||null:(console.log("Smart Connections: No active file view found"),null)}toggled_inline_connections(){this.app.workspace.getLeavesOfType("markdown").map(e=>e.view?.editor?.cm).filter(Boolean).forEach(e=>{e.plugin(Eh)?.refresh()})}toggled_footer_connections(){this.get_editor_view()&&this.env.connections_lists.settings.footer_connections?this.connections_footer_view.render_view():this.connections_footer_view.remove()}async render_web_code_block(e,t,s){t.empty(),t.createEl("span",{text:"Loading\u2026"}),await this.SmartEnv.wait_for({loaded:!0});let i=[],o={};if(e.trim().length){let l=e.split(`
`).map(d=>d.trim()).filter(d=>d.length);for(let d of l){if(d.startsWith("include:")){let _=d.replace("include:","").trim();_&&(o.key_includes_any=_.split(",").map(u=>u.trim()));continue}if(d.startsWith("does not end with:")){let _=d.replace("does not end with:","").trim();_&&(o.exclude_key_ends_with_any=_.split(",").map(u=>u.trim()));continue}if(d.startsWith("limit:")){let _=d.replace("limit:","").trim();_&&(o.limit=parseInt(_));continue}i.push(d)}}if(i.length){e=i.join(`
`);let l=await this.env.render_component("lookup",this.env.smart_sources,{attribution:this.attribution,query:e,filter:o});t.empty(),t.appendChild(l);return}let a=this.env.smart_sources.get(s.sourcePath)??this.env.smart_sources.init_file_path(s.sourcePath);if(!a){t.empty(),t.createEl("p",{text:"Entity not found: "+s.sourcePath});return}let c=await this.env.render_component("connections_web",a,{attribution:this.attribution,filter:o});t.empty(),t.appendChild(c)}async check_for_update(){let e="brianpetro/smart-connections-obsidian-early";try{let t=this.get_smart_plugins_token();if(!t){console.log("Smart Connections Early Release: skipping update check (no Smart Plugins token)");return}let s=await(0,zg.requestUrl)({url:`${jd()}/plugin_version`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({repo:e})});if(s.status!==200)throw new Error(`plugin_version responded with status ${s.status}`);let i=s.json?.version;if(!hE(this.manifest.version,i))return;this.env?.events?.emit("plugin:new_version_available",{version:i}),this.notices?.show("new_version_available",{version:i}),this.update_available=!0}catch(t){console.error("Smart Connections Early Release: failed to check for update",t)}}};

const smart_hash_id='b2733ca5b6f933e6d9270fdb1236c755672735a5f45434f868109ef5865bd421';