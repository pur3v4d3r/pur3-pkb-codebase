/*! smart-connections-early-release v4.2.7 | (c) 2026 ðŸŒ´ Brian */
var $2=Object.create;var to=Object.defineProperty;var j2=Object.getOwnPropertyDescriptor;var T2=Object.getOwnPropertyNames;var N2=Object.getPrototypeOf,P2=Object.prototype.hasOwnProperty;var o=(s,e)=>to(s,"name",{value:e,configurable:!0});var Na=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),I2=(s,e)=>{for(var t in e)to(s,t,{get:e[t],enumerable:!0})},Vy=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of T2(e))!P2.call(s,i)&&i!==t&&to(s,i,{get:()=>e[i],enumerable:!(n=j2(e,i))||n.enumerable});return s};var Y=(s,e,t)=>(t=s!=null?$2(N2(s)):{},Vy(e||!s||!s.__esModule?to(t,"default",{value:s,enumerable:!0}):t,s)),L2=s=>Vy(to({},"__esModule",{value:!0}),s);var xb=Na(hc=>{"use strict";hc.byteLength=hq;hc.toByteArray=gq;hc.fromByteArray=vq;var it=[],Ce=[],pq=typeof Uint8Array<"u"?Uint8Array:Array,jm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(As=0,kb=jm.length;As<kb;++As)it[As]=jm[As],Ce[jm.charCodeAt(As)]=As;var As,kb;Ce[45]=62;Ce[95]=63;function wb(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}o(wb,"getLens");function hq(s){var e=wb(s),t=e[0],n=e[1];return(t+n)*3/4-n}o(hq,"byteLength");function fq(s,e,t){return(e+t)*3/4-t}o(fq,"_byteLength");function gq(s){var e,t=wb(s),n=t[0],i=t[1],r=new pq(fq(s,n,i)),a=0,c=i>0?n-4:n,l;for(l=0;l<c;l+=4)e=Ce[s.charCodeAt(l)]<<18|Ce[s.charCodeAt(l+1)]<<12|Ce[s.charCodeAt(l+2)]<<6|Ce[s.charCodeAt(l+3)],r[a++]=e>>16&255,r[a++]=e>>8&255,r[a++]=e&255;return i===2&&(e=Ce[s.charCodeAt(l)]<<2|Ce[s.charCodeAt(l+1)]>>4,r[a++]=e&255),i===1&&(e=Ce[s.charCodeAt(l)]<<10|Ce[s.charCodeAt(l+1)]<<4|Ce[s.charCodeAt(l+2)]>>2,r[a++]=e>>8&255,r[a++]=e&255),r}o(gq,"toByteArray");function yq(s){return it[s>>18&63]+it[s>>12&63]+it[s>>6&63]+it[s&63]}o(yq,"tripletToBase64");function bq(s,e,t){for(var n,i=[],r=e;r<t;r+=3)n=(s[r]<<16&16711680)+(s[r+1]<<8&65280)+(s[r+2]&255),i.push(yq(n));return i.join("")}o(bq,"encodeChunk");function vq(s){for(var e,t=s.length,n=t%3,i=[],r=16383,a=0,c=t-n;a<c;a+=r)i.push(bq(s,a,a+r>c?c:a+r));return n===1?(e=s[t-1],i.push(it[e>>2]+it[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],i.push(it[e>>10]+it[e>>4&63]+it[e<<2&63]+"=")),i.join("")}o(vq,"fromByteArray")});var x0=Na(ud=>{"use strict";ud.byteLength=KP;ud.toByteArray=XP;ud.fromByteArray=eI;var ut=[],Te=[],VP=typeof Uint8Array<"u"?Uint8Array:Array,kh="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Fs=0,k0=kh.length;Fs<k0;++Fs)ut[Fs]=kh[Fs],Te[kh.charCodeAt(Fs)]=Fs;var Fs,k0;Te[45]=62;Te[95]=63;function w0(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}o(w0,"getLens");function KP(s){var e=w0(s),t=e[0],n=e[1];return(t+n)*3/4-n}o(KP,"byteLength");function YP(s,e,t){return(e+t)*3/4-t}o(YP,"_byteLength");function XP(s){var e,t=w0(s),n=t[0],i=t[1],r=new VP(YP(s,n,i)),a=0,c=i>0?n-4:n,l;for(l=0;l<c;l+=4)e=Te[s.charCodeAt(l)]<<18|Te[s.charCodeAt(l+1)]<<12|Te[s.charCodeAt(l+2)]<<6|Te[s.charCodeAt(l+3)],r[a++]=e>>16&255,r[a++]=e>>8&255,r[a++]=e&255;return i===2&&(e=Te[s.charCodeAt(l)]<<2|Te[s.charCodeAt(l+1)]>>4,r[a++]=e&255),i===1&&(e=Te[s.charCodeAt(l)]<<10|Te[s.charCodeAt(l+1)]<<4|Te[s.charCodeAt(l+2)]>>2,r[a++]=e>>8&255,r[a++]=e&255),r}o(XP,"toByteArray");function ZP(s){return ut[s>>18&63]+ut[s>>12&63]+ut[s>>6&63]+ut[s&63]}o(ZP,"tripletToBase64");function QP(s,e,t){for(var n,i=[],r=e;r<t;r+=3)n=(s[r]<<16&16711680)+(s[r+1]<<8&65280)+(s[r+2]&255),i.push(ZP(n));return i.join("")}o(QP,"encodeChunk");function eI(s){for(var e,t=s.length,n=t%3,i=[],r=16383,a=0,c=t-n;a<c;a+=r)i.push(QP(s,a,a+r>c?c:a+r));return n===1?(e=s[t-1],i.push(ut[e>>2]+ut[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],i.push(ut[e>>10]+ut[e>>4&63]+ut[e<<2&63]+"=")),i.join("")}o(eI,"fromByteArray")});var PS=Na(cu=>{"use strict";cu.byteLength=f3;cu.toByteArray=y3;cu.fromByteArray=k3;var bt=[],Le=[],h3=typeof Uint8Array<"u"?Uint8Array:Array,lg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(nn=0,TS=lg.length;nn<TS;++nn)bt[nn]=lg[nn],Le[lg.charCodeAt(nn)]=nn;var nn,TS;Le[45]=62;Le[95]=63;function NS(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}o(NS,"getLens");function f3(s){var e=NS(s),t=e[0],n=e[1];return(t+n)*3/4-n}o(f3,"byteLength");function g3(s,e,t){return(e+t)*3/4-t}o(g3,"_byteLength");function y3(s){var e,t=NS(s),n=t[0],i=t[1],r=new h3(g3(s,n,i)),a=0,c=i>0?n-4:n,l;for(l=0;l<c;l+=4)e=Le[s.charCodeAt(l)]<<18|Le[s.charCodeAt(l+1)]<<12|Le[s.charCodeAt(l+2)]<<6|Le[s.charCodeAt(l+3)],r[a++]=e>>16&255,r[a++]=e>>8&255,r[a++]=e&255;return i===2&&(e=Le[s.charCodeAt(l)]<<2|Le[s.charCodeAt(l+1)]>>4,r[a++]=e&255),i===1&&(e=Le[s.charCodeAt(l)]<<10|Le[s.charCodeAt(l+1)]<<4|Le[s.charCodeAt(l+2)]>>2,r[a++]=e>>8&255,r[a++]=e&255),r}o(y3,"toByteArray");function b3(s){return bt[s>>18&63]+bt[s>>12&63]+bt[s>>6&63]+bt[s&63]}o(b3,"tripletToBase64");function v3(s,e,t){for(var n,i=[],r=e;r<t;r+=3)n=(s[r]<<16&16711680)+(s[r+1]<<8&65280)+(s[r+2]&255),i.push(b3(n));return i.join("")}o(v3,"encodeChunk");function k3(s){for(var e,t=s.length,n=t%3,i=[],r=16383,a=0,c=t-n;a<c;a+=r)i.push(v3(s,a,a+r>c?c:a+r));return n===1?(e=s[t-1],i.push(bt[e>>2]+bt[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],i.push(bt[e>>10]+bt[e>>4&63]+bt[e<<2&63]+"=")),i.join("")}o(k3,"fromByteArray")});var t2=Na(Zu=>{"use strict";Zu.byteLength=m5;Zu.toByteArray=h5;Zu.fromByteArray=y5;var xt=[],ze=[],u5=typeof Uint8Array<"u"?Uint8Array:Array,Zg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(cn=0,QO=Zg.length;cn<QO;++cn)xt[cn]=Zg[cn],ze[Zg.charCodeAt(cn)]=cn;var cn,QO;ze[45]=62;ze[95]=63;function e2(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}o(e2,"getLens");function m5(s){var e=e2(s),t=e[0],n=e[1];return(t+n)*3/4-n}o(m5,"byteLength");function p5(s,e,t){return(e+t)*3/4-t}o(p5,"_byteLength");function h5(s){var e,t=e2(s),n=t[0],i=t[1],r=new u5(p5(s,n,i)),a=0,c=i>0?n-4:n,l;for(l=0;l<c;l+=4)e=ze[s.charCodeAt(l)]<<18|ze[s.charCodeAt(l+1)]<<12|ze[s.charCodeAt(l+2)]<<6|ze[s.charCodeAt(l+3)],r[a++]=e>>16&255,r[a++]=e>>8&255,r[a++]=e&255;return i===2&&(e=ze[s.charCodeAt(l)]<<2|ze[s.charCodeAt(l+1)]>>4,r[a++]=e&255),i===1&&(e=ze[s.charCodeAt(l)]<<10|ze[s.charCodeAt(l+1)]<<4|ze[s.charCodeAt(l+2)]>>2,r[a++]=e>>8&255,r[a++]=e&255),r}o(h5,"toByteArray");function f5(s){return xt[s>>18&63]+xt[s>>12&63]+xt[s>>6&63]+xt[s&63]}o(f5,"tripletToBase64");function g5(s,e,t){for(var n,i=[],r=e;r<t;r+=3)n=(s[r]<<16&16711680)+(s[r+1]<<8&65280)+(s[r+2]&255),i.push(f5(n));return i.join("")}o(g5,"encodeChunk");function y5(s){for(var e,t=s.length,n=t%3,i=[],r=16383,a=0,c=t-n;a<c;a+=r)i.push(g5(s,a,a+r>c?c:a+r));return n===1?(e=s[t-1],i.push(xt[e>>2]+xt[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],i.push(xt[e>>10]+xt[e>>4&63]+xt[e<<2&63]+"=")),i.join("")}o(y5,"fromByteArray")});var X5={};I2(X5,{default:()=>hm});module.exports=L2(X5);var Fy=require("obsidian");var Tp=Y(require("obsidian"),1);var Ut=require("obsidian");var Pa=class{static{o(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var Ia=class extends Pa{static{o(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let n=e==="*"?"*":e,i=this.handlers[n]||(this.handlers[n]=[]),r={id:this._next_id++,cb:t};return i.push(r),()=>this.off_entry(n,r.id)}once(e,t=()=>{}){let n=e==="*"?"*":e,i=this.handlers[n]||(this.handlers[n]=[]),r={id:this._next_id++,cb:null},a=o((c,l)=>{this.off_entry(n,r.id),t(c,l)},"wrapper");return r.cb=a,i.push(r),()=>this.off_entry(n,r.id)}off(e,t){let n=this.handlers[e];if(!(!n||!t)){for(let i=n.length-1;i>=0;i--)if(n[i].cb===t){n.splice(i,1);break}}}off_entry(e,t){let n=this.handlers[e];if(!n)return;let i=n.findIndex(r=>r.id===t);i!==-1&&n.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let n=this.handlers[e],i=this.handlers["*"];if(!n&&!i)return;let r=n?[...n]:[],a=i?[...i]:[];for(let c=0;c<r.length;c++)r[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var gs=class s{static{o(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let n=new s(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:o(()=>n,"get")}),n}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new Ia(this)),this._adapter}on(e,t=n=>{}){return this.adapter.on(e,t)}once(e,t=n=>{}){return this.adapter.once(e,t)}off(e,t=n=>{}){return this.adapter.off(e,t)}emit(e,t={}){let n={...t};return n.at===void 0&&(n.at=Date.now()),Object.freeze(n),this.adapter.emit(e,n)}};async function M2(s,e={}){let t=Object.entries(s.settings_config).map(([r,a])=>(a.setting||(a.setting=r),this.render_setting_html(a))).join(`
`),n=Object.entries(s.collections).map(([r,a])=>`<div data-smart-settings="${r}"></div>`).join(`
`);return`
<div class="">
${t}
${n}
</div>
`}o(M2,"build_html");async function Ky(s,e={}){let t=await M2.call(this,s,e),n=this.create_doc_fragment(t);return await z2.call(this,s,n,e)}o(Ky,"render");async function z2(s,e,t={}){await this.render_setting_components(e,{scope:s});let n=e.querySelectorAll("[data-smart-settings]");for(let i of n){let r=i.dataset.smartSettings;await s[r].render_settings(i)}return e}o(z2,"post_process");var La=class{static{o(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let n=new this(e,t);return await n.load(),e.smart_settings=n,Object.defineProperty(e,"settings",{get(){return n.settings},set(i){n.settings=i}}),n}static create_sync(e,t={}){let n=new this(e,t);return n.load_sync(),e.smart_settings=n,Object.defineProperty(e,"settings",{get(){return n.settings},set(i){n.settings=i}}),n}get settings(){return D2(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",R2(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function D2(s,e){let t=new WeakMap,n=new WeakMap,i=o((a,c)=>{if(!ym(a)||n.has(a))return a;if(t.has(a))return t.get(a);let l=r(a,c);return t.set(a,l),n.set(l,a),l},"wrap_value"),r=o((a,c)=>new Proxy(a,{set(l,d,_){let u=[...c,d],p=gm(l[d]),f=gm(_);return l[d]=i(_,u),F2(p,f)&&e({type:"set",path:u,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],u=gm(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:u}),!0}}),"create_proxy");return i(s,[])}o(D2,"observe_object");function R2(s){let e=Array.isArray(s.path)?s.path:[];return{type:s.type,path:e,path_string:e.join("."),value:s.value,previous_value:s.previous_value}}o(R2,"build_settings_changed_event");function gm(s){if(!ym(s))return s;if(typeof structuredClone=="function")try{return structuredClone(s)}catch{}try{return JSON.parse(JSON.stringify(s))}catch{return s}}o(gm,"snapshot_value");function F2(s,e){return Yy(s)!==Yy(e)}o(F2,"has_changed");function Yy(s){if(s===void 0)return"undefined";if(Number.isNaN(s))return"number:NaN";if(s===1/0)return"number:Infinity";if(s===-1/0)return"number:-Infinity";if(!ym(s))return`${typeof s}:${String(s)}`;try{return`object:${JSON.stringify(s)}`}catch{return`object:${String(s)}`}}o(Yy,"serialize_value");function ym(s){return typeof s=="object"&&s!==null}o(ym,"is_observable");function et(s={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Xy(e[t])&&Xy(s[t])?et(s[t],e[t]):s[t]=e[t]);return s}o(et,"deep_merge");function Xy(s){return s&&typeof s=="object"&&!Array.isArray(s)}o(Xy,"is_plain_object");function be(s=""){return s.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}o(be,"camel_case_to_snake_case");function Zy(s){return s.collections||(s.collections={}),s.modules||(s.modules={}),s.items||(s.items={}),Object.entries(s.collections).forEach(([e,t])=>{typeof t=="function"&&(s.collections[e]={class:t});let n=be(e);n!==e&&(s.collections[n]=s.collections[e],delete s.collections[e]),s.collections[n].collection_key||(s.collections[n].collection_key=n),t.item_type&&(s.items[t.item_type.key||be(t.item_type.name)]={class:t.item_type})}),Object.entries(s.modules).forEach(([e,t])=>{typeof t=="function"&&(s.modules[e]={class:t});let n=be(e);n!==e&&(s.modules[n]=s.modules[e],delete s.modules[e])}),s.item_types||(s.item_types={}),s.items||(s.items={}),Object.entries(s.item_types).forEach(([e,t])=>{if(typeof t=="function"){let n=be(e);s.items[n]={class:t,actions:{},...s.items[n]||{}}}}),s}o(Zy,"normalize_opts");function B2(s){if(!s||typeof s!="object")return!1;let e=Object.getPrototypeOf(s);return e===Object.prototype||e===null}o(B2,"is_plain_object");function Ma(s){if(Array.isArray(s))return s.map(e=>Ma(e));if(B2(s)){let e={};for(let[t,n]of Object.entries(s))e[t]=Ma(n);return e}return s}o(Ma,"deep_clone_config");function mn(s,e){let t=Qy(s),n=Qy(e),i=Math.max(t.parts.length,n.parts.length);for(let r=0;r<i;r++){let a=t.parts[r]!==void 0?t.parts[r]:0,c=n.parts[r]!==void 0?n.parts[r]:0;if(a>c)return 1;if(a<c)return-1}return t.type===n.type?0:t.type==="semver"&&n.type!=="semver"?1:n.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&n.type==="none"?t.parts[0]===0?0:1:n.type==="number"&&t.type==="none"?n.parts[0]===0?0:-1:0}o(mn,"compare_versions");function Qy(s){if(s==null)return{type:"none",parts:[0,0,0]};if(typeof s=="number"){if(!Number.isFinite(s))return{type:"none",parts:[0,0,0]};let e=Math.floor(s),t=Math.floor((s-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof s=="string"){let e=s.trim();if(!e)return{type:"none",parts:[0,0,0]};let n=e.split(".").map(i=>{let r=i.match(/^\d+/);if(!r)return 0;let a=Number.parseInt(r[0],10);return Number.isNaN(a)?0:a});for(;n.length<3;)n.push(0);return{type:"semver",parts:n}}return{type:"none",parts:[0,0,0]}}o(Qy,"normalize_version_value");function so(s){return s===null||typeof s!="object"||Array.isArray(s)||s instanceof Function||s instanceof Date?!1:Object.getPrototypeOf(s)===Object.prototype}o(so,"is_plain_object");function At(s,e,t=[]){if(!so(s)||!so(e)||t.includes(e))return s;t.push(e);for(let n of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,n))continue;let i=e[n];if(Array.isArray(s[n])&&Array.isArray(i))for(let r of i)if(typeof r=="function"){let a=r.name;s[n].some(l=>typeof l=="function"&&l.name===a)||s[n].push(r)}else(r===null||["string","number","boolean","undefined"].includes(typeof r))&&s[n].includes(r)||s[n].push(r);else so(i)?(so(s[n])||(s[n]={}),At(s[n],i,[...t])):Object.prototype.hasOwnProperty.call(s,n)||(s[n]=i)}return s}o(At,"deep_merge_no_overwrite");function ys(s,e){let t=s.version,n=e.version;for(let[i,r]of Object.entries(e)){if(i==="collections"&&r&&typeof r=="object"){s.collections||(s.collections={});for(let[a,c]of Object.entries(r)){let l=s.collections[a];if(!l){s.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(mn(d,_)>0){let p={...c};At(p,l),s.collections[a]=p}else At(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&r&&typeof r=="object"){s[i]||(s[i]={});for(let[a,c]of Object.entries(r)){if(!s[i][a]){s[i][a]={...c};continue}let l=s[i][a],d=c&&c.version,_=l&&l.version;mn(d,_)>0?(s[i][a]=c,s[i][a].version=d||-1):At(l,c)}continue}Array.isArray(r)?Array.isArray(s[i])?r.length>0&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="boolean")?s[i]=Array.from(new Set([...s[i],...r])):s[i]=[...s[i],...r]:r.length>0&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="boolean")?s[i]=Array.from(new Set(r)):s[i]=[...r]:r&&typeof r=="object"?(s[i]||(s[i]={}),At(s[i],r)):s[i]=r}return s}o(ys,"merge_env_config");function eb(s={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:n}=s;return(e!==void 0||t!==void 0||n!==void 0)&&(s.smart_sources=s.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!s.smart_sources?.file_exclusions?.length||s.smart_sources?.file_exclusions==="Untitled")&&(s.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!s.smart_sources.folder_exclusions?.length&&(s.smart_sources.folder_exclusions=t),n!==void 0&&n.length&&!s.smart_sources.excluded_headings?.length&&(s.smart_sources.excluded_headings=n)),delete s.file_exclusions,delete s.folder_exclusions,delete s.excluded_headings,s}o(eb,"migrate_exclusion_settings_2025_08_22");var U2=typeof globalThis<"u"?globalThis:Function("return this")(),no=class{static{o(this,"SmartEnv")}static version="2.2.8";scope_name="smart_env";static global_ref=U2;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=gs.create(this,G2(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([n])=>this.primary_main_key&&n===this.primary_main_key?-1:0);for(let[n,i]of t){if(!i?.main){console.warn(`SmartEnv: '${n}' unloaded, skipping`),delete this.smart_env_configs[n];continue}if(!i?.opts){console.warn(`SmartEnv: '${n}' opts missing, skipping`);continue}ys(this._config,Ma(Zy(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:n}=t||{};if(n)for(let[i,r]of Object.entries(n.collections||{})){let a=r?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:mn(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,W2(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let n=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(n),t(this.global_env))},1e3)}else{let n=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(n),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let n={};this.global_env&&mn(this.version,this.global_env.constructor?.version||0)>0&&(n.primary_main_key=be(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(n);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let n=be(e.constructor.name);this.smart_env_configs[n]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:o(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await La.create(this),this.config.default_settings&&At(this.settings,this.config.default_settings),eb(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:n}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let n=e.collections[t]?.class;n&&(n.default_settings&&At(this.settings,{[t]:n.default_settings}),typeof n.init=="function"&&(await n.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((n,i)=>{let r=this.config.collections?.[n]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return r-a});for(let n of t){let i=Date.now();typeof this[n]?.process_load_queue=="function"&&(await this[n].process_load_queue(),this[n].load_time_ms=Date.now()-i,this.collections[n]="loaded",console.log(`Loaded ${this[n].collection_key} in ${this[n].load_time_ms}ms`))}}static unload_main(e){let t=be(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let n=this.opts.modules[e];return n?(t={...n,class:null,...t},new n.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||Ky}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,n={}){let i=this.get_component(e,t);return i?await i(t,n):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let n=t.collection_key??t.scope_name,i=n?`${n}-${e}`:e;if(!this._components[i])try{if(this.opts.components[n]?.[e]){let r=this.opts.components[n][e],a=r.render||r;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let r=this.opts.components[e],a=r.render||r;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${n}`)}catch(r){console.error("Error getting component",r),console.log(`scope_name: ${n}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[n]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.config.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(n=>n.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let n=e.map(i=>{let r=i.split("/").slice(-2,-1)[0];return{dir:r,count:this.fs.file_paths.filter(a=>a.includes(r)).length}});t=n.reduce((i,r)=>r.count>i.count?r:i,n[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(et(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(n=>n.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((n,i,r)=>r.indexOf(n)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function W2(s){return{items:Object.fromEntries(Object.entries(s.items||{}).map(([e,t])=>[e,t.data]))}}o(W2,"collection_to_plain");function G2(s){if(!s)return{};if(typeof s=="function")return{adapter_class:s};let e=s.adapter_class||s.adapter;return e?{adapter_class:e}:{}}o(G2,"build_events_opts");function H2(s,{case_sensitive:e,extended_glob:t,windows_paths:n}){let i=V2(s,t),r=J2(i,n),a=e?"":"i";return new RegExp(`^${r}$`,a)}o(H2,"create_regex");function J2(s,e){return e?s.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):s}o(J2,"adjust_for_windows_paths");function V2(s,e){let t=!1,n=0,i="";for(let r=0;r<s.length;r++){let a=s[r];switch(a){case"\\":r+1<s.length?(i+=`\\${s[r+1]}`,r++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||s.indexOf("]",r+1)===-1?i+="\\[":(t=!0,s[r+1]==="!"?(i+="[^",r++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||s.indexOf("}",r+1)===-1?i+="\\{":(n++,i+="(");break;case"}":!t&&n>0?(n--,i+=")"):i+="\\}";break;case",":!t&&n>0?i+="|":i+=",";break;case"*":t?i+="\\*":r+1<s.length&&s[r+1]==="*"?(i+=".*",r++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}o(V2,"glob_to_regex_pattern");function tb(s,e={}){let n={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return s===""?/^$/:s==="*"&&!n.windows_paths?/^[^/]+$/:s==="**"&&!n.windows_paths?/^.+$/:H2(s,n)}o(tb,"glob_to_regex");function sb(s,e){let t=[];for(let n=0;n<s.length;n++){let i=e.toLowerCase().split(""),r=!0,a=0,c=s[n],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{r=!1;break}}r&&t.push({name:c,distance:a})}return t.sort((n,i)=>n.distance-i.distance),t.map(n=>n.name)}o(sb,"fuzzy_search");var za=class{static{o(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(n=>this.add_ignore_pattern(n)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(tb(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...n){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...n);return this.post_process(i)}use_adapter_sync(e,t,...n){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...n);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(n){return console.warn("Error during read: "+n.message,e),n.code==="ENOENT"?null:{error:n.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(n){throw console.error("Error during write:",n),n}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let n=this.file_paths.filter(i=>i.includes(e));return sb(n,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var K2=Y(require("obsidian"),1);var Da=class{static{o(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=K2,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:o(()=>{let n=this.obsidian_app.vault.getAbstractFileByPath(e);return n?{ctime:n.stat.ctime,mtime:n.stat.mtime,size:n.stat.size,isDirectory:o(()=>n instanceof this.obsidian.TFolder,"isDirectory"),isFile:o(()=>n instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let r=i.path.lastIndexOf("/");return!(r===-1&&e!==""||i.path.slice(0,r)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,n={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!n.no_cache){let r=this.obsidian_app.vault.getFileByPath(e);if(r)return await this.obsidian_app.vault.cachedRead(r)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let r=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(r)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let n=e.split("/").slice(0,-1).join("/");return await this.exists(n)||(await this.mkdir(n),console.log(`Created folder: ${n}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:n}=t,i=o((r,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(r,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(n.vault.on("create",r=>{i("sources:created",{path:r.path,event_source:"obsidian:vault.create"})})),t.registerEvent(n.vault.on("modify",r=>{i("sources:modified",{path:r.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(n.vault.on("rename",(r,a)=>{i("sources:renamed",{path:r.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(n.vault.on("delete",r=>{i("sources:deleted",{path:r.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(n.workspace.on("editor-change",(r,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function Ra(s){let e=document.createRange();e.selectNodeContents(s),e.deleteContents()}o(Ra,"empty");var nb=(()=>{let s=new Map;return(e,t)=>{let n=t.trim(),i=s.get(n);i||(i=document.createElement("template"),i.innerHTML=n,s.set(n,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var ib=o((s,e)=>{let n=document.createRange().createContextualFragment(e.trim());s.replaceChildren(n)},"replace_with_fragment");var Y2=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,Fa=o((s,e)=>{let t=e.trim();(Y2.test(t)?ib:nb)(s,t)},"safe_inner_html");function Re(s=""){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}o(Re,"escape_html");function ob(s,e=0){let t=s.length&3,n=s.length-t,i=e,r=3432918353,a=461845907,c=0,l=0,d=0;for(;c<n;)d=s.charCodeAt(c)&255|(s.charCodeAt(c+1)&255)<<8|(s.charCodeAt(c+2)&255)<<16|(s.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=pn(l,r),l=bm(l,15),l=pn(l,a),i^=l,i=bm(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(s.charCodeAt(c+2)&255)<<16;case 2:l^=(s.charCodeAt(c+1)&255)<<8;case 1:l^=s.charCodeAt(c)&255,l=pn(l,r),l=bm(l,15),l=pn(l,a),i^=l;break}return i^=s.length,i=X2(i),i|0}o(ob,"murmur_hash_32");function te(s,e=0){return(ob(s,e)>>>0).toString(36)}o(te,"murmur_hash_32_alphanumeric");function pn(s,e){return(s&65535)*e+((s>>>16)*e<<16)|0}o(pn,"multiply_32");function bm(s,e){return s<<e|s>>>32-e}o(bm,"rotate_left_32");function X2(s){return s^=s>>>16,s=pn(s,2246822507),s^=s>>>13,s=pn(s,3266489909),s^=s>>>16,s|0}o(X2,"fmix_32");function vm(s){let e=Date.now(),t=s<1e12?s*1e3:s,n=e-t,i=n<0,r=Math.floor(Math.abs(n)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(r/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}o(vm,"convert_to_time_ago");function bs(s=[],e=[]){if(s.length!==e.length)throw new Error("Vectors must have the same length");let t=0,n=0,i=0,r=1e-8;for(let a=0;a<s.length;a++)t+=s[a]*e[a],n+=s[a]*s[a],i+=e[a]*e[a];return n=Math.sqrt(n),i=Math.sqrt(i),n<r||i<r?0:t/(n*i)}o(bs,"cos_sim");function Ae(s,e,t=null){if(!e)return"";let n=e.split(".");t&&n.unshift(t);let i=n.pop(),r=n.reduce((a,c)=>a&&a[c],s);return r&&typeof r[i]=="function"?r[i].bind(r):r?r[i]:void 0}o(Ae,"get_by_path");function Se(s,e,t,n=null){let i=e.split(".");n&&i.unshift(n);let r=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),s);a[r]=t}o(Se,"set_by_path");function km(s,e,t=null){let n=e.split(".");t&&n.unshift(t);let i=n.pop(),r=n.reduce((a,c)=>a&&a[c],s);r&&delete r[i]}o(km,"delete_by_path");function wm(s){if(!s||s.length===0)return null;let e=s.length,t=s[0].length,n=new Float64Array(t);for(let i=0;i<e;i++){let r=s[i];for(let a=0;a<t;a++)n[a]+=r[a]}for(let i=0;i<t;i++)n[i]/=e;return Array.from(n)}o(wm,"compute_centroid");function xm(s){if(!s||s.length===0)return null;if(s.length===1)return s[0];let e=s.length,t=s[0].length,n=new Float64Array(e);for(let a=0;a<e-1;a++){let c=s[a];for(let l=a+1;l<e;l++){let d=s[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);n[a]+=u,n[l]+=u}}let i=0,r=n[0];for(let a=1;a<e;a++)n[a]<r&&(r=n[a],i=a);return s[i]}o(xm,"compute_medoid");var Z2=o(s=>typeof s!="string"?null:`style-sheet-${te(s)}`,"get_style_sheet_id"),Ba=new WeakMap,Ua=new WeakMap,Wa=class{static{o(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let n=e.querySelectorAll(".setting-component"),i=[];for(let r of n)i.push(this.render_setting_component(r,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,n=null){return Ae(e,t,n)}set_by_path(e,t,n,i=null){Se(e,t,n,i)}delete_by_path(e,t,n=null){km(e,t,n)}escape_html(e){return Re(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([n,i])=>n.includes("class")?"":typeof i=="number"?`data-${n.replace(/_/g,"-")}=${i}`:`data-${n.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),r=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(r,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let r=i.dataset.smartSetting;if(!r||Ua.has(i))return;let a=o(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,r,c)},"handler");Ua.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=Ua.get(i);c&&(i.removeEventListener("change",c),Ua.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=Z2(e);if(!t||document.getElementById(t))return;let n=document.createElement("style");n.id=t,n.textContent=e,document.head.appendChild(n);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(n=>n.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){Ra(e)}safe_inner_html(e,t){Fa(e,t)}attach_disposer(e,t){if(!e)return;let n=e.ownerDocument,i=n&&n.defaultView,r=i&&i.MutationObserver;if(!n||!i||!r||!n.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=Ba.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},Ba.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new r(()=>{if(n.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}Ba.get(e)===c&&Ba.delete(e)}}});c.observer=l,l.observe(n.body,{childList:!0,subtree:!0})}}};var Ga=class{static{o(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,n,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,n,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,n){}post_change(e,t,n){}revert_setting(e,t,n){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let n=e.dataset.setting,i=t.scope||this.main.main,r=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,n,r);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,n,a,r));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,n,a,i,r);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,n,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:n,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,n,i,r){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===n,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(n)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===n,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(n)),l.onChange(_=>{this.handle_on_change(t,_,e,i,r)})}),a}render_text_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,r),2e3)})}),a}render_password_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_number_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof n<"u"&&(c.inputEl.value=parseInt(n)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,r),2e3)})}),a}render_toggle_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addToggle(c=>{let l=n??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,r))}),a}render_textarea_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(n||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_textarea_array_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(n)?n.join(`
`):n||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_button_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,n,e,i,r)}})}),a}render_remove_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,r),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,n,e,i,r)}})}),a}render_folder_select_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,n,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,r)})}),a}render_file_select_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,n,e,i,r)})}),a}render_slider_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof n<"u"?parseFloat(n):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,r)})}),a}render_html_component(e,t,n,i){return this.safe_inner_html(e,n),e}render_array_component(e,t,n,i,r){let a=new this.setting_class(e),c=Array.isArray(n)?[...n]:[],l=document.createElement("div");l.className="array-items-container";let d=o(()=>{l.innerHTML="",c.forEach((y,g)=>{let k=document.createElement("div");k.className="array-item-row";let v=document.createElement("input");v.type="text",v.value=y,v.placeholder="Value";let b=document.createElement("button");b.textContent="\u2715",b.title="Remove",v.addEventListener("change",()=>{c[g]=v.value,f()}),b.addEventListener("click",()=>{c.splice(g,1),d(),f()}),k.appendChild(v),k.appendChild(b),l.appendChild(k)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=u.value.trim();y&&(c.push(y),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=o(()=>{this.handle_on_change(t,[...c],e,i,r)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,n,i,r){try{let a=new this.setting_class(e),c=typeof n=="object"&&n!==null?{...n}:{},l=document.createElement("div");l.className="json-pairs-container";let d=o(()=>{l.innerHTML="",Object.entries(c).forEach(([g,k],v)=>{let b=document.createElement("div");b.className="json-pair-row";let A=document.createElement("input");A.type="text",A.value=g,A.placeholder="Property";let S=document.createElement("input");S.type="text",S.value=k,S.placeholder="Value";let $=document.createElement("button");$.textContent="\u2715",$.title="Remove",A.addEventListener("change",()=>{let j=A.value.trim();j&&j!==g&&(c[j]=c[g],delete c[g],d(),y())}),S.addEventListener("change",()=>{c[A.value]=S.value,y()}),$.addEventListener("click",()=>{delete c[A.value],d(),y()}),b.appendChild(A),b.appendChild(S),b.appendChild($),l.appendChild(b)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),y())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=o(()=>{this.handle_on_change(t,{...c},e,i,r)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,n,i){t.dataset.btn&&e.addButton(r=>{r.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&r.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](n,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(n,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(r.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[n,i])=>{if(!n.startsWith("option"))return t;let[r,a]=i.split("|");return t.push({value:r,name:a||r}),t},[])}handle_on_change(e,t,n,i,r){if(this.pre_change(e,t,n,i),n.dataset.validate&&!this[n.dataset.validate](e,t,n,i)){n.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,n,i);return}if(this.main.set_by_path(i.settings,e,t,r),n.dataset.callback){let a=this.main.get_by_path(i,n.dataset.callback);a&&a(e,t,n,i)}this.post_change(e,t,n,i)}render_button_with_confirm_component(e,t,n,i){let r=new this.setting_class(e);return r.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,n,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),r}empty(e){Ra(e)}safe_inner_html(e,t){Fa(e,t)}};var tt=require("obsidian");var Ha=class extends Ga{static{o(this,"SmartViewObsidianAdapter")}get setting_class(){return tt.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,n){return super.render_text_component(e,t,n)}async render_markdown(e,t){let n=t.env.smart_connections_plugin?.connections_view||new tt.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),r=i.querySelector(".inner");try{await tt.MarkdownRenderer.render(t.env.plugin.app,e,r,t?.file_path||"",n)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,tt.getIcon)(e).outerHTML}is_mod_event(e){return tt.Keymap.isModEvent(e)}render_folder_select_component(e,t,n,i,r){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,r)}),l.setValue(n)}),a}};function Ja(s){return s.endsWith("Item")?s.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():s.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}o(Ja,"collection_instance_name_from");function rb(s){let e=JSON.stringify(s),t=0;if(e.length===0)return t;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}o(rb,"create_uid");function Va(s,e,t=new WeakMap){if(s===e)return!0;if(s===null||e===null||s===void 0||e===void 0||typeof s!=typeof e||Array.isArray(s)!==Array.isArray(e))return!1;if(Array.isArray(s))return s.length!==e.length?!1:s.every((n,i)=>Va(n,e[i],t));if(typeof s=="object"){if(t.has(s))return t.get(s)===e;t.set(s,e);let n=Object.keys(s),i=Object.keys(e);return n.length!==i.length?!1:n.every(r=>Va(s[r],e[r],t))}return s===e}o(Va,"deep_equal");function Ka(s,e){return e?s.split("/").join(" > ").replace(".md",""):s.split("/").pop().replace(".md","")}o(Ka,"get_item_display_name");function Ya(s,e){let t=e||{},n=o(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=o(m=>typeof m=="function","is_function"),r=o(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=o(m=>n(m)&&i(m.action),"is_action_object"),c=o(m=>i(m)||a(m)||r(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=o(m=>{if(!n(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let O=Object.getOwnPropertyDescriptor(m,w);if(!O)continue;let E={...O};"value"in E&&n(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=o(m=>{if(!n(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let O of h){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E){let q=E.value;if(c(q)){w=!0;continue}if(n(q)){if(_(q)){w=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=o(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=n(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=o(m=>{let h=Object.create(null),w=new Map;for(let O of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E&&_(E.value)){w.set(O,d(E.value));continue}try{Object.defineProperty(h,O,u(E))}catch{h[O]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=o((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=o((m,h,w=[])=>{if(!m||!h)return;let O=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(O.has(E))continue;let q=Object.getOwnPropertyDescriptor(m,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),b=o(m=>{let h=new m(s),w=h.action||h.run||h.execute||h.call;if(i(w)){let O=w.bind(h);return v(m,O),v(h,O),O.instance=h,O}return v(m,h),h},"instantiate_class"),A=o(m=>{if(r(m))return b(m);if(a(m)){let h=m.action.bind(s);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(s);return v(m,h),h}return n(m)?d(m):m},"bind_or_clone"),S=o(()=>{let m=s?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&n(h)?h:null},"scope_actions_for"),$=o((m,h,w)=>(m[h]=w,w),"cache_result"),j=o((m,h)=>{let w=S();return w&&g(w,h)?$(m,h,A(w[h])):g(f,h)?$(m,h,A(f[h])):$(m,h,void 0)},"compute_and_cache"),C=o(()=>{let m=S(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=o((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:o((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:o((m,h)=>{if(h in m)return!0;let w=S();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:o(()=>C(),"ownKeys"),getOwnPropertyDescriptor:o((m,h)=>{if(g(m,h))return x(m,h);let w=S();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:o((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:o((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:o((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}o(Ya,"create_actions_proxy");var se=class s{static{o(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&et(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let n=new this(e,t);return n.init(),n}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let n=e.defaults[t];typeof n=="object"?this[t]={...n,...this[t]}:this[t]=this[t]===void 0?n:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return rb(this.data)}update_data(e){let t=this.sanitize_data(e),n={...this.data};return et(n,t),!Va(this.data,n)?(this.data=n,!0):!1}sanitize_data(e){return e instanceof s?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,n)=>(t[n]=this.sanitize_data(e[n]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:n=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:r,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(n?.includes(this.key)||i&&this.key.startsWith(i)||r&&r.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Ya(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Ja(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Ja(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),be(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}once_event(e,t){return this.env.events?.once(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Ka(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var Q2=Object.getPrototypeOf(async function(){}).constructor,ne=class{static{o(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),n=t||new this.item_type(this.env);n._queue_save=!t;let i=n.update_data(e);return!t&&!n.validate_save()?n:(t||this.set(n),t&&!i?t:n.init instanceof Q2?new Promise(r=>{n.init(e).then(()=>r(n))}):(n.init(e),n))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),n=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return et(t.data,n),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:n}=e;for(let i of Object.values(this.items)){if(n&&t.length>=n)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let n=this.filter(e);return n[Math.floor(Math.random()*n.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(n=>n.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],n=e+"_adapter",i=t?.[n]??this.env.opts.collections?.smart_collections?.[n];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,n)=>{let i=t?.class?.version||t.version||0;return(n?.class?.version||n.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let n=o(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[r,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=n(c.callback)),c.btn_callback&&(c.btn_callback=n(c.btn_callback)),c.options_callback&&(c.options_callback=n(c.options_callback));let l=n(this.process_setting_key(r));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.collection_key&&n.collection_key!==this.collection_key||t(n)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Ya(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let n=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(n),e}};var Xa=class{static{o(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},Za=class{static{o(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function Qa(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.min===Number.POSITIVE_INFINITY){let{minScore:n,minObj:i}=ab(s.results);s.min=n,s.minResult=i}}else if(e.score>s.min){s.results.add(e),s.results.delete(s.minResult);let{minScore:n,minObj:i}=ab(s.results);s.min=n,s.minResult=i}}o(Qa,"results_acc");function lb(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.max===Number.NEGATIVE_INFINITY){let{maxScore:n,maxObj:i}=cb(s.results);s.max=n,s.maxResult=i}}else if(e.score<s.max){s.results.add(e),s.results.delete(s.maxResult);let{maxScore:n,maxObj:i}=cb(s.results);s.max=n,s.maxResult=i}}o(lb,"furthest_acc");function ab(s){let e=Number.POSITIVE_INFINITY,t=null;for(let n of s)n.score<e&&(e=n.score,t=n);return{minScore:e,minObj:t}}o(ab,"find_min");function cb(s){let e=Number.NEGATIVE_INFINITY,t=null;for(let n of s)n.score>e&&(e=n.score,t=n);return{maxScore:e,maxObj:t}}o(cb,"find_max");function Fe(s,e){let n=s.score-e.score;return Math.abs(n)<1e-9?0:n>0?-1:1}o(Fe,"sort_by_score");function ec(s,e){return Fe(s,e)}o(ec,"sort_by_score_descending");function db(s,e){return Fe(s,e)*-1}o(db,"sort_by_score_ascending");var tc=class extends Xa{static{o(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:n=50}=t,i=this.collection.filter(t).reduce((r,a)=>{if(!a.vec)return r;let c={item:a,score:bs(e,a.vec)};return Qa(r,c,n),r},{min:0,results:new Set});return Array.from(i.results).sort(ec)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:n=50}=t,i=this.collection.filter(t).reduce((r,a)=>{if(!a.vec)return r;let c={item:a,score:bs(e,a.vec)};return lb(r,c,n),r},{max:0,results:new Set});return Array.from(i.results).sort(db)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(n=>n.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((n,i)=>{let r=e[i];r.vec=n.vec,r.data.last_embed=r.data.last_read,n.tokens!==void 0&&(r.tokens=n.tokens),r.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(n=>setTimeout(n,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let n=0;n<t.length;n+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(n,n+this.collection.embed_model.batch_size);await Promise.all(i.map(r=>r.get_embed_input()));try{let r=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-r}catch(r){r&&r.message&&r.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(r),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(r||{},null,2))}i.forEach(r=>{r.embed_hash=r.read_hash,r._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((r,a)=>r+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},sc=class extends Za{static{o(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var eq="---frontmatter---",_b=o(s=>Array.isArray(s)?s.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof s=="string"?(s.includes(",")?s.split(","):[s]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),tq=o((s,e={})=>({...s.env.settings.smart_view_filter||{},...e,entity:s}),"merge_settings_with_params"),sq=o(s=>{let e={...s};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),nq=o(s=>{if(!s.exclude_frontmatter_blocks)return s;let e={...s},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(eq),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),iq=o((s,e)=>{if(!e)return s;let t={...s},n=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(n.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&n.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(n=[...n,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(n=[...n,...e.outlinks.map(r=>r.key)]),n.length&&(t.exclude_key_starts_with_any=n),t.exclude_filter){let r=_b(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...r]}if(t.include_filter){let r=_b(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...r]}return t},"append_entity_filters"),Em=o((s,e={})=>{let t=tq(s,e),n=sq(t),i=nq(n);return iq(i,s)},"create_find_connections_filter_opts");async function hn(s={}){let e=s.filter?.limit||s.limit||this.env.settings.smart_view_filter?.results_limit||10,t=Em(this,s);s.filter?.limit&&delete s.filter.limit,s.limit&&delete s.limit;let n=this.key+te(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[n]){let i=(await this.nearest(t)).sort(Fe).slice(0,e);this.connections_to_cache(n,i)}return this.connections_from_cache(n)}o(hn,"find_connections");hn.action_type="connections";var vs=class extends se{static{o(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new sc(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var ks=class extends ne{static{o(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new tc(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let n=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let r={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await n.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,r)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(Fe).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return ub}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let n=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(n),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return oq}},ub={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},oq={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function Am(s={}){let e=this.env.settings.smart_view_filter,t=s.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,n=s.filter?.limit||s.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await hn.call(this,s);let r=Em(this,s);if(s.filter?.limit&&delete s.filter.limit,s.limit&&delete s.limit,!t){let a=this.key+te(JSON.stringify({...r,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,r)).sort(Fe).slice(0,n);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Fe).slice(0,n)}return i}o(Am,"find_connections");Am.action_type="connections";var fn=class extends vs{static{o(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let n of t)await n(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let r=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)r[d]=""}),e=r.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),n=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(n*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[n,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let r=this.block_collection.get(this.key+n);if(r?.vec)return r}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:n="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let r=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=r.filter(_=>l.includes(_)||c.includes(_));return n==="all"?d.length===r.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(n){console.error(`Error during update for ${this.key}:`,n)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(n){console.error(`Error during merge for ${this.key}:`,n)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;if(typeof t!="string"||t.startsWith("http"))return null;let n=this.fs.get_link_target_path(t,this.file_path);return{...e,key:n,embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=wm(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=xm(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},mb={class:fn,actions:{find_connections:Am}};var io=class extends ks{static{o(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,n])=>this.env.events.on(t,n)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let n=this.init_file_path(t)||this.get(t);if(!n){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(n,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let n=this.get(t);if(n||(n=this.init_file_path(t)),!n){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(n,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),n=e.old_path||e.from;if(!t&&!n||(n&&this.items[n]&&(this.items[n]?.delete?.(),delete this.items[n],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:n}]of e){if(await n.import(),this._embed_queue||(this._embed_queue=[]),n.should_embed&&this._embed_queue.push(n),this.block_collection?.settings?.embed_blocks)for(let i of n.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let n=new this.item_type(this.env,{path:e});return this.items[e]=n,n.queue_import(),n.queue_load(),n}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let n;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;n=t.shift()}return n}build_links_map(){let e=Date.now();this.links={};for(let n of Object.values(this.items))for(let i of n.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][n.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let n=await this.create_or_update({path:e});return await n.import(),n}async search(e={}){let{keywords:t,limit:n,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let r=this.filter(i),a=[];for(let c=0;c<r.length;c+=10){let l=r.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let r=await i.lookup(e);return r.error?(console.warn(r.error),[]):r.slice(0,t)}}let n=await super.lookup(e);return n.error?(console.warn(n.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(n=[...n,...await this.block_collection.lookup(e)].sort(Fe)),n.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:n=!1}=e;n&&Object.values(this.items).forEach(r=>r._queue_import=!0);let i=Object.values(this.items).filter(r=>r._queue_import);if(console.log("import_queue "+i.length),i.length){let r=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-r)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((n,[i,r])=>(r.extensions?r.extensions?.forEach(a=>n[a]=r):typeof r.detect_type=="function"&&(n[i]=r),n),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(rq),...Object.entries(this.source_adapters).reduce((t,[n,i])=>{if(t[i])return t;let r=this.items[Object.keys(this.items).find(c=>c.endsWith(n))],a=new i(r||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,n)=>((n._queue_embed||n.should_embed&&n.is_unembedded)&&t.push(n),e&&n.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((n,i)=>(n[i]=this.env.fs.files[i],n),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((n,i)=>(n[i]=this.env.fs.folders[i],n),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(n=>t.endsWith(n))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},rq={};var nc=class{static{o(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=oo;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},oo=class{static{o(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var ic=class extends nc{static{o(this,"FileCollectionDataAdapter")}ItemDataAdapter=ro;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},ro=class extends oo{static{o(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var pb={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Mt=class extends ic{static{o(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=St;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let n=100;for(let i=0;i<e.length;i+=n){let r=e.slice(i,i+n);await Promise.all(r.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(r=>r._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),n=50;for(let r=0;r<e.length;r+=n){let a=e.slice(r,r+n);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(r=>r.deleted);i.length&&i.forEach(r=>{delete this.collection.items[r.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,n=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${n}`)}: ${i},`}},St=class extends ro{static{o(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:n}=this._parse(e);t&&(n.length?await this.fs.write(this.data_path,n):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let n=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",r=JSON.parse(i),a=Object.entries(r);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete r[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,r[_+":"+u]=d,delete r[l]);let f=this.env[_];if(!f)continue;let y=f.get(u);if(d.key||(d.key=u),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,k=new g(this.env,d);k._queue_load=!1,k.loaded_at=Date.now(),f.set(k)}}return(t||n>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(r).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(n=>!n.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(n=>n.endsWith(",")?n:n+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[n,...i]=e.split(":");return pb[n]&&(n=pb[n],t=!0),{collection_key:n,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let n=this.collection_adapter.collection.data_dir;return await this.fs.exists(n)||await this.fs.mkdir(n),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var ao=class extends Mt{static{o(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=Sm},Sm=class extends St{static{o(this,"AjsonMultiFileSourceDataAdapter")}};var oc=class{static{o(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return te(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return hb(this.constructor.name)}static get adapter_key(){return hb(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function hb(s){return s[0].toLowerCase()+s.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}o(hb,"to_snake");function rc(s,e={}){let{start_index:t=1,line_keys:n=!1}=e,i=s.split(`
`),r=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},y=null,g=null,k=!1,v=!1,b="#",A=!1,S=[],$=null;_[b]=0;for(let C=0;C<i.length;C++){let x=C+t,m=i[C],h=m.trim();if(h==="---"){if(!v&&x===1){v=!0,k=!0,l["#---frontmatter---"]=[x,null];continue}else if(k){k=!1,l["#---frontmatter---"][1]=x;continue}}if(k)continue;if(!A&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(x)),h.startsWith("```")){if(A=!A,A&&!$?$=x:!A&&$&&(S.push([$,x]),$=null),!g){let E=c.length>0?c[c.length-1].key:b;if(E===b&&!l[b]&&(l[b]=[x,null]),E===b)g={key:b,start_line:x},(l[b][1]===null||l[b][1]<x)&&(l[b][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],N=`${E}#{${q}}`;l[N]=[x,null],g={key:N,start_line:x}}}continue}let w=h.match(/^(#{1,6})\s*(.+)$/);if(w&&!A){let E=w[1].length,q=w[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=x-1)}c.length===0&&l[b]&&l[b][1]===null&&(l[b][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let N="",L=0;if(c.length>0?(N=c[c.length-1].key,L=c[c.length-1].level):(N="",L=0),c.length===0)d[q]=(d[q]||0)+1,d[q]>1&&(q+=`[${d[q]}]`);else{u[N]||(u[N]={}),u[N][q]=(u[N][q]||0)+1;let X=u[N][q];X>1&&(q+=`#{${X}}`)}let me=E-L,ge="#".repeat(me),ye=N+ge+q;l[ye]=[x,null],_[ye]=0,c.push({level:E,title:q,key:ye});continue}let O=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(O&&!A){if(O[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null),g&&g.key!==b&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let q=c.length>0?c[c.length-1].key:b;q===b&&!l[b]&&(l[b]=[x,null]),_[q]===void 0&&(_[q]=0),_[q]+=1;let N=_[q],L;if(n){let me=O[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=aq(me,r);L=`${q}#${ge}`}else L=`${q}#{${N}}`;l[L]=[x,null],y={key:L,start_line:x};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let E=c.length>0?c[c.length-1].key:b;if(E===b)l[b]||(l[b]=[x,null]),(l[b][1]===null||l[b][1]<x)&&(l[b][1]=null),g={key:b,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],N=`${E}#{${q}}`;l[N]=[x,null],g={key:N,start_line:x}}}}let j=i.length;for(;c.length>0;){let C=c.pop();l[C.key][1]===null&&(l[C.key][1]=j+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=j+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=j+t-1),g=null),l[b]&&l[b][1]===null&&(l[b][1]=j+t-1);for(let C in l)a[C]=l[C];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:S}}o(rc,"parse_markdown_blocks");function aq(s,e=3){return s.split(/\s+/).sort((n,i)=>i.length-n.length).slice(0,e).sort((n,i)=>s.indexOf(n)-s.indexOf(i)).join(" ")}o(aq,"get_longest_words_in_order");var st=class extends oc{static{o(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let n=e.init_file_path(t.path);n&&(n.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),n=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,n=!0)}else n=!0;return n?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:n="append_blocks"}=t,{blocks:i,task_lines:r}=rc(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);n==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let n=[],i=[],r=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){n.push({key:u,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let k=this.item.block_collection.get(u);if(await this.create_hash(p)!==k.last_read?.hash){r.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:n,new_with_parent_blocks:i,changed_blocks:r,same_blocks:a}}async append(e){let n=[await this.read(),"",e].join(`
`).trim();await this.update(n)}get size(){return this.item.file?.stat?.size||0}};function zt(s){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,n=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=o(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),r=o(c=>c<=0?!1:s[c-1]==="!","is_embedded"),a;for(;(a=t.exec(s))!==null;){let c=a[1],l=i(a[2]),d=s.slice(0,a.index).split(`
`).length,_=r(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=n.exec(s))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=s.slice(0,a.index).split(`
`).length,u=r(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}o(zt,"get_markdown_links");function ac({source:s,links:e=[],cache:t}={}){if(!s||!Array.isArray(e)||!e.length)return[];let n=t||s?.env?.bases_caches?.items;if(!n)return[];let i=s?.key||s?.path;return i?e.flatMap(r=>{if(!r?.embedded)return[];if(typeof r.target!="string"||!r.target.includes(".base"))return[];let a=`${i}#${r.target}`,c=n?.[a]?.markdown_table;if(!c)return[];let l=zt(c);return l.length?l.map(d=>({...d,line:r.line,bases_row:d.line-2})):[]}):[]}o(ac,"get_bases_cache_links");function Cm(s){let e=s.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}o(Cm,"parse_value");function cq(s){let e=s.split(/\r?\n/),t={},n=0;for(;n<e.length;){let i=e[n];if(n++,!i.trim()||i.trim().startsWith("#"))continue;let r=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!r)continue;let a=r[1].trim(),c=r[2].trim();if(c===">"||c==="|"){let l=[];for(;n<e.length;){let _=e[n];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),n++}let d=l.join(`
`);t[a]=Cm(d)}else if(c===""){let l=[],d=!1;for(;n<e.length;){let _=e[n];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(Cm(u)),n++,d=!0}d?t[a]=l:t[a]=""}else t[a]=Cm(c)}return t}o(cq,"parse_yaml_block");function fb(s){if(!s.startsWith("---"))return{frontmatter:{},body:s};let e=s.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:s};let i=e.slice(1,t).join(`
`),r=cq(i),c=e.slice(t+1).join(`
`);return{frontmatter:r,body:c}}o(fb,"parse_frontmatter");var gb=o((s="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,n;for(;(n=e.exec(s))!==null;)t.add(`#${n[1]}`);return[...t]},"get_markdown_tags");var co=class extends st{static{o(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:n}=this.item.file.stat;this.data.last_import={mtime:t,size:n,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let n=await this.get_metadata(e);this.data.metadata=n}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=zt(e),n=ac({source:this.item,links:t});return[...t,...n]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:n}=fb(e),i=new Set,r=t.tags;return typeof r=="string"&&(r=r.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(r)&&r.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),gb(n).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Dt=require("obsidian");function lq(s,e=[]){let t=new Set;return typeof s=="string"&&(s=s.replace(/[\[\]]/g,"").split(",").map(n=>n.trim()).filter(Boolean)),Array.isArray(s)&&s.forEach(n=>t.add(n.startsWith("#")?n:`#${n}`)),e.forEach(({tag:n})=>t.add(n)),[...t]}o(lq,"merge_tags");var ws=class extends co{static{o(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},n=lq(t.frontmatter?.tags,t.tags);return t.frontmatter?(n.length&&(t.frontmatter.tags=n),t.frontmatter):n.length?{tags:n}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let n=this.item.env.main.app;if(!n||!Dt.MarkdownRenderer||!Dt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Dt.MarkdownRenderer.render(n,t,i,this.item.path,new Dt.Component);let r=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=r!==i.innerHTML,r=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Dt.htmlToMarkdown)(i)}};var cc=class extends st{static{o(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var lc=class extends st{static{o(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function dq({content:s}={}){if(!s)return null;try{return JSON.parse(s)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}o(dq,"parse_canvas_json");function yb({target:s,title:e}={}){return s?{title:e||s,target:s,line:1}:null}o(yb,"build_link_record");function _q({node:s}={}){if(!s||typeof s!="object")return[];if(s.type==="text"&&typeof s.text=="string")return zt(s.text);if(s.type==="file"&&typeof s.file=="string"){let e=typeof s.subpath=="string"?s.subpath:"",t=`${s.file}${e}`,n=yb({target:t,title:s.file});return n?[n]:[]}if(s.type==="link"&&typeof s.url=="string"){let e=yb({target:s.url,title:s.url});return e?[e]:[]}return[]}o(_q,"get_canvas_node_links");function uq({nodes:s=[]}={}){return Array.isArray(s)?s.reduce((e,t)=>(e.push(..._q({node:t})),e),[]):[]}o(uq,"get_canvas_links_from_nodes");function mq({content:s}={}){let e=dq({content:s});return e?.nodes?uq({nodes:e.nodes}):[]}o(mq,"get_canvas_links");var dc=class extends st{static{o(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=mq({content:e});let t=this.item.file?.stat,n=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:n,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var _c=class extends ws{static{o(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),n="# Text Elements",i="# Drawing",r=t.indexOf(n),a=t.indexOf(i);if(r===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(r+n.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function bb(s,e){let[t,...n]=s.split("#").filter(Boolean),i=Ka(t,e);if(e)return[i,...n].join(" > ");let r=n.findLast(a=>a&&a[0]!=="{");return[i,r].join(" > ")}o(bb,"get_block_display_name");var gn=class extends vs{static{o(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:n,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((r,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(r.has_line_start=a),c[1]===t&&(r.has_line_end=a)),r),{has_line_start:null,has_line_end:null});return!(n&&i&&this.collection.get(this.source_key+n)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return bb(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},vb={class:gn,actions:{find_connections:hn}};var lo=class extends ks{static{o(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var uc=class extends Mt{static{o(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=Om;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),n=Object.entries(e.reduce((i,r)=>{let a=this.get_item_data_path(r.key);return i[a]=i[a]||[],i[a].push(r),i},{}));for(let i=0;i<n.length;i++){let[r,a]=n[i];await this.fs.append(r,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},Om=class extends St{static{o(this,"AjsonMultiFileBlockDataAdapter")}};var mc=class{static{o(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return te(e)}};function pc(s,e,t){return s.split(`
`).slice(e-1,t).join(`
`)}o(pc,"get_line_range");var yn=class extends mc{static{o(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:n,line_end:i}=this.item;if(!n||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let r=t.split(`
`);r.splice(i,0,"",e);let a=r.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let n=await this.item.source.read(),{line_start:i,line_end:r}=this.item;if(!i||!r)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=n.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(r)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:n}=this.item;if(!t||!n)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(n)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let n=e.includes("#"),i=n?e.split("#")[0]:e,r=this.item.env.smart_sources.get(i);if(!r){await this.item.env.smart_sources.create(i,t);return}if(n){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await r.append(t)}else await r.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:n}=this.item;if(!t||!n)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return pc(e,t,n)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let n=[],[i,...r]=this.item.key.split("#"),a=i.split("/").pop();if(n.push(a),r.length){let c=r[r.length-1];c.startsWith("{")&&c.endsWith("}")?(r.pop(),n.push(r.pop()),this.item.lines&&n.push(`Lines: ${this.item.lines.join("-")}`)):n.push(r.pop())}return n.filter(Boolean).join(" > ")}};var bn=class{static{o(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((n,[i,r])=>{let a=(t?t+".":"")+this.process_setting_key(i);return n[a]=r,n},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var _o=class extends bn{static{o(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var vn=class{static{o(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,n])=>({value:t,name:n.name||t})).sort((t,n)=>t.name.localeCompare(n.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var xs=class extends vn{static{o(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var nt=class{static{o(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var kn=class{static{o(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},wn=class{static{o(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var xn=class extends kn{static{o(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let n;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(n=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&n.status===400)throw new Error("Obsidian request failed");return new qm(n)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(n),console.error(i),null}}},qm=class extends wn{static{o(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Es=class extends kn{static{o(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...n}=e,i=await fetch(t,n);return new $m(i)}},$m=class extends wn{static{o(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var Eb=Y(xb(),1);var kq=Object.defineProperty,wq=o((s,e,t)=>e in s?kq(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,"__defNormalProp"),xq=o((s,e,t)=>(wq(s,typeof e!="symbol"?e+"":e,t),t),"__publicField");function Eq(s,e){let t=Array.from({length:s.length},(n,i)=>({start:i,end:i+1}));for(;t.length>1;){let n=null;for(let i=0;i<t.length-1;i++){let r=s.slice(t[i].start,t[i+1].end),a=e.get(r.join(","));a!=null&&(n==null||a<n[0])&&(n=[a,i])}if(n!=null){let i=n[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}o(Eq,"bytePairMerge");function Aq(s,e){return s.length===1?[e.get(s.join(","))]:Eq(s,e).map(t=>e.get(s.slice(t.start,t.end).join(","))).filter(t=>t!=null)}o(Aq,"bytePairEncode");function Sq(s){return s.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}o(Sq,"escapeRegex");var Tm=class{static{o(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(s,e){this.patStr=s.pat_str;let t=s.bpe_ranks.split(`
`).filter(Boolean).reduce((n,i)=>{let[r,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>n[d]=l+_),n},{});for(let[n,i]of Object.entries(t)){let r=Eb.default.toByteArray(n);this.rankMap.set(r.join(","),i),this.textMap.set(i,r)}this.specialTokens={...s.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[i,r])=>(n[r]=this.textEncoder.encode(i),n),{})}encode(s,e=[],t="all"){let n=new RegExp(this.patStr,"ug"),i=Tm.specialTokenRegex(Object.keys(this.specialTokens)),r=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Tm.specialTokenRegex([...c]),_=s.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(s),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??s.length;for(let f of s.substring(l,u).matchAll(n)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){r.push(g);continue}r.push(...Aq(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];r.push(p),l=d.index+d[0].length}return r}decode(s){let e=[],t=0;for(let r=0;r<s.length;++r){let a=s[r],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let n=new Uint8Array(t),i=0;for(let r of e)n.set(r,i),i+=r.length;return this.textDecoder.decode(n)}},fc=Tm;xq(fc,"specialTokenRegex",s=>new RegExp(s.map(e=>Sq(e)).join("|"),"g"));async function Sb(s,e=s){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await Ab(s);return window.localStorage.setItem(e,JSON.stringify(_)),_}let n=await import("node:fs/promises"),i=await import("node:path"),r=await import("node:os"),a=i.join(r.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await n.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await Ab(s);return await n.mkdir(a,{recursive:!0}),await n.writeFile(c,JSON.stringify(l),"utf8"),l}o(Sb,"fetch_json_cached");async function Ab(s){let e=await fetch(s);if(!e.ok)throw new Error(`failed to download ${s} \u2013 ${e.status}`);return await e.json()}o(Ab,"do_fetch");function Pm(s){if(s===null)return!0;let e=typeof s;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(s)?s.every(Pm):e==="object"?Object.values(s).every(Pm):!1}o(Pm,"is_json_compatible");function gc(s,e){let t={};for(let[n,i]of Object.entries(s))e.includes(n)||Pm(i)&&(t[n]=i);return t}o(gc,"extract_json_details");function uo(s){return Object.keys(s).length===0}o(uo,"is_empty_object");function Cq(s,e){return uo(s)?e:uo(e)?s:{...s,...e}}o(Cq,"merge_details");function Nm(s){let e=s.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}o(Nm,"get_message_from_object");function Z(s,e=null){if(Array.isArray(s)&&s.length>0)return Z(s[0],e);if(s==null)return{message:"Unknown error",details:null,http_status:e};if(typeof s=="string")return{message:s,details:null,http_status:e};if(s instanceof Error){let t=(s.message||"").trim()||"Unknown error",n=gc(s,["message"]);return{message:t,details:uo(n)?null:n,http_status:e}}if(typeof s=="object"){let t=s;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let r=i,a=Nm(r),c=gc(r,["message"]),l=gc(t,["message","error"]),d=Cq(l,c);return{message:a||Nm(t)||"Unknown error",details:uo(d)?null:d,http_status:e}}return Z(i)}let n=Nm(t);if(n){let i=gc(t,["message"]);return{message:n,details:uo(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}o(Z,"normalize_error");var Oq="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",ot=class extends xs{static{o(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Be}get res_adapter(){return Ue}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new nt({adapter:Es})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),r=await this.request(i);if(!r)return console.error("No response received for embedding request."),[];if(r.error)return[r];let c=new this.res_adapter(this,r).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let n=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(n);return i.error?{error:Z(i,n.status())}:i}catch(n){return console.warn("Request error:",n),await this.handle_request_err(n,e,t)}}async handle_request_err(e,t,n){if(e.status===429&&n<3){let i=Math.pow(n+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(r=>setTimeout(r,1e3*i)),await this.request(t,n+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?null:c}async load_tiktoken(){let e=await Sb(Oq,"cl100k_base.json");this.tiktoken=new fc(e)}},Be=class{static{o(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Ue=class{static{o(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var yc=class extends ot{static{o(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Im}get res_adapter(){return Lm}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Im=class extends Be{static{o(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Lm=class extends Ue{static{o(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(n=>({vec:n.embedding,tokens:t}))}};var bc=class extends xs{static{o(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((n,i)=>{let r=`${this.message_prefix}${this.message_id++}`;this.message_queue[r]={resolve:n,reject:i},this._post_message({method:e,params:t,id:r})})}_handle_message_result(e,t,n){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(n?this.message_queue[e].reject(new Error(n)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),n=await this._send_message("embed_batch",{inputs:t});return e.map((i,r)=>(i.vec=n[r].vec,i.tokens=n[r].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var vc=class extends bc{static{o(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(n=>this.iframe.onload=n);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(n=>{let i=o(()=>{this.model.model_loaded?n():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:n,error:i}=e.data;this._handle_message_result(t,n,i)}};var Cb=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var Ob={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:Mm};var Mm={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},qb={},zm={};var En=class extends vc{static{o(this,"SmartEmbedTransformersIframeAdapter")}static defaults=Ob;constructor(e){super(e),this.connector=Cb.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...qb}}get_models(){return Promise.resolve(this.models)}get models(){return Mm}};var kc=class extends ot{static{o(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Dm}get res_adapter(){return Rm}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let n=await t.json(),i=[];for(let a of $q(n.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let r=this.parse_model_data(i);return this.model_data=r,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),r}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,n)=>t.name.localeCompare(n.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,n)=>{let i=n.model_info||{},r=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[n.name]={model_name:n.name,id:n.name,multimodal:!1,max_tokens:r||this.max_tokens,dims:a,description:n.description||`Model: ${n.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Dm=class extends Be{static{o(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},Rm=class extends Ue{static{o(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},qq=o(s=>["embed","embedding","bge"].some(e=>s.name.toLowerCase().includes(e)),"is_embedding_model"),$q=o(s=>{if(!Array.isArray(s))throw new TypeError("models must be an array");return s.filter(qq)},"filter_embedding_models");var wc=class extends ot{static{o(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Fm}get res_adapter(){return Bm}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let n=e.map(r=>this.estimate_tokens(r.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let r=i[0].error.details?.details?.find(a=>a.retryDelay);if(r.retryDelay){let a=parseInt(r.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((r,a)=>{r.tokens=n[a]}),console.log("Gemini embed_batch response:",i),i}},Fm=class extends Be{static{o(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[n,...i]=t.split(`
`),r=i.join(`
`).trim()||"";return r.length?{model:this.model_id,content:{parts:[{text:r}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:n}:{model:this.model_id,content:{parts:[{text:n}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Bm=class extends Ue{static{o(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,n)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${n}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function jq(s,e="lm_studio"){return s.object!=="list"||!Array.isArray(s.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",s),s.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,n)=>(t[n.id]={id:n.id,model_name:n.id,max_tokens:n.loaded_context_length||512,description:`LM Studio model: ${n.id}`,adapter:e},t),{}))}o(jq,"parse_lm_studio_models");var xc=class extends ot{static{o(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Um}get res_adapter(){return Wm}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let n=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(n);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return jq(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),n=await super.embed_batch(e);return n.forEach((i,r)=>{i.tokens=t[r]}),n}},Um=class extends Be{static{o(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Wm=class extends Ue{static{o(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var mo=class extends bn{static{o(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw Z(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var Ec=class{static{o(this,"SmartStreamer")}constructor(e,t={}){let{method:n="GET",headers:i={},body:r=null,withCredentials:a=!1}=t;this.url=e,this.method=n,this.headers=i,this.body=r,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(n=>n!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(n=>(n(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let n=JSON.parse(e.currentTarget.response);typeof n=="object"?t.data=n:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let n=t.split(this.chunk_splitting_regex);n.forEach((i,r)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,r===n.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var Ac=class extends vn{static{o(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var An={},Rt={data:null,fetched_at:0},R=class extends Ac{static{o(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return F}get res_adapter(){return M}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new nt({adapter:Es})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Rt.data[e]||{},n=o(a=>a.limit?.context||1e4,"get_limit_i"),i=o(a=>a.limit?.output||1e4,"get_limit_o"),r=o(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=n(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=r(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:n(c),max_output_tokens:i(c),multimodal:r(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(n){console.error("Failed to fetch model data:",{error:n,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let n=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(n);if(!i)return null;let r=new this.res_adapter(this,await i.json());try{return r.to_openai()}catch(a){let c=Z(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((r,a)=>{try{this.active_stream=new Ec(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),r(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=Z({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=Z(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=Z(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Rt?.data&&t-Rt?.fetched_at<e)return Rt.data;try{let n={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},r=await(await this.http_adapter.request(n)).json();return Rt.data=r,Rt.fetched_at=t,console.log({MODELS_DEV_CACHE:Rt}),r}catch(n){return console.warn("models.dev fetch failed; continuing without enrichment",n),Rt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return An[this.constructor.key]||(An[this.constructor.key]={}),An[this.constructor.key]}set model_data(e){An[this.constructor.key]||(An[this.constructor.key]={}),An[this.constructor.key]=e}},F=class{static{o(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(n=>n.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},M=class{static{o(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,n=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=n}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let n=e.choices[0].delta.content;t=n,this._res.choices[0].message.content+=n}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var po=class extends R{static{o(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return ho}res_adapter=fo;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},ho=class extends F{static{o(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(n=>n.text).join(`
`):t.content;else if(t.role==="tool"){let n={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(n)}else{let n={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(n.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(n)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},fo=class extends M{static{o(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let n=e.delta?.text;t=n,this._res.content[0].text+=n}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var Tq=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Ss=class extends R{static{o(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Gm;parse_model_data(e){return e.data.filter(t=>!Tq.some(n=>t.id.startsWith(n))&&!t.id.includes("-instruct")).reduce((t,n)=>{let i={model_name:n.id,id:n.id,multimodal:!0,max_input_tokens:Nq(n.id)};return t[n.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function Nq(s){return s.startsWith("gpt-4.1")?1e6:s.startsWith("o")?2e5:s.startsWith("gpt-5")?4e5:s.startsWith("gpt-4o")||s.startsWith("gpt-4.5")||s.startsWith("gpt-4-turbo")?128e3:s.startsWith("gpt-4")?8192:s.startsWith("gpt-3")?16385:8e3}o(Nq,"get_max_input_tokens");var Gm=class extends M{static{o(this,"SmartChatModelOpenaiResponseAdapter")}};var go=class extends Ss{static{o(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:n}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${n}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,raw:n,description:`Model: ${n.model}, Status: ${n.status}`,max_input_tokens:4e3};return t}};var Sn=class extends R{static{o(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=yo;res_adapter=bo;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,n)=>{let i={model_name:n.name.split("/").pop(),id:n.name.split("/").pop(),max_input_tokens:n.inputTokenLimit,max_output_tokens:n.maxOutputTokens,description:n.description,multimodal:n.name.includes("vision")||n.description.includes("multimodal"),raw:n};return t[n.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},yo=class extends F{static{o(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let n of this.messages)n.role==="system"?t+=n.content+`
`:e.push({role:this._get_gemini_role(n.role),parts:this._transform_content_to_gemini(n.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let n=t.image_url.url.split(";")[0].split(":")[1];return n==="image/jpg"&&(n="image/jpeg"),{inline_data:{mime_type:n,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},bo=class extends M{static{o(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:Z(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},n=e.parts.find(i=>i.functionCall);return n&&(t.tool_calls=[{type:"function",function:{name:n.functionCall.name,arguments:JSON.stringify(n.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let n=JSON.parse(t),i;if(n.candidates?.[0]?.content?.parts?.[0]?.text?.length){let r=n.candidates[0].content.parts[0].text;i=r,this._res.candidates[0].content.parts[0].text+=r}return n.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=n.candidates[0].content.role),n.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=n.candidates[0].finishReason),n.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...n.promptFeedback}),n.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...n.usageMetadata}),n.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=n.candidates[0].content.parts[0].functionCall.name,n.candidates[0].content.parts[0].functionCall.args&&Object.entries(n.candidates[0].content.parts[0].functionCall.args).forEach(([r,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[r]||(this._res.candidates[0].content.parts[0].functionCall.args[r]=""),this._res.candidates[0].content.parts[0].functionCall.args[r]+=a})),i}},vo=class extends Sn{static{o(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var ko=class extends R{static{o(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Hm}get res_adapter(){return Jm}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,n)=>(t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_length,name:n.name,description:n.name,long_desc:n.description,multimodal:n.architecture.modality==="multimodal",raw:n},t),{})}},Hm=class extends F{static{o(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Jm=class extends M{static{o(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var wo=class extends R{static{o(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return xo}get res_adapter(){return Eo}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={id:n.id,model_name:n.id,description:`LM Studio model: ${n.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},xo=class extends F{static{o(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),n=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=n.messages[n.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),n.tool_choice="required"}else n.tool_choice&&typeof n.tool_choice=="object"&&(n.tool_choice="auto");return t.body=JSON.stringify(n),t}},Eo=class extends M{static{o(this,"SmartChatModelLmStudioResponseAdapter")}};var Ao=class extends R{static{o(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=So;res_adapter=Co;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let n=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let r of n.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:r.name})})).json();i.push({...c,name:r.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,n)=>{if(n.name.includes("embed"))return t;let i={model_name:n.name,id:n.name,multimodal:!1,max_input_tokens:Object.entries(n.model_info).find(r=>r[0].includes(".context_length"))[1]};return t[n.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},So=class extends F{static{o(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},n=this._extract_images_from_content(e.content);return n.length>0&&(t.images=n.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},Co=class extends M{static{o(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let n=e.message.content;t=n,this._res.message.content+=n}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Vm={openai:{req:F,res:M},anthropic:{req:ho,res:fo},gemini:{req:yo,res:bo},lm_studio:{req:xo,res:Eo},ollama:{req:So,res:Co}},Oo=class extends R{static{o(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Vm[e];return t&&t.req?t.req:F}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Vm[e];return t&&t.res?t.res:M}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",n=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${n}${i}`}get_adapters_as_options(){return Object.keys(Vm).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:o(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var qo=class extends R{static{o(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Km}get res_adapter(){return Ym}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_window||8192,description:`Owned by: ${n.owned_by}, context: ${n.context_window}`,multimodal:n.id.includes("vision")};return t}},Km=class extends F{static{o(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Ym=class extends M{static{o(this,"SmartChatModelGroqResponseAdapter")}};var $o=class extends R{static{o(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return F}get res_adapter(){return M}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((n,i)=>{let r=i.id||i.name;return n[r]={id:r,model_name:r,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},n},{})}};var jo=class extends R{static{o(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Xm}get res_adapter(){return Zm}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_size||8192,description:n.description||n.name||n.id,raw:n};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Xm=class extends F{static{o(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Zm=class extends M{static{o(this,"SmartChatModelDeepseekResponseAdapter")}};var wp=require("obsidian");function $b(s,e){let{blocks:t,task_lines:n,tasks:i,codeblock_ranges:r}=rc(e),a=s.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=s.key+c,_=s.block_collection.get(d),u=pc(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=zt(u),f=ac({source:s,links:p}),y={key:d,lines:l,size:u.length,outlinks:[...p,...f],last_read:{at:a,hash:te(u)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new s.block_collection.item_type(s.env,y);s.block_collection.set(g)}else _.data={..._.data,...y}}Pq(s,t,n,i,r);for(let c of s.blocks)c.vec||c.queue_embed()}o($b,"parse_blocks");function Pq(s,e,t=[],n={},i={}){let r=new Set(Object.keys(e).map(c=>s.key+c)),a=s.blocks;for(let c=0;c<a.length;c++)r.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());s.data.blocks=e,s.data.task_lines=t,s.data.tasks=n,s.data.codeblock_ranges=i,s.queue_save()}o(Pq,"clean_and_update_source_blocks");function Qm(s,e){if(e===null)return null;if(e===void 0)return s;if(typeof e!="object")return e;(typeof s!="object"||s===null)&&(s={});let t=Object.keys(e),n=t.length;for(let i=0;i<n;i++){let r=t[i],a=e[r],c=s[r];Array.isArray(a)?s[r]=a.slice():jb(a)?s[r]=Qm(jb(c)?c:{},a):a!==void 0&&(s[r]=a)}return s}o(Qm,"ajson_merge");function jb(s){return s!==null&&typeof s=="object"&&!Array.isArray(s)}o(jb,"is_object");var Tb={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function Iq(s){let e=!1,[t,...n]=s.split(":");return Tb[t]&&(t=Tb[t],e=!0),{collection_key:t,item_key:n.join(":"),changed:e}}o(Iq,"_parse_ajson_key");var Ft=class extends Mt{static{o(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",n=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(n)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let r of Object.values(this.collection.items))r._queue_load&&r.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let r of Object.values(this.collection.items))r._queue_load&&r.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:n,file_data:i}=this.parse_single_file_ajson(t);n&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let r of Object.values(this.collection.items))r._queue_load=!1,r.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,n=e.trim().split(`
`).filter(Boolean),i={},r=0;for(let c=0;c<n.length;c++){let l=n[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:y,item_key:g,changed:k}=Iq(p),v=`${y}:${g}`;f?(i[v]=f,(k||v!==p)&&(delete i[p],t=!0)):(delete i[v],(k||v!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}r++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=Qm(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}r>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(r=>r._queue_save),t=Date.now(),n=50;for(let r=0;r<e.length;r+=n){let a=e.slice(r,r+n);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(r=>r.deleted);i.length&&i.forEach(r=>{delete this.collection.items[r.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},ep=class extends St{static{o(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:n}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},To={collection:Ft,item:ep};var No=class extends se{static{o(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,n=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",r=[];return!t.includes(e)&&e!=="global"&&r.push(e),r.push(t),`${r.join("_").replace(/\./g,"_")}#${[n,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function Lq(s=[]){let e=s.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}o(Lq,"parse_component_properties");async function Mq(s,e){let{scope_key:t,component_key:n}=Lq(s);if(!n)return null;let i=typeof e=="function"?e:e?.render,r=typeof i?.version=="number"?i.version:0,a=await te(i.toString());return{scope_key:t,component_key:n,version:r,hash:a}}o(Mq,"build_component_data");var Sc=class{static{o(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,n){if(!this.should_use_adapter(n))return null;let i=await Mq(t,n);if(!i)return null;let r=await e.create_or_update({...i});return r?(r._component_module=n,r._component_adapter=new this(r,n),r):null}async render(e,t){throw new Error("render() not implemented")}};var Cc=class extends Sc{static{o(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let n=typeof this.module=="function"?this.module:this.module?.render;if(typeof n!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await n.call(this.smart_view,e,t)}};function Nb(s,e=[],t=[]){return!s||typeof s!="object"||Object.entries(s).forEach(([n,i])=>{let r=[...e,n];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:r,module:i});return}typeof i=="object"&&Nb(i,r,t)}}),t}o(Nb,"flatten_components_config");var Oc=class extends ne{static{o(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=Nb(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let n of this.component_adapters){let i=await n.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,n={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,n)}},Pb={class:Oc,item_type:No,data_adapter:To,component_adapters:{SmartViewComponentAdapter:Cc}};var Ib=Pb;function Lb(s=[]){let e=new Set;for(let{key:t}of s)t.includes("#")||e.add(t);return s.filter(({key:t})=>{if(!t.includes("#"))return!0;let n=t.split("#")[0];return!e.has(n)})}o(Lb,"filter_redundant_context_items");var Mb=o((s,e)=>!e||!s?.[e]?!1:s[e].folder||s[e].from_named_context?s[e].exclude?!1:(s[e].exclude=!0,!0):(delete s[e],!0),"remove_context_item_data"),Po=class extends se{static{o(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:n=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let r=this.data.context_items[i],a={d:0,at:Date.now(),...r||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),n&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:n=!0}=t;Mb(this.data.context_items,e)&&(this.queue_save(),n&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:n=!0}=t,i=Array.isArray(e)?e:[e],r=[];return i.forEach(a=>{Mb(this.data.context_items,a)&&r.push(a)}),r.length?(this.queue_save(),n&&this.emit_event("context:updated",{removed_keys:r}),r):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(n=>{n.size&&(e+=n.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],n=this.context_items.filter(e.filter).sort((r,a)=>r.data.d-a.data.d);console.log("get_text context_items",n);for(let r of n){if(r.is_media)continue;let a=await r.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(r,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:n}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),n=[];for(let i of t){if(!i.is_media)continue;let r=await i.get_base64();r.error?this.emit_get_media_error(i,r):n.push(r)}return n}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return Lb(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let n=this.data.context_items[t].d;return n===e||typeof n>"u"&&e===0})}};var qc=class extends ne{static{o(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let n=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&n.add_items(t.add_items),this.set(n),n.queue_save(),n.emit_event("context:created"),n}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var zq={class:qc,data_adapter:Ft,item_type:Po};var zb=zq;var $c=class extends se{static{o(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var rt=class{static{o(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var jc=class extends rt{static{o(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var Tc=class extends rt{static{o(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var Db=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var Nc=class extends rt{static{o(this,"ImageContextItemAdapter")}static detect(e){return Db.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),n=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:n}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var Pc=class extends rt{static{o(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var tp=class extends ne{static{o(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let n=e.order||0,i=t.order||0;return n-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(n=>n.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let n=0;n<t.length;n++){let[i,r]=t[n];r.exclude||this.new_item({key:i,...r})}}},Rb={version:1,class:tp,collection_key:"context_items",item_type:$c,context_item_adapters:{BlockContextItemAdapter:jc,SourceContextItemAdapter:Tc,ImageContextItemAdapter:Nc,PdfContextItemAdapter:Pc}};function Fb(s={},e){let t=(s.ct||0)+1,n=s.first_at??e;return{ct:t,first_at:n,last_at:e}}o(Fb,"next_log_stats");var Cn=class extends se{static{o(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var Dq={"collection:save_started":!0,"collection:save_completed":!0},sp=class extends ne{static{o(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let n=new this(e,t);return n.init(),n}get item_type(){return Cn}init(){this.env?.events||gs.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!Dq[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let n=Date.now(),i=this.get(e);i||(i=new Cn(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let r=Fb({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},n);i.data={...i.data,...r},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(n){console.error("[EventLogs] record failure",e,n)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},Bb={class:sp,collection_key:"event_logs",data_adapter:Ft,item_type:Cn};var On=require("obsidian");function Ub(s,e={}){if(!s)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],n=s?.env?.config?.actions||{},i=s?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(n[c]||{}).display_name||c;return a.push({select_action:o(()=>{s.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}o(Ub,"build_suggest_scope_items");var Wb=o((s,e={})=>{let t=s?.inputEl,n=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(n===t&&i)},"should_handle_arrow_left");var Ic=class extends On.FuzzySuggestModal{static{o(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,n=t.plugin,i=n.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=n,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let n=this,i=new n(e,t);return i.open(t),i}static register_modal(e){let t=this,n=e?.env,i={...n.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let r=o((l={})=>{let d=t.resolve_item_from_payload(n,l);return t.open(d,{...i,...l})},"open_handler"),a=[n?.events?.on?.(`${t.event_domain}:open`,r)],c=o(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,r=Wb(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&r){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return Ub(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){super.renderSuggestion(e,t);let n=e?.icon||e?.item?.icon;if(n){t.addClass("sc-modal-suggestion-has-icon");let a=t.createEl("span");(0,On.setIcon)(a,n)}let i=e&&Object.prototype.hasOwnProperty.call(e,"display_right")?e.display_right:e?.item?.display_right,r=i==null?"":String(i).trim();return r&&this.env.smart_components.render_component("suggest_display_right",r).then(a=>{t.appendChild(a)}),t}onChooseSuggestion(e,t,...n){this.prevent_close=!0;let i=e.item,r=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=On.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,r)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let n=e[t],i=await n({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let r=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),r!==-1&&this.chooser.setSelectedItem(r)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var LJ=require("obsidian");var Lc=class extends Ic{static{o(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var Gb=require("obsidian");var Mc=class extends Gb.Modal{static{o(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var Dc=require("obsidian");var Rq="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",zc=class extends Dc.Modal{static{o(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){Fq(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function Fq(s,e){if(!s)return;s.empty(),s.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let n=document.createElement("div");n.className="sc-milestones-modal__title-text",n.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),Bq(i),i.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(Rq,"_external")}),t.appendChild(n),t.appendChild(i),s.appendChild(t)}o(Fq,"render_milestones_modal_title");function Bq(s){Uq(s,["circle-help","help-circle","help","info"])||(s.textContent="?")}o(Bq,"render_help_icon");function Uq(s,e){if(!s)return!1;let t=Array.isArray(e)?e:[];for(let n of t)if(!(typeof n!="string"||n.length===0)){s.textContent="";try{(0,Dc.setIcon)(s,n)}catch{continue}if(s.querySelector("svg"))return!0}return!1}o(Uq,"set_icon_with_fallback");var Hb={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var Io=class extends se{static{o(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let n=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?n.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&n.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&n.debounce_save(),d}},r=new Proxy(e,i);return this._settings_proxy_map.set(e,r),r}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,n])=>({label:n.name||t,value:n.key||t})).sort((t,n)=>t.label.toLowerCase().includes("free")&&!n.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&n.label.toLowerCase().includes("free")?1:t.label.localeCompare(n.label))}model_changed(e,t,n){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},r=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...r,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var Rc=class extends ne{static{o(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,r)=>r.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let n=new this.item_type(this.env,{...e});return this.set(n),this.settings.default_model_key=n.key,this.emit_event("model:changed"),n.queue_save(),n}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(n=>!n.deleted).sort((n,i)=>i.data.created_at-n.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let n=this.new_model({provider_key:this.default_provider_key});n.queue_save(),this.process_save_queue(),this.settings.default_model_key=n.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function Jb(s){return{default_model_key:{type:"dropdown",name:`Default ${s.model_type.toLowerCase()} model`,description:`Used as the default ${s.model_type.toLowerCase()} model when no other is specified.`,options_callback:o(()=>s.get_model_key_options(),"options_callback"),callback:o(async(e,t)=>{s.emit_event("model:changed")},"callback")}}}o(Jb,"settings_config");var Cs=class extends Io{static{o(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var np=class extends Rc{static{o(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var Wq={class:np,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:To,item_type:Cs,providers:{},settings_config:Jb},ip=Wq;var op=class extends En{static{o(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},Vb={class:op,settings_config:zm};ip.providers={transformers:Vb};var Kb=ip;var Bt=class extends se{static{o(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],n=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(Qa(a,l,e.limit||20),a):(l?.error&&n.push(l.error),a)},{min:0,results:new Set}),r=Array.from(i).sort(ec);if(!r.length)return r;for(;!r.some(a=>a.score>.5);)r.forEach(a=>a.score*=2);return r}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};function Yb(s){return{type:"heading",name:`${s}`}}o(Yb,"create_settings_section_heading");var Xb={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:o(s=>{let e=[{value:"smart_sources",name:"Sources"}];return s.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},rp=class extends ne{static{o(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let n=Gq(new Date),i=te(e),r=`${n}+${i}`;if(this.items[r])return this.items[r];let a=new Bt(this.env,{key:r,query:e,filter:t});return this.set(a),a}get settings_config(){return{...Xb}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function Gq(s){let e=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),n=String(s.getDate()).padStart(2,"0");return`${e}-${t}-${n}`}o(Gq,"format_ymd");var Zb={class:rp,collection_key:"lookup_lists",item_type:Bt,settings_config:Xb};function Lo(s){return s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}o(Lo,"format_collection_name");async function Hq(s,e={}){let t=Object.entries(s.settings_config).map(([i,r])=>(r.setting||(r.setting=i),this.render_setting_html(r))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${Lo(s.collection_key)}</h2>
${t}
</div></div></div>`}o(Hq,"build_html");async function Qb(s,e={}){let t=await Hq.call(this,s,e),n=this.create_doc_fragment(t);return await this.render_setting_components(n,{scope:s}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(n.querySelector(".collection-settings"))):s.settings_container=n.querySelector(".collection-settings-container"),s.settings_container}o(Qb,"render");var qn=require("obsidian");function ev(s,e,t,n,i={}){let r=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(qn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(n),l=await c?.read();if(l){let d=new qn.HoverPopover(s,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");qn.MarkdownRenderer.render(r,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}o(ev,"register_block_hover_popover");var tv=require("obsidian");function Fc(s,e,t={}){let n=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?s.addEventListener("mouseover",i=>{let r=e.key.replace(/#$/,"");if(n.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:s.parentElement,targetEl:s,linktext:r}),tv.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):ev(s.parentElement,s,e.env,e.key)}o(Fc,"register_item_hover_popover");var nv=require("obsidian");function Jq(s){let e=typeof s=="number"?s:Number.parseFloat(s);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}o(Jq,"format_score");function Vq(s){let e=typeof s=="number"?s:Number.parseFloat(s);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],n=e,i=0;for(;n>=1024&&i<t.length-1;)n/=1024,i+=1;let r=n>=10||Number.isInteger(n)?0:1;return`${Number.parseFloat(n.toFixed(r)).toString()} ${t[i]}`}o(Vq,"format_size");function sv(s,e){return s?`<span class="${e}">${s}</span>`:""}o(sv,"build_badge_html");function Kq(s,e={}){let t;if(s.item_ref)if(s.item_ref.key.includes("#")){let c=s.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(s.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=s.item_ref.key.split("/").pop();else t=s.key.split("/").pop();let n=Jq(s?.data?.score),i=Vq(s?.size||s?.data?.size),r=sv(n,"sc-context-item-score"),a=sv(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${s.key}">\xD7</span>
${r}
<span class="sc-context-item-name">${t||s.key}</span>
${a}
</span>`}o(Kq,"build_html");async function iv(s,e={}){let t=Kq(s,e),i=this.create_doc_fragment(t).firstElementChild;return Yq.call(this,s,i,e),i}o(iv,"render");async function Yq(s,e,t={}){let n=s.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");n.smart_contexts.get(d).remove_item(s.key)}),s.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${nv.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),Fc(a,s.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{s.open(a)}),e}o(Yq,"post_process");async function Xq(s,e={}){let t=[];t.push("<h2>Collections</h2>");let n=Object.keys(s.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,r)=>i==="smart_sources"||i==="smart_blocks"?-1:r==="smart_sources"||r==="smart_blocks"?1:i.localeCompare(r));for(let i of n){let r=s[i];if(!r||!r.items){t.push(`
<div class="sc-collection-stats">
<h3>${Lo(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=Qq(r,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}o(Xq,"build_html");async function ov(s,e={}){let t=await Xq.call(this,s,e),n=this.create_doc_fragment(t);return await Zq.call(this,s,n,e)}o(ov,"render");async function Zq(s,e,t={}){return e}o(Zq,"post_process");function Qq(s,e){let t=Object.values(s.items).length,n=Lo(e),i=s.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${n}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let r=s.load_time_ms?`<p>Load time: ${s.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=e$(s,n,t),l="";return typeof s.process_embed_queue=="function"&&(l=t$(s,t)),`
<div class="sc-collection-stats">
<h3>${n}</h3>
${l}
${c}
${r}
${a}
</div>
`}o(Qq,"generate_collection_stats");function e$(s,e,t,n){return`
<p><strong>Total:</strong> ${t}</p>
`}o(e$,"get_generic_collection_stats");function t$(s,e){if(!Object.values(s.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let n=Object.values(s.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=n.embedded/n.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${n.embedded} / ${n.should_embed})</p>`+(n.missing_embed?`<p><strong>Missing embeddings:</strong> ${n.missing_embed}</p>`:"")+(n.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${n.extraneous_embed}</p>`:"")+(n.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${n.should_not_embed}</p>`:"")}o(t$,"calculate_embed_coverage");var rv=require("obsidian");function s$(s,e={}){return'<div class="smart-form-dropdown-component"></div>'}o(s$,"build_html");async function ap(s,e={}){let t=s$.call(this,s,e),n=this.create_doc_fragment(t);return await n$.call(this,s,n,e)}o(ap,"render");async function n$(s,e,t={}){if(!s)return e.textContent="Error: scope is required for dropdown component.",e;let n=s.settings;if(!n||typeof n!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let r=t.options;if(!Array.isArray(r)||r.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new rv.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Ae(n,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:s,options:r}),l=_.selectEl,t.required&&l.setAttribute("required","true"),r.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),r.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=o(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:s,setting_key:i,select_el:l,container:e}):Se(s.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}o(n$,"post_process");ap.version=.2;var av=require("obsidian");function i$(s,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}o(i$,"build_html");function cv(s,e={}){let t=i$.call(this,s,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),r=i.querySelector(".callout-icon"),a=(0,av.getIcon)("smart-chat");return a&&(this.empty(r),r.appendChild(a)),o$.call(this,s,i,e),i}o(cv,"render");function o$(s,e){}o(o$,"post_process");var lv=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var pv=require("obsidian");var dv=require("obsidian");var a$={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},$n={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},c$=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function cp(s){let e=Object.entries(s||{}).reduce((r,[a,c])=>{let l=c?.group||"Other";return r[l]||(r[l]=[]),r[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),r},{}),t=Object.keys(e),n=c$.reduce((r,a,c)=>(r[a]=c,r),{});return t.sort((r,a)=>{let c=Object.prototype.hasOwnProperty.call(n,r),l=Object.prototype.hasOwnProperty.call(n,a);return c&&l?n[r]-n[a]:c?-1:l?1:r.localeCompare(a)}).map(r=>{let a=(e[r]||[]).slice();return{group:r,items:a}})}o(cp,"derive_events_checklist_groups");function Mo(s,e){let t=l$(s,e);return!!(t===!0||s?.event_logs?.items?.[e])}o(Mo,"check_if_event_emitted");function l$(s,e){let t=a$[e];if(!t)return null;let n=s?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let r of i){let a=n[r];if(a&&!(t.require_pro_name&&!d$(a)))return!0}return!1}o(l$,"resolve_plugin_install_event");function d$(s){let e=s?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}o(d$,"is_pro_manifest");function _v(s){s.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in $n){let n=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",r=document.createElement("p");r.textContent=i,n.appendChild(r);let a=document.createElement("p");a.textContent=`\u2705 ${$n[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",n.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{s.open_milestones_modal()}),n.appendChild(c),new dv.Notice(n,7e3)}})}o(_v,"register_first_of_event_notifications");function _$(s,e={}){let t=cp($n),n=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(Mo(s,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),r=i>0?Math.round(n/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(Mo(s,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=Mo(s,u.event_key)===!0;return m$(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Re(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Re(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${r.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${n.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${n.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Re(`${r.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}o(_$,"build_html");async function hv(s,e={}){this.apply_style_sheet(lv);let t=_$.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return u$.call(this,s,i,e),i}o(hv,"render");async function u$(s,e,t={}){return p$(e),h$(e),e}o(u$,"post_process");function m$(s,e){let t=e.checked===!0,n=t?"true":"false",i=typeof s.link=="string"?s.link:"",r=t?"Completed":"Incomplete",a=`Open docs: ${s.milestone||s.event_key||"milestone"} (${r})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Re(s.event_key)}"
data-link="${Re(i)}"
data-checked="${n}"
tabindex="0"
role="button"
aria-label="${Re(a)}"
>
<div class="sc-events-checklist__label${s.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Re(s.milestone)}</span>
</div>
</li>
`}o(m$,"build_item_html");function p$(s){s&&s.getAttribute("data-links-enabled")!=="true"&&(s.setAttribute("data-links-enabled","true"),s.addEventListener("click",e=>{let t=mv(s,e);if(!t)return;let n=window.getSelection();n&&n.toString().length>0||uv(t)}),s.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let n=mv(s,e);n&&(e.preventDefault(),uv(n))}))}o(p$,"attach_item_link_listeners");function uv(s){let e=y$(s);typeof e=="string"&&e.length>0&&window.open(e,"_external")}o(uv,"open_item_link");function h$(s){if(!s)return;Array.from(s.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let n=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&f$(i,n)})}o(h$,"render_item_state_icons");function f$(s,e){g$(s,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}o(f$,"set_item_icon");function g$(s,e){if(!s)return;let t=Array.isArray(e)?e:[];for(let n of t)if(!(typeof n!="string"||n.length===0)){s.textContent="";try{(0,pv.setIcon)(s,n)}catch{continue}if(s.querySelector("svg"))return}}o(g$,"set_icon_with_fallback");function mv(s,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let n=t.closest(".sc-events-checklist__item");return!n||!s.contains(n)?null:n}o(mv,"get_item_el_from_event");function y$(s){let e=s.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=s.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let n=$n[t];return!n||typeof n.link!="string"?"":n.link}o(y$,"get_item_link");function b$(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}o(b$,"build_html");var lp=100,dp=100;function v$(s,e={}){let{limit:t=lp}=e;return s.slice(-t).reverse()}o(v$,"get_visible_entries");function k$(s,e={}){let{page_size:t=lp}=e;return Math.min(s,t)}o(k$,"get_visible_count");function w$(s,e={}){let{current_count:t=0,step_size:n=dp}=e;return Math.min(s,t+n)}o(w$,"get_next_visible_count");function x$(s,e){return s>e}o(x$,"should_show_load_more");async function fv(s,e={}){let t=this.create_doc_fragment(b$()),n=t.firstElementChild;return E$.call(this,s,n,e),t}o(fv,"render");async function E$(s,e,t={}){let n=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),r=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(n);let c=Array.isArray(s.event_logs.session_events)?[...s.event_logs.session_events]:[];if(!c.length){let _=n.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",n.appendChild(_),r&&(r.style.display="none");return}let l=k$(c.length,{page_size:lp}),d=o(()=>{a.empty(n),v$(c,{limit:l}).forEach(_=>{C$(n,_)}),A$(r,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=n.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),r&&r.addEventListener("click",()=>{l=w$(c.length,{current_count:l,step_size:dp}),d()})}o(E$,"post_process");function A$(s,e={}){if(!s)return;let{entries_length:t=0,visible_count:n=0}=e,i=x$(t,n);if(s.style.display=i?"inline-block":"none",i){let r=t-n,a=Math.min(dp,r);s.textContent=`Load ${a} more`}}o(A$,"update_load_more_button");function S$(s){let[e,t]=s.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}o(S$,"get_level");function C$(s,e){let t=s.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=S$(e),s.appendChild(t);let n=s.ownerDocument.createElement("div");n.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();n.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${O$(i)}
`,t.appendChild(n);let r=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(r.trim().length){t.style.cursor="pointer";let a=s.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=r,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else n.textContent+=`
`}o(C$,"append_entry");function O$(s){let e=Date.now(),t=Math.floor((e-s)/1e3);if(t<60)return`${t} seconds ago`;let n=Math.floor(t/60);if(n<60)return`${n} minutes ago`;let i=Math.floor(n/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}o(O$,"to_time_ago");var Oe=require("obsidian");var jn=require("obsidian");function Tn(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}o(Tn,"get_smart_server_url");function q$(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}o(q$,"try_get_zlib");function $$(s){let e=q$();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(s),n=e.inflateRawSync(t);return new Uint8Array(n.buffer,n.byteOffset,n.length)}o($$,"inflate_deflate_data");async function gv(s){let e=new DataView(s),t=0,n=e.byteLength,i=[],r=null;for(;t+4<=n;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let k=new Uint8Array(s.slice(t,t+y)),v=new TextDecoder("utf-8").decode(k);t+=y,t+=g;let b=(l&8)!==0,A=t,S;if(!b)S=A+p;else{let C=A,x=!1;for(;C+4<=n;){let m=e.getUint32(C,!0);if(m===134695760||m===67324752||m===33639248){x=!0;break}C++}S=x?C:n}if(S>n)break;let $=new Uint8Array(s.slice(A,S));if(t=S,b&&t+4<=n)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=n)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let j;if(d===0)j=$;else if(d===8)j=$$($);else continue;if(i.push({fileName:v,data:j}),v.toLowerCase().endsWith("manifest.json")&&!v.includes("/"))try{r=JSON.parse(new TextDecoder("utf-8").decode(j))}catch{}}return{files:i,pluginManifest:r}}o(gv,"parse_zip_into_files");function yv(s,e="Response"){if(!s||s.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(s).getUint32(0,!0)!==67324752){let n=new TextDecoder().decode(new Uint8Array(s));throw new Error(`${e} did not return a valid ZIP. Text:
${n}`)}return s}o(yv,"validate_zip_buffer");async function bv(s,e,t){let n=typeof s.writeBinary=="function";await s.exists(e)||await s.mkdir(e);for(let{fileName:i,data:r}of t){let a=e+"/"+i;if(n)await s.writeBinary(a,r);else{let c=btoa(String.fromCharCode(...r));await s.write(a,c)}}}o(bv,"write_files_with_adapter");function vv(s,e){if(!e||e==="unknown")return!1;let t=s.replace(/[^\d.]/g,""),n=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),r=n.split(".").map(Number);for(let a=0;a<Math.max(i.length,r.length);a++){let c=i[a]||0,l=r[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}o(vv,"is_server_version_newer");async function kv(s,e){let t=await(0,jn.requestUrl)({url:`${Tn()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:s})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return yv(t.arrayBuffer,"Smart Plugins server")}o(kv,"fetch_plugin_zip");async function wv(s,e=jn.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${s}`);let t=await e({url:s,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return yv(t.arrayBuffer,"Download")}o(wv,"fetch_zip_from_url");async function xv(s,e,t=jn.requestUrl){let n=await t({url:`${Tn()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:s})});if(n.status!==200)throw new Error(`plugin_readme error ${n.status}: ${n.text}`);return n.json.readme}o(xv,"fetch_plugin_readme");async function Ev(s,e){await s.plugins.enablePlugin(e),s.plugins.enabledPlugins.add(e),s.plugins.requestSaveConfig(),s.plugins.loadManifests()}o(Ev,"enable_plugin");function Av(s){return`${(s?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}o(Av,"get_oauth_storage_prefix");async function Sv(s){let e=await(0,jn.requestUrl)({url:`${Tn()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}o(Sv,"fetch_server_plugin_list");async function Cv(s={}){let e=String(s.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,jn.requestUrl)({url:`${Tn()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}o(Cv,"fetch_referral_stats");var Ov=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var T$='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',N$='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function P$(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}o(P$,"derive_fallback_plugins");function I$(s,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${T$}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${N$}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}o(I$,"build_html");async function $v(s,e={}){this.apply_style_sheet(Ov);let t=I$.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return await L$.call(this,s,i,e),i}o($v,"render");async function L$(s,e,t={}){let i=(s.plugin||null)?.app||window.app,r=Av(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=P$(),_=0,u="",p=null,f=o(C=>{if(C){if(typeof this.empty=="function"){this.empty(C);return}C.innerHTML=""}},"empty_container"),y=o(C=>{if(!a||!C)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let m=document.createElement("div");m.classList.add("smart-plugins-login-manual-controls"),p.appendChild(m);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=C,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),m.appendChild(h);let w=document.createElement("button");w.classList.add("mod-cta"),w.textContent="Copy",w.addEventListener("click",async()=>{await qv(C)?new Oe.Notice("Copied login link to clipboard."):new Oe.Notice("Copy failed. Please select and copy the link manually.")}),m.appendChild(w)},"render_manual_login_link"),g=o(async()=>{let C={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(m=>setTimeout(m,100));for(let m in x){if(!Object.prototype.hasOwnProperty.call(x,m))continue;let{name:h,version:w}=x[m];C[m]={name:h,version:w}}return C},"get_installed_info"),k=o(async()=>{_++,_>=2&&u&&y(u),s&&typeof s.initiate_smart_plugins_oauth=="function"&&(u=M$()),new Oe.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),v=o(()=>{if(this.empty(a),p=null,!(localStorage.getItem(r+"token")||"")){new Oe.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await k()})});return}let x=new Oe.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(m=>{m.setButtonText("Logout"),m.onClick(()=>{localStorage.removeItem(r+"token"),localStorage.removeItem(r+"refresh"),new Oe.Notice("Logged out of Smart Plugins"),v(),b(),$()})})},"render_oauth_login_section"),b=o(async(C={})=>{f(c);let x=String(C.token||"").trim();if(!x){new Oe.Setting(c).setName("Give $30 off Pro. Get 30 days of Pro").setDesc("Start a free trial to unlock your referral link.").addButton(w=>{w.setButtonText("Start free trial"),w.onClick(()=>{window.open("https://smartconnections.app/pro-plugins/","_external")})});return}let m=Number(C.sub_exp??0)||0;if(!(m&&m<Date.now()))try{let h=await Cv({token:x}),w=String(h?.referral_link||"").trim();if(!w)return;let O=new Oe.Setting(c).setName("Referral link").setDesc("Give $30 off Pro. Get 30 days of Pro.");O.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let q=await qv(w);new Oe.Notice(q?"Referral link copied.":"Copy failed. Please try again.")})}),O.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),A=o(async()=>{if(this.empty(l),!(!l||d.length===0))for(let C of d){let x=await s.smart_components.render_component("pro_plugins_list_item",C,{env:s,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),S=o(()=>{let C=new Oe.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");C.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),C.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),C.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{s.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),$=o(async()=>{this.empty(l);let C=localStorage.getItem(r+"token")||"";if(!C){await A(),await b();return}try{let x=await g(),m=await Sv(C),{list:h=[],unauthorized:w=[],sub_exp:O}=m;if(typeof O=="number"&&O<Date.now()){S(),await A(),await b();return}if(await b({token:C,sub_exp:O}),!Array.isArray(h)||h.length===0){await A();return}for(let E of h){let q=await s.smart_components.render_component("pro_plugins_list_item",E,{env:s,app:i,token:C,installed_map:x,on_installed:$});l.appendChild(q)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),j=o(async()=>{v(),await $()},"render_smart_plugins");return s.events.on("smart_plugins_oauth_completed",()=>{j()}),await j(),e}o(L$,"post_process");function M$(){console.log("initiate_smart_plugins_oauth");let s=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${Tn()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${s}`;return window.open(t,"_external"),t}o(M$,"initiate_smart_plugins_oauth");var qv=o(async s=>{if(!s)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(s),!0}catch{}try{let e=document.createElement("textarea");e.value=s,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var pe=require("obsidian");var z$="https://smartconnections.app/pro-plugins/";function D$(s,e={}){return'<div class="pro-plugins-list-item"></div>'}o(D$,"build_html");function R$(s){return!s||!s.repo}o(R$,"is_fallback_item");function F$(s,e){let t=s.repo,n=s.version||"unknown",i=s.manifest_id||t.replace("/","_"),r=e?.version||null,a=e?.name||s.name||t,c=`Server version: ${n}`,l="Install",d=!1;return r&&(c+=` | Installed version: ${r}`,vv(r,n)?l="Update":(l="Installed",d=!0)),s.description&&(c+=`
${s.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:n,local_version:r}}o(F$,"compute_display_state");async function jv(s,e={}){let t=D$(s,e),i=this.create_doc_fragment(t).firstElementChild;return await B$.call(this,s,i,e),i}o(jv,"render");async function B$(s,e,t={}){let{app:n,token:i,installed_map:r={},on_installed:a}=t;if(R$(s)){let u=new pe.Setting(e).setName(s.name||"Pro plugin").setDesc(s.description||"Login to unlock Pro plugins.");if(s.core_id)if(n.plugins.manifests[s.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${s.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(z$,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(s.url,"_external")})}),e}let c=s.manifest_id||s.repo.replace("/","_"),l=r[c]||null,d=F$(s,l),_=new pe.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>W$(s,{app:n,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),s.docs_url?u.onClick(()=>window.open(s.docs_url,"_external")):u.onClick(()=>G$(s,{app:n,token:i,display_name:d.display_name}))}),e}o(B$,"post_process");var U$=o(async(s,e)=>{let t=typeof s.resolve_download_url=="function"?await s.resolve_download_url():s.download_url;if(t)return wv(t);if(!e)throw new Error("Login required to install this plugin.");return kv(s.repo,e)},"download_plugin_zip"),W$=o(async(s,e={})=>{let{app:t,token:n,on_installed:i}=e;try{new pe.Notice(`Installing "${s.repo}" ...`);let r=await U$(s,n),{files:a,pluginManifest:c}=await gv(r),l=s.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await bv(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||s.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await Ev(t,_),new pe.Notice(`${s.repo} installed successfully.`),typeof i=="function"&&await i()}catch(r){console.error("[pro-plugins:list_item] Install error:",r),new pe.Notice(`Install failed: ${r.message}`)}},"install_plugin"),G$=o(async(s,e={})=>{let{app:t,token:n,display_name:i}=e;try{let r=await xv(s.repo,n),a=new pe.Modal(t);a.setTitle(i||s.name||s.repo),await pe.MarkdownRenderer.render(t,r,a.contentEl,"",new pe.Component),a.open()}catch(r){console.error("[pro-plugins:list_item] Failed to load README:",r),new pe.Notice("Failed to load README")}},"show_plugin_readme");var Tv=require("obsidian");var Os=class extends Tv.Modal{static{o(this,"SmartModelModal")}constructor(e,t={}){let n=e.env.plugin.app||window.app;super(n),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,n=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:o(async()=>{this.close()},"on_before_new"),on_after_delete:o(async()=>{this.close()},"on_after_delete")});e.appendChild(n);let i=t.settings_config,r=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(r);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let n=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(n);let i=await t.test_model();n.textContent=JSON.stringify(i,null,2)}};var Nv=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var Pv=require("obsidian");function J$(s,e){let t=[`Provider: ${s.data.provider_key}`,`Model: ${s.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${s.display_name} <span class="test-result-icon" data-icon="${Lv(s)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}o(J$,"build_html");async function Iv(s,e){this.apply_style_sheet(Nv);let n=this.create_doc_fragment(J$.call(this,s,e)).firstElementChild;return V$.call(this,s,n,e),n}o(Iv,"render");async function V$(s,e,t){let n=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),r=e.querySelector(".test-result-icon");return(0,Pv.setIcon)(r,Lv(s)),n.addEventListener("click",()=>{new Os(s).open()}),i.addEventListener("click",()=>{new Os(s,{test_on_open:!0}).open()}),e}o(V$,"post_process");function Lv(s){switch(s.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}o(Lv,"get_test_result_icon_name");var zv=require("obsidian");var Mv={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function Bc(s,e,t={}){let n=(Mv[s.collection_key]||[]).map(i=>({...i,disabled:!s.env_config.providers[i.value]}));if(n.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new zv.Menu;n.forEach(r=>{i.addItem(a=>{a.setTitle(r.label),r.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=s.new_model({provider_key:r.value}),l=o(async()=>{},"on_new_close");new Os(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}o(Bc,"show_new_model_menu");var Pn=require("obsidian");function K$(s,e){try{typeof s=="function"&&(s=s(e))}catch(t){console.error("Error evaluating settings_config function:",t),s={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return s}o(K$,"ensure_settings_config");function _p(s,e,t){let n=K$(s,e);return Object.entries(n||{}).reduce((i,[r,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][r]=a,i},{[t]:{}})}o(_p,"build_settings_group_map");function up(s,e,t,n){return _p(s,e,n)[t]||{}}o(up,"resolve_group_settings_config");var Uc=class{static{o(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new Pn.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function qs(s,e,t,n={}){let{default_group_name:i="Settings"}=n,r=s,a=_p(s,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),u={...n,...n.group_params?.[l]||{},settings_config_source:r};return mp(l,e,d,_,u)})}o(qs,"render_settings_config");function mp(s,e,t,n,i={}){let r=i.settings_config_source||t,a=i.settings_config_source?up(r,e,s,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=Uc}catch{c=Uc}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,y,g,k)=>{let v=up(y,f,p,k.default_group_name||"Settings");return mp(p,f,v,g,k)}:mp,_=Y$(e,{container:n,group_name:s,settings_config:r,group_params:i,render_group:d}),u=new c(n);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)Dv(u,e,p);else Dv(u,e,l);u.setHeading(s);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let y=f.scope_class==="pro-setting",g=!!e.env?.is_pro;u.addSetting(k=>{switch(f.name&&k.setName(f.name),k.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&k.setClass(`setting-type-${f.type}`),f.description&&k.setDesc(f.description),f.type){case"button":k.addButton(v=>{v.setButtonText(f.name||"Run"),v.onClick(async b=>{typeof f.callback=="function"&&await Nn(k,b,f.callback,{scope:e})})});break;case"toggle":k.addToggle(v=>{v.setValue(Ae(e.settings,p)||!1),v.onChange(b=>{Se(e.settings,p,b),typeof f.callback=="function"&&Nn(k,b,f.callback,{scope:e})})});break;case"text":k.addText(v=>{v.setValue(String(Ae(e.settings,p)||"")),v.onChange(b=>{Se(e.settings,p,b)})});break;case"number":k.addText(v=>{v.setValue(String(Ae(e.settings,p)??"0")),v.inputEl.setAttribute("type","number"),v.onChange(b=>{let A=Number(b);isNaN(A)||Se(e.settings,p,A),typeof f.callback=="function"&&Nn(k,A,f.callback,{scope:e})})});break;case"dropdown":k.addDropdown(v=>{let b=f.options_callback;typeof b=="function"&&b.call(e,e).forEach(S=>{let $=S.label||S.name||S.value;v.addOption(S.value,$)}),v.setValue(Ae(e.settings,p)||""),v.onChange(A=>{Se(e.settings,p,A),typeof f.callback=="function"&&Nn(k,A,f.callback,{scope:e}),_()})});break;case"textarea":k.addTextArea(v=>{v.setValue(String(Ae(e.settings,p)||"")),v.onChange(b=>{if(y&&!g){new Pn.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}Se(e.settings,p,b)}),y&&!g&&v.setDisabled(!0)});break;case"slider":k.addSlider(v=>{let b=f.min||0,A=f.max||100,S=f.step||1;v.setLimits(b,A,S),v.setValue(Ae(e.settings,p)||b),v.setDynamicTooltip(),v.onChange($=>{Se(e.settings,p,$),typeof f.callback=="function"&&Nn(k,$,f.callback,{scope:e})})});break;case"heading":k.setHeading();break;case"html":f.value&&k.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&k.settingEl.addClass(f.scope_class)})}return u}o(mp,"render_settings_group");function Dv(s,e,t){let n=s.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,Pn.setIcon)(n,t.btn_icon),t.btn_text&&n.setText(t.btn_text),t.label&&n.setAttr("aria-label",t.label),n.addEventListener("click",async i=>{typeof t.callback=="function"?await Nn(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),s.controlEl.appendChild(n)}o(Dv,"render_heading_button");async function Nn(s,e,t,n={}){let{scope:i=null}=n;return i?await t.call(i,e,s):await t(e,s)}o(Nn,"handle_config_callback");function Y$(s,e={}){let{container:t,group_name:n,settings_config:i,group_params:r={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(n,s,i,t,r))}o(Y$,"create_settings_group_rerender");function X$(s,e){return`<div class="model-settings" data-model-type="${s.collection_key}">
<div class="global-settings"></div>
</div>`}o(X$,"build_html");async function Rv(s,e){let n=this.create_doc_fragment(X$.call(this,s,e)).firstElementChild;return Z$.call(this,s,n,e),n}o(Rv,"render");async function Z$(s,e,t){let n=[],i=o(async r=>{this.empty(e);let[a]=qs(s.env_config.settings_config,s,e,{default_group_name:`${s.model_type} models`,heading_btn:{btn_text:"+ New",callback:o((c,l)=>{Bc(s,c)},"callback")}});s.env.smart_components.render_component("settings_env_model",r,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(s.default),n.push(s.on_event("settings:changed",async r=>{let a=`${s.collection_key}.default_model_key`;r.path_string===a&&await i(s.default)})),n.push(s.on_event("model:changed",async()=>{await i(s.default)})),this.attach_disposer(e,n)}o(Z$,"post_process");function Q$(s,e){return`<div class="env-model-types">
${[s.embedding_models,s.chat_completion_models,s.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}o(Q$,"build_html");async function Fv(s,e){let n=this.create_doc_fragment(Q$(s,e)).firstElementChild;return ej.call(this,s,n,e),n}o(Fv,"render");async function ej(s,e,t){let n=e.querySelectorAll("div[data-collection-key]");for(let i of n){let r=i.getAttribute("data-collection-key"),a=s[r];s.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}o(ej,"post_process");var Wv=require("obsidian");function Wc(s){s.settings||(s.settings={}),s.settings.smart_sources||(s.settings.smart_sources={});let e=s.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}o(Wc,"ensure_smart_sources_settings");function zo(s=""){return s.split(",").map(e=>e.trim()).filter(Boolean)}o(zo,"parse_exclusions_csv");function Bv(s,e){let t=(e??"").trim();if(!t)return s||"";let n=zo(s);return n.includes(t)||n.push(t),n.join(",")}o(Bv,"add_exclusion");function Uv(s,e){let t=(e??"").trim();return t?zo(s).filter(i=>i!==t).join(","):s?.trim()||""}o(Uv,"remove_exclusion");var Gc=class extends Wv.FuzzySuggestModal{static{o(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Wc(this.env),t=zo(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Wc(this.env);t.folder_exclusions=Bv(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Wc(this.env),t=zo(e.folder_exclusions),n=this.modalEl.querySelector(".sc-excluded-folders-header");if(n||(n=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(n)),n.empty(),n.createEl("h3").setText("Excluded folders"),!t.length){n.createEl("p").setText("No folders excluded yet.");return}let r=n.createEl("ul");t.forEach(a=>{let c=r.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=Uv(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var Gv=require("obsidian");var Hc=class extends Gv.Modal{static{o(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,n=this.app.vault.getMarkdownFiles().filter(r=>r.path.length>200).map(r=>r.path);for(let r of t)e.createEl("li").setText(r);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let r of n)i.createEl("li").setText(r)}};async function tj(s,e={}){return`
<div class="sources-settings">
</div>
`}o(tj,"build_html");async function Hv(s,e={}){let t=await tj.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return sj.call(this,s,i,e),i}o(Hv,"render");async function sj(s,e,t={}){qs({folder_exclusions:ij,view_exclusions:oj,re_import_sources:rj},s,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:o((r,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(s.events?.on("model:changed",nj(s,e))),this.attach_disposer(e,i),e}o(sj,"post_process");function nj(s,e){return async t=>{if(t.collection_key!=="embedding_models")return;let n=e.querySelector(".re-import-sources");n.classList.add("env-setting-highlight");let i=n.querySelector(".reimport-notice")?n.querySelector(".reimport-notice"):n.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",n.appendChild(i),s.events.once("sources:reimported",()=>{n.classList.remove("env-setting-highlight"),i.remove()})}}o(nj,"highlight_reset_data");var ij={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:o(async function(s,e){let t=this,n=new Gc(t.main.app,t),i=o(()=>{t.update_exclusions()},"selection_callback");n.open(i)},"callback")},oj={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:o(async function(s,e){let t=this;new Hc(t.main.app,t).open()},"callback")},rj={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:o(async function(s,e){let t=this,n=e.controlEl,i=n.createEl("div",{cls:"sc-inline-confirm-row"}),r=n.querySelector("button");r.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",r.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",r.style.display="inline-block"},{once:!0})},"callback")};function aj(s,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}o(aj,"build_html");async function Jv(s,e={}){let n=this.create_doc_fragment(aj(s,e)).firstElementChild;return cj.call(this,s,n,e),n}o(Jv,"render");async function cj(s,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),Bc(s.collection,l,_)});let i=e.querySelector(".delete-model-btn"),r=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{r.style.display=""}),c.addEventListener("click",async()=>{r.style.display="none"}),a.addEventListener("click",async()=>{await s.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}o(cj,"post_process");async function lj(s,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(s.notices.settings?.muted||{}).length)for(let n in s.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${n}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${n}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}o(lj,"build_html");async function Vv(s,e={}){let t=await lj.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return dj.call(this,s,i,e),i}o(Vv,"render");async function dj(s,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let r=i.closest(".muted-notice"),a=r.dataset.notice;s.notices.settings.muted[a]=!1,delete s.notices.settings.muted[a],r.remove()})})}o(dj,"post_process");var Kv=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function uj(s,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}o(uj,"build_html");async function Yv(s,e={}){this.apply_style_sheet(Kv);let t=await uj.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return mj.call(this,s,i,e),i}o(Yv,"render");async function mj(s,e,t={}){let n=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),r=e.querySelector(".notifications-container");return pp.call(this,"settings_env_sources",s,i),pp.call(this,"settings_env_models",s,n),pp.call(this,"settings_notifications",s,r),e}o(mj,"post_process");function pp(s,e,t){if(e.config.components[s]){let n=this.create_doc_fragment(`<div data-component="${s}"></div>`).firstElementChild;t.appendChild(n),e.smart_components.render_component(s,e).then(i=>{this.empty(n),n.appendChild(i)})}}o(pp,"render_if_available");var Xv=require("obsidian");function pj(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}o(pj,"build_html");async function Zv(s,e={}){let t=pj(),i=this.create_doc_fragment(t).firstElementChild;return hj.call(this,s,i,e),i}o(Zv,"render");async function hj(s,e,t={}){let n=o(()=>{let r=e.querySelector(".sc-context-actions-left");this.empty(r);let a=e.querySelector(".sc-context-actions-right");this.empty(a),fj(s,a),gj(s,a),yj(s,a),bj(s,a)},"render_ctx_actions");n();let i=[];return i.push(s.on_event("context:updated",n)),this.attach_disposer(e,i),e}o(hj,"post_process");function fj(s,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{s.emit_event("context_selector:open")})}o(fj,"render_btn_open_selector");function gj(s,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",s.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{s.actions.context_copy_to_clipboard()})}o(gj,"render_btn_copy_context");function yj(s,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",s.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{s.clear_all(),s.emit_event("context:cleared")})}o(yj,"render_btn_clear_context");function bj(s,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,Xv.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),s.emit_event("context_selector:help")})}o(bj,"render_btn_help");var Qv=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var Do=require("obsidian");async function at(s){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(s);else if(Do.Platform.isMobile)new Do.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(s)}}catch(e){console.error("Failed to copy text:",e),new Do.Notice("Failed to copy.")}}o(at,"copy_to_clipboard");var kj=o(s=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(s);return}setTimeout(s,0)},"schedule_next_frame"),wj=o(s=>{let e=!1;return()=>{e||(e=!0,kj(async()=>{e=!1,await s()}))}},"create_render_scheduler");function xj(s,e={}){return`<div>
<div class="sc-context-view" data-context-key="${s.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}o(xj,"build_html");async function ek(s,e={}){let t=xj(s,e);this.apply_style_sheet(Qv);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return Ej.call(this,s,i,e),i}o(ek,"render");async function Ej(s,e,t={}){let n=[],i=o(async()=>{let d=e.querySelector(".sc-context-view-header");s.env.smart_components.render_component("smart_context_actions",s,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");s.env.smart_components.render_component("smart_context_tree",s,t).then(p=>{this.empty(_),_.appendChild(p)});let u=e.querySelector(".sc-context-view-footer");s.env.smart_components.render_component("smart_context_meta",s,t).then(p=>{this.empty(u),u.appendChild(p)})},"render_children"),r=wj(i),a=s.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,u)=>d.addEventListener(_,u)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(u=>u.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=Aj(e);await at(p)})),_.showAtMouseEvent(d)}),await i(),n.push(s.on_event("context:updated",r)),this.attach_disposer(e,n),e}o(Ej,"post_process");function Aj(s){let e=[],t=o((n,i)=>{let r=n.dataset.path;if(!r)return;let a=r.replace(/^external:/,"").replace(/^selection:/,""),c=n.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(n.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else n.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);n.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return s.querySelectorAll(":scope > ul > li").forEach(n=>t(n,0)),e.join(`
`)}o(Aj,"tree_dom_to_wikilinks");function Sj(s){return Math.ceil((s||0)/4)}o(Sj,"estimate_tokens");function Cj(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}o(Cj,"build_html");async function tk(s,e={}){let t=Cj(),i=this.create_doc_fragment(t).firstElementChild;return Oj.call(this,s,i,e),i}o(tk,"render");async function Oj(s,e,t={}){let n=o(()=>{if(s?.has_context_items){let r=s.size||0,a=Sj(r);e.textContent=`\u2248 ${r.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");n();let i=[];return i.push(s.on_event("context:updated",n)),this.attach_disposer(e,i),e}o(Oj,"post_process");function sk(s,e,t=""){let{key:n,path:i,name:r,is_file:a}=s,c=t.trim()!=="",l="",d="",_="";n||(n=i),(e.has(n)||c)&&(l=`<span class="sc-context-item-remove" data-path="${n}">\xD7</span>`),e.has(n)&&!n.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${n}" title="Connections for ${r}"></span>`,_=`<span class="sc-tree-links" data-path="${n}" title="Links for ${r}"></span>`);let u=["sc-tree-label"];return s.exists===!1&&u.push("missing"),`<li data-path="${n}" class="sc-tree-item ${a?"file":"dir"}${n.startsWith("external:")?" sc-external":""}">
${l}
<span class="${u.join(" ")}">${r}</span>
${d}
${_}
${t}
</li>`}o(sk,"build_tree_item");function nk(s){let e=qj(s),t=new Set(s.map(i=>i.key||i.path));return ik(e,t)}o(nk,"build_tree_html");function qj(s=[]){let e=o(a=>a?.key||a?.path||"","get_item_key"),t=o(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,u=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),u=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),u=!0);let y=[];if(l){let g="",k=!1;for(let v=0;v<l.length;v++)!k&&l.slice(v,v+2)==="[["?(k=!0,g+="[[",v++):k&&l.slice(v,v+2)==="]]"?(k=!1,g+="]]",v++):!k&&l[v]==="/"?(y.push(g),g=""):g+=l[v];g&&y.push(g)}return _&&y.push(_),d&&y.push(d),{segments:y,has_block:u}},"split_path_segments"),n={name:"",children:{},selected:!1},i=o((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),r=s.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of s){let c=e(a),l=a?.exists;if(!c||i(c,r.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),u=n,p="";d.forEach((f,y)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=y===d.length-1,k=g&&_;u.children[f]||(u.children[f]={name:f,path:k?c:p,children:k?[]:{},selected:!1,is_file:k||g&&f.includes(".")}),u=u.children[f],g&&(u.selected=!0,u.exists=l)})}return n}o(qj,"build_path_tree");function ik(s,e){return!s.children||!Object.keys(s.children).length?"":`<ul>${Object.values(s.children).sort((n,i)=>n.is_file!==i.is_file?n.is_file?1:-1:n.name.localeCompare(i.name)).map(n=>sk(n,e,ik(n,e))).join("")}</ul>`}o(ik,"tree_to_html");var ok=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var jj=o((s,e)=>!s||!e?!1:s===e||s.startsWith(`${e}/`)?!0:s.startsWith(`${e}#`),"is_nested_context_item");function rk(s,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(s?.data?.context_items||{}).filter(r=>jj(r,t));return[...new Set(i)]}o(rk,"get_nested_context_item_keys");var Tj=o(s=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(s);return}setTimeout(s,0)},"schedule_next_frame"),Nj=o(s=>{let e=!1;return()=>{e||(e=!0,Tj(()=>{e=!1,s()}))}},"create_render_scheduler"),Pj=o((s,e={})=>{let{target_path:t}=e,n=rk(s,{target_path:t});s.remove_items(n)},"remove_nested_context_items");function Ij(s,e={}){return`
<div class="sc-context-tree" data-context-key="${s.data.key}"></div>
`}o(Ij,"build_html");async function ak(s,e={}){this.apply_style_sheet(ok);let t=Ij(s,e),i=this.create_doc_fragment(t).firstElementChild;return Lj.call(this,s,i,e),i}o(ak,"render");async function Lj(s,e,t={}){let n=s?.env?.plugin,i=n?.registerDomEvent?.bind(n)||((l,d,_)=>l.addEventListener(d,_)),r=o(()=>{let l=s.env,d=s.context_items.filter(t.filter),_=nk(d),u=this.create_doc_fragment(_);this.empty(e),e.appendChild(u);for(let p=0;p<d.length;p++){let f=d[p],y=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!y){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(y),y.appendChild(g)})}},"render_tree_leaves"),a=Nj(r);r(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");Pj(s,{target_path:_})});let c=[];return c.push(s.on_event("context:updated",a)),this.attach_disposer(e,c),e}o(Lj,"post_process");var ck=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function zj(s,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}o(zj,"build_html");async function lk(s,e={}){let t=zj(s,e),n=this.create_doc_fragment(t);return this.apply_style_sheet(ck),await Dj.call(this,s,n,e),n}o(lk,"render");async function Dj(s,e,t={}){let n=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!n)return e;let i=e.querySelector(".source-inspector-source-info"),r=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");r&&a&&c&&r.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(s.data,null,2),a.style.display="",r.textContent="Hide source data"):(a.style.display="none",r.textContent="Show source data")});let l=s.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=s.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!s||!s.blocks||s.blocks.length===0)return this.safe_inner_html(n,"<p>No blocks</p>"),e;let u=s.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',k=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',v="",b="";try{let S=await p.read();v=S.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),b=(await p.get_embed_input(S)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(S){console.error("[source_inspector] Error reading block:",S),v='<em style="color:red;">Error reading block content</em>'}let A=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${k}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${b}</pre>
</details>
<blockquote>${v}</blockquote>
<hr>
`);n.appendChild(A)}return e}o(Dj,"post_process");var hk=require("obsidian");var In=require("obsidian");var dk=require("obsidian");var Jc=class extends dk.Modal{static{o(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var _k=require("obsidian");var Vc=class extends _k.Modal{static{o(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function uk(s,e,t={}){let{Menu:n=In.Menu}=t,i=s.main,r=o(a=>{a.preventDefault(),a.stopPropagation();let c=new n(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new In.Notice("No active note found");return}let _=s.smart_sources?.get(d.path);if(!_){new In.Notice("Active note is not indexed by Smart Environment");return}new Jc(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Vc(i.app,s).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{s.export_json(),new In.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{s.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{s.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",r),r}o(uk,"register_status_bar_context_menu");function Rj(s){let e=s?.session_events;if(!Array.isArray(e))return 0;let t=0;for(let n of e){let i=n?.event_key;typeof i=="string"&&i.startsWith("notification:")&&(t+=1)}return t}o(Rj,"get_notification_event_count");function mk(s){let e=Object.keys(s?.smart_sources?.sources_re_import_queue||{}).length,t=Rj(s?.event_logs),n=s?.is_pro?"Pro":s?.constructor?.version,i=`Smart Env${n?" "+n:""}`,r="Smart Environment status",a=null;return e>0?(i=`Embed now (${e})`,r="Click to re-import.",a="attention"):t>0&&(a=s?.event_logs?.notification_status||"info"),{message:i,title:r,indicator_count:t,indicator_level:a,embed_queue_count:e}}o(mk,"get_status_bar_state");var pk=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function Bj(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}o(Bj,"build_html");async function fk(s,e={}){this.apply_style_sheet(pk);let n=this.create_doc_fragment(Bj()).firstElementChild;return Uj.call(this,s,n,e),n}o(fk,"render");function Uj(s,e,t={}){let n=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),r=e?.querySelector?.(".smart-env-status-msg"),a=o(()=>Object.keys(s?.smart_sources?.sources_re_import_queue||{}).length,"get_embed_queue"),c=o(()=>{let u=mk(s),{message:p,title:f,indicator_count:y,indicator_level:g}=u;n&&(0,hk.setIcon)(n,"smart-connections"),i&&(i._click_handler||(i._click_handler=k=>{k.stopPropagation(),s.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),y>0?i.dataset.count=String(y):i.dataset.count="",g?i.dataset.level=String(g):i.dataset.level="info"),r.setText?.(p),e.setAttribute?.("title",f),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=k=>{if(a()>0)k.preventDefault(),k.stopPropagation(),r?.setText?.("Embedding..."),s.run_re_import?.();else{let b=new MouseEvent("contextmenu",k);e.dispatchEvent?.(b)}},e.addEventListener("click",e._click_handler))},"render_status_elm");uk(s,e),c();let l=null,d=o(()=>{l&&clearTimeout(l),l=setTimeout(()=>{c(),l=null},100)},"debounce_refresh_status_bar"),_=[];_.push(s.events.on("*",d)),this.attach_disposer(e,_)}o(Uj,"post_process");var gk=`.sc-modal-suggestion-right {\r
margin-left: auto;\r
text-align: right;\r
white-space: nowrap;\r
font-size: var(--font-ui-smaller);\r
color: var(--text-muted);\r
font-variant-numeric: tabular-nums;\r
float: right;\r
}`;function Gj(s,e={}){return`<span class="sc-modal-suggestion-right" data-sc-display-right="true">${s}</span>`}o(Gj,"build_html");function yk(s,e={}){return this.apply_style_sheet(gk),this.create_doc_fragment(Gj(s,e)).firstElementChild}o(yk,"render");var bk=require("obsidian");function Hj(s,e={}){let{plugin_name:t=s.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}o(Hj,"build_html");function vk(s,e={}){let t=Hj.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return Jj.call(this,s,i,e),i}o(vk,"render");async function Jj(s,e){let t=e.querySelector(".callout-icon"),n=(0,bk.getIcon)("hand-heart");n&&(this.empty(t),t.appendChild(n));let i=s.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:s.env})}o(Jj,"post_process");var kk=require("obsidian");function Vj(s,e={}){let{plugin_name:t=s.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}o(Vj,"build_html");function wk(s,e={}){let t=Vj.call(this,s,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),r=i.querySelector(".callout-icon"),a=(0,kk.getIcon)("smart-connections");return a&&(this.empty(r),r.appendChild(a)),Kj.call(this,s,i,e),i}o(wk,"render");function Kj(s,e){}o(Kj,"post_process");var hp=require("obsidian");async function xk(s={}){let e=this.context_items.filter(s.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new hp.Notice("No context items to copy.");let t=await this.get_text(s);await at(t);let n=Yj({item_count:e.length,char_count:t.length,max_depth:s.max_depth,exclusions:s.exclusions});this.emit_event("context:copied"),new hp.Notice(n)}o(xk,"copy_to_clipboard");function Yj(s={}){let e=Number.isFinite(s.item_count)?s.item_count:0,t=Number.isFinite(s.char_count)?s.char_count:0,n=[];n.push(`${e} file(s)`),n.push(`${Xj(t)} chars`),Number.isFinite(s.max_depth)&&n.push(`depth\u2264${s.max_depth}`);let i=Zj(s.exclusions);return i>0&&n.push(`${i} section(s) excluded`),`Copied to clipboard! (${n.join(", ")})`}o(Yj,"format_stats_message");function Xj(s){return Number.isFinite(s)?s>=1e5?`~${Math.round(s/1e3)}k`:s.toLocaleString():"0"}o(Xj,"format_char_count");function Zj(s){return s?Object.values(s).reduce((e,t)=>{let n=Number.isFinite(t)?t:0;return e+n},0):0}o(Zj,"sum_exclusions");var Qj="xml_structured",Yc={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},Ek=o((s={})=>{let e=s.template_preset||Qj;return Yc[e]?e:"custom"},"get_preset_key"),Kc=o((s,e,t,n)=>{let i=Ek(s),r=Yc[i],a=s?.[n];return i!=="custom"&&r&&typeof r[t]=="string"?r[t]:i==="custom"&&typeof a=="string"?a:e?.[n]},"get_template_value");function Xc(){return Object.entries(Yc).map(([s,e])=>({value:s,label:e.label||s}))}o(Xc,"get_template_preset_options");function Ak(s={},e={}){return{template_before:Kc(s,e,"context_template_before","template_before"),template_after:Kc(s,e,"context_template_after","template_after")}}o(Ak,"get_context_templates");function Sk(s={},e={}){let t=Ek(s),n=Yc[t],i=t==="custom"&&typeof s.json_stringify=="boolean";return{...n&&typeof n=="object"?n:{},...i?{json_stringify:s.json_stringify}:{},template_before:Kc(s,e,"item_template_before","template_before"),template_after:Kc(s,e,"item_template_after","template_after")}}o(Sk,"get_item_templates");var eT=o((s="")=>{if(typeof s!="string"||s.trim().length===0)return"";let[e]=s.split(/[\\/]/).slice(-1),[t,...n]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return n.length>0?`${i}#${n.join("#")}`:i},"derive_item_name_from_key"),tT=o(s=>eT(s.key),"get_item_name");async function Ck(s,e={}){let t={KEY:this.key,ITEM_NAME:tT(this),TIME_AGO:vm(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},n=o(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(u,p)=>t[p]||"");return c},"replace_vars"),i=Sk(this.settings,fp);(e.json_stringify||i.json_stringify)&&(s=JSON.stringify(s));let r=await n(i.template_before),a=await n(i.template_after);return["",r,s,a,""].join(`
`)}o(Ck,"merge_template");var Ok={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:o(()=>Xc(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},fp={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Ln(s=[]){if(!Array.isArray(s)||s.length===0)return"";let e={};for(let t of s){let n=sT(t),i=t.split("/").filter(Boolean),r=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?n?r[c]=r[c]??{__isExplicitFolder:!0}:r[c]=null:r=r[c]??={}}}return Zc(e),qk(e).trimEnd()}o(Ln,"build_file_tree_string");function sT(s){return typeof s=="string"&&s.endsWith("/")}o(sT,"is_folder_path");function Zc(s){if(!(!s||typeof s!="object"))for(let e of Object.keys(s)){let t=s[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Zc(t);continue}let n=Object.keys(t);if(n.length===1&&t[n[0]]!==null&&!t[n[0]].__isExplicitFolder){let i=`${e}/${n[0]}`;s[i]=t[n[0]],delete s[e],Zc(s[i])}else Zc(t)}}}o(Zc,"compress_single_child_dirs");function qk(s,e=""){let t="",n=Object.entries(s).sort((i,r)=>{let a=i[1]!==null,c=r[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(r[0])});return n.forEach(([i,r],a)=>{let c=a===n.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";r===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=qk(r,e+(c?"    ":"\u2502   ")))}),t}o(qk,"build_tree_string");async function $k(s,e={}){let t=e.context_items||[],n={FILE_TREE:o(()=>Ln(t.map(l=>l.key)),"FILE_TREE")},i=o(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(u,p)=>n[p]?.()||"");return l},"replace_vars"),r=Ak(this.settings,gp),a=await i(r.template_before),c=await i(r.template_after);return[a,s,c].join(`
`)}o($k,"merge_template");var jk={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:o(()=>Xc(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},gp={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function Ro(s={}){s?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return s.source_key?e=this.env.smart_sources.get(s.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,n)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,r=Array.isArray(n.lines)&&n.lines.length?n.lines[0]:1/0;return i-r}).map(t=>({key:t.key,display:nT(t,{show_full_path:!1}),select_action:o(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:o(({modal:n})=>{n.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}o(Ro,"context_suggest_blocks");function nT(s,e={}){if(!s?.key)return"";if(e.show_full_path??!0)return s.key.replace(/#/g," > ").replace(/\//g," > ");let n=[],[i,...r]=s.key.split("#"),a=i.split("/").pop();if(n.push(a),r.length){let c=r[r.length-1];c.startsWith("{")&&c.endsWith("}")?(r.pop(),n.push(r.pop()),s.lines&&n.push(`Lines: ${s.lines.join("-")}`)):n.push(r.pop())}return n.filter(Boolean).join(" > ")}o(nT,"get_block_display_name");var Tk="Add blocks";var Pk="Named contexts";function iT(s){let t=s?.smart_contexts?.items;return!t||typeof t!="object"?[]:Object.values(t).filter(Boolean)}o(iT,"list_context_items");function Ik(s,e){let t=[];for(let n=0;n<e.length;n+=1){let i=e[n];if(!i||typeof i.key!="string")continue;let r=Number.isFinite(i.d)?i.d:0,a=s?.data?.context_items?.[i.key],c=Number.isFinite(a?.d)?a.d:null;t.push({key:i.key,d:c===null?r:Math.min(c,r)})}return t}o(Ik,"normalize_items_preserving_depth");function Nk(s){let e=s?.key;return typeof e=="string"&&e.endsWith("#codeblock")}o(Nk,"is_codeblock_context");function oT(s,e={}){let t=e.context_name;s?.data||(s.data={});let n=Array.isArray(s?.data?.codeblock_named_contexts)?s.data.codeblock_named_contexts:[],i=new Set(n);return t&&i.add(t),s.data.codeblock_named_contexts=[...i],s.data.codeblock_named_contexts}o(oT,"update_codeblock_named_contexts");function rT(s,e={}){let t=Array.isArray(e.items)?e.items:[],n=e.context_name;return Ik(s,t).map(i=>({...i,from_named_context:n}))}o(rT,"build_codeblock_named_context_items");function aT(s,e={}){let t=e.other_ctx,n=e.context_name,i=Lk(t),r=rT(s,{items:i,context_name:n});return oT(s,{context_name:n}),s.add_items(r),r}o(aT,"apply_codeblock_named_context");function Lk(s){let e=s?.data?.context_items||{},t=Object.entries(e),n=[];for(let i=0;i<t.length;i+=1){let[r,a]=t[i];if(!r||a?.exclude)continue;let c=Number.isFinite(a?.d)?a.d:0;n.push({key:r,d:c})}return n}o(Lk,"get_items_from_context");async function Mk(s={}){let e=this,t=e?.env,n=s?.modal;n?.setInstructions&&n.setInstructions([{command:"Enter",purpose:"Merge selected context into current context"},{command:"Mod + Enter",purpose:"Open in Context Selector"}]);let i=iT(t).filter(a=>{let c=a?.data?.name;return typeof c=="string"&&c.trim().length>0}).sort((a,c)=>{let l=String(a.data.name).trim().toLowerCase(),d=String(c.data.name).trim().toLowerCase();return l.localeCompare(d)});if(!i.length)return[{key:"contexts:none",display:"No named contexts found"}];let r=[];for(let a=0;a<i.length;a+=1){let c=i[a],l=c?.key||c?.data?.key,d=String(c?.data?.name||"").trim();if(!!(e?.data?.context_items&&Object.values(e.data.context_items).some(p=>p?.from_named_context===d||p?.key===l)))continue;let u=c?.item_count||Object.keys(c?.data?.context_items||{}).length;r.push({key:`named_context:${l}`,display:`${d} (${u})`,item:c,select_action:o(({modal:p})=>{let f;if(Nk(e))f=aT(e,{other_ctx:c,context_name:d});else{let y=Lk(c);f=Ik(e,y),e.add_items(f)}if(p?.setInstructions){let y=Nk(e)?`Added ${d} as a codeblock named context`:`Merged ${f.length} item(s) from ${d}`;p.setInstructions([{command:"Enter",purpose:y}])}},"select_action"),mod_select_action:o(({modal:p})=>{p?.close&&p.close(),e.emit_event("context_selector:open",{collection_key:"smart_contexts",item_key:l})},"mod_select_action")})}return r}o(Mk,"context_suggest_contexts");var Dk=require("obsidian");var cT=Dk.Platform.isMacOS?"\u2318":"Ctrl";function lT(s){return typeof s!="string"?"":s.replace(/\/+$/g,"")}o(lT,"normalize_folder_path");function dT(s,e){let t=lT(e);return!t||s===t?!0:s.startsWith(`${t}/`)}o(dT,"is_source_in_folder");function zk(s){s?.inputEl&&(s.last_input_value=s.inputEl.value,s.inputEl.value="")}o(zk,"reset_modal_input");function _T(s,e){return Object.values(s.env?.smart_sources?.items||{}).filter(n=>dT(n.key,e))}o(_T,"get_sources_list");function uT(s,e){return e.map(t=>({key:t.key,display:t.key,select_action:o(()=>{s.add_item(t.key)},"select_action"),mod_select_action:o(({modal:n}={})=>(zk(n),Ro.call(s,{source_key:t.key,modal:n})),"mod_select_action"),arrow_right_action:o(({modal:n}={})=>(zk(n),Ro.call(s,{source_key:t.key,modal:n})),"arrow_right_action")}))}o(uT,"build_source_suggestions");function Rk(s={}){console.log("context_suggest_sources",s);let e=s?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${cT} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=_T(this,s?.folder_path||"");return uT(this,t)}o(Rk,"context_suggest_sources");var Fk="Add sources";async function Qc(s){let e=s.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let n=await t.embed(e);return s.to_item={...n},s.score_algo_key||(s.score_algo_key="similarity"),s}o(Qc,"pre_process");function yp(s){return this.vec?s.to_item?.vec?{score:bs(this.vec||[],s.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}o(yp,"similarity");yp.action_type="score";var bp="Cosine Similarity",vp="Ranks by cosine similarity between the current note and candidates.",Bk={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${bp} algorithm`,value:`${vp}`}};var kp=require("obsidian");async function el(s,e=null){try{let n=s.env.obsidian_app,i=s.key;i.endsWith("#")&&(i=i.slice(0,-1));let r;if(i.includes("#")){let[c]=i.split("#");r=n.metadataCache.getFirstLinkpathDest(c,"")}else r=n.metadataCache.getFirstLinkpathDest(i,"");if(!r){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=kp.Keymap.isModEvent(e),l=kp.Keymap.isModifier(e,"Alt");c&&l?a=n.workspace.splitActiveLeaf("vertical"):c?a=n.workspace.getLeaf(!0):a=n.workspace.getMostRecentLeaf()}else a=n.workspace.getMostRecentLeaf();if(await a.openFile(r),typeof s?.line_start=="number"){let{editor:c}=a.view,l={line:s.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}s.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),s.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}o(el,"open_source");async function Uk(s=null){await el(this,s)}o(Uk,"source_open");var Wk={collections:{embedding_models:Kb,lookup_lists:Zb},item_types:{EmbeddingModel:Cs,LookupList:Bt},items:{embedding_model:{class:Cs},lookup_list:{class:Bt}},modules:{},components:{collection_settings:{render:Qb},context_item_leaf:{render:iv},env_stats:{render:ov},form_dropdown:{render:ap},lean_coffee_callout:{render:cv},milestones:{render:hv},notifications_feed:{render:fv},pro_plugins_list:{render:$v},pro_plugins_list_item:{render:jv},settings_env_model:{render:Iv},settings_env_model_type:{render:Rv},settings_env_models:{render:Fv},settings_env_sources:{render:Hv},settings_model_actions:{render:Jv},settings_notifications:{render:Vv},settings_smart_env:{render:Yv},smart_context_actions:{render:Zv},smart_context_item:{render:ek},smart_context_meta:{render:tk},smart_context_tree:{render:ak},source_inspector:{render:lk},status_bar:{render:fk},suggest_display_right:{render:yk},supporter_callout:{render:vk},user_agreement_callout:{render:wk}},actions:{context_copy_to_clipboard:{action:xk},context_item_merge_template:{action:Ck,settings_config:Ok,default_settings:fp},context_merge_template:{action:$k,settings_config:jk,default_settings:gp},context_suggest_blocks:{action:Ro,display_name:Tk},context_suggest_contexts:{action:Mk,display_name:Pk},context_suggest_sources:{action:Rk,display_name:Fk},lookup_list_pre_process:{action:Qc,pre_process:Qc},similarity:{action:yp,settings_config:Bk,display_name:bp,display_description:vp},source_open:{action:Uk}}};var Gk={env_path:"",modules:{smart_fs:{class:za,adapter:Da},smart_view:{class:Wa,adapter:Ha},smart_embed_model:{class:_o,adapters:{transformers:En,openai:yc,ollama:kc,gemini:wc,lm_studio:xc}},smart_chat_model:{class:mo,adapters:{anthropic:po,azure:go,custom:Oo,google:Sn,gemini:vo,groq:qo,lm_studio:wo,ollama:Ao,open_router:ko,openai:Ss,xai:$o,deepseek:jo},http_adapter:new nt({adapter:xn,obsidian_request_url:wp.requestUrl})},http_adapter:{class:nt,adapter:xn,obsidian_request_url:wp.requestUrl}},collections:{context_items:Rb,event_logs:Bb,smart_components:Ib,smart_contexts:zb,smart_sources:{collection_key:"smart_sources",class:io,data_adapter:ao,source_adapters:{md:ws,txt:ws,"excalidraw.md":_c,base:cc,canvas:dc,rendered:lc},content_parsers:[$b],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:lo,data_adapter:uc,block_adapters:{md:yn,txt:yn,"excalidraw.md":yn}}},item_types:{SmartSource:fn,SmartBlock:gn},items:{smart_source:mb,smart_block:vb},default_settings:Hb,modals:{context_selector:{class:Lc,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:zc},notifications_feed_modal:{class:Mc}}};ys(Gk,Wk);var Hk=Gk;var tl=require("obsidian");function Jk(){(0,tl.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}o(Jk,"add_smart_chat_icon");function Vk(){(0,tl.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}o(Vk,"add_smart_connections_icon");function Kk(){(0,tl.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}o(Kk,"add_smart_lookup_icon");var Yk=require("obsidian");var sl={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:o(s=>{s.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:o(s=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:o(s=>{console.log("pausing"),s.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:o(s=>{s.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function mT(s){for(let e of Object.keys(s)){let t=s[e];typeof t.create!="function"&&(t.create=function(n={}){let i=this.en??e;for(let[c,l]of Object.entries(n))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let r;!n.button&&this.button?r={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:r=n.button;let a=n.timeout??this.timeout??5e3;return{text:i,button:r,timeout:a,confirm:n.confirm,immutable:n.immutable}})}return s}o(mT,"define_default_create_methods");var Mn=class{static{o(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,mT(sl)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let n=null;typeof t=="string"?n=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let r=sl[e],a={text:n||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(r?.create){let l=r.create({...t});a.text=n||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:n}){return this.active[e]=new this.adapter(t,n),this.active[e]}_build_fragment(e,t,{button:n,confirm:i,immutable:r}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),n?.text&&typeof n.callback=="function"&&this._add_button(n,l),r||this._add_mute_button(e,l),a}_add_button(e,t){let n=document.createElement("button");this.env.smart_view.safe_inner_html(n,e.text),n.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(n)}_add_mute_button(e,t){let n=document.createElement("button");(0,Yk.setIcon)(n,"bell-off"),n.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,sl["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(n)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var Xk=require("obsidian");var pT=require("obsidian");function nl(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}o(nl,"get_smart_server_url");var hT="smart-plugins-op",fT="smart-plugins-op-secret";function gT({access_token:s,refresh_token:e},t){localStorage.setItem(t+"token",s),e&&localStorage.setItem(t+"refresh",e)}o(gT,"set_local_storage_token");async function Zk(s,e){let t=bT(e.app.vault.getName()),n=`${nl()}/auth/oauth_exchange2`,i=await(0,Xk.requestUrl)({url:n,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:hT,client_secret:fT,code:s})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:r,refresh_token:a}=i.json;if(!r)throw new Error("No access_token in response");gT({access_token:r,refresh_token:a},t)}o(Zk,"exchange_code_for_tokens");var yT="_smart_plugins_oauth_";function bT(s){return`${String(s||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${yT}`}o(bT,"build_oauth_storage_prefix");function Qk(s){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let n=Ln([...new Set(t)]);return s.replace(/{{\s*folder_tree\s*}}/gi,n)}o(Qk,"replace_folder_tree_var");function ew(s){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let n=Ln([...new Set(t)]);return s.replace(/{{\s*folders_top\s*}}/gi,n)}o(ew,"replace_folders_top_var");function tw(s){console.log("replace_recent_n_var",s);let e=this;return s.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,n)=>{let i=parseInt(n,10)||0,r=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,r),r?`
- ${r}`:""}).trim()}o(tw,"replace_recent_n_var");function sw(s){let t=this.app?.metadataCache?.getTags?.()||{},n=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return s.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${n}
`).trim()}o(sw,"replace_vault_tags_var");function nw(s){s.register(e=>/{{\s*folder_tree\s*}}/i.test(e),Qk,"{{ folder_tree }}"),s.register(e=>/{{\s*folders_top\s*}}/i.test(e),ew,"{{ folders_top }}"),s.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),sw,"{{ tags }}"),s.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),tw,"{{ recent_10 }}")}o(nw,"register_completion_variable_adapter_replacements");async function ct({app:s,plugin_ids:e=[]}={}){if(!s)return;let t=s.vault?.adapter;for(let n of e)await vT(s.plugins,n)&&console.warn(`Disabled legacy plugin: ${n}`),await kT(t,n)&&console.warn(`Removed legacy plugin: ${n}`)}o(ct,"remove_smart_plugins_plugin");async function vT(s,e){if(!(!s||!(s.plugins?.[e]||s.enabledPlugins?.has?.(e)||s.manifests&&e in s.manifests)))return s.plugins?.[e]&&await s.unloadPlugin?.(e),s.disablePluginAndSave&&await s.disablePluginAndSave(e),s.enabledPlugins?.has?.(e)&&s.enabledPlugins.delete(e),s.manifests&&e in s.manifests&&delete s.manifests[e],await s.loadManifests?.(),!0}o(vT,"disable_plugin_if_present");async function kT(s,e){if(!s?.exists)return;let t=`.obsidian/plugins/${e}`;if(await s.exists(t)){if(s.rmdir){await s.rmdir(t,!0);return}if(s.list&&s.remove){let i=[t];for(;i.length;){let r=i.pop(),a=await s.list(r);for(let c of a?.files||[])await s.remove(`${r}/${c}`);for(let c of a?.folders||[])i.push(`${r}/${c}`)}return await s.remove(t),!0}}}o(kT,"remove_plugin_folder");var $s=class extends no{static{o(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,Jk(),Vk(),Kk(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new Ut.Notice(i,0),window.smart_env=null}let n=ys(t,Hk);return n.env_path="",await super.create(e,n)}async load(e=!1){if(this.run_migrations(),this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")||this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),Ut.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new Ut.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let r=i.view?.file?.path;this.emit_source_opened(r,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let r=i?.path;this.emit_source_opened(r,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&nw(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),_v(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let n=this.smart_sources.get(e);n&&(this._current_opened_source=e,n.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new Mn(this,{adapter:Ut.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),n=`${nl()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(n,"_external"),n}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new Ut.Notice("No OAuth code provided in URL. Login failed.");return}try{await Zk(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(n){console.error("OAuth callback error",n),new Ut.Notice(`OAuth callback error: ${n.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&wT(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){ct({app:this.plugin.app,plugin_ids:["smart-plugins"]}),ct({app:this.plugin.app,plugin_ids:["smart-editor"]}),ct({app:this.plugin.app,plugin_ids:["smart-sources"]}),ct({app:this.plugin.app,plugin_ids:["smart-claude"]}),ct({app:this.plugin.app,plugin_ids:["smart-gemini"]}),ct({app:this.plugin.app,plugin_ids:["smart-deepseek"]}),ct({app:this.plugin.app,plugin_ids:["smart-perplexity"]}),ct({app:this.plugin.app,plugin_ids:["smart-grok"]}),ct({app:this.plugin.app,plugin_ids:["smart-aistudio"]})}};function wT(s,e){let t=new Blob([s],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)}o(wT,"download_json");var Ap=require("obsidian");var iw=require("obsidian");async function ow(s,e={}){let{wait_for_states:t=["loaded"]}=e,n=s.container||s.containerEl;if(!t.includes(s.env?.state)){let i=!1;for(;s.env.state==="init"&&iw.Platform.isMobile&&!i;)n?(n.empty(),s.env.smart_view.safe_inner_html(n,"<button>Load Smart Environment</button>"),n.querySelector("button").addEventListener("click",()=>{s.env.load(!0),i=!0})):console.log("Waiting for env to load (mobile)..."),await new Promise(r=>setTimeout(r,2e3));for(;!t.includes(s.env.state);){if(n){let r=s.env?.obsidian_is_syncing?"Waiting for Obsidian Sync to finish...":"Loading Obsidian Smart Environment...";n.empty(),s.env.smart_view.safe_inner_html(n,r)}else console.log("Waiting for env to load...");await new Promise(r=>setTimeout(r,2e3))}}}o(ow,"wait_for_env_to_load");var xp=`/* 1) Host elements that should get a PRO badge */\r
:is(\r
.pro-setting .setting-item-name\r
) {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
:is(\r
.pro-setting .setting-item-name:not(:empty)\r
)::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
:is(\r
.pro-setting .setting-item-name\r
):hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
.pro-plugins-container {\r
border: 1px solid var(--interactive-accent);\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-top: 1rem;\r
background-color: var(--background-secondary);\r
}\r
\r
.smart-plugin-settings-header .actions-container {\r
display: flex;\r
flex-wrap: wrap;\r
gap: var(--pill-padding-y);\r
}\r
\r
.setting-component:has(.dropdown-no-options) {\r
display: none;\r
}\r
\r
/* wrap Obsidian native styles within smart plugin settings main class */\r
.smart-plugin-settings-main, .smart-plugin-settings-env {\r
.setting-group {\r
margin-top: var(--size-4-6);\r
margin-bottom: var(--size-4-6);\r
}\r
/* polyfill */\r
.setting-group .setting-items {\r
background-color: var(--setting-items-background, var(--background-primary-alt));\r
padding: var(--setting-items-padding, var(--size-4-5));\r
border-radius: var(--setting-items-radius, var(--radius-l));\r
border: var(--setting-items-border-width, 0) solid var(--setting-items-border-color, var(--background-modifier-border));\r
}\r
}\r
`;var Fo=class extends Ap.PluginSettingTab{static{o(this,"SmartPluginSettingsTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.env.is_pro&&!this.env_settings_tab&&this.plugin.addSettingTab(new Ep(this.plugin.app,this.plugin)),this.icon="smart-connections",this.env.is_pro&&(this.name=this.name.replace("Smart ",""))}get smart_view(){return this.env?.smart_view}async display(){await this.render()}async render(){this.containerEl.empty(),rw(this),await this.env.constructor.wait_for({loaded:!0}),this.prepare_layout(),await this.render_header(this.header_container),await this.render_plugin_settings(this.plugin_container),await this.render_global_settings(this.global_settings_container)}prepare_layout(){this.smart_view.apply_style_sheet(xp),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.global_settings_container=this.containerEl.createDiv({cls:"smart-plugin-settings-env"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"})}async render_header(e){}async render_plugin_settings(e){}async render_global_settings(e){if(!e||(e.empty?.(),!this.env))return;if(this.env.is_pro){let n=e.createDiv({cls:"setting-item"}),i=n.createDiv({cls:"setting-item-info"});i.createDiv({cls:"setting-item-name",text:"Smart Environment"}),i.createDiv({cls:"setting-item-description",text:"Manage global settings in the dedicated Smart Environment settings tab."}),n.createDiv({cls:"setting-item-control"}).createEl("button",{text:"Open settings"}).addEventListener("click",()=>{this.app.setting.openTabById("smart-environment")})}else{let n=await this.render_component("settings_smart_env",this.env);n&&e.appendChild(n)}let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}async render_component(e,t,n={}){return await this.env.smart_components.render_component(e,t,n)}get env_settings_tab(){return(this.plugin.app||window.app).setting.pluginTabs.find(t=>t.id==="smart-environment")}},Ep=class extends Ap.PluginSettingTab{static{o(this,"SmartEnvSettingTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.plugin=t,this.name="Smart Env Pro",this.id="smart-environment",this.icon="smart-connections"}get smart_view(){return this.env?.smart_view}display(){this.render()}async render_component(e,t,n={}){return await this.env.smart_components.render_component(e,t,n)}async render(){this.containerEl.empty(),this.smart_view.apply_style_sheet(xp),rw(this),await this.env.constructor.wait_for({loaded:!0}),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"}),this.header_container.createEl("p",{text:"Manage all global Smart Environment settings from one tab. These settings apply to all Smart Plugins."});let e=await this.render_component("settings_smart_env",this.env);e&&this.plugin_container.appendChild(e);let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}};function rw(s){let e=s.containerEl,t=s.env;if(t.state!=="loaded")if(t.state==="loading")e.createEl("p",{text:"Smart Environment is loading\u2026"});else{e.createEl("p",{text:"Smart Environment not yet initialized."});let n=e.createEl("button",{text:"Load Smart Environment"});n.addEventListener("click",async()=>{n.disabled=!0,n.textContent="Loading Smart Environment\u2026",await t.load(!0)})}}o(rw,"render_pre_env_load");var il=require("obsidian");var Bo=class extends il.Plugin{static{o(this,"SmartPlugin")}SmartEnv=$s;get commands(){return{show_release_notes:{id:"show-release-notes",name:"Show release notes",callback:o(()=>this.show_release_notes(),"callback")}}}register_commands(){Object.values(this.commands).forEach(e=>{this.addCommand(e)})}get ribbon_icons(){return{}}register_ribbon_icons(){let e=Object.values(this.ribbon_icons);for(let t=0;t<e.length;t++){let n=e[t];this.addRibbonIcon(n.icon_name,n.description,n.callback)}}get item_views(){return{}}register_item_views(){let e=Object.values(this.item_views);for(let t=0;t<e.length;t++){let n=e[t];typeof n.register_item_view=="function"&&n.register_item_view(this)}}async is_new_user(){let e=await this.loadData()||{};return e.installed_at?!1:(e.installed_at=Date.now(),await this.saveData(e),!0)}async get_last_known_version(){return(await this.loadData()||{}).last_version||""}async set_last_known_version(e){let t=await this.loadData()||{};t.last_version=e,await this.saveData(t)}async is_new_plugin_version(e){return await this.get_last_known_version()!==e}get notices(){return this.env?.notices?this.env.notices:(this._notices||(this._notices=new Mn(this.env,il.Notice)),this._notices)}};function ol(s){return s.endsWith("Item")?s.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():s.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}o(ol,"collection_instance_name_from");function js(s={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(aw(e[t])&&aw(s[t])?js(s[t],e[t]):s[t]=e[t]);return s}o(js,"deep_merge");function aw(s){return s&&typeof s=="object"&&!Array.isArray(s)}o(aw,"is_plain_object");function cw(s){let e=JSON.stringify(s),t=0;if(e.length===0)return t;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}o(cw,"create_uid");function lw(s=""){return s.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}o(lw,"camel_case_to_snake_case");function rl(s,e,t=new WeakMap){if(s===e)return!0;if(s===null||e===null||s===void 0||e===void 0||typeof s!=typeof e||Array.isArray(s)!==Array.isArray(e))return!1;if(Array.isArray(s))return s.length!==e.length?!1:s.every((n,i)=>rl(n,e[i],t));if(typeof s=="object"){if(t.has(s))return t.get(s)===e;t.set(s,e);let n=Object.keys(s),i=Object.keys(e);return n.length!==i.length?!1:n.every(r=>rl(s[r],e[r],t))}return s===e}o(rl,"deep_equal");function dw(s,e){return e?s.split("/").join(" > ").replace(".md",""):s.split("/").pop().replace(".md","")}o(dw,"get_item_display_name");function al(s,e){let t=e||{},n=o(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=o(m=>typeof m=="function","is_function"),r=o(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=o(m=>n(m)&&i(m.action),"is_action_object"),c=o(m=>i(m)||a(m)||r(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=o(m=>{if(!n(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let O=Object.getOwnPropertyDescriptor(m,w);if(!O)continue;let E={...O};"value"in E&&n(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=o(m=>{if(!n(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let O of h){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E){let q=E.value;if(c(q)){w=!0;continue}if(n(q)){if(_(q)){w=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=o(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=n(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=o(m=>{let h=Object.create(null),w=new Map;for(let O of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E&&_(E.value)){w.set(O,d(E.value));continue}try{Object.defineProperty(h,O,u(E))}catch{h[O]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=o((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=o((m,h,w=[])=>{if(!m||!h)return;let O=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(O.has(E))continue;let q=Object.getOwnPropertyDescriptor(m,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),b=o(m=>{let h=new m(s),w=h.action||h.run||h.execute||h.call;if(i(w)){let O=w.bind(h);return v(m,O),v(h,O),O.instance=h,O}return v(m,h),h},"instantiate_class"),A=o(m=>{if(r(m))return b(m);if(a(m)){let h=m.action.bind(s);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(s);return v(m,h),h}return n(m)?d(m):m},"bind_or_clone"),S=o(()=>{let m=s?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&n(h)?h:null},"scope_actions_for"),$=o((m,h,w)=>(m[h]=w,w),"cache_result"),j=o((m,h)=>{let w=S();return w&&g(w,h)?$(m,h,A(w[h])):g(f,h)?$(m,h,A(f[h])):$(m,h,void 0)},"compute_and_cache"),C=o(()=>{let m=S(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=o((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:o((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:o((m,h)=>{if(h in m)return!0;let w=S();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:o(()=>C(),"ownKeys"),getOwnPropertyDescriptor:o((m,h)=>{if(g(m,h))return x(m,h);let w=S();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:o((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:o((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:o((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}o(al,"create_actions_proxy");var Uo=class s{static{o(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&js(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let n=new this(e,t);return n.init(),n}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let n=e.defaults[t];typeof n=="object"?this[t]={...n,...this[t]}:this[t]=this[t]===void 0?n:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return cw(this.data)}update_data(e){let t=this.sanitize_data(e),n={...this.data};return js(n,t),!rl(this.data,n)?(this.data=n,!0):!1}sanitize_data(e){return e instanceof s?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,n)=>(t[n]=this.sanitize_data(e[n]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:n=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:r,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(n?.includes(this.key)||i&&this.key.startsWith(i)||r&&r.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=al(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),ol(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),ol(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),lw(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}once_event(e,t){return this.env.events?.once(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return dw(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var ET=Object.getPrototypeOf(async function(){}).constructor,Wo=class{static{o(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),n=t||new this.item_type(this.env);n._queue_save=!t;let i=n.update_data(e);return!t&&!n.validate_save()?n:(t||this.set(n),t&&!i?t:n.init instanceof ET?new Promise(r=>{n.init(e).then(()=>r(n))}):(n.init(e),n))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),n=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return js(t.data,n),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:n}=e;for(let i of Object.values(this.items)){if(n&&t.length>=n)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let n=this.filter(e);return n[Math.floor(Math.random()*n.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(n=>n.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],n=e+"_adapter",i=t?.[n]??this.env.opts.collections?.smart_collections?.[n];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,n)=>{let i=t?.class?.version||t.version||0;return(n?.class?.version||n.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let n=o(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[r,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=n(c.callback)),c.btn_callback&&(c.btn_callback=n(c.btn_callback)),c.options_callback&&(c.options_callback=n(c.options_callback));let l=n(this.process_setting_key(r));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.collection_key&&n.collection_key!==this.collection_key||t(n)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=al(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let n=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(n),e}};function uw(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.min===Number.POSITIVE_INFINITY){let{minScore:n,minObj:i}=_w(s.results);s.min=n,s.minResult=i}}else if(e.score>s.min){s.results.add(e),s.results.delete(s.minResult);let{minScore:n,minObj:i}=_w(s.results);s.min=n,s.minResult=i}}o(uw,"results_acc");function _w(s){let e=Number.POSITIVE_INFINITY,t=null;for(let n of s)n.score<e&&(e=n.score,t=n);return{minScore:e,minObj:t}}o(_w,"find_min");function AT(s,e){let n=s.score-e.score;return Math.abs(n)<1e-9?0:n>0?-1:1}o(AT,"sort_by_score");function mw(s,e){return AT(s,e)}o(mw,"sort_by_score_descending");function pw(s,e){if(!e.pinned?.length)return s;let t=new Set(e.pinned_keys||e.pinned.map(r=>r.key)),n=e.pinned.map(r=>({item:r,...r.score?.(e)||{}})),i=s.filter(r=>{let a=r?.item?.key;return a?!t.has(a):!0});return[...n,...i]}o(pw,"merge_pinned_results");var ST="smart_sources",CT="smart_blocks";function hw(s){return!!s&&typeof s=="object"&&!Array.isArray(s)}o(hw,"is_plain_object");function OT(s){return hw(s)?Object.entries(s).filter(([,e])=>e!=null):[]}o(OT,"select_hidden_entries");function qT(s){return s.includes("#")?CT:ST}o(qT,"get_collection_prefix");function $T(s){return typeof s!="string"||s.includes(":")?s:`${qT(s)}:${s}`}o($T,"ensure_prefixed_key");function fw(s){let e=OT(s?.data?.hidden_connections);if(!e.length)return!1;hw(s.data.connections)||(s.data.connections={});let t=!1;return e.forEach(([n,i])=>{let r=$T(n);if(typeof r!="string")return;let a=s.data.connections[r]||{};(a.hidden===void 0||a.hidden===null)&&(a.hidden=i,t=!0),s.data.connections[r]=a}),t&&delete s.data.hidden_connections,t||e.length>0}o(fw,"migrate_hidden_connections");var qe=class extends Uo{static{o(this,"ConnectionsList")}static key="connections_list";static get defaults(){return{data:{}}}get_key(){return`${this.data.collection_key}:${this.data.item_key}`}async pre_process(e){fw(this.item),typeof this.actions.connections_list_pre_process=="function"&&await this.actions.connections_list_pre_process(e),typeof this.env.config?.actions?.[e.score_algo_key]?.pre_process=="function"&&await this.env.config.actions[e.score_algo_key].pre_process.call(this.item,e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return t=await this.post_process(t,e),t=pw(t,e),t=t.map(n=>Object.assign(n,{connections_list:this})),this.results=t,t}filter_and_score(e={}){let t=this.env[e.results_collection_key],n=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(uw(a,l,e.limit),a):(l?.error&&n.push(l.error),a)},{min:0,results:new Set}),r=Array.from(i).sort(mw);if(!r.length)return r;for(;!r.some(a=>a.score>.5);)r.forEach(a=>a.score*=2);return r}async post_process(e,t={}){if(!e?.length)return console.warn("No results to post-process, received:",e),[];let n=this.settings.connections_post_process,i=this.actions[n],r=e;if(typeof i=="function"){let a=await i(e,t);Array.isArray(a)?(r=a.filter(Boolean),r.length||(r=e)):a!=null&&console.warn(`connections post_process '${n}' returned non-array`,a)}else n&&n!=="none"&&console.warn(`Post-process action "${n}" not found, falling back to base results.`);return r}get item(){return this.env[this.data.collection_key]?.items[this.data.item_key]}get connections_list_component_key(){let e=this.data.connections_list_component_key||this.settings?.connections_list_component_key;return this.env.config.components[e]?e:"connections_list_v3"}};var jT=["inline_connections","inline_connections_score_threshold","footer_connections"];function gw(s){let e=s?.settings;if(!e)return!1;let t=e.connections_pro;if(!t)return!1;let n=e.connections_lists||={},i=!1;for(let r of jT)r in t&&(r in n||(n[r]=t[r],i=!0),delete t[r]);return"rank_model"in t&&(n.actions||(n.actions={}),"rank_connections"in n.actions||(n.actions.rank_connections=t.rank_model,i=!0),delete t.rank_model),i}o(gw,"migrate_connections_lists_settings");function cl(s,e,t){let n=Object.entries({...e}),i=n.findIndex(([r])=>r===s);if(i!==-1&&t&&Object.keys(t).length>0){let r=Object.entries(t);n.splice(i+1,0,...r)}return Object.fromEntries(n)}o(cl,"insert_settings_after");var Go=class extends Wo{static{o(this,"ConnectionsLists")}static version=1;process_load_queue(){}constructor(e,t={}){gw(e),super(e,t)}static get default_settings(){return{results_collection_key:"smart_sources",score_algo_key:"similarity",connections_post_process:"none",results_limit:20,exclude_frontmatter_blocks:!0,connections_list_item_component_key:"connections_list_item_v3",components:{connections_list_item_v3:{render_markdown:!0,show_full_path:!1}}}}get settings_config(){return ll(this)}new_item(e){let t=new this.item_type(this.env,{collection_key:e.collection_key,item_key:e.key});return this.set(t),Object.defineProperty(e,"connections",{get:o(()=>t,"get"),configurable:!0}),t}get_connections_list_item_options(){return Object.entries(this.env.config.components||{}).filter(([e,t])=>e.startsWith("connections_list_item_")).map(([e,t])=>({value:e,name:t.display_name||e,description:t.display_description}))}get score_algo_key(){let e=this.settings?.score_algo_key;return this.env.config?.actions?.[e]?e:"similarity"}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env[e]?e:"smart_sources"}};function ll(s){let e={results_collection_key:{name:"Connection results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:o(()=>{let t=[{value:"smart_sources",name:"Sources"}];return s.env.smart_blocks&&t.push({value:"smart_blocks",name:"Blocks"}),t},"options_callback")},results_limit:{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20)."}};return s.env.smart_blocks.settings.embed_blocks||(e.results_collection_key={type:"html",value:Yb("Connection results type",'Enable "Embed blocks" in Smart Blocks settings to use block connections.'),name:"Connection results type"}),e}o(ll,"settings_config");var yw={class:Go,collection_key:"connections_lists",item_type:qe,settings_config:ll};var bw=`.connections-codeblock {\r
.connections-top-bar {\r
display: flex;\r
gap: 0.5rem 1rem;\r
\r
.connections-actions {\r
display: flex;\r
flex-direction: row;\r
flex-wrap: wrap;\r
align-items: center;\r
gap: 0.5rem;\r
span {\r
font-weight: 600;\r
justify-self: end;\r
}\r
}\r
}\r
.connections-list {\r
padding-top: 0.85rem;\r
\r
> .sc-collapsed ul {\r
display: none;\r
}\r
> .sc-collapsed span svg {\r
transform: rotate(-90deg);\r
}\r
> .sc-result-pinned {\r
box-shadow: 0 0 0 1px var(--interactive-accent);\r
border-radius: var(--radius-s);\r
background-color: var(--background-modifier-hover);\r
}\r
}\r
}`;var Dn=require("obsidian");var dl=require("obsidian");function Sp(s,e){let t=s.app.internalPlugins?.plugins?.webviewer?.instance;window.open(e,t?"_external":"_blank")}o(Sp,"open_url_externally");var We=class s extends dl.Modal{static{o(this,"StoryModal")}constructor(e,{title:t,url:n}){super(e.app),this.plugin=e,this.title=t,this.url=n}static open(e,t){new s(e,t).open()}onOpen(){this.titleEl.setText(this.title),this.modalEl.addClass("sc-story-modal"),this.modalEl.style.width="80%",this.modalEl.style.height="80%";let e=this.contentEl.createEl("div",{cls:"sc-story-container"});if(e.style.display="flex",e.style.flexDirection="column",e.style.height="100%",dl.Platform.isMobile){e.createEl("button",{text:"Open in browser"}).addEventListener("click",()=>{Sp(this.plugin,this.url),this.close()});return}else{let t=e.createEl("webview",{attr:{src:this.url,allowpopups:""}});t.style.width="100%",t.style.height="100%",t.addEventListener("did-navigate",n=>{let i=n.url||t.getAttribute("src");i&&i!==this.url&&(Sp(this.plugin,i),this.close())})}}onClose(){this.contentEl.empty()}};function _l(s={}){let{source_item:e,results:t=[]}=s,n=[],i=new Set,r=o((a,c)=>{let l=a?.key;!l||i.has(l)||(i.add(l),n.push({key:l,score:c}))},"append_item");return e&&r(e,e.score??1),t.forEach(a=>r(a?.item,a?.score)),n}o(_l,"build_connections_context_items");function zn(s=[]){return!Array.isArray(s)||!s.length?"":s.map(({item:e})=>NT(e)).filter(Boolean).join(`
`)}o(zn,"format_connections_as_links");function NT(s){if(!s?.key)return"";let e=IT(s);if(!e)return"";let t=PT(s);return t?`${e.replace(/\#\{\d+\}/,"")} (${t})`:e}o(NT,"format_connection_item");function PT(s){return!s?.key?.endsWith("}")||!Array.isArray(s.lines)||!s.lines.length?"":`Lines: ${s.lines.join("-")}`}o(PT,"get_lines_label");function IT(s){if(!s?.key)return"";let[e,...t]=s.key.split("#"),n=e.split("/").pop().replace(/\.md$/i,"");if(t.length){let i=t.pop();return`- [[${n}#${i}]]`}return`- [[${n}]]`}o(IT,"get_wikilink");function Wt(s,e){return typeof e!="string"||!e.length||e.includes(":")||typeof s!="string"||!s.length?e:`${s}:${e}`}o(Wt,"build_prefixed_connection_key");function vw(s,e,t=Date.now()){if(!s||typeof s!="object"||typeof e!="string"||!e.length)return s;let n=s[e]||{};return n.hidden=t,s[e]=n,s}o(vw,"apply_hidden_state");function kw(s,e,t=Date.now()){if(!s||typeof s!="object"||typeof e!="string"||!e.length)return s;let n=s[e]||{};return n.pinned=t,s[e]=n,s}o(kw,"apply_pinned_state");function ww(s,e){if(!s||typeof s!="object"||typeof e!="string"||!e.length)return s;let t=s[e];return!t||typeof t!="object"||(delete t.pinned,Object.keys(t).length||delete s[e]),s}o(ww,"remove_pinned_state");function xw(s){if(!s||typeof s!="object")return!1;let e=!1;return Object.entries(s).forEach(([t,n])=>{!n||typeof n!="object"||n.hidden===void 0||n.hidden===null||(delete n.hidden,Object.keys(n).length||delete s[t],e=!0)}),e}o(xw,"remove_all_hidden_states");function Ew(s){if(!s||typeof s!="object")return!1;let e=!1;return Object.entries(s).forEach(([t,n])=>{!n||typeof n!="object"||n.pinned===void 0||n.pinned===null||(delete n.pinned,Object.keys(n).length||delete s[t],e=!0)}),e}o(Ew,"remove_all_pinned_states");function Aw(s){return!s||typeof s!="object"?0:Object.values(s).reduce((e,t)=>t&&typeof t=="object"&&t.hidden!==void 0&&t.hidden!==null?e+1:e,0)}o(Aw,"count_hidden_connections");function Sw(s){return!s||typeof s!="object"?0:Object.values(s).reduce((e,t)=>t&&typeof t=="object"&&t.pinned!==void 0&&t.pinned!==null?e+1:e,0)}o(Sw,"count_pinned_connections");function Ho(s,e){if(!s||typeof s!="object"||typeof e!="string"||!e.length)return!1;let t=s[e];return!t||typeof t!="object"?!1:t.pinned!==void 0&&t.pinned!==null}o(Ho,"is_connection_pinned");function ul(s,e){if(!s||typeof s!="object"||typeof e!="string"||!e.length)return!1;let t=s[e];return!t||typeof t!="object"?!1:t.hidden!==void 0&&t.hidden!==null}o(ul,"is_connection_hidden");function Jo(s=[],e={}){return!Array.isArray(s)||!s.length?[]:!e||typeof e!="object"?s:s.filter(t=>{let n=t?.item;if(!n)return!1;let i=Wt(n.collection_key,n.key),r=e[i];if(!r||typeof r!="object")return!0;let a=r.hidden!==void 0&&r.hidden!==null,c=r.pinned!==void 0&&r.pinned!==null;return!(a&&!c)})}o(Jo,"filter_hidden_results");async function LT(s,e={}){return`<div class="connections-codeblock connections-item-view sc-connections-view">
<div class="connections-top-bar">
<div class="connections-actions">
${[{title:"Refresh connections",icon:"refresh-cw",attrs:'data-action="refresh-connections"'},{title:"Expand all",icon:"unfold-vertical",attrs:'data-action="expand-all"'},{title:"Collapse all",icon:"fold-vertical",attrs:'data-action="collapse-all"'},{title:"Send results to Smart Context",icon:"briefcase",attrs:'data-action="send-to-smart-context"'},{title:"Copy as list of links",icon:"copy",attrs:'data-action="copy-as-links"'},{title:"Connections settings",icon:"settings",attrs:'data-action="open-settings"'},{title:"Help & getting started",icon:"help-circle",attrs:'data-action="open-help"'}].map(i=>`
<button
aria-label="${i.title}"
${i.attrs??""}
>
${this.get_icon_html(i.icon)}
</button>
`).join("")}
<span>Smart Connections</span>
</div>
</div>
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div>`}o(LT,"build_html");async function Ow(s,e={}){let t=await LT.call(this,s,e),n=this.create_doc_fragment(t);this.apply_style_sheet(bw);let i=n.firstElementChild;return MT.call(this,s,i,e),n}o(Ow,"render");async function MT(s,e,t={}){let n=e.querySelector(".connections-list-container"),i=s.env,r=i.plugin.app||window.app,a=o(async()=>{console.log("Rendering connections list in codeblock view");let c=t.connections_list_component_key||s.connections_list_component_key||"connections_list_v3",l=await i.smart_components.render_component(c,s,t);this.empty(n),n.appendChild(l)},"render_list");if(!e._has_listeners){e._has_listeners=!0,e.querySelector('[data-action="refresh-connections"]')?.addEventListener("click",async()=>{let g=s.item;g?(await g.read(),g.queue_import(),await g.collection.process_source_import_queue?.(),a()):console.warn("No entity found for refresh")}),e.querySelector('[data-action="expand-all"]')?.addEventListener("click",()=>{e.querySelectorAll(".sc-result").forEach(g=>{g.classList.remove("sc-collapsed")})}),e.querySelector('[data-action="collapse-all"]')?.addEventListener("click",()=>{e.querySelectorAll(".sc-result").forEach(g=>{g.classList.add("sc-collapsed")})}),e.querySelector('[data-action="send-to-smart-context"]')?.addEventListener("click",async()=>{let g=await Cw(s,t);if(!g.length)return new Dn.Notice("No connection results to send to Smart Context");let k=s?.item?.data?.connections||{},v=Jo(g,k),b=_l({source_item:s?.item,results:v});if(!b.length)return new Dn.Notice("No visible connection results to send to Smart Context");let A=i.smart_contexts.new_context();A.add_items(b),A.emit_event("context_selector:open"),s.emit_event("connections:sent_to_context")}),e.querySelector('[data-action="copy-as-links"]')?.addEventListener("click",async()=>{let g=await Cw(s,t);if(!g.length)return new Dn.Notice("No connection results to copy");let k=s?.item?.data?.connections||{},v=Jo(g,k),b=zn(v);if(!b)return new Dn.Notice("No visible connection results to copy");await at(b),new Dn.Notice("Copied connections as list of links"),s.emit_event("connections:copied_list")}),e.querySelector('[data-action="open-settings"]')?.addEventListener("click",()=>{r.setting.open(),r.setting.openTabById("smart-connections")});let f=o(()=>{We.open(i.plugin,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=connections-view-help#page=understanding-connections-1"})},"open_help");e.querySelector('[data-action="open-help"]')?.addEventListener("click",f)}return a(),e}o(MT,"post_process");async function Cw(s,e={}){let t=Array.isArray(s?.results)?s.results:[];if(t.length)return t;try{let n=await s.get_results({...e});return Array.isArray(n)?n:[]}catch(n){return console.error("Failed to fetch connections results",n),[]}}o(Cw,"get_results_fallback");var Gt=require("obsidian");var qw=`a.sc-result-file-title {
text-decoration: none !important;
}

a.sc-result-file-title > .sc-score {
display: inline-block;
width: auto;
height: 1.7em;
padding: 0 0.3em;
line-height: 1.7em;
text-align: center;
font-weight: 600 !important;
font-size: 0.8em !important;
color: var(--nav-item-color) !important;
background: var(--background-modifier-hover);
border-radius: 6px;
}

a.sc-result-file-title > .sc-path {
margin-right: -3px;
}

a.sc-result-file-title > .sc-path,
a.sc-result-file-title > .sc-title {
font-weight: bold !important;
text-decoration: underline;
}

a.sc-result-file-title > .sc-breadcrumb:not(.sc-path, .sc-title, .sc-score) {
font-style: italic;
}

a.sc-result-file-title > .sc-breadcrumb-separator {
color: color-mix(in srgb, var(--text-normal) 50%, transparent) !important;
}

.sc-result.sc-result-graph-focus {
outline: 2px solid color-mix(in srgb, var(--interactive-accent) 70%, transparent);
border-radius: var(--radius-s);
box-shadow:
0 0 0 1px color-mix(in srgb, var(--background-primary) 80%, transparent),
0 0 0.5rem color-mix(in srgb, var(--interactive-accent) 45%, transparent);
transition: outline 120ms ease, box-shadow 120ms ease;
}
`;function Vo(s,e={}){if(!s?.key)return"";if(e.show_full_path??!0)return s.key.replace(/#/g," \u203A ").replace(/\//g," \u203A ");let n=[],[i,...r]=s.key.split("#"),a=i.split("/").pop();return n.push(a),r.length&&n.push(r.pop()),n.join(" \u203A ")}o(Vo,"get_item_display_name");function $w(s){if(!s)return"";let[e,...t]=s.split("#"),n=e.split("/").pop().replace(/\.md$/,"");if(!t.length)return`[[${n}]]`;let i=t.filter(r=>!r.startsWith("{")).pop();return i?`[[${n}#${i}]]`:`[[${n}]]`}o($w,"parse_item_key_to_wikilink");function DT(s,e,t,n){let i=s.dragManager,r=$w(e.key),a=i.dragLink(n,r);i.onDragStart(n,a),t.drag_event_key?e.emit_event(t.drag_event_key):e.emit_event("connections:drag_result")}o(DT,"handle_connection_drag");function jw(s,e,t={}){let i=e.env.obsidian_app;s.setAttribute("draggable","true"),s.addEventListener("dragstart",DT.bind(null,i,e,t))}o(jw,"register_item_drag");async function FT(s,e={}){let t=s.item,n=t.env,i=s.score,r=e.connections_settings??n.connections_lists.settings,a=r.components?.connections_list_item_v3||{},c=UT(i,t,a);return`<div class="temp-container">
<div
class="sc-result ${r.expanded_view?"":"sc-collapsed"}"
data-path="${t.path.replace(/"/g,"&quot;")}"
data-link="${t.link?.replace(/"/g,"&quot;")||""}"
data-collection="${t.collection_key}"
data-score="${i}"
data-key="${t.key}"
draggable="true"
>
<span class="header">
${this.get_icon_html("right-triangle")}
<a class="sc-result-file-title" href="#" title="${t.path.replace(/"/g,"&quot;")}" draggable="true">
${c}
</a>
</span>
<ul draggable="true">
<li class="sc-result-file-title" title="${t.path.replace(/"/g,"&quot;")}" data-collection="${t.collection_key}" data-key="${t.key}"></li>
</ul>
</div>
</div>`}o(FT,"build_html");async function Tw(s,e={}){this.apply_style_sheet(qw);let t=await FT.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".sc-result");return BT.call(this,s,i,e),i}o(Tw,"render");async function BT(s,e,t={}){let{item:n}=s,i=n.env,r=i.smart_connections_plugin,a=r.app,l=(t.connections_settings??i.connections_lists.settings).components?.connections_list_item_v3||{},d=l?.render_markdown??!0;d||e.classList.add("sc-result-plaintext");let _=s.connections_list?.item,u=Wt(n.collection_key,n.key);e.dataset.prefixedKey=u;let p=_?.data?.connections;ul(p,u)&&(e.style.display="none",e.dataset.hidden="true"),Ho(p,u)&&(e.classList.add("sc-result-pinned"),e.dataset.pinned="true");let f=o(async b=>{if(!b.querySelector("li").innerHTML){let A=b.dataset.collection,S=i[A].get(b.dataset.path),$;GT(S)?$=`${S.embed_link}

${await S.read()}`:$=HT(await S.read());let j;d?j=await this.render_markdown($,S):j=this.create_doc_fragment($),e.querySelector("li").appendChild(j)}},"render_result");e.querySelector(".header .svg-icon.right-triangle").addEventListener("click",JT);let g=t.event_key_domain||"connections",k=`${g}:drag_result`;return jw(e,n,{drag_event_key:k}),Fc(e,n,{event_key_domain:g}),e.addEventListener("click",b=>{el(n,b),n.emit_event(`${g}:open_result`,{event_source:"connections-list-item-v3"})}),new MutationObserver(b=>{b.some(S=>{let $=S.target;return S.attributeName==="class"&&S.oldValue?.includes("sc-collapsed")!==$.classList.contains("sc-collapsed")})&&!b[0].target.classList.contains("sc-collapsed")&&f(b[0].target)}).observe(e,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),r.registerDomEvent(e,"contextmenu",b=>{if(b.preventDefault(),b.stopPropagation(),!_)return;_.data.connections||={};let A=Wt(n.collection_key,n.key),S=Ho(_.data.connections,A),$=Aw(_.data.connections),j=Sw(_.data.connections),C=s.connections_list?.results||[],x=Vo(n,l)||n.key;console.log({target_name:x,item:n});let m=new Gt.Menu(a);m.addItem(w=>{w.setTitle(`Hide ${x}`).setIcon("eye-off").onClick(()=>{try{vw(_.data.connections,A,Date.now()),_.data.hidden_connections&&(delete _.data.hidden_connections[n.key],Object.keys(_.data.hidden_connections).length||delete _.data.hidden_connections),_.queue_save(),e.style.display="none",e.dataset.hidden="true",_.collection.save(),_.emit_event("connections:hidden_item")}catch(O){new Gt.Notice("Hide failed \u2013 check console"),console.error(O)}})}),m.addItem(w=>{let O=S?"Unpin":"Pin";w.setTitle(`${O} ${x}`).setIcon(S?"pin-off":"pin").onClick(()=>{try{S?(ww(_.data.connections,A),e.classList.remove("sc-result-pinned"),e.removeAttribute("data-pinned")):(kw(_.data.connections,A,Date.now()),e.classList.add("sc-result-pinned"),e.dataset.pinned="true",_.emit_event("connections:pinned_item")),_.queue_save(),_.collection.save()}catch(E){new Gt.Notice(`${O} failed \u2013 check console`),console.error(E)}})}),m.addSeparator();let h=zn(C);h&&m.addItem(w=>{w.setTitle("Copy as list of links").setIcon("copy").onClick(async()=>{await at(h),new Gt.Notice("Connections links copied to clipboard"),s.connections_list.emit_event("connections:copied_list")})}),m.addSeparator(),m.addItem(w=>{w.setTitle(`Unhide All (${$})`).setIcon("eye").setDisabled(!$).onClick(()=>{try{if(!_.data.connections||!xw(_.data.connections))return;_.data.hidden_connections&&delete _.data.hidden_connections,_.queue_save(),e.closest(".sc-connections-view")?.querySelector('[title="Refresh"]')?.click(),_.collection.save()}catch(O){new Gt.Notice("Unhide failed \u2013 check console"),console.error(O)}})}),m.addItem(w=>{w.setTitle(`Unpin All (${j})`).setIcon("pin-off").setDisabled(!j).onClick(()=>{try{if(!_.data.connections||!Ew(_.data.connections))return;e.closest(".connections-list")?.querySelectorAll(".sc-result[data-pinned]").forEach(q=>{q.classList.remove("sc-result-pinned"),q.removeAttribute("data-pinned")}),_.queue_save(),_.collection.save()}catch(O){new Gt.Notice("Unpin failed \u2013 check console"),console.error(O)}})}),m.showAtMouseEvent(b)}),e.classList.contains("sc-collapsed")||f(e),e}o(BT,"post_process");function UT(s,e,t={}){let n=Vo(e,t).split(" \u203A ").filter(Boolean),i=WT(n,e?.lines),r=i.pop(),a=typeof s=="number"?s.toFixed(2):s,c='<small class="sc-breadcrumb-separator"> &gt; </small>',l=i.map(d=>`<small class="sc-breadcrumb">${d}</small>`).join(c);return[`<small class="sc-breadcrumb sc-score">${a}</small>`,`${l}${c}`,`<small class="sc-breadcrumb sc-title">${r}</small>`].join("")}o(UT,"get_result_header_html");function WT(s,e=[]){if(!Array.isArray(s)||!s.length)return[];let t=Array.isArray(e)&&e.length;return s.map(n=>t&&n.startsWith("{")?`Lines: ${e.join("-")}`:n)}o(WT,"format_item_parts");function GT(s){return s?!!s.is_media:!1}o(GT,"should_render_embed");function HT(s){return s.includes("```dataview")&&(s=s.replace(/```dataview/g,"```\\dataview")),s.includes("```smart-context")&&(s=s.replace(/```smart-context/g,"```\\smart-context")),s.includes("```smart-chatgpt")&&(s=s.replace(/```smart-chatgpt/g,"```\\smart-chatgpt")),s.includes("![[")&&(s=s.replace(/\!\[\[/g,"! [[")),s}o(HT,"process_for_rendering");function JT(s){s.preventDefault(),s.stopPropagation(),s.target.closest(".sc-result").classList.toggle("sc-collapsed")}o(JT,"toggle_result");var Nw={show_full_path:{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results.",default:!0},render_markdown:{name:"Render markdown",type:"toggle",description:"Turn off to prevent rendering markdown and display connection results as plain text.",default:!0}};async function VT(s,e={}){return`<div><div class="connections-list sc-list" data-key="${s.item.key}"></div></div>`}o(VT,"build_html");async function Pw(s,e={}){let t=await VT.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".connections-list");return KT.call(this,s,i,e),i}o(Pw,"render");async function KT(s,e,t={}){e.dataset.key=s.item.key;let n=await s.get_results(t);if(!n||!Array.isArray(n)||n.length===0){let a=this.create_doc_fragment(`<p class="sc-no-results">No results found.<br><em>Try using the refresh button. If that doesn't work, try running "Clear sources data" and then "Reload sources" in the Smart Environment settings.</em></p>`);return e.appendChild(a),e}let i=s.env.smart_components;return(await Promise.all(n.map(a=>i.render_component("connections_list_item_v3",a,{...t})))).forEach(a=>e.appendChild(a)),e}o(KT,"post_process");var Iw="List only";var Mw=require("obsidian");async function YT(s){return`
<div>
<div data-user-agreement></div>
<div class="actions-container">
<button class="sc-getting-started-button">Getting started guide</button>
<button class="sc-report-bug-button">Report a bug</button>
<button class="sc-request-feature-button">Request a feature</button>
<button class="sc-share-workflow-button">Share workflow \u2B50</button>
</div>
</div>
`}o(YT,"build_html");async function Lw(s){let e=await YT.call(this,s),n=this.create_doc_fragment(e).firstElementChild;return XT.call(this,s,n),n}o(Lw,"render");async function XT(s,e){let t=e.querySelector("[data-user-agreement]");if(t){let i=await s.env.render_component("user_agreement_callout",s);t.appendChild(i)}let n=e.querySelector("#header-callout a");return n&&n.addEventListener("click",i=>{i.preventDefault(),window.open(n.href,"_external")}),e.querySelector(".sc-getting-started-button")?.addEventListener("click",()=>{We.open(s,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-settings"})}),e.querySelector(".sc-report-bug-button")?.addEventListener("click",()=>{if(s.env?.is_pro){new Cp(s.app).open();return}window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=bug_report.yml","_external")}),e.querySelector(".sc-request-feature-button")?.addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=feature_request.yml","_external")}),e.querySelector(".sc-share-workflow-button")?.addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/discussions/new?category=showcase","_external")}),e}o(XT,"post_process");var Cp=class extends Mw.Modal{static{o(this,"ScProSupportModal")}open(){super.open(),this.titleEl.setText("Need help and support?");let e=this.contentEl.createDiv({cls:"sc-pro-support-modal"});e.createEl("p",{text:"Reply to your Smart Environment Pro welcome email for priority support."}),e.createEl("button",{text:"Report a bug",cls:"mod-warning"}).addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=bug_report.yml","_external")}),e.createEl("button",{text:"Close"}).addEventListener("click",()=>{this.close()})}};var ml=`.connections-view-early {
.connections-top-bar {
display: flex;
gap: 0.5rem 1rem;

.connections-actions {
display: flex;
flex-direction: row;
flex-wrap: wrap;
flex: 0 0 auto;
}

.sc-context {
display: flex;
flex-direction: column;
margin: 0;
gap: 0.1rem;
width: auto;
flex: 1 1 auto;

.sc-context-line {
line-height: 1.1;
}

.sc-context-line--parent {
color: var(--text-muted);
font-size: 0.85em;
}

.sc-context-line--focus {
color: var(--text-normal);
font-size: 1.05em;
font-weight: 600;
}
}
}
.connections-list {
padding-top: 0.85rem;

> .sc-collapsed ul {
display: none;
}
> .sc-collapsed span svg {
transform: rotate(-90deg);
}
> .sc-result-pinned {
box-shadow: 0 0 0 1px var(--interactive-accent);
border-radius: var(--radius-s);
background-color: var(--background-modifier-hover);
}
}
}`;var Rn=require("obsidian");function zw(s){let e=s.key,t="",n="",i=[];if(e.includes("#")){if(i=e.split("#"),n=i.pop().trim(),n[0]==="{"){let r=s.lines.join("-");n=i.pop().trim()+` Lines: ${r}`}t=i.filter(Boolean).join("#")}else e.includes("/")&&(i=e.split("/"),n=i.pop().trim());return t=i.filter(Boolean).join(" \u203A "),[t,n]}o(zw,"get_context_lines");async function Dw(s){let n=s.target.closest(".connections-view")?.querySelector(".connections-list")?.dataset?.key;console.log(`Refreshing smart connections view entity ${n}`);let i=this.env.smart_sources.get(n);i?(await i.read(),i.queue_import(),await i.collection.process_source_import_queue?.(),this.render_view(i)):console.warn("No entity found for refresh")}o(Dw,"connections_view_refresh_handler");async function QT(s,e={}){let t=!!s.paused;return`<div><div class="connections-view connections-item-view sc-connections-view connections-view-early">
<div class="sc-top-bar connections-top-bar">
<div class="connections-actions">
${[{title:t?"Resume auto-refresh":"Pause auto-refresh",icon:t?"play-circle":"pause-circle",attrs:`data-action="toggle-pause" aria-pressed="${t}"`},{title:"More actions",icon:"menu",attrs:'data-action="open-menu"'}].map(a=>`
<button
aria-label="${a.title}"
${a.attrs??""}
>
${this.get_icon_html(a.icon)}
</button>
`).join("")}
</div>
<p class="sc-context" data-key="">
Loading...
</p>
</div>
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div></div>`}o(QT,"build_html");async function Rw(s,e={}){let t=await QT.call(this,s,e),n=this.create_doc_fragment(t);this.apply_style_sheet(ml);let i=n.querySelector(".sc-connections-view");return eN.call(this,s,i,e),n}o(Rw,"render");async function eN(s,e,t={}){let n=e.querySelector(".connections-list-container"),i=e.querySelector(".sc-top-bar .sc-context"),r=s.env,a=t.connections_item;if(!a)return n.textContent="No source item detected for current active view.",e;let c=a.connections||r.connections_lists.new_item(a);if(!e._has_listeners){e._has_listeners=!0,e.querySelector('[data-action="toggle-pause"]')?.addEventListener("click",()=>{s.toggle_connections_paused()});let v=o(()=>{We.open(s.plugin,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=connections-view-help#page=understanding-connections-1"})},"open_help");e.querySelector('[data-action="open-menu"]')?.addEventListener("click",A=>{let S=new Rn.Menu(s.plugin.app),$=Array.isArray(c?.results)?c.results:[],j=c?.item?.data?.connections||{},C=Jo($,j);S.addItem(x=>{x.setTitle("Refresh connections").setIcon("refresh-cw").onClick(()=>{Dw.call(s,{target:e})})}),S.addItem(x=>{let m=_l({source_item:a,results:C});x.setTitle("Send results to Smart Context").setIcon("briefcase").setDisabled(!m.length).onClick(async()=>{if(!m.length)return new Rn.Notice("No connection results to send to Smart Context");let h=r.smart_contexts.new_context();h.add_items(m),h.emit_event("context_selector:open"),c.emit_event("connections:sent_to_context")})}),S.addItem(x=>{let m=zn(C);x.setTitle("Copy as list of links").setIcon("copy").setDisabled(!m).onClick(async()=>{if(!m)return new Rn.Notice("No connection results to copy");await at(m),new Rn.Notice("Connections links copied to clipboard"),c.emit_event("connections:copied_list")})}),S.addItem(x=>{let h=(t.connections_settings??c?.settings)?.expanded_view,w=h?"Collapse all results":"Expand all results",O=h?"fold-vertical":"unfold-vertical";x.setTitle(w).setIcon(O).onClick(()=>{let E=t.connections_settings??c?.settings,q=E?.expanded_view;E&&(E.expanded_view=!q),e.querySelectorAll(".sc-result").forEach(N=>{q?N.classList.add("sc-collapsed"):N.classList.remove("sc-collapsed")})})}),S.addSeparator(),S.addItem(x=>{x.setTitle("Connections settings").setIcon("settings").onClick(()=>{s.open_settings()})}),S.addItem(x=>{x.setTitle("Help & getting started").setIcon("help-circle").onClick(v)}),S.showAtMouseEvent(A)})}let l=t.connections_list_component_key||c.connections_list_component_key||"connections_list_v3",d=await r.smart_components.render_component(l,c,t);this.empty(n),n.appendChild(d);let _=c?.item||a,[u,p]=zw(_);this.empty(i);let f=i.ownerDocument;[{text:u,class_name:"sc-context-line sc-context-line--parent"},{text:p,class_name:"sc-context-line sc-context-line--focus"}].forEach(k=>{let v=f.createElement("span");v.className=k.class_name,v.textContent=k.text||"\xA0",i.appendChild(v)}),i.dataset.key=a.key;let g=e.querySelector('[data-action="toggle-pause"]');if(g){let k=o(v=>{let b=v?"Resume auto-refresh":"Pause auto-refresh";g.title=b,g.setAttribute("aria-label",`${b}`),g.setAttribute("aria-pressed",String(v)),this.safe_inner_html(g,this.get_icon_html(v?"play-circle":"pause-circle"))},"update_pause_button");k(!!s.paused),s.register_pause_controls({update:k})}return e}o(eN,"post_process");var Fw=`.lookup-item-view {
display: flex;
flex-direction: column;
gap: 1rem;
}

.lookup-item-view .lookup-query-form {
display: flex;
flex-direction: column;
gap: 0.5rem;
}

.lookup-item-view .lookup-query-label {
font-size: 0.75rem;
font-weight: 600;
letter-spacing: 0.03em;
text-transform: uppercase;
color: var(--text-muted);
}

.lookup-item-view .lookup-query-input {
resize: vertical;
min-height: 5rem;
padding: 0.75rem;
border-radius: var(--radius-m);
border: 1px solid var(--background-modifier-border);
background-color: var(--background-secondary);
color: var(--text-normal);
font-size: 0.95rem;
line-height: 1.5;
}

.lookup-item-view .lookup-query-input:focus {
outline: none;
border-color: var(--interactive-accent);
box-shadow: 0 0 0 2px color-mix(in srgb, var(--interactive-accent) 30%, transparent);
}

.lookup-item-view .lookup-list-container {
display: flex;
flex-direction: column;
gap: 0.5rem;
}
`;var sN=300,nN="Enter a lookup query to continue.",iN="Describe the idea, topic, or question you want to explore\u2026",Op="Use semantic (embeddings) search to surface relevant notes. Results are sorted by similarity to your query. Note: returns different results than lexical (keyword) search.";async function oN(s,e={}){return`<div><div class="lookup-item-view sc-connections-view connections-view-early">
<form class="lookup-query-form" novalidate>
<label class="lookup-query-label" for="lookup-query-input" title="${Op}">Smart Lookup</label>
<textarea
class="lookup-query-input"
id="lookup-query-input"
name="lookup-query"
rows="4"
placeholder="${iN}"
required
></textarea>
</form>
<div class="lookup-list-container">
<p>${Op}</p>
</div>
</div></div>`}o(oN,"build_html");async function Bw(s,e={}){this.apply_style_sheet(Fw);let t=await oN.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".lookup-item-view");return rN.call(this,s,i,e),i}o(Bw,"render");async function rN(s,e,t={}){let n=e.querySelector(".lookup-query-input"),i=e.querySelector(".lookup-query-form"),r=e.querySelector(".lookup-list-container"),a={last_query:null},c=o(async d=>{let _=cN(d);if(lN({input_el:n,query:_}),!_){this.empty(r),r.innerHTML=`<p>${Op}</p>`;return}if(_===a.last_query)return;a.last_query=_;let u={...t,query:_},p=s.env.lookup_lists.new_item(u),f=await s.env.render_component("lookup_list",p,u);this.empty(r),r.appendChild(f)},"submit_query"),l=aN(c);return n.addEventListener("input",()=>{l(n.value)}),i.addEventListener("submit",d=>{d.preventDefault(),l.cancel?.(),c(n.value)}),e}o(rN,"post_process");function aN(s,e=sN){let t,n=o(i=>{t&&clearTimeout(t),t=setTimeout(()=>{t=void 0,s(i)},e)},"schedule");return n.cancel=()=>{t&&(clearTimeout(t),t=void 0)},n}o(aN,"create_debounced_submit");function cN(s){return typeof s!="string"?"":s.trim()}o(cN,"sanitize_query");function lN({input_el:s,query:e}){s?.setCustomValidity&&(e?s.setCustomValidity(""):s.setCustomValidity(nN))}o(lN,"update_query_validity");async function dN(s,e={}){return`<div><div class="lookup-list connections-list sc-list" data-key="${s.item.key}"></div></div>`}o(dN,"build_html");async function Uw(s,e={}){let t=await dN.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".lookup-list");return _N.call(this,s,i,e),i}o(Uw,"render");async function _N(s,e,t={}){e.dataset.key=s.key;let n=await s.get_results(t);if(!n||!Array.isArray(n)||n.length===0){let a=this.create_doc_fragment('<p class="sc-no-results">No results found</p>');return e.appendChild(a),e}let i=s.env.smart_components;return(await Promise.all(n.map(a=>i.render_component("connections_list_item_v3",a,{event_key_domain:"lookup",...t})))).forEach(a=>e.appendChild(a)),e}o(_N,"post_process");function pl(s){s.limit||(s.limit=this.settings?.results_limit??20),s.results_collection_key||(s.results_collection_key=this.collection.results_collection_key),s.filter||(s.filter={}),s.score_algo_key||(s.score_algo_key=this.collection.score_algo_key),s.to_item=this.item,s.filter.exclude_keys||(s.filter.exclude_keys=[]),s.filter.exclude_key_starts_with_any||(s.filter.exclude_key_starts_with_any=[]),uN(this,s);let e=new Set(s.filter.exclude_keys);if(e.add(this.item.key),s.hidden_keys.forEach(t=>e.add(t)),s.pinned_keys.forEach(t=>e.add(t)),s.filter.exclude_keys=Array.from(e),s.results_collection_key==="smart_blocks"){let t=new Set(s.filter.exclude_key_starts_with_any);t.add(this.item.key),s.hidden_keys.forEach(n=>t.add(n)),s.pinned_keys.forEach(n=>t.add(n)),s.filter.exclude_key_starts_with_any=Array.from(t),this.collection.settings.exclude_frontmatter_blocks&&((!s.filter.exclude_key_ends_with_any||!Array.isArray(s.filter.exclude_key_ends_with_any))&&(s.filter.exclude_key_ends_with_any=[]),s.filter.exclude_key_ends_with_any.push("---frontmatter---"))}}o(pl,"pre_process");function uN(s,e){e.hidden=[],e.hidden_keys=[],e.pinned=[],e.pinned_keys=[];let t=s.item.data?.connections||{};Object.entries(t).forEach(([n,i])=>{if(!i||i.hidden==null&&i.pinned==null)return;let[r,...a]=n.split(":");if(!r||!a.length)return;let c=a.join(":"),l=s.env[r];if(!l)return;let d=l.get(c);d&&(i.hidden&&!i.pinned&&(e.hidden.push(d),e.hidden_keys.push(c)),i.pinned&&(e.pinned.push(d),e.pinned_keys.push(c)))})}o(uN,"get_connections_feedback_items");var Ww={collections:{connections_lists:yw},item_types:{ConnectionsList:qe},items:{connections_list:{class:qe}},modules:{},components:{connections_codeblock:{render:Ow},connections_list_item_v3:{render:Tw,settings_config:Nw},connections_list_v3:{render:Pw,display_name:Iw},connections_settings_header:{render:Lw},connections_view_v3:{render:Rw},lookup_item_view:{render:Bw},lookup_list:{render:Uw}},actions:{connections_list_pre_process:{action:pl,pre_process:pl}}};var qp=require("obsidian");async function Gw(s,e,t=null,n={}){let{new_tab:i=!1}=n,r=s.env;e.endsWith("#")&&(e=e.slice(0,-1));let a,c=null;if(e.includes("#")){let[d]=e.split("#");a=s.app.metadataCache.getFirstLinkpathDest(d,""),c=r.smart_blocks.get(e)}else a=s.app.metadataCache.getFirstLinkpathDest(e,"");if(!a){console.warn(`[open_note] Unable to resolve file for ${e}`);return}let l;if(t){let d=qp.Keymap.isModEvent(t),_=qp.Keymap.isModifier(t,"Alt");d&&_?l=s.app.workspace.splitActiveLeaf("vertical"):d||i?l=s.app.workspace.getLeaf(!0):l=s.app.workspace.getMostRecentLeaf()}else l=s.app.workspace.getMostRecentLeaf();if(await l.openFile(a),typeof c?.line_start=="number"){let{editor:d}=l.view,_={line:c.line_start,ch:0};d.setCursor(_),d.scrollIntoView({to:_,from:_},!0)}}o(Gw,"open_note");var hl=class extends Fo{static{o(this,"ScEarlySettingsTab")}constructor(e,t){super(e,t),this.plugin=t}hide(){super.hide?.(),this.plugin_container?.empty?.(),this.turn_off_listener?.()}async render_header(e){let t=await this.env.smart_components.render_component("connections_settings_header",this.plugin);e.appendChild(t)}async render_plugin_settings(e){if(!e)return;e.empty?.(),e.innerHTML='<div class="sc-loading">Loading main settings...</div>',e.empty?.();let t=e.createDiv({cls:"sc-settings-tab__section",attr:{"data-section-key":"connections_lists"}});t.createEl("h1",{text:"Connections"});let n=this.env.config.collections.connections_lists.settings_config;qs(n,this.env.connections_lists,t,{default_group_name:"Connections lists",group_params:{"Connections lists":{heading_btn:[{label:"Learn about Connections Lists",btn_text:"Learn more",callback:o(()=>window.open("https://smartconnections.app/smart-connections/list-feature/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for Connections Lists",btn_icon:"help-circle",callback:o(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#connections-lists","_external"),"callback")}]},Display:{heading_btn:{label:"Settings documentation for Display",btn_icon:"help-circle",callback:o(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#display","_external"),"callback")}},"Score algorithm":{heading_btn:{label:"Settings documentation for Score Algorithms",btn_icon:"help-circle",callback:o(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#score-algorithm","_external"),"callback")}},"Ranking algorithm":{heading_btn:{label:"Settings documentation for Ranking Algorithms",btn_icon:"help-circle",callback:o(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#ranking-algorithm","_external"),"callback")}},Filters:{heading_btn:{label:"Settings documentation for Filters",btn_icon:"help-circle",callback:o(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#filters","_external"),"callback")}},"Inline connections":{heading_btn:[{label:"Learn about the inline connections feature",btn_text:"Learn more",callback:o(()=>window.open("https://smartconnections.app/smart-connections/inline/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for inline connections",btn_icon:"help-circle",callback:o(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#inline-connections","_external"),"callback")}]},"Footer connections":{heading_btn:{label:"Settings documentation for Footer Connections",btn_icon:"help-circle",callback:o(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#footer-connections","_external"),"callback")}}}});let i=e.createDiv({cls:"sc-settings-tab__section",attr:{"data-section-key":"lookup_lists"}}),r=this.env.config.collections.lookup_lists.settings_config;qs(r,this.env.lookup_lists,i,{default_group_name:"Lookup lists",group_params:{"Lookup lists":{heading_btn:[{label:"Learn about Lookup Lists",btn_text:"Learn more",callback:o(()=>window.open("https://smartconnections.app/smart-connections/lookup/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for Lookup Lists",btn_icon:"help-circle",callback:o(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#lookup-lists","_external"),"callback")}]}}}),this.register_env_events()}register_env_events(){this.turn_off_listener||!this.env?.events||(this.turn_off_listener=this.env.events.on("settings:changed",e=>{(e.path?.includes("connections_post_process")||e.path?.includes("score_algo_key")||e.path?.includes("connections_list_item"))&&this.render_plugin_settings(this.plugin_container)}))}};var Jw=require("obsidian");var fl=require("obsidian");var Ht=class extends fl.ItemView{static{o(this,"SmartItemView")}constructor(e,t){super(e),this.app=t.app,this.plugin=t}static get view_type(){throw new Error("view_type must be implemented in subclass")}static get display_text(){throw new Error("display_text must be implemented in subclass")}static get icon_name(){return"smart-connections"}static register_item_view(e){let t=this;e.registerView(t.view_type,l=>new t(l,e)),e.addCommand({id:t.view_type,name:"Open: "+t.display_text+" view",callback:o(()=>{t.open(e.app.workspace)},"callback")});let n=t.view_type.replace(/^smart-/,"").replace(/-/g,"_"),i="open_"+n;Object.getOwnPropertyDescriptor(e,n)||Object.defineProperty(e,n,{configurable:!0,enumerable:!1,get:o(()=>t.get_view(e.app.workspace),"get")}),e[i]=()=>t.open(e.app.workspace);let r=`${n}:open`,a=o(l=>{let d=typeof l?.active=="boolean"?l.active:!0;t.open(e.app.workspace,d)},"handler"),c=e?.env?.events.on(r,a);return typeof e.register=="function"&&typeof c=="function"&&e.register(()=>c()),{method_name:n,open_method_name:i,event_name:r}}static get_leaf(e){return e.getLeavesOfType(this.view_type)[0]}static get_view(e){let t=this.get_leaf(e);return t?t.view:void 0}static open(e,t={}){let{active:n=!0}=t,i=this.get_leaf(e);this.default_open_location==="root"?i?i.setViewState({type:this.view_type,active:n}):e.getLeaf(!1).setViewState({type:this.view_type,active:n}):(i?i.setViewState({type:this.view_type,active:n}):e.getRightLeaf(!1).setViewState({type:this.view_type,active:n}),e.rightSplit?.collapsed&&e.rightSplit.toggle()),setTimeout(()=>{this.get_view(e)?.render_view(t)},100)}static is_open(e){return this.get_leaf(e)?.view instanceof this}getViewType(){return this.constructor.view_type}getDisplayText(){return this.constructor.display_text}getIcon(){return this.constructor.icon_name}async onOpen(){this.app.workspace.onLayoutReady(this.initialize.bind(this))}async initialize(){if(await ow(this),this.container.empty(),this.register_plugin_events(),this.app.workspace.registerHoverLinkSource(this.constructor.view_type,{display:this.getDisplayText(),defaultMod:!0}),this.render_view(),fl.Platform.isMobile){let e=this.containerEl.querySelector(".status-bar-mobile")??this.containerEl.createDiv({cls:"status-bar-mobile"});e.empty();let t=e.createDiv({cls:"status-bar-item"});this.env.smart_components.render_component("status_bar",this.env).then(n=>t.appendChild(n))}}register_plugin_events(){}render_view(e={}){throw new Error("render_view must be implemented in subclass")}get container(){return this.containerEl.children[1]}get env(){return this.plugin.env}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}};var Hw=`> [!NOTE] Patch v4.1.8
> - Added: "Pin" and "Hide" events/milestones
>
> All Smart Plugins:
> - Fixed: verified Pro plugins login should work on mobile
> - Fixed: settings groups now re-render when a dropdown changes (prevents stale dependent settings)
> - Improved: notifications modal includes a "Load more" button (beyond the default 100)

> [!NOTE]- Previous patches
> > [!NOTE]- v4.1.7
> > - Added: Links to docs from [milestones](https://smartconnections.app/smart-environment/milestones/?utm_source=release-notes)
> > - Added: Include active source item in context created from the connections view
> > - Fixed: replaced model source for multilingual E5 Small embedding model to ensure quantized variations available
>
> > [!NOTE]- v4.1.6
> > - Added: milestones feature with modal and checklist components
> > - Added: connections view menu option to copy results as links
> > - Added: multilingual-e5-small embedding model support
> > - Improved: settings tab with added "learn more" and "help" buttons to settings groups
> > - Fixed: markdown parser should handle frontmatter correctly (prevent false-positive frontmatter detection)
>
> > [!NOTE]- v4.1.4
> > - Added fallback for opening Pro login in case the button doesn't automatically open the browser as expected
>
> > [!NOTE]- v4.1.3
> > - Added link to documentation in settings for easier access
> > - Fixed highlight "Reset data" after embedding model change
>
> > [!NOTE]- v4.1.2
> > - Improved model configuration UX
> >   - Added "Delete" functionality to better manage models
> > - Enhanced UI for settings and improved styling
> > - Pro: Updated score algorithm settings to clarify descriptions
>
> > [!NOTE]- v4.1.1
> > - Connections codeblock view should render as expected without errors
>
>
# Smart Connections \`v4\`\r
\r
## What's new in v4\r
\r
Smart Connections v4 focuses the core plugin on a simple promise: install, enable, and AI-powered connections just work. Advanced configuration and power-user workflows now live in Pro plugins. Read [Introducing Pro Plugins](https://smartconnections.app/introducing-pro-plugins/?utm_source=connections-release-notes) to learn more.\r
\r
### Pause connections\r
\r
Use the new Connections "pause" button to freeze the connections results. This allows you to move through your vault while keeping the connections to a specific note visible while you work.\r
\r
### Copy connections as list of links\r
\r
Right-click the connections results to *copy all links* to clipboard.\r
\r
### Copy all connections content (Context Engineering)\r
\r
Click the connections view menu button and "Send to Smart Context" (briefcase icon) option. This allows you to quickly copy *all content from the connections* to clipboard for use as context with any AI chat! The Smart Context view also lets you add or remove items before copying all to the clipboard in one-click!\r
\r
### Pinned connections\r
\r
In addition to "hiding" connections, you can now "Pin" connections. This ensures the pinned connections are always visible in the connections view. **Connections Pro:** *Hidden and pinned connections are used by new connections algorithms (available in Pro) to improve results!*\r
\r
### Events and notifications\r
\r
Important events are now surfaced in a dedicated notifications modal:\r
\r
- On desktop, click the Smart Env item in the status bar to open the notifications modal.  \r
- On mobile, a Smart Environment notice appears at the bottom of the Connections view; tap it to review events.\r
\r
Examples of events you might see:\r
\r
- Initial indexing complete for your vault  \r
- Sources reimported after model changes  \r
- Warnings when exclusions block indexing on specific folders or files  \r
\r
Objectives of the new Events system:\r
\r
- make the environment inspectable and understandable\r
- reduce the number of Obsidian native notifications\r
\r
### Connections Pro\r
\r
Connections Pro builds on the core plugin and Smart Environment to give power users more control.\r
\r
![](https://smartconnections.app/assets/connections-view-pro-notes.gif)\r
\r
Examples of Pro features:\r
\r
- **Inline connections**  \r
Small badges in the editor that show how many strong matches a block has, with a pop-over of related blocks and notes.  \r
- **Footer connections**  \r
A persistent panel that updates as you type so high value connections stay visible while you write.  \r
- **Configurable scoring and ranking**  \r
Choose different algorithms for how results are scored and optionally add a rerank stage.  \r
- **Connections in Bases**  \r
Use \`score_connection\` and \`list_connections\` in Obsidian Bases to show similarity columns and related note lists in tables.  \r
- **Advanced filters and models**  \r
Extra Smart Environment controls for embeddings, collections, and include or exclude rules.  \r
- **Early release experiments**  \r
New ideas launch in Early channels first so supporters can shape how they evolve.\r
\r
Connections Pro is part of the [Pro plugins](https://smartconnections.app/pro-plugins/?utm_source=connections-release-notes) family and is available to active project supporters. It is still built on the same open Smart Environment. Supporting Pro helps fund development of all Smart Plugins and the free core.
`;var Fn=class s extends Ht{static{o(this,"ReleaseNotesView")}static get view_type(){return"smart-release-notes-view"}static get display_text(){return"Release Notes"}static get icon_name(){return"file-text"}static open(e,t,n=!0){e.getLeaf("tab").setViewState({type:this.view_type,active:n,state:{version:t}})}getViewType(){return s.view_type}getDisplayText(){return s.display_text}getIcon(){return s.icon_name}onOpen(){this.titleEl.setText(`What\u2019s new in v${this.version}`),this.render()}get container(){let e=this.containerEl?.querySelector(".view-content"),t=e?.querySelector(".markdown-preview-view");return t||(t=e?.createDiv("cm-scroller is-readable-line-width")?.createDiv("markdown-preview-view markdown-rendered")),t}async render(){for(;!this.container;)await new Promise(e=>setTimeout(e,100)),console.warn("Waiting for containerEl to be ready...",this.container);await Jw.MarkdownRenderer.render(this.app,Hw,this.container,"",this),this.container.querySelectorAll("a").forEach(e=>{e.setAttribute("target","_external")}),requestAnimationFrame(()=>this.#t(this.container,this.version))}get version(){return this.leaf.viewState?.state?.version??this.app.plugins.getPlugin("smart-connections")?.manifest.version??""}#t(e,t){if(!t)return;let n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`\\bv?${n}\\b`,"i");e.querySelectorAll("h1,h2,h3,h4,h5,h6").forEach(r=>{i.test(r.textContent??"")&&r.scrollIntoView({behavior:"smooth",block:"start"})})}};async function Vw(s,e,{rng:t=Math.random}={}){if(!s?.smart_sources||!e)return null;let n=s.smart_sources.get(e);if(!n?.should_embed)return null;let i=await n.connections.get_results({limit:20});return!Array.isArray(i)||i.length===0?null:mN(i,{rng:t})}o(Vw,"get_random_connection");function mN(s,{rng:e}){let t=s.map(a=>({connection:a,score:Math.max(0,typeof a?.score=="number"?a.score:0)})),n=t.reduce((a,{score:c})=>a+c,0);if(n===0)return s[0];let i=e()*n,r=0;for(let{connection:a,score:c}of t)if(r+=c,i<r)return a;return s.at(-1)}o(mN,"pick_weighted_connection");var Kw=require("obsidian");function Yw(){(0,Kw.addIcon)("smart-dice",`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
<rect x="1" y="1" width="22" height="22" rx="2" fill="none"/>

<g transform="translate(12 10) scale(0.18) translate(-50 -50)">
<path d="M50 20 L80 40 L80 60 L50 100" fill="none" stroke="currentColor" stroke-width="4"/>
<path d="M30 50 L55 70" fill="none" stroke="currentColor" stroke-width="5"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="75" cy="40" r="9" fill="currentColor"/>
<circle cx="75" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="25" cy="50" r="9" fill="currentColor"/>
</g>
</svg>
`)}o(Yw,"add_smart_dice_icon");function Xw(s,e){let t=!!e;return s.paused=t,s.pause_controls?.update?.(t),t}o(Xw,"apply_pause_state");function Zw(s){let e=!s.paused;return s.paused=e,s.pause_controls?.update?.(e),e}o(Zw,"toggle_pause_state");var yl=class extends Ht{static{o(this,"ConnectionsItemView")}static get view_type(){return"smart-connections-view"}static get display_text(){return"Connections"}static get icon_name(){return"smart-connections"}constructor(e,t){super(e,t),this.paused=!1,this.pause_controls=null,this.current=null}async render_view(e={},t=this.container){if(!e.connections_item){let i=this.plugin.app.workspace.getActiveFile()?.path;e.connections_item=this.env.smart_sources.get(i)}this.current=e.connections_item,this.pause_controls=null;let n=await this.env.smart_components.render_component("connections_view_v3",this,{connections_item:e.connections_item});t.empty(),t.appendChild(n),this.register_env_listeners(),this.env.events.emit("connections:opened")}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}register_env_listeners(){let e;gl(this,"sources:opened",(t={})=>{if(this.paused||!$p(this.container))return;let n=this.env[t.collection_key||"smart_sources"]?.get(t.item_key||t.key);n.key!==this.current?.key&&(e&&clearTimeout(e),e=setTimeout(()=>{this.render_view({connections_item:n})},250))}),gl(this,"settings:changed",t=>{t.path?.includes("expanded_view")||t.path?.includes("connections_lists")&&$p(this.container)&&this.render_view({connections_item:this.current})}),gl(this,"connections:show",t=>{if(console.log("connections:show event received",{event:t}),t.collection_key&&t.item_key){let n=this.env[t.collection_key],i=n.get(t.item_key);console.log({collection:n,item:i}),i&&(this.set_connections_paused(!0),this.render_view({connections_item:i}))}}),gl(this,"item:embedded",t=>{t.item_key===this.current?.key&&$p(this.container)&&this.render_view({connections_item:this.current})})}register_pause_controls(e){this.pause_controls=e,this.pause_controls?.update(this.paused)}set_connections_paused(e){return Xw(this,e)}toggle_connections_paused(){return Zw(this)}};function $p(s){return s?s.isConnected?typeof s.checkVisibility=="function"&&s.checkVisibility()===!1?(console.log("Connections container is not visible"),!1):!0:(console.warn("Connections container is not connected to DOM"),!1):!1}o($p,"is_visible");var jp=new WeakMap,pN=o(s=>(jp.has(s)||jp.set(s,new Map),jp.get(s)),"get_registry"),gl=o((s,e,t)=>{if(!s||typeof s.env?.events?.on!="function")return console.warn("View or event system not available for registering event listener"),()=>{};let n=pN(s),i=n.get(e);typeof i=="function"&&i();let r=s.env.events.on(e,l=>{t(l)}),a=!0,c=o(()=>{a&&(a=!1,r?.(),n.get(e)===c&&n.delete(e))},"dispose");return n.set(e,c),typeof s.register=="function"&&s.register(()=>c()),c},"register_env_event_listener");var bl=class extends Ht{static{o(this,"LookupItemView")}static get view_type(){return"smart-lookup-view"}static get display_text(){return"Lookup"}static get icon_name(){return"smart-lookup"}async render_view(e,t=this.container){let n=await this.env.render_component("lookup_item_view",this,e);t.empty(),t.appendChild(n)}};async function Qw(s){s.registerMarkdownCodeBlockProcessor("smart-connections",async(e,t,n)=>{t.empty(),t.createEl("span",{text:"Loading\u2026"});let i=JSON.parse(e.trim()||"{}"),r=s.env,a=r.smart_sources.get(n.sourcePath)??r.smart_sources.init_file_path(n.sourcePath),c=r.smart_view;if(!a){t.empty(),t.createEl("p",{text:"Entity not found: "+n.sourcePath});return}let l=o(async()=>{let d=a.connections;if(!d?.env){t.empty(),t.createEl("p",{text:"Smart Environment / Connections loading\u2026"}),t.createEl("button",{text:"Retry"}).addEventListener("click",()=>{l()});return}let _=await s.env.smart_components.render_component("connections_codeblock",d,{...i});t.empty(),t.appendChild(_)},"render_codeblock");if(!t._has_listeners){t._has_listeners=!0;let d=[];d.push(r.events.on("settings:changed",_=>{console.log("connections codeblock view detected settings change",_),_.path?.includes("connections_lists")&&l()})),c.attach_disposer(t,d)}l()})}o(Qw,"register_smart_connections_codeblock");function ex(s=null){return`\`\`\`smart-connections
${s?JSON.stringify(s,null,2):""}
\`\`\`
`}o(ex,"build_connections_codeblock");var{Notice:tx,Plugin:Bse,requestUrl:hN,Platform:Use}=Tp.default,Ko=class extends Bo{static{o(this,"SmartConnectionsPlugin")}SmartEnv=$s;get smart_env_config(){return this._smart_env_config||(this._smart_env_config=Ww),this._smart_env_config}ConnectionsSettingsTab=hl;get item_views(){return{ConnectionsItemView:yl,LookupItemView:bl,ReleaseNotesView:Fn}}get obsidian(){return Tp.default}get api(){return this._api}onload(){this.app.workspace.onLayoutReady(this.initialize.bind(this)),this.SmartEnv.create(this,this.smart_env_config),this.addSettingTab(new this.ConnectionsSettingsTab(this.app,this)),Yw(),this.register_commands(),this.register_item_views(),this.register_ribbon_icons()}onunload(){console.log("Unloading Smart Connections plugin"),this.notices?.unload(),this.env?.unload_main?.(this)}async initialize(){this.smart_connections_view=null,this.is_new_user().then(async e=>{e&&(setTimeout(()=>{We.open(this,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-new-user"})},1e3),await this.SmartEnv.wait_for({loaded:!0}),setTimeout(()=>{this.open_connections_view(),this.app.workspace.rightSplit.collapsed&&this.app.workspace.rightSplit.toggle()},1e3),this.add_to_gitignore(`

# Ignore Smart Environment folder
.smart-env`))}),await this.SmartEnv.wait_for({loaded:!0}),Qw(this),await this.check_for_updates()}get ribbon_icons(){return{connections:{icon_name:"smart-connections",description:"Smart Connections: Open connections view",callback:o(()=>{this.open_connections_view()},"callback")},lookup:{icon_name:"smart-lookup",description:"Smart Lookup: Open lookup view",callback:o(()=>{this.open_lookup_view()},"callback")},random_note:{icon_name:"smart-dice",description:"Smart Connections: Open random connection",callback:o(()=>{this.open_random_connection()},"callback")}}}get settings(){return this.env?.settings||{}}async check_for_updates(){if(await this.is_new_plugin_version(this.manifest.version)){console.log("opening release notes modal");try{Fn.open(this.app.workspace,this.manifest.version)}catch(e){console.error("Failed to open ReleaseNotesView",e)}await this.set_last_known_version(this.manifest.version)}setTimeout(this.check_for_update.bind(this),3e3),setInterval(this.check_for_update.bind(this),108e5)}async check_for_update(){try{let{json:e}=await hN({url:"https://api.github.com/repos/brianpetro/obsidian-smart-connections/releases/latest",method:"GET",headers:{"Content-Type":"application/json"},contentType:"application/json"}),t=e.tag_name;t!==this.manifest.version&&(this.env?.events?.emit("plugin:new_version_available",{version:t}),this.notices?.show("new_version_available",{version:t}),this.update_available=!0)}catch(e){console.error(e)}}async restart_plugin(){this.env?.unload_main?.(this),await new Promise(e=>setTimeout(e,3e3)),window.restart_plugin=async e=>{await window.app.plugins.disablePlugin(e),await window.app.plugins.enablePlugin(e)},await window.restart_plugin(this.manifest.id)}get commands(){return{...super.commands,random_connection:{id:"smart-connections-random",name:"Open: Random note from connections",callback:o(async()=>{await this.open_random_connection()},"callback")},getting_started:{id:"smart-connections-getting-started",name:"Show: Getting started slideshow",callback:o(()=>{We.open(this,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-command"})},"callback")},insert_connections_codeblock:{id:"insert-connections-codeblock",name:"Insert: Connections codeblock",editorCallback:o(e=>{e.replaceSelection(ex())},"editorCallback")}}}show_release_notes(){return Fn.open(this.app.workspace,this.manifest.version)}async open_random_connection(){let e=this.app.workspace.getActiveFile();if(!e){new tx("No active file to find connections for");return}let t=await Vw(this.env,e.path);if(!t){new tx("Cannot open random connection for non-embedded source: "+e.path);return}this.open_note(t.item.path),this.env?.events?.emit?.("connections:open_random")}async open_note(e,t=null){await Gw(this,e,t)}async add_to_gitignore(e,t=null){if(!await this.app.vault.adapter.exists(".gitignore"))return;(await this.app.vault.adapter.read(".gitignore")).indexOf(e)<0&&(await this.app.vault.adapter.append(".gitignore",`

${t?"# "+t+`
`:""}${e}`),console.log("Added to .gitignore: "+e))}};var sx=require("@codemirror/view"),nx=require("@codemirror/state"),Ts=nx.StateEffect.define(),ix=sx.ViewPlugin.fromClass(class{constructor(s){this.view=s,this.connections_pro_frag=null,this.container_el=null,this.collapsed_notice_el=null,this.pro_header=null,this.search_result_container=null}destroy(){this.container_el?.isConnected&&this.container_el.remove()}update(s){for(let e of s.transactions)for(let t of e.effects)t.is(Ts)&&(t.value===null?this.container_el&&(this.container_el.style.display="none"):this.render_pro(t.value))}render_pro(s=null){s&&(this.container_el&&this.container_el!==s&&this.container_el.isConnected&&this.container_el.remove(),this.connections_pro_frag=s,this.container_el=s,this._listeners_bound=!1,this.#t(),this.#e()),this.container_el&&(this.container_el.style.display=this.connections_pro_frag?"block":"none")}#t(){this.search_result_container=this.container_el?.querySelector(".search-result-container"),this.pro_header=this.container_el?.querySelector(".tree-item-self"),this.collapsed_notice_el=this.container_el?.querySelector(".collapsed-notice"),this.collapse_icon_btn=this.container_el?.querySelector(".nav-action-button")}#e(){if(!this.container_el||this.container_el.isConnected)return;let s=this.view.dom.querySelector(".cm-contentContainer");s?.parentNode?.insertBefore(this.container_el,s.nextSibling)}});var vl=class{static{o(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((n,[i,r])=>{let a=(t?t+".":"")+this.process_setting_key(i);return n[a]=r,n},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var kl=class extends vl{static{o(this,"SmartRankModel")}static defaults={adapter:"cohere",model_key:"rerank-v3.5"};async rank(e,t,n={}){return await this.invoke_adapter_method("rank",e,t,n)}get default_model_key(){return"jinaai/jina-reranker-v1-tiny-en"}get settings_config(){let e={adapter:{name:"Ranking Model Platform",type:"dropdown",description:"Select a ranking model platform.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}};var Jt=class{static{o(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,n])=>({value:t,name:n.name||t})).sort((t,n)=>t.name.localeCompare(n.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Np={"[ADAPTER].model_key":{name:"Ranking Model",type:"dropdown",description:"Select a ranking model to use.",options_callback:"adapter.get_models_as_options",callback:"reload_model"}},wl=class extends Jt{static{o(this,"SmartRankAdapter")}constructor(e){super(e),this.smart_rank=e}async rank(e,t){throw new Error("rank method not implemented")}get settings_config(){return Np}};var Ge=class{static{o(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var Bn=class{static{o(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},Un=class{static{o(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var Yo=class extends Bn{static{o(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let n;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(n=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&n.status===400)throw new Error("Obsidian request failed");return new Pp(n)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(n),console.error(i),null}}},Pp=class extends Un{static{o(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Ct=class extends Bn{static{o(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...n}=e,i=await fetch(t,n);return new Ip(i)}},Ip=class extends Un{static{o(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var xl=class extends wl{static{o(this,"SmartRankModelApiAdapter")}get endpoint(){return this.model.data.endpoint||this.constructor.defaults.endpoint}get api_key(){return this.model.data.api_key}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Ge({adapter:Ct})),this._http_adapter}async load(){this.model.model_loaded=!0,this.api_key&&this.set_state("loaded")}async request(e,t=0){try{e.throw=!1,e.url=this.endpoint,console.log("API Request:",e);let n=await this.http_adapter.request(e);return console.log("API Response:",n),await this.get_resp_json(n)}catch(n){return await this.handle_request_err(n,e,t)}}async handle_request_err(e,t,n){if(e.status===429&&n<3){let i=Math.pow(n+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(r=>setTimeout(r,1e3*i)),await this.request(t,n+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.rank("test query",["Test document"]);return Array.isArray(e)&&e.length>0&&e[0].score!==null}},El=class{static{o(this,"SmartRankModelRequestAdapter")}constructor(e,t,n){this.adapter=e,this.query=t,this.documents=n}get_headers(){let e={"Content-Type":"application/json"};return this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`),e}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Al=class{static{o(this,"SmartRankModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_standard(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Wn=class extends xl{static{o(this,"SmartRankCohereAdapter")}static defaults={adapter:"cohere",description:"Cohere",default_model:"rerank-v3.5",endpoint:"https://api.cohere.ai/v2/rerank"};get req_adapter(){return Lp}get res_adapter(){return Mp}async load(){this.model.model_loaded=!0,this.set_state("loaded")}async rank(e,t){let i=new this.req_adapter(this,e,t).to_platform(),r=await this.request(i);return!r||!r.results?{message:r?.message||"Invalid response from Cohere API",resp:r}:new this.res_adapter(this,r).to_standard()}async handle_request_err(e,t,n){if(e&&e.status===429&&n<3){let i=Math.pow(n+1,2);return console.log(`Cohere API rate limit exceeded. Retrying in ${i} seconds...`),await new Promise(r=>setTimeout(r,1e3*i)),await this.request(t,n+1)}return console.error("Cohere API Error:",e),null}get settings_config(){return fN}get models(){return gN}},fN={...Np,"[ADAPTER].api_key":{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},gN={"rerank-v3.5":{id:"rerank-v3.5",description:"State-of-the-art performance in English and non-English languages. Supports documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-english-v3.0":{id:"rerank-english-v3.0",description:"English language documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-multilingual-v3.0":{id:"rerank-multilingual-v3.0",description:"Non-English documents and semi-structured data (JSON). Supports same languages as embed-multilingual-v3.0. Context length: 4096 tokens"}},Lp=class extends El{static{o(this,"SmartRankCohereRequestAdapter")}prepare_request_body(){return{query:this.query,documents:this.documents,model:this.adapter.model_key,top_n:1e3,max_tokens_per_doc:4096}}},Mp=class extends Al{static{o(this,"SmartRankCohereResponseAdapter")}parse_response(){return this.response.results?this.response.results.map(e=>({index:e.index,score:e.relevance_score})):(console.error("Invalid response format from Cohere API:",this.response),[])}};var yN={score_algo_key:{group:"Score algorithm",name:"Scoring algorithm",description:"Calculates a score by comparing each item with the current context.",type:"dropdown",options_callback:o(s=>{console.log("getting score algo options for",{scope:s,_this:void 0});let e=s.get_score_algo_key_options.call(s);return console.log("options",e),e},"options_callback"),scope_class:"pro-setting"},connections_post_process:{group:"Ranking algorithm",name:"Ranking algorithm",description:"Modifies the ranking of connection results after initial scoring. Useful for heavy-processing algorithms that should only be applied to a subset of results produced by the main scoring algorithm (ex. re-ranking models).",type:"dropdown",options_callback:o(s=>s.get_connections_post_process_options(),"options_callback"),scope_class:"pro-setting"},filters_helper:{group:"Filters",type:"html",value:['<p class="setting-item-description"><strong>Filter tips:</strong> Use comma-separated folder or file path fragments such as <code>Projects/Clients</code>. Values are trimmed automatically and compared using case-sensitive substring matches.</p>','<p class="setting-item-description"><strong>Result vs ingestion:</strong> Connections filters only hide results after Smart Environment builds its dataset. To stop notes from being indexed, adjust Smart Environment include/exclude settings in the Environment window or plugin settings.</p>','<p class="setting-item-description"><strong>Precedence:</strong> Entries in the exclude filter always win when they match, even if the same path fragment appears in the include filter.</p>'].join("")},exclude_inlinks:{group:"Filters",name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},exclude_outlinks:{group:"Filters",name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},include_filter:{group:"Filters",name:"Include filter",type:"text",description:"Comma-separated path fragments that must appear in the note path. Matches use case-sensitive substring checks; trim spaces or wrap folder names like `Daily/`. This only affects the results list; Smart Environment still embeds matching notes unless excluded there."},exclude_filter:{group:"Filters",name:"Exclude filter",type:"text",description:"Comma-separated path fragments to omit from results. Exclusions run before includes, so any matching fragment removes the note even if it also appears in `Include filter`. Use Smart Environment include/exclude settings to stop notes from being embedded altogether."},connections_list_component_key:{group:"Display",name:"Connections List Component",type:"dropdown",description:"Select the component used to render the connections list.",options_callback:o(s=>s.get_connections_list_component_options(),"options_callback")},connections_list_item_component_key:{group:"Display",name:"Connections list item",type:"dropdown",description:"Settings for individual connections list items.",options_callback:o(s=>s.get_connections_list_item_options(),"options_callback")},exclude_frontmatter_blocks:{group:"Display",name:"Hide frontmatter blocks in results",type:"toggle",description:"Show only sources in the connections results (no frontmatter blocks)."},inline_connections:{group:"Inline connections",name:"Show inline connections",type:"toggle",description:"Shows connections for each block within the note. Hover connections icon to see list of connections."},inline_connections_score_threshold:{group:"Inline connections",name:"Inline connections score threshold",type:"text",description:"Minimum score (0-1) required before inline connections are displayed."},inline_connections_skip_codeblocks:{group:"Inline connections",name:"Skip code blocks",type:"toggle",description:"Do not show inline connections for blocks inside code blocks."},footer_connections:{group:"Footer connections",name:"Show footer connections",type:"toggle",description:"Show connections at the bottom of each note."}},zp=class extends Go{static{o(this,"ConnectionsLists")}static version=2;process_load_queue(){}static get default_settings(){return{results_collection_key:"smart_sources",score_algo_key:"similarity",connections_post_process:"none",results_limit:20,inline_connections:!0,inline_connections_score_threshold:"0.77",footer_connections:!1,exclude_frontmatter_blocks:!0,connections_list_component_key:"connections_list_v4",connections_list_item_component_key:"connections_list_item_v3",actions:{}}}get settings_config(){return ox(this)}new_item(e){let t=new this.item_type(this.env,{collection_key:e.collection_key,item_key:e.key});return this.set(t),Object.defineProperty(e,"connections",{get:o(()=>t,"get"),configurable:!0}),t}get_score_algo_key_options(){return Object.entries(this.env.config.actions||{}).filter(([,e])=>(e.action?.action_type??e.action_type)==="score").map(([e,t])=>{let n=t.display_name||e;return{value:e,name:n,label:n,description:t.display_description}})}get_connections_post_process_options(){let e=Object.entries(this.env.config.actions||{}).filter(([t,n])=>t.startsWith("connections_list_post_process")).map(([t,n])=>({value:t,name:n.display_name||t,description:n.display_description}));return[{value:"none",name:"None"},...e]}get_connections_list_component_options(){return Object.entries(this.env.config.components||{}).filter(([e,t])=>e.startsWith("connections_list_")&&!e.startsWith("connections_list_item_")).map(([e,t])=>({value:e,name:t.display_name||e,description:t.display_description}))}get score_algo_settings_config(){let e=this.settings.score_algo_key,t=this.env.config.actions[e],n=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return n?Object.fromEntries(Object.entries(n).map(([i,r])=>[`actions.${e}.${i}`,r])):null}get connections_post_process_settings_config(){let e=this.settings.connections_post_process;if(e==="none")return null;let t=this.env.config.actions[e],n=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return n?Object.fromEntries(Object.entries(n).map(([i,r])=>[`actions.${e}.${i}`,r])):null}get connections_list_item_settings_config(){let e=this.settings.connections_list_item_component_key;if(!e||e==="none")return null;let t=this.env.config.components?.[e],n=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return n?Object.fromEntries(Object.entries(n).map(([i,r])=>[`components.${e}.${i}`,r])):null}get rank_model(){return this.env.ranking_models.default.instance}};function ox(s){let e={...yN};s.connections_post_process_settings_config&&(e=cl("connections_post_process",e,s.connections_post_process_settings_config)),s.score_algo_settings_config&&(e=cl("score_algo_key",e,s.score_algo_settings_config)),s.connections_list_item_settings_config&&(e=cl("connections_list_item_component_key",e,s.connections_list_item_settings_config));let t=Object.fromEntries(Object.entries(e).map(([n,i])=>n.endsWith("similarity_algo_description")?[n,i]:(i.scope_class="pro-setting",[n,i])));return{...ll(s),...t}}o(ox,"settings_config");var rx={class:zp,collection_key:"connections_lists",item_type:qe,settings_config:ox};function Sl(s){return s.endsWith("Item")?s.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():s.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}o(Sl,"collection_instance_name_from");function Ot(s={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(ax(e[t])&&ax(s[t])?Ot(s[t],e[t]):s[t]=e[t]);return s}o(Ot,"deep_merge");function ax(s){return s&&typeof s=="object"&&!Array.isArray(s)}o(ax,"is_plain_object");function cx(s){let e=JSON.stringify(s),t=0;if(e.length===0)return t;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}o(cx,"create_uid");function Gn(s=""){return s.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}o(Gn,"camel_case_to_snake_case");function Cl(s,e,t=new WeakMap){if(s===e)return!0;if(s===null||e===null||s===void 0||e===void 0||typeof s!=typeof e||Array.isArray(s)!==Array.isArray(e))return!1;if(Array.isArray(s))return s.length!==e.length?!1:s.every((n,i)=>Cl(n,e[i],t));if(typeof s=="object"){if(t.has(s))return t.get(s)===e;t.set(s,e);let n=Object.keys(s),i=Object.keys(e);return n.length!==i.length?!1:n.every(r=>Cl(s[r],e[r],t))}return s===e}o(Cl,"deep_equal");function Ol(s,e){return e?s.split("/").join(" > ").replace(".md",""):s.split("/").pop().replace(".md","")}o(Ol,"get_item_display_name");function ql(s,e){let t=e||{},n=o(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=o(m=>typeof m=="function","is_function"),r=o(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=o(m=>n(m)&&i(m.action),"is_action_object"),c=o(m=>i(m)||a(m)||r(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=o(m=>{if(!n(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let O=Object.getOwnPropertyDescriptor(m,w);if(!O)continue;let E={...O};"value"in E&&n(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=o(m=>{if(!n(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let O of h){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E){let q=E.value;if(c(q)){w=!0;continue}if(n(q)){if(_(q)){w=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=o(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=n(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=o(m=>{let h=Object.create(null),w=new Map;for(let O of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E&&_(E.value)){w.set(O,d(E.value));continue}try{Object.defineProperty(h,O,u(E))}catch{h[O]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=o((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=o((m,h,w=[])=>{if(!m||!h)return;let O=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(O.has(E))continue;let q=Object.getOwnPropertyDescriptor(m,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),b=o(m=>{let h=new m(s),w=h.action||h.run||h.execute||h.call;if(i(w)){let O=w.bind(h);return v(m,O),v(h,O),O.instance=h,O}return v(m,h),h},"instantiate_class"),A=o(m=>{if(r(m))return b(m);if(a(m)){let h=m.action.bind(s);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(s);return v(m,h),h}return n(m)?d(m):m},"bind_or_clone"),S=o(()=>{let m=s?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&n(h)?h:null},"scope_actions_for"),$=o((m,h,w)=>(m[h]=w,w),"cache_result"),j=o((m,h)=>{let w=S();return w&&g(w,h)?$(m,h,A(w[h])):g(f,h)?$(m,h,A(f[h])):$(m,h,void 0)},"compute_and_cache"),C=o(()=>{let m=S(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=o((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:o((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:o((m,h)=>{if(h in m)return!0;let w=S();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:o(()=>C(),"ownKeys"),getOwnPropertyDescriptor:o((m,h)=>{if(g(m,h))return x(m,h);let w=S();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:o((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:o((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:o((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}o(ql,"create_actions_proxy");var ie=class s{static{o(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Ot(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let n=new this(e,t);return n.init(),n}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let n=e.defaults[t];typeof n=="object"?this[t]={...n,...this[t]}:this[t]=this[t]===void 0?n:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return cx(this.data)}update_data(e){let t=this.sanitize_data(e),n={...this.data};return Ot(n,t),!Cl(this.data,n)?(this.data=n,!0):!1}sanitize_data(e){return e instanceof s?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,n)=>(t[n]=this.sanitize_data(e[n]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:n=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:r,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(n?.includes(this.key)||i&&this.key.startsWith(i)||r&&r.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=ql(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Sl(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Sl(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Gn(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}once_event(e,t){return this.env.events?.once(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Ol(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var bN=Object.getPrototypeOf(async function(){}).constructor,oe=class{static{o(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),n=t||new this.item_type(this.env);n._queue_save=!t;let i=n.update_data(e);return!t&&!n.validate_save()?n:(t||this.set(n),t&&!i?t:n.init instanceof bN?new Promise(r=>{n.init(e).then(()=>r(n))}):(n.init(e),n))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),n=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Ot(t.data,n),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:n}=e;for(let i of Object.values(this.items)){if(n&&t.length>=n)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let n=this.filter(e);return n[Math.floor(Math.random()*n.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(n=>n.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],n=e+"_adapter",i=t?.[n]??this.env.opts.collections?.smart_collections?.[n];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,n)=>{let i=t?.class?.version||t.version||0;return(n?.class?.version||n.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let n=o(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[r,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=n(c.callback)),c.btn_callback&&(c.btn_callback=n(c.btn_callback)),c.options_callback&&(c.options_callback=n(c.options_callback));let l=n(this.process_setting_key(r));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.collection_key&&n.collection_key!==this.collection_key||t(n)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=ql(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let n=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(n),e}};function $l(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.min===Number.POSITIVE_INFINITY){let{minScore:n,minObj:i}=lx(s.results);s.min=n,s.minResult=i}}else if(e.score>s.min){s.results.add(e),s.results.delete(s.minResult);let{minScore:n,minObj:i}=lx(s.results);s.min=n,s.minResult=i}}o($l,"results_acc");function _x(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.max===Number.NEGATIVE_INFINITY){let{maxScore:n,maxObj:i}=dx(s.results);s.max=n,s.maxResult=i}}else if(e.score<s.max){s.results.add(e),s.results.delete(s.maxResult);let{maxScore:n,maxObj:i}=dx(s.results);s.max=n,s.maxResult=i}}o(_x,"furthest_acc");function lx(s){let e=Number.POSITIVE_INFINITY,t=null;for(let n of s)n.score<e&&(e=n.score,t=n);return{minScore:e,minObj:t}}o(lx,"find_min");function dx(s){let e=Number.NEGATIVE_INFINITY,t=null;for(let n of s)n.score>e&&(e=n.score,t=n);return{maxScore:e,maxObj:t}}o(dx,"find_max");function He(s,e){let n=s.score-e.score;return Math.abs(n)<1e-9?0:n>0?-1:1}o(He,"sort_by_score");function jl(s,e){return He(s,e)}o(jl,"sort_by_score_descending");function ux(s,e){return He(s,e)*-1}o(ux,"sort_by_score_ascending");var Vt=class extends ie{static{o(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],n=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?($l(a,l,e.limit||20),a):(l?.error&&n.push(l.error),a)},{min:0,results:new Set}),r=Array.from(i).sort(jl);if(!r.length)return r;for(;!r.some(a=>a.score>.5);)r.forEach(a=>a.score*=2);return r}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};function mx(s,e=0){let t=s.length&3,n=s.length-t,i=e,r=3432918353,a=461845907,c=0,l=0,d=0;for(;c<n;)d=s.charCodeAt(c)&255|(s.charCodeAt(c+1)&255)<<8|(s.charCodeAt(c+2)&255)<<16|(s.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Hn(l,r),l=Dp(l,15),l=Hn(l,a),i^=l,i=Dp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(s.charCodeAt(c+2)&255)<<16;case 2:l^=(s.charCodeAt(c+1)&255)<<8;case 1:l^=s.charCodeAt(c)&255,l=Hn(l,r),l=Dp(l,15),l=Hn(l,a),i^=l;break}return i^=s.length,i=vN(i),i|0}o(mx,"murmur_hash_32");function re(s,e=0){return(mx(s,e)>>>0).toString(36)}o(re,"murmur_hash_32_alphanumeric");function Hn(s,e){return(s&65535)*e+((s>>>16)*e<<16)|0}o(Hn,"multiply_32");function Dp(s,e){return s<<e|s>>>32-e}o(Dp,"rotate_left_32");function vN(s){return s^=s>>>16,s=Hn(s,2246822507),s^=s>>>13,s=Hn(s,3266489909),s^=s>>>16,s|0}o(vN,"fmix_32");var Tl={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:o(s=>{let e=[{value:"smart_sources",name:"Sources"}];return s.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},Rp=class extends oe{static{o(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let n=kN(new Date),i=re(e),r=`${n}+${i}`;if(this.items[r])return this.items[r];let a=new Vt(this.env,{key:r,query:e,filter:t});return this.set(a),a}get settings_config(){return{...Tl}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function kN(s){let e=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),n=String(s.getDate()).padStart(2,"0");return`${e}-${t}-${n}`}o(kN,"format_ymd");var Jn={class:Rp,collection_key:"lookup_lists",item_type:Vt,settings_config:Tl};var wN={...Tl,results_limit:{type:"number",name:"Results limit",description:"Adjust the number of lookup results displayed (default 20).",scope_class:"pro-setting"}};Jn.settings_config=wN;Jn.version=2;var px=Jn;async function xN(s,e={}){return`<div class="embedded-backlinks">
<div class="backlink-pane" style="position: relative;">
<div class="tree-item-self is-clickable" aria-label="Click to collapse">
<div class="tree-item-inner">Smart Connections</div>
<div class="tree-item-flair-outer">
<span class="tree-item-flair">Pro</span>
</div>
</div>
<div class="search-result-container">
<div class="sc-connections-wrapper">
<div class="connections-view connections-footer-view sc-connections-view connections-view-early">
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div>
</div>
</div>
</div>
</div>`}o(xN,"build_html");async function hx(s,e={}){let t=await xN.call(this,s,e),n=this.create_doc_fragment(t);this.apply_style_sheet(ml);let i=n.firstElementChild;return EN.call(this,s,i,e),i}o(hx,"render");async function EN(s,e,t={}){let n=e.querySelector(".connections-list-container"),i=o(()=>localStorage.getItem("sc_footer_connections_folded")==="true","is_folded"),r=e.querySelector(".is-clickable");r.addEventListener("click",_=>{_.preventDefault(),_.stopPropagation();let u=!i();localStorage.setItem("sc_footer_connections_folded",String(u)),u?(r.setAttribute("aria-label","Click to expand"),r.classList.add("is-collapsed"),n.style.display="none"):(r.setAttribute("aria-label","Click to collapse"),r.classList.remove("is-collapsed"),n.style.display="block")});let a=s.env,c=t.connections_item,l=c.connections||a.connections_lists.new_item(c),d=await a.smart_components.render_component("connections_list_v3",l,t);return this.empty(n),n.appendChild(d),e}o(EN,"post_process");var fx=`.connections-graph {
position: relative;
width: 100%;
block-size: auto;
container-type: inline-size;
}

.sc-graph-svg {
width: 100%;
aspect-ratio: 1 / 1; /* keep square; height follows width */
height: auto;
display: block;
border-radius: var(--radius-m);
border: 1px solid var(--background-modifier-border);
background: var(--background-secondary);
box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--background-modifier-hover) 50%, transparent);
}

/* Details mount */
.sc-graph-details {
margin-block-start: 10px;
}

/* Nodes (small, Obsidian-like) */
.sc-graph-node .sc-graph-node-dot {
fill: var(--background-primary);
stroke: var(--color-base-100);
stroke-width: 1.25px;
transition: stroke-width 120ms ease, stroke 120ms ease, fill 120ms ease;
}

.sc-graph-node-center .sc-graph-node-dot {
fill: color-mix(in srgb, var(--interactive-accent) 18%, var(--background-primary));
stroke: var(--interactive-accent);
stroke-width: 1.5px;
}

.sc-graph-node-hover .sc-graph-node-dot {
fill: var(--background-modifier-hover);
stroke: var(--text-accent);
stroke-width: 2px;
}

/* Score as native SVG text */
.sc-score-text {
font-size: 0.8em;
fill: var(--text-muted);
opacity: 0.95;
pointer-events: none;
user-select: none;
}

.sc-graph-node-hover .sc-score-text {
display: none;
}

/* Label text */
.sc-node-label {
font-size: 0.85em;
font-weight: 500;
fill: var(--nav-item-color);
opacity: 0;
pointer-events: none;
user-select: none;
paint-order: stroke fill;
stroke: color-mix(in srgb, var(--background-primary) 65%, transparent);
stroke-width: 2px;
transition: opacity 120ms ease-in-out;
}

.sc-graph-node-hover .sc-node-label {
opacity: 0.96;
fill: var(--nav-item-color-active);
}

/* Explicitly hide any label rendered for the center (defense-in-depth) */
.connections-graph .sc-graph-node-center .sc-node-label {
display: none !important;
}

/* Pinned state */
.sc-graph-node.sc-result-pinned .sc-graph-node-dot {
fill: color-mix(in srgb, var(--interactive-accent) 12%, var(--background-primary));
stroke: var(--interactive-accent);
stroke-width: 2px;
filter: drop-shadow(0 0 0.25rem color-mix(in srgb, var(--interactive-accent) 50%, transparent));
}

.sc-graph-node.sc-result-hidden .sc-graph-node-dot {
fill: color-mix(in srgb, var(--background-modifier-border) 40%, transparent);
stroke: color-mix(in srgb, var(--text-muted) 65%, transparent);
stroke-width: 1px;
opacity: 0.6;
}

/* Hidden nodes: scores always visible but muted */
.sc-graph-node.sc-result-hidden .sc-score-text {
opacity: 0.4;
fill: var(--text-faint);
}

/* Hidden nodes: labels only appear on hover, with a softer style */
.sc-graph-node.sc-result-hidden.sc-graph-node-hover .sc-node-label {
opacity: 0.85;
fill: var(--text-faint);
}
`;function ae(s=[],e=[]){if(s.length!==e.length)throw new Error("Vectors must have the same length");let t=0,n=0,i=0,r=1e-8;for(let a=0;a<s.length;a++)t+=s[a]*e[a],n+=s[a]*s[a],i+=e[a]*e[a];return n=Math.sqrt(n),i=Math.sqrt(i),n<r||i<r?0:t/(n*i)}o(ae,"cos_sim");function Nl(s=""){let e=2166136261;for(let t=0;t<s.length;t++)e^=s.charCodeAt(t),e=Math.imul(e,16777619);return e+=e<<13,e^=e>>>7,e+=e<<3,e^=e>>>17,e+=e<<5,(e>>>0)/4294967295}o(Nl,"hash_to_unit");function gx(s="",e=-Math.PI/2){let t=Nl(s);return e+t*Math.PI*2}o(gx,"seeded_angle");function yx(s=[]){let e=s.map(c=>Number.isFinite(c)?+c:null),t=e.filter(c=>c!==null);if(!t.length)return{norm:e.map(()=>.5),min:0,max:1};let n=Math.min(...t),i=Math.max(...t),r=i-n||1;return{norm:e.map(c=>c===null?.5:(c-n)/r),min:n,max:i}}o(yx,"normalize_scores");function Fp(s,e,t){let n=Math.max(0,Math.min(1,Number(s)||0));return Math.round(e+(1-n)*(t-e))}o(Fp,"score_to_radius");function Bp(s){return Array.isArray(s)&&s.length>0}o(Bp,"is_vec");function SN(s=[]){let e=0;for(let t=0;t<s.length;t++){let n=s[t]||0;e+=n*n}return Math.sqrt(e)}o(SN,"norm");function Xo(s=[]){let e=SN(s);return!Number.isFinite(e)||e===0?null:s.map(t=>t/e)}o(Xo,"to_unit");function CN(s=[]){if(!s.length)return null;let e=s[0].length,t=new Array(e).fill(0),n=0;for(let r of s)if(r){for(let a=0;a<e;a++)t[a]+=r[a]||0;n++}if(!n)return null;let i=t.map(r=>r/n);return Xo(i)}o(CN,"mean_unit");function ON(s){let e=s>>>0;return o(function(){e|=0,e=e+1831565813|0;let n=Math.imul(e^e>>>15,1|e);return n^=n+Math.imul(n^n>>>7,61|n),((n^n>>>14)>>>0)/4294967296},"rand")}o(ON,"prng_from_seed");function bx(s=[],e=4,t=100,n=1337){let i=s.map(y=>y?Xo(y):null),r=i.map((y,g)=>y?g:-1).filter(y=>y>=0),a=r.length;if(a===0)return{centers:[],assign:new Array(s.length).fill(-1),sims:new Array(s.length).fill(0)};let c=ON(n),l=new Array(a).fill(1),d=[];for(d.push(i[r[Math.floor(c()*a)]]);d.length<Math.min(e,a);){for(let v=0;v<a;v++){let b=i[r[v]],A=-1/0;for(let $ of d){let j=ae(b,$);j>A&&(A=j)}let S=1-Math.max(0,Math.min(1,A));l[v]=S*S}let y=l.reduce((v,b)=>v+b,0)||1,g=c()*y,k=0;for(let v=0;v<a;v++)if(g-=l[v],g<=0){k=v;break}d.push(i[r[k]])}let _=new Array(a).fill(-1),u=new Array(a).fill(0);for(let y=0;y<t;y++){let g=!1;for(let b=0;b<a;b++){let A=i[r[b]],S=0,$=-1/0;for(let j=0;j<d.length;j++){let C=ae(A,d[j]);C>$&&($=C,S=j)}_[b]!==S&&(_[b]=S,g=!0),u[b]=Math.max(0,Math.min(1,$))}let k=d.map(()=>[]);for(let b=0;b<a;b++)k[_[b]].push(i[r[b]]);let v=d.map((b,A)=>CN(k[A]));for(let b=0;b<d.length;b++)v[b]||(v[b]=d[b]),d[b]=v[b];if(!g)break}let p=new Array(s.length).fill(-1),f=new Array(s.length).fill(0);for(let y=0;y<a;y++)p[r[y]]=_[y],f[r[y]]=u[y];return{centers:d,assign:p,sims:f}}o(bx,"kmeans_cosine_unit");function vx(s,e,t=[100,100,100,100]){return[Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4].map((i,r)=>{let a=t[r]??t[t.length-1]??100;return{x:Math.round(s+a*Math.cos(i)),y:Math.round(e+a*Math.sin(i))}})}o(vx,"quadrant_anchors");function kx(s,e,t){if(!Number.isFinite(s)||!Number.isFinite(e)||!Number.isFinite(t)||e>=t)return .45;let n=1-(s-e)/(t-e);return .45+.55*Math.max(0,Math.min(1,n))}o(kx,"radial_strength_for");function wx(s,e,t=24){let n=Math.max(1,Number(s)||100),i=Math.max(1,Number(e)||n),r=Math.min(n,i)/2,a=Math.round(r*.18),c=Math.max(12,a),l=Math.round(n*.45),d=Math.max(c+8,l);return{min_r:c,outer_r:d,half_min:r}}o(wx,"compute_radii");function xx(s="",e=70){let t=String(s??""),n=Math.max(0,Number.isFinite(e)?Math.floor(e):0);if(!n)return"";if(t.length<=n)return t;if(n<=3)return t.slice(0,n);let i="\u2026",r=n-i.length,a=Math.ceil(r/2),c=r-a;return`${t.slice(0,a)}${i}${t.slice(t.length-c)}`}o(xx,"truncate_middle");function Ex(s,e={}){let{center_x:t=0,label_width:n=0,view_width:i=0,radius:r=0,margin:a=10}=e,c=Math.max(2,a),l=c,d=Math.max(l,i-c),_=s>=t?"start":"end",u=r+c;if(_==="start"){let g=u,k=s+g,v=k+n;if(v>d){let b=v-d;g-=b,k-=b}return k<l&&(g+=l-k),{anchor:_,offset:g}}let p=-u,f=s+p,y=f-n;if(y<l){let g=l-y;p+=g,f+=g}return f>d&&(p-=f-d),{anchor:_,offset:p}}o(Ex,"label_anchor_offset");function Ax(s,e,t,n,i){let r=t-s,a=n-e,c=Math.hypot(r,a)||1,l=r/c,d=a/c;return{x:Math.round(s+l*i),y:Math.round(e+d*i)}}o(Ax,"project_anchor_to_ring");function qN(s=[]){let e=new Set;for(let t of s){let n=Wp(t?.item);n&&e.add(n)}return e}o(qN,"build_prefixed_key_set");function Wp(s){if(s)return Wt(s.collection_key,s.key)}o(Wp,"prefixed_key_for_item");function $N({connections_state:s={},existing_keys:e=new Set,resolve_item:t}={}){if(typeof t!="function")return[];let n=[];for(let[i,r]of Object.entries(s)){if(!r?.hidden||r?.pinned||e.has(i))continue;let a=jN(i);if(!a)continue;let c=t(a.collection_key,a.item_key);c&&(e.add(i),n.push({item:c,score:null,is_hidden:!0,prefixed_key:i}))}return n}o($N,"collect_hidden_entries");function Sx({is_center:s=!1,is_hidden:e=!1,is_pinned:t=!1}={}){let n=["sc-graph-node"];return s&&n.push("sc-graph-node-center"),t&&n.push("sc-result-pinned"),e&&n.push("sc-result-hidden"),n.join(" ").trim()}o(Sx,"build_node_classname");function jN(s){if(typeof s!="string"||!s.includes(":"))return null;let[e,...t]=s.split(":");return!e||!t.length?null:{collection_key:e,item_key:t.join(":")}}o(jN,"parse_prefixed_key");var TN="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js",Cx="7.",NN=typeof globalThis<"u"&&globalThis.SC_D3_INTEGRITY_SHA256||"";function Up(s){if(!s)return;let e=String(s.version||"");e&&!e.startsWith(Cx)&&console.warn(`[connections_graph] Loaded d3 version "${e}" but expected v${Cx}x`)}o(Up,"validate_d3_instance");async function PN(){let s=typeof globalThis<"u"?globalThis:window;if(s.d3||(typeof document<"u"?document.querySelector("script[data-sc-d3]"):null)&&s.d3)return Up(s.d3),s.d3;let t=await new Promise((n,i)=>{if(typeof document>"u"||!document.head){i(new Error("D3 loader: document.head not available"));return}let r=document.createElement("script");r.src=TN,r.async=!0,r.setAttribute("data-sc-d3","true");let a=String(NN||"").trim();a&&(r.integrity=a,r.crossOrigin="anonymous"),r.onload=()=>{if(!s.d3){i(new Error("D3 loader: script loaded but window.d3 is missing"));return}n(s.d3)},r.onerror=()=>{i(new Error("D3 loader: failed to load d3 from CDN"))},document.head.appendChild(r)});return Up(t),t}o(PN,"load_d3");async function IN(s,e={}){let t=e?.to_item||s?.item,n=e.width??100,i=e.height??100;return`
<div class="connections-graph sc-graph"
data-center-key="${t?.key||""}"
data-center-collection="${t?.collection_key||""}">
<svg class="sc-graph-svg"
width="${n}" height="${i}"
viewBox="0 0 ${n} ${i}"
preserveAspectRatio="xMidYMid meet">
<g class="sc-graph-viewport">
<g class="nodes"></g>
</g>
</svg>
<div class="sc-graph-details" aria-live="polite"></div>
</div>
`}o(IN,"build_html");async function Ox(s,e={}){this.apply_style_sheet(fx);let t=await IN.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".connections-graph");return LN.call(this,s,i,e),i}o(Ox,"render");async function LN(s,e,t={}){let n=await s.get_results(t);try{let i=await PN(),r=t.to_item||s?.item;if(!r)throw new Error("connections_graph: could not resolve center item.");let a=r.env,c=t.connections_settings??a.connections_lists.settings,l=r?.data?.connections||{},d=qN(n),_=$N({connections_state:l,existing_keys:d,resolve_item:o((m,h)=>s?.env?.[m]?.get(h),"resolve_item")}),u=[...n,..._],p=e.querySelector("svg.sc-graph-svg"),y=p.querySelector("g.sc-graph-viewport").querySelector("g.nodes"),g=8,k=5,v=24,b=10,A=null,S=null,$=o(m=>{let h=Vo(m,{show_full_path:!1})||m?.key||"";return xx(h,70)},"build_label_text"),j=+p.getAttribute("width")||100,C=o(()=>{let m=e.clientWidth||+p.getAttribute("width")||100,h=m;j=m,p.setAttribute("viewBox",`0 0 ${m} ${h}`),p.setAttribute("width",m),p.setAttribute("height",h);let w=Math.round(m*.5),O=Math.round(h*.5),{min_r:E,outer_r:q,half_min:N}=wx(m,h,v),L=Bp(r?.vec)?Xo(r.vec):null,me=u.map(T=>Bp(T?.item?.vec)?Xo(T.item.vec):null),ge=me.map(T=>L&&T?Math.max(0,Math.min(1,ae(L,T))):null),{norm:ye}=yx(ge),X={id:"__center__",item:r,score:1,radius:g,isCenter:!0,x:w,y:O,fx:w,fy:O},w2=Math.floor(Nl(u.map(T=>T?.item?.key||"").join("|"))*1e9),{centers:fm,assign:By}=bx(me,4,300,w2),Uy=(fm.length?fm:[null,null,null,null]).slice(0,4).map(T=>L&&T?Math.max(0,Math.min(1,ae(L,T))):.5),Zi=Uy.map(T=>Fp(T,E,q));for(;Zi.length<4;)Zi.push(Zi[Zi.length-1]||Math.round((E+q)/2));let x2=vx(w,O,Zi),E2=u.map((T,V)=>{let P=T?.item;if(!P)return null;let fs=ye[V]??.5,Et=Fp(fs,E,q),ln=gx(P.key||String(V),-Math.PI/2),dn=Math.round(w+Et*Math.cos(ln)),Qi=Math.round(O+Et*Math.sin(ln)),Ee=Number.isInteger(By[V])?By[V]:Math.floor(Nl(P.key||String(V))*4),_n=me[V],un=fm[Ee]||null,eo=_n&&un?Math.max(0,Math.min(1,ae(_n,un))):0,It=Wp(P),O2=It?Ho(l,It):!1,q2=!!T?.is_hidden||(It?ul(l,It):!1);return{id:P.key,item:P,score:Number.isFinite(T?.score)?+T.score:L&&_n?ae(L,_n):null,ring_r:Et,angle:ln,radius:k,isCenter:!1,x:dn,y:Qi,cluster:Ee,node_to_cluster_sim:eo,label_text:$(P),prefixed_key:It,isPinned:O2,isHidden:q2}}).filter(Boolean),hs=[X,...E2];S=i.select(y).selectAll("g.sc-graph-node").data(hs,T=>T.id).join(T=>{let V=T.append("g").attr("class",P=>Sx({is_center:P.isCenter,is_hidden:P.isHidden,is_pinned:P.isPinned})).attr("title",P=>(P.item.path||"").replace(/"/g,"&quot;")).attr("data-collection",P=>P.item.collection_key).attr("data-key",P=>P.item.key).attr("data-path",P=>(P.item.path||"").replace(/"/g,"&quot;")).attr("data-link",P=>(P.item.link||"").replace(/"/g,"&quot;")).attr("data-score",P=>`${P.score??""}`).attr("data-cluster",P=>P.isCenter?"":String(P.cluster)).attr("data-hidden",P=>P.isHidden?"true":null).attr("data-pinned",P=>P.isPinned?"true":null).attr("data-prefixed-key",P=>P.prefixed_key||"");return V.append("circle").attr("r",P=>P.radius).attr("class","sc-graph-node-dot"),V.append("text").attr("class","sc-score-text").attr("y",-k-6).attr("text-anchor","middle").attr("alignment-baseline","baseline").text(P=>typeof P.score=="number"&&!P.isCenter?P.score.toFixed(2):""),V.filter(P=>!P.isCenter).append("text").attr("class","sc-node-label").attr("y",-k-6).attr("text-anchor","middle").attr("alignment-baseline","baseline").text(P=>P.label_text.replace(".md","")),V}),S.attr("class",T=>Sx({is_center:T.isCenter,is_hidden:T.isHidden,is_pinned:T.isPinned})).attr("data-hidden",T=>T.isHidden?"true":null).attr("data-pinned",T=>T.isPinned?"true":null).attr("data-prefixed-key",T=>T.prefixed_key||"").attr("transform",T=>`translate(${T.x},${T.y})`);let A2=o(()=>{S.classed("sc-graph-node-hover",!1)},"clear_hover");S.on("mouseenter",function(){A2(),i.select(this).classed("sc-graph-node-hover",!0)}).on("mouseleave",function(){i.select(this).classed("sc-graph-node-hover",!1)}).on("click",function(T,V){MN({node:V,container:e,env:a,center_item:r})});let Wy=i.forceRadial(T=>T.isCenter?0:T.ring_r,w,O).strength(T=>T.isCenter?1:kx(T.ring_r,E,q)),Gy=i.forceCollide(T=>T.radius+16).strength(.9).iterations(2),Hy=i.forceManyBody().strength(-80).distanceMax(N),S2=o(T=>{if(T.isCenter)return 0;let V=.04,P=Math.max(0,Math.min(1,T.node_to_cluster_sim||0)),fs=Uy[(T.cluster??0)%4]||.5;return V+.28*P*(.5+.5*fs)},"cluster_strength_fn");function C2(T=[],V=()=>.2,P=0,fs=0){let Et=[];function ln(dn){for(let Qi=0;Qi<Et.length;Qi++){let Ee=Et[Qi];if(Ee.isCenter)continue;let _n=Number.isInteger(Ee.cluster)?Ee.cluster%T.length:0,un=T[_n],eo=Math.max(0,Math.min(1,V(Ee)));if(!un||eo<=0)continue;let It=Ax(P,fs,un.x,un.y,Ee.ring_r);Ee.vx+=(It.x-Ee.x)*eo*dn,Ee.vy+=(It.y-Ee.y)*eo*dn}}return o(ln,"force"),ln.initialize=function(dn){Et=dn},ln}o(C2,"force_cluster");let Jy=C2(x2,S2,w,O);A?(A.nodes(hs),A.force("radial",Wy),A.force("cluster",Jy),A.force("collide",Gy),A.force("charge",Hy),hs[0].fx=w,hs[0].fy=O,A.alpha(.8).restart()):A=i.forceSimulation(hs).alpha(.95).alphaDecay(.08).force("radial",Wy).force("cluster",Jy).force("collide",Gy).force("charge",Hy).on("tick",()=>{hs[0].fx=w,hs[0].fy=O,S.attr("transform",T=>`translate(${T.x},${T.y})`),S.select("text.sc-node-label").each(function(T){if(T.isCenter)return;let V=this,P=typeof V.getComputedTextLength=="function"?V.getComputedTextLength():0,{anchor:fs,offset:Et}=Ex(T.x,{center_x:w,label_width:P,view_width:j,radius:T.radius,margin:b});i.select(V).attr("text-anchor",fs).attr("x",Et)})})},"layout");C(),new ResizeObserver(()=>C()).observe(e)}catch(i){console.error("[connections_graph] post_process error:",i);let r=document.createElement("p");r.className="sc-no-results",r.textContent="Unable to render graph. See console for details.",e.appendChild(r)}return e}o(LN,"post_process");function MN({node:s,container:e,env:t,center_item:n}){if(!s?.item)return;let i=zN(s,n);i&&(typeof CustomEvent=="function"&&e?.dispatchEvent&&e.dispatchEvent(new CustomEvent("connections:result",{detail:i,bubbles:!0})),t?.events?.emit?.("connections:result",i),s.item.emit_event?.("connections:result",i),s.item.emit_event?.("connections:open_result",i))}o(MN,"handle_node_click");function zN(s,e){let t=s?.item?.collection_key,n=s?.item?.key;return!t||!n?null:{collection_key:t,item_key:n,prefixed_key:s.prefixed_key||Wp(s.item)||Wt(t,n),score:typeof s.score=="number"?s.score:null,is_hidden:!!s.isHidden,is_pinned:!!s.isPinned,event_source:"connections-graph-v1",center_key:e?.key}}o(zN,"build_result_detail");async function DN(s,e={}){return`<div>
<div class="connections-graph-container"></div>
<div class="connections-list sc-list" data-key="${s.item.key}"></div>
</div>`}o(DN,"build_html");async function $x(s,e={}){let t=await DN.call(this,s,e),i=this.create_doc_fragment(t).querySelector("div");return RN.call(this,s,i,e),i}o($x,"render");async function RN(s,e,t={}){let n=s.env,i=e.querySelector(".connections-graph-container"),r=e.querySelector(".connections-list.sc-list");e.dataset.key=s.item.key;let a=await s.get_results(t),c=await n.smart_components.render_component("connections_graph_v1",s,t);if(this.empty(i),i.appendChild(c),BN(c,r),!a||!Array.isArray(a)||a.length===0){let _=this.create_doc_fragment(`<p class="sc-no-results">No results found.<br><em>Try using the refresh button. If that doesn't work, try running "Clear sources data" and then "Reload sources" in the Smart Environment settings.</em></p>`);return r.appendChild(_),e}let l=s.env.smart_components;return(await Promise.all(a.map(_=>l.render_component("connections_list_item_v3",_,{...t})))).forEach(_=>r.appendChild(_)),e}o(RN,"post_process");var qx="sc-result-graph-focus",FN=2400;function BN(s,e){!s||!e||s.addEventListener("connections:result",t=>{UN(e,t?.detail||{})})}o(BN,"register_graph_events");function UN(s,e={}){let t=WN(s,e);if(!t)return;t.classList.contains("sc-collapsed")&&t.classList.remove("sc-collapsed"),t.scrollIntoView?.({block:"center",behavior:"smooth"}),t.classList.add(qx),(typeof window<"u"?window.setTimeout:setTimeout)?.(()=>t.classList.remove(qx),FN)}o(UN,"focus_result_from_graph");function WN(s,e={}){if(!s)return null;let{collection_key:t,item_key:n}=e;return!t||!n?null:Array.from(s.querySelectorAll(".sc-result")).find(i=>i.dataset.collection===t&&i.dataset.key===n)||null}o(WN,"find_result_element");var jx="PRO: Graph + List";function Tx(s,e){if(typeof s!="string"||typeof e!="string")throw new TypeError("Both parameters must be strings.");let t=e.match(/\b[\w\s]+\b/g)||[],n="";for(;n.length<10&&t.length>0;)n=t.shift().trim();let i="";for(;i.length<10&&t.length>0;)i=t.pop().trim();let r;if(!i||n===i)r=encodeURIComponent(n);else{let c=encodeURIComponent(n),l=encodeURIComponent(i);r=`${c},${l}`}let a=new URL(s,"http://dummy");if(a.hash){let c=a.hash.slice(1);if(c.includes(":~:text="))return`${a.origin}${a.pathname}#${c}&text=${r}`;a.hash=`${c}:~:text=${r}`}else a.hash=`:~:text=${r}`;return a.toString()}o(Tx,"create_highlight_url");async function GN(s,e={}){return`<div><div class="sc-connections-web-view">
<div class="sc-list"><ul></ul></div>
</div></div>`}o(GN,"build_html");async function Nx(s,e={}){let t=await GN.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".sc-connections-web-view");return HN.call(this,s,i,e),i}o(Nx,"render");async function HN(s,e,t={}){let i=e.querySelector(".sc-list").querySelector("ul");return await o(async()=>{let a=Object.keys(s.data.hidden_connections||{}),c=await s.find_connections({exclude_key_ends_with:"---frontmatter---",exclude_keys:a,...t.filter||{}});console.log("render_results",c);for(let l of c){let _="https://wfhbrian.com/"+((l.item.source?.metadata||l.item.metadata||{})["wfhbrian.com"]?.replace(/\.html$/,"").replace(/\s/g,"-")||""),u=await l.item.read(),f=(u.split(`
`).map(A=>A.trim()).filter(A=>A.length>0)[0]||"").replace(/^\W+([a-zA-Z\s\d\-]+).*/,"$1").trim(),y=Tx(_,u),g,k=l.item.key.split("#"),v=k.pop();v.startsWith("{")?g=(k.pop()+v).trim():g=v;let b=g.startsWith("{")?f:g;i.appendChild(this.create_doc_fragment('<li data-key="'+l.item.key+'" data-score="'+l.score+'"><a href="'+y+'">'+b+"</a></li>"))}},"render_results")(),e}o(HN,"post_process");var Ns=require("obsidian");var Gp=require("obsidian");async function Px(s,e,t=null,n={}){let{new_tab:i=!1}=n,r=s.env;e.endsWith("#")&&(e=e.slice(0,-1));let a,c=null;if(e.includes("#")){let[d]=e.split("#");a=s.app.metadataCache.getFirstLinkpathDest(d,""),c=r.smart_blocks.get(e)}else a=s.app.metadataCache.getFirstLinkpathDest(e,"");if(!a){console.warn(`[open_note] Unable to resolve file for ${e}`);return}let l;if(t){let d=Gp.Keymap.isModEvent(t),_=Gp.Keymap.isModifier(t,"Alt");d&&_?l=s.app.workspace.splitActiveLeaf("vertical"):d||i?l=s.app.workspace.getLeaf(!0):l=s.app.workspace.getMostRecentLeaf()}else l=s.app.workspace.getMostRecentLeaf();if(await l.openFile(a),typeof c?.line_start=="number"){let{editor:d}=l.view,_={line:c.line_start,ch:0};d.setCursor(_),d.scrollIntoView({to:_,from:_},!0)}}o(Px,"open_note");var Ix=`/* Duplicate blocks modal (results) */

.sc-dup-modal {
width: min(1200px, calc(100vw - 80px));
max-width: 1200px;
}

.sc-dup-root {
padding-top: 4px;
}

.sc-dup-header {
display: flex;
flex-direction: column;
gap: 6px;
margin-bottom: 12px;
}

.sc-dup-title {
margin: 0;
font-size: 1.45em;
letter-spacing: -0.01em;
}

.sc-dup-subtitle {
margin: 0;
color: var(--text-muted);
line-height: 1.4;
max-width: 72ch;
}

.sc-dup-meta {
display: flex;
flex-wrap: wrap;
gap: 8px;
align-items: center;
margin-top: 8px;
}

.sc-dup-chip {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 4px 10px;
border-radius: 999px;
border: 1px solid var(--background-modifier-border);
background: color-mix(in srgb, var(--background-secondary) 78%, var(--background-primary));
font-size: 0.85em;
color: var(--text-muted);
white-space: nowrap;
}

.sc-dup-chip strong {
color: var(--text-normal);
font-weight: 600;
letter-spacing: -0.01em;
}

.sc-dup-empty {
margin-top: 8px;
color: var(--text-muted);
}

.sc-dup-list {
display: flex;
flex-direction: column;
gap: 14px;
}

.sc-dup-row {
border: 1px solid var(--background-modifier-border);
border-radius: 12px;
background: color-mix(in srgb, var(--background-primary) 94%, var(--background-secondary));
overflow: hidden;
box-shadow: var(--shadow-s);
transition: border-color 120ms ease, box-shadow 120ms ease;
}

.sc-dup-row:hover {
border-color: color-mix(in srgb, var(--interactive-accent) 35%, var(--background-modifier-border));
box-shadow: var(--shadow-s), 0 14px 28px rgba(0, 0, 0, 0.12);
}

.sc-dup-row-header {
display: flex;
align-items: center;
justify-content: space-between;
gap: 12px;
padding: 10px 12px;
background: color-mix(in srgb, var(--background-secondary) 78%, transparent);
border-bottom: 1px solid var(--background-modifier-border);
}

.sc-dup-row-title {
display: flex;
align-items: baseline;
gap: 10px;
min-width: 0;
}

.sc-dup-row-match {
font-weight: 600;
letter-spacing: -0.01em;
}

.sc-dup-row-hint {
color: var(--text-muted);
font-size: 0.85em;
white-space: nowrap;
}

.sc-dup-score-chip {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 4px 10px;
border-radius: 999px;
border: 1px solid var(--background-modifier-border);
background: color-mix(in srgb, var(--background-secondary) 78%, var(--background-primary));
font-size: 0.85em;
color: var(--text-muted);
white-space: nowrap;
}

.sc-dup-score-chip .sc-dup-score-value {
color: var(--text-normal);
font-weight: 650;
letter-spacing: -0.01em;
}

.sc-dup-score-chip.is-high {
border-color: color-mix(in srgb, var(--interactive-accent) 60%, var(--background-modifier-border));
background: color-mix(in srgb, var(--interactive-accent) 14%, var(--background-secondary));
}

.sc-dup-score-chip.is-medium {
border-color: color-mix(in srgb, var(--interactive-accent) 40%, var(--background-modifier-border));
background: color-mix(in srgb, var(--interactive-accent) 10%, var(--background-secondary));
}

.sc-dup-score-chip.is-low {
border-color: color-mix(in srgb, var(--interactive-accent) 24%, var(--background-modifier-border));
background: color-mix(in srgb, var(--interactive-accent) 7%, var(--background-secondary));
}

.sc-dup-score-chip.is-unknown {
opacity: 0.85;
}

.sc-dup-grid {
display: grid;
grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
}

.sc-dup-col {
padding: 12px;
display: flex;
flex-direction: column;
gap: 10px;
min-width: 0;
}

.sc-dup-col + .sc-dup-col {
border-left: 1px solid var(--background-modifier-border);
}

@media (max-width: 740px) {
.sc-dup-grid {
grid-template-columns: 1fr;
}

.sc-dup-col + .sc-dup-col {
border-left: none;
border-top: 1px solid var(--background-modifier-border);
}

.sc-dup-row-hint {
display: none;
}
}

.sc-dup-col-header {
display: flex;
flex-direction: column;
gap: 4px;
min-width: 0;
}

.sc-dup-col-top {
display: flex;
align-items: center;
justify-content: space-between;
gap: 10px;
}

.sc-dup-col-title {
font-size: 0.95em;
font-weight: 650;
letter-spacing: -0.01em;
color: var(--text-normal);
}

.sc-dup-lines {
font-size: 0.8em;
color: var(--text-muted);
padding: 2px 8px;
border-radius: 999px;
border: 1px solid var(--background-modifier-border);
background: color-mix(in srgb, var(--background-primary) 84%, var(--background-secondary));
white-space: nowrap;
}

.sc-dup-lines.is-hidden {
display: none;
}

.sc-dup-block-meta {
font-size: 0.85em;
color: var(--text-muted);
line-height: 1.35;
overflow: hidden;
display: -webkit-box;
-webkit-line-clamp: 2;
-webkit-box-orient: vertical;
}

.sc-dup-clickable {
cursor: pointer;
}

.sc-dup-clickable:hover {
color: var(--text-normal);
}

.sc-dup-clickable:focus-visible {
outline: 2px solid var(--interactive-accent);
outline-offset: 2px;
border-radius: 8px;
}

.sc-dup-body {
border: 1px solid var(--background-modifier-border);
border-radius: 10px;
background: var(--background-secondary);
padding: 10px 12px;
max-height: 260px;
overflow: auto;
white-space: pre-wrap;
line-height: 1.45;
font-family: var(--font-text);
color: var(--text-normal);
box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--background-modifier-hover) 45%, transparent);
}

.sc-dup-body.is-loading {
color: var(--text-muted);
opacity: 0.9;
}

.sc-dup-body:focus-visible {
outline: 2px solid var(--interactive-accent);
outline-offset: 2px;
}

.sc-dup-actions {
display: flex;
justify-content: flex-end;
gap: 8px;
}

.sc-dup-btn {
border-radius: 999px;
padding: 7px 12px;
font-size: 0.85em;
line-height: 1;
}

.sc-dup-btn:disabled {
opacity: 0.55;
cursor: not-allowed;
}

.sc-dup-btn.is-ghost {
background: transparent;
border: 1px solid var(--background-modifier-border);
color: var(--text-muted);
}

.sc-dup-btn.is-ghost:hover {
background: var(--background-modifier-hover);
color: var(--text-normal);
}

.sc-dup-btn.is-primary {
background: var(--interactive-accent);
border: 1px solid color-mix(in srgb, var(--interactive-accent) 65%, var(--background-modifier-border));
color: var(--text-on-accent);
}

.sc-dup-btn.is-primary:hover {
background: var(--interactive-accent-hover, var(--interactive-accent));
filter: brightness(1.05);
}

.sc-dup-btn:focus-visible {
outline: 2px solid var(--interactive-accent);
outline-offset: 2px;
}

/* Threshold modal (picker) */

.sc-dup-threshold-modal {
width: min(520px, calc(100vw - 80px));
max-width: 520px;
}

.sc-dup-threshold-root {
padding-top: 4px;
}

.sc-dup-threshold-title {
margin-bottom: 8px;
}

.sc-dup-threshold-subtitle {
margin-top: 0;
margin-bottom: 10px;
color: var(--text-muted);
}

.sc-dup-threshold-form {
display: flex;
flex-direction: column;
gap: 12px;
}

.sc-dup-threshold-input-row {
display: flex;
align-items: center;
gap: 12px;
}

.sc-dup-threshold-range {
width: 100%;
}

.sc-dup-threshold-number {
width: 96px;
text-align: right;
}

.sc-dup-presets {
display: flex;
flex-wrap: wrap;
gap: 8px;
}

.sc-dup-preset-btn.is-active {
background: var(--background-modifier-hover);
color: var(--text-normal);
}

.sc-dup-threshold-actions {
display: flex;
justify-content: flex-end;
gap: 8px;
margin-top: 12px;
}
`;var zx=.9,VN=20;function Dx(s,e={}){let t=Lx(s?.blocks);if(!t.length)return[];let n=Lx(e.all_blocks).filter(c=>!c.key.startsWith(s.key)),i=Number.isFinite(e.min_similarity)?e.min_similarity:zx,r=Number.isFinite(e.max_results)?e.max_results:VN;return KN({source_blocks:t,all_blocks:n,min_similarity:i}).sort(XN).slice(0,r)}o(Dx,"find_duplicate_blocks");function KN({source_blocks:s,all_blocks:e,min_similarity:t}){let n=new Set;return s.reduce((i,r)=>{if(!r?.vec)return i;let a=Mx(r);return a&&e.forEach(c=>{if(!c?.vec)return;let l=Mx(c);if(!l||l===a)return;let d=YN(a,l);if(n.has(d))return;n.add(d);let _=ae(r.vec,c.vec);!Number.isFinite(_)||_<t||i.push({source_block:r,target_block:c,score:_})}),i},[])}o(KN,"collect_block_matches");function Lx(s){return s?Array.isArray(s)?s:typeof s=="object"?Object.values(s):[]:[]}o(Lx,"normalize_blocks");function Mx(s){return s?.key??s?.path??s?.id??null}o(Mx,"build_block_key");function YN(s,e){return`${s}::${e}`}o(YN,"build_pair_key");function XN(s,e){return e.score-s.score}o(XN,"sort_by_score_descending");function Rx(s){return Number.isFinite(s)?s>=.97?"is-high":s>=.93?"is-medium":"is-low":"is-unknown"}o(Rx,"score_class_for");function Hp(s){if(!Number.isFinite(s))return"n/a";let e=Math.max(0,Math.min(1,s))*100,t=e>=99.95?0:1;return`${e.toFixed(t)}%`}o(Hp,"format_similarity_percent");function Jp(s){return Number.isFinite(s)?Math.max(0,Math.min(1,s)).toFixed(3):"n/a"}o(Jp,"format_similarity_raw");function Pl(s){let e=Number(s);return Number.isFinite(e)?e<0?0:e>1?1:Math.round(e*100)/100:zx}o(Pl,"clamp_similarity");function Fx(s){return s?.key??s?.path??s?.id??null}o(Fx,"build_block_cache_key");var ZN=[.85,.9,.93,.95,.97],QN=.9,eP=4;async function tP(s,e={}){return String(e.variant||"results")==="threshold"?`
<div class="sc-dup-threshold-root" data-variant="threshold">
<div class="sc-dup-threshold-header">
<h3 class="sc-dup-threshold-title">Duplicate detection threshold</h3>
<p class="sc-dup-threshold-subtitle">Higher means stricter matches (fewer results). A strong default is 0.90.</p>
</div>

<div class="sc-dup-threshold-form">
<div class="sc-dup-threshold-input-row">
<input class="sc-dup-threshold-range" type="range" min="0" max="1" step="0.01" />
<input class="sc-dup-threshold-number" type="number" min="0" max="1" step="0.01" />
</div>
<div class="sc-dup-presets" data-role="presets"></div>
</div>

<div class="sc-dup-threshold-actions">
<button class="sc-dup-btn is-ghost" data-action="cancel" type="button">Cancel</button>
<button class="sc-dup-btn is-primary" data-action="submit" type="button">Run search</button>
</div>
</div>
`:`
<div class="sc-dup-root" data-variant="results">
<div class="sc-dup-header">
<h2 class="sc-dup-title">Possible duplicate blocks</h2>
<p class="sc-dup-subtitle">Review side-by-side block contents and open the matching block.</p>
<div class="sc-dup-meta" data-role="meta"></div>
</div>
<div class="sc-dup-list" data-role="list"></div>
</div>
`}o(tP,"build_html");async function Wx(s,e={}){this.apply_style_sheet(Ix);let t=await tP.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return sP.call(this,s,i,e),i}o(Wx,"render");async function sP(s,e,t={}){if(!e||e.dataset.sc_dup_bound==="true")return e;e.dataset.sc_dup_bound="true";let n=String(t.variant||e.dataset.variant||"results"),i=[];return this.attach_disposer(e,()=>i.forEach(r=>r())),n==="threshold"?(iP.call(this,{scope:s,container:e,params:t,disposers:i}),e):(nP.call(this,{scope:s,container:e,params:t,disposers:i}),e)}o(sP,"post_process");function nP({scope:s,container:e,params:t,disposers:n}){let i=Array.isArray(t.results)?t.results:[],r=Number.isFinite(t.min_similarity)?t.min_similarity:null,a=lP({scope:s,params:t}),c=e.querySelector('[data-role="meta"]'),l=e.querySelector('[data-role="list"]');if(c&&this.empty(c),l&&this.empty(l),c&&(c.appendChild(Ux({label:"Results",value:String(i.length)})),Number.isFinite(r)&&c.appendChild(Ux({label:"Threshold",value:Jp(r)}))),!l)return;if(!i.length){let u=document.createElement("div");u.className="sc-dup-empty",u.textContent="No duplicate blocks found.",l.appendChild(u);return}let d=rP({container:e}),_=aP({container:e});i.forEach((u,p)=>{let f=oP({plugin:a,result:u,index:p,cache:d,read_scheduler:_,disposers:n});l.appendChild(f)})}o(nP,"post_process_results");function iP({scope:s,container:e,params:t,disposers:n}){let i=e.querySelector("input.sc-dup-threshold-range"),r=e.querySelector("input.sc-dup-threshold-number"),a=e.querySelector('[data-role="presets"]'),c=e.querySelector('button[data-action="cancel"]'),l=e.querySelector('button[data-action="submit"]');if(!i||!r||!a||!c||!l)return;this.empty(a);let d=Pl(t.default_value??QN),_=o(b=>{let A=Pl(b);return i.value=String(A),r.value=String(A),_P({root:e,value:A}),A},"set_value"),u=o(()=>{let b=Number.parseFloat(r.value),A=Pl(Number.isFinite(b)?b:d);if(typeof t.on_submit=="function"){t.on_submit(A);return}t.modal?.close?.()},"submit"),p=o(()=>{if(typeof t.on_cancel=="function"){t.on_cancel();return}t.modal?.close?.()},"cancel");_(d),ZN.forEach(b=>{let A=document.createElement("button");A.className="sc-dup-btn is-ghost sc-dup-preset-btn",A.type="button",A.dataset.value=String(b),A.textContent=b.toFixed(2);let S=o($=>{$.preventDefault(),_(b)},"on_click");A.addEventListener("click",S),n.push(()=>A.removeEventListener("click",S)),a.appendChild(A)});let f=o(()=>_(Number.parseFloat(i.value)),"on_range"),y=o(()=>_(Number.parseFloat(r.value)),"on_number");i.addEventListener("input",f),r.addEventListener("input",y),n.push(()=>i.removeEventListener("input",f)),n.push(()=>r.removeEventListener("input",y));let g=o(b=>{b.preventDefault(),p()},"on_cancel_click"),k=o(b=>{b.preventDefault(),u()},"on_submit_click");c.addEventListener("click",g),l.addEventListener("click",k),n.push(()=>c.removeEventListener("click",g)),n.push(()=>l.removeEventListener("click",k));let v=o(b=>{if(b.key==="Enter"){b.preventDefault(),u();return}b.key==="Escape"&&(b.preventDefault(),p())},"on_keydown");i.addEventListener("keydown",v),r.addEventListener("keydown",v),n.push(()=>i.removeEventListener("keydown",v)),n.push(()=>r.removeEventListener("keydown",v))}o(iP,"post_process_threshold");function oP({plugin:s,result:e,index:t,cache:n,read_scheduler:i,disposers:r}){let a=document.createElement("div");a.className="sc-dup-row";let c=document.createElement("div");c.className="sc-dup-row-header";let l=document.createElement("div");l.className="sc-dup-row-title";let d=document.createElement("span");d.className="sc-dup-row-match",d.textContent=`Match ${t+1}`;let _=document.createElement("span");_.className="sc-dup-row-hint",_.textContent="Side-by-side preview",l.appendChild(d),l.appendChild(_);let u=dP({score:e?.score});c.appendChild(l),c.appendChild(u);let p=document.createElement("div");p.className="sc-dup-grid";let f=Bx({plugin:s,label:"Source",block:e?.source_block,open_label:"Open source",primary_action:!1,cache:n,read_scheduler:i,disposers:r}),y=Bx({plugin:s,label:"Duplicate",block:e?.target_block,open_label:"Open duplicate",primary_action:!0,cache:n,read_scheduler:i,disposers:r});return p.appendChild(f),p.appendChild(y),a.appendChild(c),a.appendChild(p),a}o(oP,"build_result_row");function Bx({plugin:s,label:e,block:t,open_label:n,primary_action:i,cache:r,read_scheduler:a,disposers:c}){let l=document.createElement("div");l.className="sc-dup-col";let d=document.createElement("div");d.className="sc-dup-col-header";let _=document.createElement("div");_.className="sc-dup-col-top";let u=document.createElement("div");u.className="sc-dup-col-title",u.textContent=String(e||"Block");let p=pP({block:t}),f=document.createElement("span");f.className="sc-dup-lines",f.textContent=p||"",p||f.classList.add("is-hidden"),_.appendChild(u),_.appendChild(f);let y=document.createElement("div");y.className="sc-dup-block-meta sc-dup-clickable",y.textContent=hP({block:t}),y.title=y.textContent,y.tabIndex=0,d.appendChild(_),d.appendChild(y);let g=document.createElement("pre");g.className="sc-dup-body is-loading",g.textContent="Loading...",g.tabIndex=0;let k=document.createElement("div");k.className="sc-dup-actions";let v=document.createElement("button");v.className="sc-dup-btn is-ghost",v.type="button",v.textContent="Copy",v.disabled=!0;let b=document.createElement("button");b.className=i?"sc-dup-btn is-primary":"sc-dup-btn is-ghost",b.type="button",b.textContent=String(n||"Open"),k.appendChild(v),k.appendChild(b),l.appendChild(d),l.appendChild(g),l.appendChild(k);let A=o(()=>{let m=t?.path||t?.key;if(!m||!s){new Ns.Notice("Unable to open block.");return}Px(s,m)},"open_block"),S=o(m=>{m.preventDefault(),m.stopPropagation(),A()},"on_meta_click"),$=o(m=>{m.key==="Enter"&&(m.preventDefault(),A())},"on_meta_keydown");y.addEventListener("click",S),y.addEventListener("keydown",$),c.push(()=>y.removeEventListener("click",S)),c.push(()=>y.removeEventListener("keydown",$));let j=o(m=>{m.target?.closest?.("button")||A()},"on_body_dblclick");g.addEventListener("dblclick",j),c.push(()=>g.removeEventListener("dblclick",j));let C=o(m=>{m.preventDefault(),m.stopPropagation(),A()},"on_open_click");b.addEventListener("click",C),c.push(()=>b.removeEventListener("click",C));let x=o(async m=>{m.preventDefault(),m.stopPropagation(),await uP({block:t,cache:r})},"on_copy_click");return v.addEventListener("click",x),c.push(()=>v.removeEventListener("click",x)),a.enqueue(async()=>{let m=await Gx({block:t,cache:r});if(!g.isConnected)return;let h=String(m||"").trim();g.textContent=h||"No content available.",g.classList.remove("is-loading"),v.disabled=!h}),l}o(Bx,"build_block_column");function rP({container:s}){return s._sc_dup_cache instanceof Map||(s._sc_dup_cache=new Map),s._sc_dup_cache}o(rP,"ensure_cache");function aP({container:s}){return s._sc_dup_read_scheduler||(s._sc_dup_read_scheduler=cP({max_concurrent:eP})),s._sc_dup_read_scheduler}o(aP,"ensure_read_scheduler");function cP(s={}){let e=Number.isFinite(s.max_concurrent)?s.max_concurrent:2,t=0,n=[],i=o(()=>{if(t>=e||!n.length)return;let a=n.shift();a&&(t+=1,Promise.resolve().then(a.job).then(a.resolve,a.reject).finally(()=>{t-=1,i()}))},"run_next");return{enqueue:o(a=>new Promise((c,l)=>{n.push({job:a,resolve:c,reject:l}),i()}),"enqueue")}}o(cP,"create_scheduler");function lP({scope:s,params:e}){return(e?.plugin??s??null)||null}o(lP,"resolve_plugin");function Ux({label:s,value:e}){let t=document.createElement("span");t.className="sc-dup-chip";let n=document.createElement("span");n.textContent=String(s??"");let i=document.createElement("strong");return i.textContent=String(e??""),t.appendChild(n),t.appendChild(i),t}o(Ux,"build_meta_chip");function dP({score:s}){let e=document.createElement("span");e.className=`sc-dup-score-chip ${Rx(s)}`;let t=document.createElement("span");t.className="sc-dup-score-label",t.textContent="Similarity";let n=document.createElement("span");return n.className="sc-dup-score-value",n.textContent=Hp(s),e.title=Number.isFinite(s)?`Similarity: ${Jp(s)} (${Hp(s)})`:"Similarity: n/a",e.appendChild(t),e.appendChild(n),e}o(dP,"build_score_chip");function _P({root:s,value:e}){let t=Array.from(s.querySelectorAll("button.sc-dup-preset-btn"));t.forEach(i=>i.classList.remove("is-active"));let n=t.find(i=>Number(i.dataset.value)===e);n&&n.classList.add("is-active")}o(_P,"highlight_preset");async function Gx({block:s,cache:e}){if(!s)return"";let t=Fx(s);if(!t)return await s.read?.();if(e.has(t))return e.get(t);let n=await s.read?.();return e.set(t,n),n}o(Gx,"get_block_content_cached");async function uP({block:s,cache:e}){if(!s){new Ns.Notice("Unable to copy block.");return}try{let t=await Gx({block:s,cache:e}),n=String(t||"").trim();if(!n){new Ns.Notice("No content to copy.");return}if(!await mP({text:n})){new Ns.Notice("Unable to copy to clipboard.");return}new Ns.Notice("Copied.")}catch(t){console.warn("[Smart Connections] Failed to copy block content",t),new Ns.Notice("Unable to copy to clipboard.")}}o(uP,"copy_block_content");async function mP({text:s}){let e=String(s??"");if(!e)return!1;try{if(globalThis.navigator?.clipboard?.writeText)return await globalThis.navigator.clipboard.writeText(e),!0}catch{}try{let t=document.createElement("textarea");t.value=e,t.setAttribute("readonly","true"),t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",document.body.appendChild(t),t.select();let n=!!document.execCommand?.("copy");return t.remove(),n}catch{return!1}}o(mP,"copy_text_to_clipboard");function pP({block:s}){let e=Number.isFinite(s?.line_start)?Number(s.line_start):null,t=Number.isFinite(s?.line_end)?Number(s.line_end):null;return e&&t&&t>=e?`Lines ${e}-${t}`:e?`Line ${e}`:""}o(pP,"get_block_line_hint");function hP({block:s}){return s?typeof s.get_display_name=="function"?s.get_display_name():s?.path||s?.key||"Unknown block":"Unknown block"}o(hP,"get_block_label");var Hx="Duplicate blocks modal";var Jx=`.sc-inline-pop {\r
position: absolute;\r
z-index: var(--layer-popover);\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
border-radius: var(--radius-m);\r
box-shadow: var(--shadow-s);\r
max-width: 340px;\r
font-size: 0.875rem;\r
overflow-y: auto;\r
}\r
\r
.sc-inline-pop .sc-inline-header {\r
font-weight: bold;\r
border-bottom: 1px solid var(--background-modifier-border);\r
display: flex;\r
justify-content: space-between;\r
align-items: center;\r
padding: 0.5rem 0.77rem;\r
}\r
\r
.sc-inline-pop .sc-inline-items {\r
display: flex;\r
flex-direction: column;\r
}\r
\r
.sc-inline-pop .sc-inline-item:hover {\r
background-color: var(--background-primary);\r
}\r
\r
.sc-inline-pop .sc-inline-item {\r
display: flex;\r
justify-content: space-between;\r
align-items: center;\r
gap: 0.5rem;\r
cursor: pointer;\r
padding: 0.5rem 0.77rem;\r
}`;var Vn=require("obsidian");function Vx(s,e,t,n,i={}){let r=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(Vn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(n),l=await c?.read();if(l){let d=new Vn.HoverPopover(s,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");Vn.MarkdownRenderer.render(r,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}o(Vx,"register_block_hover_popover");var Kx=require("obsidian");function Il(s,e,t={}){let n=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?s.addEventListener("mouseover",i=>{let r=e.key.replace(/#$/,"");if(n.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:s.parentElement,targetEl:s,linktext:r}),Kx.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):Vx(s.parentElement,s,e.env,e.key)}o(Il,"register_item_hover_popover");function Yx(s){if(!s)return"";let[e,...t]=s.split("#"),n=e.split("/").pop().replace(/\.md$/,"");if(!t.length)return`[[${n}]]`;let i=t.filter(r=>!r.startsWith("{")).pop();return i?`[[${n}#${i}]]`:`[[${n}]]`}o(Yx,"parse_item_key_to_wikilink");function gP(s,e,t,n){let i=s.dragManager,r=Yx(e.key),a=i.dragLink(n,r);i.onDragStart(n,a),t.drag_event_key?e.emit_event(t.drag_event_key):e.emit_event("connections:drag_result")}o(gP,"handle_connection_drag");function Xx(s,e,t={}){let i=e.env.obsidian_app;s.setAttribute("draggable","true"),s.addEventListener("dragstart",gP.bind(null,i,e,t))}o(Xx,"register_item_drag");var Vp=require("obsidian");async function Ll(s,e=null){try{let n=s.env.obsidian_app,i=s.key;i.endsWith("#")&&(i=i.slice(0,-1));let r;if(i.includes("#")){let[c]=i.split("#");r=n.metadataCache.getFirstLinkpathDest(c,"")}else r=n.metadataCache.getFirstLinkpathDest(i,"");if(!r){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=Vp.Keymap.isModEvent(e),l=Vp.Keymap.isModifier(e,"Alt");c&&l?a=n.workspace.splitActiveLeaf("vertical"):c?a=n.workspace.getLeaf(!0):a=n.workspace.getMostRecentLeaf()}else a=n.workspace.getMostRecentLeaf();if(await a.openFile(r),typeof s?.line_start=="number"){let{editor:c}=a.view,l={line:s.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}s.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),s.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}o(Ll,"open_source");function yP(s,e={}){return`<div>
<div class="sc-inline-pop">
<div class="sc-inline-header">
<span class="sc-inline-title">Connections</span>
<span>Lines ${s.block.line_start}\u2013${s.block.line_end}</span>
</div>
<div class="sc-inline-items">Loading...</div>
</div>
</div>`}o(yP,"build_html");async function Zx(s,e={}){this.apply_style_sheet(Jx);let t=yP.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".sc-inline-pop");return bP.call(this,s,i,e),i}o(Zx,"render");async function bP(s,e,t={}){let n=s.env?.connections_lists,i=n?.settings,r=i?.inline_connections_score_threshold?parseFloat(i.inline_connections_score_threshold):.8,a=Array.isArray(t.precomputed_items)?t.precomputed_items.slice(0,10):null;a||(a=s.connections_list.filter_and_score({limit:10,score_algo_key:n.score_algo_key,results_collection_key:n.results_collection_key,to_item:s.block,filter:{exclude_keys:[s.block.source_key],exclude_key_starts_with_any:[s.block.source_key]}})),a=a.filter(d=>d.score>=r);let c=e.querySelector(".sc-inline-items");if(!c)return;if(!a.length){c.textContent="No connections found above threshold "+r;return}this.empty(c),a.forEach(d=>{let _=document.createElement("div");_.className="sc-inline-item";let u=document.createElement("span");u.textContent=d.item.name??d.item.path.split("/").pop(),_.appendChild(u);let p=document.createElement("span");p.textContent=d.score.toFixed(2),_.appendChild(p),c.appendChild(_),Il(_,d.item),_.addEventListener("click",f=>{Ll(d.item,f),d.item.emit_event("inline_connections:open_result",{event_source:"inline-connections-popover"})}),Xx(_,d.item,{drag_event_key:"inline_connections:drag_result"})}),e.querySelector(".sc-inline-header")?.addEventListener("click",()=>{s.plugin.connections_view_early?.container?.isShown?.()?s.block.emit_event("connections:show"):(s.plugin.open_connections_view(),setTimeout(()=>{s.block.emit_event("connections:show")},300))}),s.connections_list.emit_event("inline_connections:show")}o(bP,"post_process");function Qx(s,e=0){let t=s.length&3,n=s.length-t,i=e,r=3432918353,a=461845907,c=0,l=0,d=0;for(;c<n;)d=s.charCodeAt(c)&255|(s.charCodeAt(c+1)&255)<<8|(s.charCodeAt(c+2)&255)<<16|(s.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Kn(l,r),l=Kp(l,15),l=Kn(l,a),i^=l,i=Kp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(s.charCodeAt(c+2)&255)<<16;case 2:l^=(s.charCodeAt(c+1)&255)<<8;case 1:l^=s.charCodeAt(c)&255,l=Kn(l,r),l=Kp(l,15),l=Kn(l,a),i^=l;break}return i^=s.length,i=vP(i),i|0}o(Qx,"murmur_hash_32");function Ml(s,e=0){return(Qx(s,e)>>>0).toString(36)}o(Ml,"murmur_hash_32_alphanumeric");function Kn(s,e){return(s&65535)*e+((s>>>16)*e<<16)|0}o(Kn,"multiply_32");function Kp(s,e){return s<<e|s>>>32-e}o(Kp,"rotate_left_32");function vP(s){return s^=s>>>16,s=Kn(s,2246822507),s^=s>>>13,s=Kn(s,3266489909),s^=s>>>16,s|0}o(vP,"fmix_32");function Yp(s){let e=Date.now(),t=s<1e12?s*1e3:s,n=e-t,i=n<0,r=Math.floor(Math.abs(n)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(r/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}o(Yp,"convert_to_time_ago");var wP=`What is the most relevant to the following? Today is {{DATE}}.
{{CURRENT}}`;async function Zp(s,e={}){if(!s.length)return console.warn("No results to rank"),s;if(!this.collection.rank_model)throw new Error("[rank_connections] Rank model not available.");let{rank_query:t=this.data.rank_query||this.settings.rank_query||wP}=e;console.log("rank model loaded");let n=new Date().toLocaleDateString(),i=t.replace("{{DATE}}",n).replace("{{CURRENT}}",(await this.item.get_embed_input()).slice(0,500)),r=await Promise.all(s.map(async l=>{let d=`mtime: ${new Date(l.item.mtime).toLocaleDateString()}
`;return d+=await l.item.get_embed_input(),d.slice(0,500)})),a=await this.collection.rank_model.rank(i,r);if(console.log("Ranked results:",a),!Array.isArray(a)||!a.length)return console.warn("Ranking failed, received:",a),s;let c=Math.max(...a.map(l=>l.score));return a.map(({index:l,score:d})=>{let _=this.settings.actions?.connections_list_post_process_rank_connections?.show_og_score?`${d.toFixed(2)} (${s[l].score.toFixed(2)})`:d.toFixed(2);return{...s[l],score:_,og_score:s[l].score}}).sort((l,d)=>d.score-l.score)}o(Zp,"rank_connections");Zp.action_type="connections_post_process";var Qp="Re-ranking model",eh="Uses re-ranking model to adjust the order of connection results.";function e0(s){return{connections_post_process_description:{group:"Ranking algorithm",type:"html",name:`${Qp} algorithm`,value:[`${eh}`,"<p><i>Configure the default ranking model in the Smart Environment Pro settings.</i></p>"].join(`
`)},show_og_score:{group:"Ranking algorithm",type:"toggle",name:"Show original connection score",description:"Display the original connection score alongside the re-ranked score."}}}o(e0,"settings_config");function th(s,e={}){return!Array.isArray(s)||s.length===0?s:s.map(n=>{let i=xP(n),r=i?Yp(i):"no mtime";return{...n,og_score:n.og_score??n.score,_recency_mtime:i,score:n.score.toFixed(2)+` (${r})`}}).sort((n,i)=>i._recency_mtime-n._recency_mtime).map(({_recency_mtime:n,...i})=>i)}o(th,"recency_rank");function xP(s){let e=s?.item?.mtime;return e instanceof Date?e.getTime():typeof e=="number"?e:0}o(xP,"get_mtime_value");th.action_type="connections_post_process";var sh="Recency rank",nh="Ranks connections by most recently modified items.";function t0(s){return{connections_post_process_description:{group:"Ranking algorithm",type:"html",name:`${sh} algorithm`,value:[`${nh}`].join(`
`)}}}o(t0,"settings_config");function ih(s={}){if(!this.vec)return{score:null,error:`Missing this.vec for ${this.key}`};if(!s.to_item?.vec)return{score:null,error:"Missing params.to_item.vec"};let e=ae(this.vec,s.to_item.vec),n=(Array.isArray(s.hidden)?s.hidden:[]).reduce((r,a)=>{if(!a?.vec)return r;let c=ae(a.vec,this.vec);return c>r?c:r},0);return{score:e-n,base_score:e}}o(ih,"sim_feedback_adjusted");ih.action_type="score";var oh="Similarity Adjusted by Feedback",rh="Penalizes candidates similar to hidden notes before ranking.",s0={score_algo_description:{group:"Score algorithm",type:"html",name:`${oh} algorithm`,value:`${rh}`}};var EP=.25,AP=.5;function SP(s){return Number.isNaN(s)||s<0?0:s>1?1:s}o(SP,"clamp_score");function n0(s,e){return!Array.isArray(s)||!s.length?0:s.reduce((t,n)=>{if(!n?.vec)return t;let i=ae(e,n.vec);return i>t?i:t},0)}o(n0,"max_similarity");function ah(s={}){if(!this.vec)return{score:null,error:`Missing this.vec for ${this.key}`};if(!s.to_item?.vec)return{score:null,error:"Missing params.to_item.vec"};let e=this.vec,t=ae(e,s.to_item.vec),n=n0(s.pinned,e),i=n0(s.hidden,e),r=t+n*EP-i*AP;return{score:SP(r),base_score:t,pinned_boost:n,hidden_penalty:i}}o(ah,"sim_feedback_weighted");ah.action_type="score";var ch="Similarity Weighted by Feedback",lh="Boosts candidates similar to pinned notes while damping those that resemble hidden notes.",i0={score_algo_description:{group:"Score algorithm",type:"html",name:`${ch} algorithm`,value:`${lh}`}};var o0={collections:{connections_lists:rx,lookup_lists:px},item_types:{ConnectionsList:qe},items:{connections_list:{class:qe}},modules:{},components:{connections_footer_view:{render:hx},connections_graph_v1:{render:Ox},connections_list_v4:{render:$x,display_name:jx},connections_web:{render:Nx},duplicate_blocks_modal_v1:{render:Wx,display_name:Hx},inline_connections_popover:{render:Zx}},actions:{connections_list_post_process_rank_connections:{action:Zp,settings_config:e0,display_name:Qp,display_description:eh},connections_list_post_process_recency_rank:{action:th,settings_config:t0,display_name:sh,display_description:nh},sim_feedback_adjusted:{action:ih,settings_config:s0,display_name:oh,display_description:rh},sim_feedback_weighted:{action:ah,settings_config:i0,display_name:ch,display_description:lh}}};var R1=require("obsidian");var zl=class{static{o(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var Dl=class extends zl{static{o(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let n=e==="*"?"*":e,i=this.handlers[n]||(this.handlers[n]=[]),r={id:this._next_id++,cb:t};return i.push(r),()=>this.off_entry(n,r.id)}once(e,t=()=>{}){let n=e==="*"?"*":e,i=this.handlers[n]||(this.handlers[n]=[]),r={id:this._next_id++,cb:null},a=o((c,l)=>{this.off_entry(n,r.id),t(c,l)},"wrapper");return r.cb=a,i.push(r),()=>this.off_entry(n,r.id)}off(e,t){let n=this.handlers[e];if(!(!n||!t)){for(let i=n.length-1;i>=0;i--)if(n[i].cb===t){n.splice(i,1);break}}}off_entry(e,t){let n=this.handlers[e];if(!n)return;let i=n.findIndex(r=>r.id===t);i!==-1&&n.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let n=this.handlers[e],i=this.handlers["*"];if(!n&&!i)return;let r=n?[...n]:[],a=i?[...i]:[];for(let c=0;c<r.length;c++)r[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Yn=class s{static{o(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let n=new s(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:o(()=>n,"get")}),n}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new Dl(this)),this._adapter}on(e,t=n=>{}){return this.adapter.on(e,t)}once(e,t=n=>{}){return this.adapter.once(e,t)}off(e,t=n=>{}){return this.adapter.off(e,t)}emit(e,t={}){let n={...t};return n.at===void 0&&(n.at=Date.now()),Object.freeze(n),this.adapter.emit(e,n)}};function Rl(s,e){let t=r0(s),n=r0(e),i=Math.max(t.parts.length,n.parts.length);for(let r=0;r<i;r++){let a=t.parts[r]!==void 0?t.parts[r]:0,c=n.parts[r]!==void 0?n.parts[r]:0;if(a>c)return 1;if(a<c)return-1}return t.type===n.type?0:t.type==="semver"&&n.type!=="semver"?1:n.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&n.type==="none"?t.parts[0]===0?0:1:n.type==="number"&&t.type==="none"?n.parts[0]===0?0:-1:0}o(Rl,"compare_versions");function r0(s){if(s==null)return{type:"none",parts:[0,0,0]};if(typeof s=="number"){if(!Number.isFinite(s))return{type:"none",parts:[0,0,0]};let e=Math.floor(s),t=Math.floor((s-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof s=="string"){let e=s.trim();if(!e)return{type:"none",parts:[0,0,0]};let n=e.split(".").map(i=>{let r=i.match(/^\d+/);if(!r)return 0;let a=Number.parseInt(r[0],10);return Number.isNaN(a)?0:a});for(;n.length<3;)n.push(0);return{type:"semver",parts:n}}return{type:"none",parts:[0,0,0]}}o(r0,"normalize_version_value");function Zo(s){return s===null||typeof s!="object"||Array.isArray(s)||s instanceof Function||s instanceof Date?!1:Object.getPrototypeOf(s)===Object.prototype}o(Zo,"is_plain_object");function Ps(s,e,t=[]){if(!Zo(s)||!Zo(e)||t.includes(e))return s;t.push(e);for(let n of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,n))continue;let i=e[n];if(Array.isArray(s[n])&&Array.isArray(i))for(let r of i)if(typeof r=="function"){let a=r.name;s[n].some(l=>typeof l=="function"&&l.name===a)||s[n].push(r)}else(r===null||["string","number","boolean","undefined"].includes(typeof r))&&s[n].includes(r)||s[n].push(r);else Zo(i)?(Zo(s[n])||(s[n]={}),Ps(s[n],i,[...t])):Object.prototype.hasOwnProperty.call(s,n)||(s[n]=i)}return s}o(Ps,"deep_merge_no_overwrite");function qt(s,e){let t=s.version,n=e.version;for(let[i,r]of Object.entries(e)){if(i==="collections"&&r&&typeof r=="object"){s.collections||(s.collections={});for(let[a,c]of Object.entries(r)){let l=s.collections[a];if(!l){s.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(Rl(d,_)>0){let p={...c};Ps(p,l),s.collections[a]=p}else Ps(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&r&&typeof r=="object"){s[i]||(s[i]={});for(let[a,c]of Object.entries(r)){if(!s[i][a]){s[i][a]={...c};continue}let l=s[i][a],d=c&&c.version,_=l&&l.version;Rl(d,_)>0?(s[i][a]=c,s[i][a].version=d||-1):Ps(l,c)}continue}Array.isArray(r)?Array.isArray(s[i])?r.length>0&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="boolean")?s[i]=Array.from(new Set([...s[i],...r])):s[i]=[...s[i],...r]:r.length>0&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="boolean")?s[i]=Array.from(new Set(r)):s[i]=[...r]:r&&typeof r=="object"?(s[i]||(s[i]={}),Ps(s[i],r)):s[i]=r}return s}o(qt,"merge_env_config");var mce=typeof globalThis<"u"?globalThis:Function("return this")();function OP(s,{case_sensitive:e,extended_glob:t,windows_paths:n}){let i=$P(s,t),r=qP(i,n),a=e?"":"i";return new RegExp(`^${r}$`,a)}o(OP,"create_regex");function qP(s,e){return e?s.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):s}o(qP,"adjust_for_windows_paths");function $P(s,e){let t=!1,n=0,i="";for(let r=0;r<s.length;r++){let a=s[r];switch(a){case"\\":r+1<s.length?(i+=`\\${s[r+1]}`,r++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||s.indexOf("]",r+1)===-1?i+="\\[":(t=!0,s[r+1]==="!"?(i+="[^",r++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||s.indexOf("}",r+1)===-1?i+="\\{":(n++,i+="(");break;case"}":!t&&n>0?(n--,i+=")"):i+="\\}";break;case",":!t&&n>0?i+="|":i+=",";break;case"*":t?i+="\\*":r+1<s.length&&s[r+1]==="*"?(i+=".*",r++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}o($P,"glob_to_regex_pattern");function a0(s,e={}){let n={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return s===""?/^$/:s==="*"&&!n.windows_paths?/^[^/]+$/:s==="**"&&!n.windows_paths?/^.+$/:OP(s,n)}o(a0,"glob_to_regex");function c0(s,e){let t=[];for(let n=0;n<s.length;n++){let i=e.toLowerCase().split(""),r=!0,a=0,c=s[n],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{r=!1;break}}r&&t.push({name:c,distance:a})}return t.sort((n,i)=>n.distance-i.distance),t.map(n=>n.name)}o(c0,"fuzzy_search");var Fl=class{static{o(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(n=>this.add_ignore_pattern(n)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(a0(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...n){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...n);return this.post_process(i)}use_adapter_sync(e,t,...n){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...n);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(n){return console.warn("Error during read: "+n.message,e),n.code==="ENOENT"?null:{error:n.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(n){throw console.error("Error during write:",n),n}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let n=this.file_paths.filter(i=>i.includes(e));return c0(n,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var jP=Y(require("obsidian"),1);var Bl=class{static{o(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=jP,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:o(()=>{let n=this.obsidian_app.vault.getAbstractFileByPath(e);return n?{ctime:n.stat.ctime,mtime:n.stat.mtime,size:n.stat.size,isDirectory:o(()=>n instanceof this.obsidian.TFolder,"isDirectory"),isFile:o(()=>n instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let r=i.path.lastIndexOf("/");return!(r===-1&&e!==""||i.path.slice(0,r)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,n={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!n.no_cache){let r=this.obsidian_app.vault.getFileByPath(e);if(r)return await this.obsidian_app.vault.cachedRead(r)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let r=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(r)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let n=e.split("/").slice(0,-1).join("/");return await this.exists(n)||(await this.mkdir(n),console.log(`Created folder: ${n}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:n}=t,i=o((r,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(r,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(n.vault.on("create",r=>{i("sources:created",{path:r.path,event_source:"obsidian:vault.create"})})),t.registerEvent(n.vault.on("modify",r=>{i("sources:modified",{path:r.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(n.vault.on("rename",(r,a)=>{i("sources:renamed",{path:r.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(n.vault.on("delete",r=>{i("sources:deleted",{path:r.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(n.workspace.on("editor-change",(r,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function Ul(s){let e=document.createRange();e.selectNodeContents(s),e.deleteContents()}o(Ul,"empty");var l0=(()=>{let s=new Map;return(e,t)=>{let n=t.trim(),i=s.get(n);i||(i=document.createElement("template"),i.innerHTML=n,s.set(n,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var d0=o((s,e)=>{let n=document.createRange().createContextualFragment(e.trim());s.replaceChildren(n)},"replace_with_fragment");var TP=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,Wl=o((s,e)=>{let t=e.trim();(TP.test(t)?d0:l0)(s,t)},"safe_inner_html");function Je(s=""){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}o(Je,"escape_html");function dh(s){let e=Date.now(),t=s<1e12?s*1e3:s,n=e-t,i=n<0,r=Math.floor(Math.abs(n)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(r/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}o(dh,"convert_to_time_ago");function Is(s=[],e=[]){if(s.length!==e.length)throw new Error("Vectors must have the same length");let t=0,n=0,i=0,r=1e-8;for(let a=0;a<s.length;a++)t+=s[a]*e[a],n+=s[a]*s[a],i+=e[a]*e[a];return n=Math.sqrt(n),i=Math.sqrt(i),n<r||i<r?0:t/(n*i)}o(Is,"cos_sim");function $e(s,e,t=null){if(!e)return"";let n=e.split(".");t&&n.unshift(t);let i=n.pop(),r=n.reduce((a,c)=>a&&a[c],s);return r&&typeof r[i]=="function"?r[i].bind(r):r?r[i]:void 0}o($e,"get_by_path");function je(s,e,t,n=null){let i=e.split(".");n&&i.unshift(n);let r=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),s);a[r]=t}o(je,"set_by_path");function _h(s,e,t=null){let n=e.split(".");t&&n.unshift(t);let i=n.pop(),r=n.reduce((a,c)=>a&&a[c],s);r&&delete r[i]}o(_h,"delete_by_path");function uh(s){if(!s||s.length===0)return null;let e=s.length,t=s[0].length,n=new Float64Array(t);for(let i=0;i<e;i++){let r=s[i];for(let a=0;a<t;a++)n[a]+=r[a]}for(let i=0;i<t;i++)n[i]/=e;return Array.from(n)}o(uh,"compute_centroid");function mh(s){if(!s||s.length===0)return null;if(s.length===1)return s[0];let e=s.length,t=s[0].length,n=new Float64Array(e);for(let a=0;a<e-1;a++){let c=s[a];for(let l=a+1;l<e;l++){let d=s[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);n[a]+=u,n[l]+=u}}let i=0,r=n[0];for(let a=1;a<e;a++)n[a]<r&&(r=n[a],i=a);return s[i]}o(mh,"compute_medoid");var NP=o(s=>typeof s!="string"?null:`style-sheet-${re(s)}`,"get_style_sheet_id"),Gl=new WeakMap,Hl=new WeakMap,Jl=class{static{o(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let n=e.querySelectorAll(".setting-component"),i=[];for(let r of n)i.push(this.render_setting_component(r,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,n=null){return $e(e,t,n)}set_by_path(e,t,n,i=null){je(e,t,n,i)}delete_by_path(e,t,n=null){_h(e,t,n)}escape_html(e){return Je(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([n,i])=>n.includes("class")?"":typeof i=="number"?`data-${n.replace(/_/g,"-")}=${i}`:`data-${n.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),r=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(r,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let r=i.dataset.smartSetting;if(!r||Hl.has(i))return;let a=o(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,r,c)},"handler");Hl.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=Hl.get(i);c&&(i.removeEventListener("change",c),Hl.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=NP(e);if(!t||document.getElementById(t))return;let n=document.createElement("style");n.id=t,n.textContent=e,document.head.appendChild(n);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(n=>n.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){Ul(e)}safe_inner_html(e,t){Wl(e,t)}attach_disposer(e,t){if(!e)return;let n=e.ownerDocument,i=n&&n.defaultView,r=i&&i.MutationObserver;if(!n||!i||!r||!n.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=Gl.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},Gl.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new r(()=>{if(n.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}Gl.get(e)===c&&Gl.delete(e)}}});c.observer=l,l.observe(n.body,{childList:!0,subtree:!0})}}};var Vl=class{static{o(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,n,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,n,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,n){}post_change(e,t,n){}revert_setting(e,t,n){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let n=e.dataset.setting,i=t.scope||this.main.main,r=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,n,r);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,n,a,r));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,n,a,i,r);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,n,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:n,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,n,i,r){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===n,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(n)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===n,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(n)),l.onChange(_=>{this.handle_on_change(t,_,e,i,r)})}),a}render_text_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,r),2e3)})}),a}render_password_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_number_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof n<"u"&&(c.inputEl.value=parseInt(n)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,r),2e3)})}),a}render_toggle_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addToggle(c=>{let l=n??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,r))}),a}render_textarea_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(n||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_textarea_array_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(n)?n.join(`
`):n||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_button_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,n,e,i,r)}})}),a}render_remove_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,r),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,n,e,i,r)}})}),a}render_folder_select_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,n,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,r)})}),a}render_file_select_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,n,e,i,r)})}),a}render_slider_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof n<"u"?parseFloat(n):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,r)})}),a}render_html_component(e,t,n,i){return this.safe_inner_html(e,n),e}render_array_component(e,t,n,i,r){let a=new this.setting_class(e),c=Array.isArray(n)?[...n]:[],l=document.createElement("div");l.className="array-items-container";let d=o(()=>{l.innerHTML="",c.forEach((y,g)=>{let k=document.createElement("div");k.className="array-item-row";let v=document.createElement("input");v.type="text",v.value=y,v.placeholder="Value";let b=document.createElement("button");b.textContent="\u2715",b.title="Remove",v.addEventListener("change",()=>{c[g]=v.value,f()}),b.addEventListener("click",()=>{c.splice(g,1),d(),f()}),k.appendChild(v),k.appendChild(b),l.appendChild(k)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=u.value.trim();y&&(c.push(y),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=o(()=>{this.handle_on_change(t,[...c],e,i,r)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,n,i,r){try{let a=new this.setting_class(e),c=typeof n=="object"&&n!==null?{...n}:{},l=document.createElement("div");l.className="json-pairs-container";let d=o(()=>{l.innerHTML="",Object.entries(c).forEach(([g,k],v)=>{let b=document.createElement("div");b.className="json-pair-row";let A=document.createElement("input");A.type="text",A.value=g,A.placeholder="Property";let S=document.createElement("input");S.type="text",S.value=k,S.placeholder="Value";let $=document.createElement("button");$.textContent="\u2715",$.title="Remove",A.addEventListener("change",()=>{let j=A.value.trim();j&&j!==g&&(c[j]=c[g],delete c[g],d(),y())}),S.addEventListener("change",()=>{c[A.value]=S.value,y()}),$.addEventListener("click",()=>{delete c[A.value],d(),y()}),b.appendChild(A),b.appendChild(S),b.appendChild($),l.appendChild(b)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),y())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=o(()=>{this.handle_on_change(t,{...c},e,i,r)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,n,i){t.dataset.btn&&e.addButton(r=>{r.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&r.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](n,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(n,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(r.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[n,i])=>{if(!n.startsWith("option"))return t;let[r,a]=i.split("|");return t.push({value:r,name:a||r}),t},[])}handle_on_change(e,t,n,i,r){if(this.pre_change(e,t,n,i),n.dataset.validate&&!this[n.dataset.validate](e,t,n,i)){n.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,n,i);return}if(this.main.set_by_path(i.settings,e,t,r),n.dataset.callback){let a=this.main.get_by_path(i,n.dataset.callback);a&&a(e,t,n,i)}this.post_change(e,t,n,i)}render_button_with_confirm_component(e,t,n,i){let r=new this.setting_class(e);return r.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,n,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),r}empty(e){Ul(e)}safe_inner_html(e,t){Wl(e,t)}};var lt=require("obsidian");var Kl=class extends Vl{static{o(this,"SmartViewObsidianAdapter")}get setting_class(){return lt.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,n){return super.render_text_component(e,t,n)}async render_markdown(e,t){let n=t.env.smart_connections_plugin?.connections_view||new lt.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),r=i.querySelector(".inner");try{await lt.MarkdownRenderer.render(t.env.plugin.app,e,r,t?.file_path||"",n)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,lt.getIcon)(e).outerHTML}is_mod_event(e){return lt.Keymap.isModEvent(e)}render_folder_select_component(e,t,n,i,r){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,r)}),l.setValue(n)}),a}};var Yl=class{static{o(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},Xl=class{static{o(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};var Zl=class extends Yl{static{o(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:n=50}=t,i=this.collection.filter(t).reduce((r,a)=>{if(!a.vec)return r;let c={item:a,score:Is(e,a.vec)};return $l(r,c,n),r},{min:0,results:new Set});return Array.from(i.results).sort(jl)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:n=50}=t,i=this.collection.filter(t).reduce((r,a)=>{if(!a.vec)return r;let c={item:a,score:Is(e,a.vec)};return _x(r,c,n),r},{max:0,results:new Set});return Array.from(i.results).sort(ux)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(n=>n.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((n,i)=>{let r=e[i];r.vec=n.vec,r.data.last_embed=r.data.last_read,n.tokens!==void 0&&(r.tokens=n.tokens),r.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(n=>setTimeout(n,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let n=0;n<t.length;n+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(n,n+this.collection.embed_model.batch_size);await Promise.all(i.map(r=>r.get_embed_input()));try{let r=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-r}catch(r){r&&r.message&&r.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(r),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(r||{},null,2))}i.forEach(r=>{r.embed_hash=r.read_hash,r._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((r,a)=>r+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},Ql=class extends Xl{static{o(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var PP="---frontmatter---",_0=o(s=>Array.isArray(s)?s.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof s=="string"?(s.includes(",")?s.split(","):[s]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),IP=o((s,e={})=>({...s.env.settings.smart_view_filter||{},...e,entity:s}),"merge_settings_with_params"),LP=o(s=>{let e={...s};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),MP=o(s=>{if(!s.exclude_frontmatter_blocks)return s;let e={...s},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(PP),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),zP=o((s,e)=>{if(!e)return s;let t={...s},n=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(n.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&n.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(n=[...n,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(n=[...n,...e.outlinks.map(r=>r.key)]),n.length&&(t.exclude_key_starts_with_any=n),t.exclude_filter){let r=_0(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...r]}if(t.include_filter){let r=_0(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...r]}return t},"append_entity_filters"),ph=o((s,e={})=>{let t=IP(s,e),n=LP(t),i=MP(n);return zP(i,s)},"create_find_connections_filter_opts");async function Xn(s={}){let e=s.filter?.limit||s.limit||this.env.settings.smart_view_filter?.results_limit||10,t=ph(this,s);s.filter?.limit&&delete s.filter.limit,s.limit&&delete s.limit;let n=this.key+re(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[n]){let i=(await this.nearest(t)).sort(He).slice(0,e);this.connections_to_cache(n,i)}return this.connections_from_cache(n)}o(Xn,"find_connections");Xn.action_type="connections";var Ls=class extends ie{static{o(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new Ql(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Ms=class extends oe{static{o(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Zl(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let n=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let r={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await n.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,r)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(He).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return u0}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let n=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(n),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return DP}},u0={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},DP={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function hh(s={}){let e=this.env.settings.smart_view_filter,t=s.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,n=s.filter?.limit||s.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await Xn.call(this,s);let r=ph(this,s);if(s.filter?.limit&&delete s.filter.limit,s.limit&&delete s.limit,!t){let a=this.key+re(JSON.stringify({...r,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,r)).sort(He).slice(0,n);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(He).slice(0,n)}return i}o(hh,"find_connections");hh.action_type="connections";var Zn=class extends Ls{static{o(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let n of t)await n(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let r=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)r[d]=""}),e=r.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),n=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(n*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[n,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let r=this.block_collection.get(this.key+n);if(r?.vec)return r}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:n="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let r=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=r.filter(_=>l.includes(_)||c.includes(_));return n==="all"?d.length===r.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(n){console.error(`Error during update for ${this.key}:`,n)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(n){console.error(`Error during merge for ${this.key}:`,n)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;if(typeof t!="string"||t.startsWith("http"))return null;let n=this.fs.get_link_target_path(t,this.file_path);return{...e,key:n,embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=uh(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=mh(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},m0={class:Zn,actions:{find_connections:hh}};var Qo=class extends Ms{static{o(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,n])=>this.env.events.on(t,n)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let n=this.init_file_path(t)||this.get(t);if(!n){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(n,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let n=this.get(t);if(n||(n=this.init_file_path(t)),!n){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(n,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),n=e.old_path||e.from;if(!t&&!n||(n&&this.items[n]&&(this.items[n]?.delete?.(),delete this.items[n],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:n}]of e){if(await n.import(),this._embed_queue||(this._embed_queue=[]),n.should_embed&&this._embed_queue.push(n),this.block_collection?.settings?.embed_blocks)for(let i of n.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let n=new this.item_type(this.env,{path:e});return this.items[e]=n,n.queue_import(),n.queue_load(),n}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let n;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;n=t.shift()}return n}build_links_map(){let e=Date.now();this.links={};for(let n of Object.values(this.items))for(let i of n.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][n.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let n=await this.create_or_update({path:e});return await n.import(),n}async search(e={}){let{keywords:t,limit:n,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let r=this.filter(i),a=[];for(let c=0;c<r.length;c+=10){let l=r.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let r=await i.lookup(e);return r.error?(console.warn(r.error),[]):r.slice(0,t)}}let n=await super.lookup(e);return n.error?(console.warn(n.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(n=[...n,...await this.block_collection.lookup(e)].sort(He)),n.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:n=!1}=e;n&&Object.values(this.items).forEach(r=>r._queue_import=!0);let i=Object.values(this.items).filter(r=>r._queue_import);if(console.log("import_queue "+i.length),i.length){let r=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-r)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((n,[i,r])=>(r.extensions?r.extensions?.forEach(a=>n[a]=r):typeof r.detect_type=="function"&&(n[i]=r),n),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(RP),...Object.entries(this.source_adapters).reduce((t,[n,i])=>{if(t[i])return t;let r=this.items[Object.keys(this.items).find(c=>c.endsWith(n))],a=new i(r||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,n)=>((n._queue_embed||n.should_embed&&n.is_unembedded)&&t.push(n),e&&n.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((n,i)=>(n[i]=this.env.fs.files[i],n),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((n,i)=>(n[i]=this.env.fs.folders[i],n),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(n=>t.endsWith(n))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},RP={};var ed=class{static{o(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=er;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},er=class{static{o(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var td=class extends ed{static{o(this,"FileCollectionDataAdapter")}ItemDataAdapter=tr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},tr=class extends er{static{o(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var p0={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Yt=class extends td{static{o(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=$t;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let n=100;for(let i=0;i<e.length;i+=n){let r=e.slice(i,i+n);await Promise.all(r.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(r=>r._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),n=50;for(let r=0;r<e.length;r+=n){let a=e.slice(r,r+n);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(r=>r.deleted);i.length&&i.forEach(r=>{delete this.collection.items[r.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,n=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${n}`)}: ${i},`}},$t=class extends tr{static{o(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:n}=this._parse(e);t&&(n.length?await this.fs.write(this.data_path,n):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let n=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",r=JSON.parse(i),a=Object.entries(r);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete r[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,r[_+":"+u]=d,delete r[l]);let f=this.env[_];if(!f)continue;let y=f.get(u);if(d.key||(d.key=u),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,k=new g(this.env,d);k._queue_load=!1,k.loaded_at=Date.now(),f.set(k)}}return(t||n>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(r).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(n=>!n.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(n=>n.endsWith(",")?n:n+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[n,...i]=e.split(":");return p0[n]&&(n=p0[n],t=!0),{collection_key:n,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let n=this.collection_adapter.collection.data_dir;return await this.fs.exists(n)||await this.fs.mkdir(n),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var sr=class extends Yt{static{o(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=fh},fh=class extends $t{static{o(this,"AjsonMultiFileSourceDataAdapter")}};var sd=class{static{o(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return re(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return h0(this.constructor.name)}static get adapter_key(){return h0(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function h0(s){return s[0].toLowerCase()+s.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}o(h0,"to_snake");function nd(s,e={}){let{start_index:t=1,line_keys:n=!1}=e,i=s.split(`
`),r=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},y=null,g=null,k=!1,v=!1,b="#",A=!1,S=[],$=null;_[b]=0;for(let C=0;C<i.length;C++){let x=C+t,m=i[C],h=m.trim();if(h==="---"){if(!v&&x===1){v=!0,k=!0,l["#---frontmatter---"]=[x,null];continue}else if(k){k=!1,l["#---frontmatter---"][1]=x;continue}}if(k)continue;if(!A&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(x)),h.startsWith("```")){if(A=!A,A&&!$?$=x:!A&&$&&(S.push([$,x]),$=null),!g){let E=c.length>0?c[c.length-1].key:b;if(E===b&&!l[b]&&(l[b]=[x,null]),E===b)g={key:b,start_line:x},(l[b][1]===null||l[b][1]<x)&&(l[b][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],N=`${E}#{${q}}`;l[N]=[x,null],g={key:N,start_line:x}}}continue}let w=h.match(/^(#{1,6})\s*(.+)$/);if(w&&!A){let E=w[1].length,q=w[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=x-1)}c.length===0&&l[b]&&l[b][1]===null&&(l[b][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let N="",L=0;if(c.length>0?(N=c[c.length-1].key,L=c[c.length-1].level):(N="",L=0),c.length===0)d[q]=(d[q]||0)+1,d[q]>1&&(q+=`[${d[q]}]`);else{u[N]||(u[N]={}),u[N][q]=(u[N][q]||0)+1;let X=u[N][q];X>1&&(q+=`#{${X}}`)}let me=E-L,ge="#".repeat(me),ye=N+ge+q;l[ye]=[x,null],_[ye]=0,c.push({level:E,title:q,key:ye});continue}let O=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(O&&!A){if(O[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null),g&&g.key!==b&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let q=c.length>0?c[c.length-1].key:b;q===b&&!l[b]&&(l[b]=[x,null]),_[q]===void 0&&(_[q]=0),_[q]+=1;let N=_[q],L;if(n){let me=O[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=FP(me,r);L=`${q}#${ge}`}else L=`${q}#{${N}}`;l[L]=[x,null],y={key:L,start_line:x};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let E=c.length>0?c[c.length-1].key:b;if(E===b)l[b]||(l[b]=[x,null]),(l[b][1]===null||l[b][1]<x)&&(l[b][1]=null),g={key:b,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],N=`${E}#{${q}}`;l[N]=[x,null],g={key:N,start_line:x}}}}let j=i.length;for(;c.length>0;){let C=c.pop();l[C.key][1]===null&&(l[C.key][1]=j+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=j+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=j+t-1),g=null),l[b]&&l[b][1]===null&&(l[b][1]=j+t-1);for(let C in l)a[C]=l[C];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:S}}o(nd,"parse_markdown_blocks");function FP(s,e=3){return s.split(/\s+/).sort((n,i)=>i.length-n.length).slice(0,e).sort((n,i)=>s.indexOf(n)-s.indexOf(i)).join(" ")}o(FP,"get_longest_words_in_order");var dt=class extends sd{static{o(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let n=e.init_file_path(t.path);n&&(n.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),n=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,n=!0)}else n=!0;return n?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:n="append_blocks"}=t,{blocks:i,task_lines:r}=nd(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);n==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let n=[],i=[],r=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){n.push({key:u,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let k=this.item.block_collection.get(u);if(await this.create_hash(p)!==k.last_read?.hash){r.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:n,new_with_parent_blocks:i,changed_blocks:r,same_blocks:a}}async append(e){let n=[await this.read(),"",e].join(`
`).trim();await this.update(n)}get size(){return this.item.file?.stat?.size||0}};function Xt(s){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,n=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=o(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),r=o(c=>c<=0?!1:s[c-1]==="!","is_embedded"),a;for(;(a=t.exec(s))!==null;){let c=a[1],l=i(a[2]),d=s.slice(0,a.index).split(`
`).length,_=r(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=n.exec(s))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=s.slice(0,a.index).split(`
`).length,u=r(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}o(Xt,"get_markdown_links");function id({source:s,links:e=[],cache:t}={}){if(!s||!Array.isArray(e)||!e.length)return[];let n=t||s?.env?.bases_caches?.items;if(!n)return[];let i=s?.key||s?.path;return i?e.flatMap(r=>{if(!r?.embedded)return[];if(typeof r.target!="string"||!r.target.includes(".base"))return[];let a=`${i}#${r.target}`,c=n?.[a]?.markdown_table;if(!c)return[];let l=Xt(c);return l.length?l.map(d=>({...d,line:r.line,bases_row:d.line-2})):[]}):[]}o(id,"get_bases_cache_links");function gh(s){let e=s.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}o(gh,"parse_value");function BP(s){let e=s.split(/\r?\n/),t={},n=0;for(;n<e.length;){let i=e[n];if(n++,!i.trim()||i.trim().startsWith("#"))continue;let r=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!r)continue;let a=r[1].trim(),c=r[2].trim();if(c===">"||c==="|"){let l=[];for(;n<e.length;){let _=e[n];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),n++}let d=l.join(`
`);t[a]=gh(d)}else if(c===""){let l=[],d=!1;for(;n<e.length;){let _=e[n];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(gh(u)),n++,d=!0}d?t[a]=l:t[a]=""}else t[a]=gh(c)}return t}o(BP,"parse_yaml_block");function f0(s){if(!s.startsWith("---"))return{frontmatter:{},body:s};let e=s.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:s};let i=e.slice(1,t).join(`
`),r=BP(i),c=e.slice(t+1).join(`
`);return{frontmatter:r,body:c}}o(f0,"parse_frontmatter");var g0=o((s="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,n;for(;(n=e.exec(s))!==null;)t.add(`#${n[1]}`);return[...t]},"get_markdown_tags");var nr=class extends dt{static{o(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:n}=this.item.file.stat;this.data.last_import={mtime:t,size:n,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let n=await this.get_metadata(e);this.data.metadata=n}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=Xt(e),n=id({source:this.item,links:t});return[...t,...n]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:n}=f0(e),i=new Set,r=t.tags;return typeof r=="string"&&(r=r.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(r)&&r.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),g0(n).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Zt=require("obsidian");function UP(s,e=[]){let t=new Set;return typeof s=="string"&&(s=s.replace(/[\[\]]/g,"").split(",").map(n=>n.trim()).filter(Boolean)),Array.isArray(s)&&s.forEach(n=>t.add(n.startsWith("#")?n:`#${n}`)),e.forEach(({tag:n})=>t.add(n)),[...t]}o(UP,"merge_tags");var zs=class extends nr{static{o(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},n=UP(t.frontmatter?.tags,t.tags);return t.frontmatter?(n.length&&(t.frontmatter.tags=n),t.frontmatter):n.length?{tags:n}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let n=this.item.env.main.app;if(!n||!Zt.MarkdownRenderer||!Zt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Zt.MarkdownRenderer.render(n,t,i,this.item.path,new Zt.Component);let r=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=r!==i.innerHTML,r=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Zt.htmlToMarkdown)(i)}};var od=class extends dt{static{o(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var rd=class extends dt{static{o(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function WP({content:s}={}){if(!s)return null;try{return JSON.parse(s)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}o(WP,"parse_canvas_json");function y0({target:s,title:e}={}){return s?{title:e||s,target:s,line:1}:null}o(y0,"build_link_record");function GP({node:s}={}){if(!s||typeof s!="object")return[];if(s.type==="text"&&typeof s.text=="string")return Xt(s.text);if(s.type==="file"&&typeof s.file=="string"){let e=typeof s.subpath=="string"?s.subpath:"",t=`${s.file}${e}`,n=y0({target:t,title:s.file});return n?[n]:[]}if(s.type==="link"&&typeof s.url=="string"){let e=y0({target:s.url,title:s.url});return e?[e]:[]}return[]}o(GP,"get_canvas_node_links");function HP({nodes:s=[]}={}){return Array.isArray(s)?s.reduce((e,t)=>(e.push(...GP({node:t})),e),[]):[]}o(HP,"get_canvas_links_from_nodes");function JP({content:s}={}){let e=WP({content:s});return e?.nodes?HP({nodes:e.nodes}):[]}o(JP,"get_canvas_links");var ad=class extends dt{static{o(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=JP({content:e});let t=this.item.file?.stat,n=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:n,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var cd=class extends zs{static{o(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),n="# Text Elements",i="# Drawing",r=t.indexOf(n),a=t.indexOf(i);if(r===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(r+n.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function b0(s,e){let[t,...n]=s.split("#").filter(Boolean),i=Ol(t,e);if(e)return[i,...n].join(" > ");let r=n.findLast(a=>a&&a[0]!=="{");return[i,r].join(" > ")}o(b0,"get_block_display_name");var Qn=class extends Ls{static{o(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:n,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((r,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(r.has_line_start=a),c[1]===t&&(r.has_line_end=a)),r),{has_line_start:null,has_line_end:null});return!(n&&i&&this.collection.get(this.source_key+n)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return b0(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},v0={class:Qn,actions:{find_connections:Xn}};var ir=class extends Ms{static{o(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var ld=class extends Yt{static{o(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=yh;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),n=Object.entries(e.reduce((i,r)=>{let a=this.get_item_data_path(r.key);return i[a]=i[a]||[],i[a].push(r),i},{}));for(let i=0;i<n.length;i++){let[r,a]=n[i];await this.fs.append(r,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},yh=class extends $t{static{o(this,"AjsonMultiFileBlockDataAdapter")}};var dd=class{static{o(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return re(e)}};function _d(s,e,t){return s.split(`
`).slice(e-1,t).join(`
`)}o(_d,"get_line_range");var ei=class extends dd{static{o(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:n,line_end:i}=this.item;if(!n||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let r=t.split(`
`);r.splice(i,0,"",e);let a=r.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let n=await this.item.source.read(),{line_start:i,line_end:r}=this.item;if(!i||!r)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=n.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(r)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:n}=this.item;if(!t||!n)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(n)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let n=e.includes("#"),i=n?e.split("#")[0]:e,r=this.item.env.smart_sources.get(i);if(!r){await this.item.env.smart_sources.create(i,t);return}if(n){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await r.append(t)}else await r.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:n}=this.item;if(!t||!n)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return _d(e,t,n)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let n=[],[i,...r]=this.item.key.split("#"),a=i.split("/").pop();if(n.push(a),r.length){let c=r[r.length-1];c.startsWith("{")&&c.endsWith("}")?(r.pop(),n.push(r.pop()),this.item.lines&&n.push(`Lines: ${this.item.lines.join("-")}`)):n.push(r.pop())}return n.filter(Boolean).join(" > ")}};var ti=class{static{o(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((n,[i,r])=>{let a=(t?t+".":"")+this.process_setting_key(i);return n[a]=r,n},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var or=class extends ti{static{o(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var si=class{static{o(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,n])=>({value:t,name:n.name||t})).sort((t,n)=>t.name.localeCompare(n.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Ds=class extends si{static{o(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var _t=class{static{o(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var ni=class{static{o(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},ii=class{static{o(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var oi=class extends ni{static{o(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let n;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(n=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&n.status===400)throw new Error("Obsidian request failed");return new bh(n)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(n),console.error(i),null}}},bh=class extends ii{static{o(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Rs=class extends ni{static{o(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...n}=e,i=await fetch(t,n);return new vh(i)}},vh=class extends ii{static{o(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var E0=Y(x0(),1);var tI=Object.defineProperty,sI=o((s,e,t)=>e in s?tI(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,"__defNormalProp"),nI=o((s,e,t)=>(sI(s,typeof e!="symbol"?e+"":e,t),t),"__publicField");function iI(s,e){let t=Array.from({length:s.length},(n,i)=>({start:i,end:i+1}));for(;t.length>1;){let n=null;for(let i=0;i<t.length-1;i++){let r=s.slice(t[i].start,t[i+1].end),a=e.get(r.join(","));a!=null&&(n==null||a<n[0])&&(n=[a,i])}if(n!=null){let i=n[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}o(iI,"bytePairMerge");function oI(s,e){return s.length===1?[e.get(s.join(","))]:iI(s,e).map(t=>e.get(s.slice(t.start,t.end).join(","))).filter(t=>t!=null)}o(oI,"bytePairEncode");function rI(s){return s.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}o(rI,"escapeRegex");var wh=class{static{o(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(s,e){this.patStr=s.pat_str;let t=s.bpe_ranks.split(`
`).filter(Boolean).reduce((n,i)=>{let[r,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>n[d]=l+_),n},{});for(let[n,i]of Object.entries(t)){let r=E0.default.toByteArray(n);this.rankMap.set(r.join(","),i),this.textMap.set(i,r)}this.specialTokens={...s.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[i,r])=>(n[r]=this.textEncoder.encode(i),n),{})}encode(s,e=[],t="all"){let n=new RegExp(this.patStr,"ug"),i=wh.specialTokenRegex(Object.keys(this.specialTokens)),r=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=wh.specialTokenRegex([...c]),_=s.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(s),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??s.length;for(let f of s.substring(l,u).matchAll(n)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){r.push(g);continue}r.push(...oI(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];r.push(p),l=d.index+d[0].length}return r}decode(s){let e=[],t=0;for(let r=0;r<s.length;++r){let a=s[r],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let n=new Uint8Array(t),i=0;for(let r of e)n.set(r,i),i+=r.length;return this.textDecoder.decode(n)}},md=wh;nI(md,"specialTokenRegex",s=>new RegExp(s.map(e=>rI(e)).join("|"),"g"));async function S0(s,e=s){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await A0(s);return window.localStorage.setItem(e,JSON.stringify(_)),_}let n=await import("node:fs/promises"),i=await import("node:path"),r=await import("node:os"),a=i.join(r.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await n.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await A0(s);return await n.mkdir(a,{recursive:!0}),await n.writeFile(c,JSON.stringify(l),"utf8"),l}o(S0,"fetch_json_cached");async function A0(s){let e=await fetch(s);if(!e.ok)throw new Error(`failed to download ${s} \u2013 ${e.status}`);return await e.json()}o(A0,"do_fetch");function Eh(s){if(s===null)return!0;let e=typeof s;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(s)?s.every(Eh):e==="object"?Object.values(s).every(Eh):!1}o(Eh,"is_json_compatible");function pd(s,e){let t={};for(let[n,i]of Object.entries(s))e.includes(n)||Eh(i)&&(t[n]=i);return t}o(pd,"extract_json_details");function rr(s){return Object.keys(s).length===0}o(rr,"is_empty_object");function aI(s,e){return rr(s)?e:rr(e)?s:{...s,...e}}o(aI,"merge_details");function xh(s){let e=s.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}o(xh,"get_message_from_object");function Q(s,e=null){if(Array.isArray(s)&&s.length>0)return Q(s[0],e);if(s==null)return{message:"Unknown error",details:null,http_status:e};if(typeof s=="string")return{message:s,details:null,http_status:e};if(s instanceof Error){let t=(s.message||"").trim()||"Unknown error",n=pd(s,["message"]);return{message:t,details:rr(n)?null:n,http_status:e}}if(typeof s=="object"){let t=s;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let r=i,a=xh(r),c=pd(r,["message"]),l=pd(t,["message","error"]),d=aI(l,c);return{message:a||xh(t)||"Unknown error",details:rr(d)?null:d,http_status:e}}return Q(i)}let n=xh(t);if(n){let i=pd(t,["message"]);return{message:n,details:rr(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}o(Q,"normalize_error");var cI="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",mt=class extends Ds{static{o(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Ve}get res_adapter(){return Ke}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new _t({adapter:Rs})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),r=await this.request(i);if(!r)return console.error("No response received for embedding request."),[];if(r.error)return[r];let c=new this.res_adapter(this,r).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let n=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(n);return i.error?{error:Q(i,n.status())}:i}catch(n){return console.warn("Request error:",n),await this.handle_request_err(n,e,t)}}async handle_request_err(e,t,n){if(e.status===429&&n<3){let i=Math.pow(n+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(r=>setTimeout(r,1e3*i)),await this.request(t,n+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?null:c}async load_tiktoken(){let e=await S0(cI,"cl100k_base.json");this.tiktoken=new md(e)}},Ve=class{static{o(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Ke=class{static{o(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var hd=class extends mt{static{o(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Ah}get res_adapter(){return Sh}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Ah=class extends Ve{static{o(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Sh=class extends Ke{static{o(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(n=>({vec:n.embedding,tokens:t}))}};var fd=class extends Ds{static{o(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((n,i)=>{let r=`${this.message_prefix}${this.message_id++}`;this.message_queue[r]={resolve:n,reject:i},this._post_message({method:e,params:t,id:r})})}_handle_message_result(e,t,n){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(n?this.message_queue[e].reject(new Error(n)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),n=await this._send_message("embed_batch",{inputs:t});return e.map((i,r)=>(i.vec=n[r].vec,i.tokens=n[r].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var gd=class extends fd{static{o(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(n=>this.iframe.onload=n);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(n=>{let i=o(()=>{this.model.model_loaded?n():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:n,error:i}=e.data;this._handle_message_result(t,n,i)}};var C0=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var O0={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:Ch};var Ch={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},q0={},Oh={};var ri=class extends gd{static{o(this,"SmartEmbedTransformersIframeAdapter")}static defaults=O0;constructor(e){super(e),this.connector=C0.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...q0}}get_models(){return Promise.resolve(this.models)}get models(){return Ch}};var yd=class extends mt{static{o(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return qh}get res_adapter(){return $h}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let n=await t.json(),i=[];for(let a of dI(n.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let r=this.parse_model_data(i);return this.model_data=r,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),r}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,n)=>t.name.localeCompare(n.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,n)=>{let i=n.model_info||{},r=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[n.name]={model_name:n.name,id:n.name,multimodal:!1,max_tokens:r||this.max_tokens,dims:a,description:n.description||`Model: ${n.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},qh=class extends Ve{static{o(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},$h=class extends Ke{static{o(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},lI=o(s=>["embed","embedding","bge"].some(e=>s.name.toLowerCase().includes(e)),"is_embedding_model"),dI=o(s=>{if(!Array.isArray(s))throw new TypeError("models must be an array");return s.filter(lI)},"filter_embedding_models");var bd=class extends mt{static{o(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return jh}get res_adapter(){return Th}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let n=e.map(r=>this.estimate_tokens(r.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let r=i[0].error.details?.details?.find(a=>a.retryDelay);if(r.retryDelay){let a=parseInt(r.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((r,a)=>{r.tokens=n[a]}),console.log("Gemini embed_batch response:",i),i}},jh=class extends Ve{static{o(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[n,...i]=t.split(`
`),r=i.join(`
`).trim()||"";return r.length?{model:this.model_id,content:{parts:[{text:r}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:n}:{model:this.model_id,content:{parts:[{text:n}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Th=class extends Ke{static{o(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,n)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${n}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function _I(s,e="lm_studio"){return s.object!=="list"||!Array.isArray(s.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",s),s.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,n)=>(t[n.id]={id:n.id,model_name:n.id,max_tokens:n.loaded_context_length||512,description:`LM Studio model: ${n.id}`,adapter:e},t),{}))}o(_I,"parse_lm_studio_models");var vd=class extends mt{static{o(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Nh}get res_adapter(){return Ph}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let n=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(n);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return _I(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),n=await super.embed_batch(e);return n.forEach((i,r)=>{i.tokens=t[r]}),n}},Nh=class extends Ve{static{o(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Ph=class extends Ke{static{o(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var ar=class extends ti{static{o(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw Q(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var kd=class{static{o(this,"SmartStreamer")}constructor(e,t={}){let{method:n="GET",headers:i={},body:r=null,withCredentials:a=!1}=t;this.url=e,this.method=n,this.headers=i,this.body=r,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(n=>n!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(n=>(n(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let n=JSON.parse(e.currentTarget.response);typeof n=="object"?t.data=n:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let n=t.split(this.chunk_splitting_regex);n.forEach((i,r)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,r===n.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var wd=class extends si{static{o(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var ai={},Qt={data:null,fetched_at:0},B=class extends wd{static{o(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return U}get res_adapter(){return z}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new _t({adapter:Rs})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Qt.data[e]||{},n=o(a=>a.limit?.context||1e4,"get_limit_i"),i=o(a=>a.limit?.output||1e4,"get_limit_o"),r=o(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=n(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=r(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:n(c),max_output_tokens:i(c),multimodal:r(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(n){console.error("Failed to fetch model data:",{error:n,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let n=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(n);if(!i)return null;let r=new this.res_adapter(this,await i.json());try{return r.to_openai()}catch(a){let c=Q(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((r,a)=>{try{this.active_stream=new kd(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),r(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=Q({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=Q(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=Q(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Qt?.data&&t-Qt?.fetched_at<e)return Qt.data;try{let n={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},r=await(await this.http_adapter.request(n)).json();return Qt.data=r,Qt.fetched_at=t,console.log({MODELS_DEV_CACHE:Qt}),r}catch(n){return console.warn("models.dev fetch failed; continuing without enrichment",n),Qt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return ai[this.constructor.key]||(ai[this.constructor.key]={}),ai[this.constructor.key]}set model_data(e){ai[this.constructor.key]||(ai[this.constructor.key]={}),ai[this.constructor.key]=e}},U=class{static{o(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(n=>n.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},z=class{static{o(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,n=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=n}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let n=e.choices[0].delta.content;t=n,this._res.choices[0].message.content+=n}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var cr=class extends B{static{o(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return lr}res_adapter=dr;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},lr=class extends U{static{o(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(n=>n.text).join(`
`):t.content;else if(t.role==="tool"){let n={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(n)}else{let n={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(n.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(n)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},dr=class extends z{static{o(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let n=e.delta?.text;t=n,this._res.content[0].text+=n}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var uI=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Bs=class extends B{static{o(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Ih;parse_model_data(e){return e.data.filter(t=>!uI.some(n=>t.id.startsWith(n))&&!t.id.includes("-instruct")).reduce((t,n)=>{let i={model_name:n.id,id:n.id,multimodal:!0,max_input_tokens:mI(n.id)};return t[n.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function mI(s){return s.startsWith("gpt-4.1")?1e6:s.startsWith("o")?2e5:s.startsWith("gpt-5")?4e5:s.startsWith("gpt-4o")||s.startsWith("gpt-4.5")||s.startsWith("gpt-4-turbo")?128e3:s.startsWith("gpt-4")?8192:s.startsWith("gpt-3")?16385:8e3}o(mI,"get_max_input_tokens");var Ih=class extends z{static{o(this,"SmartChatModelOpenaiResponseAdapter")}};var _r=class extends Bs{static{o(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:n}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${n}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,raw:n,description:`Model: ${n.model}, Status: ${n.status}`,max_input_tokens:4e3};return t}};var ci=class extends B{static{o(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=ur;res_adapter=mr;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,n)=>{let i={model_name:n.name.split("/").pop(),id:n.name.split("/").pop(),max_input_tokens:n.inputTokenLimit,max_output_tokens:n.maxOutputTokens,description:n.description,multimodal:n.name.includes("vision")||n.description.includes("multimodal"),raw:n};return t[n.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},ur=class extends U{static{o(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let n of this.messages)n.role==="system"?t+=n.content+`
`:e.push({role:this._get_gemini_role(n.role),parts:this._transform_content_to_gemini(n.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let n=t.image_url.url.split(";")[0].split(":")[1];return n==="image/jpg"&&(n="image/jpeg"),{inline_data:{mime_type:n,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},mr=class extends z{static{o(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:Q(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},n=e.parts.find(i=>i.functionCall);return n&&(t.tool_calls=[{type:"function",function:{name:n.functionCall.name,arguments:JSON.stringify(n.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let n=JSON.parse(t),i;if(n.candidates?.[0]?.content?.parts?.[0]?.text?.length){let r=n.candidates[0].content.parts[0].text;i=r,this._res.candidates[0].content.parts[0].text+=r}return n.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=n.candidates[0].content.role),n.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=n.candidates[0].finishReason),n.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...n.promptFeedback}),n.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...n.usageMetadata}),n.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=n.candidates[0].content.parts[0].functionCall.name,n.candidates[0].content.parts[0].functionCall.args&&Object.entries(n.candidates[0].content.parts[0].functionCall.args).forEach(([r,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[r]||(this._res.candidates[0].content.parts[0].functionCall.args[r]=""),this._res.candidates[0].content.parts[0].functionCall.args[r]+=a})),i}},pr=class extends ci{static{o(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var hr=class extends B{static{o(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Lh}get res_adapter(){return Mh}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,n)=>(t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_length,name:n.name,description:n.name,long_desc:n.description,multimodal:n.architecture.modality==="multimodal",raw:n},t),{})}},Lh=class extends U{static{o(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Mh=class extends z{static{o(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var fr=class extends B{static{o(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return gr}get res_adapter(){return yr}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={id:n.id,model_name:n.id,description:`LM Studio model: ${n.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},gr=class extends U{static{o(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),n=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=n.messages[n.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),n.tool_choice="required"}else n.tool_choice&&typeof n.tool_choice=="object"&&(n.tool_choice="auto");return t.body=JSON.stringify(n),t}},yr=class extends z{static{o(this,"SmartChatModelLmStudioResponseAdapter")}};var br=class extends B{static{o(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=vr;res_adapter=kr;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let n=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let r of n.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:r.name})})).json();i.push({...c,name:r.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,n)=>{if(n.name.includes("embed"))return t;let i={model_name:n.name,id:n.name,multimodal:!1,max_input_tokens:Object.entries(n.model_info).find(r=>r[0].includes(".context_length"))[1]};return t[n.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},vr=class extends U{static{o(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},n=this._extract_images_from_content(e.content);return n.length>0&&(t.images=n.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},kr=class extends z{static{o(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let n=e.message.content;t=n,this._res.message.content+=n}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var zh={openai:{req:U,res:z},anthropic:{req:lr,res:dr},gemini:{req:ur,res:mr},lm_studio:{req:gr,res:yr},ollama:{req:vr,res:kr}},wr=class extends B{static{o(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=zh[e];return t&&t.req?t.req:U}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=zh[e];return t&&t.res?t.res:z}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",n=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${n}${i}`}get_adapters_as_options(){return Object.keys(zh).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:o(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var xr=class extends B{static{o(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Dh}get res_adapter(){return Rh}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_window||8192,description:`Owned by: ${n.owned_by}, context: ${n.context_window}`,multimodal:n.id.includes("vision")};return t}},Dh=class extends U{static{o(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Rh=class extends z{static{o(this,"SmartChatModelGroqResponseAdapter")}};var Er=class extends B{static{o(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return U}get res_adapter(){return z}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((n,i)=>{let r=i.id||i.name;return n[r]={id:r,model_name:r,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},n},{})}};var Ar=class extends B{static{o(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Fh}get res_adapter(){return Bh}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_size||8192,description:n.description||n.name||n.id,raw:n};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Fh=class extends U{static{o(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Bh=class extends z{static{o(this,"SmartChatModelDeepseekResponseAdapter")}};var _f=require("obsidian");function $0(s,e){let{blocks:t,task_lines:n,tasks:i,codeblock_ranges:r}=nd(e),a=s.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=s.key+c,_=s.block_collection.get(d),u=_d(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=Xt(u),f=id({source:s,links:p}),y={key:d,lines:l,size:u.length,outlinks:[...p,...f],last_read:{at:a,hash:re(u)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new s.block_collection.item_type(s.env,y);s.block_collection.set(g)}else _.data={..._.data,...y}}pI(s,t,n,i,r);for(let c of s.blocks)c.vec||c.queue_embed()}o($0,"parse_blocks");function pI(s,e,t=[],n={},i={}){let r=new Set(Object.keys(e).map(c=>s.key+c)),a=s.blocks;for(let c=0;c<a.length;c++)r.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());s.data.blocks=e,s.data.task_lines=t,s.data.tasks=n,s.data.codeblock_ranges=i,s.queue_save()}o(pI,"clean_and_update_source_blocks");function Uh(s,e){if(e===null)return null;if(e===void 0)return s;if(typeof e!="object")return e;(typeof s!="object"||s===null)&&(s={});let t=Object.keys(e),n=t.length;for(let i=0;i<n;i++){let r=t[i],a=e[r],c=s[r];Array.isArray(a)?s[r]=a.slice():j0(a)?s[r]=Uh(j0(c)?c:{},a):a!==void 0&&(s[r]=a)}return s}o(Uh,"ajson_merge");function j0(s){return s!==null&&typeof s=="object"&&!Array.isArray(s)}o(j0,"is_object");var T0={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function hI(s){let e=!1,[t,...n]=s.split(":");return T0[t]&&(t=T0[t],e=!0),{collection_key:t,item_key:n.join(":"),changed:e}}o(hI,"_parse_ajson_key");var es=class extends Yt{static{o(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",n=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(n)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let r of Object.values(this.collection.items))r._queue_load&&r.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let r of Object.values(this.collection.items))r._queue_load&&r.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:n,file_data:i}=this.parse_single_file_ajson(t);n&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let r of Object.values(this.collection.items))r._queue_load=!1,r.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,n=e.trim().split(`
`).filter(Boolean),i={},r=0;for(let c=0;c<n.length;c++){let l=n[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:y,item_key:g,changed:k}=hI(p),v=`${y}:${g}`;f?(i[v]=f,(k||v!==p)&&(delete i[p],t=!0)):(delete i[v],(k||v!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}r++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=Uh(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}r>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(r=>r._queue_save),t=Date.now(),n=50;for(let r=0;r<e.length;r+=n){let a=e.slice(r,r+n);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(r=>r.deleted);i.length&&i.forEach(r=>{delete this.collection.items[r.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Wh=class extends $t{static{o(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:n}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},Sr={collection:es,item:Wh};var Cr=class extends ie{static{o(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,n=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",r=[];return!t.includes(e)&&e!=="global"&&r.push(e),r.push(t),`${r.join("_").replace(/\./g,"_")}#${[n,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function fI(s=[]){let e=s.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}o(fI,"parse_component_properties");async function gI(s,e){let{scope_key:t,component_key:n}=fI(s);if(!n)return null;let i=typeof e=="function"?e:e?.render,r=typeof i?.version=="number"?i.version:0,a=await re(i.toString());return{scope_key:t,component_key:n,version:r,hash:a}}o(gI,"build_component_data");var xd=class{static{o(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,n){if(!this.should_use_adapter(n))return null;let i=await gI(t,n);if(!i)return null;let r=await e.create_or_update({...i});return r?(r._component_module=n,r._component_adapter=new this(r,n),r):null}async render(e,t){throw new Error("render() not implemented")}};var Ed=class extends xd{static{o(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let n=typeof this.module=="function"?this.module:this.module?.render;if(typeof n!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await n.call(this.smart_view,e,t)}};function N0(s,e=[],t=[]){return!s||typeof s!="object"||Object.entries(s).forEach(([n,i])=>{let r=[...e,n];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:r,module:i});return}typeof i=="object"&&N0(i,r,t)}}),t}o(N0,"flatten_components_config");var Ad=class extends oe{static{o(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=N0(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let n of this.component_adapters){let i=await n.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,n={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,n)}},P0={class:Ad,item_type:Cr,data_adapter:Sr,component_adapters:{SmartViewComponentAdapter:Ed}};var I0=P0;function L0(s=[]){let e=new Set;for(let{key:t}of s)t.includes("#")||e.add(t);return s.filter(({key:t})=>{if(!t.includes("#"))return!0;let n=t.split("#")[0];return!e.has(n)})}o(L0,"filter_redundant_context_items");var M0=o((s,e)=>!e||!s?.[e]?!1:s[e].folder||s[e].from_named_context?s[e].exclude?!1:(s[e].exclude=!0,!0):(delete s[e],!0),"remove_context_item_data"),Or=class extends ie{static{o(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:n=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let r=this.data.context_items[i],a={d:0,at:Date.now(),...r||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),n&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:n=!0}=t;M0(this.data.context_items,e)&&(this.queue_save(),n&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:n=!0}=t,i=Array.isArray(e)?e:[e],r=[];return i.forEach(a=>{M0(this.data.context_items,a)&&r.push(a)}),r.length?(this.queue_save(),n&&this.emit_event("context:updated",{removed_keys:r}),r):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(n=>{n.size&&(e+=n.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],n=this.context_items.filter(e.filter).sort((r,a)=>r.data.d-a.data.d);console.log("get_text context_items",n);for(let r of n){if(r.is_media)continue;let a=await r.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(r,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:n}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),n=[];for(let i of t){if(!i.is_media)continue;let r=await i.get_base64();r.error?this.emit_get_media_error(i,r):n.push(r)}return n}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return L0(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let n=this.data.context_items[t].d;return n===e||typeof n>"u"&&e===0})}};var Sd=class extends oe{static{o(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let n=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&n.add_items(t.add_items),this.set(n),n.queue_save(),n.emit_event("context:created"),n}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var yI={class:Sd,data_adapter:es,item_type:Or};var z0=yI;var Cd=class extends ie{static{o(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var pt=class{static{o(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var Od=class extends pt{static{o(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var qd=class extends pt{static{o(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var D0=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var $d=class extends pt{static{o(this,"ImageContextItemAdapter")}static detect(e){return D0.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),n=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:n}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var jd=class extends pt{static{o(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var Gh=class extends oe{static{o(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let n=e.order||0,i=t.order||0;return n-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(n=>n.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let n=0;n<t.length;n++){let[i,r]=t[n];r.exclude||this.new_item({key:i,...r})}}},R0={version:1,class:Gh,collection_key:"context_items",item_type:Cd,context_item_adapters:{BlockContextItemAdapter:Od,SourceContextItemAdapter:qd,ImageContextItemAdapter:$d,PdfContextItemAdapter:jd}};function F0(s={},e){let t=(s.ct||0)+1,n=s.first_at??e;return{ct:t,first_at:n,last_at:e}}o(F0,"next_log_stats");var li=class extends ie{static{o(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var bI={"collection:save_started":!0,"collection:save_completed":!0},Hh=class extends oe{static{o(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let n=new this(e,t);return n.init(),n}get item_type(){return li}init(){this.env?.events||Yn.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!bI[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let n=Date.now(),i=this.get(e);i||(i=new li(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let r=F0({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},n);i.data={...i.data,...r},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(n){console.error("[EventLogs] record failure",e,n)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},B0={class:Hh,collection_key:"event_logs",data_adapter:es,item_type:li};var di=require("obsidian");function U0(s,e={}){if(!s)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],n=s?.env?.config?.actions||{},i=s?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(n[c]||{}).display_name||c;return a.push({select_action:o(()=>{s.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}o(U0,"build_suggest_scope_items");var W0=o((s,e={})=>{let t=s?.inputEl,n=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(n===t&&i)},"should_handle_arrow_left");var Td=class extends di.FuzzySuggestModal{static{o(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,n=t.plugin,i=n.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=n,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let n=this,i=new n(e,t);return i.open(t),i}static register_modal(e){let t=this,n=e?.env,i={...n.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let r=o((l={})=>{let d=t.resolve_item_from_payload(n,l);return t.open(d,{...i,...l})},"open_handler"),a=[n?.events?.on?.(`${t.event_domain}:open`,r)],c=o(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,r=W0(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&r){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return U0(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){super.renderSuggestion(e,t);let n=e?.icon||e?.item?.icon;if(n){t.addClass("sc-modal-suggestion-has-icon");let a=t.createEl("span");(0,di.setIcon)(a,n)}let i=e&&Object.prototype.hasOwnProperty.call(e,"display_right")?e.display_right:e?.item?.display_right,r=i==null?"":String(i).trim();return r&&this.env.smart_components.render_component("suggest_display_right",r).then(a=>{t.appendChild(a)}),t}onChooseSuggestion(e,t,...n){this.prevent_close=!0;let i=e.item,r=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=di.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,r)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let n=e[t],i=await n({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let r=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),r!==-1&&this.chooser.setSelectedItem(r)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var Efe=require("obsidian");var Nd=class extends Td{static{o(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var G0=require("obsidian");var Pd=class extends G0.Modal{static{o(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var Ld=require("obsidian");var vI="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",Id=class extends Ld.Modal{static{o(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){kI(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function kI(s,e){if(!s)return;s.empty(),s.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let n=document.createElement("div");n.className="sc-milestones-modal__title-text",n.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),wI(i),i.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(vI,"_external")}),t.appendChild(n),t.appendChild(i),s.appendChild(t)}o(kI,"render_milestones_modal_title");function wI(s){xI(s,["circle-help","help-circle","help","info"])||(s.textContent="?")}o(wI,"render_help_icon");function xI(s,e){if(!s)return!1;let t=Array.isArray(e)?e:[];for(let n of t)if(!(typeof n!="string"||n.length===0)){s.textContent="";try{(0,Ld.setIcon)(s,n)}catch{continue}if(s.querySelector("svg"))return!0}return!1}o(xI,"set_icon_with_fallback");var H0={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var qr=class extends ie{static{o(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let n=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?n.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&n.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&n.debounce_save(),d}},r=new Proxy(e,i);return this._settings_proxy_map.set(e,r),r}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,n])=>({label:n.name||t,value:n.key||t})).sort((t,n)=>t.label.toLowerCase().includes("free")&&!n.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&n.label.toLowerCase().includes("free")?1:t.label.localeCompare(n.label))}model_changed(e,t,n){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},r=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...r,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var Md=class extends oe{static{o(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,r)=>r.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let n=new this.item_type(this.env,{...e});return this.set(n),this.settings.default_model_key=n.key,this.emit_event("model:changed"),n.queue_save(),n}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(n=>!n.deleted).sort((n,i)=>i.data.created_at-n.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let n=this.new_model({provider_key:this.default_provider_key});n.queue_save(),this.process_save_queue(),this.settings.default_model_key=n.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function J0(s){return{default_model_key:{type:"dropdown",name:`Default ${s.model_type.toLowerCase()} model`,description:`Used as the default ${s.model_type.toLowerCase()} model when no other is specified.`,options_callback:o(()=>s.get_model_key_options(),"options_callback"),callback:o(async(e,t)=>{s.emit_event("model:changed")},"callback")}}}o(J0,"settings_config");var Us=class extends qr{static{o(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Jh=class extends Md{static{o(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var EI={class:Jh,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:Sr,item_type:Us,providers:{},settings_config:J0},Vh=EI;var Kh=class extends ri{static{o(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},V0={class:Kh,settings_config:Oh};Vh.providers={transformers:V0};var K0=Vh;function $r(s){return s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}o($r,"format_collection_name");async function AI(s,e={}){let t=Object.entries(s.settings_config).map(([i,r])=>(r.setting||(r.setting=i),this.render_setting_html(r))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${$r(s.collection_key)}</h2>
${t}
</div></div></div>`}o(AI,"build_html");async function Y0(s,e={}){let t=await AI.call(this,s,e),n=this.create_doc_fragment(t);return await this.render_setting_components(n,{scope:s}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(n.querySelector(".collection-settings"))):s.settings_container=n.querySelector(".collection-settings-container"),s.settings_container}o(Y0,"render");var Z0=require("obsidian");function SI(s){let e=typeof s=="number"?s:Number.parseFloat(s);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}o(SI,"format_score");function CI(s){let e=typeof s=="number"?s:Number.parseFloat(s);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],n=e,i=0;for(;n>=1024&&i<t.length-1;)n/=1024,i+=1;let r=n>=10||Number.isInteger(n)?0:1;return`${Number.parseFloat(n.toFixed(r)).toString()} ${t[i]}`}o(CI,"format_size");function X0(s,e){return s?`<span class="${e}">${s}</span>`:""}o(X0,"build_badge_html");function OI(s,e={}){let t;if(s.item_ref)if(s.item_ref.key.includes("#")){let c=s.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(s.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=s.item_ref.key.split("/").pop();else t=s.key.split("/").pop();let n=SI(s?.data?.score),i=CI(s?.size||s?.data?.size),r=X0(n,"sc-context-item-score"),a=X0(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${s.key}">\xD7</span>
${r}
<span class="sc-context-item-name">${t||s.key}</span>
${a}
</span>`}o(OI,"build_html");async function Q0(s,e={}){let t=OI(s,e),i=this.create_doc_fragment(t).firstElementChild;return qI.call(this,s,i,e),i}o(Q0,"render");async function qI(s,e,t={}){let n=s.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");n.smart_contexts.get(d).remove_item(s.key)}),s.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${Z0.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),Il(a,s.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{s.open(a)}),e}o(qI,"post_process");async function $I(s,e={}){let t=[];t.push("<h2>Collections</h2>");let n=Object.keys(s.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,r)=>i==="smart_sources"||i==="smart_blocks"?-1:r==="smart_sources"||r==="smart_blocks"?1:i.localeCompare(r));for(let i of n){let r=s[i];if(!r||!r.items){t.push(`
<div class="sc-collection-stats">
<h3>${$r(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=TI(r,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}o($I,"build_html");async function eE(s,e={}){let t=await $I.call(this,s,e),n=this.create_doc_fragment(t);return await jI.call(this,s,n,e)}o(eE,"render");async function jI(s,e,t={}){return e}o(jI,"post_process");function TI(s,e){let t=Object.values(s.items).length,n=$r(e),i=s.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${n}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let r=s.load_time_ms?`<p>Load time: ${s.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=NI(s,n,t),l="";return typeof s.process_embed_queue=="function"&&(l=PI(s,t)),`
<div class="sc-collection-stats">
<h3>${n}</h3>
${l}
${c}
${r}
${a}
</div>
`}o(TI,"generate_collection_stats");function NI(s,e,t,n){return`
<p><strong>Total:</strong> ${t}</p>
`}o(NI,"get_generic_collection_stats");function PI(s,e){if(!Object.values(s.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let n=Object.values(s.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=n.embedded/n.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${n.embedded} / ${n.should_embed})</p>`+(n.missing_embed?`<p><strong>Missing embeddings:</strong> ${n.missing_embed}</p>`:"")+(n.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${n.extraneous_embed}</p>`:"")+(n.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${n.should_not_embed}</p>`:"")}o(PI,"calculate_embed_coverage");var tE=require("obsidian");function II(s,e={}){return'<div class="smart-form-dropdown-component"></div>'}o(II,"build_html");async function Yh(s,e={}){let t=II.call(this,s,e),n=this.create_doc_fragment(t);return await LI.call(this,s,n,e)}o(Yh,"render");async function LI(s,e,t={}){if(!s)return e.textContent="Error: scope is required for dropdown component.",e;let n=s.settings;if(!n||typeof n!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let r=t.options;if(!Array.isArray(r)||r.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new tE.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=$e(n,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:s,options:r}),l=_.selectEl,t.required&&l.setAttribute("required","true"),r.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),r.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=o(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:s,setting_key:i,select_el:l,container:e}):je(s.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}o(LI,"post_process");Yh.version=.2;var sE=require("obsidian");function MI(s,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}o(MI,"build_html");function nE(s,e={}){let t=MI.call(this,s,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),r=i.querySelector(".callout-icon"),a=(0,sE.getIcon)("smart-chat");return a&&(this.empty(r),r.appendChild(a)),zI.call(this,s,i,e),i}o(nE,"render");function zI(s,e){}o(zI,"post_process");var iE=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var aE=require("obsidian");var WI=require("obsidian");var RI={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},zd={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},FI=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function Xh(s){let e=Object.entries(s||{}).reduce((r,[a,c])=>{let l=c?.group||"Other";return r[l]||(r[l]=[]),r[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),r},{}),t=Object.keys(e),n=FI.reduce((r,a,c)=>(r[a]=c,r),{});return t.sort((r,a)=>{let c=Object.prototype.hasOwnProperty.call(n,r),l=Object.prototype.hasOwnProperty.call(n,a);return c&&l?n[r]-n[a]:c?-1:l?1:r.localeCompare(a)}).map(r=>{let a=(e[r]||[]).slice();return{group:r,items:a}})}o(Xh,"derive_events_checklist_groups");function jr(s,e){let t=BI(s,e);return!!(t===!0||s?.event_logs?.items?.[e])}o(jr,"check_if_event_emitted");function BI(s,e){let t=RI[e];if(!t)return null;let n=s?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let r of i){let a=n[r];if(a&&!(t.require_pro_name&&!UI(a)))return!0}return!1}o(BI,"resolve_plugin_install_event");function UI(s){let e=s?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}o(UI,"is_pro_manifest");function GI(s,e={}){let t=Xh(zd),n=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(jr(s,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),r=i>0?Math.round(n/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(jr(s,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=jr(s,u.event_key)===!0;return JI(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Je(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Je(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${r.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${n.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${n.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Je(`${r.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}o(GI,"build_html");async function cE(s,e={}){this.apply_style_sheet(iE);let t=GI.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return HI.call(this,s,i,e),i}o(cE,"render");async function HI(s,e,t={}){return VI(e),KI(e),e}o(HI,"post_process");function JI(s,e){let t=e.checked===!0,n=t?"true":"false",i=typeof s.link=="string"?s.link:"",r=t?"Completed":"Incomplete",a=`Open docs: ${s.milestone||s.event_key||"milestone"} (${r})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Je(s.event_key)}"
data-link="${Je(i)}"
data-checked="${n}"
tabindex="0"
role="button"
aria-label="${Je(a)}"
>
<div class="sc-events-checklist__label${s.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Je(s.milestone)}</span>
</div>
</li>
`}o(JI,"build_item_html");function VI(s){s&&s.getAttribute("data-links-enabled")!=="true"&&(s.setAttribute("data-links-enabled","true"),s.addEventListener("click",e=>{let t=rE(s,e);if(!t)return;let n=window.getSelection();n&&n.toString().length>0||oE(t)}),s.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let n=rE(s,e);n&&(e.preventDefault(),oE(n))}))}o(VI,"attach_item_link_listeners");function oE(s){let e=ZI(s);typeof e=="string"&&e.length>0&&window.open(e,"_external")}o(oE,"open_item_link");function KI(s){if(!s)return;Array.from(s.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let n=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&YI(i,n)})}o(KI,"render_item_state_icons");function YI(s,e){XI(s,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}o(YI,"set_item_icon");function XI(s,e){if(!s)return;let t=Array.isArray(e)?e:[];for(let n of t)if(!(typeof n!="string"||n.length===0)){s.textContent="";try{(0,aE.setIcon)(s,n)}catch{continue}if(s.querySelector("svg"))return}}o(XI,"set_icon_with_fallback");function rE(s,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let n=t.closest(".sc-events-checklist__item");return!n||!s.contains(n)?null:n}o(rE,"get_item_el_from_event");function ZI(s){let e=s.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=s.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let n=zd[t];return!n||typeof n.link!="string"?"":n.link}o(ZI,"get_item_link");function QI(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}o(QI,"build_html");var Zh=100,Qh=100;function eL(s,e={}){let{limit:t=Zh}=e;return s.slice(-t).reverse()}o(eL,"get_visible_entries");function tL(s,e={}){let{page_size:t=Zh}=e;return Math.min(s,t)}o(tL,"get_visible_count");function sL(s,e={}){let{current_count:t=0,step_size:n=Qh}=e;return Math.min(s,t+n)}o(sL,"get_next_visible_count");function nL(s,e){return s>e}o(nL,"should_show_load_more");async function lE(s,e={}){let t=this.create_doc_fragment(QI()),n=t.firstElementChild;return iL.call(this,s,n,e),t}o(lE,"render");async function iL(s,e,t={}){let n=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),r=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(n);let c=Array.isArray(s.event_logs.session_events)?[...s.event_logs.session_events]:[];if(!c.length){let _=n.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",n.appendChild(_),r&&(r.style.display="none");return}let l=tL(c.length,{page_size:Zh}),d=o(()=>{a.empty(n),eL(c,{limit:l}).forEach(_=>{aL(n,_)}),oL(r,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=n.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),r&&r.addEventListener("click",()=>{l=sL(c.length,{current_count:l,step_size:Qh}),d()})}o(iL,"post_process");function oL(s,e={}){if(!s)return;let{entries_length:t=0,visible_count:n=0}=e,i=nL(t,n);if(s.style.display=i?"inline-block":"none",i){let r=t-n,a=Math.min(Qh,r);s.textContent=`Load ${a} more`}}o(oL,"update_load_more_button");function rL(s){let[e,t]=s.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}o(rL,"get_level");function aL(s,e){let t=s.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=rL(e),s.appendChild(t);let n=s.ownerDocument.createElement("div");n.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();n.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${cL(i)}
`,t.appendChild(n);let r=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(r.trim().length){t.style.cursor="pointer";let a=s.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=r,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else n.textContent+=`
`}o(aL,"append_entry");function cL(s){let e=Date.now(),t=Math.floor((e-s)/1e3);if(t<60)return`${t} seconds ago`;let n=Math.floor(t/60);if(n<60)return`${n} minutes ago`;let i=Math.floor(n/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}o(cL,"to_time_ago");var Ne=require("obsidian");var _i=require("obsidian");function ui(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}o(ui,"get_smart_server_url");function lL(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}o(lL,"try_get_zlib");function dL(s){let e=lL();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(s),n=e.inflateRawSync(t);return new Uint8Array(n.buffer,n.byteOffset,n.length)}o(dL,"inflate_deflate_data");async function dE(s){let e=new DataView(s),t=0,n=e.byteLength,i=[],r=null;for(;t+4<=n;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let k=new Uint8Array(s.slice(t,t+y)),v=new TextDecoder("utf-8").decode(k);t+=y,t+=g;let b=(l&8)!==0,A=t,S;if(!b)S=A+p;else{let C=A,x=!1;for(;C+4<=n;){let m=e.getUint32(C,!0);if(m===134695760||m===67324752||m===33639248){x=!0;break}C++}S=x?C:n}if(S>n)break;let $=new Uint8Array(s.slice(A,S));if(t=S,b&&t+4<=n)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=n)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let j;if(d===0)j=$;else if(d===8)j=dL($);else continue;if(i.push({fileName:v,data:j}),v.toLowerCase().endsWith("manifest.json")&&!v.includes("/"))try{r=JSON.parse(new TextDecoder("utf-8").decode(j))}catch{}}return{files:i,pluginManifest:r}}o(dE,"parse_zip_into_files");function _E(s,e="Response"){if(!s||s.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(s).getUint32(0,!0)!==67324752){let n=new TextDecoder().decode(new Uint8Array(s));throw new Error(`${e} did not return a valid ZIP. Text:
${n}`)}return s}o(_E,"validate_zip_buffer");async function uE(s,e,t){let n=typeof s.writeBinary=="function";await s.exists(e)||await s.mkdir(e);for(let{fileName:i,data:r}of t){let a=e+"/"+i;if(n)await s.writeBinary(a,r);else{let c=btoa(String.fromCharCode(...r));await s.write(a,c)}}}o(uE,"write_files_with_adapter");function mE(s,e){if(!e||e==="unknown")return!1;let t=s.replace(/[^\d.]/g,""),n=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),r=n.split(".").map(Number);for(let a=0;a<Math.max(i.length,r.length);a++){let c=i[a]||0,l=r[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}o(mE,"is_server_version_newer");async function pE(s,e){let t=await(0,_i.requestUrl)({url:`${ui()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:s})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return _E(t.arrayBuffer,"Smart Plugins server")}o(pE,"fetch_plugin_zip");async function hE(s,e=_i.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${s}`);let t=await e({url:s,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return _E(t.arrayBuffer,"Download")}o(hE,"fetch_zip_from_url");async function fE(s,e,t=_i.requestUrl){let n=await t({url:`${ui()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:s})});if(n.status!==200)throw new Error(`plugin_readme error ${n.status}: ${n.text}`);return n.json.readme}o(fE,"fetch_plugin_readme");async function gE(s,e){await s.plugins.enablePlugin(e),s.plugins.enabledPlugins.add(e),s.plugins.requestSaveConfig(),s.plugins.loadManifests()}o(gE,"enable_plugin");function yE(s){return`${(s?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}o(yE,"get_oauth_storage_prefix");async function bE(s){let e=await(0,_i.requestUrl)({url:`${ui()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}o(bE,"fetch_server_plugin_list");async function vE(s={}){let e=String(s.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,_i.requestUrl)({url:`${ui()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}o(vE,"fetch_referral_stats");var kE=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var uL='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',mL='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function pL(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}o(pL,"derive_fallback_plugins");function hL(s,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${uL}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${mL}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}o(hL,"build_html");async function xE(s,e={}){this.apply_style_sheet(kE);let t=hL.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return await fL.call(this,s,i,e),i}o(xE,"render");async function fL(s,e,t={}){let i=(s.plugin||null)?.app||window.app,r=yE(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=pL(),_=0,u="",p=null,f=o(C=>{if(C){if(typeof this.empty=="function"){this.empty(C);return}C.innerHTML=""}},"empty_container"),y=o(C=>{if(!a||!C)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let m=document.createElement("div");m.classList.add("smart-plugins-login-manual-controls"),p.appendChild(m);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=C,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),m.appendChild(h);let w=document.createElement("button");w.classList.add("mod-cta"),w.textContent="Copy",w.addEventListener("click",async()=>{await wE(C)?new Ne.Notice("Copied login link to clipboard."):new Ne.Notice("Copy failed. Please select and copy the link manually.")}),m.appendChild(w)},"render_manual_login_link"),g=o(async()=>{let C={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(m=>setTimeout(m,100));for(let m in x){if(!Object.prototype.hasOwnProperty.call(x,m))continue;let{name:h,version:w}=x[m];C[m]={name:h,version:w}}return C},"get_installed_info"),k=o(async()=>{_++,_>=2&&u&&y(u),s&&typeof s.initiate_smart_plugins_oauth=="function"&&(u=gL()),new Ne.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),v=o(()=>{if(this.empty(a),p=null,!(localStorage.getItem(r+"token")||"")){new Ne.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await k()})});return}let x=new Ne.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(m=>{m.setButtonText("Logout"),m.onClick(()=>{localStorage.removeItem(r+"token"),localStorage.removeItem(r+"refresh"),new Ne.Notice("Logged out of Smart Plugins"),v(),b(),$()})})},"render_oauth_login_section"),b=o(async(C={})=>{f(c);let x=String(C.token||"").trim();if(!x){new Ne.Setting(c).setName("Give $30 off Pro. Get 30 days of Pro").setDesc("Start a free trial to unlock your referral link.").addButton(w=>{w.setButtonText("Start free trial"),w.onClick(()=>{window.open("https://smartconnections.app/pro-plugins/","_external")})});return}let m=Number(C.sub_exp??0)||0;if(!(m&&m<Date.now()))try{let h=await vE({token:x}),w=String(h?.referral_link||"").trim();if(!w)return;let O=new Ne.Setting(c).setName("Referral link").setDesc("Give $30 off Pro. Get 30 days of Pro.");O.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let q=await wE(w);new Ne.Notice(q?"Referral link copied.":"Copy failed. Please try again.")})}),O.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),A=o(async()=>{if(this.empty(l),!(!l||d.length===0))for(let C of d){let x=await s.smart_components.render_component("pro_plugins_list_item",C,{env:s,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),S=o(()=>{let C=new Ne.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");C.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),C.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),C.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{s.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),$=o(async()=>{this.empty(l);let C=localStorage.getItem(r+"token")||"";if(!C){await A(),await b();return}try{let x=await g(),m=await bE(C),{list:h=[],unauthorized:w=[],sub_exp:O}=m;if(typeof O=="number"&&O<Date.now()){S(),await A(),await b();return}if(await b({token:C,sub_exp:O}),!Array.isArray(h)||h.length===0){await A();return}for(let E of h){let q=await s.smart_components.render_component("pro_plugins_list_item",E,{env:s,app:i,token:C,installed_map:x,on_installed:$});l.appendChild(q)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),j=o(async()=>{v(),await $()},"render_smart_plugins");return s.events.on("smart_plugins_oauth_completed",()=>{j()}),await j(),e}o(fL,"post_process");function gL(){console.log("initiate_smart_plugins_oauth");let s=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${ui()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${s}`;return window.open(t,"_external"),t}o(gL,"initiate_smart_plugins_oauth");var wE=o(async s=>{if(!s)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(s),!0}catch{}try{let e=document.createElement("textarea");e.value=s,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var he=require("obsidian");var yL="https://smartconnections.app/pro-plugins/";function bL(s,e={}){return'<div class="pro-plugins-list-item"></div>'}o(bL,"build_html");function vL(s){return!s||!s.repo}o(vL,"is_fallback_item");function kL(s,e){let t=s.repo,n=s.version||"unknown",i=s.manifest_id||t.replace("/","_"),r=e?.version||null,a=e?.name||s.name||t,c=`Server version: ${n}`,l="Install",d=!1;return r&&(c+=` | Installed version: ${r}`,mE(r,n)?l="Update":(l="Installed",d=!0)),s.description&&(c+=`
${s.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:n,local_version:r}}o(kL,"compute_display_state");async function EE(s,e={}){let t=bL(s,e),i=this.create_doc_fragment(t).firstElementChild;return await wL.call(this,s,i,e),i}o(EE,"render");async function wL(s,e,t={}){let{app:n,token:i,installed_map:r={},on_installed:a}=t;if(vL(s)){let u=new he.Setting(e).setName(s.name||"Pro plugin").setDesc(s.description||"Login to unlock Pro plugins.");if(s.core_id)if(n.plugins.manifests[s.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${s.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(yL,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(s.url,"_external")})}),e}let c=s.manifest_id||s.repo.replace("/","_"),l=r[c]||null,d=kL(s,l),_=new he.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>EL(s,{app:n,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),s.docs_url?u.onClick(()=>window.open(s.docs_url,"_external")):u.onClick(()=>AL(s,{app:n,token:i,display_name:d.display_name}))}),e}o(wL,"post_process");var xL=o(async(s,e)=>{let t=typeof s.resolve_download_url=="function"?await s.resolve_download_url():s.download_url;if(t)return hE(t);if(!e)throw new Error("Login required to install this plugin.");return pE(s.repo,e)},"download_plugin_zip"),EL=o(async(s,e={})=>{let{app:t,token:n,on_installed:i}=e;try{new he.Notice(`Installing "${s.repo}" ...`);let r=await xL(s,n),{files:a,pluginManifest:c}=await dE(r),l=s.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await uE(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||s.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await gE(t,_),new he.Notice(`${s.repo} installed successfully.`),typeof i=="function"&&await i()}catch(r){console.error("[pro-plugins:list_item] Install error:",r),new he.Notice(`Install failed: ${r.message}`)}},"install_plugin"),AL=o(async(s,e={})=>{let{app:t,token:n,display_name:i}=e;try{let r=await fE(s.repo,n),a=new he.Modal(t);a.setTitle(i||s.name||s.repo),await he.MarkdownRenderer.render(t,r,a.contentEl,"",new he.Component),a.open()}catch(r){console.error("[pro-plugins:list_item] Failed to load README:",r),new he.Notice("Failed to load README")}},"show_plugin_readme");var AE=require("obsidian");var Ws=class extends AE.Modal{static{o(this,"SmartModelModal")}constructor(e,t={}){let n=e.env.plugin.app||window.app;super(n),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,n=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:o(async()=>{this.close()},"on_before_new"),on_after_delete:o(async()=>{this.close()},"on_after_delete")});e.appendChild(n);let i=t.settings_config,r=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(r);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let n=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(n);let i=await t.test_model();n.textContent=JSON.stringify(i,null,2)}};var SE=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var CE=require("obsidian");function CL(s,e){let t=[`Provider: ${s.data.provider_key}`,`Model: ${s.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${s.display_name} <span class="test-result-icon" data-icon="${qE(s)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}o(CL,"build_html");async function OE(s,e){this.apply_style_sheet(SE);let n=this.create_doc_fragment(CL.call(this,s,e)).firstElementChild;return OL.call(this,s,n,e),n}o(OE,"render");async function OL(s,e,t){let n=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),r=e.querySelector(".test-result-icon");return(0,CE.setIcon)(r,qE(s)),n.addEventListener("click",()=>{new Ws(s).open()}),i.addEventListener("click",()=>{new Ws(s,{test_on_open:!0}).open()}),e}o(OL,"post_process");function qE(s){switch(s.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}o(qE,"get_test_result_icon_name");var jE=require("obsidian");var $E={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function Dd(s,e,t={}){let n=($E[s.collection_key]||[]).map(i=>({...i,disabled:!s.env_config.providers[i.value]}));if(n.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new jE.Menu;n.forEach(r=>{i.addItem(a=>{a.setTitle(r.label),r.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=s.new_model({provider_key:r.value}),l=o(async()=>{},"on_new_close");new Ws(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}o(Dd,"show_new_model_menu");var pi=require("obsidian");function qL(s,e){try{typeof s=="function"&&(s=s(e))}catch(t){console.error("Error evaluating settings_config function:",t),s={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return s}o(qL,"ensure_settings_config");function ef(s,e,t){let n=qL(s,e);return Object.entries(n||{}).reduce((i,[r,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][r]=a,i},{[t]:{}})}o(ef,"build_settings_group_map");function tf(s,e,t,n){return ef(s,e,n)[t]||{}}o(tf,"resolve_group_settings_config");var Rd=class{static{o(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new pi.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function Fd(s,e,t,n={}){let{default_group_name:i="Settings"}=n,r=s,a=ef(s,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),u={...n,...n.group_params?.[l]||{},settings_config_source:r};return sf(l,e,d,_,u)})}o(Fd,"render_settings_config");function sf(s,e,t,n,i={}){let r=i.settings_config_source||t,a=i.settings_config_source?tf(r,e,s,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=Rd}catch{c=Rd}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,y,g,k)=>{let v=tf(y,f,p,k.default_group_name||"Settings");return sf(p,f,v,g,k)}:sf,_=$L(e,{container:n,group_name:s,settings_config:r,group_params:i,render_group:d}),u=new c(n);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)TE(u,e,p);else TE(u,e,l);u.setHeading(s);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let y=f.scope_class==="pro-setting",g=!!e.env?.is_pro;u.addSetting(k=>{switch(f.name&&k.setName(f.name),k.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&k.setClass(`setting-type-${f.type}`),f.description&&k.setDesc(f.description),f.type){case"button":k.addButton(v=>{v.setButtonText(f.name||"Run"),v.onClick(async b=>{typeof f.callback=="function"&&await mi(k,b,f.callback,{scope:e})})});break;case"toggle":k.addToggle(v=>{v.setValue($e(e.settings,p)||!1),v.onChange(b=>{je(e.settings,p,b),typeof f.callback=="function"&&mi(k,b,f.callback,{scope:e})})});break;case"text":k.addText(v=>{v.setValue(String($e(e.settings,p)||"")),v.onChange(b=>{je(e.settings,p,b)})});break;case"number":k.addText(v=>{v.setValue(String($e(e.settings,p)??"0")),v.inputEl.setAttribute("type","number"),v.onChange(b=>{let A=Number(b);isNaN(A)||je(e.settings,p,A),typeof f.callback=="function"&&mi(k,A,f.callback,{scope:e})})});break;case"dropdown":k.addDropdown(v=>{let b=f.options_callback;typeof b=="function"&&b.call(e,e).forEach(S=>{let $=S.label||S.name||S.value;v.addOption(S.value,$)}),v.setValue($e(e.settings,p)||""),v.onChange(A=>{je(e.settings,p,A),typeof f.callback=="function"&&mi(k,A,f.callback,{scope:e}),_()})});break;case"textarea":k.addTextArea(v=>{v.setValue(String($e(e.settings,p)||"")),v.onChange(b=>{if(y&&!g){new pi.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}je(e.settings,p,b)}),y&&!g&&v.setDisabled(!0)});break;case"slider":k.addSlider(v=>{let b=f.min||0,A=f.max||100,S=f.step||1;v.setLimits(b,A,S),v.setValue($e(e.settings,p)||b),v.setDynamicTooltip(),v.onChange($=>{je(e.settings,p,$),typeof f.callback=="function"&&mi(k,$,f.callback,{scope:e})})});break;case"heading":k.setHeading();break;case"html":f.value&&k.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&k.settingEl.addClass(f.scope_class)})}return u}o(sf,"render_settings_group");function TE(s,e,t){let n=s.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,pi.setIcon)(n,t.btn_icon),t.btn_text&&n.setText(t.btn_text),t.label&&n.setAttr("aria-label",t.label),n.addEventListener("click",async i=>{typeof t.callback=="function"?await mi(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),s.controlEl.appendChild(n)}o(TE,"render_heading_button");async function mi(s,e,t,n={}){let{scope:i=null}=n;return i?await t.call(i,e,s):await t(e,s)}o(mi,"handle_config_callback");function $L(s,e={}){let{container:t,group_name:n,settings_config:i,group_params:r={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(n,s,i,t,r))}o($L,"create_settings_group_rerender");function jL(s,e){return`<div class="model-settings" data-model-type="${s.collection_key}">
<div class="global-settings"></div>
</div>`}o(jL,"build_html");async function NE(s,e){let n=this.create_doc_fragment(jL.call(this,s,e)).firstElementChild;return TL.call(this,s,n,e),n}o(NE,"render");async function TL(s,e,t){let n=[],i=o(async r=>{this.empty(e);let[a]=Fd(s.env_config.settings_config,s,e,{default_group_name:`${s.model_type} models`,heading_btn:{btn_text:"+ New",callback:o((c,l)=>{Dd(s,c)},"callback")}});s.env.smart_components.render_component("settings_env_model",r,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(s.default),n.push(s.on_event("settings:changed",async r=>{let a=`${s.collection_key}.default_model_key`;r.path_string===a&&await i(s.default)})),n.push(s.on_event("model:changed",async()=>{await i(s.default)})),this.attach_disposer(e,n)}o(TL,"post_process");function NL(s,e){return`<div class="env-model-types">
${[s.embedding_models,s.chat_completion_models,s.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}o(NL,"build_html");async function PE(s,e){let n=this.create_doc_fragment(NL(s,e)).firstElementChild;return PL.call(this,s,n,e),n}o(PE,"render");async function PL(s,e,t){let n=e.querySelectorAll("div[data-collection-key]");for(let i of n){let r=i.getAttribute("data-collection-key"),a=s[r];s.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}o(PL,"post_process");var ME=require("obsidian");function Bd(s){s.settings||(s.settings={}),s.settings.smart_sources||(s.settings.smart_sources={});let e=s.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}o(Bd,"ensure_smart_sources_settings");function Tr(s=""){return s.split(",").map(e=>e.trim()).filter(Boolean)}o(Tr,"parse_exclusions_csv");function IE(s,e){let t=(e??"").trim();if(!t)return s||"";let n=Tr(s);return n.includes(t)||n.push(t),n.join(",")}o(IE,"add_exclusion");function LE(s,e){let t=(e??"").trim();return t?Tr(s).filter(i=>i!==t).join(","):s?.trim()||""}o(LE,"remove_exclusion");var Ud=class extends ME.FuzzySuggestModal{static{o(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Bd(this.env),t=Tr(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Bd(this.env);t.folder_exclusions=IE(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Bd(this.env),t=Tr(e.folder_exclusions),n=this.modalEl.querySelector(".sc-excluded-folders-header");if(n||(n=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(n)),n.empty(),n.createEl("h3").setText("Excluded folders"),!t.length){n.createEl("p").setText("No folders excluded yet.");return}let r=n.createEl("ul");t.forEach(a=>{let c=r.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=LE(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var zE=require("obsidian");var Wd=class extends zE.Modal{static{o(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,n=this.app.vault.getMarkdownFiles().filter(r=>r.path.length>200).map(r=>r.path);for(let r of t)e.createEl("li").setText(r);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let r of n)i.createEl("li").setText(r)}};async function IL(s,e={}){return`
<div class="sources-settings">
</div>
`}o(IL,"build_html");async function DE(s,e={}){let t=await IL.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return LL.call(this,s,i,e),i}o(DE,"render");async function LL(s,e,t={}){Fd({folder_exclusions:zL,view_exclusions:DL,re_import_sources:RL},s,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:o((r,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(s.events?.on("model:changed",ML(s,e))),this.attach_disposer(e,i),e}o(LL,"post_process");function ML(s,e){return async t=>{if(t.collection_key!=="embedding_models")return;let n=e.querySelector(".re-import-sources");n.classList.add("env-setting-highlight");let i=n.querySelector(".reimport-notice")?n.querySelector(".reimport-notice"):n.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",n.appendChild(i),s.events.once("sources:reimported",()=>{n.classList.remove("env-setting-highlight"),i.remove()})}}o(ML,"highlight_reset_data");var zL={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:o(async function(s,e){let t=this,n=new Ud(t.main.app,t),i=o(()=>{t.update_exclusions()},"selection_callback");n.open(i)},"callback")},DL={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:o(async function(s,e){let t=this;new Wd(t.main.app,t).open()},"callback")},RL={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:o(async function(s,e){let t=this,n=e.controlEl,i=n.createEl("div",{cls:"sc-inline-confirm-row"}),r=n.querySelector("button");r.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",r.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",r.style.display="inline-block"},{once:!0})},"callback")};function FL(s,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}o(FL,"build_html");async function RE(s,e={}){let n=this.create_doc_fragment(FL(s,e)).firstElementChild;return BL.call(this,s,n,e),n}o(RE,"render");async function BL(s,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),Dd(s.collection,l,_)});let i=e.querySelector(".delete-model-btn"),r=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{r.style.display=""}),c.addEventListener("click",async()=>{r.style.display="none"}),a.addEventListener("click",async()=>{await s.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}o(BL,"post_process");async function UL(s,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(s.notices.settings?.muted||{}).length)for(let n in s.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${n}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${n}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}o(UL,"build_html");async function FE(s,e={}){let t=await UL.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return WL.call(this,s,i,e),i}o(FE,"render");async function WL(s,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let r=i.closest(".muted-notice"),a=r.dataset.notice;s.notices.settings.muted[a]=!1,delete s.notices.settings.muted[a],r.remove()})})}o(WL,"post_process");var BE=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function HL(s,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}o(HL,"build_html");async function UE(s,e={}){this.apply_style_sheet(BE);let t=await HL.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return JL.call(this,s,i,e),i}o(UE,"render");async function JL(s,e,t={}){let n=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),r=e.querySelector(".notifications-container");return nf.call(this,"settings_env_sources",s,i),nf.call(this,"settings_env_models",s,n),nf.call(this,"settings_notifications",s,r),e}o(JL,"post_process");function nf(s,e,t){if(e.config.components[s]){let n=this.create_doc_fragment(`<div data-component="${s}"></div>`).firstElementChild;t.appendChild(n),e.smart_components.render_component(s,e).then(i=>{this.empty(n),n.appendChild(i)})}}o(nf,"render_if_available");var WE=require("obsidian");function VL(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}o(VL,"build_html");async function GE(s,e={}){let t=VL(),i=this.create_doc_fragment(t).firstElementChild;return KL.call(this,s,i,e),i}o(GE,"render");async function KL(s,e,t={}){let n=o(()=>{let r=e.querySelector(".sc-context-actions-left");this.empty(r);let a=e.querySelector(".sc-context-actions-right");this.empty(a),YL(s,a),XL(s,a),ZL(s,a),QL(s,a)},"render_ctx_actions");n();let i=[];return i.push(s.on_event("context:updated",n)),this.attach_disposer(e,i),e}o(KL,"post_process");function YL(s,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{s.emit_event("context_selector:open")})}o(YL,"render_btn_open_selector");function XL(s,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",s.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{s.actions.context_copy_to_clipboard()})}o(XL,"render_btn_copy_context");function ZL(s,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",s.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{s.clear_all(),s.emit_event("context:cleared")})}o(ZL,"render_btn_clear_context");function QL(s,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,WE.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),s.emit_event("context_selector:help")})}o(QL,"render_btn_help");var HE=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var Nr=require("obsidian");async function Gd(s){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(s);else if(Nr.Platform.isMobile)new Nr.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(s)}}catch(e){console.error("Failed to copy text:",e),new Nr.Notice("Failed to copy.")}}o(Gd,"copy_to_clipboard");var tM=o(s=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(s);return}setTimeout(s,0)},"schedule_next_frame"),sM=o(s=>{let e=!1;return()=>{e||(e=!0,tM(async()=>{e=!1,await s()}))}},"create_render_scheduler");function nM(s,e={}){return`<div>
<div class="sc-context-view" data-context-key="${s.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}o(nM,"build_html");async function JE(s,e={}){let t=nM(s,e);this.apply_style_sheet(HE);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return iM.call(this,s,i,e),i}o(JE,"render");async function iM(s,e,t={}){let n=[],i=o(async()=>{let d=e.querySelector(".sc-context-view-header");s.env.smart_components.render_component("smart_context_actions",s,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");s.env.smart_components.render_component("smart_context_tree",s,t).then(p=>{this.empty(_),_.appendChild(p)});let u=e.querySelector(".sc-context-view-footer");s.env.smart_components.render_component("smart_context_meta",s,t).then(p=>{this.empty(u),u.appendChild(p)})},"render_children"),r=sM(i),a=s.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,u)=>d.addEventListener(_,u)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(u=>u.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=oM(e);await Gd(p)})),_.showAtMouseEvent(d)}),await i(),n.push(s.on_event("context:updated",r)),this.attach_disposer(e,n),e}o(iM,"post_process");function oM(s){let e=[],t=o((n,i)=>{let r=n.dataset.path;if(!r)return;let a=r.replace(/^external:/,"").replace(/^selection:/,""),c=n.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(n.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else n.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);n.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return s.querySelectorAll(":scope > ul > li").forEach(n=>t(n,0)),e.join(`
`)}o(oM,"tree_dom_to_wikilinks");function rM(s){return Math.ceil((s||0)/4)}o(rM,"estimate_tokens");function aM(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}o(aM,"build_html");async function VE(s,e={}){let t=aM(),i=this.create_doc_fragment(t).firstElementChild;return cM.call(this,s,i,e),i}o(VE,"render");async function cM(s,e,t={}){let n=o(()=>{if(s?.has_context_items){let r=s.size||0,a=rM(r);e.textContent=`\u2248 ${r.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");n();let i=[];return i.push(s.on_event("context:updated",n)),this.attach_disposer(e,i),e}o(cM,"post_process");function KE(s,e,t=""){let{key:n,path:i,name:r,is_file:a}=s,c=t.trim()!=="",l="",d="",_="";n||(n=i),(e.has(n)||c)&&(l=`<span class="sc-context-item-remove" data-path="${n}">\xD7</span>`),e.has(n)&&!n.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${n}" title="Connections for ${r}"></span>`,_=`<span class="sc-tree-links" data-path="${n}" title="Links for ${r}"></span>`);let u=["sc-tree-label"];return s.exists===!1&&u.push("missing"),`<li data-path="${n}" class="sc-tree-item ${a?"file":"dir"}${n.startsWith("external:")?" sc-external":""}">
${l}
<span class="${u.join(" ")}">${r}</span>
${d}
${_}
${t}
</li>`}o(KE,"build_tree_item");function YE(s){let e=lM(s),t=new Set(s.map(i=>i.key||i.path));return XE(e,t)}o(YE,"build_tree_html");function lM(s=[]){let e=o(a=>a?.key||a?.path||"","get_item_key"),t=o(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,u=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),u=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),u=!0);let y=[];if(l){let g="",k=!1;for(let v=0;v<l.length;v++)!k&&l.slice(v,v+2)==="[["?(k=!0,g+="[[",v++):k&&l.slice(v,v+2)==="]]"?(k=!1,g+="]]",v++):!k&&l[v]==="/"?(y.push(g),g=""):g+=l[v];g&&y.push(g)}return _&&y.push(_),d&&y.push(d),{segments:y,has_block:u}},"split_path_segments"),n={name:"",children:{},selected:!1},i=o((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),r=s.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of s){let c=e(a),l=a?.exists;if(!c||i(c,r.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),u=n,p="";d.forEach((f,y)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=y===d.length-1,k=g&&_;u.children[f]||(u.children[f]={name:f,path:k?c:p,children:k?[]:{},selected:!1,is_file:k||g&&f.includes(".")}),u=u.children[f],g&&(u.selected=!0,u.exists=l)})}return n}o(lM,"build_path_tree");function XE(s,e){return!s.children||!Object.keys(s.children).length?"":`<ul>${Object.values(s.children).sort((n,i)=>n.is_file!==i.is_file?n.is_file?1:-1:n.name.localeCompare(i.name)).map(n=>KE(n,e,XE(n,e))).join("")}</ul>`}o(XE,"tree_to_html");var ZE=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var _M=o((s,e)=>!s||!e?!1:s===e||s.startsWith(`${e}/`)?!0:s.startsWith(`${e}#`),"is_nested_context_item");function QE(s,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(s?.data?.context_items||{}).filter(r=>_M(r,t));return[...new Set(i)]}o(QE,"get_nested_context_item_keys");var uM=o(s=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(s);return}setTimeout(s,0)},"schedule_next_frame"),mM=o(s=>{let e=!1;return()=>{e||(e=!0,uM(()=>{e=!1,s()}))}},"create_render_scheduler"),pM=o((s,e={})=>{let{target_path:t}=e,n=QE(s,{target_path:t});s.remove_items(n)},"remove_nested_context_items");function hM(s,e={}){return`
<div class="sc-context-tree" data-context-key="${s.data.key}"></div>
`}o(hM,"build_html");async function e1(s,e={}){this.apply_style_sheet(ZE);let t=hM(s,e),i=this.create_doc_fragment(t).firstElementChild;return fM.call(this,s,i,e),i}o(e1,"render");async function fM(s,e,t={}){let n=s?.env?.plugin,i=n?.registerDomEvent?.bind(n)||((l,d,_)=>l.addEventListener(d,_)),r=o(()=>{let l=s.env,d=s.context_items.filter(t.filter),_=YE(d),u=this.create_doc_fragment(_);this.empty(e),e.appendChild(u);for(let p=0;p<d.length;p++){let f=d[p],y=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!y){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(y),y.appendChild(g)})}},"render_tree_leaves"),a=mM(r);r(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");pM(s,{target_path:_})});let c=[];return c.push(s.on_event("context:updated",a)),this.attach_disposer(e,c),e}o(fM,"post_process");var t1=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function yM(s,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}o(yM,"build_html");async function s1(s,e={}){let t=yM(s,e),n=this.create_doc_fragment(t);return this.apply_style_sheet(t1),await bM.call(this,s,n,e),n}o(s1,"render");async function bM(s,e,t={}){let n=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!n)return e;let i=e.querySelector(".source-inspector-source-info"),r=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");r&&a&&c&&r.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(s.data,null,2),a.style.display="",r.textContent="Hide source data"):(a.style.display="none",r.textContent="Show source data")});let l=s.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=s.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!s||!s.blocks||s.blocks.length===0)return this.safe_inner_html(n,"<p>No blocks</p>"),e;let u=s.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',k=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',v="",b="";try{let S=await p.read();v=S.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),b=(await p.get_embed_input(S)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(S){console.error("[source_inspector] Error reading block:",S),v='<em style="color:red;">Error reading block content</em>'}let A=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${k}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${b}</pre>
</details>
<blockquote>${v}</blockquote>
<hr>
`);n.appendChild(A)}return e}o(bM,"post_process");var c1=require("obsidian");var hi=require("obsidian");var n1=require("obsidian");var Hd=class extends n1.Modal{static{o(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var i1=require("obsidian");var Jd=class extends i1.Modal{static{o(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function o1(s,e,t={}){let{Menu:n=hi.Menu}=t,i=s.main,r=o(a=>{a.preventDefault(),a.stopPropagation();let c=new n(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new hi.Notice("No active note found");return}let _=s.smart_sources?.get(d.path);if(!_){new hi.Notice("Active note is not indexed by Smart Environment");return}new Hd(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Jd(i.app,s).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{s.export_json(),new hi.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{s.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{s.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",r),r}o(o1,"register_status_bar_context_menu");function vM(s){let e=s?.session_events;if(!Array.isArray(e))return 0;let t=0;for(let n of e){let i=n?.event_key;typeof i=="string"&&i.startsWith("notification:")&&(t+=1)}return t}o(vM,"get_notification_event_count");function r1(s){let e=Object.keys(s?.smart_sources?.sources_re_import_queue||{}).length,t=vM(s?.event_logs),n=s?.is_pro?"Pro":s?.constructor?.version,i=`Smart Env${n?" "+n:""}`,r="Smart Environment status",a=null;return e>0?(i=`Embed now (${e})`,r="Click to re-import.",a="attention"):t>0&&(a=s?.event_logs?.notification_status||"info"),{message:i,title:r,indicator_count:t,indicator_level:a,embed_queue_count:e}}o(r1,"get_status_bar_state");var a1=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function wM(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}o(wM,"build_html");async function l1(s,e={}){this.apply_style_sheet(a1);let n=this.create_doc_fragment(wM()).firstElementChild;return xM.call(this,s,n,e),n}o(l1,"render");function xM(s,e,t={}){let n=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),r=e?.querySelector?.(".smart-env-status-msg"),a=o(()=>Object.keys(s?.smart_sources?.sources_re_import_queue||{}).length,"get_embed_queue"),c=o(()=>{let u=r1(s),{message:p,title:f,indicator_count:y,indicator_level:g}=u;n&&(0,c1.setIcon)(n,"smart-connections"),i&&(i._click_handler||(i._click_handler=k=>{k.stopPropagation(),s.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),y>0?i.dataset.count=String(y):i.dataset.count="",g?i.dataset.level=String(g):i.dataset.level="info"),r.setText?.(p),e.setAttribute?.("title",f),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=k=>{if(a()>0)k.preventDefault(),k.stopPropagation(),r?.setText?.("Embedding..."),s.run_re_import?.();else{let b=new MouseEvent("contextmenu",k);e.dispatchEvent?.(b)}},e.addEventListener("click",e._click_handler))},"render_status_elm");o1(s,e),c();let l=null,d=o(()=>{l&&clearTimeout(l),l=setTimeout(()=>{c(),l=null},100)},"debounce_refresh_status_bar"),_=[];_.push(s.events.on("*",d)),this.attach_disposer(e,_)}o(xM,"post_process");var d1=`.sc-modal-suggestion-right {\r
margin-left: auto;\r
text-align: right;\r
white-space: nowrap;\r
font-size: var(--font-ui-smaller);\r
color: var(--text-muted);\r
font-variant-numeric: tabular-nums;\r
float: right;\r
}`;function AM(s,e={}){return`<span class="sc-modal-suggestion-right" data-sc-display-right="true">${s}</span>`}o(AM,"build_html");function _1(s,e={}){return this.apply_style_sheet(d1),this.create_doc_fragment(AM(s,e)).firstElementChild}o(_1,"render");var u1=require("obsidian");function SM(s,e={}){let{plugin_name:t=s.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}o(SM,"build_html");function m1(s,e={}){let t=SM.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return CM.call(this,s,i,e),i}o(m1,"render");async function CM(s,e){let t=e.querySelector(".callout-icon"),n=(0,u1.getIcon)("hand-heart");n&&(this.empty(t),t.appendChild(n));let i=s.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:s.env})}o(CM,"post_process");var p1=require("obsidian");function OM(s,e={}){let{plugin_name:t=s.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}o(OM,"build_html");function h1(s,e={}){let t=OM.call(this,s,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),r=i.querySelector(".callout-icon"),a=(0,p1.getIcon)("smart-connections");return a&&(this.empty(r),r.appendChild(a)),qM.call(this,s,i,e),i}o(h1,"render");function qM(s,e){}o(qM,"post_process");var of=require("obsidian");async function f1(s={}){let e=this.context_items.filter(s.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new of.Notice("No context items to copy.");let t=await this.get_text(s);await Gd(t);let n=$M({item_count:e.length,char_count:t.length,max_depth:s.max_depth,exclusions:s.exclusions});this.emit_event("context:copied"),new of.Notice(n)}o(f1,"copy_to_clipboard");function $M(s={}){let e=Number.isFinite(s.item_count)?s.item_count:0,t=Number.isFinite(s.char_count)?s.char_count:0,n=[];n.push(`${e} file(s)`),n.push(`${jM(t)} chars`),Number.isFinite(s.max_depth)&&n.push(`depth\u2264${s.max_depth}`);let i=TM(s.exclusions);return i>0&&n.push(`${i} section(s) excluded`),`Copied to clipboard! (${n.join(", ")})`}o($M,"format_stats_message");function jM(s){return Number.isFinite(s)?s>=1e5?`~${Math.round(s/1e3)}k`:s.toLocaleString():"0"}o(jM,"format_char_count");function TM(s){return s?Object.values(s).reduce((e,t)=>{let n=Number.isFinite(t)?t:0;return e+n},0):0}o(TM,"sum_exclusions");var NM="xml_structured",Kd={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},g1=o((s={})=>{let e=s.template_preset||NM;return Kd[e]?e:"custom"},"get_preset_key"),Vd=o((s,e,t,n)=>{let i=g1(s),r=Kd[i],a=s?.[n];return i!=="custom"&&r&&typeof r[t]=="string"?r[t]:i==="custom"&&typeof a=="string"?a:e?.[n]},"get_template_value");function Yd(){return Object.entries(Kd).map(([s,e])=>({value:s,label:e.label||s}))}o(Yd,"get_template_preset_options");function y1(s={},e={}){return{template_before:Vd(s,e,"context_template_before","template_before"),template_after:Vd(s,e,"context_template_after","template_after")}}o(y1,"get_context_templates");function b1(s={},e={}){let t=g1(s),n=Kd[t],i=t==="custom"&&typeof s.json_stringify=="boolean";return{...n&&typeof n=="object"?n:{},...i?{json_stringify:s.json_stringify}:{},template_before:Vd(s,e,"item_template_before","template_before"),template_after:Vd(s,e,"item_template_after","template_after")}}o(b1,"get_item_templates");var PM=o((s="")=>{if(typeof s!="string"||s.trim().length===0)return"";let[e]=s.split(/[\\/]/).slice(-1),[t,...n]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return n.length>0?`${i}#${n.join("#")}`:i},"derive_item_name_from_key"),IM=o(s=>PM(s.key),"get_item_name");async function v1(s,e={}){let t={KEY:this.key,ITEM_NAME:IM(this),TIME_AGO:dh(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},n=o(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(u,p)=>t[p]||"");return c},"replace_vars"),i=b1(this.settings,rf);(e.json_stringify||i.json_stringify)&&(s=JSON.stringify(s));let r=await n(i.template_before),a=await n(i.template_after);return["",r,s,a,""].join(`
`)}o(v1,"merge_template");var k1={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:o(()=>Yd(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},rf={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Zd(s=[]){if(!Array.isArray(s)||s.length===0)return"";let e={};for(let t of s){let n=LM(t),i=t.split("/").filter(Boolean),r=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?n?r[c]=r[c]??{__isExplicitFolder:!0}:r[c]=null:r=r[c]??={}}}return Xd(e),w1(e).trimEnd()}o(Zd,"build_file_tree_string");function LM(s){return typeof s=="string"&&s.endsWith("/")}o(LM,"is_folder_path");function Xd(s){if(!(!s||typeof s!="object"))for(let e of Object.keys(s)){let t=s[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Xd(t);continue}let n=Object.keys(t);if(n.length===1&&t[n[0]]!==null&&!t[n[0]].__isExplicitFolder){let i=`${e}/${n[0]}`;s[i]=t[n[0]],delete s[e],Xd(s[i])}else Xd(t)}}}o(Xd,"compress_single_child_dirs");function w1(s,e=""){let t="",n=Object.entries(s).sort((i,r)=>{let a=i[1]!==null,c=r[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(r[0])});return n.forEach(([i,r],a)=>{let c=a===n.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";r===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=w1(r,e+(c?"    ":"\u2502   ")))}),t}o(w1,"build_tree_string");async function x1(s,e={}){let t=e.context_items||[],n={FILE_TREE:o(()=>Zd(t.map(l=>l.key)),"FILE_TREE")},i=o(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(u,p)=>n[p]?.()||"");return l},"replace_vars"),r=y1(this.settings,af),a=await i(r.template_before),c=await i(r.template_after);return[a,s,c].join(`
`)}o(x1,"merge_template");var E1={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:o(()=>Yd(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},af={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function Pr(s={}){s?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return s.source_key?e=this.env.smart_sources.get(s.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,n)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,r=Array.isArray(n.lines)&&n.lines.length?n.lines[0]:1/0;return i-r}).map(t=>({key:t.key,display:MM(t,{show_full_path:!1}),select_action:o(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:o(({modal:n})=>{n.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}o(Pr,"context_suggest_blocks");function MM(s,e={}){if(!s?.key)return"";if(e.show_full_path??!0)return s.key.replace(/#/g," > ").replace(/\//g," > ");let n=[],[i,...r]=s.key.split("#"),a=i.split("/").pop();if(n.push(a),r.length){let c=r[r.length-1];c.startsWith("{")&&c.endsWith("}")?(r.pop(),n.push(r.pop()),s.lines&&n.push(`Lines: ${s.lines.join("-")}`)):n.push(r.pop())}return n.filter(Boolean).join(" > ")}o(MM,"get_block_display_name");var A1="Add blocks";var C1="Named contexts";function zM(s){let t=s?.smart_contexts?.items;return!t||typeof t!="object"?[]:Object.values(t).filter(Boolean)}o(zM,"list_context_items");function O1(s,e){let t=[];for(let n=0;n<e.length;n+=1){let i=e[n];if(!i||typeof i.key!="string")continue;let r=Number.isFinite(i.d)?i.d:0,a=s?.data?.context_items?.[i.key],c=Number.isFinite(a?.d)?a.d:null;t.push({key:i.key,d:c===null?r:Math.min(c,r)})}return t}o(O1,"normalize_items_preserving_depth");function S1(s){let e=s?.key;return typeof e=="string"&&e.endsWith("#codeblock")}o(S1,"is_codeblock_context");function DM(s,e={}){let t=e.context_name;s?.data||(s.data={});let n=Array.isArray(s?.data?.codeblock_named_contexts)?s.data.codeblock_named_contexts:[],i=new Set(n);return t&&i.add(t),s.data.codeblock_named_contexts=[...i],s.data.codeblock_named_contexts}o(DM,"update_codeblock_named_contexts");function RM(s,e={}){let t=Array.isArray(e.items)?e.items:[],n=e.context_name;return O1(s,t).map(i=>({...i,from_named_context:n}))}o(RM,"build_codeblock_named_context_items");function FM(s,e={}){let t=e.other_ctx,n=e.context_name,i=q1(t),r=RM(s,{items:i,context_name:n});return DM(s,{context_name:n}),s.add_items(r),r}o(FM,"apply_codeblock_named_context");function q1(s){let e=s?.data?.context_items||{},t=Object.entries(e),n=[];for(let i=0;i<t.length;i+=1){let[r,a]=t[i];if(!r||a?.exclude)continue;let c=Number.isFinite(a?.d)?a.d:0;n.push({key:r,d:c})}return n}o(q1,"get_items_from_context");async function $1(s={}){let e=this,t=e?.env,n=s?.modal;n?.setInstructions&&n.setInstructions([{command:"Enter",purpose:"Merge selected context into current context"},{command:"Mod + Enter",purpose:"Open in Context Selector"}]);let i=zM(t).filter(a=>{let c=a?.data?.name;return typeof c=="string"&&c.trim().length>0}).sort((a,c)=>{let l=String(a.data.name).trim().toLowerCase(),d=String(c.data.name).trim().toLowerCase();return l.localeCompare(d)});if(!i.length)return[{key:"contexts:none",display:"No named contexts found"}];let r=[];for(let a=0;a<i.length;a+=1){let c=i[a],l=c?.key||c?.data?.key,d=String(c?.data?.name||"").trim();if(!!(e?.data?.context_items&&Object.values(e.data.context_items).some(p=>p?.from_named_context===d||p?.key===l)))continue;let u=c?.item_count||Object.keys(c?.data?.context_items||{}).length;r.push({key:`named_context:${l}`,display:`${d} (${u})`,item:c,select_action:o(({modal:p})=>{let f;if(S1(e))f=FM(e,{other_ctx:c,context_name:d});else{let y=q1(c);f=O1(e,y),e.add_items(f)}if(p?.setInstructions){let y=S1(e)?`Added ${d} as a codeblock named context`:`Merged ${f.length} item(s) from ${d}`;p.setInstructions([{command:"Enter",purpose:y}])}},"select_action"),mod_select_action:o(({modal:p})=>{p?.close&&p.close(),e.emit_event("context_selector:open",{collection_key:"smart_contexts",item_key:l})},"mod_select_action")})}return r}o($1,"context_suggest_contexts");var T1=require("obsidian");var BM=T1.Platform.isMacOS?"\u2318":"Ctrl";function UM(s){return typeof s!="string"?"":s.replace(/\/+$/g,"")}o(UM,"normalize_folder_path");function WM(s,e){let t=UM(e);return!t||s===t?!0:s.startsWith(`${t}/`)}o(WM,"is_source_in_folder");function j1(s){s?.inputEl&&(s.last_input_value=s.inputEl.value,s.inputEl.value="")}o(j1,"reset_modal_input");function GM(s,e){return Object.values(s.env?.smart_sources?.items||{}).filter(n=>WM(n.key,e))}o(GM,"get_sources_list");function HM(s,e){return e.map(t=>({key:t.key,display:t.key,select_action:o(()=>{s.add_item(t.key)},"select_action"),mod_select_action:o(({modal:n}={})=>(j1(n),Pr.call(s,{source_key:t.key,modal:n})),"mod_select_action"),arrow_right_action:o(({modal:n}={})=>(j1(n),Pr.call(s,{source_key:t.key,modal:n})),"arrow_right_action")}))}o(HM,"build_source_suggestions");function N1(s={}){console.log("context_suggest_sources",s);let e=s?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${BM} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=GM(this,s?.folder_path||"");return HM(this,t)}o(N1,"context_suggest_sources");var P1="Add sources";async function Qd(s){let e=s.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let n=await t.embed(e);return s.to_item={...n},s.score_algo_key||(s.score_algo_key="similarity"),s}o(Qd,"pre_process");function cf(s){return this.vec?s.to_item?.vec?{score:Is(this.vec||[],s.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}o(cf,"similarity");cf.action_type="score";var lf="Cosine Similarity",df="Ranks by cosine similarity between the current note and candidates.",I1={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${lf} algorithm`,value:`${df}`}};async function L1(s=null){await Ll(this,s)}o(L1,"source_open");var M1={collections:{embedding_models:K0,lookup_lists:Jn},item_types:{EmbeddingModel:Us,LookupList:Vt},items:{embedding_model:{class:Us},lookup_list:{class:Vt}},modules:{},components:{collection_settings:{render:Y0},context_item_leaf:{render:Q0},env_stats:{render:eE},form_dropdown:{render:Yh},lean_coffee_callout:{render:nE},milestones:{render:cE},notifications_feed:{render:lE},pro_plugins_list:{render:xE},pro_plugins_list_item:{render:EE},settings_env_model:{render:OE},settings_env_model_type:{render:NE},settings_env_models:{render:PE},settings_env_sources:{render:DE},settings_model_actions:{render:RE},settings_notifications:{render:FE},settings_smart_env:{render:UE},smart_context_actions:{render:GE},smart_context_item:{render:JE},smart_context_meta:{render:VE},smart_context_tree:{render:e1},source_inspector:{render:s1},status_bar:{render:l1},suggest_display_right:{render:_1},supporter_callout:{render:m1},user_agreement_callout:{render:h1}},actions:{context_copy_to_clipboard:{action:f1},context_item_merge_template:{action:v1,settings_config:k1,default_settings:rf},context_merge_template:{action:x1,settings_config:E1,default_settings:af},context_suggest_blocks:{action:Pr,display_name:A1},context_suggest_contexts:{action:$1,display_name:C1},context_suggest_sources:{action:N1,display_name:P1},lookup_list_pre_process:{action:Qd,pre_process:Qd},similarity:{action:cf,settings_config:I1,display_name:lf,display_description:df},source_open:{action:L1}}};var JM={env_path:"",modules:{smart_fs:{class:Fl,adapter:Bl},smart_view:{class:Jl,adapter:Kl},smart_embed_model:{class:or,adapters:{transformers:ri,openai:hd,ollama:yd,gemini:bd,lm_studio:vd}},smart_chat_model:{class:ar,adapters:{anthropic:cr,azure:_r,custom:wr,google:ci,gemini:pr,groq:xr,lm_studio:fr,ollama:br,open_router:hr,openai:Bs,xai:Er,deepseek:Ar},http_adapter:new _t({adapter:oi,obsidian_request_url:_f.requestUrl})},http_adapter:{class:_t,adapter:oi,obsidian_request_url:_f.requestUrl}},collections:{context_items:R0,event_logs:B0,smart_components:I0,smart_contexts:z0,smart_sources:{collection_key:"smart_sources",class:Qo,data_adapter:sr,source_adapters:{md:zs,txt:zs,"excalidraw.md":cd,base:od,canvas:ad,rendered:rd},content_parsers:[$0],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:ir,data_adapter:ld,block_adapters:{md:ei,txt:ei,"excalidraw.md":ei}}},item_types:{SmartSource:Zn,SmartBlock:Qn},items:{smart_source:m0,smart_block:v0},default_settings:H0,modals:{context_selector:{class:Nd,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:Id},notifications_feed_modal:{class:Pd}}};qt(JM,M1);var VM=require("obsidian");var KM=require("obsidian");var XM=require("obsidian");var YM=require("obsidian");function e_(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}o(e_,"get_smart_server_url");function z1(s){return{token:localStorage.getItem(s+"token")||"",refresh:localStorage.getItem(s+"refresh")||""}}o(z1,"get_local_storage_token");var ZM="_smart_plugins_oauth_";function D1(s){return`${String(s||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${ZM}`}o(D1,"build_oauth_storage_prefix");var t4=require("obsidian");var e4=require("obsidian");var F1=require("obsidian");var J1=require("obsidian"),ve=require("@codemirror/view"),s_=require("@codemirror/state");var uf=o((s,e)=>Number.isInteger(e)&&e>0&&e<=s.lines,"line_exists");function B1(s={}){let e=typeof s.ttl_ms=="number"?s.ttl_ms:1e4,t=new Map;return{set:o(({key:r,value:a})=>{t.set(r,{timestamp:Date.now(),value:a})},"write_entry"),get:o(({key:r})=>{if(!t.has(r))return null;let a=t.get(r);return Date.now()-a.timestamp>e?(t.delete(r),null):a.value},"read_entry"),clear:o(()=>t.clear(),"clear")}}o(B1,"create_inline_cache");function U1(s){let e=s.settings??{},t=e.inline_connections_score_threshold??"",n=e.score_algo_key??"",i=e.results_collection_key??"";return`${s.block_key}|${s.block_hash}|${n}|${i}|${t}`}o(U1,"make_cache_key");function W1(s){let e=typeof s?.buffer=="number"?s.buffer:0,t=e>0?Math.floor(e):0,n=s?.doc;if(!n||typeof n.length!="number"||typeof n.lineAt!="function")return{min_line:1,max_line:1};let i=Number(n.length)||0;if(i===0)return{min_line:1,max_line:1};let r=o(_=>(_=Number(_),!Number.isFinite(_)||_<0?0:_>i?i:_),"clamp"),c=(Array.isArray(s.ranges)&&s.ranges.length?s.ranges:[{from:0,to:i}]).reduce((_,u)=>{let p=r(u.from),f=r(u.to),y=n.lineAt(p).number,g=n.lineAt(f).number;return{start:Math.min(_.start,y),end:Math.max(_.end,g)}},{start:Number.POSITIVE_INFINITY,end:0}),l=Math.max(1,c.start-t),d=c.end+t;return{min_line:l,max_line:d}}o(W1,"get_visible_window");function n4(s,e){if(!s||!e)return!1;let t=Number(s.start),n=Number(s.end),i=Number(e.start),r=Number(e.end);return!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(i)||!Number.isFinite(r)||t>n||i>r?!1:t<=r&&i<=n}o(n4,"ranges_overlap");function G1(s,e){if(!Array.isArray(s)||!s.length)return!1;for(let t of s){if(!Array.isArray(t)||t.length<2)continue;let[n,i]=t;if(n4({start:n,end:i},e))return!0}return!1}o(G1,"any_range_overlaps");var i4=typeof window<"u"?window:globalThis,o4=o(s=>{let e=i4?.requestIdleCallback;return typeof e=="function"?e(s,{timeout:250}):setTimeout(()=>s({timeRemaining:o(()=>0,"timeRemaining"),didTimeout:!0}),16)},"request_idle_default"),H1=o(({request_idle_fn:s=o4,max_concurrent:e=1}={})=>{let t=0,n=[],i=o(()=>{if(t>=e||!n.length)return;let{job:a,resolve:c,reject:l}=n.shift();t+=1,s(()=>{Promise.resolve().then(a).then(c,l).finally(()=>{t-=1,i()})})},"drain_queue");return{enqueue_job:o(a=>new Promise((c,l)=>{n.push({job:a,resolve:c,reject:l}),i()}),"enqueue_job")}},"create_job_scheduler");var mf=s_.StateEffect.define(),r4=s_.StateField.define({create:o(()=>ve.Decoration.none,"create"),update:o((s,e)=>{for(let t of e.effects)if(t.is(mf))return t.value;return e.docChanged?s.map(e.changes):s},"update"),provide:o(s=>ve.EditorView.decorations.from(s),"provide")}),{enqueue_job:a4}=H1({max_concurrent:2}),c4=1e4,l4=40,t_=B1({ttl_ms:c4}),pf=class extends ve.WidgetType{static{o(this,"BadgeWidget")}constructor({block_key:e,plugin:t,block_hash:n}){super(),this.block_key=e,this.block_hash=n,this.plugin=t,this.plugin.env.create_env_getter(this),this._checked=!1,this._pending=null}eq(e){return e.block_key===this.block_key&&e.block_hash===this.block_hash}toDOM(){let e=document.createElement("span");e.className="sc-block-badge sc-loading",e.title="Connections",e.dataset.blockKey=this.block_key,e.style.cssText="cursor:pointer;user-select:none;opacity:0;position:absolute;top:0;right:-1rem;",e.appendChild((0,J1.getIcon)("smart-connections"));let t=new IntersectionObserver(n=>{n[0].isIntersecting&&(t.disconnect(),this._check_connections(e))},{root:null,threshold:0,rootMargin:"200px 0px"});return t.observe(e),requestAnimationFrame(()=>{if(!e.isConnected)return;let n=e.getBoundingClientRect();n.bottom>0&&n.top<window.innerHeight&&n.right>0&&n.left<window.innerWidth&&this._check_connections(e)}),e.addEventListener("mouseenter",async()=>{this._checked||await this._check_connections(e),e.classList.contains("sc-has-hits")&&this._show_popover(e)}),e}ignoreEvent(){return!1}get connections_list(){return this.block?.connections||this.env.connections_lists.new_item(this.block)}async _check_connections(e){if(!this._checked){this._pending||(this._pending=a4(()=>this.#t(e)));try{await this._pending}finally{this._pending=null}}}async#t(e){if(!this.block||!e.isConnected){try{e.remove()}catch{}return}let t=this.env?.connections_lists,n=t?.settings||{},i=n.inline_connections_score_threshold?parseFloat(n.inline_connections_score_threshold):.8,r=U1({block_key:this.block_key,block_hash:this.block_hash,settings:n}),a=t_.get({key:r});if(a){this.#e(e,a.ok,a.items);return}let l=this.connections_list.filter_and_score({limit:10,score_algo_key:t.score_algo_key,results_collection_key:t.results_collection_key,to_item:this.block,filter:{exclude_keys:[this.block.source_key],exclude_key_starts_with_any:[this.block.source_key]}}).filter(_=>_.score>=i),d=l.length>0;t_.set({key:r,value:{ok:d,items:l}}),this.#e(e,d,l)}#e(e,t,n){if(this._checked=!0,!t){e.style.display="none";try{e.remove()}catch{}return}e.style.transition="opacity 0.5s ease-in-out",e.style.opacity=1,e.classList.remove("sc-loading"),e.classList.add("sc-has-hits"),e._inline_results=n}get block(){return this.env.smart_blocks.get(this.block_key)}async _show_popover(e){if(e._popover||!this.block)return;let t=await this.env.render_component("inline_connections_popover",this,{precomputed_items:e._inline_results});document.body.appendChild(t),d4(t,e),e._popover=t;let n=null,i=o(()=>n=setTimeout(a,300),"schedule_hide"),r=o(()=>n&&clearTimeout(n),"cancel_hide"),a=o(()=>{try{t.remove()}catch{}e._popover=null},"close");e.addEventListener("mouseleave",i,{once:!0}),t.addEventListener("mouseenter",r),t.addEventListener("mouseleave",i),e.removeAttribute("title")}},hf=ve.ViewPlugin.fromClass(class{constructor(s){this.view=s,window.smart_env.create_env_getter(this),this.plugin=this.env?.smart_connections_plugin,this.badges=ve.Decoration.none,this.is_ready=!1,this.off_settings=this.env?.events?.on?.("settings:changed",()=>t_.clear()),this.off_opened=this.env?.events?.on?.("sources:opened",()=>{t_.clear(),this.schedule_refresh(0)}),setTimeout(()=>{this.is_ready=!0,this.schedule_refresh(0)},1300)}schedule_refresh(s=300){clearTimeout(this.timer),this.timer=setTimeout(()=>this.refresh(),s)}update(s){(s.docChanged||s.selectionSet||s.viewportChanged)&&this.schedule_refresh(150)}async refresh(){let{plugin:s,view:e}=this;if(!this.is_ready){this.schedule_refresh(200);return}let t=s?.env?.connections_lists?.settings;if(!t?.inline_connections){this.badges=ve.Decoration.none;try{requestAnimationFrame(()=>e.dispatch({effects:[mf.of(this.badges)]}))}catch(d){console.error("[Smart Connections] Decoration clear failed",d)}return}if(!this.env||this.env.state!=="loaded"){this.schedule_refresh();return}let n=s.app.workspace.getActiveFile();if(!n)return;let i=this.env.smart_sources.items[n.path],r=Array.isArray(i?.data?.codeblock_ranges)?i.data.codeblock_ranges:[],a=(i?.blocks??[]).filter(d=>d.vec),c=W1({doc:e.state.doc,ranges:e.visibleRanges,buffer:l4}),l=[];for(let d of a){let _=d.line_start;if(_<c.min_line||_>c.max_line||!uf(e.state.doc,_))continue;let u=d.line_end??_+1;if(!uf(e.state.doc,u)||t?.inline_connections_skip_codeblocks&&G1(r,{start:_,end:u}))continue;let p=e.state.doc.line(_),f=p.to;if(f>e.state.doc.length)continue;let y=e.state.doc.line(u),g=e.state.doc.sliceString(p.from,y.to),k=Ml(g);d.data.last_read?.hash===k&&l.push(ve.Decoration.widget({side:1,widget:new pf({block_key:d.key,plugin:s,block_hash:k})}).range(f))}this.badges=l.length?ve.Decoration.set(l,!0):ve.Decoration.none;try{requestAnimationFrame(()=>this.view.dispatch({effects:[mf.of(this.badges)]}))}catch(d){console.error("[Smart Connections] Decoration dispatch failed",d)}}destroy(){clearTimeout(this.timer);try{this.off_settings?.()}catch{}try{this.off_opened?.()}catch{}}});function d4(s,e){let t=e.getBoundingClientRect(),n=s.getBoundingClientRect(),i=t.right+6,r=t.top;i+n.width>window.innerWidth&&(i=Math.max(t.left-n.width-6,0)),r+n.height>window.innerHeight&&(r=Math.max(window.innerHeight-n.height-8,0)),s.style.left=`${i}px`,s.style.top=`${r}px`}o(d4,"show_popover_relative_to_anchor");var V1=o(()=>[r4,hf],"connections_inline_extension");var I=require("obsidian");function _4(s,e){let n=s.score-e.score;return Math.abs(n)<1e-9?0:n>0?-1:1}o(_4,"sort_by_score");function K1(s,e){return _4(s,e)}o(K1,"sort_by_score_descending");function X1(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.min===Number.POSITIVE_INFINITY){let{minScore:n,minObj:i}=Y1(s.results);s.min=n,s.minResult=i}}else if(e.score>s.min){s.results.add(e),s.results.delete(s.minResult);let{minScore:n,minObj:i}=Y1(s.results);s.min=n,s.minResult=i}}o(X1,"results_acc");function Y1(s){let e=Number.POSITIVE_INFINITY,t=null;for(let n of s)n.score<e&&(e=n.score,t=n);return{minScore:e,minObj:t}}o(Y1,"find_min");var Ir="score_connection",Z1="Returns the connection score between two files.",Q1="Score Connection",eA=o(s=>{if(!s.app.internalPlugins.plugins?.bases?.enabled)return;let t=o((c,l)=>{try{let d=globalThis.smart_env||{};if(d.state!=="loaded")return new I.StringValue("Smart Env not ready.");let _=d.smart_sources;if(!_)return new I.StringValue("Smart Sources not ready.");let u=ff(c),p=ff(l);if(!u)return new I.StringValue("Missing item a.");if(!p)return new I.StringValue("Missing item b.");let{metadata_cache:f}=s.app,y=s.app.vault.getAbstractFileByPath(u)??f.getFirstLinkpathDest(u,""),g=s.app.vault.getAbstractFileByPath(p)??f.getFirstLinkpathDest(p,"");if(!y)return new I.StringValue(`File not found: ${u}`);if(!g)return new I.StringValue(`File not found: ${p}`);let k=_.get(y.path),v=_.get(g.path);if(!k)return new I.StringValue(`No Smart Source for: ${u}`);if(!v)return new I.StringValue(`No Smart Source for: ${p}`);if(!k.vec)return new I.StringValue(`No embedding for: ${u}`);if(!v.vec)return new I.StringValue(`No embedding for: ${p}`);let b=d.connections_lists.score_algo_key,A={to_item:v,score_algo_key:b},{score:S}=k.score(A);return new I.NumberValue(Number.isFinite(S)?Math.round(S*100)/100:0)}catch(d){return console.error("Error in score_connection:",d),new I.StringValue("Error computing connection score, see console for details.")}},"score_connections_handler");s.registerGlobalFunc({name:Ir,params:[{name:"file",type:[I.Value,I.FileValue,I.StringValue]},{name:"compared_to",type:[I.Value,I.FileValue,I.StringValue]}],docString:Z1,ctx:null,applyWithContext(c,...l){return t(...l)}}),s.registerInstanceFunc(I.FileValue,{name:Ir,params:[{name:"self",type:[I.Value,I.FileValue]},{name:"compared_to",type:[I.Value,I.FileValue,I.StringValue]}],docString:Z1,ctx:null,applyWithContext(c,...l){return console.log("score_connections_handler ctx and args:",{_ctx:c,args:l}),t(...l)}});let n=o(c=>{try{let d=globalThis.smart_env||{};if(d.state!=="loaded")return new I.StringValue("Smart Env not ready.");let _=d.smart_sources;if(!_)return new I.StringValue("Smart Sources not ready.");let u=ff(c);if(!u)return new I.StringValue("Missing item.");let{metadata_cache:p}=s.app,f=s.app.vault.getAbstractFileByPath(u)??p.getFirstLinkpathDest(u,"");if(!f)return new I.StringValue(`File not found: ${u}`);let y=_.get(f.path);if(!y)return new I.StringValue(`No Smart Source for: ${u}`);if(!y.vec)return new I.StringValue(`No embedding for: ${u}`);let g=d.connections_lists.score_algo_key,k={to_item:y,score_algo_key:g},v=[],{results:b}=Object.values(_.items).reduce((j,C)=>{let x=C.filter_and_score({...k,filter:{exclude_keys:[y.key]}});return x?.score?(X1(j,x,5),j):(x?.error&&v.push(x.error),j)},{min:0,results:new Set}),A=Array.from(b).sort(K1);console.log("connections_list_handler results:",A);let S=A.map(j=>I.LinkValue.parseFromString(s.app,`[[${j.item.key}|${j.score?.toFixed(2)??"n/a"} ${j.item.name}]]`));console.log("connections_list_handler links:",S);let $=new I.ListValue(S);return console.log("connections_list_handler list:",$),$}catch(d){return console.error("Error in connections_list:",d),new I.StringValue("Error retrieving connections list, see console for details.")}},"connections_list_handler");s.registerGlobalFunc({name:"list_connections",params:[{name:"file",type:[I.Value,I.FileValue,I.StringValue]}],docString:"Returns a list of top 5 connections for the given file.",ctx:null,applyWithContext(c,...l){return n(...l)}}),s.registerInstanceFunc(I.FileValue,{name:"list_connections",params:[{name:"self",type:[I.Value,I.FileValue]}],docString:"Returns a list of top 5 connections for the given file.",ctx:null,applyWithContext(c,...l){return n(...l)}});let i=s.app.workspace,r=i.operatorFuncConfigs?.bases||[];r.some(c=>c?.funcName===Ir)||i.registerOperatorFuncConfigs("bases",[...r,{funcName:Ir,display:Q1,inverseDisplay:"Inverse "+Q1}]),s.register(()=>{i?.unregisterOperatorFuncConfigs?.("bases",[Ir])})},"register_bases_integration"),ff=o(s=>{if(s){if(typeof s=="string")return s;if(typeof s=="object"){let e=s;if(typeof e.path=="string")return e.path;if(typeof e.value=="string")return e.value;if(typeof e.file=="string")return e.file;if(e.file&&typeof e.file.path=="string")return e.file.path;if(e.file?.file&&typeof e.file.file.path=="string")return e.file.file.path;if(typeof e.data=="string")return e.data}}},"value_to_path");var t0e=Object.getPrototypeOf(async function(){}).constructor;var sA=require("obsidian");var h4=o((s,e)=>{let t=e.getActiveFile();return t&&s.smart_sources?.get(t.path)||null},"get_active_entity"),tA=o(s=>{try{if(!s?.state?.doc)return!1;let e=s.state.doc,t=e.line(e.lines),n=t.from,i=t.to;return(Array.isArray(s.visibleRanges)?s.visibleRanges:[]).some(r=>r.from<=i&&r.to>=n)}catch(e){return console.warn("[Smart Connections] last-line visibility check failed",e),!1}},"is_last_line_visible"),n_=class{static{o(this,"ConnectionsFooterView")}constructor(e){this.plugin=e,this.app=e.app,this.register_env_listeners(),this.container_map={},this._detach_visibility_guard=null}get env(){return this.plugin.env}attach_visibility_guard(e){if(this.detach_visibility_guard(),!e)return;let t=e.scrollDOM||e.dom||null;if(!t)return;let n=!1,i=o(()=>{n||(n=!0,requestAnimationFrame(()=>{n=!1,tA(e)&&(this.detach_visibility_guard(),this.render_view())}))},"check_and_render"),r=o(()=>i(),"on_scroll"),a=o(()=>i(),"on_resize");t.addEventListener("scroll",r,{passive:!0}),window.addEventListener("resize",a),this._detach_visibility_guard=()=>{try{t.removeEventListener("scroll",r)}catch{}try{window.removeEventListener("resize",a)}catch{}this._detach_visibility_guard=null}}detach_visibility_guard(){typeof this._detach_visibility_guard=="function"&&this._detach_visibility_guard()}async render_view(){if(!this.env.connections_lists?.settings?.footer_connections)return this.remove();let e=this.plugin.get_editor_view();if(!e)return;if(!tA(e)){try{e.dispatch({effects:[Ts.of(null)]})}catch(i){console.warn("[Smart Connections] footer hide dispatch failed",i)}this.attach_visibility_guard(e);return}this.detach_visibility_guard();let t=h4(this.env,this.app.workspace);if(!t){e.dispatch({effects:[Ts.of(null)]});return}if(this.container_map[t.key]?.isConnected){e.dispatch({effects:[Ts.of(this.container_map[t.key])]});return}let n=await this.env.render_component("connections_footer_view",this,{connections_item:t});if(this.container_map[t.key]&&this.container_map[t.key]instanceof HTMLElement&&this.container_map[t.key].remove(),this.container_map[t.key]=n,e.dispatch({effects:[Ts.of(n)]}),sA.Platform.isMobile){let i=this.container_map[t.key],r=i.querySelector(".status-bar-mobile")??i.createDiv({cls:"status-bar-mobile"});r.empty();let a=r.createDiv({cls:"status-bar-item"});this.env.smart_components.render_component("status_bar",this.env).then(c=>a.appendChild(c))}}remove(){let e=this.plugin.get_editor_view();if(this.detach_visibility_guard(),e)try{e.dispatch({effects:[Ts.of(null)]})}catch(t){console.warn("[Smart Connections] footer remove dispatch failed",t)}}register_env_listeners(){let e;this.register_env_listener("sources:opened",(t={})=>{e&&clearTimeout(e),e=setTimeout(()=>{this.render_view()},250)}),this.register_env_listener("settings:changed",t=>{t.path?.includes("connections_lists")&&this.render_view()})}register_env_listener(e,t){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on(e,t))}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}unload(){this.detach_visibility_guard(),this.env_listeners&&(this.env_listeners.forEach(e=>e()),this.env_listeners=[])}};var nA=require("obsidian");var i_=class{static{o(this,"ConnectionsCodeblock")}constructor(e){this.plugin=e,this.app=e.app,this.plugin.env.create_env_getter(this),this.register_env_listeners()}async render(e,t,n){t.empty(),t.createEl("span",{text:"Loading\u2026"});let i=this.env.smart_sources.get(n.sourcePath)??this.env.smart_sources.init_file_path(n.sourcePath);if(!i){t.empty(),t.createEl("p",{text:"Entity not found: "+n.sourcePath});return}let r=e,a=JSON.parse(e.trim()||"{}"),c=await this.env.smart_components.render_component("connections_codeblock",this,{connections_item:i,connections_settings:a});t.empty(),t.appendChild(c),r!==e&&f4(n,r)}register_env_listeners(){this.register_env_listener("settings:changed",e=>{e.path?.includes("connections_lists")&&this.render()})}register_env_listener(e,t){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on(e,t))}open_settings(){new gf(this.app,this.env,this.connections_settings).open()}};function f4(s,e){if(typeof s.replaceCode=="function")return s.replaceCode(e.trim()+`
`)}o(f4,"update_codeblock");var gf=class extends nA.Modal{static{o(this,"ConnectionsCodeblockModal")}constructor(e,t,n={}){super(e),this.env=t,this.connections_settings=n}async onOpen(){this.titleEl.setText("Connections Codeblock"),this.contentEl.empty(),console.log("Opening ConnectionsCodeblockModal with codeblock_ctx:",this.connections_settings);let e=await this.env.smart_view.render_settings(this.env.connections_lists.settings_config,{scope:{settings:this.connections_settings}});this.contentEl.appendChild(e)}};function g4(s){return s?String(s).trim().replace(/^v/i,""):""}o(g4,"normalize_version");function iA(s){let e=g4(s);if(!e)return{core:[],prerelease:""};let[t,n=""]=e.split("-",2);return{core:t.split(".").map(r=>{let a=Number.parseInt(r,10);return Number.isNaN(a)?0:a}),prerelease:n}}o(iA,"split_version");function y4(s,e){let t=iA(s),n=iA(e);if(!(n.core.length>0||n.prerelease.length>0))return 0;if(!(t.core.length>0||t.prerelease.length>0))return 1;let a=Math.max(t.core.length,n.core.length);for(let d=0;d<a;d+=1){let _=t.core[d]??0,u=n.core[d]??0;if(u>_)return 1;if(u<_)return-1}let c=t.prerelease.length>0,l=n.prerelease.length>0;return c&&!l?1:!c&&l?-1:!c&&!l||n.prerelease===t.prerelease?0:n.prerelease>t.prerelease?1:-1}o(y4,"compare_versions");function oA(s,e){return y4(s,e)>0}o(oA,"should_notify_update");var ce=require("obsidian");var Lr="smart_tasks",rA="Smart Tasks",aA="Returns number of tasks using Smart Environment.",cA=o(s=>{if(!s.app.internalPlugins.plugins?.bases?.enabled)return;let t=o(a=>{try{let l=globalThis.smart_env||{};if(l.state!=="loaded")return new ce.StringValue("Smart Env not ready.");let d=l.smart_sources;if(!d)return new ce.StringValue("Smart Sources not ready.");let _=b4(a);if(!_)return new ce.StringValue("Missing item.");let{metadata_cache:u}=s.app,p=s.app.vault.getAbstractFileByPath(_)??u.getFirstLinkpathDest(_,"");if(!p)return new ce.StringValue(`File not found: ${_}`);let f=d.get(p.path);if(!f)return new ce.StringValue(`No Smart Source for: ${_}`);let y=f.data?.tasks?.incomplete?.top||[],g=Object.entries(f.data?.blocks||{}).filter(([b,A])=>!!b.includes("next")),k=y.filter(b=>g.some(([A,S])=>b>=S[0]&&b<=S[1])),v={all:f.data?.task_lines?.length||0,incomplete:f.data?.tasks?.incomplete?.all?.length||0,incomplete_top:y?.length||0,next:k?.length||0};return new ce.ObjectValue(v)}catch(l){return console.error("Error in smart_tasks:",l),new ce.StringValue("Error retrieving tasks count, see console for details.")}},"tasks_count");s.registerGlobalFunc({name:Lr,params:[{name:"file",type:[ce.Value,ce.FileValue,ce.StringValue]}],docString:aA,ctx:null,applyWithContext(a,...c){return t(...c)}}),s.registerInstanceFunc(ce.FileValue,{name:Lr,params:[{name:"self",type:[ce.Value,ce.FileValue]}],docString:aA,ctx:null,applyWithContext(a,...c){return t(...c)}});let n=s.app.workspace,i=n.operatorFuncConfigs?.bases||[];i.some(a=>a?.funcName===Lr)||n.registerOperatorFuncConfigs("bases",[...i,{funcName:Lr,display:rA,inverseDisplay:"Inverse "+rA}]),s.register(()=>{n?.unregisterOperatorFuncConfigs?.("bases",[Lr])})},"register_bases_tasks_integration"),b4=o(s=>{if(s){if(typeof s=="string")return s;if(typeof s=="object"){let e=s;if(typeof e.path=="string")return e.path;if(typeof e.value=="string")return e.value;if(typeof e.file=="string")return e.file;if(e.file&&typeof e.file.path=="string")return e.file.path;if(e.file?.file&&typeof e.file.file.path=="string")return e.file.file.path;if(typeof e.data=="string")return e.data}}},"value_to_path");var fi=require("obsidian");function lA(s="",e,t=""){if(!e)return s??"";let n=t||e.split("/").pop().replace(/\.md$/i,""),i=e==="this.file.file"?"this.file.file":`"${e}"`,r=`  ${n}: score_connection(file.file, ${i})`,a=`  formula.${n}: ${n}`,c=`      - formula.${n}`,l=(s??"").split(/\r?\n/),d=l.findIndex(_=>/^formulas:\s*$/i.test(_));if(d===-1?l.unshift("formulas:",r):l.some(_=>_.trimStart()===r.trimStart())||(d=yf(l,d,/^\s{2}\S/),l.splice(d+1,0,r)),d=l.findIndex(_=>/^display:\s*$/i.test(_)),d===-1){let _=l.findIndex(p=>/^formulas:\s*$/i.test(p)),u=yf(l,_,/^\s{2}\S/)+1;l.splice(u,0,"display:",a)}else l.some(_=>_.trimStart()===a.trimStart())||(d=yf(l,d,/^\s{2}\S/),l.splice(d+1,0,a));if(d=l.findIndex(_=>/^views:\s*$/i.test(_)),d===-1)l.push("views:","  - type: table","    name: Table","    order:","      - file.name",c);else{let _=-1;for(let u=d+1;u<l.length;u++)if(/^\s*-\s+type:\s+table/i.test(l[u])){if(_=l.findIndex((p,f)=>f>u&&/^\s*order:\s*$/i.test(p)),_===-1){let p=l.findIndex((y,g)=>g>u&&/^\s*name:\s+/i.test(y)),f=p!==-1?p+1:u+1;l.splice(f,0,"    order:","      - file.name",c)}break}_!==-1&&!l.some(u=>u.trimStart()===c.trimStart())&&l.splice(_+1,0,c)}return l.filter(_=>_.trim()).join(`
`).trim()}o(lA,"insert_score_connection_column");var yf=o((s,e,t)=>{let n=e+1;for(;n<s.length&&t.test(s[n]);)n++;return n-1},"find_block_end"),bf=o(s=>!!s&&s.extension==="base","is_base_file");var vf=class extends fi.FuzzySuggestModal{static{o(this,"ConnectionsScoreColumnModal")}constructor(e){super(e),this.items=["Current/active file (dynamic)",...Object.keys(window.smart_env?.smart_sources?.items||{})],this.setPlaceholder("Select note for similarity\u2026")}getItems(){return this.items}getItemText(e){return e}onChooseItem(e){this.#t(e)}async#t(e){let t=this.app.workspace.getActiveFile();if(!bf(t)){new fi.Notice("No active .base file");return}let n;e==="Current/active file (dynamic)"&&(e="this.file.file",n="score");let i=await this.app.vault.read(t),r=lA(i,e,n);if(i===r){new fi.Notice("Connections score column already present");return}await this.app.vault.modify(t,r),this.#e(),new fi.Notice(`Added score_connection column for ${e}`)}#e(){this.app.workspace.getLeavesOfType("bases").forEach(e=>e.isVisible()&&e.rebuildView())}};function dA(s){s.addCommand({id:"sc-add-connections-score-column",name:"Add: Connections score bases column",checkCallback:o(e=>{let t=bf(s.app.workspace.getActiveFile());return e?t:t?(new vf(s.app).open(),!0):!1},"checkCallback")})}o(dA,"register_connections_score_command");var Gs=require("obsidian");var _A="duplicate_blocks_modal_v1",xf=.9,v4=20,kf=class extends Gs.Modal{static{o(this,"DuplicateBlocksResultsModal")}constructor(e,t={}){super(e),this.plugin=t.plugin,this.results=Array.isArray(t.results)?t.results:[],this.min_similarity=Number.isFinite(t.min_similarity)?t.min_similarity:null}async onOpen(){this.modalEl.classList.add("sc-dup-modal");let{contentEl:e}=this;e.empty();let t=e.createEl("div",{text:"Loading..."});t.style.color="var(--text-muted)";let n=this.plugin?.env;if(!n?.smart_components?.render_component){e.empty(),e.createEl("p",{text:"Smart components not available in this environment."});return}try{let i=await n.smart_components.render_component(_A,this.plugin,{variant:"results",plugin:this.plugin,modal:this,results:this.results,min_similarity:this.min_similarity});e.empty(),e.appendChild(i)}catch(i){console.warn("[Smart Connections] Failed to render duplicate blocks modal component",i),e.empty(),e.createEl("p",{text:"Unable to render duplicate blocks UI. See console for details."})}}};function uA(s){s.addCommand({id:"sc-find-duplicate-blocks",name:"Find: Duplicate blocks (embeddings)",checkCallback:o(e=>{let t=s.app.workspace.getActiveFile();return t?.path?(e||k4(s,{file_path:t.path}),!0):!1},"checkCallback")})}o(uA,"register_find_duplicate_blocks_command");async function k4(s,e={}){let t=s.env,n=t?.smart_blocks;if(!n){new Gs.Notice("Smart Blocks are not available in this environment.");return}let i=t?.smart_sources?.get(e.file_path)??t?.smart_sources?.init_file_path(e.file_path);if(!(Array.isArray(i?.blocks)?i.blocks:[]).length){new Gs.Notice("No blocks found for the active note.");return}let a=await w4({app:s.app,plugin:s,default_value:xf});if(a===null)return;let c=Dx(i,{all_blocks:n.items,min_similarity:a,max_results:v4});if(!c.length){new Gs.Notice("No duplicate blocks found above the similarity threshold.");return}new kf(s.app,{plugin:s,results:c,min_similarity:a}).open()}o(k4,"run_duplicate_blocks_search");function w4(s={}){let e=Number.isFinite(s.default_value)?s.default_value:xf;return new Promise(t=>{new wf(s.app,{plugin:s.plugin,default_value:e,on_submit:t}).open()})}o(w4,"request_similarity_threshold");var wf=class extends Gs.Modal{static{o(this,"DuplicateThresholdModal")}constructor(e,t={}){super(e),this.plugin=t.plugin,this.default_value=t.default_value,this.on_submit=t.on_submit,this.did_submit=!1}async onOpen(){this.modalEl.classList.add("sc-dup-threshold-modal");let{contentEl:e}=this;e.empty();let t=this.plugin?.env;if(!t?.smart_components?.render_component){e.createEl("p",{text:"Smart components not available in this environment."});return}let n=o(r=>{this.did_submit=!0,this.on_submit?.(r),this.close()},"on_submit"),i=o(()=>{this.close()},"on_cancel");try{let r=await t.smart_components.render_component(_A,this.plugin,{variant:"threshold",modal:this,default_value:this.default_value??xf,on_submit:n,on_cancel:i});e.empty(),e.appendChild(r)}catch(r){console.warn("[Smart Connections] Failed to render threshold modal component",r),e.empty(),e.createEl("p",{text:"Unable to render threshold UI. See console for details."})}}onClose(){this.did_submit||this.on_submit?.(null)}};function o_(s){return s.endsWith("Item")?s.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():s.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}o(o_,"collection_instance_name_from");function Hs(s={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(mA(e[t])&&mA(s[t])?Hs(s[t],e[t]):s[t]=e[t]);return s}o(Hs,"deep_merge");function mA(s){return s&&typeof s=="object"&&!Array.isArray(s)}o(mA,"is_plain_object");function pA(s){let e=JSON.stringify(s),t=0;if(e.length===0)return t;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}o(pA,"create_uid");function hA(s=""){return s.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}o(hA,"camel_case_to_snake_case");function r_(s,e,t=new WeakMap){if(s===e)return!0;if(s===null||e===null||s===void 0||e===void 0||typeof s!=typeof e||Array.isArray(s)!==Array.isArray(e))return!1;if(Array.isArray(s))return s.length!==e.length?!1:s.every((n,i)=>r_(n,e[i],t));if(typeof s=="object"){if(t.has(s))return t.get(s)===e;t.set(s,e);let n=Object.keys(s),i=Object.keys(e);return n.length!==i.length?!1:n.every(r=>r_(s[r],e[r],t))}return s===e}o(r_,"deep_equal");function Ef(s,e){return e?s.split("/").join(" > ").replace(".md",""):s.split("/").pop().replace(".md","")}o(Ef,"get_item_display_name");function a_(s,e){let t=e||{},n=o(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=o(m=>typeof m=="function","is_function"),r=o(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=o(m=>n(m)&&i(m.action),"is_action_object"),c=o(m=>i(m)||a(m)||r(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=o(m=>{if(!n(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let O=Object.getOwnPropertyDescriptor(m,w);if(!O)continue;let E={...O};"value"in E&&n(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=o(m=>{if(!n(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let O of h){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E){let q=E.value;if(c(q)){w=!0;continue}if(n(q)){if(_(q)){w=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=o(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=n(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=o(m=>{let h=Object.create(null),w=new Map;for(let O of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E&&_(E.value)){w.set(O,d(E.value));continue}try{Object.defineProperty(h,O,u(E))}catch{h[O]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=o((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=o((m,h,w=[])=>{if(!m||!h)return;let O=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(O.has(E))continue;let q=Object.getOwnPropertyDescriptor(m,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),b=o(m=>{let h=new m(s),w=h.action||h.run||h.execute||h.call;if(i(w)){let O=w.bind(h);return v(m,O),v(h,O),O.instance=h,O}return v(m,h),h},"instantiate_class"),A=o(m=>{if(r(m))return b(m);if(a(m)){let h=m.action.bind(s);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(s);return v(m,h),h}return n(m)?d(m):m},"bind_or_clone"),S=o(()=>{let m=s?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&n(h)?h:null},"scope_actions_for"),$=o((m,h,w)=>(m[h]=w,w),"cache_result"),j=o((m,h)=>{let w=S();return w&&g(w,h)?$(m,h,A(w[h])):g(f,h)?$(m,h,A(f[h])):$(m,h,void 0)},"compute_and_cache"),C=o(()=>{let m=S(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=o((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:o((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:o((m,h)=>{if(h in m)return!0;let w=S();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:o(()=>C(),"ownKeys"),getOwnPropertyDescriptor:o((m,h)=>{if(g(m,h))return x(m,h);let w=S();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:o((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:o((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:o((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}o(a_,"create_actions_proxy");var ts=class s{static{o(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Hs(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let n=new this(e,t);return n.init(),n}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let n=e.defaults[t];typeof n=="object"?this[t]={...n,...this[t]}:this[t]=this[t]===void 0?n:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return pA(this.data)}update_data(e){let t=this.sanitize_data(e),n={...this.data};return Hs(n,t),!r_(this.data,n)?(this.data=n,!0):!1}sanitize_data(e){return e instanceof s?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,n)=>(t[n]=this.sanitize_data(e[n]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:n=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:r,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(n?.includes(this.key)||i&&this.key.startsWith(i)||r&&r.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=a_(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),o_(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),o_(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),hA(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}once_event(e,t){return this.env.events?.once(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Ef(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var x4=Object.getPrototypeOf(async function(){}).constructor,jt=class{static{o(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),n=t||new this.item_type(this.env);n._queue_save=!t;let i=n.update_data(e);return!t&&!n.validate_save()?n:(t||this.set(n),t&&!i?t:n.init instanceof x4?new Promise(r=>{n.init(e).then(()=>r(n))}):(n.init(e),n))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),n=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Hs(t.data,n),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:n}=e;for(let i of Object.values(this.items)){if(n&&t.length>=n)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let n=this.filter(e);return n[Math.floor(Math.random()*n.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(n=>n.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],n=e+"_adapter",i=t?.[n]??this.env.opts.collections?.smart_collections?.[n];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,n)=>{let i=t?.class?.version||t.version||0;return(n?.class?.version||n.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let n=o(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[r,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=n(c.callback)),c.btn_callback&&(c.btn_callback=n(c.btn_callback)),c.options_callback&&(c.options_callback=n(c.options_callback));let l=n(this.process_setting_key(r));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.collection_key&&n.collection_key!==this.collection_key||t(n)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=a_(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let n=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(n),e}};var c_=class{static{o(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Mr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Mr=class{static{o(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var l_=class extends c_{static{o(this,"FileCollectionDataAdapter")}ItemDataAdapter=zr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},zr=class extends Mr{static{o(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var fA={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Dr=class extends l_{static{o(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=gi;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let n=100;for(let i=0;i<e.length;i+=n){let r=e.slice(i,i+n);await Promise.all(r.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(r=>r._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),n=50;for(let r=0;r<e.length;r+=n){let a=e.slice(r,r+n);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(r=>r.deleted);i.length&&i.forEach(r=>{delete this.collection.items[r.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,n=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${n}`)}: ${i},`}},gi=class extends zr{static{o(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:n}=this._parse(e);t&&(n.length?await this.fs.write(this.data_path,n):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let n=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",r=JSON.parse(i),a=Object.entries(r);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete r[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,r[_+":"+u]=d,delete r[l]);let f=this.env[_];if(!f)continue;let y=f.get(u);if(d.key||(d.key=u),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,k=new g(this.env,d);k._queue_load=!1,k.loaded_at=Date.now(),f.set(k)}}return(t||n>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(r).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(n=>!n.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(n=>n.endsWith(",")?n:n+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[n,...i]=e.split(":");return fA[n]&&(n=fA[n],t=!0),{collection_key:n,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let n=this.collection_adapter.collection.data_dir;return await this.fs.exists(n)||await this.fs.mkdir(n),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function Af(s,e){if(e===null)return null;if(e===void 0)return s;if(typeof e!="object")return e;(typeof s!="object"||s===null)&&(s={});let t=Object.keys(e),n=t.length;for(let i=0;i<n;i++){let r=t[i],a=e[r],c=s[r];Array.isArray(a)?s[r]=a.slice():gA(a)?s[r]=Af(gA(c)?c:{},a):a!==void 0&&(s[r]=a)}return s}o(Af,"ajson_merge");function gA(s){return s!==null&&typeof s=="object"&&!Array.isArray(s)}o(gA,"is_object");var yA={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function E4(s){let e=!1,[t,...n]=s.split(":");return yA[t]&&(t=yA[t],e=!0),{collection_key:t,item_key:n.join(":"),changed:e}}o(E4,"_parse_ajson_key");var Rr=class extends Dr{static{o(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",n=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(n)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let r of Object.values(this.collection.items))r._queue_load&&r.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let r of Object.values(this.collection.items))r._queue_load&&r.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:n,file_data:i}=this.parse_single_file_ajson(t);n&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let r of Object.values(this.collection.items))r._queue_load=!1,r.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,n=e.trim().split(`
`).filter(Boolean),i={},r=0;for(let c=0;c<n.length;c++){let l=n[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:y,item_key:g,changed:k}=E4(p),v=`${y}:${g}`;f?(i[v]=f,(k||v!==p)&&(delete i[p],t=!0)):(delete i[v],(k||v!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}r++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=Af(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}r>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(r=>r._queue_save),t=Date.now(),n=50;for(let r=0;r<e.length;r+=n){let a=e.slice(r,r+n);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(r=>r.deleted);i.length&&i.forEach(r=>{delete this.collection.items[r.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Sf=class extends gi{static{o(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:n}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},Fr={collection:Rr,item:Sf};function A4(s){if(s==null)return"";let e;if(Array.isArray(s))e=s.map(t=>t==null?"":String(t)).join(", ");else if(typeof s=="object")try{e=JSON.stringify(s)}catch{e=String(s)}else e=String(s);return e.startsWith("formula.")&&(e=e.replace("formula.","")),e.startsWith("note.")&&(e=e.replace("note.","")),e.startsWith("file.")&&(e=e.replace("file.","")),e.replace(/\|/g,"\\|").replace(/\r?\n/g,"<br>")}o(A4,"stringify_cell");function S4(s){if(!Array.isArray(s)||s.length===0)return[];let e=s.map(n=>Array.isArray(n)?n:[n]),t=e.reduce((n,i)=>Math.max(n,i.length),0);return e.map(n=>Array.from({length:t},(i,r)=>A4(n[r])))}o(S4,"normalize_table");function C4(s){if(s.length===0)return[];let e=s[0].length,t=Array.from({length:e},()=>0);return s.forEach(n=>{for(let i=0;i<e;i++){let r=(n[i]??"").length;r>t[i]&&(t[i]=r)}}),t.map(n=>Math.max(n,3))}o(C4,"compute_col_widths");function O4(s,e){let t=s??"";return t.length>=e?t:t+" ".repeat(e-t.length)}o(O4,"pad_cell");function Cf(s,e){return`| ${s.map((n,i)=>O4(n,e[i])).join(" | ")} |`}o(Cf,"build_row");function q4(s){let e=S4(s);if(e.length===0)return"";let t=C4(e),n=Cf(e[0],t),i=t.map(c=>"-".repeat(c)),r=Cf(i,t),a=e.slice(1).map(c=>Cf(c,t));return[n,r,...a].join(`
`)}o(q4,"to_markdown_table");function $4(s,e){if(!(typeof e!="string"||e.length===0))return e.split(".").reduce((t,n)=>{if(t!=null){if(n==="formula")return t?.formulaResults?.cachedFormulaOutputs;if(n==="note")return t?.note?.data??t?.note;if(["size","mtime","ctime"].includes(n))return t?.stat?.[n];if(n==="links")try{return(globalThis.smart_env?.smart_sources?.get?.(s?.file?.path)?.outlinks||[]).map(r=>`[[${r?.key??r}]]`).join(", ")}catch{return""}return n==="name"?`[[${t?.name??""}]]`:t?.[n]}},s)}o($4,"get_value_from_path");function j4(s){return s?.linkText?.includes(".base")??!1}o(j4,"is_bases_child");async function T4(s,e=300){await new Promise(n=>setTimeout(n,e));let t=s?._children?.[0]?.view;return t?.data?t:null}o(T4,"get_base_file_view");function bA(s){let e=s?.propertiesCache;if(!Array.isArray(e)||e.length===0)return[];let t=s?.groupedDataCache;if(!Array.isArray(t)||t.length===0)return[];let n=t[t.length-1];if(!n||!Array.isArray(n.entries))return[];let i=e.map(a=>a),r=n.entries.map(a=>e.map(c=>{let l=$4(a,c);return Array.isArray(l?.data)&&typeof l.data?.[0]?.data=="string"?l.data.map(d=>d?.sourcePath?`[[${d.data}]]`:d?.data??"").join(", "):l&&typeof l=="object"&&"data"in l?l.data??"":typeof l!="object"?l??"":""}));return[i,...r]}o(bA,"get_bases_output");function N4(s){if(!Array.isArray(s))return new Set;let e=s.map(t=>t?.link??t?.path??t?.displayText??t?.original??t?.rawText??"").filter(t=>typeof t=="string"&&t.includes(".base"));return new Set(e)}o(N4,"get_base_links");var d_=class extends ts{static{o(this,"BasesCache")}get collection(){return this.env.bases_caches}get markdown_table(){let e=this.data?.bases_output;return q4(e)}},Of=class extends jt{static{o(this,"BasesCaches")}static version=1;#t=null;#e=new Map;#o="";#n=new WeakSet;#i=null;#s=200;#a=3e4;#l=3e4;#r=0;#c=!1;init(){if(this.#c)return;this.#c=!0;let e=globalThis.app?.workspace;if(!e){console.warn("BasesCaches.init: no app.workspace available");return}let t=o(()=>this.start_watchers(),"handler");this.env.plugin.registerEvent(e.on("active-leaf-change",t)),typeof this.env.plugin.register=="function"&&this.env.plugin.register(()=>this.stop_watchers()),this.start_watchers()}get_base_file_view(e){return T4(e)}start_watchers(){this.stop_watchers();let e=this.#r,t=globalThis.app?.workspace?.getActiveFileView?.();if(!t)return console.warn("No file view");let n=t.file?this.env.smart_sources?.get(t.file.path):null;this.#o=n?.key||t.file?.path||"",this.#n=new WeakSet,this.prune_missing_base_caches({source:n});let i=t?.editor?.editorComponent;if(i){let r=o(()=>{if(e!==this.#r)return;let a=[];try{a=i._children||[]}catch{a=[]}let c=new Set;a.forEach(l=>{j4(l)&&(c.add(l),!this.#n.has(l)&&(this.#n.add(l),this.watch_base_child(l,e)))}),this.sweep_orphan_watchers(c)},"scan_children");r(),this.#t=this.set_interval(r,this.#s)}this.get_base_file_view(t).then(r=>{e===this.#r&&(r?(this.#i=r,this.watch_base_file(r,e)):this.#i=null)}).catch(r=>{e===this.#r&&console.warn("BasesCaches: get_base_file_view failed",r)})}set_interval(e,t){return setInterval(e,t)}clear_interval(e){clearInterval(e)}sweep_orphan_watchers(e){let t=new Set(e);this.#i&&t.add(this.#i),this.#e.forEach((n,i)=>{if(n?.generation!==this.#r){this.clear_interval(n.id),this.#e.delete(i);return}let r=t.has(i),a=!0;try{let c=i?.containerEl||i?._children?.[0]?.viewContainerEl||i?.viewContainerEl||null;c&&typeof c.isConnected=="boolean"&&(a=c.isConnected)}catch{a=!1}(!r||!a)&&(this.clear_interval(n.id),this.#e.delete(i))})}watch_base_child(e,t=this.#r){if(this.#e.has(e))return;let n=e?.linkText??"",i=Date.now(),r=this.set_interval(()=>{if(t!==this.#r){this.clear_interval(r),this.#e.delete(e);return}let a=e?.containerEl||e?._children?.[0]?.viewContainerEl||null;if(a&&a.isConnected===!1){this.clear_interval(r),this.#e.delete(e);return}if(Date.now()-i>this.#a){this.clear_interval(r),this.#e.delete(e);return}let c=e?._children?.[0]?.view?.data;if(!c)return;let l=[];try{l=bA(c)}catch(d){console.warn("BasesCaches: get_bases_output failed for embedded base",d),l=[]}l.length&&(this.clear_interval(r),this.#e.delete(e),this.cache_bases_output({key:`${this.#o}#${n}`,bases_output:l}))},this.#s);this.#e.set(e,{id:r,started:i,generation:t})}watch_base_file(e,t=this.#r){if(this.#e.has(e))return;let n=Date.now(),i=this.set_interval(()=>{if(t!==this.#r){this.clear_interval(i),this.#e.delete(e);return}let r=e?.containerEl||e?.viewContainerEl||null;if(r&&r.isConnected===!1){this.clear_interval(i),this.#e.delete(e);return}if(Date.now()-n>this.#l){this.clear_interval(i),this.#e.delete(e);return}let a=e?.data;if(!a)return;let c=[];try{c=bA(a)}catch(l){console.warn("BasesCaches: get_bases_output failed for base file",l),c=[]}c.length&&(this.clear_interval(i),this.#e.delete(e),this.cache_bases_output({key:this.#o,bases_output:c}))},this.#s);this.#e.set(e,{id:i,started:n,generation:t})}stop_watchers(){this.#r+=1,this.#t&&(this.clear_interval(this.#t),this.#t=null),this.#e.forEach(e=>this.clear_interval(e.id)),this.#e.clear(),this.#i=null}prune_missing_base_caches(e={}){let{source:t=null,source_key:n=this.#o}=e,i=t?.data?.meta?.links||t?.meta?.links||[],r=N4(i);if(!n)return;let a=`${n}#`,c=!1;Object.entries(this.items).forEach(([l,d])=>{if(!l.startsWith(a))return;let _=l.slice(a.length);r.has(_)||(c=!0,d.delete())}),c&&this.process_save_queue()}cache_bases_output(e={}){let{key:t,bases_output:n}=e;if(!t||!Array.isArray(n)||n.length===0)return;let i=new d_(this.env,{key:t,bases_output:n});this.set(i),i.queue_save(),this.process_save_queue()}},vA={class:Of,collection_key:"bases_caches",data_adapter:Rr,item_type:d_};var Js=class extends ts{static{o(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let n=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?n.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&n.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&n.debounce_save(),d}},r=new Proxy(e,i);return this._settings_proxy_map.set(e,r),r}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,n])=>({label:n.name||t,value:n.key||t})).sort((t,n)=>t.label.toLowerCase().includes("free")&&!n.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&n.label.toLowerCase().includes("free")?1:t.label.localeCompare(n.label))}model_changed(e,t,n){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},r=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...r,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var yi=class extends jt{static{o(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,r)=>r.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let n=new this.item_type(this.env,{...e});return this.set(n),this.settings.default_model_key=n.key,this.emit_event("model:changed"),n.queue_save(),n}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(n=>!n.deleted).sort((n,i)=>i.data.created_at-n.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let n=this.new_model({provider_key:this.default_provider_key});n.queue_save(),this.process_save_queue(),this.settings.default_model_key=n.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function __(s){return{default_model_key:{type:"dropdown",name:`Default ${s.model_type.toLowerCase()} model`,description:`Used as the default ${s.model_type.toLowerCase()} model when no other is specified.`,options_callback:o(()=>s.get_model_key_options(),"options_callback"),callback:o(async(e,t)=>{s.emit_event("model:changed")},"callback")}}}o(__,"settings_config");var Vs=class extends Js{static{o(this,"ChatCompletionModel")}async complete(e){return this.instance.complete(e)}async stream(e,t={}){return this.instance.stream(e,t)}async test_model(){try{let e=await this.complete({messages:[{role:"user",content:"2+2="}]}),t=!e.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var u_=class{static{o(this,"SmartStreamer")}constructor(e,t={}){let{method:n="GET",headers:i={},body:r=null,withCredentials:a=!1}=t;this.url=e,this.method=n,this.headers=i,this.body=r,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(n=>n!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(n=>(n(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let n=JSON.parse(e.currentTarget.response);typeof n=="object"?t.data=n:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let n=t.split(this.chunk_splitting_regex);n.forEach((i,r)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,r===n.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var m_=class extends Jt{static{o(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};function $f(s){if(s===null)return!0;let e=typeof s;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(s)?s.every($f):e==="object"?Object.values(s).every($f):!1}o($f,"is_json_compatible");function p_(s,e){let t={};for(let[n,i]of Object.entries(s))e.includes(n)||$f(i)&&(t[n]=i);return t}o(p_,"extract_json_details");function Br(s){return Object.keys(s).length===0}o(Br,"is_empty_object");function P4(s,e){return Br(s)?e:Br(e)?s:{...s,...e}}o(P4,"merge_details");function qf(s){let e=s.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}o(qf,"get_message_from_object");function ue(s,e=null){if(Array.isArray(s)&&s.length>0)return ue(s[0],e);if(s==null)return{message:"Unknown error",details:null,http_status:e};if(typeof s=="string")return{message:s,details:null,http_status:e};if(s instanceof Error){let t=(s.message||"").trim()||"Unknown error",n=p_(s,["message"]);return{message:t,details:Br(n)?null:n,http_status:e}}if(typeof s=="object"){let t=s;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let r=i,a=qf(r),c=p_(r,["message"]),l=p_(t,["message","error"]),d=P4(l,c);return{message:a||qf(t)||"Unknown error",details:Br(d)?null:d,http_status:e}}return ue(i)}let n=qf(t);if(n){let i=p_(t,["message"]);return{message:n,details:Br(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}o(ue,"normalize_error");var bi={},ss={data:null,fetched_at:0},J=class extends m_{static{o(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return K}get res_adapter(){return W}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Ge({adapter:Ct})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=ss.data[e]||{},n=o(a=>a.limit?.context||1e4,"get_limit_i"),i=o(a=>a.limit?.output||1e4,"get_limit_o"),r=o(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=n(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=r(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:n(c),max_output_tokens:i(c),multimodal:r(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(n){console.error("Failed to fetch model data:",{error:n,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let n=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(n);if(!i)return null;let r=new this.res_adapter(this,await i.json());try{return r.to_openai()}catch(a){let c=ue(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((r,a)=>{try{this.active_stream=new u_(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),r(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=ue({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=ue(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=ue(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(ss?.data&&t-ss?.fetched_at<e)return ss.data;try{let n={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},r=await(await this.http_adapter.request(n)).json();return ss.data=r,ss.fetched_at=t,console.log({MODELS_DEV_CACHE:ss}),r}catch(n){return console.warn("models.dev fetch failed; continuing without enrichment",n),ss.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return bi[this.constructor.key]||(bi[this.constructor.key]={}),bi[this.constructor.key]}set model_data(e){bi[this.constructor.key]||(bi[this.constructor.key]={}),bi[this.constructor.key]=e}},K=class{static{o(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(n=>n.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},W=class{static{o(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,n=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=n}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:ue(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let n=e.choices[0].delta.content;t=n,this._res.choices[0].message.content+=n}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var h_=class extends J{static{o(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return jf}get res_adapter(){return Tf}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,n)=>(t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_length,name:n.name,description:n.name,long_desc:n.description,multimodal:n.architecture.modality==="multimodal",raw:n},t),{})}},jf=class extends K{static{o(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Tf=class extends W{static{o(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Nf=class extends h_{static{o(this,"OpenRouterChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},I4={api_key:{name:"API Key",type:"password",description:"Enter your API key for the chat model provider."}},f_={class:Nf,settings_config:I4};var Pf=class extends yi{static{o(this,"ChatCompletionModels")}model_type="Chat";get default_provider_key(){return"open_router"}};var L4={class:Pf,data_dir:"chat_completion_models",collection_key:"chat_completion_models",data_adapter:Fr,item_type:Vs,providers:{open_router:f_},settings_config:__},kA=L4;var wA=kA;var Ks=class extends Js{static{o(this,"RankingModel")}static get defaults(){return{data:{api_key:"",provider_key:"cohere",model_key:"rerank-v3.5"}}}async rank(e,t,n={}){return this.instance.rank(e,t,n)}async test_model(){try{let e=await this.rank("alphabetical order",["z","y","x","a","b","c"]),t=!!(!e.error&&Array.isArray(e)&&e.length);return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var If=class extends Wn{static{o(this,"CohereRankingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get_models(){return this.models}},M4={api_key:{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},xA={class:If,settings_config:M4};var Lf=class extends yi{static{o(this,"RankingModels")}model_type="Ranking";get default_provider_key(){return"cohere"}},z4={class:Lf,data_dir:"ranking_models",collection_key:"ranking_models",data_adapter:Fr,item_type:Ks,providers:{cohere:xA},settings_config:__},EA=z4;var AA=EA;var g_=class{static{o(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}};function y_(s=[],e=[]){if(s.length!==e.length)throw new Error("Vectors must have the same length");let t=0,n=0,i=0,r=1e-8;for(let a=0;a<s.length;a++)t+=s[a]*e[a],n+=s[a]*s[a],i+=e[a]*e[a];return n=Math.sqrt(n),i=Math.sqrt(i),n<r||i<r?0:t/(n*i)}o(y_,"cos_sim");function OA(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.min===Number.POSITIVE_INFINITY){let{minScore:n,minObj:i}=SA(s.results);s.min=n,s.minResult=i}}else if(e.score>s.min){s.results.add(e),s.results.delete(s.minResult);let{minScore:n,minObj:i}=SA(s.results);s.min=n,s.minResult=i}}o(OA,"results_acc");function qA(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.max===Number.NEGATIVE_INFINITY){let{maxScore:n,maxObj:i}=CA(s.results);s.max=n,s.maxResult=i}}else if(e.score<s.max){s.results.add(e),s.results.delete(s.maxResult);let{maxScore:n,maxObj:i}=CA(s.results);s.max=n,s.maxResult=i}}o(qA,"furthest_acc");function SA(s){let e=Number.POSITIVE_INFINITY,t=null;for(let n of s)n.score<e&&(e=n.score,t=n);return{minScore:e,minObj:t}}o(SA,"find_min");function CA(s){let e=Number.NEGATIVE_INFINITY,t=null;for(let n of s)n.score>e&&(e=n.score,t=n);return{maxScore:e,maxObj:t}}o(CA,"find_max");function vi(s,e){let n=s.score-e.score;return Math.abs(n)<1e-9?0:n>0?-1:1}o(vi,"sort_by_score");function $A(s,e){return vi(s,e)}o($A,"sort_by_score_descending");function jA(s,e){return vi(s,e)*-1}o(jA,"sort_by_score_ascending");var b_=class extends g_{static{o(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:n=50}=t,i=this.collection.filter(t).reduce((r,a)=>{if(!a.vec)return r;let c={item:a,score:y_(e,a.vec)};return OA(r,c,n),r},{min:0,results:new Set});return Array.from(i.results).sort($A)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:n=50}=t,i=this.collection.filter(t).reduce((r,a)=>{if(!a.vec)return r;let c={item:a,score:y_(e,a.vec)};return qA(r,c,n),r},{max:0,results:new Set});return Array.from(i.results).sort(jA)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(n=>n.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((n,i)=>{let r=e[i];r.vec=n.vec,r.data.last_embed=r.data.last_read,n.tokens!==void 0&&(r.tokens=n.tokens),r.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(n=>setTimeout(n,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let n=0;n<t.length;n+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(n,n+this.collection.embed_model.batch_size);await Promise.all(i.map(r=>r.get_embed_input()));try{let r=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-r}catch(r){r&&r.message&&r.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(r),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(r||{},null,2))}i.forEach(r=>{r.embed_hash=r.read_hash,r._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((r,a)=>r+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}};function D4(s,e=0){let t=s.length&3,n=s.length-t,i=e,r=3432918353,a=461845907,c=0,l=0,d=0;for(;c<n;)d=s.charCodeAt(c)&255|(s.charCodeAt(c+1)&255)<<8|(s.charCodeAt(c+2)&255)<<16|(s.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=ki(l,r),l=Mf(l,15),l=ki(l,a),i^=l,i=Mf(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(s.charCodeAt(c+2)&255)<<16;case 2:l^=(s.charCodeAt(c+1)&255)<<8;case 1:l^=s.charCodeAt(c)&255,l=ki(l,r),l=Mf(l,15),l=ki(l,a),i^=l;break}return i^=s.length,i=R4(i),i|0}o(D4,"murmur_hash_32");function TA(s,e=0){return(D4(s,e)>>>0).toString(36)}o(TA,"murmur_hash_32_alphanumeric");function ki(s,e){return(s&65535)*e+((s>>>16)*e<<16)|0}o(ki,"multiply_32");function Mf(s,e){return s<<e|s>>>32-e}o(Mf,"rotate_left_32");function R4(s){return s^=s>>>16,s=ki(s,2246822507),s^=s>>>13,s=ki(s,3266489909),s^=s>>>16,s|0}o(R4,"fmix_32");var F4="---frontmatter---",NA=o(s=>Array.isArray(s)?s.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof s=="string"?(s.includes(",")?s.split(","):[s]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),B4=o((s,e={})=>({...s.env.settings.smart_view_filter||{},...e,entity:s}),"merge_settings_with_params"),U4=o(s=>{let e={...s};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),W4=o(s=>{if(!s.exclude_frontmatter_blocks)return s;let e={...s},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(F4),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),G4=o((s,e)=>{if(!e)return s;let t={...s},n=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(n.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&n.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(n=[...n,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(n=[...n,...e.outlinks.map(r=>r.key)]),n.length&&(t.exclude_key_starts_with_any=n),t.exclude_filter){let r=NA(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...r]}if(t.include_filter){let r=NA(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...r]}return t},"append_entity_filters"),H4=o((s,e={})=>{let t=B4(s,e),n=U4(t),i=W4(n);return G4(i,s)},"create_find_connections_filter_opts");async function zf(s={}){let e=s.filter?.limit||s.limit||this.env.settings.smart_view_filter?.results_limit||10,t=H4(this,s);s.filter?.limit&&delete s.filter.limit,s.limit&&delete s.limit;let n=this.key+TA(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[n]){let i=(await this.nearest(t)).sort(vi).slice(0,e);this.connections_to_cache(n,i)}return this.connections_from_cache(n)}o(zf,"find_connections");zf.action_type="connections";var Ur=class extends jt{static{o(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new b_(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let n=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let r={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await n.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,r)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(vi).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return v_}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let n=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(n),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return J4}},v_={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},J4={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};var Wr=class extends Ur{static{o(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var K4=o(s=>{let e={embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...v_};return s.settings.embed_blocks===!1&&e.min_chars&&(e.min_chars.disabled=!0),e},"settings_config"),PA={class:Wr,collection_key:"smart_blocks",settings_config:K4};var Ei=require("obsidian");function Ye(s=""){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}o(Ye,"escape_html");function IA(s,e=0){let t=s.length&3,n=s.length-t,i=e,r=3432918353,a=461845907,c=0,l=0,d=0;for(;c<n;)d=s.charCodeAt(c)&255|(s.charCodeAt(c+1)&255)<<8|(s.charCodeAt(c+2)&255)<<16|(s.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=wi(l,r),l=Df(l,15),l=wi(l,a),i^=l,i=Df(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(s.charCodeAt(c+2)&255)<<16;case 2:l^=(s.charCodeAt(c+1)&255)<<8;case 1:l^=s.charCodeAt(c)&255,l=wi(l,r),l=Df(l,15),l=wi(l,a),i^=l;break}return i^=s.length,i=Y4(i),i|0}o(IA,"murmur_hash_32");function le(s,e=0){return(IA(s,e)>>>0).toString(36)}o(le,"murmur_hash_32_alphanumeric");function wi(s,e){return(s&65535)*e+((s>>>16)*e<<16)|0}o(wi,"multiply_32");function Df(s,e){return s<<e|s>>>32-e}o(Df,"rotate_left_32");function Y4(s){return s^=s>>>16,s=wi(s,2246822507),s^=s>>>13,s=wi(s,3266489909),s^=s>>>16,s|0}o(Y4,"fmix_32");function ke(s=""){return s.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}o(ke,"camel_case_to_snake_case");function Rf(s){let e=Date.now(),t=s<1e12?s*1e3:s,n=e-t,i=n<0,r=Math.floor(Math.abs(n)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(r/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}o(Rf,"convert_to_time_ago");function ht(s={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(LA(e[t])&&LA(s[t])?ht(s[t],e[t]):s[t]=e[t]);return s}o(ht,"deep_merge");function LA(s){return s&&typeof s=="object"&&!Array.isArray(s)}o(LA,"is_plain_object");function Ys(s=[],e=[]){if(s.length!==e.length)throw new Error("Vectors must have the same length");let t=0,n=0,i=0,r=1e-8;for(let a=0;a<s.length;a++)t+=s[a]*e[a],n+=s[a]*s[a],i+=e[a]*e[a];return n=Math.sqrt(n),i=Math.sqrt(i),n<r||i<r?0:t/(n*i)}o(Ys,"cos_sim");function Pe(s,e,t=null){if(!e)return"";let n=e.split(".");t&&n.unshift(t);let i=n.pop(),r=n.reduce((a,c)=>a&&a[c],s);return r&&typeof r[i]=="function"?r[i].bind(r):r?r[i]:void 0}o(Pe,"get_by_path");function Ie(s,e,t,n=null){let i=e.split(".");n&&i.unshift(n);let r=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),s);a[r]=t}o(Ie,"set_by_path");function Ff(s,e,t=null){let n=e.split(".");t&&n.unshift(t);let i=n.pop(),r=n.reduce((a,c)=>a&&a[c],s);r&&delete r[i]}o(Ff,"delete_by_path");function Bf(s){if(!s||s.length===0)return null;let e=s.length,t=s[0].length,n=new Float64Array(t);for(let i=0;i<e;i++){let r=s[i];for(let a=0;a<t;a++)n[a]+=r[a]}for(let i=0;i<t;i++)n[i]/=e;return Array.from(n)}o(Bf,"compute_centroid");function Uf(s){if(!s||s.length===0)return null;if(s.length===1)return s[0];let e=s.length,t=s[0].length,n=new Float64Array(e);for(let a=0;a<e-1;a++){let c=s[a];for(let l=a+1;l<e;l++){let d=s[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);n[a]+=u,n[l]+=u}}let i=0,r=n[0];for(let a=1;a<e;a++)n[a]<r&&(r=n[a],i=a);return s[i]}o(Uf,"compute_medoid");function X4(s,e){try{typeof s=="function"&&(s=s(e))}catch(t){console.error("Error evaluating settings_config function:",t),s={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return s}o(X4,"ensure_settings_config");function Wf(s,e,t){let n=X4(s,e);return Object.entries(n||{}).reduce((i,[r,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][r]=a,i},{[t]:{}})}o(Wf,"build_settings_group_map");function Gf(s,e,t,n){return Wf(s,e,n)[t]||{}}o(Gf,"resolve_group_settings_config");var k_=class{static{o(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new Ei.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function Ai(s,e,t,n={}){let{default_group_name:i="Settings"}=n,r=s,a=Wf(s,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),u={...n,...n.group_params?.[l]||{},settings_config_source:r};return Hf(l,e,d,_,u)})}o(Ai,"render_settings_config");function Hf(s,e,t,n,i={}){let r=i.settings_config_source||t,a=i.settings_config_source?Gf(r,e,s,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=k_}catch{c=k_}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,y,g,k)=>{let v=Gf(y,f,p,k.default_group_name||"Settings");return Hf(p,f,v,g,k)}:Hf,_=Z4(e,{container:n,group_name:s,settings_config:r,group_params:i,render_group:d}),u=new c(n);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)MA(u,e,p);else MA(u,e,l);u.setHeading(s);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let y=f.scope_class==="pro-setting",g=!!e.env?.is_pro;u.addSetting(k=>{switch(f.name&&k.setName(f.name),k.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&k.setClass(`setting-type-${f.type}`),f.description&&k.setDesc(f.description),f.type){case"button":k.addButton(v=>{v.setButtonText(f.name||"Run"),v.onClick(async b=>{typeof f.callback=="function"&&await xi(k,b,f.callback,{scope:e})})});break;case"toggle":k.addToggle(v=>{v.setValue(Pe(e.settings,p)||!1),v.onChange(b=>{Ie(e.settings,p,b),typeof f.callback=="function"&&xi(k,b,f.callback,{scope:e})})});break;case"text":k.addText(v=>{v.setValue(String(Pe(e.settings,p)||"")),v.onChange(b=>{Ie(e.settings,p,b)})});break;case"number":k.addText(v=>{v.setValue(String(Pe(e.settings,p)??"0")),v.inputEl.setAttribute("type","number"),v.onChange(b=>{let A=Number(b);isNaN(A)||Ie(e.settings,p,A),typeof f.callback=="function"&&xi(k,A,f.callback,{scope:e})})});break;case"dropdown":k.addDropdown(v=>{let b=f.options_callback;typeof b=="function"&&b.call(e,e).forEach(S=>{let $=S.label||S.name||S.value;v.addOption(S.value,$)}),v.setValue(Pe(e.settings,p)||""),v.onChange(A=>{Ie(e.settings,p,A),typeof f.callback=="function"&&xi(k,A,f.callback,{scope:e}),_()})});break;case"textarea":k.addTextArea(v=>{v.setValue(String(Pe(e.settings,p)||"")),v.onChange(b=>{if(y&&!g){new Ei.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}Ie(e.settings,p,b)}),y&&!g&&v.setDisabled(!0)});break;case"slider":k.addSlider(v=>{let b=f.min||0,A=f.max||100,S=f.step||1;v.setLimits(b,A,S),v.setValue(Pe(e.settings,p)||b),v.setDynamicTooltip(),v.onChange($=>{Ie(e.settings,p,$),typeof f.callback=="function"&&xi(k,$,f.callback,{scope:e})})});break;case"heading":k.setHeading();break;case"html":f.value&&k.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&k.settingEl.addClass(f.scope_class)})}return u}o(Hf,"render_settings_group");function MA(s,e,t){let n=s.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,Ei.setIcon)(n,t.btn_icon),t.btn_text&&n.setText(t.btn_text),t.label&&n.setAttr("aria-label",t.label),n.addEventListener("click",async i=>{typeof t.callback=="function"?await xi(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),s.controlEl.appendChild(n)}o(MA,"render_heading_button");async function xi(s,e,t,n={}){let{scope:i=null}=n;return i?await t.call(i,e,s):await t(e,s)}o(xi,"handle_config_callback");function Z4(s,e={}){let{container:t,group_name:n,settings_config:i,group_params:r={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(n,s,i,t,r))}o(Z4,"create_settings_group_rerender");var zA=require("obsidian");function ns(s){s.settings||(s.settings={}),s.settings.smart_sources||(s.settings.smart_sources={});let e=s.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}o(ns,"ensure_smart_sources_settings");function is(s=""){return s.split(",").map(e=>e.trim()).filter(Boolean)}o(is,"parse_exclusions_csv");function w_(s,e){let t=(e??"").trim();if(!t)return s||"";let n=is(s);return n.includes(t)||n.push(t),n.join(",")}o(w_,"add_exclusion");function x_(s,e){let t=(e??"").trim();return t?is(s).filter(i=>i!==t).join(","):s?.trim()||""}o(x_,"remove_exclusion");var E_=class extends zA.FuzzySuggestModal{static{o(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=ns(this.env),t=is(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=ns(this.env);t.folder_exclusions=w_(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=ns(this.env),t=is(e.folder_exclusions),n=this.modalEl.querySelector(".sc-excluded-folders-header");if(n||(n=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(n)),n.empty(),n.createEl("h3").setText("Excluded folders"),!t.length){n.createEl("p").setText("No folders excluded yet.");return}let r=n.createEl("ul");t.forEach(a=>{let c=r.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=x_(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var DA=require("obsidian");var A_=class extends DA.Modal{static{o(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,n=this.app.vault.getMarkdownFiles().filter(r=>r.path.length>200).map(r=>r.path);for(let r of t)e.createEl("li").setText(r);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let r of n)i.createEl("li").setText(r)}};async function Q4(s,e={}){return`
<div class="sources-settings">
</div>
`}o(Q4,"build_html");async function RA(s,e={}){let t=await Q4.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return ez.call(this,s,i,e),i}o(RA,"render");async function ez(s,e,t={}){Ai({folder_exclusions:Vf,view_exclusions:Kf,re_import_sources:Yf},s,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:o((r,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(s.events?.on("model:changed",Jf(s,e))),this.attach_disposer(e,i),e}o(ez,"post_process");function Jf(s,e){return async t=>{if(t.collection_key!=="embedding_models")return;let n=e.querySelector(".re-import-sources");n.classList.add("env-setting-highlight");let i=n.querySelector(".reimport-notice")?n.querySelector(".reimport-notice"):n.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",n.appendChild(i),s.events.once("sources:reimported",()=>{n.classList.remove("env-setting-highlight"),i.remove()})}}o(Jf,"highlight_reset_data");var Vf={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:o(async function(s,e){let t=this,n=new E_(t.main.app,t),i=o(()=>{t.update_exclusions()},"selection_callback");n.open(i)},"callback")},Kf={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:o(async function(s,e){let t=this;new A_(t.main.app,t).open()},"callback")},Yf={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:o(async function(s,e){let t=this,n=e.controlEl,i=n.createEl("div",{cls:"sc-inline-confirm-row"}),r=n.querySelector("button");r.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",r.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",r.style.display="inline-block"},{once:!0})},"callback")};var FA=require("obsidian");var Si=class extends FA.FuzzySuggestModal{static{o(this,"ExcludedFilesFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a file to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=ns(this.env),t=is(e.file_exclusions);return(this.env.smart_sources?.fs?.file_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=ns(this.env);t.file_exclusions=w_(t.file_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=ns(this.env),t=is(e.file_exclusions),n=this.modalEl.querySelector(".sc-excluded-files-header");if(n||(n=this.modalEl.createEl("div",{cls:"sc-excluded-files-header"}),this.modalEl.prepend(n)),n.empty(),n.createEl("h3").setText("Excluded files"),!t.length){n.createEl("p").setText("No files excluded yet.");return}let r=n.createEl("ul");t.forEach(a=>{let c=r.createEl("li",{cls:"excluded-file-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-file-btn"}).addEventListener("click",()=>{e.file_exclusions=x_(e.file_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};async function tz(s,e={}){return`
<div class="sources-pro-settings">
</div>
`}o(tz,"build_html");async function BA(s,e={}){let t=await tz.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return sz.call(this,s,i,e),i}o(BA,"render");async function sz(s,e,t={}){Ai({folder_exclusions:Vf,file_exclusions:nz,view_exclusions:Kf,re_import_wait_time:{type:"number",name:"Re-import wait time",description:"Time in seconds to wait before re-importing a file after modification.",scope_class:"pro-setting"},"smart_blocks.embed_blocks":{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Embedding allows more granular results in semantic lookups.",scope_class:"pro-setting"},"smart_sources.min_chars":{name:"Minimum length to embed (Sources)",type:"number",description:"Minimum number of characters a source must have to be embedded.",scope_class:"pro-setting"},"smart_blocks.min_chars":{name:"Minimum length to embed (Blocks)",type:"number",description:"Minimum number of characters a block must have to be embedded.",scope_class:"pro-setting"},re_import_sources:Yf},s,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:o((r,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(s.events?.on("model:changed",Jf(s,e))),this.attach_disposer(e,i),e}o(sz,"post_process");var nz={type:"button",name:"Manage excluded files",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",scope_class:"pro-setting",callback:o(async function(s,e){let t=this,n=new Si(t.main.app,t),i=o(()=>{t.update_exclusions()},"selection_callback");n.open(i)},"callback")};async function iz(s,e={}){return`
<div class="setting-component pro-setting">
<div class="setting-item">
<div class="info setting-item-info">
<div class="setting-item-name">Excluded files</div>
<div class="setting-item-description">Manage files to exclude from the environment.</div>
</div>
<div class="control setting-item-control">
<button class="sc-add-excluded-file-btn" type="button">Edit excluded files</button>
</div>
</div>
</div>
`}o(iz,"build_html");async function UA(s,e={}){let t=await iz.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return oz.call(this,s,i,e),i}o(UA,"render");async function oz(s,e,t={}){let n=e.querySelector(".sc-add-excluded-file-btn");return n&&n.addEventListener("click",()=>{new Si(s.main.app,s).open(()=>{s.update_exclusions()})}),e}o(oz,"post_process");var WA="Chat Threads";function rz(s){return s?.chat_threads||s?.smart_chat_threads||null}o(rz,"get_threads_collection");async function GA(s={}){let e=this,t=e?.env,n=s?.modal;n?.setInstructions&&n.setInstructions([{command:"Enter",purpose:"Add chat thread to context"}]);let i=rz(t);if(!i?.items)return[{key:"chat_threads:missing",display:"Chat Threads: collection not available (stub)"}];let r=Object.values(i.items||{}).filter(Boolean);return r.length?r.map(a=>{let c=a?.key||a?.data?.key,l=a?.data?.name||a?.data?.title||c;return{key:`chat_thread:${c}`,display:String(l),select_action:o(()=>{e.add_item({key:`thread:${c}`,d:0})},"select_action")}}):[{key:"chat_threads:none",display:"No chat threads found"}]}o(GA,"context_suggest_chat_threads");function os(s={}){s?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return s.source_key?e=this.env.smart_sources.get(s.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,n)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,r=Array.isArray(n.lines)&&n.lines.length?n.lines[0]:1/0;return i-r}).map(t=>({key:t.key,display:az(t,{show_full_path:!1}),select_action:o(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:o(({modal:n})=>{n.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}o(os,"context_suggest_blocks");function az(s,e={}){if(!s?.key)return"";if(e.show_full_path??!0)return s.key.replace(/#/g," > ").replace(/\//g," > ");let n=[],[i,...r]=s.key.split("#"),a=i.split("/").pop();if(n.push(a),r.length){let c=r[r.length-1];c.startsWith("{")&&c.endsWith("}")?(r.pop(),n.push(r.pop()),s.lines&&n.push(`Lines: ${s.lines.join("-")}`)):n.push(r.pop())}return n.filter(Boolean).join(" > ")}o(az,"get_block_display_name");var HA="Add blocks";var VA=require("obsidian");var cz=VA.Platform.isMacOS?"\u2318":"Ctrl";function lz(s){return typeof s!="string"?"":s.replace(/\/+$/g,"")}o(lz,"normalize_folder_path");function dz(s,e){let t=lz(e);return!t||s===t?!0:s.startsWith(`${t}/`)}o(dz,"is_source_in_folder");function JA(s){s?.inputEl&&(s.last_input_value=s.inputEl.value,s.inputEl.value="")}o(JA,"reset_modal_input");function _z(s,e){return Object.values(s.env?.smart_sources?.items||{}).filter(n=>dz(n.key,e))}o(_z,"get_sources_list");function uz(s,e){return e.map(t=>({key:t.key,display:t.key,select_action:o(()=>{s.add_item(t.key)},"select_action"),mod_select_action:o(({modal:n}={})=>(JA(n),os.call(s,{source_key:t.key,modal:n})),"mod_select_action"),arrow_right_action:o(({modal:n}={})=>(JA(n),os.call(s,{source_key:t.key,modal:n})),"arrow_right_action")}))}o(uz,"build_source_suggestions");function Gr(s={}){console.log("context_suggest_sources",s);let e=s?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${cz} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=_z(this,s?.folder_path||"");return uz(this,t)}o(Gr,"context_suggest_sources");var KA="Add sources";var YA="Add folders";function mz(s){return typeof s!="string"?"":s.replace(/\/+$/g,"")}o(mz,"normalize_folder_path");function pz(s,e){let t=mz(e);return!t||s===t?!0:s.startsWith(`${t}/`)}o(pz,"is_source_in_folder");function hz(s,e){return Object.values(s.env?.smart_sources?.items||{}).filter(n=>pz(n.key,e)).map(n=>n.key)}o(hz,"get_source_keys_in_folder");function Xf(s){s?.inputEl&&(s.last_input_value=s.inputEl.value,s.inputEl.value="")}o(Xf,"reset_modal_input");function XA(s={}){let e=s?.modal;return e?.setInstructions&&e.setInstructions([{command:"Enter",purpose:"Browse folder sources"},{command:"Mod + Enter",purpose:"Add all sources in folder to context"},{command:"\u2192",purpose:"Browse folder sources"}]),(Array.isArray(s.folder_paths)?s.folder_paths:this.env?.smart_sources?.fs?.folder_paths||[]).map(n=>({key:n,display:n,select_action:o(({modal:i}={})=>(Xf(i),Gr.call(this,{folder_path:n,modal:i})),"select_action"),mod_select_action:o(({modal:i}={})=>{Xf(i);let r=hz(this,n);this.add_items(r)},"mod_select_action"),arrow_right_action:o(({modal:i}={})=>(Xf(i),Gr.call(this,{folder_path:n,modal:i})),"arrow_right_action")}))}o(XA,"context_suggest_folders");var rs={OUT:"out",IN:"in",BOTH:"both"};function fz(s,e){return typeof e!="number"||e<=0||!s||typeof s!="object"||!Object.prototype.hasOwnProperty.call(s,"bases_row")?!1:Number.isFinite(s.bases_row)}o(fz,"should_exclude_bases_embed_outlink");function ZA(s,e=1,{direction:t=rs.OUT,include_self:n=!1}={}){if(!s||typeof s!="object"||!s.collection)return[];let i=s.collection,r=i.links||{},a=new Set,c=[],l=o((_,u)=>{_&&(a.has(_.key)||(a.add(_.key),d.push({src:_,depth:u}),c.push({depth:u,item:_})))},"enqueue"),d=[{src:s,depth:0}];for(n&&(a.add(s.key),c.push({depth:0,item:s}));d.length;){let _=d.shift();if(!_)continue;let u=_.depth;if(u>=e)continue;let p=u+1;if(t===rs.OUT||t===rs.BOTH){let f=Array.isArray(_.src.outlinks)?_.src.outlinks:[];for(let y of f)fz(y,u)||l(i.get(y.key),p)}if(t===rs.IN||t===rs.BOTH){let f=Object.keys(r[_.src.path]||{});for(let y of f)l(i.get(y),p)}}return c}o(ZA,"get_links_to_depth");var gz=[1,2,3];function yz(s){return s?.env?.obsidian_app||s?.env?.plugin?.app||null}o(yz,"get_obsidian_app");function bz(s){let t=yz(s)?.workspace?.getActiveFile?.();return t?.path?t.path:""}o(bz,"get_active_source_key");function vz(s,e={}){if(e.source&&typeof e.source=="object")return e.source;if(typeof e.source_key=="string"&&e.source_key)return s?.env?.smart_sources?.get?.(e.source_key)||s?.env?.smart_sources?.items?.[e.source_key]||null;let t=bz(s);return t&&(s?.env?.smart_sources?.get?.(t)||s?.env?.smart_sources?.items?.[t])||null}o(vz,"resolve_target_source");function QA(s,e){if(typeof s=="string"&&s.trim()!==""){let n=Number(s);Number.isFinite(n)&&(s=n)}if(typeof s!="number"||!Number.isFinite(s))return e;let t=Math.floor(s);return Number.isFinite(t)&&t>=1?t:e}o(QA,"coerce_positive_int");function kz(s){return QA(s,1)}o(kz,"normalize_max_depth");function wz(s){if(!Array.isArray(s))return[];let e=s.map(t=>QA(t,Number.NaN)).filter(t=>Number.isInteger(t)&&t>=1);return[...new Set(e)].sort((t,n)=>t-n)}o(wz,"normalize_depth_options");function xz(s={}){let e=wz(s.depth_options);if(e.length)return{depth_options:e,max_depth:e[e.length-1]};if(s.max_depth!==void 0){let n=kz(s.max_depth);return{max_depth:n,depth_options:[n]}}let t=gz.slice();return{depth_options:t,max_depth:t[t.length-1]}}o(xz,"resolve_depth_settings");function Ez(s){return s&&Object.values(rs).includes(s)?s:rs.BOTH}o(Ez,"normalize_direction");function Az(s){let t=(Array.isArray(s?.outlinks)?s.outlinks:[]).filter(n=>n&&typeof n.key=="string"&&n.embedded===!0).map(n=>n.key);return new Set(t)}o(Az,"get_embedded_outlink_keys");function Sz(s=[],e=null){if(!Array.isArray(s)||!s.length)return[];let t=e?.key,n=Az(e),i=new Map;for(let a=0;a<s.length;a+=1){let c=s[a],l=c?.item,d=l?.key;if(!d||typeof d!="string"||t&&d===t)continue;let _=typeof c?.depth=="number"&&Number.isFinite(c.depth)?c.depth:0;_>0&&n.has(d)&&(_=0);let u=i.get(d);(!u||_<u.depth)&&i.set(d,{depth:_,item:l})}let r=Array.from(i.values());return r.sort((a,c)=>{if(a.depth!==c.depth)return a.depth-c.depth;let l=String(a.item?.key||""),d=String(c.item?.key||"");return l.localeCompare(d)}),r}o(Sz,"normalize_graph_links");function eS(s,e=[]){let t=[];for(let n=0;n<e.length;n+=1){let i=e[n];if(!i||typeof i.key!="string")continue;let r=Number.isFinite(i.d)?i.d:0,a=s?.data?.context_items?.[i.key],c=Number.isFinite(a?.d)?a.d:null;t.push({key:i.key,d:c===null?r:Math.min(c,r)})}return t}o(eS,"normalize_items_preserving_depth");function tS(s,e=[]){if(!(!e||!e.length)){if(typeof s?.add_items=="function"){s.add_items(e);return}if(typeof s?.add_item=="function")for(let t=0;t<e.length;t+=1)s.add_item(e[t])}}o(tS,"add_ctx_items");function Cz(s=[],e=1){return s.filter(t=>t?.item?.key&&typeof t.depth=="number"&&t.depth<=e).map(t=>({key:t.item.key,d:t.depth}))}o(Cz,"get_link_payloads_up_to_depth");function Oz(s,e={}){let t=e.links||[];return(Array.isArray(e.depth_options)&&e.depth_options.length?e.depth_options:[3]).map(i=>({key:`links_depth_${i}`,display:`Add all up to depth ${i}`,select_action:o(()=>{let r=Cz(t,i);r.length&&tS(s,eS(s,r))},"select_action")}))}o(Oz,"build_add_all_links_suggestions");function qz(s,e={}){return(e.links||[]).filter(n=>n?.item?.key).map(n=>({key:n.item.key,display:n.item.key,display_right:`depth: ${n.depth}`,select_action:o(()=>{let i=eS(s,[{key:n.item.key,d:n.depth}]);tS(s,i)},"select_action")}))}o(qz,"build_link_suggestions");async function S_(s={}){let e=s?.modal;e?.setInstructions&&e.setInstructions([{command:"Enter",purpose:"Add link(s) to context"}]);let t=vz(this,s);if(!t)return[];let{max_depth:n,depth_options:i}=xz(s),r=Ez(s.direction),a=await ZA(t,n,{direction:r,include_self:!0}),c=Sz(a,t);return c.length?[...Oz(this,{links:c,depth_options:i}),...qz(this,{links:c})]:[]}o(S_,"context_suggest_links");var sS="Add links";var $z=!!(typeof navigator<"u"&&/Mac/i.test(navigator.platform)||typeof process<"u"&&process.platform==="darwin"),jz=$z?"\u2318":"Ctrl",Hr=[1,2,3];function Tz(s){return typeof s!="string"?"":s.replace(/\/+$/g,"")}o(Tz,"normalize_folder_path");function Nz(s,e){let t=Tz(e);return!t||s===t?!0:s.startsWith(`${t}/`)}o(Nz,"is_source_in_folder");function Zf(s){s?.inputEl&&(s.last_input_value=s.inputEl.value,s.inputEl.value="")}o(Zf,"reset_modal_input");function Pz(s,e={}){return Object.values(s.env?.smart_sources?.items||{}).filter(n=>Nz(n.key,e.folder_path||""))}o(Pz,"get_sources_list");function Iz(s,e={}){return(e.sources||[]).map(n=>({key:n.key,display:n.key,select_action:o(()=>{s.add_item(n.key)},"select_action"),mod_select_action:o(({modal:i}={})=>(Zf(i),os.call(s,{source_key:n.key,modal:i})),"mod_select_action"),shift_select_action:o(({modal:i}={})=>(Zf(i),S_.call(s,{source:n,max_depth:Hr[Hr.length-1],depth_options:Hr,modal:i})),"shift_select_action"),arrow_right_action:o(({modal:i}={})=>(Zf(i),os.call(s,{source_key:n.key,modal:i})),"arrow_right_action")}))}o(Iz,"build_source_suggestions");function nS(s={}){let e=s?.modal;if(e){let n=Hr[Hr.length-1];e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${jz} + Enter / \u2192`,purpose:"Suggest source blocks"},{command:"Shift + Enter",purpose:`Follow links (up to depth ${n})`}])}let t=Pz(this,{folder_path:s?.folder_path||""});return Iz(this,{sources:t,folder_path:s?.folder_path||""})}o(nS,"context_suggest_sources");var iS="Add sources";function Qf(s,e){let t=s.vault.getMarkdownFiles(),n=[];for(let i of t){let r=s.metadataCache.getFileCache(i);[...r?.tags?.map(c=>c.tag)||[],...r?.frontmatter?.tags||[]].map(c=>c.startsWith("#")?c:`#${c}`).includes(e)&&n.push(i.path)}return n}o(Qf,"get_files_with_tag");function oS(s){return s?.env?.obsidian_app||s?.env?.plugin?.app||null}o(oS,"get_obsidian_app");function Lz(s,e={}){let{tags:t}=e;return Object.entries(t).map(([n,i])=>({key:n,display:n,display_right:`count: ${i}`,select_action:o(({modal:r}={})=>Jr.call(s,{tag:n,modal:r}),"select_action"),mod_select_action:o(({modal:r}={})=>(Mz(s,{tag:n}),Jr.call(s,{modal:r})),"mod_select_action"),arrow_right_action:o(({modal:r}={})=>Jr.call(s,{tag:n,modal:r}),"arrow_right_action")}))}o(Lz,"build_tag_suggestions");function Mz(s,e={}){let t=oS(s);if(!t)return[];let n=Qf(t,e.tag);return n.length&&s.add_items(n),n}o(Mz,"add_tagged_sources");function zz(s,e={}){let{file_paths:t}=e;return t.map(n=>({key:n,display:n,select_action:o(()=>{s.add_item(n)},"select_action")}))}o(zz,"build_tag_source_suggestions");function Jr(s={}){let e=s?.modal;e?.setInstructions&&(typeof s.tag=="string"&&s.tag.length?e.setInstructions([{command:"Enter",purpose:"Add file to context"}]):e.setInstructions([{command:"Enter",purpose:"Browse tag sources"},{command:"Mod + Enter",purpose:"Add all tagged sources to context"},{command:"\u2192",purpose:"Browse tag sources"}]));let t=oS(this);if(!t)return[];if(typeof s.tag=="string"&&s.tag.length){let i=Qf(t,s.tag);return zz(this,{tag:s.tag,file_paths:i})}let n=t.metadataCache.getTags();return Lz(this,{tags:n,modal:e})}o(Jr,"context_suggest_tags");var rS="Add tags";var aS={collections:{bases_caches:vA,chat_completion_models:wA,ranking_models:AA,smart_blocks:PA},item_types:{ChatCompletionModel:Vs,RankingModel:Ks},items:{chat_completion_model:{class:Vs},ranking_model:{class:Ks}},modules:{},components:{settings_env_sources:{render:BA},settings_sources_file_exclusions:{render:UA}},actions:{context_suggest_chat_threads:{action:GA,display_name:WA},context_suggest_folders:{action:XA,display_name:YA},context_suggest_links:{action:S_,display_name:sS},context_suggest_sources:{action:nS,display_name:iS},context_suggest_tags:{action:Jr,display_name:rS}}};var ps=require("obsidian");var C_=class{static{o(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var O_=class extends C_{static{o(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let n=e==="*"?"*":e,i=this.handlers[n]||(this.handlers[n]=[]),r={id:this._next_id++,cb:t};return i.push(r),()=>this.off_entry(n,r.id)}once(e,t=()=>{}){let n=e==="*"?"*":e,i=this.handlers[n]||(this.handlers[n]=[]),r={id:this._next_id++,cb:null},a=o((c,l)=>{this.off_entry(n,r.id),t(c,l)},"wrapper");return r.cb=a,i.push(r),()=>this.off_entry(n,r.id)}off(e,t){let n=this.handlers[e];if(!(!n||!t)){for(let i=n.length-1;i>=0;i--)if(n[i].cb===t){n.splice(i,1);break}}}off_entry(e,t){let n=this.handlers[e];if(!n)return;let i=n.findIndex(r=>r.id===t);i!==-1&&n.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let n=this.handlers[e],i=this.handlers["*"];if(!n&&!i)return;let r=n?[...n]:[],a=i?[...i]:[];for(let c=0;c<r.length;c++)r[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Xs=class s{static{o(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let n=new s(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:o(()=>n,"get")}),n}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new O_(this)),this._adapter}on(e,t=n=>{}){return this.adapter.on(e,t)}once(e,t=n=>{}){return this.adapter.once(e,t)}off(e,t=n=>{}){return this.adapter.off(e,t)}emit(e,t={}){let n={...t};return n.at===void 0&&(n.at=Date.now()),Object.freeze(n),this.adapter.emit(e,n)}};async function Dz(s,e={}){let t=Object.entries(s.settings_config).map(([r,a])=>(a.setting||(a.setting=r),this.render_setting_html(a))).join(`
`),n=Object.entries(s.collections).map(([r,a])=>`<div data-smart-settings="${r}"></div>`).join(`
`);return`
<div class="">
${t}
${n}
</div>
`}o(Dz,"build_html");async function cS(s,e={}){let t=await Dz.call(this,s,e),n=this.create_doc_fragment(t);return await Rz.call(this,s,n,e)}o(cS,"render");async function Rz(s,e,t={}){await this.render_setting_components(e,{scope:s});let n=e.querySelectorAll("[data-smart-settings]");for(let i of n){let r=i.dataset.smartSettings;await s[r].render_settings(i)}return e}o(Rz,"post_process");var q_=class{static{o(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let n=new this(e,t);return await n.load(),e.smart_settings=n,Object.defineProperty(e,"settings",{get(){return n.settings},set(i){n.settings=i}}),n}static create_sync(e,t={}){let n=new this(e,t);return n.load_sync(),e.smart_settings=n,Object.defineProperty(e,"settings",{get(){return n.settings},set(i){n.settings=i}}),n}get settings(){return Fz(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",Bz(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function Fz(s,e){let t=new WeakMap,n=new WeakMap,i=o((a,c)=>{if(!tg(a)||n.has(a))return a;if(t.has(a))return t.get(a);let l=r(a,c);return t.set(a,l),n.set(l,a),l},"wrap_value"),r=o((a,c)=>new Proxy(a,{set(l,d,_){let u=[...c,d],p=eg(l[d]),f=eg(_);return l[d]=i(_,u),Uz(p,f)&&e({type:"set",path:u,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],u=eg(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:u}),!0}}),"create_proxy");return i(s,[])}o(Fz,"observe_object");function Bz(s){let e=Array.isArray(s.path)?s.path:[];return{type:s.type,path:e,path_string:e.join("."),value:s.value,previous_value:s.previous_value}}o(Bz,"build_settings_changed_event");function eg(s){if(!tg(s))return s;if(typeof structuredClone=="function")try{return structuredClone(s)}catch{}try{return JSON.parse(JSON.stringify(s))}catch{return s}}o(eg,"snapshot_value");function Uz(s,e){return lS(s)!==lS(e)}o(Uz,"has_changed");function lS(s){if(s===void 0)return"undefined";if(Number.isNaN(s))return"number:NaN";if(s===1/0)return"number:Infinity";if(s===-1/0)return"number:-Infinity";if(!tg(s))return`${typeof s}:${String(s)}`;try{return`object:${JSON.stringify(s)}`}catch{return`object:${String(s)}`}}o(lS,"serialize_value");function tg(s){return typeof s=="object"&&s!==null}o(tg,"is_observable");function dS(s){return s.collections||(s.collections={}),s.modules||(s.modules={}),s.items||(s.items={}),Object.entries(s.collections).forEach(([e,t])=>{typeof t=="function"&&(s.collections[e]={class:t});let n=ke(e);n!==e&&(s.collections[n]=s.collections[e],delete s.collections[e]),s.collections[n].collection_key||(s.collections[n].collection_key=n),t.item_type&&(s.items[t.item_type.key||ke(t.item_type.name)]={class:t.item_type})}),Object.entries(s.modules).forEach(([e,t])=>{typeof t=="function"&&(s.modules[e]={class:t});let n=ke(e);n!==e&&(s.modules[n]=s.modules[e],delete s.modules[e])}),s.item_types||(s.item_types={}),s.items||(s.items={}),Object.entries(s.item_types).forEach(([e,t])=>{if(typeof t=="function"){let n=ke(e);s.items[n]={class:t,actions:{},...s.items[n]||{}}}}),s}o(dS,"normalize_opts");function Wz(s){if(!s||typeof s!="object")return!1;let e=Object.getPrototypeOf(s);return e===Object.prototype||e===null}o(Wz,"is_plain_object");function $_(s){if(Array.isArray(s))return s.map(e=>$_(e));if(Wz(s)){let e={};for(let[t,n]of Object.entries(s))e[t]=$_(n);return e}return s}o($_,"deep_clone_config");function Ci(s,e){let t=_S(s),n=_S(e),i=Math.max(t.parts.length,n.parts.length);for(let r=0;r<i;r++){let a=t.parts[r]!==void 0?t.parts[r]:0,c=n.parts[r]!==void 0?n.parts[r]:0;if(a>c)return 1;if(a<c)return-1}return t.type===n.type?0:t.type==="semver"&&n.type!=="semver"?1:n.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&n.type==="none"?t.parts[0]===0?0:1:n.type==="number"&&t.type==="none"?n.parts[0]===0?0:-1:0}o(Ci,"compare_versions");function _S(s){if(s==null)return{type:"none",parts:[0,0,0]};if(typeof s=="number"){if(!Number.isFinite(s))return{type:"none",parts:[0,0,0]};let e=Math.floor(s),t=Math.floor((s-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof s=="string"){let e=s.trim();if(!e)return{type:"none",parts:[0,0,0]};let n=e.split(".").map(i=>{let r=i.match(/^\d+/);if(!r)return 0;let a=Number.parseInt(r[0],10);return Number.isNaN(a)?0:a});for(;n.length<3;)n.push(0);return{type:"semver",parts:n}}return{type:"none",parts:[0,0,0]}}o(_S,"normalize_version_value");function Vr(s){return s===null||typeof s!="object"||Array.isArray(s)||s instanceof Function||s instanceof Date?!1:Object.getPrototypeOf(s)===Object.prototype}o(Vr,"is_plain_object");function Tt(s,e,t=[]){if(!Vr(s)||!Vr(e)||t.includes(e))return s;t.push(e);for(let n of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,n))continue;let i=e[n];if(Array.isArray(s[n])&&Array.isArray(i))for(let r of i)if(typeof r=="function"){let a=r.name;s[n].some(l=>typeof l=="function"&&l.name===a)||s[n].push(r)}else(r===null||["string","number","boolean","undefined"].includes(typeof r))&&s[n].includes(r)||s[n].push(r);else Vr(i)?(Vr(s[n])||(s[n]={}),Tt(s[n],i,[...t])):Object.prototype.hasOwnProperty.call(s,n)||(s[n]=i)}return s}o(Tt,"deep_merge_no_overwrite");function Nt(s,e){let t=s.version,n=e.version;for(let[i,r]of Object.entries(e)){if(i==="collections"&&r&&typeof r=="object"){s.collections||(s.collections={});for(let[a,c]of Object.entries(r)){let l=s.collections[a];if(!l){s.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(Ci(d,_)>0){let p={...c};Tt(p,l),s.collections[a]=p}else Tt(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&r&&typeof r=="object"){s[i]||(s[i]={});for(let[a,c]of Object.entries(r)){if(!s[i][a]){s[i][a]={...c};continue}let l=s[i][a],d=c&&c.version,_=l&&l.version;Ci(d,_)>0?(s[i][a]=c,s[i][a].version=d||-1):Tt(l,c)}continue}Array.isArray(r)?Array.isArray(s[i])?r.length>0&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="boolean")?s[i]=Array.from(new Set([...s[i],...r])):s[i]=[...s[i],...r]:r.length>0&&(typeof r[0]=="string"||typeof r[0]=="number"||typeof r[0]=="boolean")?s[i]=Array.from(new Set(r)):s[i]=[...r]:r&&typeof r=="object"?(s[i]||(s[i]={}),Tt(s[i],r)):s[i]=r}return s}o(Nt,"merge_env_config");function uS(s={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:n}=s;return(e!==void 0||t!==void 0||n!==void 0)&&(s.smart_sources=s.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!s.smart_sources?.file_exclusions?.length||s.smart_sources?.file_exclusions==="Untitled")&&(s.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!s.smart_sources.folder_exclusions?.length&&(s.smart_sources.folder_exclusions=t),n!==void 0&&n.length&&!s.smart_sources.excluded_headings?.length&&(s.smart_sources.excluded_headings=n)),delete s.file_exclusions,delete s.folder_exclusions,delete s.excluded_headings,s}o(uS,"migrate_exclusion_settings_2025_08_22");var Gz=typeof globalThis<"u"?globalThis:Function("return this")(),Kr=class{static{o(this,"SmartEnv")}static version="2.2.8";scope_name="smart_env";static global_ref=Gz;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=Xs.create(this,Jz(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([n])=>this.primary_main_key&&n===this.primary_main_key?-1:0);for(let[n,i]of t){if(!i?.main){console.warn(`SmartEnv: '${n}' unloaded, skipping`),delete this.smart_env_configs[n];continue}if(!i?.opts){console.warn(`SmartEnv: '${n}' opts missing, skipping`);continue}Nt(this._config,$_(dS(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:n}=t||{};if(n)for(let[i,r]of Object.entries(n.collections||{})){let a=r?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:Ci(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,Hz(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let n=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(n),t(this.global_env))},1e3)}else{let n=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(n),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let n={};this.global_env&&Ci(this.version,this.global_env.constructor?.version||0)>0&&(n.primary_main_key=ke(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(n);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let n=ke(e.constructor.name);this.smart_env_configs[n]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:o(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await q_.create(this),this.config.default_settings&&Tt(this.settings,this.config.default_settings),uS(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:n}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let n=e.collections[t]?.class;n&&(n.default_settings&&Tt(this.settings,{[t]:n.default_settings}),typeof n.init=="function"&&(await n.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((n,i)=>{let r=this.config.collections?.[n]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return r-a});for(let n of t){let i=Date.now();typeof this[n]?.process_load_queue=="function"&&(await this[n].process_load_queue(),this[n].load_time_ms=Date.now()-i,this.collections[n]="loaded",console.log(`Loaded ${this[n].collection_key} in ${this[n].load_time_ms}ms`))}}static unload_main(e){let t=ke(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let n=this.opts.modules[e];return n?(t={...n,class:null,...t},new n.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||cS}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,n={}){let i=this.get_component(e,t);return i?await i(t,n):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let n=t.collection_key??t.scope_name,i=n?`${n}-${e}`:e;if(!this._components[i])try{if(this.opts.components[n]?.[e]){let r=this.opts.components[n][e],a=r.render||r;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let r=this.opts.components[e],a=r.render||r;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${n}`)}catch(r){console.error("Error getting component",r),console.log(`scope_name: ${n}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[n]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.config.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(n=>n.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let n=e.map(i=>{let r=i.split("/").slice(-2,-1)[0];return{dir:r,count:this.fs.file_paths.filter(a=>a.includes(r)).length}});t=n.reduce((i,r)=>r.count>i.count?r:i,n[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(ht(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(n=>n.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((n,i,r)=>r.indexOf(n)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function Hz(s){return{items:Object.fromEntries(Object.entries(s.items||{}).map(([e,t])=>[e,t.data]))}}o(Hz,"collection_to_plain");function Jz(s){if(!s)return{};if(typeof s=="function")return{adapter_class:s};let e=s.adapter_class||s.adapter;return e?{adapter_class:e}:{}}o(Jz,"build_events_opts");function Vz(s,{case_sensitive:e,extended_glob:t,windows_paths:n}){let i=Yz(s,t),r=Kz(i,n),a=e?"":"i";return new RegExp(`^${r}$`,a)}o(Vz,"create_regex");function Kz(s,e){return e?s.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):s}o(Kz,"adjust_for_windows_paths");function Yz(s,e){let t=!1,n=0,i="";for(let r=0;r<s.length;r++){let a=s[r];switch(a){case"\\":r+1<s.length?(i+=`\\${s[r+1]}`,r++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||s.indexOf("]",r+1)===-1?i+="\\[":(t=!0,s[r+1]==="!"?(i+="[^",r++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||s.indexOf("}",r+1)===-1?i+="\\{":(n++,i+="(");break;case"}":!t&&n>0?(n--,i+=")"):i+="\\}";break;case",":!t&&n>0?i+="|":i+=",";break;case"*":t?i+="\\*":r+1<s.length&&s[r+1]==="*"?(i+=".*",r++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}o(Yz,"glob_to_regex_pattern");function mS(s,e={}){let n={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return s===""?/^$/:s==="*"&&!n.windows_paths?/^[^/]+$/:s==="**"&&!n.windows_paths?/^.+$/:Vz(s,n)}o(mS,"glob_to_regex");function pS(s,e){let t=[];for(let n=0;n<s.length;n++){let i=e.toLowerCase().split(""),r=!0,a=0,c=s[n],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{r=!1;break}}r&&t.push({name:c,distance:a})}return t.sort((n,i)=>n.distance-i.distance),t.map(n=>n.name)}o(pS,"fuzzy_search");var j_=class{static{o(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(n=>this.add_ignore_pattern(n)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(mS(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...n){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...n);return this.post_process(i)}use_adapter_sync(e,t,...n){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...n);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(n){return console.warn("Error during read: "+n.message,e),n.code==="ENOENT"?null:{error:n.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(n){throw console.error("Error during write:",n),n}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let n=this.file_paths.filter(i=>i.includes(e));return pS(n,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var Xz=Y(require("obsidian"),1);var T_=class{static{o(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=Xz,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:o(()=>{let n=this.obsidian_app.vault.getAbstractFileByPath(e);return n?{ctime:n.stat.ctime,mtime:n.stat.mtime,size:n.stat.size,isDirectory:o(()=>n instanceof this.obsidian.TFolder,"isDirectory"),isFile:o(()=>n instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let r=i.path.lastIndexOf("/");return!(r===-1&&e!==""||i.path.slice(0,r)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,n={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!n.no_cache){let r=this.obsidian_app.vault.getFileByPath(e);if(r)return await this.obsidian_app.vault.cachedRead(r)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let r=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(r)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let n=e.split("/").slice(0,-1).join("/");return await this.exists(n)||(await this.mkdir(n),console.log(`Created folder: ${n}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:n}=t,i=o((r,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(r,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(n.vault.on("create",r=>{i("sources:created",{path:r.path,event_source:"obsidian:vault.create"})})),t.registerEvent(n.vault.on("modify",r=>{i("sources:modified",{path:r.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(n.vault.on("rename",(r,a)=>{i("sources:renamed",{path:r.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(n.vault.on("delete",r=>{i("sources:deleted",{path:r.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(n.workspace.on("editor-change",(r,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function N_(s){let e=document.createRange();e.selectNodeContents(s),e.deleteContents()}o(N_,"empty");var hS=(()=>{let s=new Map;return(e,t)=>{let n=t.trim(),i=s.get(n);i||(i=document.createElement("template"),i.innerHTML=n,s.set(n,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var fS=o((s,e)=>{let n=document.createRange().createContextualFragment(e.trim());s.replaceChildren(n)},"replace_with_fragment");var Zz=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,P_=o((s,e)=>{let t=e.trim();(Zz.test(t)?fS:hS)(s,t)},"safe_inner_html");var Qz=o(s=>typeof s!="string"?null:`style-sheet-${le(s)}`,"get_style_sheet_id"),I_=new WeakMap,L_=new WeakMap,M_=class{static{o(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let n=e.querySelectorAll(".setting-component"),i=[];for(let r of n)i.push(this.render_setting_component(r,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,n=null){return Pe(e,t,n)}set_by_path(e,t,n,i=null){Ie(e,t,n,i)}delete_by_path(e,t,n=null){Ff(e,t,n)}escape_html(e){return Ye(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([n,i])=>n.includes("class")?"":typeof i=="number"?`data-${n.replace(/_/g,"-")}=${i}`:`data-${n.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),r=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(r,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let r=i.dataset.smartSetting;if(!r||L_.has(i))return;let a=o(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,r,c)},"handler");L_.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=L_.get(i);c&&(i.removeEventListener("change",c),L_.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=Qz(e);if(!t||document.getElementById(t))return;let n=document.createElement("style");n.id=t,n.textContent=e,document.head.appendChild(n);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(n=>n.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){N_(e)}safe_inner_html(e,t){P_(e,t)}attach_disposer(e,t){if(!e)return;let n=e.ownerDocument,i=n&&n.defaultView,r=i&&i.MutationObserver;if(!n||!i||!r||!n.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=I_.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},I_.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new r(()=>{if(n.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}I_.get(e)===c&&I_.delete(e)}}});c.observer=l,l.observe(n.body,{childList:!0,subtree:!0})}}};var z_=class{static{o(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,n,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,n,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,n){}post_change(e,t,n){}revert_setting(e,t,n){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let n=e.dataset.setting,i=t.scope||this.main.main,r=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,n,r);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,n,a,r));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,n,a,i,r);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,n,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:n,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,n,i,r){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===n,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(n)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===n,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(n)),l.onChange(_=>{this.handle_on_change(t,_,e,i,r)})}),a}render_text_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,r),2e3)})}),a}render_password_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_number_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof n<"u"&&(c.inputEl.value=parseInt(n)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,r),2e3)})}),a}render_toggle_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addToggle(c=>{let l=n??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,r))}),a}render_textarea_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(n||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_textarea_array_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(n)?n.join(`
`):n||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,r),2e3)})}),a}render_button_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,n,e,i,r)}})}),a}render_remove_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,r),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,n,e,i,r)}})}),a}render_folder_select_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,n,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,r)})}),a}render_file_select_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),n&&c.setValue(n),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,n,e,i,r)})}),a}render_slider_component(e,t,n,i,r){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof n<"u"?parseFloat(n):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,r)})}),a}render_html_component(e,t,n,i){return this.safe_inner_html(e,n),e}render_array_component(e,t,n,i,r){let a=new this.setting_class(e),c=Array.isArray(n)?[...n]:[],l=document.createElement("div");l.className="array-items-container";let d=o(()=>{l.innerHTML="",c.forEach((y,g)=>{let k=document.createElement("div");k.className="array-item-row";let v=document.createElement("input");v.type="text",v.value=y,v.placeholder="Value";let b=document.createElement("button");b.textContent="\u2715",b.title="Remove",v.addEventListener("change",()=>{c[g]=v.value,f()}),b.addEventListener("click",()=>{c.splice(g,1),d(),f()}),k.appendChild(v),k.appendChild(b),l.appendChild(k)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=u.value.trim();y&&(c.push(y),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=o(()=>{this.handle_on_change(t,[...c],e,i,r)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,n,i,r){try{let a=new this.setting_class(e),c=typeof n=="object"&&n!==null?{...n}:{},l=document.createElement("div");l.className="json-pairs-container";let d=o(()=>{l.innerHTML="",Object.entries(c).forEach(([g,k],v)=>{let b=document.createElement("div");b.className="json-pair-row";let A=document.createElement("input");A.type="text",A.value=g,A.placeholder="Property";let S=document.createElement("input");S.type="text",S.value=k,S.placeholder="Value";let $=document.createElement("button");$.textContent="\u2715",$.title="Remove",A.addEventListener("change",()=>{let j=A.value.trim();j&&j!==g&&(c[j]=c[g],delete c[g],d(),y())}),S.addEventListener("change",()=>{c[A.value]=S.value,y()}),$.addEventListener("click",()=>{delete c[A.value],d(),y()}),b.appendChild(A),b.appendChild(S),b.appendChild($),l.appendChild(b)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),y())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=o(()=>{this.handle_on_change(t,{...c},e,i,r)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,n,i){t.dataset.btn&&e.addButton(r=>{r.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&r.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](n,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(n,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(r.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[n,i])=>{if(!n.startsWith("option"))return t;let[r,a]=i.split("|");return t.push({value:r,name:a||r}),t},[])}handle_on_change(e,t,n,i,r){if(this.pre_change(e,t,n,i),n.dataset.validate&&!this[n.dataset.validate](e,t,n,i)){n.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,n,i);return}if(this.main.set_by_path(i.settings,e,t,r),n.dataset.callback){let a=this.main.get_by_path(i,n.dataset.callback);a&&a(e,t,n,i)}this.post_change(e,t,n,i)}render_button_with_confirm_component(e,t,n,i){let r=new this.setting_class(e);return r.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,n,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),r}empty(e){N_(e)}safe_inner_html(e,t){P_(e,t)}};var ft=require("obsidian");var D_=class extends z_{static{o(this,"SmartViewObsidianAdapter")}get setting_class(){return ft.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,n){return super.render_text_component(e,t,n)}async render_markdown(e,t){let n=t.env.smart_connections_plugin?.connections_view||new ft.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),r=i.querySelector(".inner");try{await ft.MarkdownRenderer.render(t.env.plugin.app,e,r,t?.file_path||"",n)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,ft.getIcon)(e).outerHTML}is_mod_event(e){return ft.Keymap.isModEvent(e)}render_folder_select_component(e,t,n,i,r){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,r)}),l.setValue(n)}),a}};function R_(s){return s.endsWith("Item")?s.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():s.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}o(R_,"collection_instance_name_from");function gS(s){let e=JSON.stringify(s),t=0;if(e.length===0)return t;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}o(gS,"create_uid");function F_(s,e,t=new WeakMap){if(s===e)return!0;if(s===null||e===null||s===void 0||e===void 0||typeof s!=typeof e||Array.isArray(s)!==Array.isArray(e))return!1;if(Array.isArray(s))return s.length!==e.length?!1:s.every((n,i)=>F_(n,e[i],t));if(typeof s=="object"){if(t.has(s))return t.get(s)===e;t.set(s,e);let n=Object.keys(s),i=Object.keys(e);return n.length!==i.length?!1:n.every(r=>F_(s[r],e[r],t))}return s===e}o(F_,"deep_equal");function B_(s,e){return e?s.split("/").join(" > ").replace(".md",""):s.split("/").pop().replace(".md","")}o(B_,"get_item_display_name");function U_(s,e){let t=e||{},n=o(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=o(m=>typeof m=="function","is_function"),r=o(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=o(m=>n(m)&&i(m.action),"is_action_object"),c=o(m=>i(m)||a(m)||r(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=o(m=>{if(!n(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let O=Object.getOwnPropertyDescriptor(m,w);if(!O)continue;let E={...O};"value"in E&&n(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=o(m=>{if(!n(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let O of h){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E){let q=E.value;if(c(q)){w=!0;continue}if(n(q)){if(_(q)){w=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=o(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=n(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=o(m=>{let h=Object.create(null),w=new Map;for(let O of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,O);if(E){if("value"in E&&_(E.value)){w.set(O,d(E.value));continue}try{Object.defineProperty(h,O,u(E))}catch{h[O]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=o((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=o((m,h,w=[])=>{if(!m||!h)return;let O=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(O.has(E))continue;let q=Object.getOwnPropertyDescriptor(m,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),b=o(m=>{let h=new m(s),w=h.action||h.run||h.execute||h.call;if(i(w)){let O=w.bind(h);return v(m,O),v(h,O),O.instance=h,O}return v(m,h),h},"instantiate_class"),A=o(m=>{if(r(m))return b(m);if(a(m)){let h=m.action.bind(s);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(s);return v(m,h),h}return n(m)?d(m):m},"bind_or_clone"),S=o(()=>{let m=s?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=y.get(m);return h&&n(h)?h:null},"scope_actions_for"),$=o((m,h,w)=>(m[h]=w,w),"cache_result"),j=o((m,h)=>{let w=S();return w&&g(w,h)?$(m,h,A(w[h])):g(f,h)?$(m,h,A(f[h])):$(m,h,void 0)},"compute_and_cache"),C=o(()=>{let m=S(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=o((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:o((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:o((m,h)=>{if(h in m)return!0;let w=S();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:o(()=>C(),"ownKeys"),getOwnPropertyDescriptor:o((m,h)=>{if(g(m,h))return x(m,h);let w=S();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:o((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:o((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:o((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}o(U_,"create_actions_proxy");var de=class s{static{o(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&ht(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let n=new this(e,t);return n.init(),n}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let n=e.defaults[t];typeof n=="object"?this[t]={...n,...this[t]}:this[t]=this[t]===void 0?n:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return gS(this.data)}update_data(e){let t=this.sanitize_data(e),n={...this.data};return ht(n,t),!F_(this.data,n)?(this.data=n,!0):!1}sanitize_data(e){return e instanceof s?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,n)=>(t[n]=this.sanitize_data(e[n]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:n=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:r,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(n?.includes(this.key)||i&&this.key.startsWith(i)||r&&r.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=U_(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),R_(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),R_(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),ke(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}once_event(e,t){return this.env.events?.once(e,n=>{n?.item_key&&n.item_key!==this.key||t(n)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return B_(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var e3=Object.getPrototypeOf(async function(){}).constructor,_e=class{static{o(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),n=t||new this.item_type(this.env);n._queue_save=!t;let i=n.update_data(e);return!t&&!n.validate_save()?n:(t||this.set(n),t&&!i?t:n.init instanceof e3?new Promise(r=>{n.init(e).then(()=>r(n))}):(n.init(e),n))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),n=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return ht(t.data,n),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:n}=e;for(let i of Object.values(this.items)){if(n&&t.length>=n)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let n=this.filter(e);return n[Math.floor(Math.random()*n.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(n=>n.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],n=e+"_adapter",i=t?.[n]??this.env.opts.collections?.smart_collections?.[n];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,n)=>{let i=t?.class?.version||t.version||0;return(n?.class?.version||n.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let n=o(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[r,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=n(c.callback)),c.btn_callback&&(c.btn_callback=n(c.btn_callback)),c.options_callback&&(c.options_callback=n(c.options_callback));let l=n(this.process_setting_key(r));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,n=>{n?.collection_key&&n.collection_key!==this.collection_key||t(n)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=U_(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let n=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(n),e}};var W_=class{static{o(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},G_=class{static{o(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function H_(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.min===Number.POSITIVE_INFINITY){let{minScore:n,minObj:i}=yS(s.results);s.min=n,s.minResult=i}}else if(e.score>s.min){s.results.add(e),s.results.delete(s.minResult);let{minScore:n,minObj:i}=yS(s.results);s.min=n,s.minResult=i}}o(H_,"results_acc");function vS(s,e,t=10){if(s.results.size<t){if(s.results.add(e),s.results.size===t&&s.max===Number.NEGATIVE_INFINITY){let{maxScore:n,maxObj:i}=bS(s.results);s.max=n,s.maxResult=i}}else if(e.score<s.max){s.results.add(e),s.results.delete(s.maxResult);let{maxScore:n,maxObj:i}=bS(s.results);s.max=n,s.maxResult=i}}o(vS,"furthest_acc");function yS(s){let e=Number.POSITIVE_INFINITY,t=null;for(let n of s)n.score<e&&(e=n.score,t=n);return{minScore:e,minObj:t}}o(yS,"find_min");function bS(s){let e=Number.NEGATIVE_INFINITY,t=null;for(let n of s)n.score>e&&(e=n.score,t=n);return{maxScore:e,maxObj:t}}o(bS,"find_max");function Xe(s,e){let n=s.score-e.score;return Math.abs(n)<1e-9?0:n>0?-1:1}o(Xe,"sort_by_score");function J_(s,e){return Xe(s,e)}o(J_,"sort_by_score_descending");function kS(s,e){return Xe(s,e)*-1}o(kS,"sort_by_score_ascending");var V_=class extends W_{static{o(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:n=50}=t,i=this.collection.filter(t).reduce((r,a)=>{if(!a.vec)return r;let c={item:a,score:Ys(e,a.vec)};return H_(r,c,n),r},{min:0,results:new Set});return Array.from(i.results).sort(J_)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:n=50}=t,i=this.collection.filter(t).reduce((r,a)=>{if(!a.vec)return r;let c={item:a,score:Ys(e,a.vec)};return vS(r,c,n),r},{max:0,results:new Set});return Array.from(i.results).sort(kS)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(n=>n.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((n,i)=>{let r=e[i];r.vec=n.vec,r.data.last_embed=r.data.last_read,n.tokens!==void 0&&(r.tokens=n.tokens),r.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(n=>setTimeout(n,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let n=0;n<t.length;n+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(n,n+this.collection.embed_model.batch_size);await Promise.all(i.map(r=>r.get_embed_input()));try{let r=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-r}catch(r){r&&r.message&&r.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(r),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(r||{},null,2))}i.forEach(r=>{r.embed_hash=r.read_hash,r._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((r,a)=>r+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},K_=class extends G_{static{o(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var t3="---frontmatter---",wS=o(s=>Array.isArray(s)?s.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof s=="string"?(s.includes(",")?s.split(","):[s]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),s3=o((s,e={})=>({...s.env.settings.smart_view_filter||{},...e,entity:s}),"merge_settings_with_params"),n3=o(s=>{let e={...s};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),i3=o(s=>{if(!s.exclude_frontmatter_blocks)return s;let e={...s},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(t3),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),o3=o((s,e)=>{if(!e)return s;let t={...s},n=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(n.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&n.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(n=[...n,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(n=[...n,...e.outlinks.map(r=>r.key)]),n.length&&(t.exclude_key_starts_with_any=n),t.exclude_filter){let r=wS(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...r]}if(t.include_filter){let r=wS(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...r]}return t},"append_entity_filters"),sg=o((s,e={})=>{let t=s3(s,e),n=n3(t),i=i3(n);return o3(i,s)},"create_find_connections_filter_opts");async function Oi(s={}){let e=s.filter?.limit||s.limit||this.env.settings.smart_view_filter?.results_limit||10,t=sg(this,s);s.filter?.limit&&delete s.filter.limit,s.limit&&delete s.limit;let n=this.key+le(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[n]){let i=(await this.nearest(t)).sort(Xe).slice(0,e);this.connections_to_cache(n,i)}return this.connections_from_cache(n)}o(Oi,"find_connections");Oi.action_type="connections";var Zs=class extends de{static{o(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new K_(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Qs=class extends _e{static{o(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new V_(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let n=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let r={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await n.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,r)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(Xe).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return xS}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let n=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(n),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return r3}},xS={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},r3={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function ng(s={}){let e=this.env.settings.smart_view_filter,t=s.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,n=s.filter?.limit||s.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await Oi.call(this,s);let r=sg(this,s);if(s.filter?.limit&&delete s.filter.limit,s.limit&&delete s.limit,!t){let a=this.key+le(JSON.stringify({...r,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,r)).sort(Xe).slice(0,n);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Xe).slice(0,n)}return i}o(ng,"find_connections");ng.action_type="connections";var qi=class extends Zs{static{o(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let n of t)await n(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let r=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)r[d]=""}),e=r.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),n=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(n*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[n,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let r=this.block_collection.get(this.key+n);if(r?.vec)return r}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:n="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let r=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=r.filter(_=>l.includes(_)||c.includes(_));return n==="all"?d.length===r.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(n){console.error(`Error during update for ${this.key}:`,n)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(n){console.error(`Error during merge for ${this.key}:`,n)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;if(typeof t!="string"||t.startsWith("http"))return null;let n=this.fs.get_link_target_path(t,this.file_path);return{...e,key:n,embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=Bf(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=Uf(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},ES={class:qi,actions:{find_connections:ng}};var Yr=class extends Qs{static{o(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,n])=>this.env.events.on(t,n)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let n=this.init_file_path(t)||this.get(t);if(!n){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(n,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let n=this.get(t);if(n||(n=this.init_file_path(t)),!n){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(n,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),n=e.old_path||e.from;if(!t&&!n||(n&&this.items[n]&&(this.items[n]?.delete?.(),delete this.items[n],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:n}]of e){if(await n.import(),this._embed_queue||(this._embed_queue=[]),n.should_embed&&this._embed_queue.push(n),this.block_collection?.settings?.embed_blocks)for(let i of n.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let n=new this.item_type(this.env,{path:e});return this.items[e]=n,n.queue_import(),n.queue_load(),n}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let n;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;n=t.shift()}return n}build_links_map(){let e=Date.now();this.links={};for(let n of Object.values(this.items))for(let i of n.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][n.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let n=await this.create_or_update({path:e});return await n.import(),n}async search(e={}){let{keywords:t,limit:n,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let r=this.filter(i),a=[];for(let c=0;c<r.length;c+=10){let l=r.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let r=await i.lookup(e);return r.error?(console.warn(r.error),[]):r.slice(0,t)}}let n=await super.lookup(e);return n.error?(console.warn(n.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(n=[...n,...await this.block_collection.lookup(e)].sort(Xe)),n.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:n=!1}=e;n&&Object.values(this.items).forEach(r=>r._queue_import=!0);let i=Object.values(this.items).filter(r=>r._queue_import);if(console.log("import_queue "+i.length),i.length){let r=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-r)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((n,[i,r])=>(r.extensions?r.extensions?.forEach(a=>n[a]=r):typeof r.detect_type=="function"&&(n[i]=r),n),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(a3),...Object.entries(this.source_adapters).reduce((t,[n,i])=>{if(t[i])return t;let r=this.items[Object.keys(this.items).find(c=>c.endsWith(n))],a=new i(r||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,n)=>((n._queue_embed||n.should_embed&&n.is_unembedded)&&t.push(n),e&&n.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((n,i)=>(n[i]=this.env.fs.files[i],n),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((n,i)=>(n[i]=this.env.fs.folders[i],n),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(n=>t.endsWith(n))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},a3={};var Y_=class{static{o(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Xr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Xr=class{static{o(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var X_=class extends Y_{static{o(this,"FileCollectionDataAdapter")}ItemDataAdapter=Zr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Zr=class extends Xr{static{o(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var AS={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},cs=class extends X_{static{o(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=Pt;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let n=100;for(let i=0;i<e.length;i+=n){let r=e.slice(i,i+n);await Promise.all(r.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(r=>r._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),n=50;for(let r=0;r<e.length;r+=n){let a=e.slice(r,r+n);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(r=>r.deleted);i.length&&i.forEach(r=>{delete this.collection.items[r.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,n=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${n}`)}: ${i},`}},Pt=class extends Zr{static{o(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:n}=this._parse(e);t&&(n.length?await this.fs.write(this.data_path,n):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let n=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",r=JSON.parse(i),a=Object.entries(r);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete r[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,r[_+":"+u]=d,delete r[l]);let f=this.env[_];if(!f)continue;let y=f.get(u);if(d.key||(d.key=u),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,k=new g(this.env,d);k._queue_load=!1,k.loaded_at=Date.now(),f.set(k)}}return(t||n>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(r).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(n=>!n.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(n=>n.endsWith(",")?n:n+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[n,...i]=e.split(":");return AS[n]&&(n=AS[n],t=!0),{collection_key:n,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let n=this.collection_adapter.collection.data_dir;return await this.fs.exists(n)||await this.fs.mkdir(n),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Qr=class extends cs{static{o(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=ig},ig=class extends Pt{static{o(this,"AjsonMultiFileSourceDataAdapter")}};var Z_=class{static{o(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return le(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return SS(this.constructor.name)}static get adapter_key(){return SS(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function SS(s){return s[0].toLowerCase()+s.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}o(SS,"to_snake");function Q_(s,e={}){let{start_index:t=1,line_keys:n=!1}=e,i=s.split(`
`),r=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},y=null,g=null,k=!1,v=!1,b="#",A=!1,S=[],$=null;_[b]=0;for(let C=0;C<i.length;C++){let x=C+t,m=i[C],h=m.trim();if(h==="---"){if(!v&&x===1){v=!0,k=!0,l["#---frontmatter---"]=[x,null];continue}else if(k){k=!1,l["#---frontmatter---"][1]=x;continue}}if(k)continue;if(!A&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(x)),h.startsWith("```")){if(A=!A,A&&!$?$=x:!A&&$&&(S.push([$,x]),$=null),!g){let E=c.length>0?c[c.length-1].key:b;if(E===b&&!l[b]&&(l[b]=[x,null]),E===b)g={key:b,start_line:x},(l[b][1]===null||l[b][1]<x)&&(l[b][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],N=`${E}#{${q}}`;l[N]=[x,null],g={key:N,start_line:x}}}continue}let w=h.match(/^(#{1,6})\s*(.+)$/);if(w&&!A){let E=w[1].length,q=w[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=x-1)}c.length===0&&l[b]&&l[b][1]===null&&(l[b][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let N="",L=0;if(c.length>0?(N=c[c.length-1].key,L=c[c.length-1].level):(N="",L=0),c.length===0)d[q]=(d[q]||0)+1,d[q]>1&&(q+=`[${d[q]}]`);else{u[N]||(u[N]={}),u[N][q]=(u[N][q]||0)+1;let X=u[N][q];X>1&&(q+=`#{${X}}`)}let me=E-L,ge="#".repeat(me),ye=N+ge+q;l[ye]=[x,null],_[ye]=0,c.push({level:E,title:q,key:ye});continue}let O=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(O&&!A){if(O[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null),g&&g.key!==b&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let q=c.length>0?c[c.length-1].key:b;q===b&&!l[b]&&(l[b]=[x,null]),_[q]===void 0&&(_[q]=0),_[q]+=1;let N=_[q],L;if(n){let me=O[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=c3(me,r);L=`${q}#${ge}`}else L=`${q}#{${N}}`;l[L]=[x,null],y={key:L,start_line:x};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let E=c.length>0?c[c.length-1].key:b;if(E===b)l[b]||(l[b]=[x,null]),(l[b][1]===null||l[b][1]<x)&&(l[b][1]=null),g={key:b,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],N=`${E}#{${q}}`;l[N]=[x,null],g={key:N,start_line:x}}}}let j=i.length;for(;c.length>0;){let C=c.pop();l[C.key][1]===null&&(l[C.key][1]=j+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=j+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=j+t-1),g=null),l[b]&&l[b][1]===null&&(l[b][1]=j+t-1);for(let C in l)a[C]=l[C];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:S}}o(Q_,"parse_markdown_blocks");function c3(s,e=3){return s.split(/\s+/).sort((n,i)=>i.length-n.length).slice(0,e).sort((n,i)=>s.indexOf(n)-s.indexOf(i)).join(" ")}o(c3,"get_longest_words_in_order");var gt=class extends Z_{static{o(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let n=e.init_file_path(t.path);n&&(n.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),n=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,n=!0)}else n=!0;return n?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:n="append_blocks"}=t,{blocks:i,task_lines:r}=Q_(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);n==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let n=[],i=[],r=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){n.push({key:u,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let k=this.item.block_collection.get(u);if(await this.create_hash(p)!==k.last_read?.hash){r.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:n,new_with_parent_blocks:i,changed_blocks:r,same_blocks:a}}async append(e){let n=[await this.read(),"",e].join(`
`).trim();await this.update(n)}get size(){return this.item.file?.stat?.size||0}};function ls(s){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,n=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=o(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),r=o(c=>c<=0?!1:s[c-1]==="!","is_embedded"),a;for(;(a=t.exec(s))!==null;){let c=a[1],l=i(a[2]),d=s.slice(0,a.index).split(`
`).length,_=r(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=n.exec(s))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=s.slice(0,a.index).split(`
`).length,u=r(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}o(ls,"get_markdown_links");function eu({source:s,links:e=[],cache:t}={}){if(!s||!Array.isArray(e)||!e.length)return[];let n=t||s?.env?.bases_caches?.items;if(!n)return[];let i=s?.key||s?.path;return i?e.flatMap(r=>{if(!r?.embedded)return[];if(typeof r.target!="string"||!r.target.includes(".base"))return[];let a=`${i}#${r.target}`,c=n?.[a]?.markdown_table;if(!c)return[];let l=ls(c);return l.length?l.map(d=>({...d,line:r.line,bases_row:d.line-2})):[]}):[]}o(eu,"get_bases_cache_links");function og(s){let e=s.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}o(og,"parse_value");function l3(s){let e=s.split(/\r?\n/),t={},n=0;for(;n<e.length;){let i=e[n];if(n++,!i.trim()||i.trim().startsWith("#"))continue;let r=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!r)continue;let a=r[1].trim(),c=r[2].trim();if(c===">"||c==="|"){let l=[];for(;n<e.length;){let _=e[n];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),n++}let d=l.join(`
`);t[a]=og(d)}else if(c===""){let l=[],d=!1;for(;n<e.length;){let _=e[n];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(og(u)),n++,d=!0}d?t[a]=l:t[a]=""}else t[a]=og(c)}return t}o(l3,"parse_yaml_block");function CS(s){if(!s.startsWith("---"))return{frontmatter:{},body:s};let e=s.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:s};let i=e.slice(1,t).join(`
`),r=l3(i),c=e.slice(t+1).join(`
`);return{frontmatter:r,body:c}}o(CS,"parse_frontmatter");var OS=o((s="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,n;for(;(n=e.exec(s))!==null;)t.add(`#${n[1]}`);return[...t]},"get_markdown_tags");var ea=class extends gt{static{o(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:n}=this.item.file.stat;this.data.last_import={mtime:t,size:n,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let n=await this.get_metadata(e);this.data.metadata=n}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=ls(e),n=eu({source:this.item,links:t});return[...t,...n]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:n}=CS(e),i=new Set,r=t.tags;return typeof r=="string"&&(r=r.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(r)&&r.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),OS(n).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var ds=require("obsidian");function d3(s,e=[]){let t=new Set;return typeof s=="string"&&(s=s.replace(/[\[\]]/g,"").split(",").map(n=>n.trim()).filter(Boolean)),Array.isArray(s)&&s.forEach(n=>t.add(n.startsWith("#")?n:`#${n}`)),e.forEach(({tag:n})=>t.add(n)),[...t]}o(d3,"merge_tags");var en=class extends ea{static{o(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},n=d3(t.frontmatter?.tags,t.tags);return t.frontmatter?(n.length&&(t.frontmatter.tags=n),t.frontmatter):n.length?{tags:n}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let n=this.item.env.main.app;if(!n||!ds.MarkdownRenderer||!ds.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await ds.MarkdownRenderer.render(n,t,i,this.item.path,new ds.Component);let r=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=r!==i.innerHTML,r=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,ds.htmlToMarkdown)(i)}};var tu=class extends gt{static{o(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var su=class extends gt{static{o(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function _3({content:s}={}){if(!s)return null;try{return JSON.parse(s)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}o(_3,"parse_canvas_json");function qS({target:s,title:e}={}){return s?{title:e||s,target:s,line:1}:null}o(qS,"build_link_record");function u3({node:s}={}){if(!s||typeof s!="object")return[];if(s.type==="text"&&typeof s.text=="string")return ls(s.text);if(s.type==="file"&&typeof s.file=="string"){let e=typeof s.subpath=="string"?s.subpath:"",t=`${s.file}${e}`,n=qS({target:t,title:s.file});return n?[n]:[]}if(s.type==="link"&&typeof s.url=="string"){let e=qS({target:s.url,title:s.url});return e?[e]:[]}return[]}o(u3,"get_canvas_node_links");function m3({nodes:s=[]}={}){return Array.isArray(s)?s.reduce((e,t)=>(e.push(...u3({node:t})),e),[]):[]}o(m3,"get_canvas_links_from_nodes");function p3({content:s}={}){let e=_3({content:s});return e?.nodes?m3({nodes:e.nodes}):[]}o(p3,"get_canvas_links");var nu=class extends gt{static{o(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=p3({content:e});let t=this.item.file?.stat,n=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:n,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var iu=class extends en{static{o(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),n="# Text Elements",i="# Drawing",r=t.indexOf(n),a=t.indexOf(i);if(r===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(r+n.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function $S(s,e){let[t,...n]=s.split("#").filter(Boolean),i=B_(t,e);if(e)return[i,...n].join(" > ");let r=n.findLast(a=>a&&a[0]!=="{");return[i,r].join(" > ")}o($S,"get_block_display_name");var $i=class extends Zs{static{o(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:n,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((r,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(r.has_line_start=a),c[1]===t&&(r.has_line_end=a)),r),{has_line_start:null,has_line_end:null});return!(n&&i&&this.collection.get(this.source_key+n)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return $S(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},jS={class:$i,actions:{find_connections:Oi}};var ta=class extends Qs{static{o(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var ou=class extends cs{static{o(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=rg;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),n=Object.entries(e.reduce((i,r)=>{let a=this.get_item_data_path(r.key);return i[a]=i[a]||[],i[a].push(r),i},{}));for(let i=0;i<n.length;i++){let[r,a]=n[i];await this.fs.append(r,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},rg=class extends Pt{static{o(this,"AjsonMultiFileBlockDataAdapter")}};var ru=class{static{o(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return le(e)}};function au(s,e,t){return s.split(`
`).slice(e-1,t).join(`
`)}o(au,"get_line_range");var ji=class extends ru{static{o(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:n,line_end:i}=this.item;if(!n||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let r=t.split(`
`);r.splice(i,0,"",e);let a=r.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let n=await this.item.source.read(),{line_start:i,line_end:r}=this.item;if(!i||!r)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=n.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(r)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:n}=this.item;if(!t||!n)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(n)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let n=e.includes("#"),i=n?e.split("#")[0]:e,r=this.item.env.smart_sources.get(i);if(!r){await this.item.env.smart_sources.create(i,t);return}if(n){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await r.append(t)}else await r.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:n}=this.item;if(!t||!n)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return au(e,t,n)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let n=[],[i,...r]=this.item.key.split("#"),a=i.split("/").pop();if(n.push(a),r.length){let c=r[r.length-1];c.startsWith("{")&&c.endsWith("}")?(r.pop(),n.push(r.pop()),this.item.lines&&n.push(`Lines: ${this.item.lines.join("-")}`)):n.push(r.pop())}return n.filter(Boolean).join(" > ")}};var Ti=class{static{o(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((n,[i,r])=>{let a=(t?t+".":"")+this.process_setting_key(i);return n[a]=r,n},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var sa=class extends Ti{static{o(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var Ni=class{static{o(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,n])=>({value:t,name:n.name||t})).sort((t,n)=>t.name.localeCompare(n.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var tn=class extends Ni{static{o(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var yt=class{static{o(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var Pi=class{static{o(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},Ii=class{static{o(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var Li=class extends Pi{static{o(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let n;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(n=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&n.status===400)throw new Error("Obsidian request failed");return new ag(n)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(n),console.error(i),null}}},ag=class extends Ii{static{o(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var sn=class extends Pi{static{o(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...n}=e,i=await fetch(t,n);return new cg(i)}},cg=class extends Ii{static{o(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var IS=Y(PS(),1);var w3=Object.defineProperty,x3=o((s,e,t)=>e in s?w3(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,"__defNormalProp"),E3=o((s,e,t)=>(x3(s,typeof e!="symbol"?e+"":e,t),t),"__publicField");function A3(s,e){let t=Array.from({length:s.length},(n,i)=>({start:i,end:i+1}));for(;t.length>1;){let n=null;for(let i=0;i<t.length-1;i++){let r=s.slice(t[i].start,t[i+1].end),a=e.get(r.join(","));a!=null&&(n==null||a<n[0])&&(n=[a,i])}if(n!=null){let i=n[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}o(A3,"bytePairMerge");function S3(s,e){return s.length===1?[e.get(s.join(","))]:A3(s,e).map(t=>e.get(s.slice(t.start,t.end).join(","))).filter(t=>t!=null)}o(S3,"bytePairEncode");function C3(s){return s.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}o(C3,"escapeRegex");var dg=class{static{o(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(s,e){this.patStr=s.pat_str;let t=s.bpe_ranks.split(`
`).filter(Boolean).reduce((n,i)=>{let[r,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>n[d]=l+_),n},{});for(let[n,i]of Object.entries(t)){let r=IS.default.toByteArray(n);this.rankMap.set(r.join(","),i),this.textMap.set(i,r)}this.specialTokens={...s.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[i,r])=>(n[r]=this.textEncoder.encode(i),n),{})}encode(s,e=[],t="all"){let n=new RegExp(this.patStr,"ug"),i=dg.specialTokenRegex(Object.keys(this.specialTokens)),r=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=dg.specialTokenRegex([...c]),_=s.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(s),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??s.length;for(let f of s.substring(l,u).matchAll(n)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){r.push(g);continue}r.push(...S3(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];r.push(p),l=d.index+d[0].length}return r}decode(s){let e=[],t=0;for(let r=0;r<s.length;++r){let a=s[r],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let n=new Uint8Array(t),i=0;for(let r of e)n.set(r,i),i+=r.length;return this.textDecoder.decode(n)}},lu=dg;E3(lu,"specialTokenRegex",s=>new RegExp(s.map(e=>C3(e)).join("|"),"g"));async function MS(s,e=s){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await LS(s);return window.localStorage.setItem(e,JSON.stringify(_)),_}let n=await import("node:fs/promises"),i=await import("node:path"),r=await import("node:os"),a=i.join(r.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await n.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await LS(s);return await n.mkdir(a,{recursive:!0}),await n.writeFile(c,JSON.stringify(l),"utf8"),l}o(MS,"fetch_json_cached");async function LS(s){let e=await fetch(s);if(!e.ok)throw new Error(`failed to download ${s} \u2013 ${e.status}`);return await e.json()}o(LS,"do_fetch");function ug(s){if(s===null)return!0;let e=typeof s;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(s)?s.every(ug):e==="object"?Object.values(s).every(ug):!1}o(ug,"is_json_compatible");function du(s,e){let t={};for(let[n,i]of Object.entries(s))e.includes(n)||ug(i)&&(t[n]=i);return t}o(du,"extract_json_details");function na(s){return Object.keys(s).length===0}o(na,"is_empty_object");function O3(s,e){return na(s)?e:na(e)?s:{...s,...e}}o(O3,"merge_details");function _g(s){let e=s.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}o(_g,"get_message_from_object");function ee(s,e=null){if(Array.isArray(s)&&s.length>0)return ee(s[0],e);if(s==null)return{message:"Unknown error",details:null,http_status:e};if(typeof s=="string")return{message:s,details:null,http_status:e};if(s instanceof Error){let t=(s.message||"").trim()||"Unknown error",n=du(s,["message"]);return{message:t,details:na(n)?null:n,http_status:e}}if(typeof s=="object"){let t=s;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let r=i,a=_g(r),c=du(r,["message"]),l=du(t,["message","error"]),d=O3(l,c);return{message:a||_g(t)||"Unknown error",details:na(d)?null:d,http_status:e}}return ee(i)}let n=_g(t);if(n){let i=du(t,["message"]);return{message:n,details:na(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}o(ee,"normalize_error");var q3="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",vt=class extends tn{static{o(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Ze}get res_adapter(){return Qe}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new yt({adapter:sn})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),r=await this.request(i);if(!r)return console.error("No response received for embedding request."),[];if(r.error)return[r];let c=new this.res_adapter(this,r).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let n=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(n);return i.error?{error:ee(i,n.status())}:i}catch(n){return console.warn("Request error:",n),await this.handle_request_err(n,e,t)}}async handle_request_err(e,t,n){if(e.status===429&&n<3){let i=Math.pow(n+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(r=>setTimeout(r,1e3*i)),await this.request(t,n+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?null:c}async load_tiktoken(){let e=await MS(q3,"cl100k_base.json");this.tiktoken=new lu(e)}},Ze=class{static{o(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Qe=class{static{o(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var _u=class extends vt{static{o(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return mg}get res_adapter(){return pg}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},mg=class extends Ze{static{o(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},pg=class extends Qe{static{o(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(n=>({vec:n.embedding,tokens:t}))}};var uu=class extends tn{static{o(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((n,i)=>{let r=`${this.message_prefix}${this.message_id++}`;this.message_queue[r]={resolve:n,reject:i},this._post_message({method:e,params:t,id:r})})}_handle_message_result(e,t,n){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(n?this.message_queue[e].reject(new Error(n)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),n=await this._send_message("embed_batch",{inputs:t});return e.map((i,r)=>(i.vec=n[r].vec,i.tokens=n[r].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var mu=class extends uu{static{o(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(n=>this.iframe.onload=n);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(n=>{let i=o(()=>{this.model.model_loaded?n():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:n,error:i}=e.data;this._handle_message_result(t,n,i)}};var zS=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var DS={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:hg};var hg={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},RS={},fg={};var Mi=class extends mu{static{o(this,"SmartEmbedTransformersIframeAdapter")}static defaults=DS;constructor(e){super(e),this.connector=zS.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...RS}}get_models(){return Promise.resolve(this.models)}get models(){return hg}};var pu=class extends vt{static{o(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return gg}get res_adapter(){return yg}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let n=await t.json(),i=[];for(let a of j3(n.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let r=this.parse_model_data(i);return this.model_data=r,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),r}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,n)=>t.name.localeCompare(n.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,n)=>{let i=n.model_info||{},r=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[n.name]={model_name:n.name,id:n.name,multimodal:!1,max_tokens:r||this.max_tokens,dims:a,description:n.description||`Model: ${n.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},gg=class extends Ze{static{o(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},yg=class extends Qe{static{o(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},$3=o(s=>["embed","embedding","bge"].some(e=>s.name.toLowerCase().includes(e)),"is_embedding_model"),j3=o(s=>{if(!Array.isArray(s))throw new TypeError("models must be an array");return s.filter($3)},"filter_embedding_models");var hu=class extends vt{static{o(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return bg}get res_adapter(){return vg}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let n=e.map(r=>this.estimate_tokens(r.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let r=i[0].error.details?.details?.find(a=>a.retryDelay);if(r.retryDelay){let a=parseInt(r.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((r,a)=>{r.tokens=n[a]}),console.log("Gemini embed_batch response:",i),i}},bg=class extends Ze{static{o(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[n,...i]=t.split(`
`),r=i.join(`
`).trim()||"";return r.length?{model:this.model_id,content:{parts:[{text:r}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:n}:{model:this.model_id,content:{parts:[{text:n}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},vg=class extends Qe{static{o(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,n)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${n}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function T3(s,e="lm_studio"){return s.object!=="list"||!Array.isArray(s.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",s),s.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,n)=>(t[n.id]={id:n.id,model_name:n.id,max_tokens:n.loaded_context_length||512,description:`LM Studio model: ${n.id}`,adapter:e},t),{}))}o(T3,"parse_lm_studio_models");var fu=class extends vt{static{o(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return kg}get res_adapter(){return wg}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let n=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(n);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return T3(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),n=await super.embed_batch(e);return n.forEach((i,r)=>{i.tokens=t[r]}),n}},kg=class extends Ze{static{o(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},wg=class extends Qe{static{o(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var ia=class extends Ti{static{o(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw ee(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var gu=class{static{o(this,"SmartStreamer")}constructor(e,t={}){let{method:n="GET",headers:i={},body:r=null,withCredentials:a=!1}=t;this.url=e,this.method=n,this.headers=i,this.body=r,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(n=>n!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(n=>(n(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let n=JSON.parse(e.currentTarget.response);typeof n=="object"?t.data=n:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let n=t.split(this.chunk_splitting_regex);n.forEach((i,r)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,r===n.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var yu=class extends Ni{static{o(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var zi={},_s={data:null,fetched_at:0},G=class extends yu{static{o(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return H}get res_adapter(){return D}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new yt({adapter:sn})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=_s.data[e]||{},n=o(a=>a.limit?.context||1e4,"get_limit_i"),i=o(a=>a.limit?.output||1e4,"get_limit_o"),r=o(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=n(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=r(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:n(c),max_output_tokens:i(c),multimodal:r(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(n){console.error("Failed to fetch model data:",{error:n,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let n=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(n);if(!i)return null;let r=new this.res_adapter(this,await i.json());try{return r.to_openai()}catch(a){let c=ee(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((r,a)=>{try{this.active_stream=new gu(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),r(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=ee({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=ee(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=ee(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(_s?.data&&t-_s?.fetched_at<e)return _s.data;try{let n={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},r=await(await this.http_adapter.request(n)).json();return _s.data=r,_s.fetched_at=t,console.log({MODELS_DEV_CACHE:_s}),r}catch(n){return console.warn("models.dev fetch failed; continuing without enrichment",n),_s.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return zi[this.constructor.key]||(zi[this.constructor.key]={}),zi[this.constructor.key]}set model_data(e){zi[this.constructor.key]||(zi[this.constructor.key]={}),zi[this.constructor.key]=e}},H=class{static{o(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(n=>n.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},D=class{static{o(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,n=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=n}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let n=e.choices[0].delta.content;t=n,this._res.choices[0].message.content+=n}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var oa=class extends G{static{o(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return ra}res_adapter=aa;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},ra=class extends H{static{o(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(n=>n.text).join(`
`):t.content;else if(t.role==="tool"){let n={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(n)}else{let n={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(n.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(n)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},aa=class extends D{static{o(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let n=e.delta?.text;t=n,this._res.content[0].text+=n}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var N3=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],on=class extends G{static{o(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=xg;parse_model_data(e){return e.data.filter(t=>!N3.some(n=>t.id.startsWith(n))&&!t.id.includes("-instruct")).reduce((t,n)=>{let i={model_name:n.id,id:n.id,multimodal:!0,max_input_tokens:P3(n.id)};return t[n.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function P3(s){return s.startsWith("gpt-4.1")?1e6:s.startsWith("o")?2e5:s.startsWith("gpt-5")?4e5:s.startsWith("gpt-4o")||s.startsWith("gpt-4.5")||s.startsWith("gpt-4-turbo")?128e3:s.startsWith("gpt-4")?8192:s.startsWith("gpt-3")?16385:8e3}o(P3,"get_max_input_tokens");var xg=class extends D{static{o(this,"SmartChatModelOpenaiResponseAdapter")}};var ca=class extends on{static{o(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:n}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${n}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,raw:n,description:`Model: ${n.model}, Status: ${n.status}`,max_input_tokens:4e3};return t}};var Di=class extends G{static{o(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=la;res_adapter=da;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,n)=>{let i={model_name:n.name.split("/").pop(),id:n.name.split("/").pop(),max_input_tokens:n.inputTokenLimit,max_output_tokens:n.maxOutputTokens,description:n.description,multimodal:n.name.includes("vision")||n.description.includes("multimodal"),raw:n};return t[n.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},la=class extends H{static{o(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let n of this.messages)n.role==="system"?t+=n.content+`
`:e.push({role:this._get_gemini_role(n.role),parts:this._transform_content_to_gemini(n.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let n=t.image_url.url.split(";")[0].split(":")[1];return n==="image/jpg"&&(n="image/jpeg"),{inline_data:{mime_type:n,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},da=class extends D{static{o(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:ee(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},n=e.parts.find(i=>i.functionCall);return n&&(t.tool_calls=[{type:"function",function:{name:n.functionCall.name,arguments:JSON.stringify(n.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let n=JSON.parse(t),i;if(n.candidates?.[0]?.content?.parts?.[0]?.text?.length){let r=n.candidates[0].content.parts[0].text;i=r,this._res.candidates[0].content.parts[0].text+=r}return n.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=n.candidates[0].content.role),n.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=n.candidates[0].finishReason),n.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...n.promptFeedback}),n.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...n.usageMetadata}),n.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=n.candidates[0].content.parts[0].functionCall.name,n.candidates[0].content.parts[0].functionCall.args&&Object.entries(n.candidates[0].content.parts[0].functionCall.args).forEach(([r,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[r]||(this._res.candidates[0].content.parts[0].functionCall.args[r]=""),this._res.candidates[0].content.parts[0].functionCall.args[r]+=a})),i}},_a=class extends Di{static{o(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var ua=class extends G{static{o(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Eg}get res_adapter(){return Ag}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,n)=>(t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_length,name:n.name,description:n.name,long_desc:n.description,multimodal:n.architecture.modality==="multimodal",raw:n},t),{})}},Eg=class extends H{static{o(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Ag=class extends D{static{o(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var ma=class extends G{static{o(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return pa}get res_adapter(){return ha}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={id:n.id,model_name:n.id,description:`LM Studio model: ${n.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},pa=class extends H{static{o(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),n=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=n.messages[n.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),n.tool_choice="required"}else n.tool_choice&&typeof n.tool_choice=="object"&&(n.tool_choice="auto");return t.body=JSON.stringify(n),t}},ha=class extends D{static{o(this,"SmartChatModelLmStudioResponseAdapter")}};var fa=class extends G{static{o(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=ga;res_adapter=ya;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let n=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let r of n.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:r.name})})).json();i.push({...c,name:r.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,n)=>{if(n.name.includes("embed"))return t;let i={model_name:n.name,id:n.name,multimodal:!1,max_input_tokens:Object.entries(n.model_info).find(r=>r[0].includes(".context_length"))[1]};return t[n.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},ga=class extends H{static{o(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},n=this._extract_images_from_content(e.content);return n.length>0&&(t.images=n.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},ya=class extends D{static{o(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let n=e.message.content;t=n,this._res.message.content+=n}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Sg={openai:{req:H,res:D},anthropic:{req:ra,res:aa},gemini:{req:la,res:da},lm_studio:{req:pa,res:ha},ollama:{req:ga,res:ya}},ba=class extends G{static{o(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Sg[e];return t&&t.req?t.req:H}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Sg[e];return t&&t.res?t.res:D}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",n=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${n}${i}`}get_adapters_as_options(){return Object.keys(Sg).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:o(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var va=class extends G{static{o(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Cg}get res_adapter(){return Og}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_window||8192,description:`Owned by: ${n.owned_by}, context: ${n.context_window}`,multimodal:n.id.includes("vision")};return t}},Cg=class extends H{static{o(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Og=class extends D{static{o(this,"SmartChatModelGroqResponseAdapter")}};var ka=class extends G{static{o(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return H}get res_adapter(){return D}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((n,i)=>{let r=i.id||i.name;return n[r]={id:r,model_name:r,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},n},{})}};var wa=class extends G{static{o(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return qg}get res_adapter(){return $g}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_size||8192,description:n.description||n.name||n.id,raw:n};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},qg=class extends H{static{o(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},$g=class extends D{static{o(this,"SmartChatModelDeepseekResponseAdapter")}};var Xg=require("obsidian");function FS(s,e){let{blocks:t,task_lines:n,tasks:i,codeblock_ranges:r}=Q_(e),a=s.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=s.key+c,_=s.block_collection.get(d),u=au(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=ls(u),f=eu({source:s,links:p}),y={key:d,lines:l,size:u.length,outlinks:[...p,...f],last_read:{at:a,hash:le(u)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new s.block_collection.item_type(s.env,y);s.block_collection.set(g)}else _.data={..._.data,...y}}I3(s,t,n,i,r);for(let c of s.blocks)c.vec||c.queue_embed()}o(FS,"parse_blocks");function I3(s,e,t=[],n={},i={}){let r=new Set(Object.keys(e).map(c=>s.key+c)),a=s.blocks;for(let c=0;c<a.length;c++)r.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());s.data.blocks=e,s.data.task_lines=t,s.data.tasks=n,s.data.codeblock_ranges=i,s.queue_save()}o(I3,"clean_and_update_source_blocks");function jg(s,e){if(e===null)return null;if(e===void 0)return s;if(typeof e!="object")return e;(typeof s!="object"||s===null)&&(s={});let t=Object.keys(e),n=t.length;for(let i=0;i<n;i++){let r=t[i],a=e[r],c=s[r];Array.isArray(a)?s[r]=a.slice():BS(a)?s[r]=jg(BS(c)?c:{},a):a!==void 0&&(s[r]=a)}return s}o(jg,"ajson_merge");function BS(s){return s!==null&&typeof s=="object"&&!Array.isArray(s)}o(BS,"is_object");var US={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function L3(s){let e=!1,[t,...n]=s.split(":");return US[t]&&(t=US[t],e=!0),{collection_key:t,item_key:n.join(":"),changed:e}}o(L3,"_parse_ajson_key");var us=class extends cs{static{o(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",n=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(n)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let r of Object.values(this.collection.items))r._queue_load&&r.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let r of Object.values(this.collection.items))r._queue_load&&r.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:n,file_data:i}=this.parse_single_file_ajson(t);n&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let r of Object.values(this.collection.items))r._queue_load=!1,r.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,n=e.trim().split(`
`).filter(Boolean),i={},r=0;for(let c=0;c<n.length;c++){let l=n[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:y,item_key:g,changed:k}=L3(p),v=`${y}:${g}`;f?(i[v]=f,(k||v!==p)&&(delete i[p],t=!0)):(delete i[v],(k||v!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}r++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=jg(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}r>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(r=>r._queue_save),t=Date.now(),n=50;for(let r=0;r<e.length;r+=n){let a=e.slice(r,r+n);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(r=>r.deleted);i.length&&i.forEach(r=>{delete this.collection.items[r.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Tg=class extends Pt{static{o(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:n}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},xa={collection:us,item:Tg};var Ea=class extends de{static{o(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,n=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",r=[];return!t.includes(e)&&e!=="global"&&r.push(e),r.push(t),`${r.join("_").replace(/\./g,"_")}#${[n,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function M3(s=[]){let e=s.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}o(M3,"parse_component_properties");async function z3(s,e){let{scope_key:t,component_key:n}=M3(s);if(!n)return null;let i=typeof e=="function"?e:e?.render,r=typeof i?.version=="number"?i.version:0,a=await le(i.toString());return{scope_key:t,component_key:n,version:r,hash:a}}o(z3,"build_component_data");var bu=class{static{o(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,n){if(!this.should_use_adapter(n))return null;let i=await z3(t,n);if(!i)return null;let r=await e.create_or_update({...i});return r?(r._component_module=n,r._component_adapter=new this(r,n),r):null}async render(e,t){throw new Error("render() not implemented")}};var vu=class extends bu{static{o(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let n=typeof this.module=="function"?this.module:this.module?.render;if(typeof n!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await n.call(this.smart_view,e,t)}};function WS(s,e=[],t=[]){return!s||typeof s!="object"||Object.entries(s).forEach(([n,i])=>{let r=[...e,n];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:r,module:i});return}typeof i=="object"&&WS(i,r,t)}}),t}o(WS,"flatten_components_config");var ku=class extends _e{static{o(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=WS(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let n of this.component_adapters){let i=await n.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,n={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,n)}},GS={class:ku,item_type:Ea,data_adapter:xa,component_adapters:{SmartViewComponentAdapter:vu}};var HS=GS;function JS(s=[]){let e=new Set;for(let{key:t}of s)t.includes("#")||e.add(t);return s.filter(({key:t})=>{if(!t.includes("#"))return!0;let n=t.split("#")[0];return!e.has(n)})}o(JS,"filter_redundant_context_items");var VS=o((s,e)=>!e||!s?.[e]?!1:s[e].folder||s[e].from_named_context?s[e].exclude?!1:(s[e].exclude=!0,!0):(delete s[e],!0),"remove_context_item_data"),Aa=class extends de{static{o(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:n=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let r=this.data.context_items[i],a={d:0,at:Date.now(),...r||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),n&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:n=!0}=t;VS(this.data.context_items,e)&&(this.queue_save(),n&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:n=!0}=t,i=Array.isArray(e)?e:[e],r=[];return i.forEach(a=>{VS(this.data.context_items,a)&&r.push(a)}),r.length?(this.queue_save(),n&&this.emit_event("context:updated",{removed_keys:r}),r):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(n=>{n.size&&(e+=n.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],n=this.context_items.filter(e.filter).sort((r,a)=>r.data.d-a.data.d);console.log("get_text context_items",n);for(let r of n){if(r.is_media)continue;let a=await r.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(r,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:n}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),n=[];for(let i of t){if(!i.is_media)continue;let r=await i.get_base64();r.error?this.emit_get_media_error(i,r):n.push(r)}return n}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return JS(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let n=this.data.context_items[t].d;return n===e||typeof n>"u"&&e===0})}};var wu=class extends _e{static{o(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let n=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&n.add_items(t.add_items),this.set(n),n.queue_save(),n.emit_event("context:created"),n}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var D3={class:wu,data_adapter:us,item_type:Aa};var KS=D3;var xu=class extends de{static{o(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var kt=class{static{o(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var Eu=class extends kt{static{o(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var Au=class extends kt{static{o(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var YS=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var Su=class extends kt{static{o(this,"ImageContextItemAdapter")}static detect(e){return YS.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),n=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:n}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var Cu=class extends kt{static{o(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var Ng=class extends _e{static{o(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let n=e.order||0,i=t.order||0;return n-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(n=>n.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let n=0;n<t.length;n++){let[i,r]=t[n];r.exclude||this.new_item({key:i,...r})}}},XS={version:1,class:Ng,collection_key:"context_items",item_type:xu,context_item_adapters:{BlockContextItemAdapter:Eu,SourceContextItemAdapter:Au,ImageContextItemAdapter:Su,PdfContextItemAdapter:Cu}};function ZS(s={},e){let t=(s.ct||0)+1,n=s.first_at??e;return{ct:t,first_at:n,last_at:e}}o(ZS,"next_log_stats");var Ri=class extends de{static{o(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var R3={"collection:save_started":!0,"collection:save_completed":!0},Pg=class extends _e{static{o(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let n=new this(e,t);return n.init(),n}get item_type(){return Ri}init(){this.env?.events||Xs.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!R3[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let n=Date.now(),i=this.get(e);i||(i=new Ri(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let r=ZS({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},n);i.data={...i.data,...r},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(n){console.error("[EventLogs] record failure",e,n)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},QS={class:Pg,collection_key:"event_logs",data_adapter:us,item_type:Ri};var Fi=require("obsidian");function eC(s,e={}){if(!s)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],n=s?.env?.config?.actions||{},i=s?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(n[c]||{}).display_name||c;return a.push({select_action:o(()=>{s.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}o(eC,"build_suggest_scope_items");var tC=o((s,e={})=>{let t=s?.inputEl,n=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(n===t&&i)},"should_handle_arrow_left");var Ou=class extends Fi.FuzzySuggestModal{static{o(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,n=t.plugin,i=n.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=n,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let n=this,i=new n(e,t);return i.open(t),i}static register_modal(e){let t=this,n=e?.env,i={...n.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let r=o((l={})=>{let d=t.resolve_item_from_payload(n,l);return t.open(d,{...i,...l})},"open_handler"),a=[n?.events?.on?.(`${t.event_domain}:open`,r)],c=o(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,r=tC(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&r){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return eC(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){super.renderSuggestion(e,t);let n=e?.icon||e?.item?.icon;if(n){t.addClass("sc-modal-suggestion-has-icon");let a=t.createEl("span");(0,Fi.setIcon)(a,n)}let i=e&&Object.prototype.hasOwnProperty.call(e,"display_right")?e.display_right:e?.item?.display_right,r=i==null?"":String(i).trim();return r&&this.env.smart_components.render_component("suggest_display_right",r).then(a=>{t.appendChild(a)}),t}onChooseSuggestion(e,t,...n){this.prevent_close=!0;let i=e.item,r=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=Fi.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,r)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let n=e[t],i=await n({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let r=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),r!==-1&&this.chooser.setSelectedItem(r)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var iMe=require("obsidian");var qu=class extends Ou{static{o(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var sC=require("obsidian");var $u=class extends sC.Modal{static{o(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var Tu=require("obsidian");var F3="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",ju=class extends Tu.Modal{static{o(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){B3(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function B3(s,e){if(!s)return;s.empty(),s.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let n=document.createElement("div");n.className="sc-milestones-modal__title-text",n.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),U3(i),i.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(F3,"_external")}),t.appendChild(n),t.appendChild(i),s.appendChild(t)}o(B3,"render_milestones_modal_title");function U3(s){W3(s,["circle-help","help-circle","help","info"])||(s.textContent="?")}o(U3,"render_help_icon");function W3(s,e){if(!s)return!1;let t=Array.isArray(e)?e:[];for(let n of t)if(!(typeof n!="string"||n.length===0)){s.textContent="";try{(0,Tu.setIcon)(s,n)}catch{continue}if(s.querySelector("svg"))return!0}return!1}o(W3,"set_icon_with_fallback");var nC={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var Sa=class extends de{static{o(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let n=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?n.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&n.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&n.debounce_save(),d}},r=new Proxy(e,i);return this._settings_proxy_map.set(e,r),r}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,n])=>({label:n.name||t,value:n.key||t})).sort((t,n)=>t.label.toLowerCase().includes("free")&&!n.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&n.label.toLowerCase().includes("free")?1:t.label.localeCompare(n.label))}model_changed(e,t,n){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},r=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...r,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var Nu=class extends _e{static{o(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,r)=>r.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let n=new this.item_type(this.env,{...e});return this.set(n),this.settings.default_model_key=n.key,this.emit_event("model:changed"),n.queue_save(),n}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(n=>!n.deleted).sort((n,i)=>i.data.created_at-n.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let n=this.new_model({provider_key:this.default_provider_key});n.queue_save(),this.process_save_queue(),this.settings.default_model_key=n.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function iC(s){return{default_model_key:{type:"dropdown",name:`Default ${s.model_type.toLowerCase()} model`,description:`Used as the default ${s.model_type.toLowerCase()} model when no other is specified.`,options_callback:o(()=>s.get_model_key_options(),"options_callback"),callback:o(async(e,t)=>{s.emit_event("model:changed")},"callback")}}}o(iC,"settings_config");var rn=class extends Sa{static{o(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Ig=class extends Nu{static{o(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var G3={class:Ig,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:xa,item_type:rn,providers:{},settings_config:iC},Lg=G3;var Mg=class extends Mi{static{o(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},oC={class:Mg,settings_config:fg};Lg.providers={transformers:oC};var rC=Lg;var ms=class extends de{static{o(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],n=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(H_(a,l,e.limit||20),a):(l?.error&&n.push(l.error),a)},{min:0,results:new Set}),r=Array.from(i).sort(J_);if(!r.length)return r;for(;!r.some(a=>a.score>.5);)r.forEach(a=>a.score*=2);return r}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var aC={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:o(s=>{let e=[{value:"smart_sources",name:"Sources"}];return s.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},zg=class extends _e{static{o(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let n=H3(new Date),i=le(e),r=`${n}+${i}`;if(this.items[r])return this.items[r];let a=new ms(this.env,{key:r,query:e,filter:t});return this.set(a),a}get settings_config(){return{...aC}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function H3(s){let e=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),n=String(s.getDate()).padStart(2,"0");return`${e}-${t}-${n}`}o(H3,"format_ymd");var cC={class:zg,collection_key:"lookup_lists",item_type:ms,settings_config:aC};function Ca(s){return s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}o(Ca,"format_collection_name");async function J3(s,e={}){let t=Object.entries(s.settings_config).map(([i,r])=>(r.setting||(r.setting=i),this.render_setting_html(r))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${Ca(s.collection_key)}</h2>
${t}
</div></div></div>`}o(J3,"build_html");async function lC(s,e={}){let t=await J3.call(this,s,e),n=this.create_doc_fragment(t);return await this.render_setting_components(n,{scope:s}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(n.querySelector(".collection-settings"))):s.settings_container=n.querySelector(".collection-settings-container"),s.settings_container}o(lC,"render");var Bi=require("obsidian");function dC(s,e,t,n,i={}){let r=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(Bi.Keymap.isModEvent(a)){let c=t.smart_blocks.get(n),l=await c?.read();if(l){let d=new Bi.HoverPopover(s,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");Bi.MarkdownRenderer.render(r,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}o(dC,"register_block_hover_popover");var _C=require("obsidian");function uC(s,e,t={}){let n=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?s.addEventListener("mouseover",i=>{let r=e.key.replace(/#$/,"");if(n.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:s.parentElement,targetEl:s,linktext:r}),_C.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):dC(s.parentElement,s,e.env,e.key)}o(uC,"register_item_hover_popover");var pC=require("obsidian");function V3(s){let e=typeof s=="number"?s:Number.parseFloat(s);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}o(V3,"format_score");function K3(s){let e=typeof s=="number"?s:Number.parseFloat(s);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],n=e,i=0;for(;n>=1024&&i<t.length-1;)n/=1024,i+=1;let r=n>=10||Number.isInteger(n)?0:1;return`${Number.parseFloat(n.toFixed(r)).toString()} ${t[i]}`}o(K3,"format_size");function mC(s,e){return s?`<span class="${e}">${s}</span>`:""}o(mC,"build_badge_html");function Y3(s,e={}){let t;if(s.item_ref)if(s.item_ref.key.includes("#")){let c=s.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(s.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=s.item_ref.key.split("/").pop();else t=s.key.split("/").pop();let n=V3(s?.data?.score),i=K3(s?.size||s?.data?.size),r=mC(n,"sc-context-item-score"),a=mC(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${s.key}">\xD7</span>
${r}
<span class="sc-context-item-name">${t||s.key}</span>
${a}
</span>`}o(Y3,"build_html");async function hC(s,e={}){let t=Y3(s,e),i=this.create_doc_fragment(t).firstElementChild;return X3.call(this,s,i,e),i}o(hC,"render");async function X3(s,e,t={}){let n=s.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");n.smart_contexts.get(d).remove_item(s.key)}),s.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${pC.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),uC(a,s.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{s.open(a)}),e}o(X3,"post_process");async function Z3(s,e={}){let t=[];t.push("<h2>Collections</h2>");let n=Object.keys(s.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,r)=>i==="smart_sources"||i==="smart_blocks"?-1:r==="smart_sources"||r==="smart_blocks"?1:i.localeCompare(r));for(let i of n){let r=s[i];if(!r||!r.items){t.push(`
<div class="sc-collection-stats">
<h3>${Ca(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=eD(r,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}o(Z3,"build_html");async function fC(s,e={}){let t=await Z3.call(this,s,e),n=this.create_doc_fragment(t);return await Q3.call(this,s,n,e)}o(fC,"render");async function Q3(s,e,t={}){return e}o(Q3,"post_process");function eD(s,e){let t=Object.values(s.items).length,n=Ca(e),i=s.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${n}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let r=s.load_time_ms?`<p>Load time: ${s.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=tD(s,n,t),l="";return typeof s.process_embed_queue=="function"&&(l=sD(s,t)),`
<div class="sc-collection-stats">
<h3>${n}</h3>
${l}
${c}
${r}
${a}
</div>
`}o(eD,"generate_collection_stats");function tD(s,e,t,n){return`
<p><strong>Total:</strong> ${t}</p>
`}o(tD,"get_generic_collection_stats");function sD(s,e){if(!Object.values(s.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let n=Object.values(s.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=n.embedded/n.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${n.embedded} / ${n.should_embed})</p>`+(n.missing_embed?`<p><strong>Missing embeddings:</strong> ${n.missing_embed}</p>`:"")+(n.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${n.extraneous_embed}</p>`:"")+(n.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${n.should_not_embed}</p>`:"")}o(sD,"calculate_embed_coverage");var gC=require("obsidian");function nD(s,e={}){return'<div class="smart-form-dropdown-component"></div>'}o(nD,"build_html");async function Dg(s,e={}){let t=nD.call(this,s,e),n=this.create_doc_fragment(t);return await iD.call(this,s,n,e)}o(Dg,"render");async function iD(s,e,t={}){if(!s)return e.textContent="Error: scope is required for dropdown component.",e;let n=s.settings;if(!n||typeof n!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let r=t.options;if(!Array.isArray(r)||r.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new gC.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Pe(n,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:s,options:r}),l=_.selectEl,t.required&&l.setAttribute("required","true"),r.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),r.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=o(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:s,setting_key:i,select_el:l,container:e}):Ie(s.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}o(iD,"post_process");Dg.version=.2;var yC=require("obsidian");function oD(s,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}o(oD,"build_html");function bC(s,e={}){let t=oD.call(this,s,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),r=i.querySelector(".callout-icon"),a=(0,yC.getIcon)("smart-chat");return a&&(this.empty(r),r.appendChild(a)),rD.call(this,s,i,e),i}o(bC,"render");function rD(s,e){}o(rD,"post_process");var vC=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var AC=require("obsidian");var kC=require("obsidian");var cD={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},Ui={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},lD=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function Rg(s){let e=Object.entries(s||{}).reduce((r,[a,c])=>{let l=c?.group||"Other";return r[l]||(r[l]=[]),r[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),r},{}),t=Object.keys(e),n=lD.reduce((r,a,c)=>(r[a]=c,r),{});return t.sort((r,a)=>{let c=Object.prototype.hasOwnProperty.call(n,r),l=Object.prototype.hasOwnProperty.call(n,a);return c&&l?n[r]-n[a]:c?-1:l?1:r.localeCompare(a)}).map(r=>{let a=(e[r]||[]).slice();return{group:r,items:a}})}o(Rg,"derive_events_checklist_groups");function Oa(s,e){let t=dD(s,e);return!!(t===!0||s?.event_logs?.items?.[e])}o(Oa,"check_if_event_emitted");function dD(s,e){let t=cD[e];if(!t)return null;let n=s?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let r of i){let a=n[r];if(a&&!(t.require_pro_name&&!_D(a)))return!0}return!1}o(dD,"resolve_plugin_install_event");function _D(s){let e=s?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}o(_D,"is_pro_manifest");function wC(s){s.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in Ui){let n=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",r=document.createElement("p");r.textContent=i,n.appendChild(r);let a=document.createElement("p");a.textContent=`\u2705 ${Ui[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",n.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{s.open_milestones_modal()}),n.appendChild(c),new kC.Notice(n,7e3)}})}o(wC,"register_first_of_event_notifications");function uD(s,e={}){let t=Rg(Ui),n=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(Oa(s,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),r=i>0?Math.round(n/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(Oa(s,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=Oa(s,u.event_key)===!0;return pD(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Ye(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Ye(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${r.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${n.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${n.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Ye(`${r.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}o(uD,"build_html");async function SC(s,e={}){this.apply_style_sheet(vC);let t=uD.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return mD.call(this,s,i,e),i}o(SC,"render");async function mD(s,e,t={}){return hD(e),fD(e),e}o(mD,"post_process");function pD(s,e){let t=e.checked===!0,n=t?"true":"false",i=typeof s.link=="string"?s.link:"",r=t?"Completed":"Incomplete",a=`Open docs: ${s.milestone||s.event_key||"milestone"} (${r})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Ye(s.event_key)}"
data-link="${Ye(i)}"
data-checked="${n}"
tabindex="0"
role="button"
aria-label="${Ye(a)}"
>
<div class="sc-events-checklist__label${s.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Ye(s.milestone)}</span>
</div>
</li>
`}o(pD,"build_item_html");function hD(s){s&&s.getAttribute("data-links-enabled")!=="true"&&(s.setAttribute("data-links-enabled","true"),s.addEventListener("click",e=>{let t=EC(s,e);if(!t)return;let n=window.getSelection();n&&n.toString().length>0||xC(t)}),s.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let n=EC(s,e);n&&(e.preventDefault(),xC(n))}))}o(hD,"attach_item_link_listeners");function xC(s){let e=bD(s);typeof e=="string"&&e.length>0&&window.open(e,"_external")}o(xC,"open_item_link");function fD(s){if(!s)return;Array.from(s.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let n=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&gD(i,n)})}o(fD,"render_item_state_icons");function gD(s,e){yD(s,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}o(gD,"set_item_icon");function yD(s,e){if(!s)return;let t=Array.isArray(e)?e:[];for(let n of t)if(!(typeof n!="string"||n.length===0)){s.textContent="";try{(0,AC.setIcon)(s,n)}catch{continue}if(s.querySelector("svg"))return}}o(yD,"set_icon_with_fallback");function EC(s,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let n=t.closest(".sc-events-checklist__item");return!n||!s.contains(n)?null:n}o(EC,"get_item_el_from_event");function bD(s){let e=s.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=s.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let n=Ui[t];return!n||typeof n.link!="string"?"":n.link}o(bD,"get_item_link");function vD(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}o(vD,"build_html");var Fg=100,Bg=100;function kD(s,e={}){let{limit:t=Fg}=e;return s.slice(-t).reverse()}o(kD,"get_visible_entries");function wD(s,e={}){let{page_size:t=Fg}=e;return Math.min(s,t)}o(wD,"get_visible_count");function xD(s,e={}){let{current_count:t=0,step_size:n=Bg}=e;return Math.min(s,t+n)}o(xD,"get_next_visible_count");function ED(s,e){return s>e}o(ED,"should_show_load_more");async function CC(s,e={}){let t=this.create_doc_fragment(vD()),n=t.firstElementChild;return AD.call(this,s,n,e),t}o(CC,"render");async function AD(s,e,t={}){let n=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),r=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(n);let c=Array.isArray(s.event_logs.session_events)?[...s.event_logs.session_events]:[];if(!c.length){let _=n.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",n.appendChild(_),r&&(r.style.display="none");return}let l=wD(c.length,{page_size:Fg}),d=o(()=>{a.empty(n),kD(c,{limit:l}).forEach(_=>{OD(n,_)}),SD(r,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=n.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),r&&r.addEventListener("click",()=>{l=xD(c.length,{current_count:l,step_size:Bg}),d()})}o(AD,"post_process");function SD(s,e={}){if(!s)return;let{entries_length:t=0,visible_count:n=0}=e,i=ED(t,n);if(s.style.display=i?"inline-block":"none",i){let r=t-n,a=Math.min(Bg,r);s.textContent=`Load ${a} more`}}o(SD,"update_load_more_button");function CD(s){let[e,t]=s.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}o(CD,"get_level");function OD(s,e){let t=s.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=CD(e),s.appendChild(t);let n=s.ownerDocument.createElement("div");n.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();n.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${qD(i)}
`,t.appendChild(n);let r=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(r.trim().length){t.style.cursor="pointer";let a=s.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=r,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else n.textContent+=`
`}o(OD,"append_entry");function qD(s){let e=Date.now(),t=Math.floor((e-s)/1e3);if(t<60)return`${t} seconds ago`;let n=Math.floor(t/60);if(n<60)return`${n} minutes ago`;let i=Math.floor(n/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}o(qD,"to_time_ago");var Me=require("obsidian");var Wi=require("obsidian");function Gi(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}o(Gi,"get_smart_server_url");function $D(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}o($D,"try_get_zlib");function jD(s){let e=$D();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(s),n=e.inflateRawSync(t);return new Uint8Array(n.buffer,n.byteOffset,n.length)}o(jD,"inflate_deflate_data");async function qa(s){let e=new DataView(s),t=0,n=e.byteLength,i=[],r=null;for(;t+4<=n;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let k=new Uint8Array(s.slice(t,t+y)),v=new TextDecoder("utf-8").decode(k);t+=y,t+=g;let b=(l&8)!==0,A=t,S;if(!b)S=A+p;else{let C=A,x=!1;for(;C+4<=n;){let m=e.getUint32(C,!0);if(m===134695760||m===67324752||m===33639248){x=!0;break}C++}S=x?C:n}if(S>n)break;let $=new Uint8Array(s.slice(A,S));if(t=S,b&&t+4<=n)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=n)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let j;if(d===0)j=$;else if(d===8)j=jD($);else continue;if(i.push({fileName:v,data:j}),v.toLowerCase().endsWith("manifest.json")&&!v.includes("/"))try{r=JSON.parse(new TextDecoder("utf-8").decode(j))}catch{}}return{files:i,pluginManifest:r}}o(qa,"parse_zip_into_files");function Pu(s,e="Response"){if(!s||s.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(s).getUint32(0,!0)!==67324752){let n=new TextDecoder().decode(new Uint8Array(s));throw new Error(`${e} did not return a valid ZIP. Text:
${n}`)}return s}o(Pu,"validate_zip_buffer");async function $a(s,e,t){let n=typeof s.writeBinary=="function";await s.exists(e)||await s.mkdir(e);for(let{fileName:i,data:r}of t){let a=e+"/"+i;if(n)await s.writeBinary(a,r);else{let c=btoa(String.fromCharCode(...r));await s.write(a,c)}}}o($a,"write_files_with_adapter");function Iu(s,e){if(!e||e==="unknown")return!1;let t=s.replace(/[^\d.]/g,""),n=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),r=n.split(".").map(Number);for(let a=0;a<Math.max(i.length,r.length);a++){let c=i[a]||0,l=r[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}o(Iu,"is_server_version_newer");async function Lu(s,e){let t=await(0,Wi.requestUrl)({url:`${Gi()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:s})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return Pu(t.arrayBuffer,"Smart Plugins server")}o(Lu,"fetch_plugin_zip");async function OC(s,e=Wi.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${s}`);let t=await e({url:s,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return Pu(t.arrayBuffer,"Download")}o(OC,"fetch_zip_from_url");async function qC(s,e,t=Wi.requestUrl){let n=await t({url:`${Gi()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:s})});if(n.status!==200)throw new Error(`plugin_readme error ${n.status}: ${n.text}`);return n.json.readme}o(qC,"fetch_plugin_readme");async function $C(s,e){await s.plugins.enablePlugin(e),s.plugins.enabledPlugins.add(e),s.plugins.requestSaveConfig(),s.plugins.loadManifests()}o($C,"enable_plugin");function Mu(s){return`${(s?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}o(Mu,"get_oauth_storage_prefix");async function zu(s){let e=await(0,Wi.requestUrl)({url:`${Gi()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}o(zu,"fetch_server_plugin_list");async function jC(s={}){let e=String(s.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,Wi.requestUrl)({url:`${Gi()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}o(jC,"fetch_referral_stats");var TC=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var ND='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',PD='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function ID(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}o(ID,"derive_fallback_plugins");function LD(s,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${ND}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${PD}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}o(LD,"build_html");async function PC(s,e={}){this.apply_style_sheet(TC);let t=LD.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return await MD.call(this,s,i,e),i}o(PC,"render");async function MD(s,e,t={}){let i=(s.plugin||null)?.app||window.app,r=Mu(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=ID(),_=0,u="",p=null,f=o(C=>{if(C){if(typeof this.empty=="function"){this.empty(C);return}C.innerHTML=""}},"empty_container"),y=o(C=>{if(!a||!C)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let m=document.createElement("div");m.classList.add("smart-plugins-login-manual-controls"),p.appendChild(m);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=C,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),m.appendChild(h);let w=document.createElement("button");w.classList.add("mod-cta"),w.textContent="Copy",w.addEventListener("click",async()=>{await NC(C)?new Me.Notice("Copied login link to clipboard."):new Me.Notice("Copy failed. Please select and copy the link manually.")}),m.appendChild(w)},"render_manual_login_link"),g=o(async()=>{let C={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(m=>setTimeout(m,100));for(let m in x){if(!Object.prototype.hasOwnProperty.call(x,m))continue;let{name:h,version:w}=x[m];C[m]={name:h,version:w}}return C},"get_installed_info"),k=o(async()=>{_++,_>=2&&u&&y(u),s&&typeof s.initiate_smart_plugins_oauth=="function"&&(u=zD()),new Me.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),v=o(()=>{if(this.empty(a),p=null,!(localStorage.getItem(r+"token")||"")){new Me.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await k()})});return}let x=new Me.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(m=>{m.setButtonText("Logout"),m.onClick(()=>{localStorage.removeItem(r+"token"),localStorage.removeItem(r+"refresh"),new Me.Notice("Logged out of Smart Plugins"),v(),b(),$()})})},"render_oauth_login_section"),b=o(async(C={})=>{f(c);let x=String(C.token||"").trim();if(!x){new Me.Setting(c).setName("Give $30 off Pro. Get 30 days of Pro").setDesc("Start a free trial to unlock your referral link.").addButton(w=>{w.setButtonText("Start free trial"),w.onClick(()=>{window.open("https://smartconnections.app/pro-plugins/","_external")})});return}let m=Number(C.sub_exp??0)||0;if(!(m&&m<Date.now()))try{let h=await jC({token:x}),w=String(h?.referral_link||"").trim();if(!w)return;let O=new Me.Setting(c).setName("Referral link").setDesc("Give $30 off Pro. Get 30 days of Pro.");O.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let q=await NC(w);new Me.Notice(q?"Referral link copied.":"Copy failed. Please try again.")})}),O.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),A=o(async()=>{if(this.empty(l),!(!l||d.length===0))for(let C of d){let x=await s.smart_components.render_component("pro_plugins_list_item",C,{env:s,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),S=o(()=>{let C=new Me.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");C.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),C.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),C.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{s.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),$=o(async()=>{this.empty(l);let C=localStorage.getItem(r+"token")||"";if(!C){await A(),await b();return}try{let x=await g(),m=await zu(C),{list:h=[],unauthorized:w=[],sub_exp:O}=m;if(typeof O=="number"&&O<Date.now()){S(),await A(),await b();return}if(await b({token:C,sub_exp:O}),!Array.isArray(h)||h.length===0){await A();return}for(let E of h){let q=await s.smart_components.render_component("pro_plugins_list_item",E,{env:s,app:i,token:C,installed_map:x,on_installed:$});l.appendChild(q)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),j=o(async()=>{v(),await $()},"render_smart_plugins");return s.events.on("smart_plugins_oauth_completed",()=>{j()}),await j(),e}o(MD,"post_process");function zD(){console.log("initiate_smart_plugins_oauth");let s=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${Gi()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${s}`;return window.open(t,"_external"),t}o(zD,"initiate_smart_plugins_oauth");var NC=o(async s=>{if(!s)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(s),!0}catch{}try{let e=document.createElement("textarea");e.value=s,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var fe=require("obsidian");var DD="https://smartconnections.app/pro-plugins/";function RD(s,e={}){return'<div class="pro-plugins-list-item"></div>'}o(RD,"build_html");function FD(s){return!s||!s.repo}o(FD,"is_fallback_item");function BD(s,e){let t=s.repo,n=s.version||"unknown",i=s.manifest_id||t.replace("/","_"),r=e?.version||null,a=e?.name||s.name||t,c=`Server version: ${n}`,l="Install",d=!1;return r&&(c+=` | Installed version: ${r}`,Iu(r,n)?l="Update":(l="Installed",d=!0)),s.description&&(c+=`
${s.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:n,local_version:r}}o(BD,"compute_display_state");async function IC(s,e={}){let t=RD(s,e),i=this.create_doc_fragment(t).firstElementChild;return await UD.call(this,s,i,e),i}o(IC,"render");async function UD(s,e,t={}){let{app:n,token:i,installed_map:r={},on_installed:a}=t;if(FD(s)){let u=new fe.Setting(e).setName(s.name||"Pro plugin").setDesc(s.description||"Login to unlock Pro plugins.");if(s.core_id)if(n.plugins.manifests[s.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${s.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(DD,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(s.url,"_external")})}),e}let c=s.manifest_id||s.repo.replace("/","_"),l=r[c]||null,d=BD(s,l),_=new fe.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>GD(s,{app:n,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),s.docs_url?u.onClick(()=>window.open(s.docs_url,"_external")):u.onClick(()=>HD(s,{app:n,token:i,display_name:d.display_name}))}),e}o(UD,"post_process");var WD=o(async(s,e)=>{let t=typeof s.resolve_download_url=="function"?await s.resolve_download_url():s.download_url;if(t)return OC(t);if(!e)throw new Error("Login required to install this plugin.");return Lu(s.repo,e)},"download_plugin_zip"),GD=o(async(s,e={})=>{let{app:t,token:n,on_installed:i}=e;try{new fe.Notice(`Installing "${s.repo}" ...`);let r=await WD(s,n),{files:a,pluginManifest:c}=await qa(r),l=s.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await $a(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||s.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await $C(t,_),new fe.Notice(`${s.repo} installed successfully.`),typeof i=="function"&&await i()}catch(r){console.error("[pro-plugins:list_item] Install error:",r),new fe.Notice(`Install failed: ${r.message}`)}},"install_plugin"),HD=o(async(s,e={})=>{let{app:t,token:n,display_name:i}=e;try{let r=await qC(s.repo,n),a=new fe.Modal(t);a.setTitle(i||s.name||s.repo),await fe.MarkdownRenderer.render(t,r,a.contentEl,"",new fe.Component),a.open()}catch(r){console.error("[pro-plugins:list_item] Failed to load README:",r),new fe.Notice("Failed to load README")}},"show_plugin_readme");var LC=require("obsidian");var an=class extends LC.Modal{static{o(this,"SmartModelModal")}constructor(e,t={}){let n=e.env.plugin.app||window.app;super(n),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,n=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:o(async()=>{this.close()},"on_before_new"),on_after_delete:o(async()=>{this.close()},"on_after_delete")});e.appendChild(n);let i=t.settings_config,r=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(r);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let n=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(n);let i=await t.test_model();n.textContent=JSON.stringify(i,null,2)}};var MC=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var zC=require("obsidian");function VD(s,e){let t=[`Provider: ${s.data.provider_key}`,`Model: ${s.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${s.display_name} <span class="test-result-icon" data-icon="${RC(s)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}o(VD,"build_html");async function DC(s,e){this.apply_style_sheet(MC);let n=this.create_doc_fragment(VD.call(this,s,e)).firstElementChild;return KD.call(this,s,n,e),n}o(DC,"render");async function KD(s,e,t){let n=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),r=e.querySelector(".test-result-icon");return(0,zC.setIcon)(r,RC(s)),n.addEventListener("click",()=>{new an(s).open()}),i.addEventListener("click",()=>{new an(s,{test_on_open:!0}).open()}),e}o(KD,"post_process");function RC(s){switch(s.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}o(RC,"get_test_result_icon_name");var BC=require("obsidian");var FC={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function Du(s,e,t={}){let n=(FC[s.collection_key]||[]).map(i=>({...i,disabled:!s.env_config.providers[i.value]}));if(n.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new BC.Menu;n.forEach(r=>{i.addItem(a=>{a.setTitle(r.label),r.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=s.new_model({provider_key:r.value}),l=o(async()=>{},"on_new_close");new an(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}o(Du,"show_new_model_menu");function YD(s,e){return`<div class="model-settings" data-model-type="${s.collection_key}">
<div class="global-settings"></div>
</div>`}o(YD,"build_html");async function UC(s,e){let n=this.create_doc_fragment(YD.call(this,s,e)).firstElementChild;return XD.call(this,s,n,e),n}o(UC,"render");async function XD(s,e,t){let n=[],i=o(async r=>{this.empty(e);let[a]=Ai(s.env_config.settings_config,s,e,{default_group_name:`${s.model_type} models`,heading_btn:{btn_text:"+ New",callback:o((c,l)=>{Du(s,c)},"callback")}});s.env.smart_components.render_component("settings_env_model",r,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(s.default),n.push(s.on_event("settings:changed",async r=>{let a=`${s.collection_key}.default_model_key`;r.path_string===a&&await i(s.default)})),n.push(s.on_event("model:changed",async()=>{await i(s.default)})),this.attach_disposer(e,n)}o(XD,"post_process");function ZD(s,e){return`<div class="env-model-types">
${[s.embedding_models,s.chat_completion_models,s.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}o(ZD,"build_html");async function WC(s,e){let n=this.create_doc_fragment(ZD(s,e)).firstElementChild;return QD.call(this,s,n,e),n}o(WC,"render");async function QD(s,e,t){let n=e.querySelectorAll("div[data-collection-key]");for(let i of n){let r=i.getAttribute("data-collection-key"),a=s[r];s.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}o(QD,"post_process");function eR(s,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}o(eR,"build_html");async function GC(s,e={}){let n=this.create_doc_fragment(eR(s,e)).firstElementChild;return tR.call(this,s,n,e),n}o(GC,"render");async function tR(s,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),Du(s.collection,l,_)});let i=e.querySelector(".delete-model-btn"),r=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{r.style.display=""}),c.addEventListener("click",async()=>{r.style.display="none"}),a.addEventListener("click",async()=>{await s.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}o(tR,"post_process");async function sR(s,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(s.notices.settings?.muted||{}).length)for(let n in s.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${n}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${n}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}o(sR,"build_html");async function HC(s,e={}){let t=await sR.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return nR.call(this,s,i,e),i}o(HC,"render");async function nR(s,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let r=i.closest(".muted-notice"),a=r.dataset.notice;s.notices.settings.muted[a]=!1,delete s.notices.settings.muted[a],r.remove()})})}o(nR,"post_process");var JC=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function oR(s,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}o(oR,"build_html");async function VC(s,e={}){this.apply_style_sheet(JC);let t=await oR.call(this,s,e),i=this.create_doc_fragment(t).firstElementChild;return rR.call(this,s,i,e),i}o(VC,"render");async function rR(s,e,t={}){let n=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),r=e.querySelector(".notifications-container");return Ug.call(this,"settings_env_sources",s,i),Ug.call(this,"settings_env_models",s,n),Ug.call(this,"settings_notifications",s,r),e}o(rR,"post_process");function Ug(s,e,t){if(e.config.components[s]){let n=this.create_doc_fragment(`<div data-component="${s}"></div>`).firstElementChild;t.appendChild(n),e.smart_components.render_component(s,e).then(i=>{this.empty(n),n.appendChild(i)})}}o(Ug,"render_if_available");var KC=require("obsidian");function aR(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}o(aR,"build_html");async function YC(s,e={}){let t=aR(),i=this.create_doc_fragment(t).firstElementChild;return cR.call(this,s,i,e),i}o(YC,"render");async function cR(s,e,t={}){let n=o(()=>{let r=e.querySelector(".sc-context-actions-left");this.empty(r);let a=e.querySelector(".sc-context-actions-right");this.empty(a),lR(s,a),dR(s,a),_R(s,a),uR(s,a)},"render_ctx_actions");n();let i=[];return i.push(s.on_event("context:updated",n)),this.attach_disposer(e,i),e}o(cR,"post_process");function lR(s,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{s.emit_event("context_selector:open")})}o(lR,"render_btn_open_selector");function dR(s,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",s.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{s.actions.context_copy_to_clipboard()})}o(dR,"render_btn_copy_context");function _R(s,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",s.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{s.clear_all(),s.emit_event("context:cleared")})}o(_R,"render_btn_clear_context");function uR(s,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,KC.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),s.emit_event("context_selector:help")})}o(uR,"render_btn_help");var XC=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var ja=require("obsidian");async function Ru(s){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(s);else if(ja.Platform.isMobile)new ja.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(s)}}catch(e){console.error("Failed to copy text:",e),new ja.Notice("Failed to copy.")}}o(Ru,"copy_to_clipboard");var pR=o(s=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(s);return}setTimeout(s,0)},"schedule_next_frame"),hR=o(s=>{let e=!1;return()=>{e||(e=!0,pR(async()=>{e=!1,await s()}))}},"create_render_scheduler");function fR(s,e={}){return`<div>
<div class="sc-context-view" data-context-key="${s.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}o(fR,"build_html");async function ZC(s,e={}){let t=fR(s,e);this.apply_style_sheet(XC);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return gR.call(this,s,i,e),i}o(ZC,"render");async function gR(s,e,t={}){let n=[],i=o(async()=>{let d=e.querySelector(".sc-context-view-header");s.env.smart_components.render_component("smart_context_actions",s,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");s.env.smart_components.render_component("smart_context_tree",s,t).then(p=>{this.empty(_),_.appendChild(p)});let u=e.querySelector(".sc-context-view-footer");s.env.smart_components.render_component("smart_context_meta",s,t).then(p=>{this.empty(u),u.appendChild(p)})},"render_children"),r=hR(i),a=s.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,u)=>d.addEventListener(_,u)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(u=>u.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=yR(e);await Ru(p)})),_.showAtMouseEvent(d)}),await i(),n.push(s.on_event("context:updated",r)),this.attach_disposer(e,n),e}o(gR,"post_process");function yR(s){let e=[],t=o((n,i)=>{let r=n.dataset.path;if(!r)return;let a=r.replace(/^external:/,"").replace(/^selection:/,""),c=n.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(n.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else n.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);n.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return s.querySelectorAll(":scope > ul > li").forEach(n=>t(n,0)),e.join(`
`)}o(yR,"tree_dom_to_wikilinks");function bR(s){return Math.ceil((s||0)/4)}o(bR,"estimate_tokens");function vR(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}o(vR,"build_html");async function QC(s,e={}){let t=vR(),i=this.create_doc_fragment(t).firstElementChild;return kR.call(this,s,i,e),i}o(QC,"render");async function kR(s,e,t={}){let n=o(()=>{if(s?.has_context_items){let r=s.size||0,a=bR(r);e.textContent=`\u2248 ${r.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");n();let i=[];return i.push(s.on_event("context:updated",n)),this.attach_disposer(e,i),e}o(kR,"post_process");function eO(s,e,t=""){let{key:n,path:i,name:r,is_file:a}=s,c=t.trim()!=="",l="",d="",_="";n||(n=i),(e.has(n)||c)&&(l=`<span class="sc-context-item-remove" data-path="${n}">\xD7</span>`),e.has(n)&&!n.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${n}" title="Connections for ${r}"></span>`,_=`<span class="sc-tree-links" data-path="${n}" title="Links for ${r}"></span>`);let u=["sc-tree-label"];return s.exists===!1&&u.push("missing"),`<li data-path="${n}" class="sc-tree-item ${a?"file":"dir"}${n.startsWith("external:")?" sc-external":""}">
${l}
<span class="${u.join(" ")}">${r}</span>
${d}
${_}
${t}
</li>`}o(eO,"build_tree_item");function tO(s){let e=wR(s),t=new Set(s.map(i=>i.key||i.path));return sO(e,t)}o(tO,"build_tree_html");function wR(s=[]){let e=o(a=>a?.key||a?.path||"","get_item_key"),t=o(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,u=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),u=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),u=!0);let y=[];if(l){let g="",k=!1;for(let v=0;v<l.length;v++)!k&&l.slice(v,v+2)==="[["?(k=!0,g+="[[",v++):k&&l.slice(v,v+2)==="]]"?(k=!1,g+="]]",v++):!k&&l[v]==="/"?(y.push(g),g=""):g+=l[v];g&&y.push(g)}return _&&y.push(_),d&&y.push(d),{segments:y,has_block:u}},"split_path_segments"),n={name:"",children:{},selected:!1},i=o((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),r=s.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of s){let c=e(a),l=a?.exists;if(!c||i(c,r.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),u=n,p="";d.forEach((f,y)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=y===d.length-1,k=g&&_;u.children[f]||(u.children[f]={name:f,path:k?c:p,children:k?[]:{},selected:!1,is_file:k||g&&f.includes(".")}),u=u.children[f],g&&(u.selected=!0,u.exists=l)})}return n}o(wR,"build_path_tree");function sO(s,e){return!s.children||!Object.keys(s.children).length?"":`<ul>${Object.values(s.children).sort((n,i)=>n.is_file!==i.is_file?n.is_file?1:-1:n.name.localeCompare(i.name)).map(n=>eO(n,e,sO(n,e))).join("")}</ul>`}o(sO,"tree_to_html");var nO=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var ER=o((s,e)=>!s||!e?!1:s===e||s.startsWith(`${e}/`)?!0:s.startsWith(`${e}#`),"is_nested_context_item");function iO(s,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(s?.data?.context_items||{}).filter(r=>ER(r,t));return[...new Set(i)]}o(iO,"get_nested_context_item_keys");var AR=o(s=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(s);return}setTimeout(s,0)},"schedule_next_frame"),SR=o(s=>{let e=!1;return()=>{e||(e=!0,AR(()=>{e=!1,s()}))}},"create_render_scheduler"),CR=o((s,e={})=>{let{target_path:t}=e,n=iO(s,{target_path:t});s.remove_items(n)},"remove_nested_context_items");function OR(s,e={}){return`
<div class="sc-context-tree" data-context-key="${s.data.key}"></div>
`}o(OR,"build_html");async function oO(s,e={}){this.apply_style_sheet(nO);let t=OR(s,e),i=this.create_doc_fragment(t).firstElementChild;return qR.call(this,s,i,e),i}o(oO,"render");async function qR(s,e,t={}){let n=s?.env?.plugin,i=n?.registerDomEvent?.bind(n)||((l,d,_)=>l.addEventListener(d,_)),r=o(()=>{let l=s.env,d=s.context_items.filter(t.filter),_=tO(d),u=this.create_doc_fragment(_);this.empty(e),e.appendChild(u);for(let p=0;p<d.length;p++){let f=d[p],y=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!y){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(y),y.appendChild(g)})}},"render_tree_leaves"),a=SR(r);r(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");CR(s,{target_path:_})});let c=[];return c.push(s.on_event("context:updated",a)),this.attach_disposer(e,c),e}o(qR,"post_process");var rO=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function jR(s,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}o(jR,"build_html");async function aO(s,e={}){let t=jR(s,e),n=this.create_doc_fragment(t);return this.apply_style_sheet(rO),await TR.call(this,s,n,e),n}o(aO,"render");async function TR(s,e,t={}){let n=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!n)return e;let i=e.querySelector(".source-inspector-source-info"),r=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");r&&a&&c&&r.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(s.data,null,2),a.style.display="",r.textContent="Hide source data"):(a.style.display="none",r.textContent="Show source data")});let l=s.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=s.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!s||!s.blocks||s.blocks.length===0)return this.safe_inner_html(n,"<p>No blocks</p>"),e;let u=s.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',k=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',v="",b="";try{let S=await p.read();v=S.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),b=(await p.get_embed_input(S)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(S){console.error("[source_inspector] Error reading block:",S),v='<em style="color:red;">Error reading block content</em>'}let A=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${k}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${b}</pre>
</details>
<blockquote>${v}</blockquote>
<hr>
`);n.appendChild(A)}return e}o(TR,"post_process");var mO=require("obsidian");var Hi=require("obsidian");var cO=require("obsidian");var Fu=class extends cO.Modal{static{o(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var lO=require("obsidian");var Bu=class extends lO.Modal{static{o(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function dO(s,e,t={}){let{Menu:n=Hi.Menu}=t,i=s.main,r=o(a=>{a.preventDefault(),a.stopPropagation();let c=new n(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new Hi.Notice("No active note found");return}let _=s.smart_sources?.get(d.path);if(!_){new Hi.Notice("Active note is not indexed by Smart Environment");return}new Fu(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Bu(i.app,s).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{s.export_json(),new Hi.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{s.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{s.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",r),r}o(dO,"register_status_bar_context_menu");function NR(s){let e=s?.session_events;if(!Array.isArray(e))return 0;let t=0;for(let n of e){let i=n?.event_key;typeof i=="string"&&i.startsWith("notification:")&&(t+=1)}return t}o(NR,"get_notification_event_count");function _O(s){let e=Object.keys(s?.smart_sources?.sources_re_import_queue||{}).length,t=NR(s?.event_logs),n=s?.is_pro?"Pro":s?.constructor?.version,i=`Smart Env${n?" "+n:""}`,r="Smart Environment status",a=null;return e>0?(i=`Embed now (${e})`,r="Click to re-import.",a="attention"):t>0&&(a=s?.event_logs?.notification_status||"info"),{message:i,title:r,indicator_count:t,indicator_level:a,embed_queue_count:e}}o(_O,"get_status_bar_state");var uO=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function IR(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}o(IR,"build_html");async function pO(s,e={}){this.apply_style_sheet(uO);let n=this.create_doc_fragment(IR()).firstElementChild;return LR.call(this,s,n,e),n}o(pO,"render");function LR(s,e,t={}){let n=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),r=e?.querySelector?.(".smart-env-status-msg"),a=o(()=>Object.keys(s?.smart_sources?.sources_re_import_queue||{}).length,"get_embed_queue"),c=o(()=>{let u=_O(s),{message:p,title:f,indicator_count:y,indicator_level:g}=u;n&&(0,mO.setIcon)(n,"smart-connections"),i&&(i._click_handler||(i._click_handler=k=>{k.stopPropagation(),s.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),y>0?i.dataset.count=String(y):i.dataset.count="",g?i.dataset.level=String(g):i.dataset.level="info"),r.setText?.(p),e.setAttribute?.("title",f),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=k=>{if(a()>0)k.preventDefault(),k.stopPropagation(),r?.setText?.("Embedding..."),s.run_re_import?.();else{let b=new MouseEvent("contextmenu",k);e.dispatchEvent?.(b)}},e.addEventListener("click",e._click_handler))},"render_status_elm");dO(s,e),c();let l=null,d=o(()=>{l&&clearTimeout(l),l=setTimeout(()=>{c(),l=null},100)},"debounce_refresh_status_bar"),_=[];_.push(s.events.on("*",d)),this.attach_disposer(e,_)}o(LR,"post_process");var hO=`.sc-modal-suggestion-right {\r
margin-left: auto;\r
text-align: right;\r
white-space: nowrap;\r
font-size: var(--font-ui-smaller);\r
color: var(--text-muted);\r
font-variant-numeric: tabular-nums;\r
float: right;\r
}`;function zR(s,e={}){return`<span class="sc-modal-suggestion-right" data-sc-display-right="true">${s}</span>`}o(zR,"build_html");function fO(s,e={}){return this.apply_style_sheet(hO),this.create_doc_fragment(zR(s,e)).firstElementChild}o(fO,"render");var gO=require("obsidian");function DR(s,e={}){let{plugin_name:t=s.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}o(DR,"build_html");function yO(s,e={}){let t=DR.call(this,s,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return RR.call(this,s,i,e),i}o(yO,"render");async function RR(s,e){let t=e.querySelector(".callout-icon"),n=(0,gO.getIcon)("hand-heart");n&&(this.empty(t),t.appendChild(n));let i=s.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:s.env})}o(RR,"post_process");var bO=require("obsidian");function FR(s,e={}){let{plugin_name:t=s.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}o(FR,"build_html");function vO(s,e={}){let t=FR.call(this,s,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),r=i.querySelector(".callout-icon"),a=(0,bO.getIcon)("smart-connections");return a&&(this.empty(r),r.appendChild(a)),BR.call(this,s,i,e),i}o(vO,"render");function BR(s,e){}o(BR,"post_process");var Wg=require("obsidian");async function kO(s={}){let e=this.context_items.filter(s.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new Wg.Notice("No context items to copy.");let t=await this.get_text(s);await Ru(t);let n=UR({item_count:e.length,char_count:t.length,max_depth:s.max_depth,exclusions:s.exclusions});this.emit_event("context:copied"),new Wg.Notice(n)}o(kO,"copy_to_clipboard");function UR(s={}){let e=Number.isFinite(s.item_count)?s.item_count:0,t=Number.isFinite(s.char_count)?s.char_count:0,n=[];n.push(`${e} file(s)`),n.push(`${WR(t)} chars`),Number.isFinite(s.max_depth)&&n.push(`depth\u2264${s.max_depth}`);let i=GR(s.exclusions);return i>0&&n.push(`${i} section(s) excluded`),`Copied to clipboard! (${n.join(", ")})`}o(UR,"format_stats_message");function WR(s){return Number.isFinite(s)?s>=1e5?`~${Math.round(s/1e3)}k`:s.toLocaleString():"0"}o(WR,"format_char_count");function GR(s){return s?Object.values(s).reduce((e,t)=>{let n=Number.isFinite(t)?t:0;return e+n},0):0}o(GR,"sum_exclusions");var HR="xml_structured",Wu={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},wO=o((s={})=>{let e=s.template_preset||HR;return Wu[e]?e:"custom"},"get_preset_key"),Uu=o((s,e,t,n)=>{let i=wO(s),r=Wu[i],a=s?.[n];return i!=="custom"&&r&&typeof r[t]=="string"?r[t]:i==="custom"&&typeof a=="string"?a:e?.[n]},"get_template_value");function Gu(){return Object.entries(Wu).map(([s,e])=>({value:s,label:e.label||s}))}o(Gu,"get_template_preset_options");function xO(s={},e={}){return{template_before:Uu(s,e,"context_template_before","template_before"),template_after:Uu(s,e,"context_template_after","template_after")}}o(xO,"get_context_templates");function EO(s={},e={}){let t=wO(s),n=Wu[t],i=t==="custom"&&typeof s.json_stringify=="boolean";return{...n&&typeof n=="object"?n:{},...i?{json_stringify:s.json_stringify}:{},template_before:Uu(s,e,"item_template_before","template_before"),template_after:Uu(s,e,"item_template_after","template_after")}}o(EO,"get_item_templates");var JR=o((s="")=>{if(typeof s!="string"||s.trim().length===0)return"";let[e]=s.split(/[\\/]/).slice(-1),[t,...n]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return n.length>0?`${i}#${n.join("#")}`:i},"derive_item_name_from_key"),VR=o(s=>JR(s.key),"get_item_name");async function AO(s,e={}){let t={KEY:this.key,ITEM_NAME:VR(this),TIME_AGO:Rf(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},n=o(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(u,p)=>t[p]||"");return c},"replace_vars"),i=EO(this.settings,Gg);(e.json_stringify||i.json_stringify)&&(s=JSON.stringify(s));let r=await n(i.template_before),a=await n(i.template_after);return["",r,s,a,""].join(`
`)}o(AO,"merge_template");var SO={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:o(()=>Gu(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},Gg={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Ji(s=[]){if(!Array.isArray(s)||s.length===0)return"";let e={};for(let t of s){let n=KR(t),i=t.split("/").filter(Boolean),r=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?n?r[c]=r[c]??{__isExplicitFolder:!0}:r[c]=null:r=r[c]??={}}}return Hu(e),CO(e).trimEnd()}o(Ji,"build_file_tree_string");function KR(s){return typeof s=="string"&&s.endsWith("/")}o(KR,"is_folder_path");function Hu(s){if(!(!s||typeof s!="object"))for(let e of Object.keys(s)){let t=s[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Hu(t);continue}let n=Object.keys(t);if(n.length===1&&t[n[0]]!==null&&!t[n[0]].__isExplicitFolder){let i=`${e}/${n[0]}`;s[i]=t[n[0]],delete s[e],Hu(s[i])}else Hu(t)}}}o(Hu,"compress_single_child_dirs");function CO(s,e=""){let t="",n=Object.entries(s).sort((i,r)=>{let a=i[1]!==null,c=r[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(r[0])});return n.forEach(([i,r],a)=>{let c=a===n.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";r===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=CO(r,e+(c?"    ":"\u2502   ")))}),t}o(CO,"build_tree_string");async function OO(s,e={}){let t=e.context_items||[],n={FILE_TREE:o(()=>Ji(t.map(l=>l.key)),"FILE_TREE")},i=o(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(u,p)=>n[p]?.()||"");return l},"replace_vars"),r=xO(this.settings,Hg),a=await i(r.template_before),c=await i(r.template_after);return[a,s,c].join(`
`)}o(OO,"merge_template");var qO={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:o(()=>Gu(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},Hg={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};var jO="Named contexts";function YR(s){let t=s?.smart_contexts?.items;return!t||typeof t!="object"?[]:Object.values(t).filter(Boolean)}o(YR,"list_context_items");function TO(s,e){let t=[];for(let n=0;n<e.length;n+=1){let i=e[n];if(!i||typeof i.key!="string")continue;let r=Number.isFinite(i.d)?i.d:0,a=s?.data?.context_items?.[i.key],c=Number.isFinite(a?.d)?a.d:null;t.push({key:i.key,d:c===null?r:Math.min(c,r)})}return t}o(TO,"normalize_items_preserving_depth");function $O(s){let e=s?.key;return typeof e=="string"&&e.endsWith("#codeblock")}o($O,"is_codeblock_context");function XR(s,e={}){let t=e.context_name;s?.data||(s.data={});let n=Array.isArray(s?.data?.codeblock_named_contexts)?s.data.codeblock_named_contexts:[],i=new Set(n);return t&&i.add(t),s.data.codeblock_named_contexts=[...i],s.data.codeblock_named_contexts}o(XR,"update_codeblock_named_contexts");function ZR(s,e={}){let t=Array.isArray(e.items)?e.items:[],n=e.context_name;return TO(s,t).map(i=>({...i,from_named_context:n}))}o(ZR,"build_codeblock_named_context_items");function QR(s,e={}){let t=e.other_ctx,n=e.context_name,i=NO(t),r=ZR(s,{items:i,context_name:n});return XR(s,{context_name:n}),s.add_items(r),r}o(QR,"apply_codeblock_named_context");function NO(s){let e=s?.data?.context_items||{},t=Object.entries(e),n=[];for(let i=0;i<t.length;i+=1){let[r,a]=t[i];if(!r||a?.exclude)continue;let c=Number.isFinite(a?.d)?a.d:0;n.push({key:r,d:c})}return n}o(NO,"get_items_from_context");async function PO(s={}){let e=this,t=e?.env,n=s?.modal;n?.setInstructions&&n.setInstructions([{command:"Enter",purpose:"Merge selected context into current context"},{command:"Mod + Enter",purpose:"Open in Context Selector"}]);let i=YR(t).filter(a=>{let c=a?.data?.name;return typeof c=="string"&&c.trim().length>0}).sort((a,c)=>{let l=String(a.data.name).trim().toLowerCase(),d=String(c.data.name).trim().toLowerCase();return l.localeCompare(d)});if(!i.length)return[{key:"contexts:none",display:"No named contexts found"}];let r=[];for(let a=0;a<i.length;a+=1){let c=i[a],l=c?.key||c?.data?.key,d=String(c?.data?.name||"").trim();if(!!(e?.data?.context_items&&Object.values(e.data.context_items).some(p=>p?.from_named_context===d||p?.key===l)))continue;let u=c?.item_count||Object.keys(c?.data?.context_items||{}).length;r.push({key:`named_context:${l}`,display:`${d} (${u})`,item:c,select_action:o(({modal:p})=>{let f;if($O(e))f=QR(e,{other_ctx:c,context_name:d});else{let y=NO(c);f=TO(e,y),e.add_items(f)}if(p?.setInstructions){let y=$O(e)?`Added ${d} as a codeblock named context`:`Merged ${f.length} item(s) from ${d}`;p.setInstructions([{command:"Enter",purpose:y}])}},"select_action"),mod_select_action:o(({modal:p})=>{p?.close&&p.close(),e.emit_event("context_selector:open",{collection_key:"smart_contexts",item_key:l})},"mod_select_action")})}return r}o(PO,"context_suggest_contexts");async function Ju(s){let e=s.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let n=await t.embed(e);return s.to_item={...n},s.score_algo_key||(s.score_algo_key="similarity"),s}o(Ju,"pre_process");function Jg(s){return this.vec?s.to_item?.vec?{score:Ys(this.vec||[],s.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}o(Jg,"similarity");Jg.action_type="score";var Vg="Cosine Similarity",Kg="Ranks by cosine similarity between the current note and candidates.",IO={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${Vg} algorithm`,value:`${Kg}`}};var Yg=require("obsidian");async function LO(s,e=null){try{let n=s.env.obsidian_app,i=s.key;i.endsWith("#")&&(i=i.slice(0,-1));let r;if(i.includes("#")){let[c]=i.split("#");r=n.metadataCache.getFirstLinkpathDest(c,"")}else r=n.metadataCache.getFirstLinkpathDest(i,"");if(!r){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=Yg.Keymap.isModEvent(e),l=Yg.Keymap.isModifier(e,"Alt");c&&l?a=n.workspace.splitActiveLeaf("vertical"):c?a=n.workspace.getLeaf(!0):a=n.workspace.getMostRecentLeaf()}else a=n.workspace.getMostRecentLeaf();if(await a.openFile(r),typeof s?.line_start=="number"){let{editor:c}=a.view,l={line:s.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}s.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),s.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}o(LO,"open_source");async function MO(s=null){await LO(this,s)}o(MO,"source_open");var zO={collections:{embedding_models:rC,lookup_lists:cC},item_types:{EmbeddingModel:rn,LookupList:ms},items:{embedding_model:{class:rn},lookup_list:{class:ms}},modules:{},components:{collection_settings:{render:lC},context_item_leaf:{render:hC},env_stats:{render:fC},form_dropdown:{render:Dg},lean_coffee_callout:{render:bC},milestones:{render:SC},notifications_feed:{render:CC},pro_plugins_list:{render:PC},pro_plugins_list_item:{render:IC},settings_env_model:{render:DC},settings_env_model_type:{render:UC},settings_env_models:{render:WC},settings_env_sources:{render:RA},settings_model_actions:{render:GC},settings_notifications:{render:HC},settings_smart_env:{render:VC},smart_context_actions:{render:YC},smart_context_item:{render:ZC},smart_context_meta:{render:QC},smart_context_tree:{render:oO},source_inspector:{render:aO},status_bar:{render:pO},suggest_display_right:{render:fO},supporter_callout:{render:yO},user_agreement_callout:{render:vO}},actions:{context_copy_to_clipboard:{action:kO},context_item_merge_template:{action:AO,settings_config:SO,default_settings:Gg},context_merge_template:{action:OO,settings_config:qO,default_settings:Hg},context_suggest_blocks:{action:os,display_name:HA},context_suggest_contexts:{action:PO,display_name:jO},context_suggest_sources:{action:Gr,display_name:KA},lookup_list_pre_process:{action:Ju,pre_process:Ju},similarity:{action:Jg,settings_config:IO,display_name:Vg,display_description:Kg},source_open:{action:MO}}};var DO={env_path:"",modules:{smart_fs:{class:j_,adapter:T_},smart_view:{class:M_,adapter:D_},smart_embed_model:{class:sa,adapters:{transformers:Mi,openai:_u,ollama:pu,gemini:hu,lm_studio:fu}},smart_chat_model:{class:ia,adapters:{anthropic:oa,azure:ca,custom:ba,google:Di,gemini:_a,groq:va,lm_studio:ma,ollama:fa,open_router:ua,openai:on,xai:ka,deepseek:wa},http_adapter:new yt({adapter:Li,obsidian_request_url:Xg.requestUrl})},http_adapter:{class:yt,adapter:Li,obsidian_request_url:Xg.requestUrl}},collections:{context_items:XS,event_logs:QS,smart_components:HS,smart_contexts:KS,smart_sources:{collection_key:"smart_sources",class:Yr,data_adapter:Qr,source_adapters:{md:en,txt:en,"excalidraw.md":iu,base:tu,canvas:nu,rendered:su},content_parsers:[FS],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:ta,data_adapter:ou,block_adapters:{md:ji,txt:ji,"excalidraw.md":ji}}},item_types:{SmartSource:qi,SmartBlock:$i},items:{smart_source:ES,smart_block:jS},default_settings:nC,modals:{context_selector:{class:qu,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:ju},notifications_feed_modal:{class:$u}}};Nt(DO,zO);var RO=DO;var Vu=require("obsidian");function FO(){(0,Vu.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}o(FO,"add_smart_chat_icon");function BO(){(0,Vu.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}o(BO,"add_smart_connections_icon");function UO(){(0,Vu.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}o(UO,"add_smart_lookup_icon");var WO=require("obsidian");var Ku={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:o(s=>{s.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:o(s=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:o(s=>{console.log("pausing"),s.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:o(s=>{s.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function e5(s){for(let e of Object.keys(s)){let t=s[e];typeof t.create!="function"&&(t.create=function(n={}){let i=this.en??e;for(let[c,l]of Object.entries(n))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let r;!n.button&&this.button?r={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:r=n.button;let a=n.timeout??this.timeout??5e3;return{text:i,button:r,timeout:a,confirm:n.confirm,immutable:n.immutable}})}return s}o(e5,"define_default_create_methods");var Ta=class{static{o(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,e5(Ku)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let n=null;typeof t=="string"?n=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let r=Ku[e],a={text:n||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(r?.create){let l=r.create({...t});a.text=n||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:n}){return this.active[e]=new this.adapter(t,n),this.active[e]}_build_fragment(e,t,{button:n,confirm:i,immutable:r}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),n?.text&&typeof n.callback=="function"&&this._add_button(n,l),r||this._add_mute_button(e,l),a}_add_button(e,t){let n=document.createElement("button");this.env.smart_view.safe_inner_html(n,e.text),n.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(n)}_add_mute_button(e,t){let n=document.createElement("button");(0,WO.setIcon)(n,"bell-off"),n.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,Ku["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(n)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var GO=require("obsidian");var t5=require("obsidian");function Yu(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}o(Yu,"get_smart_server_url");var s5="smart-plugins-op",n5="smart-plugins-op-secret";function i5({access_token:s,refresh_token:e},t){localStorage.setItem(t+"token",s),e&&localStorage.setItem(t+"refresh",e)}o(i5,"set_local_storage_token");async function HO(s,e){let t=r5(e.app.vault.getName()),n=`${Yu()}/auth/oauth_exchange2`,i=await(0,GO.requestUrl)({url:n,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:s5,client_secret:n5,code:s})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:r,refresh_token:a}=i.json;if(!r)throw new Error("No access_token in response");i5({access_token:r,refresh_token:a},t)}o(HO,"exchange_code_for_tokens");var o5="_smart_plugins_oauth_";function r5(s){return`${String(s||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${o5}`}o(r5,"build_oauth_storage_prefix");function JO(s){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let n=Ji([...new Set(t)]);return s.replace(/{{\s*folder_tree\s*}}/gi,n)}o(JO,"replace_folder_tree_var");function VO(s){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let n=Ji([...new Set(t)]);return s.replace(/{{\s*folders_top\s*}}/gi,n)}o(VO,"replace_folders_top_var");function KO(s){console.log("replace_recent_n_var",s);let e=this;return s.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,n)=>{let i=parseInt(n,10)||0,r=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,r),r?`
- ${r}`:""}).trim()}o(KO,"replace_recent_n_var");function YO(s){let t=this.app?.metadataCache?.getTags?.()||{},n=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return s.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${n}
`).trim()}o(YO,"replace_vault_tags_var");function XO(s){s.register(e=>/{{\s*folder_tree\s*}}/i.test(e),JO,"{{ folder_tree }}"),s.register(e=>/{{\s*folders_top\s*}}/i.test(e),VO,"{{ folders_top }}"),s.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),YO,"{{ tags }}"),s.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),KO,"{{ recent_10 }}")}o(XO,"register_completion_variable_adapter_replacements");async function wt({app:s,plugin_ids:e=[]}={}){if(!s)return;let t=s.vault?.adapter;for(let n of e)await a5(s.plugins,n)&&console.warn(`Disabled legacy plugin: ${n}`),await c5(t,n)&&console.warn(`Removed legacy plugin: ${n}`)}o(wt,"remove_smart_plugins_plugin");async function a5(s,e){if(!(!s||!(s.plugins?.[e]||s.enabledPlugins?.has?.(e)||s.manifests&&e in s.manifests)))return s.plugins?.[e]&&await s.unloadPlugin?.(e),s.disablePluginAndSave&&await s.disablePluginAndSave(e),s.enabledPlugins?.has?.(e)&&s.enabledPlugins.delete(e),s.manifests&&e in s.manifests&&delete s.manifests[e],await s.loadManifests?.(),!0}o(a5,"disable_plugin_if_present");async function c5(s,e){if(!s?.exists)return;let t=`.obsidian/plugins/${e}`;if(await s.exists(t)){if(s.rmdir){await s.rmdir(t,!0);return}if(s.list&&s.remove){let i=[t];for(;i.length;){let r=i.pop(),a=await s.list(r);for(let c of a?.files||[])await s.remove(`${r}/${c}`);for(let c of a?.folders||[])i.push(`${r}/${c}`)}return await s.remove(t),!0}}}o(c5,"remove_plugin_folder");var Vi=class extends Kr{static{o(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,FO(),BO(),UO(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new ps.Notice(i,0),window.smart_env=null}let n=Nt(t,RO);return n.env_path="",await super.create(e,n)}async load(e=!1){if(this.run_migrations(),this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")||this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),ps.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new ps.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let r=i.view?.file?.path;this.emit_source_opened(r,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let r=i?.path;this.emit_source_opened(r,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&XO(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),wC(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let n=this.smart_sources.get(e);n&&(this._current_opened_source=e,n.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new Ta(this,{adapter:ps.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),n=`${Yu()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(n,"_external"),n}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new ps.Notice("No OAuth code provided in URL. Login failed.");return}try{await HO(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(n){console.error("OAuth callback error",n),new ps.Notice(`OAuth callback error: ${n.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&l5(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){wt({app:this.plugin.app,plugin_ids:["smart-plugins"]}),wt({app:this.plugin.app,plugin_ids:["smart-editor"]}),wt({app:this.plugin.app,plugin_ids:["smart-sources"]}),wt({app:this.plugin.app,plugin_ids:["smart-claude"]}),wt({app:this.plugin.app,plugin_ids:["smart-gemini"]}),wt({app:this.plugin.app,plugin_ids:["smart-deepseek"]}),wt({app:this.plugin.app,plugin_ids:["smart-perplexity"]}),wt({app:this.plugin.app,plugin_ids:["smart-grok"]}),wt({app:this.plugin.app,plugin_ids:["smart-aistudio"]})}};function l5(s,e){let t=new Blob([s],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)}o(l5,"download_json");var _5=require("obsidian");var d5=require("obsidian");var ZO=require("obsidian");var Xu=class extends Jt{static{o(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var s2=Y(t2(),1);var b5=Object.defineProperty,v5=o((s,e,t)=>e in s?b5(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,"__defNormalProp"),k5=o((s,e,t)=>(v5(s,typeof e!="symbol"?e+"":e,t),t),"__publicField");function w5(s,e){let t=Array.from({length:s.length},(n,i)=>({start:i,end:i+1}));for(;t.length>1;){let n=null;for(let i=0;i<t.length-1;i++){let r=s.slice(t[i].start,t[i+1].end),a=e.get(r.join(","));a!=null&&(n==null||a<n[0])&&(n=[a,i])}if(n!=null){let i=n[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}o(w5,"bytePairMerge");function x5(s,e){return s.length===1?[e.get(s.join(","))]:w5(s,e).map(t=>e.get(s.slice(t.start,t.end).join(","))).filter(t=>t!=null)}o(x5,"bytePairEncode");function E5(s){return s.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}o(E5,"escapeRegex");var Qg=class{static{o(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(s,e){this.patStr=s.pat_str;let t=s.bpe_ranks.split(`
`).filter(Boolean).reduce((n,i)=>{let[r,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>n[d]=l+_),n},{});for(let[n,i]of Object.entries(t)){let r=s2.default.toByteArray(n);this.rankMap.set(r.join(","),i),this.textMap.set(i,r)}this.specialTokens={...s.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[i,r])=>(n[r]=this.textEncoder.encode(i),n),{})}encode(s,e=[],t="all"){let n=new RegExp(this.patStr,"ug"),i=Qg.specialTokenRegex(Object.keys(this.specialTokens)),r=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Qg.specialTokenRegex([...c]),_=s.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(s),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??s.length;for(let f of s.substring(l,u).matchAll(n)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){r.push(g);continue}r.push(...x5(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];r.push(p),l=d.index+d[0].length}return r}decode(s){let e=[],t=0;for(let r=0;r<s.length;++r){let a=s[r],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let n=new Uint8Array(t),i=0;for(let r of e)n.set(r,i),i+=r.length;return this.textDecoder.decode(n)}},Qu=Qg;k5(Qu,"specialTokenRegex",s=>new RegExp(s.map(e=>E5(e)).join("|"),"g"));async function i2(s,e=s){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await n2(s);return window.localStorage.setItem(e,JSON.stringify(_)),_}let n=await import("node:fs/promises"),i=await import("node:path"),r=await import("node:os"),a=i.join(r.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await n.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await n2(s);return await n.mkdir(a,{recursive:!0}),await n.writeFile(c,JSON.stringify(l),"utf8"),l}o(i2,"fetch_json_cached");async function n2(s){let e=await fetch(s);if(!e.ok)throw new Error(`failed to download ${s} \u2013 ${e.status}`);return await e.json()}o(n2,"do_fetch");var A5="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",De=class extends Xu{static{o(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return we}get res_adapter(){return xe}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Ge({adapter:Ct})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),r=await this.request(i);if(!r)return console.error("No response received for embedding request."),[];if(r.error)return[r];let c=new this.res_adapter(this,r).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let n=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(n);return i.error?{error:ue(i,n.status())}:i}catch(n){return console.warn("Request error:",n),await this.handle_request_err(n,e,t)}}async handle_request_err(e,t,n){if(e.status===429&&n<3){let i=Math.pow(n+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(r=>setTimeout(r,1e3*i)),await this.request(t,n+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?null:c}async load_tiktoken(){let e=await i2(A5,"cl100k_base.json");this.tiktoken=new Qu(e)}},we=class{static{o(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},xe=class{static{o(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var em=class extends De{static{o(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return ey}get res_adapter(){return ty}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let n=e.map(r=>this.estimate_tokens(r.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let r=i[0].error.details?.details?.find(a=>a.retryDelay);if(r.retryDelay){let a=parseInt(r.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((r,a)=>{r.tokens=n[a]}),console.log("Gemini embed_batch response:",i),i}},ey=class extends we{static{o(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[n,...i]=t.split(`
`),r=i.join(`
`).trim()||"";return r.length?{model:this.model_id,content:{parts:[{text:r}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:n}:{model:this.model_id,content:{parts:[{text:n}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},ty=class extends xe{static{o(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,n)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${n}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};var sy=class extends em{static{o(this,"GoogleGeminiEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},S5={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."},gemini_note:{name:"Note about using Gemini Embeddings API",type:"html",value:'<p class="model-note"><b>WARNING: Gemini rate-limiting:</b> Google imposes strict rate limits on the Gemini Embeddings API. Smart Environment will attempt to retry. Retry details can be found in the developer console logs. Consistent rate limit errors may prevent all items from being properly embedded. Restarting Obsidian will attempt to re-embed any failed items. If you continue to experience issues, try disabling blocks to reduce the number of embeddings required by your Smart Environment.</p>'}},o2={class:sy,settings_config:S5};function C5(s,e="lm_studio"){return s.object!=="list"||!Array.isArray(s.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",s),s.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,n)=>(t[n.id]={id:n.id,model_name:n.id,max_tokens:n.loaded_context_length||512,description:`LM Studio model: ${n.id}`,adapter:e},t),{}))}o(C5,"parse_lm_studio_models");var tm=class extends De{static{o(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return ny}get res_adapter(){return iy}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let n=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(n);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return C5(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),n=await super.embed_batch(e);return n.forEach((i,r)=>{i.tokens=t[r]}),n}},ny=class extends we{static{o(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},iy=class extends xe{static{o(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var oy=class extends tm{static{o(this,"LmStudioEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},r2={class:oy};var sm=class extends De{static{o(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return ry}get res_adapter(){return ay}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let n=await t.json(),i=[];for(let a of q5(n.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let r=this.parse_model_data(i);return this.model_data=r,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),r}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,n)=>t.name.localeCompare(n.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,n)=>{let i=n.model_info||{},r=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[n.name]={model_name:n.name,id:n.name,multimodal:!1,max_tokens:r||this.max_tokens,dims:a,description:n.description||`Model: ${n.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},ry=class extends we{static{o(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},ay=class extends xe{static{o(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},O5=o(s=>["embed","embedding","bge"].some(e=>s.name.toLowerCase().includes(e)),"is_embedding_model"),q5=o(s=>{if(!Array.isArray(s))throw new TypeError("models must be an array");return s.filter(O5)},"filter_embedding_models");var cy=class extends sm{static{o(this,"OllamaEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},$5={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},a2={class:cy,settings_config:$5};var nm=class extends De{static{o(this,"SmartEmbedOpenRouterAdapter")}static key="open_router";static defaults={description:"OpenRouter (Embeddings)",type:"API",adapter:"OpenRouterEmbeddings",endpoint:"https://openrouter.ai/api/v1/embeddings",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"text-embedding-3-small",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys",streaming:!1,api_key:null,batch_size:50,max_tokens:8191};get req_adapter(){return ly}get res_adapter(){return dy}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenRouter API key for embeddings",type:"password",description:"Required for OpenRouter embedding models.",placeholder:"Enter OpenRouter API key"}}}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}get models_endpoint(){return this.constructor.defaults.models_endpoint}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;if(!this.api_key){console.warn("[SmartEmbedOpenRouterAdapter] API key missing; cannot fetch models from OpenRouter.");let t=this.constructor.defaults.default_model,n={[t]:{id:t,model_name:t,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=n,n}try{let n=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET",headers:{Authorization:`Bearer ${this.api_key}`}})).json(),i=this.parse_model_data(n);return this.model.data.provider_models=i,this.model.re_render_settings(),i}catch(t){if(console.error("[SmartEmbedOpenRouterAdapter] Failed to fetch models:",t),this.model.data.provider_models)return this.model.data.provider_models;let n=this.constructor.defaults.default_model,i={[n]:{id:n,model_name:n,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=i,i}}parse_model_data(e){let t=[];if(Array.isArray(e?.data))t=e.data;else if(Array.isArray(e))t=e;else return console.error("[SmartEmbedOpenRouterAdapter] Invalid model data format from OpenRouter:",e),{_:{id:"No models found."}};let n={};for(let i of t){let r=i.id||i.name;r&&j5(r)&&(n[r]={id:r,model_name:r,max_tokens:i.context_length||this.max_tokens,description:i.name||i.description||`Model: ${r}`,adapter:this.constructor.key})}return Object.keys(n).length?n:{_:{id:"No embedding models found."}}}},ly=class extends we{static{o(this,"SmartEmbedOpenRouterRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},dy=class extends xe{static{o(this,"SmartEmbedOpenRouterResponseAdapter")}parse_response(){let e=this.response;if(!e||!Array.isArray(e.data))return console.error("[SmartEmbedOpenRouterResponseAdapter] Invalid embedding response format:",e),[];let t=null;return e.usage?.total_tokens&&e.data.length>0&&(t=e.usage.total_tokens/e.data.length),e.data.map(n=>({vec:n.embedding||n.data||[],tokens:t}))}},j5=o(s=>{let e=String(s||"").toLowerCase();return!!(e.split(/[-:/_]/).some(n=>["embed","embedding","bge"].includes(n))||e.includes("text-embedding"))},"is_embedding_model");var _y=class extends nm{static{o(this,"OpenRouterEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},c2={class:_y};var im=class extends De{static{o(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let n=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-n)),r=e.slice(0,i),a=r.lastIndexOf(" ");a>0&&(r=r.slice(0,a));let c=await this.prepare_embed_input(r);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return uy}get res_adapter(){return my}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},uy=class extends we{static{o(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},my=class extends xe{static{o(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(n=>({vec:n.embedding,tokens:t}))}};var py=class extends im{static{o(this,"OpenAIEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get batch_size(){return 30}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},T5={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},dimensions:{name:"Embedding Dimensions",type:"dropdown",description:"Select the number of dimensions for the embeddings (only for text-embedding-3 models).",option_1:"256|256 (equivalent to ada using 'large' model)",option_2:"512|512 (equivalent to ada using 'small' model)",option_3:"1536|1536",option_4:"3072|3072 (uses >10X more RAM/storage than 256)",default:"512"}},l2={class:py,settings_config:T5};var om=class extends J{static{o(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return hy}res_adapter=fy;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},hy=class extends K{static{o(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(n=>n.text).join(`
`):t.content;else if(t.role==="tool"){let n={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(n)}else{let n={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(n.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(n)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},fy=class extends W{static{o(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:ue(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let n=e.delta?.text;t=n,this._res.content[0].text+=n}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var gy=class extends om{static{o(this,"AnthropicChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},N5={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."}},d2={class:gy,settings_config:N5};var P5=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Ki=class extends J{static{o(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=yy;parse_model_data(e){return e.data.filter(t=>!P5.some(n=>t.id.startsWith(n))&&!t.id.includes("-instruct")).reduce((t,n)=>{let i={model_name:n.id,id:n.id,multimodal:!0,max_input_tokens:I5(n.id)};return t[n.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function I5(s){return s.startsWith("gpt-4.1")?1e6:s.startsWith("o")?2e5:s.startsWith("gpt-5")?4e5:s.startsWith("gpt-4o")||s.startsWith("gpt-4.5")||s.startsWith("gpt-4-turbo")?128e3:s.startsWith("gpt-4")?8192:s.startsWith("gpt-3")?16385:8e3}o(I5,"get_max_input_tokens");var yy=class extends W{static{o(this,"SmartChatModelOpenaiResponseAdapter")}};var rm=class extends Ki{static{o(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:n}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${n}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,raw:n,description:`Model: ${n.model}, Status: ${n.status}`,max_input_tokens:4e3};return t}};var by=class extends rm{static{o(this,"AzureChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},L5={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."},azure_resource_name:{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},azure_deployment_name:{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},azure_api_version:{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}},_2={class:by,settings_config:L5};var am=class extends J{static{o(this,"SmartChatModelCohereAdapter")}static key="cohere";static defaults={description:"Cohere Command-R",type:"API",endpoint:"https://api.cohere.ai/v1/chat",streaming:!1,adapter:"Cohere",models_endpoint:"https://api.cohere.ai/v1/models",default_model:"command-r",signup_url:"https://dashboard.cohere.com/welcome/register?redirect_uri=%2Fapi-keys"};get req_adapter(){return vy}get res_adapter(){return ky}async count_tokens(e){let t={url:`${this.endpoint}/tokenize`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.api_key}`},body:JSON.stringify({text:typeof e=="string"?e:JSON.stringify(e)})};return(await this.http_adapter.request(t)).json.tokens.length}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("command-")).reduce((t,n)=>(t[n.name]={model_name:n.name,id:n.name,max_input_tokens:n.context_length,tokenizer_url:n.tokenizer_url,finetuned:n.finetuned,description:`Max input tokens: ${n.context_length}, Finetuned: ${n.finetuned}`,raw:n},t),{})}},vy=class extends K{static{o(this,"SmartChatModelCohereRequestAdapter")}to_platform(){return this.to_cohere()}to_cohere(){let e={model:this.model_id,message:this._get_latest_user_message(),chat_history:this._transform_messages_to_cohere_chat_history(),max_tokens:this.max_tokens,temperature:this.temperature,stream:this.stream,...this.tools&&{tools:this._transform_tools_to_cohere()},...this._req.tool_choice&&{tool_choice:this._req.tool_choice},...this._req.preamble&&{preamble:this._req.preamble},...this._req.conversation_id&&{conversation_id:this._req.conversation_id},...this._req.connectors&&{connectors:this._req.connectors},...this._req.documents&&{documents:this._req.documents}};return this._req.response_format&&(e.response_format={type:this._req.response_format.type,...this._req.response_format.schema&&{schema:this._req.response_format.schema}}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}_get_latest_user_message(){if(this.messages.some(t=>Array.isArray(t.content)&&t.content.some(n=>n.type==="image_url")))throw new Error("Cohere API does not support image input");let e=this.messages.filter(t=>t.role==="user");return e[e.length-1]?.content||""}_transform_messages_to_cohere_chat_history(){return this.messages.slice(0,-1).map(e=>({role:this._get_cohere_role(e.role),message:this._get_cohere_content(e.content)}))}_get_cohere_role(e){return{system:"SYSTEM",user:"USER",assistant:"CHATBOT",function:"CHATBOT"}[e]||e.toUpperCase()}_get_cohere_content(e){if(Array.isArray(e)){for(let t of e)if(t.type==="image_url")throw new Error("Cohere API does not support image input");return e.map(t=>t.type==="text"?t.text:JSON.stringify(t)).join(`
`)}return e}_transform_tools_to_cohere(){return this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}},ky=class extends W{static{o(this,"SmartChatModelCohereResponseAdapter")}to_openai(){if(this._res.message)throw new Error(this._res.message);return{id:this._res.generation_id||"cohere_"+Date.now(),object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.finish_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:this._res.text||""};return this._res.citations&&(e.citations=this._res.citations),this._res.documents&&(e.documents=this._res.documents),this._res.search_queries&&(e.search_queries=this._res.search_queries),this._res.search_results&&(e.search_results=this._res.search_results),e}_get_openai_finish_reason(e){return{COMPLETE:"stop",MAX_TOKENS:"length",ERROR:"error",STOP_SEQUENCE:"stop"}[e]||"stop"}_transform_usage_to_openai(){return!this._res.meta||!this._res.meta.billed_units?{prompt_tokens:null,completion_tokens:null,total_tokens:null}:{prompt_tokens:this._res.meta.billed_units.input_tokens||null,completion_tokens:this._res.meta.billed_units.output_tokens||null,total_tokens:(this._res.meta.billed_units.input_tokens||0)+(this._res.meta.billed_units.output_tokens||0)}}};var wy=class extends am{static{o(this,"CohereChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},M5={api_key:{name:"API Key",type:"password",description:"Enter your Cohere API key."}},u2={class:wy,settings_config:M5};var cm=class extends J{static{o(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return xy}get res_adapter(){return Ey}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_size||8192,description:n.description||n.name||n.id,raw:n};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},xy=class extends K{static{o(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Ey=class extends W{static{o(this,"SmartChatModelDeepseekResponseAdapter")}};var Ay=class extends cm{static{o(this,"DeepseekChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},z5={api_key:{name:"API Key",type:"password",description:"Enter your Deepseek API key."}},m2={class:Ay,settings_config:z5};var lm=class extends J{static{o(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Sy;res_adapter=Cy;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,n)=>{let i={model_name:n.name.split("/").pop(),id:n.name.split("/").pop(),max_input_tokens:n.inputTokenLimit,max_output_tokens:n.maxOutputTokens,description:n.description,multimodal:n.name.includes("vision")||n.description.includes("multimodal"),raw:n};return t[n.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Sy=class extends K{static{o(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let n of this.messages)n.role==="system"?t+=n.content+`
`:e.push({role:this._get_gemini_role(n.role),parts:this._transform_content_to_gemini(n.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let n=t.image_url.url.split(";")[0].split(":")[1];return n==="image/jpg"&&(n="image/jpeg"),{inline_data:{mime_type:n,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Cy=class extends W{static{o(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:ue(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},n=e.parts.find(i=>i.functionCall);return n&&(t.tool_calls=[{type:"function",function:{name:n.functionCall.name,arguments:JSON.stringify(n.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let n=JSON.parse(t),i;if(n.candidates?.[0]?.content?.parts?.[0]?.text?.length){let r=n.candidates[0].content.parts[0].text;i=r,this._res.candidates[0].content.parts[0].text+=r}return n.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=n.candidates[0].content.role),n.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=n.candidates[0].finishReason),n.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...n.promptFeedback}),n.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...n.usageMetadata}),n.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=n.candidates[0].content.parts[0].functionCall.name,n.candidates[0].content.parts[0].functionCall.args&&Object.entries(n.candidates[0].content.parts[0].functionCall.args).forEach(([r,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[r]||(this._res.candidates[0].content.parts[0].functionCall.args[r]=""),this._res.candidates[0].content.parts[0].functionCall.args[r]+=a})),i}};var Oy=class extends lm{static{o(this,"GoogleChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},D5={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."}},p2={class:Oy,settings_config:D5};var dm=class extends J{static{o(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return qy}get res_adapter(){return $y}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={model_name:n.id,id:n.id,max_input_tokens:n.context_window||8192,description:`Owned by: ${n.owned_by}, context: ${n.context_window}`,multimodal:n.id.includes("vision")};return t}},qy=class extends K{static{o(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},$y=class extends W{static{o(this,"SmartChatModelGroqResponseAdapter")}};var jy=class extends dm{static{o(this,"GroqChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},R5={api_key:{name:"API Key",type:"password",description:"Enter your Groq API key."}},h2={class:jy,settings_config:R5};var _m=class extends J{static{o(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Ty}get res_adapter(){return Ny}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let n of e.data)t[n.id]={id:n.id,model_name:n.id,description:`LM Studio model: ${n.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Ty=class extends K{static{o(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),n=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=n.messages[n.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),n.tool_choice="required"}else n.tool_choice&&typeof n.tool_choice=="object"&&(n.tool_choice="auto");return t.body=JSON.stringify(n),t}},Ny=class extends W{static{o(this,"SmartChatModelLmStudioResponseAdapter")}};var Py=class extends _m{static{o(this,"LmStudioChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},F5={},f2={class:Py,settings_config:F5};var um=class extends J{static{o(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=Iy;res_adapter=Ly;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let n=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let r of n.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:r.name})})).json();i.push({...c,name:r.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,n)=>{if(n.name.includes("embed"))return t;let i={model_name:n.name,id:n.name,multimodal:!1,max_input_tokens:Object.entries(n.model_info).find(r=>r[0].includes(".context_length"))[1]};return t[n.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},Iy=class extends K{static{o(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},n=this._extract_images_from_content(e.content);return n.length>0&&(t.images=n.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},Ly=class extends W{static{o(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:ue(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let n=e.message.content;t=n,this._res.message.content+=n}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var My=class extends um{static{o(this,"OllamaChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},B5={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},g2={class:My,settings_config:B5};var zy=class extends Ki{static{o(this,"OpenAIChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},U5={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},openai_note:{name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."}},y2={class:zy,settings_config:U5};var mm=class extends J{static{o(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return K}get res_adapter(){return W}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((n,i)=>{let r=i.id||i.name;return n[r]={id:r,model_name:r,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},n},{})}};var Dy=class extends mm{static{o(this,"XaiChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},W5={api_key:{name:"API Key",type:"password",description:"Enter your xAI API key."}},b2={class:Dy,settings_config:W5};var v2={collections:{embedding_models:{providers:{gemini:o2,lm_studio:r2,ollama:a2,open_router:c2,openai:l2}},chat_completion_models:{providers:{anthropic:d2,azure:_2,cohere:u2,deepseek:m2,google:p2,groq:h2,lm_studio:f2,ollama:g2,open_router:f_,openai:y2,xai:b2}}},modals:{context_selector:{default_suggest_action_keys:["context_suggest_blocks","context_suggest_folders","context_suggest_links","context_suggest_tags"]}}};var Yi=require("obsidian");async function Ry(s){let e=s.plugin?.app||window.app,t=Mu(e),n=(typeof localStorage<"u"?localStorage.getItem(t+"token"):"")||"";if(!n){console.warn("[smart_plugins] No OAuth token found; skipping Smart Plugins auto\u2011update."),pm("Smart Plugins: connect your Smart Plugins account to keep using Pro plugins.");let i=t+"auth_misses",r=parseInt(localStorage.getItem(i)||"0",10);return localStorage.setItem(i,(r+1).toString()),{updated:[],skipped:[],checked:0}}try{let i=await J5(e);console.log("[smart_plugins] Built installed plugins map:",i);let r=await zu(n);console.log("[smart_plugins] Fetched server plugin list:",r);let a=Array.isArray(r.list)?r.list:[],c=Array.isArray(r.unauthorized)?r.unauthorized:[],l=r.sub_exp,d=typeof l=="number"&&l<Date.now(),_=[],u=[],p=[];if(d){if(c.length){console.log("[smart_plugins] Subscription expired; handling unauthorized plugins.",{unauthorized_list:c});for(let b of c){if(!i[b.plugin_id]){p.push(b.plugin_id);continue}if(b.core_repo)await G5(e,b)&&u.push(b.plugin_id);else{await V5(e,b.plugin_id)&&_.push(b.plugin_id);continue}}}let v={updated:[],skipped:[],checked:0,removed:_,replaced:u,not_installed:p,unauthorized_count:c.length,sub_exp:l||null};return console.log({update_result:v}),v}let f=a.length,y=[];for(let v of a){if(!v||!v.repo)continue;let b=v.version||"unknown",A=(v.manifest_id||v.repo.replace("/","_")).trim(),S=i[A];!S||!S.version||Iu(S.version,b)&&y.push({item:v,plugin_id:A,local_version:S.version,server_version:b})}if(!y.length)return{updated:[],skipped:[],checked:f};let g=[],k=[];for(let v of y){let{item:b,plugin_id:A,local_version:S,server_version:$}=v;try{let j=await Lu(b.repo,n),{files:C,pluginManifest:x}=await qa(j),m=x.id,h=`${e.vault.configDir}/plugins/${m}`;await $a(e.vault.adapter,h,C),g.push(`${b.repo}@${$}`)}catch(j){console.error("[smart_plugins] Failed to auto\u2011update plugin:",{repo:b.repo,plugin_id:A,local_version:S,server_version:$,error:j}),k.push(b.repo)}}if(g.length){let v=g.length===1?"":"s";pm(`Smart Plugins: updated ${g.length} plugin${v}. Please restart Obsidian to apply updates.`)}else k.length||pm("Smart Plugins: no updates applied.");return{updated:g,skipped:k,checked:f}}catch(i){return console.error("[smart_plugins] update_installed_smart_plugins error:",i),pm("Smart Plugins: failed to check for updates. See console for details."),{updated:[],skipped:[],checked:0}}}o(Ry,"update_installed_smart_plugins");async function G5(s,e){let t=await(0,Yi.requestUrl)({url:`https://api.github.com/repos/${e.core_repo}/releases/latest`,method:"GET"}),n=t?.json||{};if(!(n?.tag_name||null))return console.error("[smart_plugins] Failed to get latest core plugin version from GitHub:",{core_repo:e.core_repo,response:t}),null;try{let r=n?.assets?.find(u=>u.name.endsWith(".zip"))?.browser_download_url||null;if(!r)return console.error("[smart_plugins] Failed to find core plugin zip asset in GitHub release:",{core_repo:e.core_repo,release:n}),null;let a=await H5(r),{files:c,pluginManifest:l}=await qa(a),d=e.plugin_id,_=`${s.vault.configDir}/plugins/${d}`;return await $a(s.vault.adapter,_,c),!0}catch(r){return console.error("[smart_plugins] Failed to install core plugin:",{core_repo:e.core_repo,error:r}),null}}o(G5,"replace_pro_with_core");async function H5(s){console.log(`[smart_plugins] download plugin from URL: ${s}`);let e=await(0,Yi.requestUrl)({url:s,method:"GET",headers:{Accept:"application/zip"}});if(e.status&&e.status!==200)throw new Error(`Download error ${e.status}: ${e.text||""}`);return Pu(e.arrayBuffer,"Download")}o(H5,"fetch_zip_from_public_url");async function J5(s){let e={},t=s.plugins;if(!t)return e;await t.loadManifests();let n=t.manifests||{};for(let i in n){if(!Object.prototype.hasOwnProperty.call(n,i))continue;let r=n[i]||{};e[i]={id:r.id||i,name:r.name||i,version:r.version||""}}return e}o(J5,"build_installed_plugins_map");function pm(s){try{typeof Yi.Notice=="function"?new Yi.Notice(s):console.log("[smart_plugins]",s)}catch(e){console.log("[smart_plugins] notice error",e,s)}}o(pm,"show_notice");async function V5(s,e){let t=s?.vault?.adapter;if(!t)return!1;let n=`${s.vault.configDir}/plugins/${e}`,i=`${n}/main.js`,r=`${n}/manifest.json`;try{return await t.exists(i)&&await t.remove(i),await t.exists(r)&&await t.remove(r),!0}catch(a){console.error("[smart_plugins] Failed to remove main.js for unauthorized plugin",{plugin_id:e,error:a})}return!1}o(V5,"remove_main_js_for_plugin");var Xi=class s extends Vi{static{o(this,"SmartEnv")}static version="2.3.11";is_pro=!0;async load(e=!1){await super.load(e),s.wait_for({loaded:!0}).then(async()=>{console.warn("[smart_env] Checking for Smart Plugins updates..."),Ry(this),this._registered_refresh_event||(this._registered_refresh_event=!0,this.events.on("pro_plugins:refresh",async()=>{console.warn("[smart_env] Refreshing Smart Plugins list..."),Ry(this)}))})}},Z8e=Xi.version;var k2=Nt(aS,v2);var Y5={modules:{smart_rank_model:{class:kl,adapters:{cohere:Wn},http_adapter:new Ge({adapter:Yo,obsidian_request_url:Fy.requestUrl})}}},hm=class extends Ko{static{o(this,"SmartConnectionsPlugin")}SmartEnv=Xi;get smart_env_config(){if(!this._smart_env_config){let e=super.smart_env_config;qt(e,k2),qt(e,o0),qt(e,Y5),this._smart_env_config=e}return this._smart_env_config}async initialize(){await this.remove_deprecated_plugin_if_present(),eA(this),cA(this),await super.initialize?.(),console.log("Loading Smart Connections Early Release plugin..."),this.registerEditorExtension(ix),this.registerEditorExtension(V1(this)),this.connections_footer_view=new n_(this),this.app.workspace.onLayoutReady(()=>{this.toggled_inline_connections()}),this.toggled_footer_connections(),this.register_env_event_listeners(),console.log("Smart Connections Early Release plugin loaded."),dA(this),uA(this)}get oauth_storage_prefix(){if(!this._oauth_storage_prefix){let e=this.app.vault.getName();this._oauth_storage_prefix=D1(e)}return this._oauth_storage_prefix}get_smart_plugins_token(){let{token:e}=z1(this.oauth_storage_prefix);return e||""}async remove_deprecated_plugin_if_present(){let e="smart-connections-early-release";try{let t=this.app.plugins;t.enabledPlugins?.has(e)&&await t.disablePlugin(e);let i=`${String(this.app.vault.configDir||"").replace(/\/$/,"")}/plugins/${e}`;await this.app.vault.adapter.exists(i)&&(await this.app.vault.adapter.rmdir(i,!0),await t.loadManifests())}catch(t){console.warn("Smart Connections Early Release: failed to clean up deprecated plugin",t)}}get commands(){return{...super.commands,toggle_inline_connections:{id:"toggle-inline-connections",name:"Toggle: Inline connections",callback:o(()=>{let e=this.env.connections_lists.settings;e.inline_connections=!e.inline_connections},"callback")},toggle_footer_connections:{id:"toggle-footer-connections",name:"Toggle: Footer connections",callback:o(()=>{let e=this.env.connections_lists.settings;e.footer_connections=!e.footer_connections},"callback")}}}register_code_blocks(){super.register_code_blocks?.(),this.registerMarkdownCodeBlockProcessor("smart-connections-web",this.render_web_code_block.bind(this)),this.registerMarkdownCodeBlockProcessor("connections",(e,t,n)=>{new i_(this).render(e,t,n)})}register_env_event_listeners(){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on("settings:changed",e=>{e.path?.includes("inline_connections")&&this.toggled_inline_connections()})),this.env_listeners.push(this.env.events.on("settings:changed",e=>{e.path?.includes("footer_connections")&&this.toggled_footer_connections()}))}onunload(){console.log("Unloading Smart Connections Early Release plugin..."),this.env_listeners.forEach(e=>e()),this.connections_footer_view?.unload(),super.onunload?.()}get_editor_view(){if(!this.app.workspace.getActiveFile())return console.log("Smart Connections: No active file found"),null;let t=this.app.workspace.getActiveFileView();return t?t.editor?.cm||null:(console.log("Smart Connections: No active file view found"),null)}toggled_inline_connections(){this.app.workspace.getLeavesOfType("markdown").map(e=>e.view?.editor?.cm).filter(Boolean).forEach(e=>{e.plugin(hf)?.refresh()})}toggled_footer_connections(){this.get_editor_view()&&this.env.connections_lists.settings.footer_connections?this.connections_footer_view.render_view():this.connections_footer_view.remove()}async render_web_code_block(e,t,n){t.empty(),t.createEl("span",{text:"Loading\u2026"}),await this.SmartEnv.wait_for({loaded:!0});let i=[],r={};if(e.trim().length){let l=e.split(`
`).map(d=>d.trim()).filter(d=>d.length);for(let d of l){if(d.startsWith("include:")){let _=d.replace("include:","").trim();_&&(r.key_includes_any=_.split(",").map(u=>u.trim()));continue}if(d.startsWith("does not end with:")){let _=d.replace("does not end with:","").trim();_&&(r.exclude_key_ends_with_any=_.split(",").map(u=>u.trim()));continue}if(d.startsWith("limit:")){let _=d.replace("limit:","").trim();_&&(r.limit=parseInt(_));continue}i.push(d)}}if(i.length){e=i.join(`
`);let l=await this.env.render_component("lookup",this.env.smart_sources,{attribution:this.attribution,query:e,filter:r});t.empty(),t.appendChild(l);return}let a=this.env.smart_sources.get(n.sourcePath)??this.env.smart_sources.init_file_path(n.sourcePath);if(!a){t.empty(),t.createEl("p",{text:"Entity not found: "+n.sourcePath});return}let c=await this.env.render_component("connections_web",a,{attribution:this.attribution,filter:r});t.empty(),t.appendChild(c)}async check_for_update(){let e="brianpetro/smart-connections-obsidian-early";try{let t=this.get_smart_plugins_token();if(!t){console.log("Smart Connections Early Release: skipping update check (no Smart Plugins token)");return}let n=await(0,Fy.requestUrl)({url:`${e_()}/plugin_version`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({repo:e})});if(n.status!==200)throw new Error(`plugin_version responded with status ${n.status}`);let i=n.json?.version;if(!oA(this.manifest.version,i))return;this.env?.events?.emit("plugin:new_version_available",{version:i}),this.notices?.show("new_version_available",{version:i}),this.update_available=!0}catch(t){console.error("Smart Connections Early Release: failed to check for update",t)}}};

const smart_hash_id='b2733ca5b6f933e6d9270fdb1236c755672735a5f45434f868109ef5865bd421';