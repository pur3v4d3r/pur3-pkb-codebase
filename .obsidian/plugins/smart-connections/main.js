/*! smart-connections-early-release v4.2.6 | (c) 2026 ðŸŒ´ Brian */
var w2=Object.create;var Xi=Object.defineProperty;var x2=Object.getOwnPropertyDescriptor;var E2=Object.getOwnPropertyNames;var S2=Object.getPrototypeOf,A2=Object.prototype.hasOwnProperty;var r=(n,e)=>Xi(n,"name",{value:e,configurable:!0});var Ca=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),C2=(n,e)=>{for(var t in e)Xi(n,t,{get:e[t],enumerable:!0})},$y=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of E2(e))!A2.call(n,i)&&i!==t&&Xi(n,i,{get:()=>e[i],enumerable:!(s=x2(e,i))||s.enumerable});return n};var Y=(n,e,t)=>(t=n!=null?w2(S2(n)):{},$y(e||!n||!n.__esModule?Xi(t,"default",{value:n,enumerable:!0}):t,n)),q2=n=>$y(Xi({},"__esModule",{value:!0}),n);var ob=Ca(lc=>{"use strict";lc.byteLength=rq;lc.toByteArray=cq;lc.fromByteArray=_q;var it=[],Ce=[],oq=typeof Uint8Array<"u"?Uint8Array:Array,wm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(xs=0,nb=wm.length;xs<nb;++xs)it[xs]=wm[xs],Ce[wm.charCodeAt(xs)]=xs;var xs,nb;Ce[45]=62;Ce[95]=63;function ib(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(ib,"getLens");function rq(n){var e=ib(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(rq,"byteLength");function aq(n,e,t){return(e+t)*3/4-t}r(aq,"_byteLength");function cq(n){var e,t=ib(n),s=t[0],i=t[1],o=new oq(aq(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Ce[n.charCodeAt(l)]<<18|Ce[n.charCodeAt(l+1)]<<12|Ce[n.charCodeAt(l+2)]<<6|Ce[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Ce[n.charCodeAt(l)]<<2|Ce[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Ce[n.charCodeAt(l)]<<10|Ce[n.charCodeAt(l+1)]<<4|Ce[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(cq,"toByteArray");function lq(n){return it[n>>18&63]+it[n>>12&63]+it[n>>6&63]+it[n&63]}r(lq,"tripletToBase64");function dq(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(lq(s));return i.join("")}r(dq,"encodeChunk");function _q(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(dq(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(it[e>>2]+it[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(it[e>>10]+it[e>>4&63]+it[e<<2&63]+"=")),i.join("")}r(_q,"fromByteArray")});var Gx=Ca(id=>{"use strict";id.byteLength=iN;id.toByteArray=rN;id.fromByteArray=lN;var ut=[],je=[],nN=typeof Uint8Array<"u"?Uint8Array:Array,lh="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(zs=0,Ux=lh.length;zs<Ux;++zs)ut[zs]=lh[zs],je[lh.charCodeAt(zs)]=zs;var zs,Ux;je[45]=62;je[95]=63;function Wx(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(Wx,"getLens");function iN(n){var e=Wx(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(iN,"byteLength");function oN(n,e,t){return(e+t)*3/4-t}r(oN,"_byteLength");function rN(n){var e,t=Wx(n),s=t[0],i=t[1],o=new nN(oN(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=je[n.charCodeAt(l)]<<18|je[n.charCodeAt(l+1)]<<12|je[n.charCodeAt(l+2)]<<6|je[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=je[n.charCodeAt(l)]<<2|je[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=je[n.charCodeAt(l)]<<10|je[n.charCodeAt(l+1)]<<4|je[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(rN,"toByteArray");function aN(n){return ut[n>>18&63]+ut[n>>12&63]+ut[n>>6&63]+ut[n&63]}r(aN,"tripletToBase64");function cN(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(aN(s));return i.join("")}r(cN,"encodeChunk");function lN(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(cN(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(ut[e>>2]+ut[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(ut[e>>10]+ut[e>>4&63]+ut[e<<2&63]+"=")),i.join("")}r(lN,"fromByteArray")});var OS=Ca(Q_=>{"use strict";Q_.byteLength=IL;Q_.toByteArray=LL;Q_.fromByteArray=RL;var bt=[],Pe=[],PL=typeof Uint8Array<"u"?Uint8Array:Array,Gf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Qs=0,CS=Gf.length;Qs<CS;++Qs)bt[Qs]=Gf[Qs],Pe[Gf.charCodeAt(Qs)]=Qs;var Qs,CS;Pe[45]=62;Pe[95]=63;function qS(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(qS,"getLens");function IL(n){var e=qS(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(IL,"byteLength");function ML(n,e,t){return(e+t)*3/4-t}r(ML,"_byteLength");function LL(n){var e,t=qS(n),s=t[0],i=t[1],o=new PL(ML(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Pe[n.charCodeAt(l)]<<18|Pe[n.charCodeAt(l+1)]<<12|Pe[n.charCodeAt(l+2)]<<6|Pe[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Pe[n.charCodeAt(l)]<<2|Pe[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Pe[n.charCodeAt(l)]<<10|Pe[n.charCodeAt(l+1)]<<4|Pe[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(LL,"toByteArray");function zL(n){return bt[n>>18&63]+bt[n>>12&63]+bt[n>>6&63]+bt[n&63]}r(zL,"tripletToBase64");function DL(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(zL(s));return i.join("")}r(DL,"encodeChunk");function RL(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(DL(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(bt[e>>2]+bt[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(bt[e>>10]+bt[e>>4&63]+bt[e<<2&63]+"=")),i.join("")}r(RL,"fromByteArray")});var JC=Ca(Uu=>{"use strict";Uu.byteLength=j3;Uu.toByteArray=N3;Uu.fromByteArray=M3;var xt=[],Ie=[],$3=typeof Uint8Array<"u"?Uint8Array:Array,Pg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(nn=0,GC=Pg.length;nn<GC;++nn)xt[nn]=Pg[nn],Ie[Pg.charCodeAt(nn)]=nn;var nn,GC;Ie[45]=62;Ie[95]=63;function HC(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(HC,"getLens");function j3(n){var e=HC(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(j3,"byteLength");function T3(n,e,t){return(e+t)*3/4-t}r(T3,"_byteLength");function N3(n){var e,t=HC(n),s=t[0],i=t[1],o=new $3(T3(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Ie[n.charCodeAt(l)]<<18|Ie[n.charCodeAt(l+1)]<<12|Ie[n.charCodeAt(l+2)]<<6|Ie[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Ie[n.charCodeAt(l)]<<2|Ie[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Ie[n.charCodeAt(l)]<<10|Ie[n.charCodeAt(l+1)]<<4|Ie[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(N3,"toByteArray");function P3(n){return xt[n>>18&63]+xt[n>>12&63]+xt[n>>6&63]+xt[n&63]}r(P3,"tripletToBase64");function I3(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(P3(s));return i.join("")}r(I3,"encodeChunk");function M3(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(I3(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(xt[e>>2]+xt[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(xt[e>>10]+xt[e>>4&63]+xt[e<<2&63]+"=")),i.join("")}r(M3,"fromByteArray")});var hD={};C2(hD,{default:()=>rm});module.exports=q2(hD);var xy=require("obsidian");var xp=Y(require("obsidian"),1);var Ut=require("obsidian");var qa=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var Oa=class extends qa{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var hs=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new Oa(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};async function O2(n,e={}){let t=Object.entries(n.settings_config).map(([o,a])=>(a.setting||(a.setting=o),this.render_setting_html(a))).join(`
`),s=Object.entries(n.collections).map(([o,a])=>`<div data-smart-settings="${o}"></div>`).join(`
`);return`
<div class="">
${t}
${s}
</div>
`}r(O2,"build_html");async function jy(n,e={}){let t=await O2.call(this,n,e),s=this.create_doc_fragment(t);return await $2.call(this,n,s,e)}r(jy,"render");async function $2(n,e,t={}){await this.render_setting_components(e,{scope:n});let s=e.querySelectorAll("[data-smart-settings]");for(let i of s){let o=i.dataset.smartSettings;await n[o].render_settings(i)}return e}r($2,"post_process");var $a=class{static{r(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let s=new this(e,t);return await s.load(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}static create_sync(e,t={}){let s=new this(e,t);return s.load_sync(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}get settings(){return j2(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",T2(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function j2(n,e){let t=new WeakMap,s=new WeakMap,i=r((a,c)=>{if(!lm(a)||s.has(a))return a;if(t.has(a))return t.get(a);let l=o(a,c);return t.set(a,l),s.set(l,a),l},"wrap_value"),o=r((a,c)=>new Proxy(a,{set(l,d,_){let u=[...c,d],p=cm(l[d]),f=cm(_);return l[d]=i(_,u),N2(p,f)&&e({type:"set",path:u,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],u=cm(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:u}),!0}}),"create_proxy");return i(n,[])}r(j2,"observe_object");function T2(n){let e=Array.isArray(n.path)?n.path:[];return{type:n.type,path:e,path_string:e.join("."),value:n.value,previous_value:n.previous_value}}r(T2,"build_settings_changed_event");function cm(n){if(!lm(n))return n;if(typeof structuredClone=="function")try{return structuredClone(n)}catch{}try{return JSON.parse(JSON.stringify(n))}catch{return n}}r(cm,"snapshot_value");function N2(n,e){return Ty(n)!==Ty(e)}r(N2,"has_changed");function Ty(n){if(n===void 0)return"undefined";if(Number.isNaN(n))return"number:NaN";if(n===1/0)return"number:Infinity";if(n===-1/0)return"number:-Infinity";if(!lm(n))return`${typeof n}:${String(n)}`;try{return`object:${JSON.stringify(n)}`}catch{return`object:${String(n)}`}}r(Ty,"serialize_value");function lm(n){return typeof n=="object"&&n!==null}r(lm,"is_observable");function et(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Ny(e[t])&&Ny(n[t])?et(n[t],e[t]):n[t]=e[t]);return n}r(et,"deep_merge");function Ny(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Ny,"is_plain_object");function be(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(be,"camel_case_to_snake_case");function Py(n){return n.collections||(n.collections={}),n.modules||(n.modules={}),n.items||(n.items={}),Object.entries(n.collections).forEach(([e,t])=>{typeof t=="function"&&(n.collections[e]={class:t});let s=be(e);s!==e&&(n.collections[s]=n.collections[e],delete n.collections[e]),n.collections[s].collection_key||(n.collections[s].collection_key=s),t.item_type&&(n.items[t.item_type.key||be(t.item_type.name)]={class:t.item_type})}),Object.entries(n.modules).forEach(([e,t])=>{typeof t=="function"&&(n.modules[e]={class:t});let s=be(e);s!==e&&(n.modules[s]=n.modules[e],delete n.modules[e])}),n.item_types||(n.item_types={}),n.items||(n.items={}),Object.entries(n.item_types).forEach(([e,t])=>{if(typeof t=="function"){let s=be(e);n.items[s]={class:t,actions:{},...n.items[s]||{}}}}),n}r(Py,"normalize_opts");function P2(n){if(!n||typeof n!="object")return!1;let e=Object.getPrototypeOf(n);return e===Object.prototype||e===null}r(P2,"is_plain_object");function ja(n){if(Array.isArray(n))return n.map(e=>ja(e));if(P2(n)){let e={};for(let[t,s]of Object.entries(n))e[t]=ja(s);return e}return n}r(ja,"deep_clone_config");function ln(n,e){let t=Iy(n),s=Iy(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(ln,"compare_versions");function Iy(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(Iy,"normalize_version_value");function Zi(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Zi,"is_plain_object");function St(n,e,t=[]){if(!Zi(n)||!Zi(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Zi(i)?(Zi(n[s])||(n[s]={}),St(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(St,"deep_merge_no_overwrite");function fs(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(ln(d,_)>0){let p={...c};St(p,l),n.collections[a]=p}else St(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;ln(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):St(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),St(n[i],o)):n[i]=o}return n}r(fs,"merge_env_config");function My(n={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:s}=n;return(e!==void 0||t!==void 0||s!==void 0)&&(n.smart_sources=n.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!n.smart_sources?.file_exclusions?.length||n.smart_sources?.file_exclusions==="Untitled")&&(n.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!n.smart_sources.folder_exclusions?.length&&(n.smart_sources.folder_exclusions=t),s!==void 0&&s.length&&!n.smart_sources.excluded_headings?.length&&(n.smart_sources.excluded_headings=s)),delete n.file_exclusions,delete n.folder_exclusions,delete n.excluded_headings,n}r(My,"migrate_exclusion_settings_2025_08_22");var I2=typeof globalThis<"u"?globalThis:Function("return this")(),Qi=class{static{r(this,"SmartEnv")}static version="2.2.8";scope_name="smart_env";static global_ref=I2;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=hs.create(this,L2(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([s])=>this.primary_main_key&&s===this.primary_main_key?-1:0);for(let[s,i]of t){if(!i?.main){console.warn(`SmartEnv: '${s}' unloaded, skipping`),delete this.smart_env_configs[s];continue}if(!i?.opts){console.warn(`SmartEnv: '${s}' opts missing, skipping`);continue}fs(this._config,ja(Py(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:s}=t||{};if(s)for(let[i,o]of Object.entries(s.collections||{})){let a=o?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:ln(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,M2(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let s=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(s),t(this.global_env))},1e3)}else{let s=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(s),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let s={};this.global_env&&ln(this.version,this.global_env.constructor?.version||0)>0&&(s.primary_main_key=be(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(s);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let s=be(e.constructor.name);this.smart_env_configs[s]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:r(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await $a.create(this),this.config.default_settings&&St(this.settings,this.config.default_settings),My(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:s}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let s=e.collections[t]?.class;s&&(s.default_settings&&St(this.settings,{[t]:s.default_settings}),typeof s.init=="function"&&(await s.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((s,i)=>{let o=this.config.collections?.[s]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return o-a});for(let s of t){let i=Date.now();typeof this[s]?.process_load_queue=="function"&&(await this[s].process_load_queue(),this[s].load_time_ms=Date.now()-i,this.collections[s]="loaded",console.log(`Loaded ${this[s].collection_key} in ${this[s].load_time_ms}ms`))}}static unload_main(e){let t=be(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let s=this.opts.modules[e];return s?(t={...s,class:null,...t},new s.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||jy}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,s={}){let i=this.get_component(e,t);return i?await i(t,s):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let s=t.collection_key??t.scope_name,i=s?`${s}-${e}`:e;if(!this._components[i])try{if(this.opts.components[s]?.[e]){let o=this.opts.components[s][e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let o=this.opts.components[e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${s}`)}catch(o){console.error("Error getting component",o),console.log(`scope_name: ${s}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[s]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.config.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(s=>s.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let s=e.map(i=>{let o=i.split("/").slice(-2,-1)[0];return{dir:o,count:this.fs.file_paths.filter(a=>a.includes(o)).length}});t=s.reduce((i,o)=>o.count>i.count?o:i,s[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(et(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(s=>s.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((s,i,o)=>o.indexOf(s)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function M2(n){return{items:Object.fromEntries(Object.entries(n.items||{}).map(([e,t])=>[e,t.data]))}}r(M2,"collection_to_plain");function L2(n){if(!n)return{};if(typeof n=="function")return{adapter_class:n};let e=n.adapter_class||n.adapter;return e?{adapter_class:e}:{}}r(L2,"build_events_opts");function z2(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=R2(n,t),o=D2(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(z2,"create_regex");function D2(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(D2,"adjust_for_windows_paths");function R2(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(R2,"glob_to_regex_pattern");function Ly(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:z2(n,s)}r(Ly,"glob_to_regex");function zy(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(zy,"fuzzy_search");var Ta=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(Ly(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return zy(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var F2=Y(require("obsidian"),1);var Na=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=F2,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function Pa(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(Pa,"empty");var Dy=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var Ry=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var B2=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,Ia=r((n,e)=>{let t=e.trim();(B2.test(t)?Ry:Dy)(n,t)},"safe_inner_html");function Le(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(Le,"escape_html");function Fy(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=dn(l,o),l=dm(l,15),l=dn(l,a),i^=l,i=dm(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=dn(l,o),l=dm(l,15),l=dn(l,a),i^=l;break}return i^=n.length,i=U2(i),i|0}r(Fy,"murmur_hash_32");function te(n,e=0){return(Fy(n,e)>>>0).toString(36)}r(te,"murmur_hash_32_alphanumeric");function dn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(dn,"multiply_32");function dm(n,e){return n<<e|n>>>32-e}r(dm,"rotate_left_32");function U2(n){return n^=n>>>16,n=dn(n,2246822507),n^=n>>>13,n=dn(n,3266489909),n^=n>>>16,n|0}r(U2,"fmix_32");function _m(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(_m,"convert_to_time_ago");function gs(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(gs,"cos_sim");function Se(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(Se,"get_by_path");function Ae(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(Ae,"set_by_path");function um(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(um,"delete_by_path");function mm(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(mm,"compute_centroid");function pm(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);s[a]+=u,s[l]+=u}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(pm,"compute_medoid");var Ma=new WeakMap,La=new WeakMap,za=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return Se(e,t,s)}set_by_path(e,t,s,i=null){Ae(e,t,s,i)}delete_by_path(e,t,s=null){um(e,t,s)}escape_html(e){return Le(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||La.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");La.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=La.get(i);c&&(i.removeEventListener("change",c),La.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=te(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){Pa(e)}safe_inner_html(e,t){Ia(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=Ma.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},Ma.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}Ma.get(e)===c&&Ma.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var Da=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===s,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((b,g)=>{let k=document.createElement("div");k.className="array-item-row";let v=document.createElement("input");v.type="text",v.value=b,v.placeholder="Value";let y=document.createElement("button");y.textContent="\u2715",y.title="Remove",v.addEventListener("change",()=>{c[g]=v.value,f()}),y.addEventListener("click",()=>{c.splice(g,1),d(),f()}),k.appendChild(v),k.appendChild(y),l.appendChild(k)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let b=u.value.trim();b&&(c.push(b),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,k],v)=>{let y=document.createElement("div");y.className="json-pair-row";let S=document.createElement("input");S.type="text",S.value=g,S.placeholder="Property";let A=document.createElement("input");A.type="text",A.value=k,A.placeholder="Value";let $=document.createElement("button");$.textContent="\u2715",$.title="Remove",S.addEventListener("change",()=>{let j=S.value.trim();j&&j!==g&&(c[j]=c[g],delete c[g],d(),b())}),A.addEventListener("change",()=>{c[S.value]=A.value,b()}),$.addEventListener("click",()=>{delete c[S.value],d(),b()}),y.appendChild(S),y.appendChild(A),y.appendChild($),l.appendChild(y)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),b())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let b=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){Pa(e)}safe_inner_html(e,t){Ia(e,t)}};var tt=require("obsidian");var Ra=class extends Da{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return tt.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new tt.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await tt.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,tt.getIcon)(e).outerHTML}is_mod_event(e){return tt.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function Fa(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Fa,"collection_instance_name_from");function By(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(By,"create_uid");function Ba(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Ba(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Ba(n[o],e[o],t))}return n===e}r(Ba,"deep_equal");function Ua(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(Ua,"get_item_display_name");function Wa(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let q=Object.getOwnPropertyDescriptor(m,w);if(!q)continue;let E={...q};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let q of h){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E){let O=E.value;if(c(O)){w=!0;continue}if(s(O)){if(_(O)){w=!0;continue}return!1}if(typeof O>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),w=new Map;for(let q of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E&&_(E.value)){w.set(q,d(E.value));continue}try{Object.defineProperty(h,q,u(E))}catch{h[q]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:b}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=r((m,h,w=[])=>{if(!m||!h)return;let q=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(q.has(E))continue;let O=Object.getOwnPropertyDescriptor(m,E);if(O)try{Object.defineProperty(h,E,O)}catch{h[E]=O.value}}},"copy_metadata"),y=r(m=>{let h=new m(n),w=h.action||h.run||h.execute||h.call;if(i(w)){let q=w.bind(h);return v(m,q),v(h,q),q.instance=h,q}return v(m,h),h},"instantiate_class"),S=r(m=>{if(o(m))return y(m);if(a(m)){let h=m.action.bind(n);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return v(m,h),h}return s(m)?d(m):m},"bind_or_clone"),A=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=b.get(m);return h&&s(h)?h:null},"scope_actions_for"),$=r((m,h,w)=>(m[h]=w,w),"cache_result"),j=r((m,h)=>{let w=A();return w&&g(w,h)?$(m,h,S(w[h])):g(f,h)?$(m,h,S(f[h])):$(m,h,void 0)},"compute_and_cache"),C=r(()=>{let m=A(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let w=A();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:r(()=>C(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return x(m,h);let w=A();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:r((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(Wa,"create_actions_proxy");var se=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&et(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return By(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return et(s,t),!Ba(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:b}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||b&&!b.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Wa(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Fa(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Fa(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),be(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Ua(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var W2=Object.getPrototypeOf(async function(){}).constructor,ne=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof W2?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return et(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Wa(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var Ga=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},Ha=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function Ja(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=Uy(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=Uy(n.results);n.min=s,n.minResult=i}}r(Ja,"results_acc");function Gy(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=Wy(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=Wy(n.results);n.max=s,n.maxResult=i}}r(Gy,"furthest_acc");function Uy(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(Uy,"find_min");function Wy(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(Wy,"find_max");function ze(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(ze,"sort_by_score");function Va(n,e){return ze(n,e)}r(Va,"sort_by_score_descending");function Hy(n,e){return ze(n,e)*-1}r(Hy,"sort_by_score_ascending");var Ka=class extends Ga{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:gs(e,a.vec)};return Ja(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(Va)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:gs(e,a.vec)};return Gy(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(Hy)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},Ya=class extends Ha{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var G2="---frontmatter---",Jy=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),H2=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),J2=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),V2=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(G2),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),K2=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=Jy(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=Jy(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),hm=r((n,e={})=>{let t=H2(n,e),s=J2(t),i=V2(s);return K2(i,n)},"create_find_connections_filter_opts");async function _n(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=hm(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+te(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(ze).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(_n,"find_connections");_n.action_type="connections";var ys=class extends se{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new Ya(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var bs=class extends ne{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Ka(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(ze).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return Vy}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return Y2}},Vy={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},Y2={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function fm(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await _n.call(this,n);let o=hm(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+te(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(ze).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(ze).slice(0,s)}return i}r(fm,"find_connections");fm.action_type="connections";var un=class extends ys{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=mm(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=pm(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},Ky={class:un,actions:{find_connections:fm}};var eo=class extends bs{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(ze)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(X2),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},X2={};var Xa=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=to;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},to=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Za=class extends Xa{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=so;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},so=class extends to{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var Yy={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Lt=class extends Za{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=At;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},At=class extends so{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+u]=d,delete o[l]);let f=this.env[_];if(!f)continue;let b=f.get(u);if(d.key||(d.key=u),b)b.data=d,b._queue_load=!1,b.loaded_at=Date.now();else{let g=f.item_type,k=new g(this.env,d);k._queue_load=!1,k.loaded_at=Date.now(),f.set(k)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return Yy[s]&&(s=Yy[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var no=class extends Lt{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=gm},gm=class extends At{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var Qa=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return te(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return Xy(this.constructor.name)}static get adapter_key(){return Xy(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function Xy(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(Xy,"to_snake");function ec(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},b=null,g=null,k=!1,v=!1,y="#",S=!1,A=[],$=null;_[y]=0;for(let C=0;C<i.length;C++){let x=C+t,m=i[C],h=m.trim();if(h==="---"){if(!v&&x===1){v=!0,k=!0,l["#---frontmatter---"]=[x,null];continue}else if(k){k=!1,l["#---frontmatter---"][1]=x;continue}}if(k)continue;if(!S&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(x)),h.startsWith("```")){if(S=!S,S&&!$?$=x:!S&&$&&(A.push([$,x]),$=null),!g){let E=c.length>0?c[c.length-1].key:y;if(E===y&&!l[y]&&(l[y]=[x,null]),E===y)g={key:y,start_line:x},(l[y][1]===null||l[y][1]<x)&&(l[y][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let O=_[E],N=`${E}#{${O}}`;l[N]=[x,null],g={key:N,start_line:x}}}continue}let w=h.match(/^(#{1,6})\s*(.+)$/);if(w&&!S){let E=w[1].length,O=w[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=x-1)}c.length===0&&l[y]&&l[y][1]===null&&(l[y][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null);let N="",M=0;if(c.length>0?(N=c[c.length-1].key,M=c[c.length-1].level):(N="",M=0),c.length===0)d[O]=(d[O]||0)+1,d[O]>1&&(O+=`[${d[O]}]`);else{u[N]||(u[N]={}),u[N][O]=(u[N][O]||0)+1;let X=u[N][O];X>1&&(O+=`#{${X}}`)}let ue=E-M,ge="#".repeat(ue),ye=N+ge+O;l[ye]=[x,null],_[ye]=0,c.push({level:E,title:O,key:ye});continue}let q=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(q&&!S){if(q[1].length===0){b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null),g&&g.key!==y&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let O=c.length>0?c[c.length-1].key:y;O===y&&!l[y]&&(l[y]=[x,null]),_[O]===void 0&&(_[O]=0),_[O]+=1;let N=_[O],M;if(s){let ue=q[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=Z2(ue,o);M=`${O}#${ge}`}else M=`${O}#{${N}}`;l[M]=[x,null],b={key:M,start_line:x};continue}if(b)continue}if(h!==""&&!g){b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null);let E=c.length>0?c[c.length-1].key:y;if(E===y)l[y]||(l[y]=[x,null]),(l[y][1]===null||l[y][1]<x)&&(l[y][1]=null),g={key:y,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let O=_[E],N=`${E}#{${O}}`;l[N]=[x,null],g={key:N,start_line:x}}}}let j=i.length;for(;c.length>0;){let C=c.pop();l[C.key][1]===null&&(l[C.key][1]=j+t-1)}b&&(l[b.key][1]===null&&(l[b.key][1]=j+t-1),b=null),g&&(l[g.key][1]===null&&(l[g.key][1]=j+t-1),g=null),l[y]&&l[y][1]===null&&(l[y][1]=j+t-1);for(let C in l)a[C]=l[C];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:A}}r(ec,"parse_markdown_blocks");function Z2(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(Z2,"get_longest_words_in_order");var st=class extends Qa{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=ec(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);s==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:u,state:"new",content:p});continue}let f,b=l.split("#"),g;for(;!f&&b.length>0;)b.pop(),g=b.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let k=this.item.block_collection.get(u);if(await this.create_hash(p)!==k.last_read?.hash){o.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function zt(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,u=o(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(zt,"get_markdown_links");function tc({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=zt(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(tc,"get_bases_cache_links");function ym(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(ym,"parse_value");function Q2(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=ym(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(ym(u)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=ym(c)}return t}r(Q2,"parse_yaml_block");function Zy(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=Q2(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(Zy,"parse_frontmatter");var Qy=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var io=class extends st{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=zt(e),s=tc({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=Zy(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),Qy(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Dt=require("obsidian");function eq(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(eq,"merge_tags");var vs=class extends io{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=eq(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!Dt.MarkdownRenderer||!Dt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Dt.MarkdownRenderer.render(s,t,i,this.item.path,new Dt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Dt.htmlToMarkdown)(i)}};var sc=class extends st{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var nc=class extends st{static{r(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function tq({content:n}={}){if(!n)return null;try{return JSON.parse(n)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}r(tq,"parse_canvas_json");function eb({target:n,title:e}={}){return n?{title:e||n,target:n,line:1}:null}r(eb,"build_link_record");function sq({node:n}={}){if(!n||typeof n!="object")return[];if(n.type==="text"&&typeof n.text=="string")return zt(n.text);if(n.type==="file"&&typeof n.file=="string"){let e=typeof n.subpath=="string"?n.subpath:"",t=`${n.file}${e}`,s=eb({target:t,title:n.file});return s?[s]:[]}if(n.type==="link"&&typeof n.url=="string"){let e=eb({target:n.url,title:n.url});return e?[e]:[]}return[]}r(sq,"get_canvas_node_links");function nq({nodes:n=[]}={}){return Array.isArray(n)?n.reduce((e,t)=>(e.push(...sq({node:t})),e),[]):[]}r(nq,"get_canvas_links_from_nodes");function iq({content:n}={}){let e=tq({content:n});return e?.nodes?nq({nodes:e.nodes}):[]}r(iq,"get_canvas_links");var ic=class extends st{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=iq({content:e});let t=this.item.file?.stat,s=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:s,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var oc=class extends vs{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function tb(n,e){let[t,...s]=n.split("#").filter(Boolean),i=Ua(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(tb,"get_block_display_name");var mn=class extends ys{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return tb(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},sb={class:mn,actions:{find_connections:_n}};var oo=class extends bs{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var rc=class extends Lt{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=bm;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},bm=class extends At{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var ac=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return te(e)}};function cc(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(cc,"get_line_range");var pn=class extends ac{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return cc(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var hn=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var ro=class extends hn{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var fn=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var ks=class extends fn{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var nt=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var gn=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},yn=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var bn=class extends gn{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new vm(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},vm=class extends yn{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var ws=class extends gn{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new km(i)}},km=class extends yn{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var rb=Y(ob(),1);var uq=Object.defineProperty,mq=r((n,e,t)=>e in n?uq(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),pq=r((n,e,t)=>(mq(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function hq(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(hq,"bytePairMerge");function fq(n,e){return n.length===1?[e.get(n.join(","))]:hq(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(fq,"bytePairEncode");function gq(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(gq,"escapeRegex");var xm=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=rb.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=xm.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=xm.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??n.length;for(let f of n.substring(l,u).matchAll(s)){let b=this.textEncoder.encode(f[0]),g=this.rankMap.get(b.join(","));if(g!=null){o.push(g);continue}o.push(...fq(b,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},dc=xm;pq(dc,"specialTokenRegex",n=>new RegExp(n.map(e=>gq(e)).join("|"),"g"));async function cb(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await ab(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await ab(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(cb,"fetch_json_cached");async function ab(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(ab,"do_fetch");function Sm(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(Sm):e==="object"?Object.values(n).every(Sm):!1}r(Sm,"is_json_compatible");function _c(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||Sm(i)&&(t[s]=i);return t}r(_c,"extract_json_details");function ao(n){return Object.keys(n).length===0}r(ao,"is_empty_object");function yq(n,e){return ao(n)?e:ao(e)?n:{...n,...e}}r(yq,"merge_details");function Em(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(Em,"get_message_from_object");function Z(n,e=null){if(Array.isArray(n)&&n.length>0)return Z(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=_c(n,["message"]);return{message:t,details:ao(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=Em(o),c=_c(o,["message"]),l=_c(t,["message","error"]),d=yq(l,c);return{message:a||Em(t)||"Unknown error",details:ao(d)?null:d,http_status:e}}return Z(i)}let s=Em(t);if(s){let i=_c(t,["message"]);return{message:s,details:ao(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(Z,"normalize_error");var bq="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",ot=class extends ks{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return De}get res_adapter(){return Re}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new nt({adapter:ws})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:Z(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await cb(bq,"cl100k_base.json");this.tiktoken=new dc(e)}},De=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Re=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var uc=class extends ot{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Am}get res_adapter(){return Cm}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Am=class extends De{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Cm=class extends Re{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var mc=class extends ks{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var pc=class extends mc{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var lb=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var db={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:qm};var qm={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},_b={},Om={};var vn=class extends pc{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=db;constructor(e){super(e),this.connector=lb.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,..._b}}get_models(){return Promise.resolve(this.models)}get models(){return qm}};var hc=class extends ot{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return $m}get res_adapter(){return jm}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of kq(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},$m=class extends De{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},jm=class extends Re{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},vq=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),kq=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(vq)},"filter_embedding_models");var fc=class extends ot{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Tm}get res_adapter(){return Nm}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},Tm=class extends De{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Nm=class extends Re{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function wq(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(wq,"parse_lm_studio_models");var gc=class extends ot{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Pm}get res_adapter(){return Im}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return wq(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},Pm=class extends De{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Im=class extends Re{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var co=class extends hn{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw Z(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var yc=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var bc=class extends fn{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var kn={},Rt={data:null,fetched_at:0},R=class extends bc{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return F}get res_adapter(){return L}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new nt({adapter:ws})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Rt.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=Z(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new yc(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=Z({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=Z(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=Z(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Rt?.data&&t-Rt?.fetched_at<e)return Rt.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Rt.data=o,Rt.fetched_at=t,console.log({MODELS_DEV_CACHE:Rt}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Rt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return kn[this.constructor.key]||(kn[this.constructor.key]={}),kn[this.constructor.key]}set model_data(e){kn[this.constructor.key]||(kn[this.constructor.key]={}),kn[this.constructor.key]=e}},F=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},L=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var lo=class extends R{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return _o}res_adapter=uo;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},_o=class extends F{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},uo=class extends L{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var xq=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Es=class extends R{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Mm;parse_model_data(e){return e.data.filter(t=>!xq.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:Eq(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function Eq(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(Eq,"get_max_input_tokens");var Mm=class extends L{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var mo=class extends Es{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var wn=class extends R{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=po;res_adapter=ho;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},po=class extends F{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},ho=class extends L{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:Z(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},fo=class extends wn{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var go=class extends R{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Lm}get res_adapter(){return zm}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Lm=class extends F{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},zm=class extends L{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var yo=class extends R{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return bo}get res_adapter(){return vo}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},bo=class extends F{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},vo=class extends L{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var ko=class extends R{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=wo;res_adapter=xo;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},wo=class extends F{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},xo=class extends L{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:Z(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Dm={openai:{req:F,res:L},anthropic:{req:_o,res:uo},gemini:{req:po,res:ho},lm_studio:{req:bo,res:vo},ollama:{req:wo,res:xo}},Eo=class extends R{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Dm[e];return t&&t.req?t.req:F}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Dm[e];return t&&t.res?t.res:L}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(Dm).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var So=class extends R{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Rm}get res_adapter(){return Fm}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},Rm=class extends F{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Fm=class extends L{static{r(this,"SmartChatModelGroqResponseAdapter")}};var Ao=class extends R{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return F}get res_adapter(){return L}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var Co=class extends R{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Bm}get res_adapter(){return Um}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Bm=class extends F{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Um=class extends L{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var mp=require("obsidian");function ub(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=ec(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),u=cc(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=zt(u),f=tc({source:n,links:p}),b={key:d,lines:l,size:u.length,outlinks:[...p,...f],last_read:{at:a,hash:te(u)}};if(!_||_?.data.last_read?.hash!==b.last_read.hash){let g=new n.block_collection.item_type(n.env,b);n.block_collection.set(g)}else _.data={..._.data,...b}}Sq(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(ub,"parse_blocks");function Sq(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(Sq,"clean_and_update_source_blocks");function Wm(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():mb(a)?n[o]=Wm(mb(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(Wm,"ajson_merge");function mb(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(mb,"is_object");var pb={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function Aq(n){let e=!1,[t,...s]=n.split(":");return pb[t]&&(t=pb[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(Aq,"_parse_ajson_key");var Ft=class extends Lt{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:b,item_key:g,changed:k}=Aq(p),v=`${b}:${g}`;f?(i[v]=f,(k||v!==p)&&(delete i[p],t=!0)):(delete i[v],(k||v!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=Wm(f.data,l);else{let b=p.item_type;f=new b(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Gm=class extends At{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},qo={collection:Ft,item:Gm};var Oo=class extends se{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function Cq(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(Cq,"parse_component_properties");async function qq(n,e){let{scope_key:t,component_key:s}=Cq(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await te(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(qq,"build_component_data");var vc=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await qq(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var kc=class extends vc{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function hb(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&hb(i,o,t)}}),t}r(hb,"flatten_components_config");var wc=class extends ne{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=hb(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},fb={class:wc,item_type:Oo,data_adapter:qo,component_adapters:{SmartViewComponentAdapter:kc}};var gb=fb;function yb(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(yb,"filter_redundant_context_items");var bb=r((n,e)=>!e||!n?.[e]?!1:n[e].folder?n[e].exclude?!1:(n[e].exclude=!0,!0):(delete n[e],!0),"remove_context_item_data"),$o=class extends se{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:s=!0}=t;bb(this.data.context_items,e)&&(this.queue_save(),s&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:s=!0}=t,i=Array.isArray(e)?e:[e],o=[];return i.forEach(a=>{bb(this.data.context_items,a)&&o.push(a)}),o.length?(this.queue_save(),s&&this.emit_event("context:updated",{removed_keys:o}),o):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return yb(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var xc=class extends ne{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var Oq={class:xc,data_adapter:Ft,item_type:$o};var vb=Oq;var Ec=class extends se{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var rt=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var Sc=class extends rt{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var Ac=class extends rt{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var kb=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var Cc=class extends rt{static{r(this,"ImageContextItemAdapter")}static detect(e){return kb.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var qc=class extends rt{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var Hm=class extends ne{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},wb={version:1,class:Hm,collection_key:"context_items",item_type:Ec,context_item_adapters:{BlockContextItemAdapter:Sc,SourceContextItemAdapter:Ac,ImageContextItemAdapter:Cc,PdfContextItemAdapter:qc}};function xb(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(xb,"next_log_stats");var xn=class extends se{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var $q={"collection:save_started":!0,"collection:save_completed":!0},Jm=class extends ne{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return xn}init(){this.env?.events||hs.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!$q[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new xn(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=xb({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},Eb={class:Jm,collection_key:"event_logs",data_adapter:Ft,item_type:xn};var En=require("obsidian");function Sb(n,e={}){if(!n)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],s=n?.env?.config?.actions||{},i=n?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(s[c]||{}).display_name||c;return a.push({select_action:r(()=>{n.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}r(Sb,"build_suggest_scope_items");var Ab=r((n,e={})=>{let t=n?.inputEl,s=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(s===t&&i)},"should_handle_arrow_left");var Oc=class extends En.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,o=Ab(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&o){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return Sb(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,En.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=En.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var e9=require("obsidian");var $c=class extends Oc{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var Cb=require("obsidian");var jc=class extends Cb.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var Nc=require("obsidian");var jq="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",Tc=class extends Nc.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){Tq(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function Tq(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),Nq(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(jq,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r(Tq,"render_milestones_modal_title");function Nq(n){Pq(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(Nq,"render_help_icon");function Pq(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,Nc.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(Pq,"set_icon_with_fallback");var qb={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var jo=class extends se{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var Pc=class extends ne{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function Ob(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(Ob,"settings_config");var Ss=class extends jo{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Vm=class extends Pc{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var Iq={class:Vm,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:qo,item_type:Ss,providers:{},settings_config:Ob},Km=Iq;var Ym=class extends vn{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},$b={class:Ym,settings_config:Om};Km.providers={transformers:$b};var jb=Km;var Bt=class extends se{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(Ja(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(Va);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};function Tb(n){return{type:"heading",name:`${n}`}}r(Tb,"create_settings_section_heading");var Nb={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},Xm=class extends ne{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=Mq(new Date),i=te(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new Bt(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...Nb}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function Mq(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(Mq,"format_ymd");var Pb={class:Xm,collection_key:"lookup_lists",item_type:Bt,settings_config:Nb};function To(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(To,"format_collection_name");async function Lq(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${To(n.collection_key)}</h2>
${t}
</div></div></div>`}r(Lq,"build_html");async function Ib(n,e={}){let t=await Lq.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(Ib,"render");var Sn=require("obsidian");function Mb(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(Sn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new Sn.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");Sn.MarkdownRenderer.render(o,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(Mb,"register_block_hover_popover");var Lb=require("obsidian");function Ic(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),Lb.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):Mb(n.parentElement,n,e.env,e.key)}r(Ic,"register_item_hover_popover");var Db=require("obsidian");function zq(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(zq,"format_score");function Dq(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(Dq,"format_size");function zb(n,e){return n?`<span class="${e}">${n}</span>`:""}r(zb,"build_badge_html");function Rq(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=zq(n?.data?.score),i=Dq(n?.size||n?.data?.size),o=zb(s,"sc-context-item-score"),a=zb(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(Rq,"build_html");async function Rb(n,e={}){let t=Rq(n,e),i=this.create_doc_fragment(t).firstElementChild;return Fq.call(this,n,i,e),i}r(Rb,"render");async function Fq(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${Db.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),Ic(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(Fq,"post_process");async function Bq(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${To(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=Wq(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(Bq,"build_html");async function Fb(n,e={}){let t=await Bq.call(this,n,e),s=this.create_doc_fragment(t);return await Uq.call(this,n,s,e)}r(Fb,"render");async function Uq(n,e,t={}){return e}r(Uq,"post_process");function Wq(n,e){let t=Object.values(n.items).length,s=To(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=Gq(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=Hq(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(Wq,"generate_collection_stats");function Gq(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(Gq,"get_generic_collection_stats");function Hq(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(Hq,"calculate_embed_coverage");var Bb=require("obsidian");function Jq(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(Jq,"build_html");async function Zm(n,e={}){let t=Jq.call(this,n,e),s=this.create_doc_fragment(t);return await Vq.call(this,n,s,e)}r(Zm,"render");async function Vq(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new Bb.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Se(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),o.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):Ae(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(Vq,"post_process");Zm.version=.2;var Ub=require("obsidian");function Kq(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(Kq,"build_html");function Wb(n,e={}){let t=Kq.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,Ub.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),Yq.call(this,n,i,e),i}r(Wb,"render");function Yq(n,e){}r(Yq,"post_process");var Gb=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var Yb=require("obsidian");var Hb=require("obsidian");var Zq={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},An={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},Qq=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function Qm(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=Qq.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(Qm,"derive_events_checklist_groups");function No(n,e){let t=eO(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(No,"check_if_event_emitted");function eO(n,e){let t=Zq[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!tO(a)))return!0}return!1}r(eO,"resolve_plugin_install_event");function tO(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r(tO,"is_pro_manifest");function Jb(n){n.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in An){let s=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",o=document.createElement("p");o.textContent=i,s.appendChild(o);let a=document.createElement("p");a.textContent=`\u2705 ${An[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",s.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{n.open_milestones_modal()}),s.appendChild(c),new Hb.Notice(s,7e3)}})}r(Jb,"register_first_of_event_notifications");function sO(n,e={}){let t=Qm(An),s=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(No(n,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(No(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=No(n,u.event_key)===!0;return iO(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Le(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Le(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Le(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(sO,"build_html");async function Xb(n,e={}){this.apply_style_sheet(Gb);let t=sO.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return nO.call(this,n,i,e),i}r(Xb,"render");async function nO(n,e,t={}){return oO(e),rO(e),e}r(nO,"post_process");function iO(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Le(n.event_key)}"
data-link="${Le(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${Le(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Le(n.milestone)}</span>
</div>
</li>
`}r(iO,"build_item_html");function oO(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=Kb(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||Vb(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=Kb(n,e);s&&(e.preventDefault(),Vb(s))}))}r(oO,"attach_item_link_listeners");function Vb(n){let e=lO(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(Vb,"open_item_link");function rO(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&aO(i,s)})}r(rO,"render_item_state_icons");function aO(n,e){cO(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(aO,"set_item_icon");function cO(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,Yb.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(cO,"set_icon_with_fallback");function Kb(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(Kb,"get_item_el_from_event");function lO(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=An[t];return!s||typeof s.link!="string"?"":s.link}r(lO,"get_item_link");function dO(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}r(dO,"build_html");var ep=100,tp=100;function _O(n,e={}){let{limit:t=ep}=e;return n.slice(-t).reverse()}r(_O,"get_visible_entries");function uO(n,e={}){let{page_size:t=ep}=e;return Math.min(n,t)}r(uO,"get_visible_count");function mO(n,e={}){let{current_count:t=0,step_size:s=tp}=e;return Math.min(n,t+s)}r(mO,"get_next_visible_count");function pO(n,e){return n>e}r(pO,"should_show_load_more");async function Zb(n,e={}){let t=this.create_doc_fragment(dO()),s=t.firstElementChild;return hO.call(this,n,s,e),t}r(Zb,"render");async function hO(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),o=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(s);let c=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!c.length){let _=s.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",s.appendChild(_),o&&(o.style.display="none");return}let l=uO(c.length,{page_size:ep}),d=r(()=>{a.empty(s),_O(c,{limit:l}).forEach(_=>{yO(s,_)}),fO(o,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=s.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),o&&o.addEventListener("click",()=>{l=mO(c.length,{current_count:l,step_size:tp}),d()})}r(hO,"post_process");function fO(n,e={}){if(!n)return;let{entries_length:t=0,visible_count:s=0}=e,i=pO(t,s);if(n.style.display=i?"inline-block":"none",i){let o=t-s,a=Math.min(tp,o);n.textContent=`Load ${a} more`}}r(fO,"update_load_more_button");function gO(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(gO,"get_level");function yO(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=gO(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${bO(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(yO,"append_entry");function bO(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(bO,"to_time_ago");var Fe=require("obsidian");var Cn=require("obsidian");function qn(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(qn,"get_smart_server_url");function vO(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(vO,"try_get_zlib");function kO(n){let e=vO();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(kO,"inflate_deflate_data");async function Qb(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let b=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let k=new Uint8Array(n.slice(t,t+b)),v=new TextDecoder("utf-8").decode(k);t+=b,t+=g;let y=(l&8)!==0,S=t,A;if(!y)A=S+p;else{let C=S,x=!1;for(;C+4<=s;){let m=e.getUint32(C,!0);if(m===134695760||m===67324752||m===33639248){x=!0;break}C++}A=x?C:s}if(A>s)break;let $=new Uint8Array(n.slice(S,A));if(t=A,y&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let j;if(d===0)j=$;else if(d===8)j=kO($);else continue;if(i.push({fileName:v,data:j}),v.toLowerCase().endsWith("manifest.json")&&!v.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(j))}catch{}}return{files:i,pluginManifest:o}}r(Qb,"parse_zip_into_files");function ev(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(ev,"validate_zip_buffer");async function tv(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(tv,"write_files_with_adapter");function sv(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(sv,"is_server_version_newer");async function nv(n,e){let t=await(0,Cn.requestUrl)({url:`${qn()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return ev(t.arrayBuffer,"Smart Plugins server")}r(nv,"fetch_plugin_zip");async function iv(n,e=Cn.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return ev(t.arrayBuffer,"Download")}r(iv,"fetch_zip_from_url");async function ov(n,e,t=Cn.requestUrl){let s=await t({url:`${qn()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(ov,"fetch_plugin_readme");async function rv(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(rv,"enable_plugin");function av(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(av,"get_oauth_storage_prefix");async function cv(n){let e=await(0,Cn.requestUrl)({url:`${qn()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(cv,"fetch_server_plugin_list");async function lv(n={}){let e=String(n.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,Cn.requestUrl)({url:`${qn()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}r(lv,"fetch_referral_stats");var dv=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var xO='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',EO='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function SO(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(SO,"derive_fallback_plugins");function AO(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${xO}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${EO}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}r(AO,"build_html");async function uv(n,e={}){this.apply_style_sheet(dv);let t=AO.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await CO.call(this,n,i,e),i}r(uv,"render");async function CO(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=av(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=SO(),_=0,u="",p=null,f=r(C=>{if(C){if(typeof this.empty=="function"){this.empty(C);return}C.innerHTML=""}},"empty_container"),b=r(C=>{if(!a||!C)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let m=document.createElement("div");m.classList.add("smart-plugins-login-manual-controls"),p.appendChild(m);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=C,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),m.appendChild(h);let w=document.createElement("button");w.classList.add("mod-cta"),w.textContent="Copy",w.addEventListener("click",async()=>{await _v(C)?new Fe.Notice("Copied login link to clipboard."):new Fe.Notice("Copy failed. Please select and copy the link manually.")}),m.appendChild(w)},"render_manual_login_link"),g=r(async()=>{let C={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(m=>setTimeout(m,100));for(let m in x){if(!Object.prototype.hasOwnProperty.call(x,m))continue;let{name:h,version:w}=x[m];C[m]={name:h,version:w}}return C},"get_installed_info"),k=r(async()=>{_++,_>=2&&u&&b(u),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(u=qO()),new Fe.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),v=r(()=>{if(this.empty(a),p=null,!(localStorage.getItem(o+"token")||"")){new Fe.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await k()})});return}let x=new Fe.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(m=>{m.setButtonText("Logout"),m.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new Fe.Notice("Logged out of Smart Plugins"),v(),y(),$()})})},"render_oauth_login_section"),y=r(async(C={})=>{f(c);let x=String(C.token||"").trim();if(!x)return;let m=Number(C.sub_exp??0)||0;if(!(m&&m<Date.now()))try{let h=await lv({token:x}),w=String(h?.referral_link||"").trim();if(!w)return;let q=new Fe.Setting(c).setName("Referral link").setDesc("Share your link to give $30 off Pro and earn 30 days of Pro credit.");q.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let O=await _v(w);new Fe.Notice(O?"Referral link copied.":"Copy failed. Please try again.")})}),q.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),S=r(async()=>{if(this.empty(l),!(!l||d.length===0))for(let C of d){let x=await n.smart_components.render_component("pro_plugins_list_item",C,{env:n,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),A=r(()=>{let C=new Fe.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");C.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),C.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),C.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),$=r(async()=>{this.empty(l);let C=localStorage.getItem(o+"token")||"";if(!C){await S(),await y();return}try{let x=await g(),m=await cv(C),{list:h=[],unauthorized:w=[],sub_exp:q}=m;if(typeof q=="number"&&q<Date.now()){A(),await S(),await y();return}if(await y({token:C,sub_exp:q}),!Array.isArray(h)||h.length===0){await S();return}for(let E of h){let O=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,token:C,installed_map:x,on_installed:$});l.appendChild(O)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),j=r(async()=>{v(),await $()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{j()}),await j(),e}r(CO,"post_process");function qO(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${qn()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(qO,"initiate_smart_plugins_oauth");var _v=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var pe=require("obsidian");var OO="https://smartconnections.app/pro-plugins/";function $O(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r($O,"build_html");function jO(n){return!n||!n.repo}r(jO,"is_fallback_item");function TO(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,sv(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(TO,"compute_display_state");async function mv(n,e={}){let t=$O(n,e),i=this.create_doc_fragment(t).firstElementChild;return await NO.call(this,n,i,e),i}r(mv,"render");async function NO(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(jO(n)){let u=new pe.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(OO,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=TO(n,l),_=new pe.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>IO(n,{app:s,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),n.docs_url?u.onClick(()=>window.open(n.docs_url,"_external")):u.onClick(()=>MO(n,{app:s,token:i,display_name:d.display_name}))}),e}r(NO,"post_process");var PO=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return iv(t);if(!e)throw new Error("Login required to install this plugin.");return nv(n.repo,e)},"download_plugin_zip"),IO=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new pe.Notice(`Installing "${n.repo}" ...`);let o=await PO(n,s),{files:a,pluginManifest:c}=await Qb(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await tv(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await rv(t,_),new pe.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new pe.Notice(`Install failed: ${o.message}`)}},"install_plugin"),MO=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await ov(n.repo,s),a=new pe.Modal(t);a.setTitle(i||n.name||n.repo),await pe.MarkdownRenderer.render(t,o,a.contentEl,"",new pe.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new pe.Notice("Failed to load README")}},"show_plugin_readme");var pv=require("obsidian");var As=class extends pv.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var hv=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var fv=require("obsidian");function zO(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${yv(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(zO,"build_html");async function gv(n,e){this.apply_style_sheet(hv);let s=this.create_doc_fragment(zO.call(this,n,e)).firstElementChild;return DO.call(this,n,s,e),s}r(gv,"render");async function DO(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,fv.setIcon)(o,yv(n)),s.addEventListener("click",()=>{new As(n).open()}),i.addEventListener("click",()=>{new As(n,{test_on_open:!0}).open()}),e}r(DO,"post_process");function yv(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(yv,"get_test_result_icon_name");var vv=require("obsidian");var bv={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function Mc(n,e,t={}){let s=(bv[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new vv.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new As(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(Mc,"show_new_model_menu");var $n=require("obsidian");function RO(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(RO,"ensure_settings_config");function sp(n,e,t){let s=RO(n,e);return Object.entries(s||{}).reduce((i,[o,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][o]=a,i},{[t]:{}})}r(sp,"build_settings_group_map");function np(n,e,t,s){return sp(n,e,s)[t]||{}}r(np,"resolve_group_settings_config");var Lc=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new $n.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function Cs(n,e,t,s={}){let{default_group_name:i="Settings"}=s,o=n,a=sp(n,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),u={...s,...s.group_params?.[l]||{},settings_config_source:o};return ip(l,e,d,_,u)})}r(Cs,"render_settings_config");function ip(n,e,t,s,i={}){let o=i.settings_config_source||t,a=i.settings_config_source?np(o,e,n,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=Lc}catch{c=Lc}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,b,g,k)=>{let v=np(b,f,p,k.default_group_name||"Settings");return ip(p,f,v,g,k)}:ip,_=FO(e,{container:s,group_name:n,settings_config:o,group_params:i,render_group:d}),u=new c(s);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)kv(u,e,p);else kv(u,e,l);u.setHeading(n);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let b=f.scope_class==="pro-setting",g=!!e.env?.is_pro;u.addSetting(k=>{switch(f.name&&k.setName(f.name),k.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&k.setClass(`setting-type-${f.type}`),f.description&&k.setDesc(f.description),f.type){case"button":k.addButton(v=>{v.setButtonText(f.name||"Run"),v.onClick(async y=>{typeof f.callback=="function"&&await On(k,y,f.callback,{scope:e})})});break;case"toggle":k.addToggle(v=>{v.setValue(Se(e.settings,p)||!1),v.onChange(y=>{Ae(e.settings,p,y),typeof f.callback=="function"&&On(k,y,f.callback,{scope:e})})});break;case"text":k.addText(v=>{v.setValue(String(Se(e.settings,p)||"")),v.onChange(y=>{Ae(e.settings,p,y)})});break;case"number":k.addText(v=>{v.setValue(String(Se(e.settings,p)??"0")),v.inputEl.setAttribute("type","number"),v.onChange(y=>{let S=Number(y);isNaN(S)||Ae(e.settings,p,S),typeof f.callback=="function"&&On(k,S,f.callback,{scope:e})})});break;case"dropdown":k.addDropdown(v=>{let y=f.options_callback;typeof y=="function"&&y.call(e,e).forEach(A=>{let $=A.label||A.name||A.value;v.addOption(A.value,$)}),v.setValue(Se(e.settings,p)||""),v.onChange(S=>{Ae(e.settings,p,S),typeof f.callback=="function"&&On(k,S,f.callback,{scope:e}),_()})});break;case"textarea":k.addTextArea(v=>{v.setValue(String(Se(e.settings,p)||"")),v.onChange(y=>{if(b&&!g){new $n.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}Ae(e.settings,p,y)}),b&&!g&&v.setDisabled(!0)});break;case"slider":k.addSlider(v=>{let y=f.min||0,S=f.max||100,A=f.step||1;v.setLimits(y,S,A),v.setValue(Se(e.settings,p)||y),v.setDynamicTooltip(),v.onChange($=>{Ae(e.settings,p,$),typeof f.callback=="function"&&On(k,$,f.callback,{scope:e})})});break;case"heading":k.setHeading();break;case"html":f.value&&k.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&k.settingEl.addClass(f.scope_class)})}return u}r(ip,"render_settings_group");function kv(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,$n.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await On(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(kv,"render_heading_button");async function On(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(On,"handle_config_callback");function FO(n,e={}){let{container:t,group_name:s,settings_config:i,group_params:o={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(s,n,i,t,o))}r(FO,"create_settings_group_rerender");function BO(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(BO,"build_html");async function wv(n,e){let s=this.create_doc_fragment(BO.call(this,n,e)).firstElementChild;return UO.call(this,n,s,e),s}r(wv,"render");async function UO(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=Cs(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{Mc(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(UO,"post_process");function WO(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(WO,"build_html");async function xv(n,e){let s=this.create_doc_fragment(WO(n,e)).firstElementChild;return GO.call(this,n,s,e),s}r(xv,"render");async function GO(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(GO,"post_process");var Av=require("obsidian");function zc(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(zc,"ensure_smart_sources_settings");function Po(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(Po,"parse_exclusions_csv");function Ev(n,e){let t=(e??"").trim();if(!t)return n||"";let s=Po(n);return s.includes(t)||s.push(t),s.join(",")}r(Ev,"add_exclusion");function Sv(n,e){let t=(e??"").trim();return t?Po(n).filter(i=>i!==t).join(","):n?.trim()||""}r(Sv,"remove_exclusion");var Dc=class extends Av.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=zc(this.env),t=Po(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=zc(this.env);t.folder_exclusions=Ev(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=zc(this.env),t=Po(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=Sv(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var Cv=require("obsidian");var Rc=class extends Cv.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function HO(n,e={}){return`
<div class="sources-settings">
</div>
`}r(HO,"build_html");async function qv(n,e={}){let t=await HO.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return JO.call(this,n,i,e),i}r(qv,"render");async function JO(n,e,t={}){Cs({folder_exclusions:KO,view_exclusions:YO,re_import_sources:XO},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",VO(n,e))),this.attach_disposer(e,i),e}r(JO,"post_process");function VO(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(VO,"highlight_reset_data");var KO={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new Dc(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},YO={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new Rc(t.main.app,t).open()},"callback")},XO={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};function ZO(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(ZO,"build_html");async function Ov(n,e={}){let s=this.create_doc_fragment(ZO(n,e)).firstElementChild;return QO.call(this,n,s,e),s}r(Ov,"render");async function QO(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),Mc(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(QO,"post_process");async function e$(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(e$,"build_html");async function $v(n,e={}){let t=await e$.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return t$.call(this,n,i,e),i}r($v,"render");async function t$(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(t$,"post_process");var jv=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function n$(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(n$,"build_html");async function Tv(n,e={}){this.apply_style_sheet(jv);let t=await n$.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return i$.call(this,n,i,e),i}r(Tv,"render");async function i$(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return op.call(this,"settings_env_sources",n,i),op.call(this,"settings_env_models",n,s),op.call(this,"settings_notifications",n,o),e}r(i$,"post_process");function op(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(op,"render_if_available");var Nv=require("obsidian");function o$(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(o$,"build_html");async function Pv(n,e={}){let t=o$(),i=this.create_doc_fragment(t).firstElementChild;return r$.call(this,n,i,e),i}r(Pv,"render");async function r$(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),a$(n,a),c$(n,a),l$(n,a),d$(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(r$,"post_process");function a$(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(a$,"render_btn_open_selector");function c$(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(c$,"render_btn_copy_context");function l$(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(l$,"render_btn_clear_context");function d$(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,Nv.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(d$,"render_btn_help");var Iv=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var Io=require("obsidian");async function at(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(Io.Platform.isMobile)new Io.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new Io.Notice("Failed to copy.")}}r(at,"copy_to_clipboard");var u$=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),m$=r(n=>{let e=!1;return()=>{e||(e=!0,u$(async()=>{e=!1,await n()}))}},"create_render_scheduler");function p$(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(p$,"build_html");async function Mv(n,e={}){let t=p$(n,e);this.apply_style_sheet(Iv);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return h$.call(this,n,i,e),i}r(Mv,"render");async function h$(n,e,t={}){let s=[],i=r(async()=>{let d=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(p=>{this.empty(_),_.appendChild(p)});let u=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(p=>{this.empty(u),u.appendChild(p)})},"render_children"),o=m$(i),a=n.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,u)=>d.addEventListener(_,u)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(u=>u.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=f$(e);await at(p)})),_.showAtMouseEvent(d)}),await i(),s.push(n.on_event("context:updated",o)),this.attach_disposer(e,s),e}r(h$,"post_process");function f$(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(f$,"tree_dom_to_wikilinks");function g$(n){return Math.ceil((n||0)/4)}r(g$,"estimate_tokens");function y$(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(y$,"build_html");async function Lv(n,e={}){let t=y$(),i=this.create_doc_fragment(t).firstElementChild;return b$.call(this,n,i,e),i}r(Lv,"render");async function b$(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=g$(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(b$,"post_process");function zv(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-context-item-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let u=["sc-tree-label"];return n.exists===!1&&u.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${l}
<span class="${u.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(zv,"build_tree_item");function Dv(n){let e=v$(n),t=new Set(n.map(i=>i.key||i.path));return Rv(e,t)}r(Dv,"build_tree_html");function v$(n=[]){let e=r(a=>a?.key||a?.path||"","get_item_key"),t=r(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,u=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),u=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),u=!0);let b=[];if(l){let g="",k=!1;for(let v=0;v<l.length;v++)!k&&l.slice(v,v+2)==="[["?(k=!0,g+="[[",v++):k&&l.slice(v,v+2)==="]]"?(k=!1,g+="]]",v++):!k&&l[v]==="/"?(b.push(g),g=""):g+=l[v];g&&b.push(g)}return _&&b.push(_),d&&b.push(d),{segments:b,has_block:u}},"split_path_segments"),s={name:"",children:{},selected:!1},i=r((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),o=n.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of n){let c=e(a),l=a?.exists;if(!c||i(c,o.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),u=s,p="";d.forEach((f,b)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=b===d.length-1,k=g&&_;u.children[f]||(u.children[f]={name:f,path:k?c:p,children:k?[]:{},selected:!1,is_file:k||g&&f.includes(".")}),u=u.children[f],g&&(u.selected=!0,u.exists=l)})}return s}r(v$,"build_path_tree");function Rv(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>zv(s,e,Rv(s,e))).join("")}</ul>`}r(Rv,"tree_to_html");var Fv=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var w$=r((n,e)=>!n||!e?!1:n===e||n.startsWith(`${e}/`)?!0:n.startsWith(`${e}#`),"is_nested_context_item");function Bv(n,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(n?.data?.context_items||{}).filter(o=>w$(o,t));return[...new Set(i)]}r(Bv,"get_nested_context_item_keys");var x$=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),E$=r(n=>{let e=!1;return()=>{e||(e=!0,x$(()=>{e=!1,n()}))}},"create_render_scheduler"),S$=r((n,e={})=>{let{target_path:t}=e,s=Bv(n,{target_path:t});n.remove_items(s)},"remove_nested_context_items");function A$(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(A$,"build_html");async function Uv(n,e={}){this.apply_style_sheet(Fv);let t=A$(n,e),i=this.create_doc_fragment(t).firstElementChild;return C$.call(this,n,i,e),i}r(Uv,"render");async function C$(n,e,t={}){let s=n?.env?.plugin,i=s?.registerDomEvent?.bind(s)||((l,d,_)=>l.addEventListener(d,_)),o=r(()=>{let l=n.env,d=n.context_items.filter(t.filter),_=Dv(d),u=this.create_doc_fragment(_);this.empty(e),e.appendChild(u);for(let p=0;p<d.length;p++){let f=d[p],b=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!b){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(b),b.appendChild(g)})}},"render_tree_leaves"),a=E$(o);o(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");S$(n,{target_path:_})});let c=[];return c.push(n.on_event("context:updated",a)),this.attach_disposer(e,c),e}r(C$,"post_process");var Wv=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function O$(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(O$,"build_html");async function Gv(n,e={}){let t=O$(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(Wv),await $$.call(this,n,s,e),s}r(Gv,"render");async function $$(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let u=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let b=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',k=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',v="",y="";try{let A=await p.read();v=A.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),y=(await p.get_embed_input(A)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(A){console.error("[source_inspector] Error reading block:",A),v='<em style="color:red;">Error reading block content</em>'}let S=this.create_doc_fragment(`
<p>
${b}<br>
${g} | ${k}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${y}</pre>
</details>
<blockquote>${v}</blockquote>
<hr>
`);s.appendChild(S)}return e}r($$,"post_process");var Yv=require("obsidian");var jn=require("obsidian");var Hv=require("obsidian");var Fc=class extends Hv.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var Jv=require("obsidian");var Bc=class extends Jv.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function Vv(n,e,t={}){let{Menu:s=jn.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new jn.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new jn.Notice("Active note is not indexed by Smart Environment");return}new Fc(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Bc(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new jn.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(Vv,"register_status_bar_context_menu");var Kv=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function T$(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(T$,"build_html");async function Xv(n,e={}){this.apply_style_sheet(Kv);let s=this.create_doc_fragment(T$()).firstElementChild;return N$.call(this,n,s,e),s}r(Xv,"render");function N$(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),b=`Smart Env${a?" "+a:""}`,g="Smart Environment status",k=c(),v=n.event_logs?.notification_status||"info";f>0&&(b=`Embed now (${f})`,g="Click to re-import.",v="attention"),s&&(0,Yv.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=y=>{y.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),k>0?i.dataset.count=String(k):delete i.dataset.count,v?i.dataset.level=String(v):delete i.dataset.level),o.setText?.(b),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=y=>{if(l()>0)y.preventDefault(),y.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let A=new MouseEvent("contextmenu",y);e.dispatchEvent?.(A)}},e.addEventListener("click",e._click_handler))},"render_status_elm");Vv(n,e),d();let _=null,u=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",u)),this.attach_disposer(e,p)}r(N$,"post_process");var Zv=require("obsidian");function P$(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(P$,"build_html");function Qv(n,e={}){let t=P$.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return I$.call(this,n,i,e),i}r(Qv,"render");async function I$(n,e){let t=e.querySelector(".callout-icon"),s=(0,Zv.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(I$,"post_process");var ek=require("obsidian");function M$(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(M$,"build_html");function tk(n,e={}){let t=M$.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,ek.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),L$.call(this,n,i,e),i}r(tk,"render");function L$(n,e){}r(L$,"post_process");var rp=require("obsidian");async function sk(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new rp.Notice("No context items to copy.");let t=await this.get_text(n);await at(t);let s=z$({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new rp.Notice(s)}r(sk,"copy_to_clipboard");function z$(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${D$(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=R$(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(z$,"format_stats_message");function D$(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(D$,"format_char_count");function R$(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(R$,"sum_exclusions");var F$="xml_structured",Wc={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},nk=r((n={})=>{let e=n.template_preset||F$;return Wc[e]?e:"custom"},"get_preset_key"),Uc=r((n,e,t,s)=>{let i=nk(n),o=Wc[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function Gc(){return Object.entries(Wc).map(([n,e])=>({value:n,label:e.label||n}))}r(Gc,"get_template_preset_options");function ik(n={},e={}){return{template_before:Uc(n,e,"context_template_before","template_before"),template_after:Uc(n,e,"context_template_after","template_after")}}r(ik,"get_context_templates");function ok(n={},e={}){let t=nk(n),s=Wc[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:Uc(n,e,"item_template_before","template_before"),template_after:Uc(n,e,"item_template_after","template_after")}}r(ok,"get_item_templates");var B$=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),U$=r(n=>B$(n.key),"get_item_name");async function rk(n,e={}){let t={KEY:this.key,ITEM_NAME:U$(this),TIME_AGO:_m(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(u,p)=>t[p]||"");return c},"replace_vars"),i=ok(this.settings,ap);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(rk,"merge_template");var ak={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>Gc(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},ap={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Tn(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=W$(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Hc(e),ck(e).trimEnd()}r(Tn,"build_file_tree_string");function W$(n){return typeof n=="string"&&n.endsWith("/")}r(W$,"is_folder_path");function Hc(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Hc(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Hc(n[i])}else Hc(t)}}}r(Hc,"compress_single_child_dirs");function ck(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=ck(o,e+(c?"    ":"\u2502   ")))}),t}r(ck,"build_tree_string");async function lk(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>Tn(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(u,p)=>s[p]?.()||"");return l},"replace_vars"),o=ik(this.settings,cp),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(lk,"merge_template");var dk={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>Gc(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},cp={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function Mo(n={}){n?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:G$(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:r(({modal:s})=>{s.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}r(Mo,"context_suggest_blocks");function G$(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(G$,"get_block_display_name");var _k="Add blocks";var mk=require("obsidian");var H$=mk.Platform.isMacOS?"\u2318":"Ctrl";function J$(n){return typeof n!="string"?"":n.replace(/\/+$/g,"")}r(J$,"normalize_folder_path");function V$(n,e){let t=J$(e);return!t||n===t?!0:n.startsWith(`${t}/`)}r(V$,"is_source_in_folder");function uk(n){n?.inputEl&&(n.last_input_value=n.inputEl.value,n.inputEl.value="")}r(uk,"reset_modal_input");function K$(n,e){return Object.values(n.env?.smart_sources?.items||{}).filter(s=>V$(s.key,e))}r(K$,"get_sources_list");function Y$(n,e){return e.map(t=>({key:t.key,display:t.key,select_action:r(()=>{n.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s}={})=>(uk(s),Mo.call(n,{source_key:t.key,modal:s})),"mod_select_action"),arrow_right_action:r(({modal:s}={})=>(uk(s),Mo.call(n,{source_key:t.key,modal:s})),"arrow_right_action")}))}r(Y$,"build_source_suggestions");function pk(n={}){console.log("context_suggest_sources",n);let e=n?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${H$} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=K$(this,n?.folder_path||"");return Y$(this,t)}r(pk,"context_suggest_sources");var hk="Add sources";async function Jc(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(Jc,"pre_process");function lp(n){return this.vec?n.to_item?.vec?{score:gs(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(lp,"similarity");lp.action_type="score";var dp="Cosine Similarity",_p="Ranks by cosine similarity between the current note and candidates.",fk={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${dp} algorithm`,value:`${_p}`}};var up=require("obsidian");async function Vc(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=up.Keymap.isModEvent(e),l=up.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(Vc,"open_source");async function gk(n=null){await Vc(this,n)}r(gk,"source_open");var yk={collections:{embedding_models:jb,lookup_lists:Pb},item_types:{EmbeddingModel:Ss,LookupList:Bt},items:{embedding_model:{class:Ss},lookup_list:{class:Bt}},modules:{},components:{collection_settings:{render:Ib},context_item_leaf:{render:Rb},env_stats:{render:Fb},form_dropdown:{render:Zm},lean_coffee_callout:{render:Wb},milestones:{render:Xb},notifications_feed:{render:Zb},pro_plugins_list:{render:uv},pro_plugins_list_item:{render:mv},settings_env_model:{render:gv},settings_env_model_type:{render:wv},settings_env_models:{render:xv},settings_env_sources:{render:qv},settings_model_actions:{render:Ov},settings_notifications:{render:$v},settings_smart_env:{render:Tv},smart_context_actions:{render:Pv},smart_context_item:{render:Mv},smart_context_meta:{render:Lv},smart_context_tree:{render:Uv},source_inspector:{render:Gv},status_bar:{render:Xv},supporter_callout:{render:Qv},user_agreement_callout:{render:tk}},actions:{context_copy_to_clipboard:{action:sk},context_item_merge_template:{action:rk,settings_config:ak,default_settings:ap},context_merge_template:{action:lk,settings_config:dk,default_settings:cp},context_suggest_blocks:{action:Mo,display_name:_k},context_suggest_sources:{action:pk,display_name:hk},lookup_list_pre_process:{action:Jc,pre_process:Jc},similarity:{action:lp,settings_config:fk,display_name:dp,display_description:_p},source_open:{action:gk}}};var bk={env_path:"",modules:{smart_fs:{class:Ta,adapter:Na},smart_view:{class:za,adapter:Ra},smart_embed_model:{class:ro,adapters:{transformers:vn,openai:uc,ollama:hc,gemini:fc,lm_studio:gc}},smart_chat_model:{class:co,adapters:{anthropic:lo,azure:mo,custom:Eo,google:wn,gemini:fo,groq:So,lm_studio:yo,ollama:ko,open_router:go,openai:Es,xai:Ao,deepseek:Co},http_adapter:new nt({adapter:bn,obsidian_request_url:mp.requestUrl})},http_adapter:{class:nt,adapter:bn,obsidian_request_url:mp.requestUrl}},collections:{context_items:wb,event_logs:Eb,smart_components:gb,smart_contexts:vb,smart_sources:{collection_key:"smart_sources",class:eo,data_adapter:no,source_adapters:{md:vs,txt:vs,"excalidraw.md":oc,base:sc,canvas:ic,rendered:nc},content_parsers:[ub],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:oo,data_adapter:rc,block_adapters:{md:pn,txt:pn,"excalidraw.md":pn}}},item_types:{SmartSource:un,SmartBlock:mn},items:{smart_source:Ky,smart_block:sb},default_settings:qb,modals:{context_selector:{class:$c,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:Tc},notifications_feed_modal:{class:jc}}};fs(bk,yk);var vk=bk;var Kc=require("obsidian");function kk(){(0,Kc.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}r(kk,"add_smart_chat_icon");function wk(){(0,Kc.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}r(wk,"add_smart_connections_icon");function xk(){(0,Kc.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}r(xk,"add_smart_lookup_icon");var Ek=require("obsidian");var Yc={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function X$(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(X$,"define_default_create_methods");var Nn=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,X$(Yc)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=Yc[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,Ek.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,Yc["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var Sk=require("obsidian");var Z$=require("obsidian");function Xc(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Xc,"get_smart_server_url");var Q$="smart-plugins-op",ej="smart-plugins-op-secret";function tj({access_token:n,refresh_token:e},t){localStorage.setItem(t+"token",n),e&&localStorage.setItem(t+"refresh",e)}r(tj,"set_local_storage_token");async function Ak(n,e){let t=nj(e.app.vault.getName()),s=`${Xc()}/auth/oauth_exchange2`,i=await(0,Sk.requestUrl)({url:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:Q$,client_secret:ej,code:n})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:o,refresh_token:a}=i.json;if(!o)throw new Error("No access_token in response");tj({access_token:o,refresh_token:a},t)}r(Ak,"exchange_code_for_tokens");var sj="_smart_plugins_oauth_";function nj(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${sj}`}r(nj,"build_oauth_storage_prefix");function Ck(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let s=Tn([...new Set(t)]);return n.replace(/{{\s*folder_tree\s*}}/gi,s)}r(Ck,"replace_folder_tree_var");function qk(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let s=Tn([...new Set(t)]);return n.replace(/{{\s*folders_top\s*}}/gi,s)}r(qk,"replace_folders_top_var");function Ok(n){console.log("replace_recent_n_var",n);let e=this;return n.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,s)=>{let i=parseInt(s,10)||0,o=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,o),o?`
- ${o}`:""}).trim()}r(Ok,"replace_recent_n_var");function $k(n){let t=this.app?.metadataCache?.getTags?.()||{},s=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return n.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${s}
`).trim()}r($k,"replace_vault_tags_var");function jk(n){n.register(e=>/{{\s*folder_tree\s*}}/i.test(e),Ck,"{{ folder_tree }}"),n.register(e=>/{{\s*folders_top\s*}}/i.test(e),qk,"{{ folders_top }}"),n.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),$k,"{{ tags }}"),n.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),Ok,"{{ recent_10 }}")}r(jk,"register_completion_variable_adapter_replacements");async function ct({app:n,plugin_ids:e=[]}={}){if(!n)return;let t=n.vault?.adapter;for(let s of e)await ij(n.plugins,s)&&console.warn(`Disabled legacy plugin: ${s}`),await oj(t,s)&&console.warn(`Removed legacy plugin: ${s}`)}r(ct,"remove_smart_plugins_plugin");async function ij(n,e){if(!(!n||!(n.plugins?.[e]||n.enabledPlugins?.has?.(e)||n.manifests&&e in n.manifests)))return n.plugins?.[e]&&await n.unloadPlugin?.(e),n.disablePluginAndSave&&await n.disablePluginAndSave(e),n.enabledPlugins?.has?.(e)&&n.enabledPlugins.delete(e),n.manifests&&e in n.manifests&&delete n.manifests[e],await n.loadManifests?.(),!0}r(ij,"disable_plugin_if_present");async function oj(n,e){if(!n?.exists)return;let t=`.obsidian/plugins/${e}`;if(await n.exists(t)){if(n.rmdir){await n.rmdir(t,!0);return}if(n.list&&n.remove){let i=[t];for(;i.length;){let o=i.pop(),a=await n.list(o);for(let c of a?.files||[])await n.remove(`${o}/${c}`);for(let c of a?.folders||[])i.push(`${o}/${c}`)}return await n.remove(t),!0}}}r(oj,"remove_plugin_folder");var qs=class extends Qi{static{r(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,kk(),wk(),xk(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new Ut.Notice(i,0),window.smart_env=null}let s=fs(t,vk);return s.env_path="",await super.create(e,s)}async load(e=!1){if(this.run_migrations(),this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")||this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),Ut.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new Ut.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i.view?.file?.path;this.emit_source_opened(o,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i?.path;this.emit_source_opened(o,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&jk(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),Jb(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let s=this.smart_sources.get(e);s&&(this._current_opened_source=e,s.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new Nn(this,{adapter:Ut.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),s=`${Xc()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(s,"_external"),s}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new Ut.Notice("No OAuth code provided in URL. Login failed.");return}try{await Ak(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(s){console.error("OAuth callback error",s),new Ut.Notice(`OAuth callback error: ${s.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&rj(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){ct({app:this.plugin.app,plugin_ids:["smart-plugins"]}),ct({app:this.plugin.app,plugin_ids:["smart-editor"]}),ct({app:this.plugin.app,plugin_ids:["smart-sources"]}),ct({app:this.plugin.app,plugin_ids:["smart-claude"]}),ct({app:this.plugin.app,plugin_ids:["smart-gemini"]}),ct({app:this.plugin.app,plugin_ids:["smart-deepseek"]}),ct({app:this.plugin.app,plugin_ids:["smart-perplexity"]}),ct({app:this.plugin.app,plugin_ids:["smart-grok"]}),ct({app:this.plugin.app,plugin_ids:["smart-aistudio"]})}};function rj(n,e){let t=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}r(rj,"download_json");var fp=require("obsidian");var Tk=require("obsidian");async function Nk(n,e={}){let{wait_for_states:t=["loaded"]}=e,s=n.container||n.containerEl;if(!t.includes(n.env?.state)){let i=!1;for(;n.env.state==="init"&&Tk.Platform.isMobile&&!i;)s?(s.empty(),n.env.smart_view.safe_inner_html(s,"<button>Load Smart Environment</button>"),s.querySelector("button").addEventListener("click",()=>{n.env.load(!0),i=!0})):console.log("Waiting for env to load (mobile)..."),await new Promise(o=>setTimeout(o,2e3));for(;!t.includes(n.env.state);){if(s){let o=n.env?.obsidian_is_syncing?"Waiting for Obsidian Sync to finish...":"Loading Obsidian Smart Environment...";s.empty(),n.env.smart_view.safe_inner_html(s,o)}else console.log("Waiting for env to load...");await new Promise(o=>setTimeout(o,2e3))}}}r(Nk,"wait_for_env_to_load");var pp=`/* 1) Host elements that should get a PRO badge */\r
:is(\r
.pro-setting .setting-item-name\r
) {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
:is(\r
.pro-setting .setting-item-name:not(:empty)\r
)::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
:is(\r
.pro-setting .setting-item-name\r
):hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
.pro-plugins-container {\r
border: 1px solid var(--interactive-accent);\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-top: 1rem;\r
background-color: var(--background-secondary);\r
}\r
\r
.smart-plugin-settings-header .actions-container {\r
display: flex;\r
flex-wrap: wrap;\r
gap: var(--pill-padding-y);\r
}\r
\r
.setting-component:has(.dropdown-no-options) {\r
display: none;\r
}\r
\r
/* wrap Obsidian native styles within smart plugin settings main class */\r
.smart-plugin-settings-main, .smart-plugin-settings-env {\r
.setting-group {\r
margin-top: var(--size-4-6);\r
margin-bottom: var(--size-4-6);\r
}\r
/* polyfill */\r
.setting-group .setting-items {\r
background-color: var(--setting-items-background, var(--background-primary-alt));\r
padding: var(--setting-items-padding, var(--size-4-5));\r
border-radius: var(--setting-items-radius, var(--radius-l));\r
border: var(--setting-items-border-width, 0) solid var(--setting-items-border-color, var(--background-modifier-border));\r
}\r
}\r
`;var Lo=class extends fp.PluginSettingTab{static{r(this,"SmartPluginSettingsTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.env.is_pro&&!this.env_settings_tab&&this.plugin.addSettingTab(new hp(this.plugin.app,this.plugin)),this.icon="smart-connections",this.env.is_pro&&(this.name=this.name.replace("Smart ",""))}get smart_view(){return this.env?.smart_view}async display(){await this.render()}async render(){this.containerEl.empty(),Pk(this),await this.env.constructor.wait_for({loaded:!0}),this.prepare_layout(),await this.render_header(this.header_container),await this.render_plugin_settings(this.plugin_container),await this.render_global_settings(this.global_settings_container)}prepare_layout(){this.smart_view.apply_style_sheet(pp),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.global_settings_container=this.containerEl.createDiv({cls:"smart-plugin-settings-env"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"})}async render_header(e){}async render_plugin_settings(e){}async render_global_settings(e){if(!e||(e.empty?.(),!this.env))return;if(this.env.is_pro){let s=e.createDiv({cls:"setting-item"}),i=s.createDiv({cls:"setting-item-info"});i.createDiv({cls:"setting-item-name",text:"Smart Environment"}),i.createDiv({cls:"setting-item-description",text:"Manage global settings in the dedicated Smart Environment settings tab."}),s.createDiv({cls:"setting-item-control"}).createEl("button",{text:"Open settings"}).addEventListener("click",()=>{this.app.setting.openTabById("smart-environment")})}else{let s=await this.render_component("settings_smart_env",this.env);s&&e.appendChild(s)}let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}async render_component(e,t,s={}){return await this.env.smart_components.render_component(e,t,s)}get env_settings_tab(){return(this.plugin.app||window.app).setting.pluginTabs.find(t=>t.id==="smart-environment")}},hp=class extends fp.PluginSettingTab{static{r(this,"SmartEnvSettingTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.plugin=t,this.name="Smart Env Pro",this.id="smart-environment",this.icon="smart-connections"}get smart_view(){return this.env?.smart_view}display(){this.render()}async render_component(e,t,s={}){return await this.env.smart_components.render_component(e,t,s)}async render(){this.containerEl.empty(),this.smart_view.apply_style_sheet(pp),Pk(this),await this.env.constructor.wait_for({loaded:!0}),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"}),this.header_container.createEl("p",{text:"Manage all global Smart Environment settings from one tab. These settings apply to all Smart Plugins."});let e=await this.render_component("settings_smart_env",this.env);e&&this.plugin_container.appendChild(e);let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}};function Pk(n){let e=n.containerEl,t=n.env;if(t.state!=="loaded")if(t.state==="loading")e.createEl("p",{text:"Smart Environment is loading\u2026"});else{e.createEl("p",{text:"Smart Environment not yet initialized."});let s=e.createEl("button",{text:"Load Smart Environment"});s.addEventListener("click",async()=>{s.disabled=!0,s.textContent="Loading Smart Environment\u2026",await t.load(!0)})}}r(Pk,"render_pre_env_load");var Zc=require("obsidian");var zo=class extends Zc.Plugin{static{r(this,"SmartPlugin")}SmartEnv=qs;get commands(){return{show_release_notes:{id:"show-release-notes",name:"Show release notes",callback:r(()=>this.show_release_notes(),"callback")}}}register_commands(){Object.values(this.commands).forEach(e=>{this.addCommand(e)})}get ribbon_icons(){return{}}register_ribbon_icons(){let e=Object.values(this.ribbon_icons);for(let t=0;t<e.length;t++){let s=e[t];this.addRibbonIcon(s.icon_name,s.description,s.callback)}}get item_views(){return{}}register_item_views(){let e=Object.values(this.item_views);for(let t=0;t<e.length;t++){let s=e[t];typeof s.register_item_view=="function"&&s.register_item_view(this)}}async is_new_user(){let e=await this.loadData()||{};return e.installed_at?!1:(e.installed_at=Date.now(),await this.saveData(e),!0)}async get_last_known_version(){return(await this.loadData()||{}).last_version||""}async set_last_known_version(e){let t=await this.loadData()||{};t.last_version=e,await this.saveData(t)}async is_new_plugin_version(e){return await this.get_last_known_version()!==e}get notices(){return this.env?.notices?this.env.notices:(this._notices||(this._notices=new Nn(this.env,Zc.Notice)),this._notices)}};function Qc(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Qc,"collection_instance_name_from");function Os(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Ik(e[t])&&Ik(n[t])?Os(n[t],e[t]):n[t]=e[t]);return n}r(Os,"deep_merge");function Ik(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Ik,"is_plain_object");function Mk(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Mk,"create_uid");function Lk(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(Lk,"camel_case_to_snake_case");function el(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>el(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>el(n[o],e[o],t))}return n===e}r(el,"deep_equal");function zk(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(zk,"get_item_display_name");function tl(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let q=Object.getOwnPropertyDescriptor(m,w);if(!q)continue;let E={...q};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let q of h){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E){let O=E.value;if(c(O)){w=!0;continue}if(s(O)){if(_(O)){w=!0;continue}return!1}if(typeof O>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),w=new Map;for(let q of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E&&_(E.value)){w.set(q,d(E.value));continue}try{Object.defineProperty(h,q,u(E))}catch{h[q]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:b}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=r((m,h,w=[])=>{if(!m||!h)return;let q=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(q.has(E))continue;let O=Object.getOwnPropertyDescriptor(m,E);if(O)try{Object.defineProperty(h,E,O)}catch{h[E]=O.value}}},"copy_metadata"),y=r(m=>{let h=new m(n),w=h.action||h.run||h.execute||h.call;if(i(w)){let q=w.bind(h);return v(m,q),v(h,q),q.instance=h,q}return v(m,h),h},"instantiate_class"),S=r(m=>{if(o(m))return y(m);if(a(m)){let h=m.action.bind(n);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return v(m,h),h}return s(m)?d(m):m},"bind_or_clone"),A=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=b.get(m);return h&&s(h)?h:null},"scope_actions_for"),$=r((m,h,w)=>(m[h]=w,w),"cache_result"),j=r((m,h)=>{let w=A();return w&&g(w,h)?$(m,h,S(w[h])):g(f,h)?$(m,h,S(f[h])):$(m,h,void 0)},"compute_and_cache"),C=r(()=>{let m=A(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let w=A();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:r(()=>C(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return x(m,h);let w=A();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:r((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(tl,"create_actions_proxy");var Do=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Os(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Mk(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return Os(s,t),!el(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:b}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||b&&!b.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=tl(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Qc(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Qc(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Lk(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return zk(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var cj=Object.getPrototypeOf(async function(){}).constructor,Ro=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof cj?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Os(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=tl(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};function Rk(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=Dk(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=Dk(n.results);n.min=s,n.minResult=i}}r(Rk,"results_acc");function Dk(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(Dk,"find_min");function lj(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(lj,"sort_by_score");function Fk(n,e){return lj(n,e)}r(Fk,"sort_by_score_descending");function Bk(n,e){if(!e.pinned?.length)return n;let t=new Set(e.pinned_keys||e.pinned.map(o=>o.key)),s=e.pinned.map(o=>({item:o,...o.score?.(e)||{}})),i=n.filter(o=>{let a=o?.item?.key;return a?!t.has(a):!0});return[...s,...i]}r(Bk,"merge_pinned_results");var dj="smart_sources",_j="smart_blocks";function Uk(n){return!!n&&typeof n=="object"&&!Array.isArray(n)}r(Uk,"is_plain_object");function uj(n){return Uk(n)?Object.entries(n).filter(([,e])=>e!=null):[]}r(uj,"select_hidden_entries");function mj(n){return n.includes("#")?_j:dj}r(mj,"get_collection_prefix");function pj(n){return typeof n!="string"||n.includes(":")?n:`${mj(n)}:${n}`}r(pj,"ensure_prefixed_key");function Wk(n){let e=uj(n?.data?.hidden_connections);if(!e.length)return!1;Uk(n.data.connections)||(n.data.connections={});let t=!1;return e.forEach(([s,i])=>{let o=pj(s);if(typeof o!="string")return;let a=n.data.connections[o]||{};(a.hidden===void 0||a.hidden===null)&&(a.hidden=i,t=!0),n.data.connections[o]=a}),t&&delete n.data.hidden_connections,t||e.length>0}r(Wk,"migrate_hidden_connections");var qe=class extends Do{static{r(this,"ConnectionsList")}static key="connections_list";static get defaults(){return{data:{}}}get_key(){return`${this.data.collection_key}:${this.data.item_key}`}async pre_process(e){Wk(this.item),typeof this.actions.connections_list_pre_process=="function"&&await this.actions.connections_list_pre_process(e),typeof this.env.config?.actions?.[e.score_algo_key]?.pre_process=="function"&&await this.env.config.actions[e.score_algo_key].pre_process.call(this.item,e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return t=await this.post_process(t,e),t=Bk(t,e),t=t.map(s=>Object.assign(s,{connections_list:this})),this.results=t,t}filter_and_score(e={}){let t=this.env[e.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(Rk(a,l,e.limit),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(Fk);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){if(!e?.length)return console.warn("No results to post-process, received:",e),[];let s=this.settings.connections_post_process,i=this.actions[s],o=e;if(typeof i=="function"){let a=await i(e,t);Array.isArray(a)?(o=a.filter(Boolean),o.length||(o=e)):a!=null&&console.warn(`connections post_process '${s}' returned non-array`,a)}else s&&s!=="none"&&console.warn(`Post-process action "${s}" not found, falling back to base results.`);return o}get item(){return this.env[this.data.collection_key]?.items[this.data.item_key]}get connections_list_component_key(){let e=this.data.connections_list_component_key||this.settings?.connections_list_component_key;return this.env.config.components[e]?e:"connections_list_v3"}};var hj=["inline_connections","inline_connections_score_threshold","footer_connections"];function Gk(n){let e=n?.settings;if(!e)return!1;let t=e.connections_pro;if(!t)return!1;let s=e.connections_lists||={},i=!1;for(let o of hj)o in t&&(o in s||(s[o]=t[o],i=!0),delete t[o]);return"rank_model"in t&&(s.actions||(s.actions={}),"rank_connections"in s.actions||(s.actions.rank_connections=t.rank_model,i=!0),delete t.rank_model),i}r(Gk,"migrate_connections_lists_settings");function sl(n,e,t){let s=Object.entries({...e}),i=s.findIndex(([o])=>o===n);if(i!==-1&&t&&Object.keys(t).length>0){let o=Object.entries(t);s.splice(i+1,0,...o)}return Object.fromEntries(s)}r(sl,"insert_settings_after");var Fo=class extends Ro{static{r(this,"ConnectionsLists")}static version=1;process_load_queue(){}constructor(e,t={}){Gk(e),super(e,t)}static get default_settings(){return{results_collection_key:"smart_sources",score_algo_key:"similarity",connections_post_process:"none",results_limit:20,exclude_frontmatter_blocks:!0,connections_list_item_component_key:"connections_list_item_v3",components:{connections_list_item_v3:{render_markdown:!0,show_full_path:!1}}}}get settings_config(){return nl(this)}new_item(e){let t=new this.item_type(this.env,{collection_key:e.collection_key,item_key:e.key});return this.set(t),Object.defineProperty(e,"connections",{get:r(()=>t,"get"),configurable:!0}),t}get_connections_list_item_options(){return Object.entries(this.env.config.components||{}).filter(([e,t])=>e.startsWith("connections_list_item_")).map(([e,t])=>({value:e,name:t.display_name||e,description:t.display_description}))}get score_algo_key(){let e=this.settings?.score_algo_key;return this.env.config?.actions?.[e]?e:"similarity"}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env[e]?e:"smart_sources"}};function nl(n){let e={results_collection_key:{name:"Connection results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(()=>{let t=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&t.push({value:"smart_blocks",name:"Blocks"}),t},"options_callback")},results_limit:{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20)."}};return n.env.smart_blocks.settings.embed_blocks||(e.results_collection_key={type:"html",value:Tb("Connection results type",'Enable "Embed blocks" in Smart Blocks settings to use block connections.'),name:"Connection results type"}),e}r(nl,"settings_config");var Hk={class:Fo,collection_key:"connections_lists",item_type:qe,settings_config:nl};var Jk=`.connections-codeblock {\r
.connections-top-bar {\r
display: flex;\r
gap: 0.5rem 1rem;\r
\r
.connections-actions {\r
display: flex;\r
flex-direction: row;\r
flex-wrap: wrap;\r
align-items: center;\r
gap: 0.5rem;\r
span {\r
font-weight: 600;\r
justify-self: end;\r
}\r
}\r
}\r
.connections-list {\r
padding-top: 0.85rem;\r
\r
> .sc-collapsed ul {\r
display: none;\r
}\r
> .sc-collapsed span svg {\r
transform: rotate(-90deg);\r
}\r
> .sc-result-pinned {\r
box-shadow: 0 0 0 1px var(--interactive-accent);\r
border-radius: var(--radius-s);\r
background-color: var(--background-modifier-hover);\r
}\r
}\r
}`;var In=require("obsidian");var il=require("obsidian");function gp(n,e){let t=n.app.internalPlugins?.plugins?.webviewer?.instance;window.open(e,t?"_external":"_blank")}r(gp,"open_url_externally");var Be=class n extends il.Modal{static{r(this,"StoryModal")}constructor(e,{title:t,url:s}){super(e.app),this.plugin=e,this.title=t,this.url=s}static open(e,t){new n(e,t).open()}onOpen(){this.titleEl.setText(this.title),this.modalEl.addClass("sc-story-modal");let e=this.contentEl.createEl("div",{cls:"sc-story-container"});if(il.Platform.isMobile){e.createEl("button",{text:"Open in browser"}).addEventListener("click",()=>{gp(this.plugin,this.url),this.close()});return}else{let t=e.createEl("webview",{attr:{src:this.url,allowpopups:""}});t.style.width="100%",t.style.height="100%",t.addEventListener("did-navigate",s=>{let i=s.url||t.getAttribute("src");i&&i!==this.url&&(gp(this.plugin,i),this.close())})}}onClose(){this.contentEl.empty()}};function ol(n={}){let{source_item:e,results:t=[]}=n,s=[],i=new Set,o=r((a,c)=>{let l=a?.key;!l||i.has(l)||(i.add(l),s.push({key:l,score:c}))},"append_item");return e&&o(e,e.score??1),t.forEach(a=>o(a?.item,a?.score)),s}r(ol,"build_connections_context_items");function Pn(n=[]){return!Array.isArray(n)||!n.length?"":n.map(({item:e})=>gj(e)).filter(Boolean).join(`
`)}r(Pn,"format_connections_as_links");function gj(n){if(!n?.key)return"";let e=bj(n);if(!e)return"";let t=yj(n);return t?`${e.replace(/\#\{\d+\}/,"")} (${t})`:e}r(gj,"format_connection_item");function yj(n){return!n?.key?.endsWith("}")||!Array.isArray(n.lines)||!n.lines.length?"":`Lines: ${n.lines.join("-")}`}r(yj,"get_lines_label");function bj(n){if(!n?.key)return"";let[e,...t]=n.key.split("#"),s=e.split("/").pop().replace(/\.md$/i,"");if(t.length){let i=t.pop();return`- [[${s}#${i}]]`}return`- [[${s}]]`}r(bj,"get_wikilink");function Wt(n,e){return typeof e!="string"||!e.length||e.includes(":")||typeof n!="string"||!n.length?e:`${n}:${e}`}r(Wt,"build_prefixed_connection_key");function Vk(n,e,t=Date.now()){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return n;let s=n[e]||{};return s.hidden=t,n[e]=s,n}r(Vk,"apply_hidden_state");function Kk(n,e,t=Date.now()){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return n;let s=n[e]||{};return s.pinned=t,n[e]=s,n}r(Kk,"apply_pinned_state");function Yk(n,e){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return n;let t=n[e];return!t||typeof t!="object"||(delete t.pinned,Object.keys(t).length||delete n[e]),n}r(Yk,"remove_pinned_state");function Xk(n){if(!n||typeof n!="object")return!1;let e=!1;return Object.entries(n).forEach(([t,s])=>{!s||typeof s!="object"||s.hidden===void 0||s.hidden===null||(delete s.hidden,Object.keys(s).length||delete n[t],e=!0)}),e}r(Xk,"remove_all_hidden_states");function Zk(n){if(!n||typeof n!="object")return!1;let e=!1;return Object.entries(n).forEach(([t,s])=>{!s||typeof s!="object"||s.pinned===void 0||s.pinned===null||(delete s.pinned,Object.keys(s).length||delete n[t],e=!0)}),e}r(Zk,"remove_all_pinned_states");function Qk(n){return!n||typeof n!="object"?0:Object.values(n).reduce((e,t)=>t&&typeof t=="object"&&t.hidden!==void 0&&t.hidden!==null?e+1:e,0)}r(Qk,"count_hidden_connections");function ew(n){return!n||typeof n!="object"?0:Object.values(n).reduce((e,t)=>t&&typeof t=="object"&&t.pinned!==void 0&&t.pinned!==null?e+1:e,0)}r(ew,"count_pinned_connections");function Bo(n,e){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return!1;let t=n[e];return!t||typeof t!="object"?!1:t.pinned!==void 0&&t.pinned!==null}r(Bo,"is_connection_pinned");function rl(n,e){if(!n||typeof n!="object"||typeof e!="string"||!e.length)return!1;let t=n[e];return!t||typeof t!="object"?!1:t.hidden!==void 0&&t.hidden!==null}r(rl,"is_connection_hidden");function Uo(n=[],e={}){return!Array.isArray(n)||!n.length?[]:!e||typeof e!="object"?n:n.filter(t=>{let s=t?.item;if(!s)return!1;let i=Wt(s.collection_key,s.key),o=e[i];if(!o||typeof o!="object")return!0;let a=o.hidden!==void 0&&o.hidden!==null,c=o.pinned!==void 0&&o.pinned!==null;return!(a&&!c)})}r(Uo,"filter_hidden_results");async function vj(n,e={}){return`<div class="connections-codeblock connections-item-view sc-connections-view">
<div class="connections-top-bar">
<div class="connections-actions">
${[{title:"Refresh connections",icon:"refresh-cw",attrs:'data-action="refresh-connections"'},{title:"Expand all",icon:"unfold-vertical",attrs:'data-action="expand-all"'},{title:"Collapse all",icon:"fold-vertical",attrs:'data-action="collapse-all"'},{title:"Send results to Smart Context",icon:"briefcase",attrs:'data-action="send-to-smart-context"'},{title:"Copy as list of links",icon:"copy",attrs:'data-action="copy-as-links"'},{title:"Connections settings",icon:"settings",attrs:'data-action="open-settings"'},{title:"Help & getting started",icon:"help-circle",attrs:'data-action="open-help"'}].map(i=>`
<button
aria-label="${i.title}"
${i.attrs??""}
>
${this.get_icon_html(i.icon)}
</button>
`).join("")}
<span>Smart Connections</span>
</div>
</div>
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div>`}r(vj,"build_html");async function sw(n,e={}){let t=await vj.call(this,n,e),s=this.create_doc_fragment(t);this.apply_style_sheet(Jk);let i=s.firstElementChild;return kj.call(this,n,i,e),s}r(sw,"render");async function kj(n,e,t={}){let s=e.querySelector(".connections-list-container"),i=n.env,o=i.plugin.app||window.app,a=r(async()=>{console.log("Rendering connections list in codeblock view");let c=t.connections_list_component_key||n.connections_list_component_key||"connections_list_v3",l=await i.smart_components.render_component(c,n,t);this.empty(s),s.appendChild(l)},"render_list");if(!e._has_listeners){e._has_listeners=!0,e.querySelector('[data-action="refresh-connections"]')?.addEventListener("click",async()=>{let g=n.item;g?(await g.read(),g.queue_import(),await g.collection.process_source_import_queue?.(),a()):console.warn("No entity found for refresh")}),e.querySelector('[data-action="expand-all"]')?.addEventListener("click",()=>{e.querySelectorAll(".sc-result").forEach(g=>{g.classList.remove("sc-collapsed")})}),e.querySelector('[data-action="collapse-all"]')?.addEventListener("click",()=>{e.querySelectorAll(".sc-result").forEach(g=>{g.classList.add("sc-collapsed")})}),e.querySelector('[data-action="send-to-smart-context"]')?.addEventListener("click",async()=>{let g=await tw(n,t);if(!g.length)return new In.Notice("No connection results to send to Smart Context");let k=n?.item?.data?.connections||{},v=Uo(g,k),y=ol({source_item:n?.item,results:v});if(!y.length)return new In.Notice("No visible connection results to send to Smart Context");let S=i.smart_contexts.new_context();S.add_items(y),S.emit_event("context_selector:open"),n.emit_event("connections:sent_to_context")}),e.querySelector('[data-action="copy-as-links"]')?.addEventListener("click",async()=>{let g=await tw(n,t);if(!g.length)return new In.Notice("No connection results to copy");let k=n?.item?.data?.connections||{},v=Uo(g,k),y=Pn(v);if(!y)return new In.Notice("No visible connection results to copy");await at(y),new In.Notice("Copied connections as list of links"),n.emit_event("connections:copied_list")}),e.querySelector('[data-action="open-settings"]')?.addEventListener("click",()=>{o.setting.open(),o.setting.openTabById("smart-connections")});let f=r(()=>{Be.open(i.plugin,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=connections-view-help#page=understanding-connections-1"})},"open_help");e.querySelector('[data-action="open-help"]')?.addEventListener("click",f)}return a(),e}r(kj,"post_process");async function tw(n,e={}){let t=Array.isArray(n?.results)?n.results:[];if(t.length)return t;try{let s=await n.get_results({...e});return Array.isArray(s)?s:[]}catch(s){return console.error("Failed to fetch connections results",s),[]}}r(tw,"get_results_fallback");var Gt=require("obsidian");var nw=new CSSStyleSheet;nw.replaceSync(`a.sc-result-file-title{text-decoration:none!important}a.sc-result-file-title>.sc-score{display:inline-block;width:auto;height:1.7em;padding:0 .3em;line-height:1.7em;text-align:center;font-weight:600!important;font-size:.8em!important;color:var(--nav-item-color)!important;background:var(--background-modifier-hover);border-radius:6px}a.sc-result-file-title>.sc-path{margin-right:-3px}a.sc-result-file-title>.sc-path,a.sc-result-file-title>.sc-title{font-weight:700!important;text-decoration:underline}a.sc-result-file-title>.sc-breadcrumb:not(.sc-path,.sc-title,.sc-score){font-style:italic}a.sc-result-file-title>.sc-breadcrumb-separator{color:color-mix(in srgb,var(--text-normal) 50%,transparent)!important}.sc-result.sc-result-graph-focus{outline:2px solid color-mix(in srgb,var(--interactive-accent) 70%,transparent);border-radius:var(--radius-s);box-shadow:0 0 0 1px color-mix(in srgb,var(--background-primary) 80%,transparent),0 0 .5rem color-mix(in srgb,var(--interactive-accent) 45%,transparent);transition:outline .12s ease,box-shadow .12s ease}
`);var iw=nw;function Wo(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();return s.push(a),o.length&&s.push(o.pop()),s.join(" > ")}r(Wo,"get_item_display_name");function ow(n){if(!n)return"";let[e,...t]=n.split("#"),s=e.split("/").pop().replace(/\.md$/,"");if(!t.length)return`[[${s}]]`;let i=t.filter(o=>!o.startsWith("{")).pop();return i?`[[${s}#${i}]]`:`[[${s}]]`}r(ow,"parse_item_key_to_wikilink");function wj(n,e,t,s){let i=n.dragManager,o=ow(e.key),a=i.dragLink(s,o);i.onDragStart(s,a),t.drag_event_key?e.emit_event(t.drag_event_key):e.emit_event("connections:drag_result")}r(wj,"handle_connection_drag");function rw(n,e,t={}){let i=e.env.obsidian_app;n.setAttribute("draggable","true"),n.addEventListener("dragstart",wj.bind(null,i,e,t))}r(rw,"register_item_drag");async function xj(n,e={}){let t=n.item,s=t.env,i=n.score,o=e.connections_settings??s.connections_lists.settings,a=o.components?.connections_list_item_v3||{},c=Sj(i,t,a);return`<div class="temp-container">
<div
class="sc-result ${o.expanded_view?"":"sc-collapsed"}"
data-path="${t.path.replace(/"/g,"&quot;")}"
data-link="${t.link?.replace(/"/g,"&quot;")||""}"
data-collection="${t.collection_key}"
data-score="${i}"
data-key="${t.key}"
draggable="true"
>
<span class="header">
${this.get_icon_html("right-triangle")}
<a class="sc-result-file-title" href="#" title="${t.path.replace(/"/g,"&quot;")}" draggable="true">
${c}
</a>
</span>
<ul draggable="true">
<li class="sc-result-file-title" title="${t.path.replace(/"/g,"&quot;")}" data-collection="${t.collection_key}" data-key="${t.key}"></li>
</ul>
</div>
</div>`}r(xj,"build_html");async function aw(n,e={}){this.apply_style_sheet(iw);let t=await xj.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".sc-result");return Ej.call(this,n,i,e),i}r(aw,"render");async function Ej(n,e,t={}){let{item:s}=n,i=s.env,o=i.smart_connections_plugin,a=o.app,l=(t.connections_settings??i.connections_lists.settings).components?.connections_list_item_v3||{},d=l?.render_markdown??!0;d||e.classList.add("sc-result-plaintext");let _=n.connections_list?.item,u=Wt(s.collection_key,s.key);e.dataset.prefixedKey=u;let p=_?.data?.connections;rl(p,u)&&(e.style.display="none",e.dataset.hidden="true"),Bo(p,u)&&(e.classList.add("sc-result-pinned"),e.dataset.pinned="true");let f=r(async y=>{if(!y.querySelector("li").innerHTML){let S=y.dataset.collection,A=i[S].get(y.dataset.path),$;Cj(A)?$=`${A.embed_link}

${await A.read()}`:$=qj(await A.read());let j;d?j=await this.render_markdown($,A):j=this.create_doc_fragment($),e.querySelector("li").appendChild(j)}},"render_result");e.querySelector(".header .svg-icon.right-triangle").addEventListener("click",Oj);let g=t.event_key_domain||"connections",k=`${g}:drag_result`;return rw(e,s,{drag_event_key:k}),Ic(e,s,{event_key_domain:g}),e.addEventListener("click",y=>{Vc(s,y),s.emit_event(`${g}:open_result`,{event_source:"connections-list-item-v3"})}),new MutationObserver(y=>{y.some(A=>{let $=A.target;return A.attributeName==="class"&&A.oldValue?.includes("sc-collapsed")!==$.classList.contains("sc-collapsed")})&&!y[0].target.classList.contains("sc-collapsed")&&f(y[0].target)}).observe(e,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),o.registerDomEvent(e,"contextmenu",y=>{if(y.preventDefault(),y.stopPropagation(),!_)return;_.data.connections||={};let S=Wt(s.collection_key,s.key),A=Bo(_.data.connections,S),$=Qk(_.data.connections),j=ew(_.data.connections),C=n.connections_list?.results||[],x=Wo(s,l)||s.key;console.log({target_name:x,item:s});let m=new Gt.Menu(a);m.addItem(w=>{w.setTitle(`Hide ${x}`).setIcon("eye-off").onClick(()=>{try{Vk(_.data.connections,S,Date.now()),_.data.hidden_connections&&(delete _.data.hidden_connections[s.key],Object.keys(_.data.hidden_connections).length||delete _.data.hidden_connections),_.queue_save(),e.style.display="none",e.dataset.hidden="true",_.collection.save(),_.emit_event("connections:hidden_item")}catch(q){new Gt.Notice("Hide failed \u2013 check console"),console.error(q)}})}),m.addItem(w=>{let q=A?"Unpin":"Pin";w.setTitle(`${q} ${x}`).setIcon(A?"pin-off":"pin").onClick(()=>{try{A?(Yk(_.data.connections,S),e.classList.remove("sc-result-pinned"),e.removeAttribute("data-pinned")):(Kk(_.data.connections,S,Date.now()),e.classList.add("sc-result-pinned"),e.dataset.pinned="true",_.emit_event("connections:pinned_item")),_.queue_save(),_.collection.save()}catch(E){new Gt.Notice(`${q} failed \u2013 check console`),console.error(E)}})}),m.addSeparator();let h=Pn(C);h&&m.addItem(w=>{w.setTitle("Copy as list of links").setIcon("copy").onClick(async()=>{await at(h),new Gt.Notice("Connections links copied to clipboard"),n.connections_list.emit_event("connections:copied_list")})}),m.addSeparator(),m.addItem(w=>{w.setTitle(`Unhide All (${$})`).setIcon("eye").setDisabled(!$).onClick(()=>{try{if(!_.data.connections||!Xk(_.data.connections))return;_.data.hidden_connections&&delete _.data.hidden_connections,_.queue_save(),e.closest(".sc-connections-view")?.querySelector('[title="Refresh"]')?.click(),_.collection.save()}catch(q){new Gt.Notice("Unhide failed \u2013 check console"),console.error(q)}})}),m.addItem(w=>{w.setTitle(`Unpin All (${j})`).setIcon("pin-off").setDisabled(!j).onClick(()=>{try{if(!_.data.connections||!Zk(_.data.connections))return;e.closest(".connections-list")?.querySelectorAll(".sc-result[data-pinned]").forEach(O=>{O.classList.remove("sc-result-pinned"),O.removeAttribute("data-pinned")}),_.queue_save(),_.collection.save()}catch(q){new Gt.Notice("Unpin failed \u2013 check console"),console.error(q)}})}),m.showAtMouseEvent(y)}),e.classList.contains("sc-collapsed")||f(e),e}r(Ej,"post_process");function Sj(n,e,t={}){let s=Wo(e,t).split(" > ").filter(Boolean),i=Aj(s,e?.lines),o=i.pop(),a=typeof n=="number"?n.toFixed(2):n,c='<small class="sc-breadcrumb-separator"> &gt; </small>',l=i.map(d=>`<small class="sc-breadcrumb">${d}</small>`).join(c);return[`<small class="sc-breadcrumb sc-score">${a}</small>`,`${l}${c}`,`<small class="sc-breadcrumb sc-title">${o}</small>`].join("")}r(Sj,"get_result_header_html");function Aj(n,e=[]){if(!Array.isArray(n)||!n.length)return[];let t=Array.isArray(e)&&e.length;return n.map(s=>t&&s.startsWith("{")?`Lines: ${e.join("-")}`:s)}r(Aj,"format_item_parts");function Cj(n){return n?!!n.is_media:!1}r(Cj,"should_render_embed");function qj(n){return n.includes("```dataview")&&(n=n.replace(/```dataview/g,"```\\dataview")),n.includes("```smart-context")&&(n=n.replace(/```smart-context/g,"```\\smart-context")),n.includes("```smart-chatgpt")&&(n=n.replace(/```smart-chatgpt/g,"```\\smart-chatgpt")),n.includes("![[")&&(n=n.replace(/\!\[\[/g,"! [[")),n}r(qj,"process_for_rendering");function Oj(n){n.preventDefault(),n.stopPropagation(),n.target.closest(".sc-result").classList.toggle("sc-collapsed")}r(Oj,"toggle_result");var cw={show_full_path:{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results.",default:!0},render_markdown:{name:"Render markdown",type:"toggle",description:"Turn off to prevent rendering markdown and display connection results as plain text.",default:!0}};async function $j(n,e={}){return`<div><div class="connections-list sc-list" data-key="${n.item.key}"></div></div>`}r($j,"build_html");async function lw(n,e={}){let t=await $j.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".connections-list");return jj.call(this,n,i,e),i}r(lw,"render");async function jj(n,e,t={}){e.dataset.key=n.item.key;let s=await n.get_results(t);if(!s||!Array.isArray(s)||s.length===0){let a=this.create_doc_fragment(`<p class="sc-no-results">No results found.<br><em>Try using the refresh button. If that doesn't work, try running "Clear sources data" and then "Reload sources" in the Smart Environment settings.</em></p>`);return e.appendChild(a),e}let i=n.env.smart_components;return(await Promise.all(s.map(a=>i.render_component("connections_list_item_v3",a,{...t})))).forEach(a=>e.appendChild(a)),e}r(jj,"post_process");var dw="List only";var uw=require("obsidian");async function Tj(n){return`
<div>
<div data-user-agreement></div>
<div class="actions-container">
<button class="sc-getting-started-button">Getting started guide</button>
<button class="sc-report-bug-button">Report a bug</button>
<button class="sc-request-feature-button">Request a feature</button>
<button class="sc-share-workflow-button">Share workflow \u2B50</button>
</div>
</div>
`}r(Tj,"build_html");async function _w(n){let e=await Tj.call(this,n),s=this.create_doc_fragment(e).firstElementChild;return Nj.call(this,n,s),s}r(_w,"render");async function Nj(n,e){let t=e.querySelector("[data-user-agreement]");if(t){let i=await n.env.render_component("user_agreement_callout",n);t.appendChild(i)}let s=e.querySelector("#header-callout a");return s&&s.addEventListener("click",i=>{i.preventDefault(),window.open(s.href,"_external")}),e.querySelector(".sc-getting-started-button")?.addEventListener("click",()=>{Be.open(n,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-settings"})}),e.querySelector(".sc-report-bug-button")?.addEventListener("click",()=>{if(n.env?.is_pro){new yp(n.app).open();return}window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=bug_report.yml","_external")}),e.querySelector(".sc-request-feature-button")?.addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=feature_request.yml","_external")}),e.querySelector(".sc-share-workflow-button")?.addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/discussions/new?category=showcase","_external")}),e}r(Nj,"post_process");var yp=class extends uw.Modal{static{r(this,"ScProSupportModal")}open(){super.open(),this.titleEl.setText("Need help and support?");let e=this.contentEl.createDiv({cls:"sc-pro-support-modal"});e.createEl("p",{text:"Reply to your Smart Environment Pro welcome email for priority support."}),e.createEl("button",{text:"Report a bug",cls:"mod-warning"}).addEventListener("click",()=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/issues/new?template=bug_report.yml","_external")}),e.createEl("button",{text:"Close"}).addEventListener("click",()=>{this.close()})}};var mw=`.connections-view-early {
.connections-top-bar {
display: flex;
gap: 0.5rem 1rem;

.connections-actions {
display: flex;
flex-direction: row;
flex-wrap: wrap;
flex: 0 0 auto;
}

.sc-context {
display: flex;
flex-direction: column;
margin: 0;
gap: 0.1rem;
width: auto;
flex: 1 1 auto;

.sc-context-line {
line-height: 1.1;
}

.sc-context-line--parent {
color: var(--text-muted);
font-size: 0.85em;
}

.sc-context-line--focus {
color: var(--text-normal);
font-size: 1.05em;
font-weight: 600;
}
}
}
.connections-list {
padding-top: 0.85rem;

> .sc-collapsed ul {
display: none;
}
> .sc-collapsed span svg {
transform: rotate(-90deg);
}
> .sc-result-pinned {
box-shadow: 0 0 0 1px var(--interactive-accent);
border-radius: var(--radius-s);
background-color: var(--background-modifier-hover);
}
}
}`;var Mn=require("obsidian");function pw(n){let e=n.key,t="",s="",i=[];if(e.includes("#")){if(i=e.split("#"),s=i.pop().trim(),s[0]==="{"){let o=n.lines.join("-");s=i.pop().trim()+` Lines: ${o}`}t=i.filter(Boolean).join("#")}else e.includes("/")&&(i=e.split("/"),s=i.pop().trim());return t=i.filter(Boolean).join(" \u203A "),[t,s]}r(pw,"get_context_lines");async function hw(n){let s=n.target.closest(".connections-view")?.querySelector(".connections-list")?.dataset?.key;console.log(`Refreshing smart connections view entity ${s}`);let i=this.env.smart_sources.get(s);i?(await i.read(),i.queue_import(),await i.collection.process_source_import_queue?.(),this.render_view(i)):console.warn("No entity found for refresh")}r(hw,"connections_view_refresh_handler");async function Ij(n,e={}){let t=!!n.paused;return`<div><div class="connections-view connections-item-view sc-connections-view connections-view-early">
<div class="sc-top-bar connections-top-bar">
<div class="connections-actions">
${[{title:t?"Resume auto-refresh":"Pause auto-refresh",icon:t?"play-circle":"pause-circle",attrs:`data-action="toggle-pause" aria-pressed="${t}"`},{title:"More actions",icon:"menu",attrs:'data-action="open-menu"'}].map(a=>`
<button
aria-label="${a.title}"
${a.attrs??""}
>
${this.get_icon_html(a.icon)}
</button>
`).join("")}
</div>
<p class="sc-context" data-key="">
Loading...
</p>
</div>
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div></div>`}r(Ij,"build_html");async function fw(n,e={}){let t=await Ij.call(this,n,e),s=this.create_doc_fragment(t);this.apply_style_sheet(mw);let i=s.querySelector(".sc-connections-view");return Mj.call(this,n,i,e),s}r(fw,"render");async function Mj(n,e,t={}){let s=e.querySelector(".connections-list-container"),i=e.querySelector(".sc-top-bar .sc-context"),o=n.env,a=t.connections_item;if(!a)return s.textContent="No source item detected for current active view.",e;let c=a.connections||o.connections_lists.new_item(a);if(!e._has_listeners){e._has_listeners=!0,e.querySelector('[data-action="toggle-pause"]')?.addEventListener("click",()=>{n.toggle_connections_paused()});let v=r(()=>{Be.open(n.plugin,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=connections-view-help#page=understanding-connections-1"})},"open_help");e.querySelector('[data-action="open-menu"]')?.addEventListener("click",S=>{let A=new Mn.Menu(n.plugin.app),$=Array.isArray(c?.results)?c.results:[],j=c?.item?.data?.connections||{},C=Uo($,j);A.addItem(x=>{x.setTitle("Refresh connections").setIcon("refresh-cw").onClick(()=>{hw.call(n,{target:e})})}),A.addItem(x=>{let m=ol({source_item:a,results:C});x.setTitle("Send results to Smart Context").setIcon("briefcase").setDisabled(!m.length).onClick(async()=>{if(!m.length)return new Mn.Notice("No connection results to send to Smart Context");let h=o.smart_contexts.new_context();h.add_items(m),h.emit_event("context_selector:open"),c.emit_event("connections:sent_to_context")})}),A.addItem(x=>{let m=Pn(C);x.setTitle("Copy as list of links").setIcon("copy").setDisabled(!m).onClick(async()=>{if(!m)return new Mn.Notice("No connection results to copy");await at(m),new Mn.Notice("Connections links copied to clipboard"),c.emit_event("connections:copied_list")})}),A.addItem(x=>{let h=(t.connections_settings??c?.settings)?.expanded_view,w=h?"Collapse all results":"Expand all results",q=h?"fold-vertical":"unfold-vertical";x.setTitle(w).setIcon(q).onClick(()=>{let E=t.connections_settings??c?.settings,O=E?.expanded_view;E&&(E.expanded_view=!O),e.querySelectorAll(".sc-result").forEach(N=>{O?N.classList.add("sc-collapsed"):N.classList.remove("sc-collapsed")})})}),A.addSeparator(),A.addItem(x=>{x.setTitle("Connections settings").setIcon("settings").onClick(()=>{n.open_settings()})}),A.addItem(x=>{x.setTitle("Help & getting started").setIcon("help-circle").onClick(v)}),A.showAtMouseEvent(S)})}let l=t.connections_list_component_key||c.connections_list_component_key||"connections_list_v3",d=await o.smart_components.render_component(l,c,t);this.empty(s),s.appendChild(d);let _=c?.item||a,[u,p]=pw(_);this.empty(i);let f=i.ownerDocument;[{text:u,class_name:"sc-context-line sc-context-line--parent"},{text:p,class_name:"sc-context-line sc-context-line--focus"}].forEach(k=>{let v=f.createElement("span");v.className=k.class_name,v.textContent=k.text||"\xA0",i.appendChild(v)}),i.dataset.key=a.key;let g=e.querySelector('[data-action="toggle-pause"]');if(g){let k=r(v=>{let y=v?"Resume auto-refresh":"Pause auto-refresh";g.title=y,g.setAttribute("aria-label",`${y}`),g.setAttribute("aria-pressed",String(v)),this.safe_inner_html(g,this.get_icon_html(v?"play-circle":"pause-circle"))},"update_pause_button");k(!!n.paused),n.register_pause_controls({update:k})}return e}r(Mj,"post_process");var gw=new CSSStyleSheet;gw.replaceSync(`.lookup-item-view{display:flex;flex-direction:column;gap:1rem}.lookup-item-view .lookup-query-form{display:flex;flex-direction:column;gap:.5rem}.lookup-item-view .lookup-query-label{font-size:.75rem;font-weight:600;letter-spacing:.03em;text-transform:uppercase;color:var(--text-muted)}.lookup-item-view .lookup-query-input{resize:vertical;min-height:5rem;padding:.75rem;border-radius:var(--radius-m);border:1px solid var(--background-modifier-border);background-color:var(--background-secondary);color:var(--text-normal);font-size:.95rem;line-height:1.5}.lookup-item-view .lookup-query-input:focus{outline:none;border-color:var(--interactive-accent);box-shadow:0 0 0 2px color-mix(in srgb,var(--interactive-accent) 30%,transparent)}.lookup-item-view .lookup-list-container{display:flex;flex-direction:column;gap:.5rem}
`);var yw=gw;var Lj=300,zj="Enter a lookup query to continue.",Dj="Describe the idea, topic, or question you want to explore\u2026",bp="Use semantic (embeddings) search to surface relevant notes. Results are sorted by similarity to your query. Note: returns different results than lexical (keyword) search.";async function Rj(n,e={}){return`<div><div class="lookup-item-view sc-connections-view connections-view-early">
<form class="lookup-query-form" novalidate>
<label class="lookup-query-label" for="lookup-query-input" title="${bp}">Smart Lookup</label>
<textarea
class="lookup-query-input"
id="lookup-query-input"
name="lookup-query"
rows="4"
placeholder="${Dj}"
required
></textarea>
</form>
<div class="lookup-list-container">
<p>${bp}</p>
</div>
</div></div>`}r(Rj,"build_html");async function bw(n,e={}){this.apply_style_sheet(yw);let t=await Rj.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".lookup-item-view");return Fj.call(this,n,i,e),i}r(bw,"render");async function Fj(n,e,t={}){let s=e.querySelector(".lookup-query-input"),i=e.querySelector(".lookup-query-form"),o=e.querySelector(".lookup-list-container"),a={last_query:null},c=r(async d=>{let _=Uj(d);if(Wj({input_el:s,query:_}),!_){this.empty(o),o.innerHTML=`<p>${bp}</p>`;return}if(_===a.last_query)return;a.last_query=_;let u={...t,query:_},p=n.env.lookup_lists.new_item(u),f=await n.env.render_component("lookup_list",p,u);this.empty(o),o.appendChild(f)},"submit_query"),l=Bj(c);return s.addEventListener("input",()=>{l(s.value)}),i.addEventListener("submit",d=>{d.preventDefault(),l.cancel?.(),c(s.value)}),e}r(Fj,"post_process");function Bj(n,e=Lj){let t,s=r(i=>{t&&clearTimeout(t),t=setTimeout(()=>{t=void 0,n(i)},e)},"schedule");return s.cancel=()=>{t&&(clearTimeout(t),t=void 0)},s}r(Bj,"create_debounced_submit");function Uj(n){return typeof n!="string"?"":n.trim()}r(Uj,"sanitize_query");function Wj({input_el:n,query:e}){n?.setCustomValidity&&(e?n.setCustomValidity(""):n.setCustomValidity(zj))}r(Wj,"update_query_validity");async function Gj(n,e={}){return`<div><div class="lookup-list connections-list sc-list" data-key="${n.item.key}"></div></div>`}r(Gj,"build_html");async function vw(n,e={}){let t=await Gj.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".lookup-list");return Hj.call(this,n,i,e),i}r(vw,"render");async function Hj(n,e,t={}){e.dataset.key=n.key;let s=await n.get_results(t);if(!s||!Array.isArray(s)||s.length===0){let a=this.create_doc_fragment('<p class="sc-no-results">No results found</p>');return e.appendChild(a),e}let i=n.env.smart_components;return(await Promise.all(s.map(a=>i.render_component("connections_list_item_v3",a,{event_key_domain:"lookup",...t})))).forEach(a=>e.appendChild(a)),e}r(Hj,"post_process");function al(n){n.limit||(n.limit=this.settings?.results_limit??20),n.results_collection_key||(n.results_collection_key=this.collection.results_collection_key),n.filter||(n.filter={}),n.score_algo_key||(n.score_algo_key=this.collection.score_algo_key),n.to_item=this.item,n.filter.exclude_keys||(n.filter.exclude_keys=[]),n.filter.exclude_key_starts_with_any||(n.filter.exclude_key_starts_with_any=[]),Jj(this,n);let e=new Set(n.filter.exclude_keys);if(e.add(this.item.key),n.hidden_keys.forEach(t=>e.add(t)),n.pinned_keys.forEach(t=>e.add(t)),n.filter.exclude_keys=Array.from(e),n.results_collection_key==="smart_blocks"){let t=new Set(n.filter.exclude_key_starts_with_any);t.add(this.item.key),n.hidden_keys.forEach(s=>t.add(s)),n.pinned_keys.forEach(s=>t.add(s)),n.filter.exclude_key_starts_with_any=Array.from(t),this.collection.settings.exclude_frontmatter_blocks&&((!n.filter.exclude_key_ends_with_any||!Array.isArray(n.filter.exclude_key_ends_with_any))&&(n.filter.exclude_key_ends_with_any=[]),n.filter.exclude_key_ends_with_any.push("---frontmatter---"))}}r(al,"pre_process");function Jj(n,e){e.hidden=[],e.hidden_keys=[],e.pinned=[],e.pinned_keys=[];let t=n.item.data?.connections||{};Object.entries(t).forEach(([s,i])=>{if(!i||i.hidden==null&&i.pinned==null)return;let[o,...a]=s.split(":");if(!o||!a.length)return;let c=a.join(":"),l=n.env[o];if(!l)return;let d=l.get(c);d&&(i.hidden&&!i.pinned&&(e.hidden.push(d),e.hidden_keys.push(c)),i.pinned&&(e.pinned.push(d),e.pinned_keys.push(c)))})}r(Jj,"get_connections_feedback_items");var kw={collections:{connections_lists:Hk},item_types:{ConnectionsList:qe},items:{connections_list:{class:qe}},modules:{},components:{connections_codeblock:{render:sw},connections_list_item_v3:{render:aw,settings_config:cw},connections_list_v3:{render:lw,display_name:dw},connections_settings_header:{render:_w},connections_view_v3:{render:fw},lookup_item_view:{render:bw},lookup_list:{render:vw}},actions:{connections_list_pre_process:{action:al,pre_process:al}}};var vp=require("obsidian");async function ww(n,e,t=null,s={}){let{new_tab:i=!1}=s,o=n.env;e.endsWith("#")&&(e=e.slice(0,-1));let a,c=null;if(e.includes("#")){let[d]=e.split("#");a=n.app.metadataCache.getFirstLinkpathDest(d,""),c=o.smart_blocks.get(e)}else a=n.app.metadataCache.getFirstLinkpathDest(e,"");if(!a){console.warn(`[open_note] Unable to resolve file for ${e}`);return}let l;if(t){let d=vp.Keymap.isModEvent(t),_=vp.Keymap.isModifier(t,"Alt");d&&_?l=n.app.workspace.splitActiveLeaf("vertical"):d||i?l=n.app.workspace.getLeaf(!0):l=n.app.workspace.getMostRecentLeaf()}else l=n.app.workspace.getMostRecentLeaf();if(await l.openFile(a),typeof c?.line_start=="number"){let{editor:d}=l.view,_={line:c.line_start,ch:0};d.setCursor(_),d.scrollIntoView({to:_,from:_},!0)}}r(ww,"open_note");var cl=class extends Lo{static{r(this,"ScEarlySettingsTab")}constructor(e,t){super(e,t),this.plugin=t}hide(){super.hide?.(),this.plugin_container?.empty?.(),this.turn_off_listener?.()}async render_header(e){let t=await this.env.smart_components.render_component("connections_settings_header",this.plugin);e.appendChild(t)}async render_plugin_settings(e){if(!e)return;e.empty?.(),e.innerHTML='<div class="sc-loading">Loading main settings...</div>',e.empty?.();let t=e.createDiv({cls:"sc-settings-tab__section",attr:{"data-section-key":"connections_lists"}});t.createEl("h1",{text:"Connections"});let s=this.env.config.collections.connections_lists.settings_config;Cs(s,this.env.connections_lists,t,{default_group_name:"Connections lists",group_params:{"Connections lists":{heading_btn:[{label:"Learn about Connections Lists",btn_text:"Learn more",callback:r(()=>window.open("https://smartconnections.app/smart-connections/list-feature/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for Connections Lists",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#connections-lists","_external"),"callback")}]},Display:{heading_btn:{label:"Settings documentation for Display",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#display","_external"),"callback")}},"Score algorithm":{heading_btn:{label:"Settings documentation for Score Algorithms",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#score-algorithm","_external"),"callback")}},"Ranking algorithm":{heading_btn:{label:"Settings documentation for Ranking Algorithms",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#ranking-algorithm","_external"),"callback")}},Filters:{heading_btn:{label:"Settings documentation for Filters",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#filters","_external"),"callback")}},"Inline connections":{heading_btn:[{label:"Learn about the inline connections feature",btn_text:"Learn more",callback:r(()=>window.open("https://smartconnections.app/smart-connections/inline/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for inline connections",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#inline-connections","_external"),"callback")}]},"Footer connections":{heading_btn:{label:"Settings documentation for Footer Connections",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#footer-connections","_external"),"callback")}}}});let i=e.createDiv({cls:"sc-settings-tab__section",attr:{"data-section-key":"lookup_lists"}}),o=this.env.config.collections.lookup_lists.settings_config;Cs(o,this.env.lookup_lists,i,{default_group_name:"Lookup lists",group_params:{"Lookup lists":{heading_btn:[{label:"Learn about Lookup Lists",btn_text:"Learn more",callback:r(()=>window.open("https://smartconnections.app/smart-connections/lookup/?utm_source=connections-settings-tab","_external"),"callback")},{label:"Settings documentation for Lookup Lists",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-connections/settings/?utm_source=connections-settings-tab#lookup-lists","_external"),"callback")}]}}}),this.register_env_events()}register_env_events(){this.turn_off_listener||!this.env?.events||(this.turn_off_listener=this.env.events.on("settings:changed",e=>{(e.path?.includes("connections_post_process")||e.path?.includes("score_algo_key")||e.path?.includes("connections_list_item"))&&this.render_plugin_settings(this.plugin_container)}))}};var Ew=require("obsidian");var ll=require("obsidian");var Ht=class extends ll.ItemView{static{r(this,"SmartItemView")}constructor(e,t){super(e),this.app=t.app,this.plugin=t}static get view_type(){throw new Error("view_type must be implemented in subclass")}static get display_text(){throw new Error("display_text must be implemented in subclass")}static get icon_name(){return"smart-connections"}static register_item_view(e){let t=this;e.registerView(t.view_type,l=>new t(l,e)),e.addCommand({id:t.view_type,name:"Open: "+t.display_text+" view",callback:r(()=>{t.open(e.app.workspace)},"callback")});let s=t.view_type.replace(/^smart-/,"").replace(/-/g,"_"),i="open_"+s;Object.getOwnPropertyDescriptor(e,s)||Object.defineProperty(e,s,{configurable:!0,enumerable:!1,get:r(()=>t.get_view(e.app.workspace),"get")}),e[i]=()=>t.open(e.app.workspace);let o=`${s}:open`,a=r(l=>{let d=typeof l?.active=="boolean"?l.active:!0;t.open(e.app.workspace,d)},"handler"),c=e?.env?.events.on(o,a);return typeof e.register=="function"&&typeof c=="function"&&e.register(()=>c()),{method_name:s,open_method_name:i,event_name:o}}static get_leaf(e){return e.getLeavesOfType(this.view_type)[0]}static get_view(e){let t=this.get_leaf(e);return t?t.view:void 0}static open(e,t={}){let{active:s=!0}=t,i=this.get_leaf(e);this.default_open_location==="root"?i?i.setViewState({type:this.view_type,active:s}):e.getLeaf(!1).setViewState({type:this.view_type,active:s}):(i?i.setViewState({type:this.view_type,active:s}):e.getRightLeaf(!1).setViewState({type:this.view_type,active:s}),e.rightSplit?.collapsed&&e.rightSplit.toggle()),setTimeout(()=>{this.get_view(e)?.render_view(t)},100)}static is_open(e){return this.get_leaf(e)?.view instanceof this}getViewType(){return this.constructor.view_type}getDisplayText(){return this.constructor.display_text}getIcon(){return this.constructor.icon_name}async onOpen(){this.app.workspace.onLayoutReady(this.initialize.bind(this))}async initialize(){if(await Nk(this),this.container.empty(),this.register_plugin_events(),this.app.workspace.registerHoverLinkSource(this.constructor.view_type,{display:this.getDisplayText(),defaultMod:!0}),this.render_view(),ll.Platform.isMobile){let e=this.containerEl.querySelector(".status-bar-mobile")??this.containerEl.createDiv({cls:"status-bar-mobile"});e.empty();let t=e.createDiv({cls:"status-bar-item"});this.env.smart_components.render_component("status_bar",this.env).then(s=>t.appendChild(s))}}register_plugin_events(){}render_view(e={}){throw new Error("render_view must be implemented in subclass")}get container(){return this.containerEl.children[1]}get env(){return this.plugin.env}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}};var xw=`> [!NOTE] Patch v4.1.7
> - Added: Links to docs from [milestones](https://smartconnections.app/smart-environment/milestones/?utm_source=release-notes)
> - Added: Include active source item in context created from the connections view
> - Fixed: replaced model source for multilingual E5 Small embedding model to ensure quantized variations available

> [!NOTE]- Previous patches
> > [!NOTE]- v4.1.6
> > - Added: milestones feature with modal and checklist components
> > - Added: connections view menu option to copy results as links
> > - Added: multilingual-e5-small embedding model support
> > - Improved: settings tab with added "learn more" and "help" buttons to settings groups
> > - Fixed: markdown parser should handle frontmatter correctly (prevent false-positive frontmatter detection)
>
> > [!NOTE]- v4.1.4
> > - Added fallback for opening Pro login in case the button doesn't automatically open the browser as expected
>
> > [!NOTE]- v4.1.3
> > - Added link to documentation in settings for easier access
> > - Fixed highlight "Reset data" after embedding model change
>
> > [!NOTE]- v4.1.2
> > - Improved model configuration UX
> >   - Added "Delete" functionality to better manage models
> > - Enhanced UI for settings and improved styling
> > - Pro: Updated score algorithm settings to clarify descriptions
>
> > [!NOTE]- v4.1.1
> > - Connections codeblock view should render as expected without errors
>
>
# Smart Connections \`v4\`\r
\r
## What's new in v4\r
\r
Smart Connections v4 focuses the core plugin on a simple promise: install, enable, and AI-powered connections just work. Advanced configuration and power-user workflows now live in Pro plugins. Read [Introducing Pro Plugins](https://smartconnections.app/introducing-pro-plugins/?utm_source=connections-release-notes) to learn more.\r
\r
### Pause connections\r
\r
Use the new Connections "pause" button to freeze the connections results. This allows you to move through your vault while keeping the connections to a specific note visible while you work.\r
\r
### Copy connections as list of links\r
\r
Right-click the connections results to *copy all links* to clipboard.\r
\r
### Copy all connections content (Context Engineering)\r
\r
Click the connections view menu button and "Send to Smart Context" (briefcase icon) option. This allows you to quickly copy *all content from the connections* to clipboard for use as context with any AI chat! The Smart Context view also lets you add or remove items before copying all to the clipboard in one-click!\r
\r
### Pinned connections\r
\r
In addition to "hiding" connections, you can now "Pin" connections. This ensures the pinned connections are always visible in the connections view. **Connections Pro:** *Hidden and pinned connections are used by new connections algorithms (available in Pro) to improve results!*\r
\r
### Events and notifications\r
\r
Important events are now surfaced in a dedicated notifications modal:\r
\r
- On desktop, click the Smart Env item in the status bar to open the notifications modal.  \r
- On mobile, a Smart Environment notice appears at the bottom of the Connections view; tap it to review events.\r
\r
Examples of events you might see:\r
\r
- Initial indexing complete for your vault  \r
- Sources reimported after model changes  \r
- Warnings when exclusions block indexing on specific folders or files  \r
\r
Objectives of the new Events system:\r
\r
- make the environment inspectable and understandable\r
- reduce the number of Obsidian native notifications\r
\r
### Connections Pro\r
\r
Connections Pro builds on the core plugin and Smart Environment to give power users more control.\r
\r
![](https://smartconnections.app/assets/connections-view-pro-notes.gif)\r
\r
Examples of Pro features:\r
\r
- **Inline connections**  \r
Small badges in the editor that show how many strong matches a block has, with a pop-over of related blocks and notes.  \r
- **Footer connections**  \r
A persistent panel that updates as you type so high value connections stay visible while you write.  \r
- **Configurable scoring and ranking**  \r
Choose different algorithms for how results are scored and optionally add a rerank stage.  \r
- **Connections in Bases**  \r
Use \`score_connection\` and \`list_connections\` in Obsidian Bases to show similarity columns and related note lists in tables.  \r
- **Advanced filters and models**  \r
Extra Smart Environment controls for embeddings, collections, and include or exclude rules.  \r
- **Early release experiments**  \r
New ideas launch in Early channels first so supporters can shape how they evolve.\r
\r
Connections Pro is part of the [Pro plugins](https://smartconnections.app/pro-plugins/?utm_source=connections-release-notes) family and is available to active project supporters. It is still built on the same open Smart Environment. Supporting Pro helps fund development of all Smart Plugins and the free core.
`;var Ln=class n extends Ht{static{r(this,"ReleaseNotesView")}static get view_type(){return"smart-release-notes-view"}static get display_text(){return"Release Notes"}static get icon_name(){return"file-text"}static open(e,t,s=!0){e.getLeaf("tab").setViewState({type:this.view_type,active:s,state:{version:t}})}getViewType(){return n.view_type}getDisplayText(){return n.display_text}getIcon(){return n.icon_name}onOpen(){this.titleEl.setText(`What\u2019s new in v${this.version}`),this.render()}get container(){let e=this.containerEl?.querySelector(".view-content"),t=e?.querySelector(".markdown-preview-view");return t||(t=e?.createDiv("cm-scroller is-readable-line-width")?.createDiv("markdown-preview-view markdown-rendered")),t}async render(){for(;!this.container;)await new Promise(e=>setTimeout(e,100)),console.warn("Waiting for containerEl to be ready...",this.container);await Ew.MarkdownRenderer.render(this.app,xw,this.container,"",this),this.container.querySelectorAll("a").forEach(e=>{e.setAttribute("target","_external")}),requestAnimationFrame(()=>this.#t(this.container,this.version))}get version(){return this.leaf.viewState?.state?.version??this.app.plugins.getPlugin("smart-connections")?.manifest.version??""}#t(e,t){if(!t)return;let s=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`\\bv?${s}\\b`,"i");e.querySelectorAll("h1,h2,h3,h4,h5,h6").forEach(o=>{i.test(o.textContent??"")&&o.scrollIntoView({behavior:"smooth",block:"start"})})}};async function Sw(n,e,{rng:t=Math.random}={}){if(!n?.smart_sources||!e)return null;let s=n.smart_sources.get(e);if(!s?.should_embed)return null;let i=await s.connections.get_results({limit:20});return!Array.isArray(i)||i.length===0?null:Vj(i,{rng:t})}r(Sw,"get_random_connection");function Vj(n,{rng:e}){let t=n.map(a=>({connection:a,score:Math.max(0,typeof a?.score=="number"?a.score:0)})),s=t.reduce((a,{score:c})=>a+c,0);if(s===0)return n[0];let i=e()*s,o=0;for(let{connection:a,score:c}of t)if(o+=c,i<o)return a;return n.at(-1)}r(Vj,"pick_weighted_connection");var Aw=require("obsidian");function Cw(){(0,Aw.addIcon)("smart-dice",`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
<rect x="1" y="1" width="22" height="22" rx="2" fill="none"/>

<g transform="translate(12 10) scale(0.18) translate(-50 -50)">
<path d="M50 20 L80 40 L80 60 L50 100" fill="none" stroke="currentColor" stroke-width="4"/>
<path d="M30 50 L55 70" fill="none" stroke="currentColor" stroke-width="5"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="75" cy="40" r="9" fill="currentColor"/>
<circle cx="75" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="25" cy="50" r="9" fill="currentColor"/>
</g>
</svg>
`)}r(Cw,"add_smart_dice_icon");function qw(n,e){let t=!!e;return n.paused=t,n.pause_controls?.update?.(t),t}r(qw,"apply_pause_state");function Ow(n){let e=!n.paused;return n.paused=e,n.pause_controls?.update?.(e),e}r(Ow,"toggle_pause_state");var _l=class extends Ht{static{r(this,"ConnectionsItemView")}static get view_type(){return"smart-connections-view"}static get display_text(){return"Connections"}static get icon_name(){return"smart-connections"}constructor(e,t){super(e,t),this.paused=!1,this.pause_controls=null,this.current=null}async render_view(e={},t=this.container){if(!e.connections_item){let i=this.plugin.app.workspace.getActiveFile()?.path;e.connections_item=this.env.smart_sources.get(i)}this.current=e.connections_item,this.pause_controls=null;let s=await this.env.smart_components.render_component("connections_view_v3",this,{connections_item:e.connections_item});t.empty(),t.appendChild(s),this.register_env_listeners(),this.env.events.emit("connections:opened")}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}register_env_listeners(){let e;dl(this,"sources:opened",(t={})=>{if(this.paused||!kp(this.container))return;let s=this.env[t.collection_key||"smart_sources"]?.get(t.item_key||t.key);s.key!==this.current?.key&&(e&&clearTimeout(e),e=setTimeout(()=>{this.render_view({connections_item:s})},250))}),dl(this,"settings:changed",t=>{t.path?.includes("expanded_view")||t.path?.includes("connections_lists")&&kp(this.container)&&this.render_view({connections_item:this.current})}),dl(this,"connections:show",t=>{if(console.log("connections:show event received",{event:t}),t.collection_key&&t.item_key){let s=this.env[t.collection_key],i=s.get(t.item_key);console.log({collection:s,item:i}),i&&(this.set_connections_paused(!0),this.render_view({connections_item:i}))}}),dl(this,"item:embedded",t=>{t.item_key===this.current?.key&&kp(this.container)&&this.render_view({connections_item:this.current})})}register_pause_controls(e){this.pause_controls=e,this.pause_controls?.update(this.paused)}set_connections_paused(e){return qw(this,e)}toggle_connections_paused(){return Ow(this)}};function kp(n){return n?n.isConnected?typeof n.checkVisibility=="function"&&n.checkVisibility()===!1?(console.log("Connections container is not visible"),!1):!0:(console.warn("Connections container is not connected to DOM"),!1):!1}r(kp,"is_visible");var wp=new WeakMap,Kj=r(n=>(wp.has(n)||wp.set(n,new Map),wp.get(n)),"get_registry"),dl=r((n,e,t)=>{if(!n||typeof n.env?.events?.on!="function")return console.warn("View or event system not available for registering event listener"),()=>{};let s=Kj(n),i=s.get(e);typeof i=="function"&&i();let o=n.env.events.on(e,l=>{t(l)}),a=!0,c=r(()=>{a&&(a=!1,o?.(),s.get(e)===c&&s.delete(e))},"dispose");return s.set(e,c),typeof n.register=="function"&&n.register(()=>c()),c},"register_env_event_listener");var ul=class extends Ht{static{r(this,"LookupItemView")}static get view_type(){return"smart-lookup-view"}static get display_text(){return"Lookup"}static get icon_name(){return"smart-lookup"}async render_view(e,t=this.container){let s=await this.env.render_component("lookup_item_view",this,e);t.empty(),t.appendChild(s)}};async function $w(n){n.registerMarkdownCodeBlockProcessor("smart-connections",async(e,t,s)=>{t.empty(),t.createEl("span",{text:"Loading\u2026"});let i=JSON.parse(e.trim()||"{}"),o=n.env,a=o.smart_sources.get(s.sourcePath)??o.smart_sources.init_file_path(s.sourcePath),c=o.smart_view;if(!a){t.empty(),t.createEl("p",{text:"Entity not found: "+s.sourcePath});return}let l=r(async()=>{let d=a.connections;if(!d?.env){t.empty(),t.createEl("p",{text:"Smart Environment / Connections loading\u2026"}),t.createEl("button",{text:"Retry"}).addEventListener("click",()=>{l()});return}let _=await n.env.smart_components.render_component("connections_codeblock",d,{...i});t.empty(),t.appendChild(_)},"render_codeblock");if(!t._has_listeners){t._has_listeners=!0;let d=[];d.push(o.events.on("settings:changed",_=>{console.log("connections codeblock view detected settings change",_),_.path?.includes("connections_lists")&&l()})),c.attach_disposer(t,d)}l()})}r($w,"register_smart_connections_codeblock");function jw(n=null){return`\`\`\`smart-connections
${n?JSON.stringify(n,null,2):""}
\`\`\`
`}r(jw,"build_connections_codeblock");var{Notice:Tw,Plugin:KQ,requestUrl:Yj,Platform:YQ}=xp.default,Go=class extends zo{static{r(this,"SmartConnectionsPlugin")}SmartEnv=qs;get smart_env_config(){return this._smart_env_config||(this._smart_env_config=kw),this._smart_env_config}ConnectionsSettingsTab=cl;get item_views(){return{ConnectionsItemView:_l,LookupItemView:ul,ReleaseNotesView:Ln}}get obsidian(){return xp.default}get api(){return this._api}onload(){this.app.workspace.onLayoutReady(this.initialize.bind(this)),this.SmartEnv.create(this,this.smart_env_config),this.addSettingTab(new this.ConnectionsSettingsTab(this.app,this)),Cw(),this.register_commands(),this.register_item_views(),this.register_ribbon_icons()}onunload(){console.log("Unloading Smart Connections plugin"),this.notices?.unload(),this.env?.unload_main?.(this)}async initialize(){this.smart_connections_view=null,this.is_new_user().then(async e=>{e&&(setTimeout(()=>{Be.open(this,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-new-user"})},1e3),await this.SmartEnv.wait_for({loaded:!0}),setTimeout(()=>{this.open_connections_view(),this.app.workspace.rightSplit.collapsed&&this.app.workspace.rightSplit.toggle()},1e3),this.add_to_gitignore(`

# Ignore Smart Environment folder
.smart-env`))}),await this.SmartEnv.wait_for({loaded:!0}),$w(this),await this.check_for_updates()}get ribbon_icons(){return{connections:{icon_name:"smart-connections",description:"Smart Connections: Open connections view",callback:r(()=>{this.open_connections_view()},"callback")},lookup:{icon_name:"smart-lookup",description:"Smart Lookup: Open lookup view",callback:r(()=>{this.open_lookup_view()},"callback")},random_note:{icon_name:"smart-dice",description:"Smart Connections: Open random connection",callback:r(()=>{this.open_random_connection()},"callback")}}}get settings(){return this.env?.settings||{}}async check_for_updates(){if(await this.is_new_plugin_version(this.manifest.version)){console.log("opening release notes modal");try{Ln.open(this.app.workspace,this.manifest.version)}catch(e){console.error("Failed to open ReleaseNotesView",e)}await this.set_last_known_version(this.manifest.version)}setTimeout(this.check_for_update.bind(this),3e3),setInterval(this.check_for_update.bind(this),108e5)}async check_for_update(){try{let{json:e}=await Yj({url:"https://api.github.com/repos/brianpetro/obsidian-smart-connections/releases/latest",method:"GET",headers:{"Content-Type":"application/json"},contentType:"application/json"}),t=e.tag_name;t!==this.manifest.version&&(this.env?.events?.emit("plugin:new_version_available",{version:t}),this.notices?.show("new_version_available",{version:t}),this.update_available=!0)}catch(e){console.error(e)}}async restart_plugin(){this.env?.unload_main?.(this),await new Promise(e=>setTimeout(e,3e3)),window.restart_plugin=async e=>{await window.app.plugins.disablePlugin(e),await window.app.plugins.enablePlugin(e)},await window.restart_plugin(this.manifest.id)}get commands(){return{...super.commands,random_connection:{id:"smart-connections-random",name:"Open: Random note from connections",callback:r(async()=>{await this.open_random_connection()},"callback")},getting_started:{id:"smart-connections-getting-started",name:"Show: Getting started slideshow",callback:r(()=>{Be.open(this,{title:"Getting Started With Smart Connections",url:"https://smartconnections.app/story/smart-connections-getting-started/?utm_source=sc-op-command"})},"callback")},insert_connections_codeblock:{id:"insert-connections-codeblock",name:"Insert: Connections codeblock",editorCallback:r(e=>{e.replaceSelection(jw())},"editorCallback")}}}show_release_notes(){return Ln.open(this.app.workspace,this.manifest.version)}async open_random_connection(){let e=this.app.workspace.getActiveFile();if(!e){new Tw("No active file to find connections for");return}let t=await Sw(this.env,e.path);if(!t){new Tw("Cannot open random connection for non-embedded source: "+e.path);return}this.open_note(t.item.path),this.env?.events?.emit?.("connections:open_random")}async open_note(e,t=null){await ww(this,e,t)}async add_to_gitignore(e,t=null){if(!await this.app.vault.adapter.exists(".gitignore"))return;(await this.app.vault.adapter.read(".gitignore")).indexOf(e)<0&&(await this.app.vault.adapter.append(".gitignore",`

${t?"# "+t+`
`:""}${e}`),console.log("Added to .gitignore: "+e))}};var Nw=require("@codemirror/view"),Pw=require("@codemirror/state"),$s=Pw.StateEffect.define(),Iw=Nw.ViewPlugin.fromClass(class{constructor(n){this.view=n,this.connections_pro_frag=null,this.container_el=null,this.collapsed_notice_el=null,this.pro_header=null,this.search_result_container=null}destroy(){this.container_el?.isConnected&&this.container_el.remove()}update(n){for(let e of n.transactions)for(let t of e.effects)t.is($s)&&(t.value===null?this.container_el&&(this.container_el.style.display="none"):this.render_pro(t.value))}render_pro(n=null){n&&(this.container_el&&this.container_el!==n&&this.container_el.isConnected&&this.container_el.remove(),this.connections_pro_frag=n,this.container_el=n,this._listeners_bound=!1,this.#t(),this.#e()),this.container_el&&(this.container_el.style.display=this.connections_pro_frag?"block":"none")}#t(){this.search_result_container=this.container_el?.querySelector(".search-result-container"),this.pro_header=this.container_el?.querySelector(".tree-item-self"),this.collapsed_notice_el=this.container_el?.querySelector(".collapsed-notice"),this.collapse_icon_btn=this.container_el?.querySelector(".nav-action-button")}#e(){if(!this.container_el||this.container_el.isConnected)return;let n=this.view.dom.querySelector(".cm-contentContainer");n?.parentNode?.insertBefore(this.container_el,n.nextSibling)}});var ml=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var pl=class extends ml{static{r(this,"SmartRankModel")}static defaults={adapter:"cohere",model_key:"rerank-v3.5"};async rank(e,t,s={}){return await this.invoke_adapter_method("rank",e,t,s)}get default_model_key(){return"jinaai/jina-reranker-v1-tiny-en"}get settings_config(){let e={adapter:{name:"Ranking Model Platform",type:"dropdown",description:"Select a ranking model platform.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}};var Jt=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Ep={"[ADAPTER].model_key":{name:"Ranking Model",type:"dropdown",description:"Select a ranking model to use.",options_callback:"adapter.get_models_as_options",callback:"reload_model"}},hl=class extends Jt{static{r(this,"SmartRankAdapter")}constructor(e){super(e),this.smart_rank=e}async rank(e,t){throw new Error("rank method not implemented")}get settings_config(){return Ep}};var Ue=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var zn=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},Dn=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var Ho=class extends zn{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new Sp(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},Sp=class extends Dn{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Ct=class extends zn{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new Ap(i)}},Ap=class extends Dn{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var fl=class extends hl{static{r(this,"SmartRankModelApiAdapter")}get endpoint(){return this.model.data.endpoint||this.constructor.defaults.endpoint}get api_key(){return this.model.data.api_key}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Ue({adapter:Ct})),this._http_adapter}async load(){this.model.model_loaded=!0,this.api_key&&this.set_state("loaded")}async request(e,t=0){try{e.throw=!1,e.url=this.endpoint,console.log("API Request:",e);let s=await this.http_adapter.request(e);return console.log("API Response:",s),await this.get_resp_json(s)}catch(s){return await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.rank("test query",["Test document"]);return Array.isArray(e)&&e.length>0&&e[0].score!==null}},gl=class{static{r(this,"SmartRankModelRequestAdapter")}constructor(e,t,s){this.adapter=e,this.query=t,this.documents=s}get_headers(){let e={"Content-Type":"application/json"};return this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`),e}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},yl=class{static{r(this,"SmartRankModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_standard(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Rn=class extends fl{static{r(this,"SmartRankCohereAdapter")}static defaults={adapter:"cohere",description:"Cohere",default_model:"rerank-v3.5",endpoint:"https://api.cohere.ai/v2/rerank"};get req_adapter(){return Cp}get res_adapter(){return qp}async load(){this.model.model_loaded=!0,this.set_state("loaded")}async rank(e,t){let i=new this.req_adapter(this,e,t).to_platform(),o=await this.request(i);return!o||!o.results?{message:o?.message||"Invalid response from Cohere API",resp:o}:new this.res_adapter(this,o).to_standard()}async handle_request_err(e,t,s){if(e&&e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Cohere API rate limit exceeded. Retrying in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error("Cohere API Error:",e),null}get settings_config(){return Xj}get models(){return Zj}},Xj={...Ep,"[ADAPTER].api_key":{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},Zj={"rerank-v3.5":{id:"rerank-v3.5",description:"State-of-the-art performance in English and non-English languages. Supports documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-english-v3.0":{id:"rerank-english-v3.0",description:"English language documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-multilingual-v3.0":{id:"rerank-multilingual-v3.0",description:"Non-English documents and semi-structured data (JSON). Supports same languages as embed-multilingual-v3.0. Context length: 4096 tokens"}},Cp=class extends gl{static{r(this,"SmartRankCohereRequestAdapter")}prepare_request_body(){return{query:this.query,documents:this.documents,model:this.adapter.model_key,top_n:1e3,max_tokens_per_doc:4096}}},qp=class extends yl{static{r(this,"SmartRankCohereResponseAdapter")}parse_response(){return this.response.results?this.response.results.map(e=>({index:e.index,score:e.relevance_score})):(console.error("Invalid response format from Cohere API:",this.response),[])}};var Qj={score_algo_key:{group:"Score algorithm",name:"Scoring algorithm",description:"Calculates a score by comparing each item with the current context.",type:"dropdown",options_callback:r(n=>{console.log("getting score algo options for",{scope:n,_this:void 0});let e=n.get_score_algo_key_options.call(n);return console.log("options",e),e},"options_callback"),scope_class:"pro-setting"},connections_post_process:{group:"Ranking algorithm",name:"Ranking algorithm",description:"Modifies the ranking of connection results after initial scoring. Useful for heavy-processing algorithms that should only be applied to a subset of results produced by the main scoring algorithm (ex. re-ranking models).",type:"dropdown",options_callback:r(n=>n.get_connections_post_process_options(),"options_callback"),scope_class:"pro-setting"},filters_helper:{group:"Filters",type:"html",value:['<p class="setting-item-description"><strong>Filter tips:</strong> Use comma-separated folder or file path fragments such as <code>Projects/Clients</code>. Values are trimmed automatically and compared using case-sensitive substring matches.</p>','<p class="setting-item-description"><strong>Result vs ingestion:</strong> Connections filters only hide results after Smart Environment builds its dataset. To stop notes from being indexed, adjust Smart Environment include/exclude settings in the Environment window or plugin settings.</p>','<p class="setting-item-description"><strong>Precedence:</strong> Entries in the exclude filter always win when they match, even if the same path fragment appears in the include filter.</p>'].join("")},exclude_inlinks:{group:"Filters",name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},exclude_outlinks:{group:"Filters",name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},include_filter:{group:"Filters",name:"Include filter",type:"text",description:"Comma-separated path fragments that must appear in the note path. Matches use case-sensitive substring checks; trim spaces or wrap folder names like `Daily/`. This only affects the results list; Smart Environment still embeds matching notes unless excluded there."},exclude_filter:{group:"Filters",name:"Exclude filter",type:"text",description:"Comma-separated path fragments to omit from results. Exclusions run before includes, so any matching fragment removes the note even if it also appears in `Include filter`. Use Smart Environment include/exclude settings to stop notes from being embedded altogether."},connections_list_component_key:{group:"Display",name:"Connections List Component",type:"dropdown",description:"Select the component used to render the connections list.",options_callback:r(n=>n.get_connections_list_component_options(),"options_callback")},connections_list_item_component_key:{group:"Display",name:"Connections list item",type:"dropdown",description:"Settings for individual connections list items.",options_callback:r(n=>n.get_connections_list_item_options(),"options_callback")},exclude_frontmatter_blocks:{group:"Display",name:"Hide frontmatter blocks in results",type:"toggle",description:"Show only sources in the connections results (no frontmatter blocks)."},inline_connections:{group:"Inline connections",name:"Show inline connections",type:"toggle",description:"Shows connections for each block within the note. Hover connections icon to see list of connections."},inline_connections_score_threshold:{group:"Inline connections",name:"Inline connections score threshold",type:"text",description:"Minimum score (0-1) required before inline connections are displayed."},inline_connections_skip_codeblocks:{group:"Inline connections",name:"Skip code blocks",type:"toggle",description:"Do not show inline connections for blocks inside code blocks."},footer_connections:{group:"Footer connections",name:"Show footer connections",type:"toggle",description:"Show connections at the bottom of each note."}},Op=class extends Fo{static{r(this,"ConnectionsLists")}static version=2;process_load_queue(){}static get default_settings(){return{results_collection_key:"smart_sources",score_algo_key:"similarity",connections_post_process:"none",results_limit:20,inline_connections:!0,inline_connections_score_threshold:"0.77",footer_connections:!1,exclude_frontmatter_blocks:!0,connections_list_component_key:"connections_list_v4",connections_list_item_component_key:"connections_list_item_v3"}}get settings_config(){return Mw(this)}new_item(e){let t=new this.item_type(this.env,{collection_key:e.collection_key,item_key:e.key});return this.set(t),Object.defineProperty(e,"connections",{get:r(()=>t,"get"),configurable:!0}),t}get_score_algo_key_options(){return Object.entries(this.env.config.actions||{}).filter(([,e])=>(e.action?.action_type??e.action_type)==="score").map(([e,t])=>{let s=t.display_name||e;return{value:e,name:s,label:s,description:t.display_description}})}get_connections_post_process_options(){let e=Object.entries(this.env.config.actions||{}).filter(([t,s])=>t.startsWith("connections_list_post_process")).map(([t,s])=>({value:t,name:s.display_name||t,description:s.display_description}));return[{value:"none",name:"None"},...e]}get_connections_list_component_options(){return Object.entries(this.env.config.components||{}).filter(([e,t])=>e.startsWith("connections_list_")&&!e.startsWith("connections_list_item_")).map(([e,t])=>({value:e,name:t.display_name||e,description:t.display_description}))}get score_algo_settings_config(){let e=this.settings.score_algo_key,t=this.env.config.actions[e],s=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return s?Object.fromEntries(Object.entries(s).map(([i,o])=>[`actions.${e}.${i}`,o])):null}get connections_post_process_settings_config(){let e=this.settings.connections_post_process;if(e==="none")return null;let t=this.env.config.actions[e],s=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return s?Object.fromEntries(Object.entries(s).map(([i,o])=>[`actions.${e}.${i}`,o])):null}get connections_list_item_settings_config(){let e=this.settings.connections_list_item_component_key;if(!e||e==="none")return null;let t=this.env.config.components?.[e],s=typeof t?.settings_config=="function"?t.settings_config(this):t?.settings_config;return s?Object.fromEntries(Object.entries(s).map(([i,o])=>[`components.${e}.${i}`,o])):null}get rank_model(){return this.env.ranking_models.default.instance}};function Mw(n){let e={...Qj};n.connections_post_process_settings_config&&(e=sl("connections_post_process",e,n.connections_post_process_settings_config)),n.score_algo_settings_config&&(e=sl("score_algo_key",e,n.score_algo_settings_config)),n.connections_list_item_settings_config&&(e=sl("connections_list_item_component_key",e,n.connections_list_item_settings_config));let t=Object.fromEntries(Object.entries(e).map(([s,i])=>s.endsWith("similarity_algo_description")?[s,i]:(i.scope_class="pro-setting",[s,i])));return{...nl(n),...t}}r(Mw,"settings_config");var Lw={class:Op,collection_key:"connections_lists",item_type:qe,settings_config:Mw};function bl(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(bl,"collection_instance_name_from");function qt(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(zw(e[t])&&zw(n[t])?qt(n[t],e[t]):n[t]=e[t]);return n}r(qt,"deep_merge");function zw(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(zw,"is_plain_object");function Dw(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Dw,"create_uid");function Fn(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(Fn,"camel_case_to_snake_case");function vl(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>vl(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>vl(n[o],e[o],t))}return n===e}r(vl,"deep_equal");function kl(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(kl,"get_item_display_name");function wl(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let q=Object.getOwnPropertyDescriptor(m,w);if(!q)continue;let E={...q};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let q of h){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E){let O=E.value;if(c(O)){w=!0;continue}if(s(O)){if(_(O)){w=!0;continue}return!1}if(typeof O>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),w=new Map;for(let q of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E&&_(E.value)){w.set(q,d(E.value));continue}try{Object.defineProperty(h,q,u(E))}catch{h[q]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:b}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=r((m,h,w=[])=>{if(!m||!h)return;let q=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(q.has(E))continue;let O=Object.getOwnPropertyDescriptor(m,E);if(O)try{Object.defineProperty(h,E,O)}catch{h[E]=O.value}}},"copy_metadata"),y=r(m=>{let h=new m(n),w=h.action||h.run||h.execute||h.call;if(i(w)){let q=w.bind(h);return v(m,q),v(h,q),q.instance=h,q}return v(m,h),h},"instantiate_class"),S=r(m=>{if(o(m))return y(m);if(a(m)){let h=m.action.bind(n);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return v(m,h),h}return s(m)?d(m):m},"bind_or_clone"),A=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=b.get(m);return h&&s(h)?h:null},"scope_actions_for"),$=r((m,h,w)=>(m[h]=w,w),"cache_result"),j=r((m,h)=>{let w=A();return w&&g(w,h)?$(m,h,S(w[h])):g(f,h)?$(m,h,S(f[h])):$(m,h,void 0)},"compute_and_cache"),C=r(()=>{let m=A(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let w=A();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:r(()=>C(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return x(m,h);let w=A();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:r((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(wl,"create_actions_proxy");var ie=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&qt(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Dw(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return qt(s,t),!vl(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:b}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||b&&!b.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=wl(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),bl(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),bl(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Fn(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return kl(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var eT=Object.getPrototypeOf(async function(){}).constructor,oe=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof eT?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return qt(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=wl(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};function xl(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=Rw(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=Rw(n.results);n.min=s,n.minResult=i}}r(xl,"results_acc");function Bw(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=Fw(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=Fw(n.results);n.max=s,n.maxResult=i}}r(Bw,"furthest_acc");function Rw(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(Rw,"find_min");function Fw(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(Fw,"find_max");function We(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(We,"sort_by_score");function El(n,e){return We(n,e)}r(El,"sort_by_score_descending");function Uw(n,e){return We(n,e)*-1}r(Uw,"sort_by_score_ascending");var Vt=class extends ie{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(xl(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(El);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};function Ww(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Bn(l,o),l=$p(l,15),l=Bn(l,a),i^=l,i=$p(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Bn(l,o),l=$p(l,15),l=Bn(l,a),i^=l;break}return i^=n.length,i=tT(i),i|0}r(Ww,"murmur_hash_32");function re(n,e=0){return(Ww(n,e)>>>0).toString(36)}r(re,"murmur_hash_32_alphanumeric");function Bn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Bn,"multiply_32");function $p(n,e){return n<<e|n>>>32-e}r($p,"rotate_left_32");function tT(n){return n^=n>>>16,n=Bn(n,2246822507),n^=n>>>13,n=Bn(n,3266489909),n^=n>>>16,n|0}r(tT,"fmix_32");var Sl={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},jp=class extends oe{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=sT(new Date),i=re(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new Vt(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...Sl}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function sT(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(sT,"format_ymd");var Un={class:jp,collection_key:"lookup_lists",item_type:Vt,settings_config:Sl};var nT={...Sl,results_limit:{type:"number",name:"Results limit",description:"Adjust the number of lookup results displayed (default 20).",scope_class:"pro-setting"}};Un.settings_config=nT;Un.version=2;var Gw=Un;var Hw=new CSSStyleSheet;Hw.replaceSync(`.connections-view-early{.connections-top-bar{display:flex;gap:.5rem 1rem;.connections-actions{display:flex;flex-direction:row;flex-wrap:wrap;flex:0 0 auto}.sc-context{display:flex;flex-direction:column;margin:0;gap:.1rem;width:auto;flex:1 1 auto;.sc-context-line{line-height:1.1}.sc-context-line--parent{color:var(--text-muted);font-size:.85em}.sc-context-line--focus{color:var(--text-normal);font-size:1.05em;font-weight:600}}}.connections-list{padding-top:.85rem;>.sc-collapsed ul{display:none}>.sc-collapsed span svg{transform:rotate(-90deg)}>.sc-result-pinned{box-shadow:0 0 0 1px var(--interactive-accent);border-radius:var(--radius-s);background-color:var(--background-modifier-hover)}}}
`);var Jw=Hw;async function iT(n,e={}){return`<div class="embedded-backlinks">
<div class="backlink-pane" style="position: relative;">
<div class="tree-item-self is-clickable" aria-label="Click to collapse">
<div class="tree-item-inner">Smart Connections</div>
<div class="tree-item-flair-outer">
<span class="tree-item-flair">Pro</span>
</div>
</div>
<div class="search-result-container">
<div class="sc-connections-wrapper">
<div class="connections-view connections-footer-view sc-connections-view connections-view-early">
<div class="connections-list-container"></div>
<div class="connections-bottom-bar"></div>
</div>
</div>
</div>
</div>
</div>`}r(iT,"build_html");async function Vw(n,e={}){let t=await iT.call(this,n,e),s=this.create_doc_fragment(t);this.apply_style_sheet(Jw);let i=s.firstElementChild;return oT.call(this,n,i,e),i}r(Vw,"render");async function oT(n,e,t={}){let s=e.querySelector(".connections-list-container"),i=r(()=>localStorage.getItem("sc_footer_connections_folded")==="true","is_folded"),o=e.querySelector(".is-clickable");o.addEventListener("click",_=>{_.preventDefault(),_.stopPropagation();let u=!i();localStorage.setItem("sc_footer_connections_folded",String(u)),u?(o.setAttribute("aria-label","Click to expand"),o.classList.add("is-collapsed"),s.style.display="none"):(o.setAttribute("aria-label","Click to collapse"),o.classList.remove("is-collapsed"),s.style.display="block")});let a=n.env,c=t.connections_item,l=c.connections||a.connections_lists.new_item(c),d=await a.smart_components.render_component("connections_list_v3",l,t);return this.empty(s),s.appendChild(d),e}r(oT,"post_process");var Kw=new CSSStyleSheet;Kw.replaceSync(`.connections-graph{position:relative;width:100%;block-size:auto;container-type:inline-size}.sc-graph-svg{width:100%;aspect-ratio:1 / 1;height:auto;display:block;border-radius:var(--radius-m);border:1px solid var(--background-modifier-border);background:var(--background-secondary);box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--background-modifier-hover) 50%,transparent)}.sc-graph-details{margin-block-start:10px}.sc-graph-node .sc-graph-node-dot{fill:var(--background-primary);stroke:var(--color-base-100);stroke-width:1.25px;transition:stroke-width .12s ease,stroke .12s ease,fill .12s ease}.sc-graph-node-center .sc-graph-node-dot{fill:color-mix(in srgb,var(--interactive-accent) 18%,var(--background-primary));stroke:var(--interactive-accent);stroke-width:1.5px}.sc-graph-node-hover .sc-graph-node-dot{fill:var(--background-modifier-hover);stroke:var(--text-accent);stroke-width:2px}.sc-score-text{font-size:.8em;fill:var(--text-muted);opacity:.95;pointer-events:none;user-select:none}.sc-graph-node-hover .sc-score-text{display:none}.sc-node-label{font-size:.85em;font-weight:500;fill:var(--nav-item-color);opacity:0;pointer-events:none;user-select:none;paint-order:stroke fill;stroke:color-mix(in srgb,var(--background-primary) 65%,transparent);stroke-width:2px;transition:opacity .12s ease-in-out}.sc-graph-node-hover .sc-node-label{opacity:.96;fill:var(--nav-item-color-active)}.connections-graph .sc-graph-node-center .sc-node-label{display:none!important}.sc-graph-node.sc-result-pinned .sc-graph-node-dot{fill:color-mix(in srgb,var(--interactive-accent) 12%,var(--background-primary));stroke:var(--interactive-accent);stroke-width:2px;filter:drop-shadow(0 0 .25rem color-mix(in srgb,var(--interactive-accent) 50%,transparent))}.sc-graph-node.sc-result-hidden .sc-graph-node-dot{fill:color-mix(in srgb,var(--background-modifier-border) 40%,transparent);stroke:color-mix(in srgb,var(--text-muted) 65%,transparent);stroke-width:1px;opacity:.6}.sc-graph-node.sc-result-hidden .sc-score-text{opacity:.4;fill:var(--text-faint)}.sc-graph-node.sc-result-hidden.sc-graph-node-hover .sc-node-label{opacity:.85;fill:var(--text-faint)}
`);var Yw=Kw;function me(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(me,"cos_sim");function Al(n=""){let e=2166136261;for(let t=0;t<n.length;t++)e^=n.charCodeAt(t),e=Math.imul(e,16777619);return e+=e<<13,e^=e>>>7,e+=e<<3,e^=e>>>17,e+=e<<5,(e>>>0)/4294967295}r(Al,"hash_to_unit");function Xw(n="",e=-Math.PI/2){let t=Al(n);return e+t*Math.PI*2}r(Xw,"seeded_angle");function Zw(n=[]){let e=n.map(c=>Number.isFinite(c)?+c:null),t=e.filter(c=>c!==null);if(!t.length)return{norm:e.map(()=>.5),min:0,max:1};let s=Math.min(...t),i=Math.max(...t),o=i-s||1;return{norm:e.map(c=>c===null?.5:(c-s)/o),min:s,max:i}}r(Zw,"normalize_scores");function Tp(n,e,t){let s=Math.max(0,Math.min(1,Number(n)||0));return Math.round(e+(1-s)*(t-e))}r(Tp,"score_to_radius");function Np(n){return Array.isArray(n)&&n.length>0}r(Np,"is_vec");function rT(n=[]){let e=0;for(let t=0;t<n.length;t++){let s=n[t]||0;e+=s*s}return Math.sqrt(e)}r(rT,"norm");function Jo(n=[]){let e=rT(n);return!Number.isFinite(e)||e===0?null:n.map(t=>t/e)}r(Jo,"to_unit");function aT(n=[]){if(!n.length)return null;let e=n[0].length,t=new Array(e).fill(0),s=0;for(let o of n)if(o){for(let a=0;a<e;a++)t[a]+=o[a]||0;s++}if(!s)return null;let i=t.map(o=>o/s);return Jo(i)}r(aT,"mean_unit");function cT(n){let e=n>>>0;return r(function(){e|=0,e=e+1831565813|0;let s=Math.imul(e^e>>>15,1|e);return s^=s+Math.imul(s^s>>>7,61|s),((s^s>>>14)>>>0)/4294967296},"rand")}r(cT,"prng_from_seed");function Qw(n=[],e=4,t=100,s=1337){let i=n.map(b=>b?Jo(b):null),o=i.map((b,g)=>b?g:-1).filter(b=>b>=0),a=o.length;if(a===0)return{centers:[],assign:new Array(n.length).fill(-1),sims:new Array(n.length).fill(0)};let c=cT(s),l=new Array(a).fill(1),d=[];for(d.push(i[o[Math.floor(c()*a)]]);d.length<Math.min(e,a);){for(let v=0;v<a;v++){let y=i[o[v]],S=-1/0;for(let $ of d){let j=me(y,$);j>S&&(S=j)}let A=1-Math.max(0,Math.min(1,S));l[v]=A*A}let b=l.reduce((v,y)=>v+y,0)||1,g=c()*b,k=0;for(let v=0;v<a;v++)if(g-=l[v],g<=0){k=v;break}d.push(i[o[k]])}let _=new Array(a).fill(-1),u=new Array(a).fill(0);for(let b=0;b<t;b++){let g=!1;for(let y=0;y<a;y++){let S=i[o[y]],A=0,$=-1/0;for(let j=0;j<d.length;j++){let C=me(S,d[j]);C>$&&($=C,A=j)}_[y]!==A&&(_[y]=A,g=!0),u[y]=Math.max(0,Math.min(1,$))}let k=d.map(()=>[]);for(let y=0;y<a;y++)k[_[y]].push(i[o[y]]);let v=d.map((y,S)=>aT(k[S]));for(let y=0;y<d.length;y++)v[y]||(v[y]=d[y]),d[y]=v[y];if(!g)break}let p=new Array(n.length).fill(-1),f=new Array(n.length).fill(0);for(let b=0;b<a;b++)p[o[b]]=_[b],f[o[b]]=u[b];return{centers:d,assign:p,sims:f}}r(Qw,"kmeans_cosine_unit");function ex(n,e,t=[100,100,100,100]){return[Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4].map((i,o)=>{let a=t[o]??t[t.length-1]??100;return{x:Math.round(n+a*Math.cos(i)),y:Math.round(e+a*Math.sin(i))}})}r(ex,"quadrant_anchors");function tx(n,e,t){if(!Number.isFinite(n)||!Number.isFinite(e)||!Number.isFinite(t)||e>=t)return .45;let s=1-(n-e)/(t-e);return .45+.55*Math.max(0,Math.min(1,s))}r(tx,"radial_strength_for");function sx(n,e,t=24){let s=Math.max(1,Number(n)||100),i=Math.max(1,Number(e)||s),o=Math.min(s,i)/2,a=Math.round(o*.18),c=Math.max(12,a),l=Math.round(s*.45),d=Math.max(c+8,l);return{min_r:c,outer_r:d,half_min:o}}r(sx,"compute_radii");function nx(n="",e=70){let t=String(n??""),s=Math.max(0,Number.isFinite(e)?Math.floor(e):0);if(!s)return"";if(t.length<=s)return t;if(s<=3)return t.slice(0,s);let i="\u2026",o=s-i.length,a=Math.ceil(o/2),c=o-a;return`${t.slice(0,a)}${i}${t.slice(t.length-c)}`}r(nx,"truncate_middle");function ix(n,e={}){let{center_x:t=0,label_width:s=0,view_width:i=0,radius:o=0,margin:a=10}=e,c=Math.max(2,a),l=c,d=Math.max(l,i-c),_=n>=t?"start":"end",u=o+c;if(_==="start"){let g=u,k=n+g,v=k+s;if(v>d){let y=v-d;g-=y,k-=y}return k<l&&(g+=l-k),{anchor:_,offset:g}}let p=-u,f=n+p,b=f-s;if(b<l){let g=l-b;p+=g,f+=g}return f>d&&(p-=f-d),{anchor:_,offset:p}}r(ix,"label_anchor_offset");function ox(n,e,t,s,i){let o=t-n,a=s-e,c=Math.hypot(o,a)||1,l=o/c,d=a/c;return{x:Math.round(n+l*i),y:Math.round(e+d*i)}}r(ox,"project_anchor_to_ring");function lT(n=[]){let e=new Set;for(let t of n){let s=Ip(t?.item);s&&e.add(s)}return e}r(lT,"build_prefixed_key_set");function Ip(n){if(n)return Wt(n.collection_key,n.key)}r(Ip,"prefixed_key_for_item");function dT({connections_state:n={},existing_keys:e=new Set,resolve_item:t}={}){if(typeof t!="function")return[];let s=[];for(let[i,o]of Object.entries(n)){if(!o?.hidden||o?.pinned||e.has(i))continue;let a=_T(i);if(!a)continue;let c=t(a.collection_key,a.item_key);c&&(e.add(i),s.push({item:c,score:null,is_hidden:!0,prefixed_key:i}))}return s}r(dT,"collect_hidden_entries");function rx({is_center:n=!1,is_hidden:e=!1,is_pinned:t=!1}={}){let s=["sc-graph-node"];return n&&s.push("sc-graph-node-center"),t&&s.push("sc-result-pinned"),e&&s.push("sc-result-hidden"),s.join(" ").trim()}r(rx,"build_node_classname");function _T(n){if(typeof n!="string"||!n.includes(":"))return null;let[e,...t]=n.split(":");return!e||!t.length?null:{collection_key:e,item_key:t.join(":")}}r(_T,"parse_prefixed_key");var uT="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js",ax="7.",mT=typeof globalThis<"u"&&globalThis.SC_D3_INTEGRITY_SHA256||"";function Pp(n){if(!n)return;let e=String(n.version||"");e&&!e.startsWith(ax)&&console.warn(`[connections_graph] Loaded d3 version "${e}" but expected v${ax}x`)}r(Pp,"validate_d3_instance");async function pT(){let n=typeof globalThis<"u"?globalThis:window;if(n.d3||(typeof document<"u"?document.querySelector("script[data-sc-d3]"):null)&&n.d3)return Pp(n.d3),n.d3;let t=await new Promise((s,i)=>{if(typeof document>"u"||!document.head){i(new Error("D3 loader: document.head not available"));return}let o=document.createElement("script");o.src=uT,o.async=!0,o.setAttribute("data-sc-d3","true");let a=String(mT||"").trim();a&&(o.integrity=a,o.crossOrigin="anonymous"),o.onload=()=>{if(!n.d3){i(new Error("D3 loader: script loaded but window.d3 is missing"));return}s(n.d3)},o.onerror=()=>{i(new Error("D3 loader: failed to load d3 from CDN"))},document.head.appendChild(o)});return Pp(t),t}r(pT,"load_d3");async function hT(n,e={}){let t=e?.to_item||n?.item,s=e.width??100,i=e.height??100;return`
<div class="connections-graph sc-graph"
data-center-key="${t?.key||""}"
data-center-collection="${t?.collection_key||""}">
<svg class="sc-graph-svg"
width="${s}" height="${i}"
viewBox="0 0 ${s} ${i}"
preserveAspectRatio="xMidYMid meet">
<g class="sc-graph-viewport">
<g class="nodes"></g>
</g>
</svg>
<div class="sc-graph-details" aria-live="polite"></div>
</div>
`}r(hT,"build_html");async function cx(n,e={}){this.apply_style_sheet(Yw);let t=await hT.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".connections-graph");return fT.call(this,n,i,e),i}r(cx,"render");async function fT(n,e,t={}){let s=await n.get_results(t);try{let i=await pT(),o=t.to_item||n?.item;if(!o)throw new Error("connections_graph: could not resolve center item.");let a=o.env,c=t.connections_settings??a.connections_lists.settings,l=o?.data?.connections||{},d=lT(s),_=dT({connections_state:l,existing_keys:d,resolve_item:r((m,h)=>n?.env?.[m]?.get(h),"resolve_item")}),u=[...s,..._],p=e.querySelector("svg.sc-graph-svg"),b=p.querySelector("g.sc-graph-viewport").querySelector("g.nodes"),g=8,k=5,v=24,y=10,S=null,A=null,$=r(m=>{let h=Wo(m,{show_full_path:!1})||m?.key||"";return nx(h,70)},"build_label_text"),j=+p.getAttribute("width")||100,C=r(()=>{let m=e.clientWidth||+p.getAttribute("width")||100,h=m;j=m,p.setAttribute("viewBox",`0 0 ${m} ${h}`),p.setAttribute("width",m),p.setAttribute("height",h);let w=Math.round(m*.5),q=Math.round(h*.5),{min_r:E,outer_r:O,half_min:N}=sx(m,h,v),M=Np(o?.vec)?Jo(o.vec):null,ue=u.map(T=>Np(T?.item?.vec)?Jo(T.item.vec):null),ge=ue.map(T=>M&&T?Math.max(0,Math.min(1,me(M,T))):null),{norm:ye}=Zw(ge),X={id:"__center__",item:o,score:1,radius:g,isCenter:!0,x:w,y:q,fx:w,fy:q},p2=Math.floor(Al(u.map(T=>T?.item?.key||"").join("|"))*1e9),{centers:am,assign:Ey}=Qw(ue,4,300,p2),Sy=(am.length?am:[null,null,null,null]).slice(0,4).map(T=>M&&T?Math.max(0,Math.min(1,me(M,T))):.5),Vi=Sy.map(T=>Tp(T,E,O));for(;Vi.length<4;)Vi.push(Vi[Vi.length-1]||Math.round((E+O)/2));let h2=ex(w,q,Vi),f2=u.map((T,V)=>{let P=T?.item;if(!P)return null;let ps=ye[V]??.5,Et=Tp(ps,E,O),on=Xw(P.key||String(V),-Math.PI/2),rn=Math.round(w+Et*Math.cos(on)),Ki=Math.round(q+Et*Math.sin(on)),Ee=Number.isInteger(Ey[V])?Ey[V]:Math.floor(Al(P.key||String(V))*4),an=ue[V],cn=am[Ee]||null,Yi=an&&cn?Math.max(0,Math.min(1,me(an,cn))):0,It=Ip(P),v2=It?Bo(l,It):!1,k2=!!T?.is_hidden||(It?rl(l,It):!1);return{id:P.key,item:P,score:Number.isFinite(T?.score)?+T.score:M&&an?me(M,an):null,ring_r:Et,angle:on,radius:k,isCenter:!1,x:rn,y:Ki,cluster:Ee,node_to_cluster_sim:Yi,label_text:$(P),prefixed_key:It,isPinned:v2,isHidden:k2}}).filter(Boolean),ms=[X,...f2];A=i.select(b).selectAll("g.sc-graph-node").data(ms,T=>T.id).join(T=>{let V=T.append("g").attr("class",P=>rx({is_center:P.isCenter,is_hidden:P.isHidden,is_pinned:P.isPinned})).attr("title",P=>(P.item.path||"").replace(/"/g,"&quot;")).attr("data-collection",P=>P.item.collection_key).attr("data-key",P=>P.item.key).attr("data-path",P=>(P.item.path||"").replace(/"/g,"&quot;")).attr("data-link",P=>(P.item.link||"").replace(/"/g,"&quot;")).attr("data-score",P=>`${P.score??""}`).attr("data-cluster",P=>P.isCenter?"":String(P.cluster)).attr("data-hidden",P=>P.isHidden?"true":null).attr("data-pinned",P=>P.isPinned?"true":null).attr("data-prefixed-key",P=>P.prefixed_key||"");return V.append("circle").attr("r",P=>P.radius).attr("class","sc-graph-node-dot"),V.append("text").attr("class","sc-score-text").attr("y",-k-6).attr("text-anchor","middle").attr("alignment-baseline","baseline").text(P=>typeof P.score=="number"&&!P.isCenter?P.score.toFixed(2):""),V.filter(P=>!P.isCenter).append("text").attr("class","sc-node-label").attr("y",-k-6).attr("text-anchor","middle").attr("alignment-baseline","baseline").text(P=>P.label_text.replace(".md","")),V}),A.attr("class",T=>rx({is_center:T.isCenter,is_hidden:T.isHidden,is_pinned:T.isPinned})).attr("data-hidden",T=>T.isHidden?"true":null).attr("data-pinned",T=>T.isPinned?"true":null).attr("data-prefixed-key",T=>T.prefixed_key||"").attr("transform",T=>`translate(${T.x},${T.y})`);let g2=r(()=>{A.classed("sc-graph-node-hover",!1)},"clear_hover");A.on("mouseenter",function(){g2(),i.select(this).classed("sc-graph-node-hover",!0)}).on("mouseleave",function(){i.select(this).classed("sc-graph-node-hover",!1)}).on("click",function(T,V){gT({node:V,container:e,env:a,center_item:o})});let Ay=i.forceRadial(T=>T.isCenter?0:T.ring_r,w,q).strength(T=>T.isCenter?1:tx(T.ring_r,E,O)),Cy=i.forceCollide(T=>T.radius+16).strength(.9).iterations(2),qy=i.forceManyBody().strength(-80).distanceMax(N),y2=r(T=>{if(T.isCenter)return 0;let V=.04,P=Math.max(0,Math.min(1,T.node_to_cluster_sim||0)),ps=Sy[(T.cluster??0)%4]||.5;return V+.28*P*(.5+.5*ps)},"cluster_strength_fn");function b2(T=[],V=()=>.2,P=0,ps=0){let Et=[];function on(rn){for(let Ki=0;Ki<Et.length;Ki++){let Ee=Et[Ki];if(Ee.isCenter)continue;let an=Number.isInteger(Ee.cluster)?Ee.cluster%T.length:0,cn=T[an],Yi=Math.max(0,Math.min(1,V(Ee)));if(!cn||Yi<=0)continue;let It=ox(P,ps,cn.x,cn.y,Ee.ring_r);Ee.vx+=(It.x-Ee.x)*Yi*rn,Ee.vy+=(It.y-Ee.y)*Yi*rn}}return r(on,"force"),on.initialize=function(rn){Et=rn},on}r(b2,"force_cluster");let Oy=b2(h2,y2,w,q);S?(S.nodes(ms),S.force("radial",Ay),S.force("cluster",Oy),S.force("collide",Cy),S.force("charge",qy),ms[0].fx=w,ms[0].fy=q,S.alpha(.8).restart()):S=i.forceSimulation(ms).alpha(.95).alphaDecay(.08).force("radial",Ay).force("cluster",Oy).force("collide",Cy).force("charge",qy).on("tick",()=>{ms[0].fx=w,ms[0].fy=q,A.attr("transform",T=>`translate(${T.x},${T.y})`),A.select("text.sc-node-label").each(function(T){if(T.isCenter)return;let V=this,P=typeof V.getComputedTextLength=="function"?V.getComputedTextLength():0,{anchor:ps,offset:Et}=ix(T.x,{center_x:w,label_width:P,view_width:j,radius:T.radius,margin:y});i.select(V).attr("text-anchor",ps).attr("x",Et)})})},"layout");C(),new ResizeObserver(()=>C()).observe(e)}catch(i){console.error("[connections_graph] post_process error:",i);let o=document.createElement("p");o.className="sc-no-results",o.textContent="Unable to render graph. See console for details.",e.appendChild(o)}return e}r(fT,"post_process");function gT({node:n,container:e,env:t,center_item:s}){if(!n?.item)return;let i=yT(n,s);i&&(typeof CustomEvent=="function"&&e?.dispatchEvent&&e.dispatchEvent(new CustomEvent("connections:result",{detail:i,bubbles:!0})),t?.events?.emit?.("connections:result",i),n.item.emit_event?.("connections:result",i),n.item.emit_event?.("connections:open_result",i))}r(gT,"handle_node_click");function yT(n,e){let t=n?.item?.collection_key,s=n?.item?.key;return!t||!s?null:{collection_key:t,item_key:s,prefixed_key:n.prefixed_key||Ip(n.item)||Wt(t,s),score:typeof n.score=="number"?n.score:null,is_hidden:!!n.isHidden,is_pinned:!!n.isPinned,event_source:"connections-graph-v1",center_key:e?.key}}r(yT,"build_result_detail");async function bT(n,e={}){return`<div>
<div class="connections-graph-container"></div>
<div class="connections-list sc-list" data-key="${n.item.key}"></div>
</div>`}r(bT,"build_html");async function dx(n,e={}){let t=await bT.call(this,n,e),i=this.create_doc_fragment(t).querySelector("div");return vT.call(this,n,i,e),i}r(dx,"render");async function vT(n,e,t={}){let s=n.env,i=e.querySelector(".connections-graph-container"),o=e.querySelector(".connections-list.sc-list");e.dataset.key=n.item.key;let a=await n.get_results(t),c=await s.smart_components.render_component("connections_graph_v1",n,t);if(this.empty(i),i.appendChild(c),wT(c,o),!a||!Array.isArray(a)||a.length===0){let _=this.create_doc_fragment(`<p class="sc-no-results">No results found.<br><em>Try using the refresh button. If that doesn't work, try running "Clear sources data" and then "Reload sources" in the Smart Environment settings.</em></p>`);return o.appendChild(_),e}let l=n.env.smart_components;return(await Promise.all(a.map(_=>l.render_component("connections_list_item_v3",_,{...t})))).forEach(_=>o.appendChild(_)),e}r(vT,"post_process");var lx="sc-result-graph-focus",kT=2400;function wT(n,e){!n||!e||n.addEventListener("connections:result",t=>{xT(e,t?.detail||{})})}r(wT,"register_graph_events");function xT(n,e={}){let t=ET(n,e);if(!t)return;t.classList.contains("sc-collapsed")&&t.classList.remove("sc-collapsed"),t.scrollIntoView?.({block:"center",behavior:"smooth"}),t.classList.add(lx),(typeof window<"u"?window.setTimeout:setTimeout)?.(()=>t.classList.remove(lx),kT)}r(xT,"focus_result_from_graph");function ET(n,e={}){if(!n)return null;let{collection_key:t,item_key:s}=e;return!t||!s?null:Array.from(n.querySelectorAll(".sc-result")).find(i=>i.dataset.collection===t&&i.dataset.key===s)||null}r(ET,"find_result_element");var _x="PRO: Graph + List";function ux(n,e){if(typeof n!="string"||typeof e!="string")throw new TypeError("Both parameters must be strings.");let t=e.match(/\b[\w\s]+\b/g)||[],s="";for(;s.length<10&&t.length>0;)s=t.shift().trim();let i="";for(;i.length<10&&t.length>0;)i=t.pop().trim();let o;if(!i||s===i)o=encodeURIComponent(s);else{let c=encodeURIComponent(s),l=encodeURIComponent(i);o=`${c},${l}`}let a=new URL(n,"http://dummy");if(a.hash){let c=a.hash.slice(1);if(c.includes(":~:text="))return`${a.origin}${a.pathname}#${c}&text=${o}`;a.hash=`${c}:~:text=${o}`}else a.hash=`:~:text=${o}`;return a.toString()}r(ux,"create_highlight_url");async function ST(n,e={}){return`<div><div class="sc-connections-web-view">
<div class="sc-list"><ul></ul></div>
</div></div>`}r(ST,"build_html");async function mx(n,e={}){let t=await ST.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".sc-connections-web-view");return AT.call(this,n,i,e),i}r(mx,"render");async function AT(n,e,t={}){let i=e.querySelector(".sc-list").querySelector("ul");return await r(async()=>{let a=Object.keys(n.data.hidden_connections||{}),c=await n.find_connections({exclude_key_ends_with:"---frontmatter---",exclude_keys:a,...t.filter||{}});console.log("render_results",c);for(let l of c){let _="https://wfhbrian.com/"+((l.item.source?.metadata||l.item.metadata||{})["wfhbrian.com"]?.replace(/\.html$/,"").replace(/\s/g,"-")||""),u=await l.item.read(),f=(u.split(`
`).map(S=>S.trim()).filter(S=>S.length>0)[0]||"").replace(/^\W+([a-zA-Z\s\d\-]+).*/,"$1").trim(),b=ux(_,u),g,k=l.item.key.split("#"),v=k.pop();v.startsWith("{")?g=(k.pop()+v).trim():g=v;let y=g.startsWith("{")?f:g;i.appendChild(this.create_doc_fragment('<li data-key="'+l.item.key+'" data-score="'+l.score+'"><a href="'+b+'">'+y+"</a></li>"))}},"render_results")(),e}r(AT,"post_process");var px=new CSSStyleSheet;px.replaceSync(`.sc-inline-pop{position:absolute;z-index:var(--layer-popover);background-color:var(--background-secondary);border:1px solid var(--background-modifier-border);border-radius:var(--radius-m);box-shadow:var(--shadow-s);max-width:340px;font-size:.875rem;overflow-y:auto}.sc-inline-pop .sc-inline-header{font-weight:700;border-bottom:1px solid var(--background-modifier-border);display:flex;justify-content:space-between;align-items:center;padding:.5rem .77rem}.sc-inline-pop .sc-inline-items{display:flex;flex-direction:column}.sc-inline-pop .sc-inline-item:hover{background-color:var(--background-primary)}.sc-inline-pop .sc-inline-item{display:flex;justify-content:space-between;align-items:center;gap:.5rem;cursor:pointer;padding:.5rem .77rem}
`);var hx=px;var Wn=require("obsidian");function fx(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(Wn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new Wn.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");Wn.MarkdownRenderer.render(o,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(fx,"register_block_hover_popover");var gx=require("obsidian");function Cl(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),gx.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):fx(n.parentElement,n,e.env,e.key)}r(Cl,"register_item_hover_popover");function yx(n){if(!n)return"";let[e,...t]=n.split("#"),s=e.split("/").pop().replace(/\.md$/,"");if(!t.length)return`[[${s}]]`;let i=t.filter(o=>!o.startsWith("{")).pop();return i?`[[${s}#${i}]]`:`[[${s}]]`}r(yx,"parse_item_key_to_wikilink");function CT(n,e,t,s){let i=n.dragManager,o=yx(e.key),a=i.dragLink(s,o);i.onDragStart(s,a),t.drag_event_key?e.emit_event(t.drag_event_key):e.emit_event("connections:drag_result")}r(CT,"handle_connection_drag");function bx(n,e,t={}){let i=e.env.obsidian_app;n.setAttribute("draggable","true"),n.addEventListener("dragstart",CT.bind(null,i,e,t))}r(bx,"register_item_drag");var Mp=require("obsidian");async function ql(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=Mp.Keymap.isModEvent(e),l=Mp.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(ql,"open_source");function qT(n,e={}){return`<div>
<div class="sc-inline-pop">
<div class="sc-inline-header">
<span class="sc-inline-title">Connections</span>
<span>Lines ${n.block.line_start}\u2013${n.block.line_end}</span>
</div>
<div class="sc-inline-items">Loading...</div>
</div>
</div>`}r(qT,"build_html");async function vx(n,e={}){this.apply_style_sheet(hx);let t=qT.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".sc-inline-pop");return OT.call(this,n,i,e),i}r(vx,"render");async function OT(n,e,t={}){let s=n.env?.connections_lists,i=s?.settings,o=i?.inline_connections_score_threshold?parseFloat(i.inline_connections_score_threshold):.8,a=Array.isArray(t.precomputed_items)?t.precomputed_items.slice(0,10):null;a||(a=n.connections_list.filter_and_score({limit:10,score_algo_key:s.score_algo_key,results_collection_key:s.results_collection_key,to_item:n.block,filter:{exclude_keys:[n.block.source_key],exclude_key_starts_with_any:[n.block.source_key]}})),a=a.filter(d=>d.score>=o);let c=e.querySelector(".sc-inline-items");if(!c)return;if(!a.length){c.textContent="No connections found above threshold "+o;return}this.empty(c),a.forEach(d=>{let _=document.createElement("div");_.className="sc-inline-item";let u=document.createElement("span");u.textContent=d.item.name??d.item.path.split("/").pop(),_.appendChild(u);let p=document.createElement("span");p.textContent=d.score.toFixed(2),_.appendChild(p),c.appendChild(_),Cl(_,d.item),_.addEventListener("click",f=>{ql(d.item,f),d.item.emit_event("inline_connections:open_result",{event_source:"inline-connections-popover"})}),bx(_,d.item,{drag_event_key:"inline_connections:drag_result"})}),e.querySelector(".sc-inline-header")?.addEventListener("click",()=>{n.plugin.connections_view_early?.container?.isShown?.()?n.block.emit_event("connections:show"):(n.plugin.open_connections_view(),setTimeout(()=>{n.block.emit_event("connections:show")},300))}),n.connections_list.emit_event("inline_connections:show")}r(OT,"post_process");function kx(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Gn(l,o),l=Lp(l,15),l=Gn(l,a),i^=l,i=Lp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Gn(l,o),l=Lp(l,15),l=Gn(l,a),i^=l;break}return i^=n.length,i=$T(i),i|0}r(kx,"murmur_hash_32");function Ol(n,e=0){return(kx(n,e)>>>0).toString(36)}r(Ol,"murmur_hash_32_alphanumeric");function Gn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Gn,"multiply_32");function Lp(n,e){return n<<e|n>>>32-e}r(Lp,"rotate_left_32");function $T(n){return n^=n>>>16,n=Gn(n,2246822507),n^=n>>>13,n=Gn(n,3266489909),n^=n>>>16,n|0}r($T,"fmix_32");function zp(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(zp,"convert_to_time_ago");var TT=`What is the most relevant to the following? Today is {{DATE}}.
{{CURRENT}}`;async function Rp(n,e={}){if(!n.length)return console.warn("No results to rank"),n;if(!this.collection.rank_model)throw new Error("[rank_connections] Rank model not available.");let{rank_query:t=this.data.rank_query||this.settings.rank_query||TT}=e;console.log("rank model loaded");let s=new Date().toLocaleDateString(),i=t.replace("{{DATE}}",s).replace("{{CURRENT}}",(await this.item.get_embed_input()).slice(0,500)),o=await Promise.all(n.map(async l=>{let d=`mtime: ${new Date(l.item.mtime).toLocaleDateString()}
`;return d+=await l.item.get_embed_input(),d.slice(0,500)})),a=await this.collection.rank_model.rank(i,o);if(console.log("Ranked results:",a),!Array.isArray(a)||!a.length)return console.warn("Ranking failed, received:",a),n;let c=Math.max(...a.map(l=>l.score));return a.map(({index:l,score:d})=>{let _=this.settings.actions.connections_list_post_process_rank_connections.show_og_score?`${d.toFixed(2)} (${n[l].score.toFixed(2)})`:d.toFixed(2);return{...n[l],score:_,og_score:n[l].score}}).sort((l,d)=>d.score-l.score)}r(Rp,"rank_connections");Rp.action_type="connections_post_process";var Fp="Re-ranking model",Bp="Uses re-ranking model to adjust the order of connection results.";function wx(n){return{connections_post_process_description:{group:"Ranking algorithm",type:"html",name:`${Fp} algorithm`,value:[`${Bp}`,"<p><i>Configure the default ranking model in the Smart Environment Pro settings.</i></p>"].join(`
`)},show_og_score:{group:"Ranking algorithm",type:"toggle",name:"Show original connection score",description:"Display the original connection score alongside the re-ranked score."}}}r(wx,"settings_config");function Up(n,e={}){return!Array.isArray(n)||n.length===0?n:n.map(s=>{let i=NT(s),o=i?zp(i):"no mtime";return{...s,og_score:s.og_score??s.score,_recency_mtime:i,score:s.score.toFixed(2)+` (${o})`}}).sort((s,i)=>i._recency_mtime-s._recency_mtime).map(({_recency_mtime:s,...i})=>i)}r(Up,"recency_rank");function NT(n){let e=n?.item?.mtime;return e instanceof Date?e.getTime():typeof e=="number"?e:0}r(NT,"get_mtime_value");Up.action_type="connections_post_process";var Wp="Recency rank",Gp="Ranks connections by most recently modified items.";function xx(n){return{connections_post_process_description:{group:"Ranking algorithm",type:"html",name:`${Wp} algorithm`,value:[`${Gp}`].join(`
`)}}}r(xx,"settings_config");function Hp(n={}){if(!this.vec)return{score:null,error:`Missing this.vec for ${this.key}`};if(!n.to_item?.vec)return{score:null,error:"Missing params.to_item.vec"};let e=me(this.vec,n.to_item.vec),s=(Array.isArray(n.hidden)?n.hidden:[]).reduce((o,a)=>{if(!a?.vec)return o;let c=me(a.vec,this.vec);return c>o?c:o},0);return{score:e-s,base_score:e}}r(Hp,"sim_feedback_adjusted");Hp.action_type="score";var Jp="Similarity Adjusted by Feedback",Vp="Penalizes candidates similar to hidden notes before ranking.",Ex={score_algo_description:{group:"Score algorithm",type:"html",name:`${Jp} algorithm`,value:`${Vp}`}};var PT=.25,IT=.5;function MT(n){return Number.isNaN(n)||n<0?0:n>1?1:n}r(MT,"clamp_score");function Sx(n,e){return!Array.isArray(n)||!n.length?0:n.reduce((t,s)=>{if(!s?.vec)return t;let i=me(e,s.vec);return i>t?i:t},0)}r(Sx,"max_similarity");function Kp(n={}){if(!this.vec)return{score:null,error:`Missing this.vec for ${this.key}`};if(!n.to_item?.vec)return{score:null,error:"Missing params.to_item.vec"};let e=this.vec,t=me(e,n.to_item.vec),s=Sx(n.pinned,e),i=Sx(n.hidden,e),o=t+s*PT-i*IT;return{score:MT(o),base_score:t,pinned_boost:s,hidden_penalty:i}}r(Kp,"sim_feedback_weighted");Kp.action_type="score";var Yp="Similarity Weighted by Feedback",Xp="Boosts candidates similar to pinned notes while damping those that resemble hidden notes.",Ax={score_algo_description:{group:"Score algorithm",type:"html",name:`${Yp} algorithm`,value:`${Xp}`}};var Cx={collections:{connections_lists:Lw,lookup_lists:Gw},item_types:{ConnectionsList:qe},items:{connections_list:{class:qe}},modules:{},components:{connections_footer_view:{render:Vw},connections_graph_v1:{render:cx},connections_list_v4:{render:dx,display_name:_x},connections_web:{render:mx},inline_connections_popover:{render:vx}},actions:{connections_list_post_process_rank_connections:{action:Rp,settings_config:wx,display_name:Fp,display_description:Bp},connections_list_post_process_recency_rank:{action:Up,settings_config:xx,display_name:Wp,display_description:Gp},sim_feedback_adjusted:{action:Hp,settings_config:Ex,display_name:Jp,display_description:Vp},sim_feedback_weighted:{action:Kp,settings_config:Ax,display_name:Yp,display_description:Xp}}};var e1=require("obsidian");var $l=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var jl=class extends $l{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Hn=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new jl(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};function Tl(n,e){let t=qx(n),s=qx(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(Tl,"compare_versions");function qx(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(qx,"normalize_version_value");function Vo(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Vo,"is_plain_object");function js(n,e,t=[]){if(!Vo(n)||!Vo(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Vo(i)?(Vo(n[s])||(n[s]={}),js(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(js,"deep_merge_no_overwrite");function Ot(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(Tl(d,_)>0){let p={...c};js(p,l),n.collections[a]=p}else js(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;Tl(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):js(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),js(n[i],o)):n[i]=o}return n}r(Ot,"merge_env_config");var loe=typeof globalThis<"u"?globalThis:Function("return this")();function zT(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=RT(n,t),o=DT(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(zT,"create_regex");function DT(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(DT,"adjust_for_windows_paths");function RT(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(RT,"glob_to_regex_pattern");function Ox(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:zT(n,s)}r(Ox,"glob_to_regex");function $x(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r($x,"fuzzy_search");var Nl=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(Ox(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return $x(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var FT=Y(require("obsidian"),1);var Pl=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=FT,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function Il(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(Il,"empty");var jx=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var Tx=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var BT=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,Ml=r((n,e)=>{let t=e.trim();(BT.test(t)?Tx:jx)(n,t)},"safe_inner_html");function Ge(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(Ge,"escape_html");function Zp(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(Zp,"convert_to_time_ago");function Ts(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Ts,"cos_sim");function Oe(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(Oe,"get_by_path");function $e(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r($e,"set_by_path");function Qp(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(Qp,"delete_by_path");function eh(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(eh,"compute_centroid");function th(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);s[a]+=u,s[l]+=u}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(th,"compute_medoid");var Ll=new WeakMap,zl=new WeakMap,Dl=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return Oe(e,t,s)}set_by_path(e,t,s,i=null){$e(e,t,s,i)}delete_by_path(e,t,s=null){Qp(e,t,s)}escape_html(e){return Ge(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||zl.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");zl.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=zl.get(i);c&&(i.removeEventListener("change",c),zl.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=re(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){Il(e)}safe_inner_html(e,t){Ml(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=Ll.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},Ll.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}Ll.get(e)===c&&Ll.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var Rl=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===s,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((b,g)=>{let k=document.createElement("div");k.className="array-item-row";let v=document.createElement("input");v.type="text",v.value=b,v.placeholder="Value";let y=document.createElement("button");y.textContent="\u2715",y.title="Remove",v.addEventListener("change",()=>{c[g]=v.value,f()}),y.addEventListener("click",()=>{c.splice(g,1),d(),f()}),k.appendChild(v),k.appendChild(y),l.appendChild(k)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let b=u.value.trim();b&&(c.push(b),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,k],v)=>{let y=document.createElement("div");y.className="json-pair-row";let S=document.createElement("input");S.type="text",S.value=g,S.placeholder="Property";let A=document.createElement("input");A.type="text",A.value=k,A.placeholder="Value";let $=document.createElement("button");$.textContent="\u2715",$.title="Remove",S.addEventListener("change",()=>{let j=S.value.trim();j&&j!==g&&(c[j]=c[g],delete c[g],d(),b())}),A.addEventListener("change",()=>{c[S.value]=A.value,b()}),$.addEventListener("click",()=>{delete c[S.value],d(),b()}),y.appendChild(S),y.appendChild(A),y.appendChild($),l.appendChild(y)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),b())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let b=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){Il(e)}safe_inner_html(e,t){Ml(e,t)}};var lt=require("obsidian");var Fl=class extends Rl{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return lt.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new lt.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await lt.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,lt.getIcon)(e).outerHTML}is_mod_event(e){return lt.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};var Bl=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},Ul=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};var Wl=class extends Bl{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Ts(e,a.vec)};return xl(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(El)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Ts(e,a.vec)};return Bw(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(Uw)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},Gl=class extends Ul{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var UT="---frontmatter---",Nx=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),WT=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),GT=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),HT=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(UT),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),JT=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=Nx(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=Nx(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),sh=r((n,e={})=>{let t=WT(n,e),s=GT(t),i=HT(s);return JT(i,n)},"create_find_connections_filter_opts");async function Jn(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=sh(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+re(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(We).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(Jn,"find_connections");Jn.action_type="connections";var Ns=class extends ie{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new Gl(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Ps=class extends oe{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Wl(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(We).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return Px}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return VT}},Px={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},VT={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function nh(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await Jn.call(this,n);let o=sh(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+re(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(We).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(We).slice(0,s)}return i}r(nh,"find_connections");nh.action_type="connections";var Vn=class extends Ns{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=eh(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=th(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},Ix={class:Vn,actions:{find_connections:nh}};var Ko=class extends Ps{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(We)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(KT),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},KT={};var Hl=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Yo;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Yo=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Jl=class extends Hl{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Xo;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Xo=class extends Yo{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var Mx={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Yt=class extends Jl{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=$t;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},$t=class extends Xo{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+u]=d,delete o[l]);let f=this.env[_];if(!f)continue;let b=f.get(u);if(d.key||(d.key=u),b)b.data=d,b._queue_load=!1,b.loaded_at=Date.now();else{let g=f.item_type,k=new g(this.env,d);k._queue_load=!1,k.loaded_at=Date.now(),f.set(k)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return Mx[s]&&(s=Mx[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Zo=class extends Yt{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=ih},ih=class extends $t{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var Vl=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return re(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return Lx(this.constructor.name)}static get adapter_key(){return Lx(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function Lx(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(Lx,"to_snake");function Kl(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},b=null,g=null,k=!1,v=!1,y="#",S=!1,A=[],$=null;_[y]=0;for(let C=0;C<i.length;C++){let x=C+t,m=i[C],h=m.trim();if(h==="---"){if(!v&&x===1){v=!0,k=!0,l["#---frontmatter---"]=[x,null];continue}else if(k){k=!1,l["#---frontmatter---"][1]=x;continue}}if(k)continue;if(!S&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(x)),h.startsWith("```")){if(S=!S,S&&!$?$=x:!S&&$&&(A.push([$,x]),$=null),!g){let E=c.length>0?c[c.length-1].key:y;if(E===y&&!l[y]&&(l[y]=[x,null]),E===y)g={key:y,start_line:x},(l[y][1]===null||l[y][1]<x)&&(l[y][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let O=_[E],N=`${E}#{${O}}`;l[N]=[x,null],g={key:N,start_line:x}}}continue}let w=h.match(/^(#{1,6})\s*(.+)$/);if(w&&!S){let E=w[1].length,O=w[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=x-1)}c.length===0&&l[y]&&l[y][1]===null&&(l[y][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null);let N="",M=0;if(c.length>0?(N=c[c.length-1].key,M=c[c.length-1].level):(N="",M=0),c.length===0)d[O]=(d[O]||0)+1,d[O]>1&&(O+=`[${d[O]}]`);else{u[N]||(u[N]={}),u[N][O]=(u[N][O]||0)+1;let X=u[N][O];X>1&&(O+=`#{${X}}`)}let ue=E-M,ge="#".repeat(ue),ye=N+ge+O;l[ye]=[x,null],_[ye]=0,c.push({level:E,title:O,key:ye});continue}let q=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(q&&!S){if(q[1].length===0){b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null),g&&g.key!==y&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let O=c.length>0?c[c.length-1].key:y;O===y&&!l[y]&&(l[y]=[x,null]),_[O]===void 0&&(_[O]=0),_[O]+=1;let N=_[O],M;if(s){let ue=q[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=YT(ue,o);M=`${O}#${ge}`}else M=`${O}#{${N}}`;l[M]=[x,null],b={key:M,start_line:x};continue}if(b)continue}if(h!==""&&!g){b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null);let E=c.length>0?c[c.length-1].key:y;if(E===y)l[y]||(l[y]=[x,null]),(l[y][1]===null||l[y][1]<x)&&(l[y][1]=null),g={key:y,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let O=_[E],N=`${E}#{${O}}`;l[N]=[x,null],g={key:N,start_line:x}}}}let j=i.length;for(;c.length>0;){let C=c.pop();l[C.key][1]===null&&(l[C.key][1]=j+t-1)}b&&(l[b.key][1]===null&&(l[b.key][1]=j+t-1),b=null),g&&(l[g.key][1]===null&&(l[g.key][1]=j+t-1),g=null),l[y]&&l[y][1]===null&&(l[y][1]=j+t-1);for(let C in l)a[C]=l[C];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:A}}r(Kl,"parse_markdown_blocks");function YT(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(YT,"get_longest_words_in_order");var dt=class extends Vl{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=Kl(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);s==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:u,state:"new",content:p});continue}let f,b=l.split("#"),g;for(;!f&&b.length>0;)b.pop(),g=b.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let k=this.item.block_collection.get(u);if(await this.create_hash(p)!==k.last_read?.hash){o.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function Xt(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,u=o(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(Xt,"get_markdown_links");function Yl({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=Xt(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(Yl,"get_bases_cache_links");function oh(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(oh,"parse_value");function XT(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=oh(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(oh(u)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=oh(c)}return t}r(XT,"parse_yaml_block");function zx(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=XT(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(zx,"parse_frontmatter");var Dx=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Qo=class extends dt{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=Xt(e),s=Yl({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=zx(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),Dx(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Zt=require("obsidian");function ZT(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(ZT,"merge_tags");var Is=class extends Qo{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=ZT(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!Zt.MarkdownRenderer||!Zt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Zt.MarkdownRenderer.render(s,t,i,this.item.path,new Zt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Zt.htmlToMarkdown)(i)}};var Xl=class extends dt{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var Zl=class extends dt{static{r(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function QT({content:n}={}){if(!n)return null;try{return JSON.parse(n)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}r(QT,"parse_canvas_json");function Rx({target:n,title:e}={}){return n?{title:e||n,target:n,line:1}:null}r(Rx,"build_link_record");function eN({node:n}={}){if(!n||typeof n!="object")return[];if(n.type==="text"&&typeof n.text=="string")return Xt(n.text);if(n.type==="file"&&typeof n.file=="string"){let e=typeof n.subpath=="string"?n.subpath:"",t=`${n.file}${e}`,s=Rx({target:t,title:n.file});return s?[s]:[]}if(n.type==="link"&&typeof n.url=="string"){let e=Rx({target:n.url,title:n.url});return e?[e]:[]}return[]}r(eN,"get_canvas_node_links");function tN({nodes:n=[]}={}){return Array.isArray(n)?n.reduce((e,t)=>(e.push(...eN({node:t})),e),[]):[]}r(tN,"get_canvas_links_from_nodes");function sN({content:n}={}){let e=QT({content:n});return e?.nodes?tN({nodes:e.nodes}):[]}r(sN,"get_canvas_links");var Ql=class extends dt{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=sN({content:e});let t=this.item.file?.stat,s=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:s,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var ed=class extends Is{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function Fx(n,e){let[t,...s]=n.split("#").filter(Boolean),i=kl(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(Fx,"get_block_display_name");var Kn=class extends Ns{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return Fx(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},Bx={class:Kn,actions:{find_connections:Jn}};var er=class extends Ps{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var td=class extends Yt{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=rh;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},rh=class extends $t{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var sd=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return re(e)}};function nd(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(nd,"get_line_range");var Yn=class extends sd{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return nd(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var Xn=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var tr=class extends Xn{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var Zn=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Ms=class extends Zn{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var _t=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var Qn=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},ei=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var ti=class extends Qn{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new ah(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},ah=class extends ei{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Ls=class extends Qn{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new ch(i)}},ch=class extends ei{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var Hx=Y(Gx(),1);var dN=Object.defineProperty,_N=r((n,e,t)=>e in n?dN(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),uN=r((n,e,t)=>(_N(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function mN(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(mN,"bytePairMerge");function pN(n,e){return n.length===1?[e.get(n.join(","))]:mN(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(pN,"bytePairEncode");function hN(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(hN,"escapeRegex");var dh=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=Hx.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=dh.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=dh.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??n.length;for(let f of n.substring(l,u).matchAll(s)){let b=this.textEncoder.encode(f[0]),g=this.rankMap.get(b.join(","));if(g!=null){o.push(g);continue}o.push(...pN(b,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},od=dh;uN(od,"specialTokenRegex",n=>new RegExp(n.map(e=>hN(e)).join("|"),"g"));async function Vx(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await Jx(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await Jx(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(Vx,"fetch_json_cached");async function Jx(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(Jx,"do_fetch");function uh(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(uh):e==="object"?Object.values(n).every(uh):!1}r(uh,"is_json_compatible");function rd(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||uh(i)&&(t[s]=i);return t}r(rd,"extract_json_details");function sr(n){return Object.keys(n).length===0}r(sr,"is_empty_object");function fN(n,e){return sr(n)?e:sr(e)?n:{...n,...e}}r(fN,"merge_details");function _h(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(_h,"get_message_from_object");function Q(n,e=null){if(Array.isArray(n)&&n.length>0)return Q(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=rd(n,["message"]);return{message:t,details:sr(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=_h(o),c=rd(o,["message"]),l=rd(t,["message","error"]),d=fN(l,c);return{message:a||_h(t)||"Unknown error",details:sr(d)?null:d,http_status:e}}return Q(i)}let s=_h(t);if(s){let i=rd(t,["message"]);return{message:s,details:sr(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(Q,"normalize_error");var gN="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",mt=class extends Ms{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return He}get res_adapter(){return Je}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new _t({adapter:Ls})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:Q(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await Vx(gN,"cl100k_base.json");this.tiktoken=new od(e)}},He=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Je=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var ad=class extends mt{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return mh}get res_adapter(){return ph}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},mh=class extends He{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},ph=class extends Je{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var cd=class extends Ms{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var ld=class extends cd{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var Kx=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var Yx={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:hh};var hh={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},Xx={},fh={};var si=class extends ld{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=Yx;constructor(e){super(e),this.connector=Kx.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...Xx}}get_models(){return Promise.resolve(this.models)}get models(){return hh}};var dd=class extends mt{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return gh}get res_adapter(){return yh}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of bN(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},gh=class extends He{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},yh=class extends Je{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},yN=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),bN=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(yN)},"filter_embedding_models");var _d=class extends mt{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return bh}get res_adapter(){return vh}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},bh=class extends He{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},vh=class extends Je{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function vN(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(vN,"parse_lm_studio_models");var ud=class extends mt{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return kh}get res_adapter(){return wh}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return vN(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},kh=class extends He{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},wh=class extends Je{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var nr=class extends Xn{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw Q(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var md=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var pd=class extends Zn{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var ni={},Qt={data:null,fetched_at:0},B=class extends pd{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return U}get res_adapter(){return z}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new _t({adapter:Ls})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Qt.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=Q(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new md(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=Q({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=Q(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=Q(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Qt?.data&&t-Qt?.fetched_at<e)return Qt.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Qt.data=o,Qt.fetched_at=t,console.log({MODELS_DEV_CACHE:Qt}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Qt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return ni[this.constructor.key]||(ni[this.constructor.key]={}),ni[this.constructor.key]}set model_data(e){ni[this.constructor.key]||(ni[this.constructor.key]={}),ni[this.constructor.key]=e}},U=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},z=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var ir=class extends B{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return or}res_adapter=rr;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},or=class extends U{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},rr=class extends z{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var kN=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Ds=class extends B{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=xh;parse_model_data(e){return e.data.filter(t=>!kN.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:wN(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function wN(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(wN,"get_max_input_tokens");var xh=class extends z{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var ar=class extends Ds{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var ii=class extends B{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=cr;res_adapter=lr;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},cr=class extends U{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},lr=class extends z{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:Q(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},dr=class extends ii{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var _r=class extends B{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Eh}get res_adapter(){return Sh}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Eh=class extends U{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Sh=class extends z{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var ur=class extends B{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return mr}get res_adapter(){return pr}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},mr=class extends U{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},pr=class extends z{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var hr=class extends B{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=fr;res_adapter=gr;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},fr=class extends U{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},gr=class extends z{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:Q(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Ah={openai:{req:U,res:z},anthropic:{req:or,res:rr},gemini:{req:cr,res:lr},lm_studio:{req:mr,res:pr},ollama:{req:fr,res:gr}},yr=class extends B{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Ah[e];return t&&t.req?t.req:U}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Ah[e];return t&&t.res?t.res:z}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(Ah).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var br=class extends B{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Ch}get res_adapter(){return qh}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},Ch=class extends U{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},qh=class extends z{static{r(this,"SmartChatModelGroqResponseAdapter")}};var vr=class extends B{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return U}get res_adapter(){return z}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var kr=class extends B{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Oh}get res_adapter(){return $h}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Oh=class extends U{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},$h=class extends z{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var Zh=require("obsidian");function Zx(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=Kl(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),u=nd(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=Xt(u),f=Yl({source:n,links:p}),b={key:d,lines:l,size:u.length,outlinks:[...p,...f],last_read:{at:a,hash:re(u)}};if(!_||_?.data.last_read?.hash!==b.last_read.hash){let g=new n.block_collection.item_type(n.env,b);n.block_collection.set(g)}else _.data={..._.data,...b}}xN(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(Zx,"parse_blocks");function xN(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(xN,"clean_and_update_source_blocks");function jh(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():Qx(a)?n[o]=jh(Qx(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(jh,"ajson_merge");function Qx(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(Qx,"is_object");var e0={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function EN(n){let e=!1,[t,...s]=n.split(":");return e0[t]&&(t=e0[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(EN,"_parse_ajson_key");var es=class extends Yt{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:b,item_key:g,changed:k}=EN(p),v=`${b}:${g}`;f?(i[v]=f,(k||v!==p)&&(delete i[p],t=!0)):(delete i[v],(k||v!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=jh(f.data,l);else{let b=p.item_type;f=new b(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Th=class extends $t{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},wr={collection:es,item:Th};var xr=class extends ie{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function SN(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(SN,"parse_component_properties");async function AN(n,e){let{scope_key:t,component_key:s}=SN(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await re(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(AN,"build_component_data");var hd=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await AN(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var fd=class extends hd{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function t0(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&t0(i,o,t)}}),t}r(t0,"flatten_components_config");var gd=class extends oe{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=t0(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},s0={class:gd,item_type:xr,data_adapter:wr,component_adapters:{SmartViewComponentAdapter:fd}};var n0=s0;function i0(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(i0,"filter_redundant_context_items");var o0=r((n,e)=>!e||!n?.[e]?!1:n[e].folder?n[e].exclude?!1:(n[e].exclude=!0,!0):(delete n[e],!0),"remove_context_item_data"),Er=class extends ie{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:s=!0}=t;o0(this.data.context_items,e)&&(this.queue_save(),s&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:s=!0}=t,i=Array.isArray(e)?e:[e],o=[];return i.forEach(a=>{o0(this.data.context_items,a)&&o.push(a)}),o.length?(this.queue_save(),s&&this.emit_event("context:updated",{removed_keys:o}),o):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return i0(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var yd=class extends oe{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var CN={class:yd,data_adapter:es,item_type:Er};var r0=CN;var bd=class extends ie{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var pt=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var vd=class extends pt{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var kd=class extends pt{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var a0=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var wd=class extends pt{static{r(this,"ImageContextItemAdapter")}static detect(e){return a0.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var xd=class extends pt{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var Nh=class extends oe{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},c0={version:1,class:Nh,collection_key:"context_items",item_type:bd,context_item_adapters:{BlockContextItemAdapter:vd,SourceContextItemAdapter:kd,ImageContextItemAdapter:wd,PdfContextItemAdapter:xd}};function l0(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(l0,"next_log_stats");var oi=class extends ie{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var qN={"collection:save_started":!0,"collection:save_completed":!0},Ph=class extends oe{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return oi}init(){this.env?.events||Hn.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!qN[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new oi(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=l0({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},d0={class:Ph,collection_key:"event_logs",data_adapter:es,item_type:oi};var ri=require("obsidian");function _0(n,e={}){if(!n)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],s=n?.env?.config?.actions||{},i=n?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(s[c]||{}).display_name||c;return a.push({select_action:r(()=>{n.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}r(_0,"build_suggest_scope_items");var u0=r((n,e={})=>{let t=n?.inputEl,s=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(s===t&&i)},"should_handle_arrow_left");var Ed=class extends ri.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,o=u0(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&o){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return _0(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,ri.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=ri.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var vme=require("obsidian");var Sd=class extends Ed{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var m0=require("obsidian");var Ad=class extends m0.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var qd=require("obsidian");var ON="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",Cd=class extends qd.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){$N(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function $N(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),jN(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(ON,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r($N,"render_milestones_modal_title");function jN(n){TN(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(jN,"render_help_icon");function TN(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,qd.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(TN,"set_icon_with_fallback");var p0={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var Sr=class extends ie{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var Od=class extends oe{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function h0(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(h0,"settings_config");var Rs=class extends Sr{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Ih=class extends Od{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var NN={class:Ih,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:wr,item_type:Rs,providers:{},settings_config:h0},Mh=NN;var Lh=class extends si{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},f0={class:Lh,settings_config:fh};Mh.providers={transformers:f0};var g0=Mh;function Ar(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(Ar,"format_collection_name");async function PN(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${Ar(n.collection_key)}</h2>
${t}
</div></div></div>`}r(PN,"build_html");async function y0(n,e={}){let t=await PN.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(y0,"render");var v0=require("obsidian");function IN(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(IN,"format_score");function MN(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(MN,"format_size");function b0(n,e){return n?`<span class="${e}">${n}</span>`:""}r(b0,"build_badge_html");function LN(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=IN(n?.data?.score),i=MN(n?.size||n?.data?.size),o=b0(s,"sc-context-item-score"),a=b0(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(LN,"build_html");async function k0(n,e={}){let t=LN(n,e),i=this.create_doc_fragment(t).firstElementChild;return zN.call(this,n,i,e),i}r(k0,"render");async function zN(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${v0.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),Cl(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(zN,"post_process");async function DN(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${Ar(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=FN(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(DN,"build_html");async function w0(n,e={}){let t=await DN.call(this,n,e),s=this.create_doc_fragment(t);return await RN.call(this,n,s,e)}r(w0,"render");async function RN(n,e,t={}){return e}r(RN,"post_process");function FN(n,e){let t=Object.values(n.items).length,s=Ar(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=BN(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=UN(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(FN,"generate_collection_stats");function BN(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(BN,"get_generic_collection_stats");function UN(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(UN,"calculate_embed_coverage");var x0=require("obsidian");function WN(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(WN,"build_html");async function zh(n,e={}){let t=WN.call(this,n,e),s=this.create_doc_fragment(t);return await GN.call(this,n,s,e)}r(zh,"render");async function GN(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new x0.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Oe(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),o.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):$e(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(GN,"post_process");zh.version=.2;var E0=require("obsidian");function HN(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(HN,"build_html");function S0(n,e={}){let t=HN.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,E0.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),JN.call(this,n,i,e),i}r(S0,"render");function JN(n,e){}r(JN,"post_process");var A0=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var O0=require("obsidian");var QN=require("obsidian");var KN={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},$d={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},YN=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function Dh(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=YN.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(Dh,"derive_events_checklist_groups");function Cr(n,e){let t=XN(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(Cr,"check_if_event_emitted");function XN(n,e){let t=KN[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!ZN(a)))return!0}return!1}r(XN,"resolve_plugin_install_event");function ZN(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r(ZN,"is_pro_manifest");function eP(n,e={}){let t=Dh($d),s=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(Cr(n,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(Cr(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=Cr(n,u.event_key)===!0;return sP(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Ge(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Ge(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Ge(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(eP,"build_html");async function $0(n,e={}){this.apply_style_sheet(A0);let t=eP.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return tP.call(this,n,i,e),i}r($0,"render");async function tP(n,e,t={}){return nP(e),iP(e),e}r(tP,"post_process");function sP(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Ge(n.event_key)}"
data-link="${Ge(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${Ge(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Ge(n.milestone)}</span>
</div>
</li>
`}r(sP,"build_item_html");function nP(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=q0(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||C0(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=q0(n,e);s&&(e.preventDefault(),C0(s))}))}r(nP,"attach_item_link_listeners");function C0(n){let e=aP(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(C0,"open_item_link");function iP(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&oP(i,s)})}r(iP,"render_item_state_icons");function oP(n,e){rP(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(oP,"set_item_icon");function rP(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,O0.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(rP,"set_icon_with_fallback");function q0(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(q0,"get_item_el_from_event");function aP(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=$d[t];return!s||typeof s.link!="string"?"":s.link}r(aP,"get_item_link");function cP(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}r(cP,"build_html");var Rh=100,Fh=100;function lP(n,e={}){let{limit:t=Rh}=e;return n.slice(-t).reverse()}r(lP,"get_visible_entries");function dP(n,e={}){let{page_size:t=Rh}=e;return Math.min(n,t)}r(dP,"get_visible_count");function _P(n,e={}){let{current_count:t=0,step_size:s=Fh}=e;return Math.min(n,t+s)}r(_P,"get_next_visible_count");function uP(n,e){return n>e}r(uP,"should_show_load_more");async function j0(n,e={}){let t=this.create_doc_fragment(cP()),s=t.firstElementChild;return mP.call(this,n,s,e),t}r(j0,"render");async function mP(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),o=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(s);let c=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!c.length){let _=s.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",s.appendChild(_),o&&(o.style.display="none");return}let l=dP(c.length,{page_size:Rh}),d=r(()=>{a.empty(s),lP(c,{limit:l}).forEach(_=>{fP(s,_)}),pP(o,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=s.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),o&&o.addEventListener("click",()=>{l=_P(c.length,{current_count:l,step_size:Fh}),d()})}r(mP,"post_process");function pP(n,e={}){if(!n)return;let{entries_length:t=0,visible_count:s=0}=e,i=uP(t,s);if(n.style.display=i?"inline-block":"none",i){let o=t-s,a=Math.min(Fh,o);n.textContent=`Load ${a} more`}}r(pP,"update_load_more_button");function hP(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(hP,"get_level");function fP(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=hP(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${gP(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(fP,"append_entry");function gP(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(gP,"to_time_ago");var Ve=require("obsidian");var ai=require("obsidian");function ci(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(ci,"get_smart_server_url");function yP(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(yP,"try_get_zlib");function bP(n){let e=yP();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(bP,"inflate_deflate_data");async function T0(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let b=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let k=new Uint8Array(n.slice(t,t+b)),v=new TextDecoder("utf-8").decode(k);t+=b,t+=g;let y=(l&8)!==0,S=t,A;if(!y)A=S+p;else{let C=S,x=!1;for(;C+4<=s;){let m=e.getUint32(C,!0);if(m===134695760||m===67324752||m===33639248){x=!0;break}C++}A=x?C:s}if(A>s)break;let $=new Uint8Array(n.slice(S,A));if(t=A,y&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let j;if(d===0)j=$;else if(d===8)j=bP($);else continue;if(i.push({fileName:v,data:j}),v.toLowerCase().endsWith("manifest.json")&&!v.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(j))}catch{}}return{files:i,pluginManifest:o}}r(T0,"parse_zip_into_files");function N0(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(N0,"validate_zip_buffer");async function P0(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(P0,"write_files_with_adapter");function I0(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(I0,"is_server_version_newer");async function M0(n,e){let t=await(0,ai.requestUrl)({url:`${ci()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return N0(t.arrayBuffer,"Smart Plugins server")}r(M0,"fetch_plugin_zip");async function L0(n,e=ai.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return N0(t.arrayBuffer,"Download")}r(L0,"fetch_zip_from_url");async function z0(n,e,t=ai.requestUrl){let s=await t({url:`${ci()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(z0,"fetch_plugin_readme");async function D0(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(D0,"enable_plugin");function R0(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(R0,"get_oauth_storage_prefix");async function F0(n){let e=await(0,ai.requestUrl)({url:`${ci()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(F0,"fetch_server_plugin_list");async function B0(n={}){let e=String(n.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,ai.requestUrl)({url:`${ci()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}r(B0,"fetch_referral_stats");var U0=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var kP='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',wP='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function xP(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(xP,"derive_fallback_plugins");function EP(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${kP}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${wP}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}r(EP,"build_html");async function G0(n,e={}){this.apply_style_sheet(U0);let t=EP.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await SP.call(this,n,i,e),i}r(G0,"render");async function SP(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=R0(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=xP(),_=0,u="",p=null,f=r(C=>{if(C){if(typeof this.empty=="function"){this.empty(C);return}C.innerHTML=""}},"empty_container"),b=r(C=>{if(!a||!C)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let m=document.createElement("div");m.classList.add("smart-plugins-login-manual-controls"),p.appendChild(m);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=C,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),m.appendChild(h);let w=document.createElement("button");w.classList.add("mod-cta"),w.textContent="Copy",w.addEventListener("click",async()=>{await W0(C)?new Ve.Notice("Copied login link to clipboard."):new Ve.Notice("Copy failed. Please select and copy the link manually.")}),m.appendChild(w)},"render_manual_login_link"),g=r(async()=>{let C={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(m=>setTimeout(m,100));for(let m in x){if(!Object.prototype.hasOwnProperty.call(x,m))continue;let{name:h,version:w}=x[m];C[m]={name:h,version:w}}return C},"get_installed_info"),k=r(async()=>{_++,_>=2&&u&&b(u),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(u=AP()),new Ve.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),v=r(()=>{if(this.empty(a),p=null,!(localStorage.getItem(o+"token")||"")){new Ve.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await k()})});return}let x=new Ve.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(m=>{m.setButtonText("Logout"),m.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new Ve.Notice("Logged out of Smart Plugins"),v(),y(),$()})})},"render_oauth_login_section"),y=r(async(C={})=>{f(c);let x=String(C.token||"").trim();if(!x)return;let m=Number(C.sub_exp??0)||0;if(!(m&&m<Date.now()))try{let h=await B0({token:x}),w=String(h?.referral_link||"").trim();if(!w)return;let q=new Ve.Setting(c).setName("Referral link").setDesc("Share your link to give $30 off Pro and earn 30 days of Pro credit.");q.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let O=await W0(w);new Ve.Notice(O?"Referral link copied.":"Copy failed. Please try again.")})}),q.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),S=r(async()=>{if(this.empty(l),!(!l||d.length===0))for(let C of d){let x=await n.smart_components.render_component("pro_plugins_list_item",C,{env:n,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),A=r(()=>{let C=new Ve.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");C.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),C.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),C.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),$=r(async()=>{this.empty(l);let C=localStorage.getItem(o+"token")||"";if(!C){await S(),await y();return}try{let x=await g(),m=await F0(C),{list:h=[],unauthorized:w=[],sub_exp:q}=m;if(typeof q=="number"&&q<Date.now()){A(),await S(),await y();return}if(await y({token:C,sub_exp:q}),!Array.isArray(h)||h.length===0){await S();return}for(let E of h){let O=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,token:C,installed_map:x,on_installed:$});l.appendChild(O)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),j=r(async()=>{v(),await $()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{j()}),await j(),e}r(SP,"post_process");function AP(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${ci()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(AP,"initiate_smart_plugins_oauth");var W0=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var he=require("obsidian");var CP="https://smartconnections.app/pro-plugins/";function qP(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(qP,"build_html");function OP(n){return!n||!n.repo}r(OP,"is_fallback_item");function $P(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,I0(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r($P,"compute_display_state");async function H0(n,e={}){let t=qP(n,e),i=this.create_doc_fragment(t).firstElementChild;return await jP.call(this,n,i,e),i}r(H0,"render");async function jP(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(OP(n)){let u=new he.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(CP,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=$P(n,l),_=new he.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>NP(n,{app:s,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),n.docs_url?u.onClick(()=>window.open(n.docs_url,"_external")):u.onClick(()=>PP(n,{app:s,token:i,display_name:d.display_name}))}),e}r(jP,"post_process");var TP=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return L0(t);if(!e)throw new Error("Login required to install this plugin.");return M0(n.repo,e)},"download_plugin_zip"),NP=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new he.Notice(`Installing "${n.repo}" ...`);let o=await TP(n,s),{files:a,pluginManifest:c}=await T0(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await P0(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await D0(t,_),new he.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new he.Notice(`Install failed: ${o.message}`)}},"install_plugin"),PP=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await z0(n.repo,s),a=new he.Modal(t);a.setTitle(i||n.name||n.repo),await he.MarkdownRenderer.render(t,o,a.contentEl,"",new he.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new he.Notice("Failed to load README")}},"show_plugin_readme");var J0=require("obsidian");var Fs=class extends J0.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var V0=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var K0=require("obsidian");function MP(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${X0(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(MP,"build_html");async function Y0(n,e){this.apply_style_sheet(V0);let s=this.create_doc_fragment(MP.call(this,n,e)).firstElementChild;return LP.call(this,n,s,e),s}r(Y0,"render");async function LP(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,K0.setIcon)(o,X0(n)),s.addEventListener("click",()=>{new Fs(n).open()}),i.addEventListener("click",()=>{new Fs(n,{test_on_open:!0}).open()}),e}r(LP,"post_process");function X0(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(X0,"get_test_result_icon_name");var Q0=require("obsidian");var Z0={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function jd(n,e,t={}){let s=(Z0[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new Q0.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new Fs(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(jd,"show_new_model_menu");var di=require("obsidian");function zP(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(zP,"ensure_settings_config");function Bh(n,e,t){let s=zP(n,e);return Object.entries(s||{}).reduce((i,[o,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][o]=a,i},{[t]:{}})}r(Bh,"build_settings_group_map");function Uh(n,e,t,s){return Bh(n,e,s)[t]||{}}r(Uh,"resolve_group_settings_config");var Td=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new di.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function Nd(n,e,t,s={}){let{default_group_name:i="Settings"}=s,o=n,a=Bh(n,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),u={...s,...s.group_params?.[l]||{},settings_config_source:o};return Wh(l,e,d,_,u)})}r(Nd,"render_settings_config");function Wh(n,e,t,s,i={}){let o=i.settings_config_source||t,a=i.settings_config_source?Uh(o,e,n,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=Td}catch{c=Td}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,b,g,k)=>{let v=Uh(b,f,p,k.default_group_name||"Settings");return Wh(p,f,v,g,k)}:Wh,_=DP(e,{container:s,group_name:n,settings_config:o,group_params:i,render_group:d}),u=new c(s);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)eE(u,e,p);else eE(u,e,l);u.setHeading(n);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let b=f.scope_class==="pro-setting",g=!!e.env?.is_pro;u.addSetting(k=>{switch(f.name&&k.setName(f.name),k.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&k.setClass(`setting-type-${f.type}`),f.description&&k.setDesc(f.description),f.type){case"button":k.addButton(v=>{v.setButtonText(f.name||"Run"),v.onClick(async y=>{typeof f.callback=="function"&&await li(k,y,f.callback,{scope:e})})});break;case"toggle":k.addToggle(v=>{v.setValue(Oe(e.settings,p)||!1),v.onChange(y=>{$e(e.settings,p,y),typeof f.callback=="function"&&li(k,y,f.callback,{scope:e})})});break;case"text":k.addText(v=>{v.setValue(String(Oe(e.settings,p)||"")),v.onChange(y=>{$e(e.settings,p,y)})});break;case"number":k.addText(v=>{v.setValue(String(Oe(e.settings,p)??"0")),v.inputEl.setAttribute("type","number"),v.onChange(y=>{let S=Number(y);isNaN(S)||$e(e.settings,p,S),typeof f.callback=="function"&&li(k,S,f.callback,{scope:e})})});break;case"dropdown":k.addDropdown(v=>{let y=f.options_callback;typeof y=="function"&&y.call(e,e).forEach(A=>{let $=A.label||A.name||A.value;v.addOption(A.value,$)}),v.setValue(Oe(e.settings,p)||""),v.onChange(S=>{$e(e.settings,p,S),typeof f.callback=="function"&&li(k,S,f.callback,{scope:e}),_()})});break;case"textarea":k.addTextArea(v=>{v.setValue(String(Oe(e.settings,p)||"")),v.onChange(y=>{if(b&&!g){new di.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}$e(e.settings,p,y)}),b&&!g&&v.setDisabled(!0)});break;case"slider":k.addSlider(v=>{let y=f.min||0,S=f.max||100,A=f.step||1;v.setLimits(y,S,A),v.setValue(Oe(e.settings,p)||y),v.setDynamicTooltip(),v.onChange($=>{$e(e.settings,p,$),typeof f.callback=="function"&&li(k,$,f.callback,{scope:e})})});break;case"heading":k.setHeading();break;case"html":f.value&&k.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&k.settingEl.addClass(f.scope_class)})}return u}r(Wh,"render_settings_group");function eE(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,di.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await li(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(eE,"render_heading_button");async function li(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(li,"handle_config_callback");function DP(n,e={}){let{container:t,group_name:s,settings_config:i,group_params:o={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(s,n,i,t,o))}r(DP,"create_settings_group_rerender");function RP(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(RP,"build_html");async function tE(n,e){let s=this.create_doc_fragment(RP.call(this,n,e)).firstElementChild;return FP.call(this,n,s,e),s}r(tE,"render");async function FP(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=Nd(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{jd(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(FP,"post_process");function BP(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(BP,"build_html");async function sE(n,e){let s=this.create_doc_fragment(BP(n,e)).firstElementChild;return UP.call(this,n,s,e),s}r(sE,"render");async function UP(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(UP,"post_process");var oE=require("obsidian");function Pd(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(Pd,"ensure_smart_sources_settings");function qr(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(qr,"parse_exclusions_csv");function nE(n,e){let t=(e??"").trim();if(!t)return n||"";let s=qr(n);return s.includes(t)||s.push(t),s.join(",")}r(nE,"add_exclusion");function iE(n,e){let t=(e??"").trim();return t?qr(n).filter(i=>i!==t).join(","):n?.trim()||""}r(iE,"remove_exclusion");var Id=class extends oE.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Pd(this.env),t=qr(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Pd(this.env);t.folder_exclusions=nE(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Pd(this.env),t=qr(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=iE(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var rE=require("obsidian");var Md=class extends rE.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function WP(n,e={}){return`
<div class="sources-settings">
</div>
`}r(WP,"build_html");async function aE(n,e={}){let t=await WP.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return GP.call(this,n,i,e),i}r(aE,"render");async function GP(n,e,t={}){Nd({folder_exclusions:JP,view_exclusions:VP,re_import_sources:KP},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",HP(n,e))),this.attach_disposer(e,i),e}r(GP,"post_process");function HP(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(HP,"highlight_reset_data");var JP={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new Id(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},VP={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new Md(t.main.app,t).open()},"callback")},KP={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};function YP(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(YP,"build_html");async function cE(n,e={}){let s=this.create_doc_fragment(YP(n,e)).firstElementChild;return XP.call(this,n,s,e),s}r(cE,"render");async function XP(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),jd(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(XP,"post_process");async function ZP(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(ZP,"build_html");async function lE(n,e={}){let t=await ZP.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return QP.call(this,n,i,e),i}r(lE,"render");async function QP(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(QP,"post_process");var dE=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function tI(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(tI,"build_html");async function _E(n,e={}){this.apply_style_sheet(dE);let t=await tI.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return sI.call(this,n,i,e),i}r(_E,"render");async function sI(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return Gh.call(this,"settings_env_sources",n,i),Gh.call(this,"settings_env_models",n,s),Gh.call(this,"settings_notifications",n,o),e}r(sI,"post_process");function Gh(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(Gh,"render_if_available");var uE=require("obsidian");function nI(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(nI,"build_html");async function mE(n,e={}){let t=nI(),i=this.create_doc_fragment(t).firstElementChild;return iI.call(this,n,i,e),i}r(mE,"render");async function iI(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),oI(n,a),rI(n,a),aI(n,a),cI(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(iI,"post_process");function oI(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(oI,"render_btn_open_selector");function rI(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(rI,"render_btn_copy_context");function aI(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(aI,"render_btn_clear_context");function cI(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,uE.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(cI,"render_btn_help");var pE=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var Or=require("obsidian");async function Ld(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(Or.Platform.isMobile)new Or.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new Or.Notice("Failed to copy.")}}r(Ld,"copy_to_clipboard");var dI=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),_I=r(n=>{let e=!1;return()=>{e||(e=!0,dI(async()=>{e=!1,await n()}))}},"create_render_scheduler");function uI(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(uI,"build_html");async function hE(n,e={}){let t=uI(n,e);this.apply_style_sheet(pE);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return mI.call(this,n,i,e),i}r(hE,"render");async function mI(n,e,t={}){let s=[],i=r(async()=>{let d=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(p=>{this.empty(_),_.appendChild(p)});let u=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(p=>{this.empty(u),u.appendChild(p)})},"render_children"),o=_I(i),a=n.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,u)=>d.addEventListener(_,u)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(u=>u.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=pI(e);await Ld(p)})),_.showAtMouseEvent(d)}),await i(),s.push(n.on_event("context:updated",o)),this.attach_disposer(e,s),e}r(mI,"post_process");function pI(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(pI,"tree_dom_to_wikilinks");function hI(n){return Math.ceil((n||0)/4)}r(hI,"estimate_tokens");function fI(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(fI,"build_html");async function fE(n,e={}){let t=fI(),i=this.create_doc_fragment(t).firstElementChild;return gI.call(this,n,i,e),i}r(fE,"render");async function gI(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=hI(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(gI,"post_process");function gE(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-context-item-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let u=["sc-tree-label"];return n.exists===!1&&u.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${l}
<span class="${u.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(gE,"build_tree_item");function yE(n){let e=yI(n),t=new Set(n.map(i=>i.key||i.path));return bE(e,t)}r(yE,"build_tree_html");function yI(n=[]){let e=r(a=>a?.key||a?.path||"","get_item_key"),t=r(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,u=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),u=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),u=!0);let b=[];if(l){let g="",k=!1;for(let v=0;v<l.length;v++)!k&&l.slice(v,v+2)==="[["?(k=!0,g+="[[",v++):k&&l.slice(v,v+2)==="]]"?(k=!1,g+="]]",v++):!k&&l[v]==="/"?(b.push(g),g=""):g+=l[v];g&&b.push(g)}return _&&b.push(_),d&&b.push(d),{segments:b,has_block:u}},"split_path_segments"),s={name:"",children:{},selected:!1},i=r((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),o=n.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of n){let c=e(a),l=a?.exists;if(!c||i(c,o.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),u=s,p="";d.forEach((f,b)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=b===d.length-1,k=g&&_;u.children[f]||(u.children[f]={name:f,path:k?c:p,children:k?[]:{},selected:!1,is_file:k||g&&f.includes(".")}),u=u.children[f],g&&(u.selected=!0,u.exists=l)})}return s}r(yI,"build_path_tree");function bE(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>gE(s,e,bE(s,e))).join("")}</ul>`}r(bE,"tree_to_html");var vE=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var vI=r((n,e)=>!n||!e?!1:n===e||n.startsWith(`${e}/`)?!0:n.startsWith(`${e}#`),"is_nested_context_item");function kE(n,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(n?.data?.context_items||{}).filter(o=>vI(o,t));return[...new Set(i)]}r(kE,"get_nested_context_item_keys");var kI=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),wI=r(n=>{let e=!1;return()=>{e||(e=!0,kI(()=>{e=!1,n()}))}},"create_render_scheduler"),xI=r((n,e={})=>{let{target_path:t}=e,s=kE(n,{target_path:t});n.remove_items(s)},"remove_nested_context_items");function EI(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(EI,"build_html");async function wE(n,e={}){this.apply_style_sheet(vE);let t=EI(n,e),i=this.create_doc_fragment(t).firstElementChild;return SI.call(this,n,i,e),i}r(wE,"render");async function SI(n,e,t={}){let s=n?.env?.plugin,i=s?.registerDomEvent?.bind(s)||((l,d,_)=>l.addEventListener(d,_)),o=r(()=>{let l=n.env,d=n.context_items.filter(t.filter),_=yE(d),u=this.create_doc_fragment(_);this.empty(e),e.appendChild(u);for(let p=0;p<d.length;p++){let f=d[p],b=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!b){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(b),b.appendChild(g)})}},"render_tree_leaves"),a=wI(o);o(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");xI(n,{target_path:_})});let c=[];return c.push(n.on_event("context:updated",a)),this.attach_disposer(e,c),e}r(SI,"post_process");var xE=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function CI(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(CI,"build_html");async function EE(n,e={}){let t=CI(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(xE),await qI.call(this,n,s,e),s}r(EE,"render");async function qI(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let u=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let b=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',k=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',v="",y="";try{let A=await p.read();v=A.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),y=(await p.get_embed_input(A)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(A){console.error("[source_inspector] Error reading block:",A),v='<em style="color:red;">Error reading block content</em>'}let S=this.create_doc_fragment(`
<p>
${b}<br>
${g} | ${k}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${y}</pre>
</details>
<blockquote>${v}</blockquote>
<hr>
`);s.appendChild(S)}return e}r(qI,"post_process");var OE=require("obsidian");var _i=require("obsidian");var SE=require("obsidian");var zd=class extends SE.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var AE=require("obsidian");var Dd=class extends AE.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function CE(n,e,t={}){let{Menu:s=_i.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new _i.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new _i.Notice("Active note is not indexed by Smart Environment");return}new zd(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Dd(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new _i.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(CE,"register_status_bar_context_menu");var qE=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function $I(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r($I,"build_html");async function $E(n,e={}){this.apply_style_sheet(qE);let s=this.create_doc_fragment($I()).firstElementChild;return jI.call(this,n,s,e),s}r($E,"render");function jI(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),b=`Smart Env${a?" "+a:""}`,g="Smart Environment status",k=c(),v=n.event_logs?.notification_status||"info";f>0&&(b=`Embed now (${f})`,g="Click to re-import.",v="attention"),s&&(0,OE.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=y=>{y.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),k>0?i.dataset.count=String(k):delete i.dataset.count,v?i.dataset.level=String(v):delete i.dataset.level),o.setText?.(b),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=y=>{if(l()>0)y.preventDefault(),y.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let A=new MouseEvent("contextmenu",y);e.dispatchEvent?.(A)}},e.addEventListener("click",e._click_handler))},"render_status_elm");CE(n,e),d();let _=null,u=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",u)),this.attach_disposer(e,p)}r(jI,"post_process");var jE=require("obsidian");function TI(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(TI,"build_html");function TE(n,e={}){let t=TI.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return NI.call(this,n,i,e),i}r(TE,"render");async function NI(n,e){let t=e.querySelector(".callout-icon"),s=(0,jE.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(NI,"post_process");var NE=require("obsidian");function PI(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(PI,"build_html");function PE(n,e={}){let t=PI.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,NE.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),II.call(this,n,i,e),i}r(PE,"render");function II(n,e){}r(II,"post_process");var Hh=require("obsidian");async function IE(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new Hh.Notice("No context items to copy.");let t=await this.get_text(n);await Ld(t);let s=MI({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new Hh.Notice(s)}r(IE,"copy_to_clipboard");function MI(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${LI(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=zI(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(MI,"format_stats_message");function LI(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(LI,"format_char_count");function zI(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(zI,"sum_exclusions");var DI="xml_structured",Fd={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},ME=r((n={})=>{let e=n.template_preset||DI;return Fd[e]?e:"custom"},"get_preset_key"),Rd=r((n,e,t,s)=>{let i=ME(n),o=Fd[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function Bd(){return Object.entries(Fd).map(([n,e])=>({value:n,label:e.label||n}))}r(Bd,"get_template_preset_options");function LE(n={},e={}){return{template_before:Rd(n,e,"context_template_before","template_before"),template_after:Rd(n,e,"context_template_after","template_after")}}r(LE,"get_context_templates");function zE(n={},e={}){let t=ME(n),s=Fd[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:Rd(n,e,"item_template_before","template_before"),template_after:Rd(n,e,"item_template_after","template_after")}}r(zE,"get_item_templates");var RI=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),FI=r(n=>RI(n.key),"get_item_name");async function DE(n,e={}){let t={KEY:this.key,ITEM_NAME:FI(this),TIME_AGO:Zp(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(u,p)=>t[p]||"");return c},"replace_vars"),i=zE(this.settings,Jh);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(DE,"merge_template");var RE={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>Bd(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},Jh={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Wd(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=BI(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Ud(e),FE(e).trimEnd()}r(Wd,"build_file_tree_string");function BI(n){return typeof n=="string"&&n.endsWith("/")}r(BI,"is_folder_path");function Ud(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Ud(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Ud(n[i])}else Ud(t)}}}r(Ud,"compress_single_child_dirs");function FE(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=FE(o,e+(c?"    ":"\u2502   ")))}),t}r(FE,"build_tree_string");async function BE(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>Wd(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(u,p)=>s[p]?.()||"");return l},"replace_vars"),o=LE(this.settings,Vh),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(BE,"merge_template");var UE={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>Bd(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},Vh={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function $r(n={}){n?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:UI(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:r(({modal:s})=>{s.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}r($r,"context_suggest_blocks");function UI(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(UI,"get_block_display_name");var WE="Add blocks";var HE=require("obsidian");var WI=HE.Platform.isMacOS?"\u2318":"Ctrl";function GI(n){return typeof n!="string"?"":n.replace(/\/+$/g,"")}r(GI,"normalize_folder_path");function HI(n,e){let t=GI(e);return!t||n===t?!0:n.startsWith(`${t}/`)}r(HI,"is_source_in_folder");function GE(n){n?.inputEl&&(n.last_input_value=n.inputEl.value,n.inputEl.value="")}r(GE,"reset_modal_input");function JI(n,e){return Object.values(n.env?.smart_sources?.items||{}).filter(s=>HI(s.key,e))}r(JI,"get_sources_list");function VI(n,e){return e.map(t=>({key:t.key,display:t.key,select_action:r(()=>{n.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s}={})=>(GE(s),$r.call(n,{source_key:t.key,modal:s})),"mod_select_action"),arrow_right_action:r(({modal:s}={})=>(GE(s),$r.call(n,{source_key:t.key,modal:s})),"arrow_right_action")}))}r(VI,"build_source_suggestions");function JE(n={}){console.log("context_suggest_sources",n);let e=n?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${WI} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=JI(this,n?.folder_path||"");return VI(this,t)}r(JE,"context_suggest_sources");var VE="Add sources";async function Gd(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(Gd,"pre_process");function Kh(n){return this.vec?n.to_item?.vec?{score:Ts(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(Kh,"similarity");Kh.action_type="score";var Yh="Cosine Similarity",Xh="Ranks by cosine similarity between the current note and candidates.",KE={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${Yh} algorithm`,value:`${Xh}`}};async function YE(n=null){await ql(this,n)}r(YE,"source_open");var XE={collections:{embedding_models:g0,lookup_lists:Un},item_types:{EmbeddingModel:Rs,LookupList:Vt},items:{embedding_model:{class:Rs},lookup_list:{class:Vt}},modules:{},components:{collection_settings:{render:y0},context_item_leaf:{render:k0},env_stats:{render:w0},form_dropdown:{render:zh},lean_coffee_callout:{render:S0},milestones:{render:$0},notifications_feed:{render:j0},pro_plugins_list:{render:G0},pro_plugins_list_item:{render:H0},settings_env_model:{render:Y0},settings_env_model_type:{render:tE},settings_env_models:{render:sE},settings_env_sources:{render:aE},settings_model_actions:{render:cE},settings_notifications:{render:lE},settings_smart_env:{render:_E},smart_context_actions:{render:mE},smart_context_item:{render:hE},smart_context_meta:{render:fE},smart_context_tree:{render:wE},source_inspector:{render:EE},status_bar:{render:$E},supporter_callout:{render:TE},user_agreement_callout:{render:PE}},actions:{context_copy_to_clipboard:{action:IE},context_item_merge_template:{action:DE,settings_config:RE,default_settings:Jh},context_merge_template:{action:BE,settings_config:UE,default_settings:Vh},context_suggest_blocks:{action:$r,display_name:WE},context_suggest_sources:{action:JE,display_name:VE},lookup_list_pre_process:{action:Gd,pre_process:Gd},similarity:{action:Kh,settings_config:KE,display_name:Yh,display_description:Xh},source_open:{action:YE}}};var KI={env_path:"",modules:{smart_fs:{class:Nl,adapter:Pl},smart_view:{class:Dl,adapter:Fl},smart_embed_model:{class:tr,adapters:{transformers:si,openai:ad,ollama:dd,gemini:_d,lm_studio:ud}},smart_chat_model:{class:nr,adapters:{anthropic:ir,azure:ar,custom:yr,google:ii,gemini:dr,groq:br,lm_studio:ur,ollama:hr,open_router:_r,openai:Ds,xai:vr,deepseek:kr},http_adapter:new _t({adapter:ti,obsidian_request_url:Zh.requestUrl})},http_adapter:{class:_t,adapter:ti,obsidian_request_url:Zh.requestUrl}},collections:{context_items:c0,event_logs:d0,smart_components:n0,smart_contexts:r0,smart_sources:{collection_key:"smart_sources",class:Ko,data_adapter:Zo,source_adapters:{md:Is,txt:Is,"excalidraw.md":ed,base:Xl,canvas:Ql,rendered:Zl},content_parsers:[Zx],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:er,data_adapter:td,block_adapters:{md:Yn,txt:Yn,"excalidraw.md":Yn}}},item_types:{SmartSource:Vn,SmartBlock:Kn},items:{smart_source:Ix,smart_block:Bx},default_settings:p0,modals:{context_selector:{class:Sd,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:Cd},notifications_feed_modal:{class:Ad}}};Ot(KI,XE);var YI=require("obsidian");var XI=require("obsidian");var QI=require("obsidian");var ZI=require("obsidian");function Hd(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Hd,"get_smart_server_url");function ZE(n){return{token:localStorage.getItem(n+"token")||"",refresh:localStorage.getItem(n+"refresh")||""}}r(ZE,"get_local_storage_token");var eM="_smart_plugins_oauth_";function QE(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${eM}`}r(QE,"build_oauth_storage_prefix");var nM=require("obsidian");var sM=require("obsidian");var t1=require("obsidian");var a1=require("obsidian"),ve=require("@codemirror/view"),Vd=require("@codemirror/state");var Qh=r((n,e)=>Number.isInteger(e)&&e>0&&e<=n.lines,"line_exists");function s1(n={}){let e=typeof n.ttl_ms=="number"?n.ttl_ms:1e4,t=new Map;return{set:r(({key:o,value:a})=>{t.set(o,{timestamp:Date.now(),value:a})},"write_entry"),get:r(({key:o})=>{if(!t.has(o))return null;let a=t.get(o);return Date.now()-a.timestamp>e?(t.delete(o),null):a.value},"read_entry"),clear:r(()=>t.clear(),"clear")}}r(s1,"create_inline_cache");function n1(n){let e=n.settings??{},t=e.inline_connections_score_threshold??"",s=e.score_algo_key??"",i=e.results_collection_key??"";return`${n.block_key}|${n.block_hash}|${s}|${i}|${t}`}r(n1,"make_cache_key");function i1(n){let e=typeof n?.buffer=="number"?n.buffer:0,t=e>0?Math.floor(e):0,s=n?.doc;if(!s||typeof s.length!="number"||typeof s.lineAt!="function")return{min_line:1,max_line:1};let i=Number(s.length)||0;if(i===0)return{min_line:1,max_line:1};let o=r(_=>(_=Number(_),!Number.isFinite(_)||_<0?0:_>i?i:_),"clamp"),c=(Array.isArray(n.ranges)&&n.ranges.length?n.ranges:[{from:0,to:i}]).reduce((_,u)=>{let p=o(u.from),f=o(u.to),b=s.lineAt(p).number,g=s.lineAt(f).number;return{start:Math.min(_.start,b),end:Math.max(_.end,g)}},{start:Number.POSITIVE_INFINITY,end:0}),l=Math.max(1,c.start-t),d=c.end+t;return{min_line:l,max_line:d}}r(i1,"get_visible_window");function oM(n,e){if(!n||!e)return!1;let t=Number(n.start),s=Number(n.end),i=Number(e.start),o=Number(e.end);return!Number.isFinite(t)||!Number.isFinite(s)||!Number.isFinite(i)||!Number.isFinite(o)||t>s||i>o?!1:t<=o&&i<=s}r(oM,"ranges_overlap");function o1(n,e){if(!Array.isArray(n)||!n.length)return!1;for(let t of n){if(!Array.isArray(t)||t.length<2)continue;let[s,i]=t;if(oM({start:s,end:i},e))return!0}return!1}r(o1,"any_range_overlaps");var rM=typeof window<"u"?window:globalThis,aM=r(n=>{let e=rM?.requestIdleCallback;return typeof e=="function"?e(n,{timeout:250}):setTimeout(()=>n({timeRemaining:r(()=>0,"timeRemaining"),didTimeout:!0}),16)},"request_idle_default"),r1=r(({request_idle_fn:n=aM,max_concurrent:e=1}={})=>{let t=0,s=[],i=r(()=>{if(t>=e||!s.length)return;let{job:a,resolve:c,reject:l}=s.shift();t+=1,n(()=>{Promise.resolve().then(a).then(c,l).finally(()=>{t-=1,i()})})},"drain_queue");return{enqueue_job:r(a=>new Promise((c,l)=>{s.push({job:a,resolve:c,reject:l}),i()}),"enqueue_job")}},"create_job_scheduler");var ef=Vd.StateEffect.define(),cM=Vd.StateField.define({create:r(()=>ve.Decoration.none,"create"),update:r((n,e)=>{for(let t of e.effects)if(t.is(ef))return t.value;return e.docChanged?n.map(e.changes):n},"update"),provide:r(n=>ve.EditorView.decorations.from(n),"provide")}),{enqueue_job:lM}=r1({max_concurrent:2}),dM=1e4,_M=40,Jd=s1({ttl_ms:dM}),tf=class extends ve.WidgetType{static{r(this,"BadgeWidget")}constructor({block_key:e,plugin:t,block_hash:s}){super(),this.block_key=e,this.block_hash=s,this.plugin=t,this.plugin.env.create_env_getter(this),this._checked=!1,this._pending=null}eq(e){return e.block_key===this.block_key&&e.block_hash===this.block_hash}toDOM(){let e=document.createElement("span");e.className="sc-block-badge sc-loading",e.title="Connections",e.dataset.blockKey=this.block_key,e.style.cssText="cursor:pointer;user-select:none;opacity:0;position:absolute;top:0;right:-1rem;",e.appendChild((0,a1.getIcon)("smart-connections"));let t=new IntersectionObserver(s=>{s[0].isIntersecting&&(t.disconnect(),this._check_connections(e))},{root:null,threshold:0,rootMargin:"200px 0px"});return t.observe(e),requestAnimationFrame(()=>{if(!e.isConnected)return;let s=e.getBoundingClientRect();s.bottom>0&&s.top<window.innerHeight&&s.right>0&&s.left<window.innerWidth&&this._check_connections(e)}),e.addEventListener("mouseenter",async()=>{this._checked||await this._check_connections(e),e.classList.contains("sc-has-hits")&&this._show_popover(e)}),e}ignoreEvent(){return!1}get connections_list(){return this.block?.connections||this.env.connections_lists.new_item(this.block)}async _check_connections(e){if(!this._checked){this._pending||(this._pending=lM(()=>this.#t(e)));try{await this._pending}finally{this._pending=null}}}async#t(e){if(!this.block||!e.isConnected){try{e.remove()}catch{}return}let t=this.env?.connections_lists,s=t?.settings||{},i=s.inline_connections_score_threshold?parseFloat(s.inline_connections_score_threshold):.8,o=n1({block_key:this.block_key,block_hash:this.block_hash,settings:s}),a=Jd.get({key:o});if(a){this.#e(e,a.ok,a.items);return}let l=this.connections_list.filter_and_score({limit:10,score_algo_key:t.score_algo_key,results_collection_key:t.results_collection_key,to_item:this.block,filter:{exclude_keys:[this.block.source_key],exclude_key_starts_with_any:[this.block.source_key]}}).filter(_=>_.score>=i),d=l.length>0;Jd.set({key:o,value:{ok:d,items:l}}),this.#e(e,d,l)}#e(e,t,s){if(this._checked=!0,!t){e.style.display="none";try{e.remove()}catch{}return}e.style.transition="opacity 0.5s ease-in-out",e.style.opacity=1,e.classList.remove("sc-loading"),e.classList.add("sc-has-hits"),e._inline_results=s}get block(){return this.env.smart_blocks.get(this.block_key)}async _show_popover(e){if(e._popover||!this.block)return;let t=await this.env.render_component("inline_connections_popover",this,{precomputed_items:e._inline_results});document.body.appendChild(t),uM(t,e),e._popover=t;let s=null,i=r(()=>s=setTimeout(a,300),"schedule_hide"),o=r(()=>s&&clearTimeout(s),"cancel_hide"),a=r(()=>{try{t.remove()}catch{}e._popover=null},"close");e.addEventListener("mouseleave",i,{once:!0}),t.addEventListener("mouseenter",o),t.addEventListener("mouseleave",i),e.removeAttribute("title")}},sf=ve.ViewPlugin.fromClass(class{constructor(n){this.view=n,window.smart_env.create_env_getter(this),this.plugin=this.env?.smart_connections_plugin,this.badges=ve.Decoration.none,this.is_ready=!1,this.off_settings=this.env?.events?.on?.("settings:changed",()=>Jd.clear()),this.off_opened=this.env?.events?.on?.("sources:opened",()=>{Jd.clear(),this.schedule_refresh(0)}),setTimeout(()=>{this.is_ready=!0,this.schedule_refresh(0)},1300)}schedule_refresh(n=300){clearTimeout(this.timer),this.timer=setTimeout(()=>this.refresh(),n)}update(n){(n.docChanged||n.selectionSet||n.viewportChanged)&&this.schedule_refresh(150)}async refresh(){let{plugin:n,view:e}=this;if(!this.is_ready){this.schedule_refresh(200);return}let t=n?.env?.connections_lists?.settings;if(!t?.inline_connections){this.badges=ve.Decoration.none;try{requestAnimationFrame(()=>e.dispatch({effects:[ef.of(this.badges)]}))}catch(d){console.error("[Smart Connections] Decoration clear failed",d)}return}if(!this.env||this.env.state!=="loaded"){this.schedule_refresh();return}let s=n.app.workspace.getActiveFile();if(!s)return;let i=this.env.smart_sources.items[s.path],o=Array.isArray(i?.data?.codeblock_ranges)?i.data.codeblock_ranges:[],a=(i?.blocks??[]).filter(d=>d.vec),c=i1({doc:e.state.doc,ranges:e.visibleRanges,buffer:_M}),l=[];for(let d of a){let _=d.line_start;if(_<c.min_line||_>c.max_line||!Qh(e.state.doc,_))continue;let u=d.line_end??_+1;if(!Qh(e.state.doc,u)||t?.inline_connections_skip_codeblocks&&o1(o,{start:_,end:u}))continue;let p=e.state.doc.line(_),f=p.to;if(f>e.state.doc.length)continue;let b=e.state.doc.line(u),g=e.state.doc.sliceString(p.from,b.to),k=Ol(g);d.data.last_read?.hash===k&&l.push(ve.Decoration.widget({side:1,widget:new tf({block_key:d.key,plugin:n,block_hash:k})}).range(f))}this.badges=l.length?ve.Decoration.set(l,!0):ve.Decoration.none;try{requestAnimationFrame(()=>this.view.dispatch({effects:[ef.of(this.badges)]}))}catch(d){console.error("[Smart Connections] Decoration dispatch failed",d)}}destroy(){clearTimeout(this.timer);try{this.off_settings?.()}catch{}try{this.off_opened?.()}catch{}}});function uM(n,e){let t=e.getBoundingClientRect(),s=n.getBoundingClientRect(),i=t.right+6,o=t.top;i+s.width>window.innerWidth&&(i=Math.max(t.left-s.width-6,0)),o+s.height>window.innerHeight&&(o=Math.max(window.innerHeight-s.height-8,0)),n.style.left=`${i}px`,n.style.top=`${o}px`}r(uM,"show_popover_relative_to_anchor");var c1=r(()=>[cM,sf],"connections_inline_extension");var I=require("obsidian");function mM(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(mM,"sort_by_score");function l1(n,e){return mM(n,e)}r(l1,"sort_by_score_descending");function _1(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=d1(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=d1(n.results);n.min=s,n.minResult=i}}r(_1,"results_acc");function d1(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(d1,"find_min");var jr="score_connection",u1="Returns the connection score between two files.",m1="Score Connection",p1=r(n=>{if(!n.app.internalPlugins.plugins?.bases?.enabled)return;let t=r((c,l)=>{try{let d=globalThis.smart_env||{};if(d.state!=="loaded")return new I.StringValue("Smart Env not ready.");let _=d.smart_sources;if(!_)return new I.StringValue("Smart Sources not ready.");let u=nf(c),p=nf(l);if(!u)return new I.StringValue("Missing item a.");if(!p)return new I.StringValue("Missing item b.");let{metadata_cache:f}=n.app,b=n.app.vault.getAbstractFileByPath(u)??f.getFirstLinkpathDest(u,""),g=n.app.vault.getAbstractFileByPath(p)??f.getFirstLinkpathDest(p,"");if(!b)return new I.StringValue(`File not found: ${u}`);if(!g)return new I.StringValue(`File not found: ${p}`);let k=_.get(b.path),v=_.get(g.path);if(!k)return new I.StringValue(`No Smart Source for: ${u}`);if(!v)return new I.StringValue(`No Smart Source for: ${p}`);if(!k.vec)return new I.StringValue(`No embedding for: ${u}`);if(!v.vec)return new I.StringValue(`No embedding for: ${p}`);let y=d.connections_lists.score_algo_key,S={to_item:v,score_algo_key:y},{score:A}=k.score(S);return new I.NumberValue(Number.isFinite(A)?Math.round(A*100)/100:0)}catch(d){return console.error("Error in score_connection:",d),new I.StringValue("Error computing connection score, see console for details.")}},"score_connections_handler");n.registerGlobalFunc({name:jr,params:[{name:"file",type:[I.Value,I.FileValue,I.StringValue]},{name:"compared_to",type:[I.Value,I.FileValue,I.StringValue]}],docString:u1,ctx:null,applyWithContext(c,...l){return t(...l)}}),n.registerInstanceFunc(I.FileValue,{name:jr,params:[{name:"self",type:[I.Value,I.FileValue]},{name:"compared_to",type:[I.Value,I.FileValue,I.StringValue]}],docString:u1,ctx:null,applyWithContext(c,...l){return console.log("score_connections_handler ctx and args:",{_ctx:c,args:l}),t(...l)}});let s=r(c=>{try{let d=globalThis.smart_env||{};if(d.state!=="loaded")return new I.StringValue("Smart Env not ready.");let _=d.smart_sources;if(!_)return new I.StringValue("Smart Sources not ready.");let u=nf(c);if(!u)return new I.StringValue("Missing item.");let{metadata_cache:p}=n.app,f=n.app.vault.getAbstractFileByPath(u)??p.getFirstLinkpathDest(u,"");if(!f)return new I.StringValue(`File not found: ${u}`);let b=_.get(f.path);if(!b)return new I.StringValue(`No Smart Source for: ${u}`);if(!b.vec)return new I.StringValue(`No embedding for: ${u}`);let g=d.connections_lists.score_algo_key,k={to_item:b,score_algo_key:g},v=[],{results:y}=Object.values(_.items).reduce((j,C)=>{let x=C.filter_and_score({...k,filter:{exclude_keys:[b.key]}});return x?.score?(_1(j,x,5),j):(x?.error&&v.push(x.error),j)},{min:0,results:new Set}),S=Array.from(y).sort(l1);console.log("connections_list_handler results:",S);let A=S.map(j=>I.LinkValue.parseFromString(n.app,`[[${j.item.key}|${j.score?.toFixed(2)??"n/a"} ${j.item.name}]]`));console.log("connections_list_handler links:",A);let $=new I.ListValue(A);return console.log("connections_list_handler list:",$),$}catch(d){return console.error("Error in connections_list:",d),new I.StringValue("Error retrieving connections list, see console for details.")}},"connections_list_handler");n.registerGlobalFunc({name:"list_connections",params:[{name:"file",type:[I.Value,I.FileValue,I.StringValue]}],docString:"Returns a list of top 5 connections for the given file.",ctx:null,applyWithContext(c,...l){return s(...l)}}),n.registerInstanceFunc(I.FileValue,{name:"list_connections",params:[{name:"self",type:[I.Value,I.FileValue]}],docString:"Returns a list of top 5 connections for the given file.",ctx:null,applyWithContext(c,...l){return s(...l)}});let i=n.app.workspace,o=i.operatorFuncConfigs?.bases||[];o.some(c=>c?.funcName===jr)||i.registerOperatorFuncConfigs("bases",[...o,{funcName:jr,display:m1,inverseDisplay:"Inverse "+m1}]),n.register(()=>{i?.unregisterOperatorFuncConfigs?.("bases",[jr])})},"register_bases_integration"),nf=r(n=>{if(n){if(typeof n=="string")return n;if(typeof n=="object"){let e=n;if(typeof e.path=="string")return e.path;if(typeof e.value=="string")return e.value;if(typeof e.file=="string")return e.file;if(e.file&&typeof e.file.path=="string")return e.file.path;if(e.file?.file&&typeof e.file.file.path=="string")return e.file.file.path;if(typeof e.data=="string")return e.data}}},"value_to_path");var Rve=Object.getPrototypeOf(async function(){}).constructor;var f1=require("obsidian");var gM=r((n,e)=>{let t=e.getActiveFile();return t&&n.smart_sources?.get(t.path)||null},"get_active_entity"),h1=r(n=>{try{if(!n?.state?.doc)return!1;let e=n.state.doc,t=e.line(e.lines),s=t.from,i=t.to;return(Array.isArray(n.visibleRanges)?n.visibleRanges:[]).some(o=>o.from<=i&&o.to>=s)}catch(e){return console.warn("[Smart Connections] last-line visibility check failed",e),!1}},"is_last_line_visible"),Kd=class{static{r(this,"ConnectionsFooterView")}constructor(e){this.plugin=e,this.app=e.app,this.register_env_listeners(),this.container_map={},this._detach_visibility_guard=null}get env(){return this.plugin.env}attach_visibility_guard(e){if(this.detach_visibility_guard(),!e)return;let t=e.scrollDOM||e.dom||null;if(!t)return;let s=!1,i=r(()=>{s||(s=!0,requestAnimationFrame(()=>{s=!1,h1(e)&&(this.detach_visibility_guard(),this.render_view())}))},"check_and_render"),o=r(()=>i(),"on_scroll"),a=r(()=>i(),"on_resize");t.addEventListener("scroll",o,{passive:!0}),window.addEventListener("resize",a),this._detach_visibility_guard=()=>{try{t.removeEventListener("scroll",o)}catch{}try{window.removeEventListener("resize",a)}catch{}this._detach_visibility_guard=null}}detach_visibility_guard(){typeof this._detach_visibility_guard=="function"&&this._detach_visibility_guard()}async render_view(){if(!this.env.connections_lists?.settings?.footer_connections)return this.remove();let e=this.plugin.get_editor_view();if(!e)return;if(!h1(e)){try{e.dispatch({effects:[$s.of(null)]})}catch(i){console.warn("[Smart Connections] footer hide dispatch failed",i)}this.attach_visibility_guard(e);return}this.detach_visibility_guard();let t=gM(this.env,this.app.workspace);if(!t){e.dispatch({effects:[$s.of(null)]});return}if(this.container_map[t.key]?.isConnected){e.dispatch({effects:[$s.of(this.container_map[t.key])]});return}let s=await this.env.render_component("connections_footer_view",this,{connections_item:t});if(this.container_map[t.key]&&this.container_map[t.key]instanceof HTMLElement&&this.container_map[t.key].remove(),this.container_map[t.key]=s,e.dispatch({effects:[$s.of(s)]}),f1.Platform.isMobile){let i=this.container_map[t.key],o=i.querySelector(".status-bar-mobile")??i.createDiv({cls:"status-bar-mobile"});o.empty();let a=o.createDiv({cls:"status-bar-item"});this.env.smart_components.render_component("status_bar",this.env).then(c=>a.appendChild(c))}}remove(){let e=this.plugin.get_editor_view();if(this.detach_visibility_guard(),e)try{e.dispatch({effects:[$s.of(null)]})}catch(t){console.warn("[Smart Connections] footer remove dispatch failed",t)}}register_env_listeners(){let e;this.register_env_listener("sources:opened",(t={})=>{e&&clearTimeout(e),e=setTimeout(()=>{this.render_view()},250)}),this.register_env_listener("settings:changed",t=>{t.path?.includes("connections_lists")&&this.render_view()})}register_env_listener(e,t){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on(e,t))}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}unload(){this.detach_visibility_guard(),this.env_listeners&&(this.env_listeners.forEach(e=>e()),this.env_listeners=[])}};var g1=require("obsidian");var Yd=class{static{r(this,"ConnectionsCodeblock")}constructor(e){this.plugin=e,this.app=e.app,this.plugin.env.create_env_getter(this),this.register_env_listeners()}async render(e,t,s){t.empty(),t.createEl("span",{text:"Loading\u2026"});let i=this.env.smart_sources.get(s.sourcePath)??this.env.smart_sources.init_file_path(s.sourcePath);if(!i){t.empty(),t.createEl("p",{text:"Entity not found: "+s.sourcePath});return}let o=e,a=JSON.parse(e.trim()||"{}"),c=await this.env.smart_components.render_component("connections_codeblock",this,{connections_item:i,connections_settings:a});t.empty(),t.appendChild(c),o!==e&&yM(s,o)}register_env_listeners(){this.register_env_listener("settings:changed",e=>{e.path?.includes("connections_lists")&&this.render()})}register_env_listener(e,t){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on(e,t))}open_settings(){new of(this.app,this.env,this.connections_settings).open()}};function yM(n,e){if(typeof n.replaceCode=="function")return n.replaceCode(e.trim()+`
`)}r(yM,"update_codeblock");var of=class extends g1.Modal{static{r(this,"ConnectionsCodeblockModal")}constructor(e,t,s={}){super(e),this.env=t,this.connections_settings=s}async onOpen(){this.titleEl.setText("Connections Codeblock"),this.contentEl.empty(),console.log("Opening ConnectionsCodeblockModal with codeblock_ctx:",this.connections_settings);let e=await this.env.smart_view.render_settings(this.env.connections_lists.settings_config,{scope:{settings:this.connections_settings}});this.contentEl.appendChild(e)}};function bM(n){return n?String(n).trim().replace(/^v/i,""):""}r(bM,"normalize_version");function y1(n){let e=bM(n);if(!e)return{core:[],prerelease:""};let[t,s=""]=e.split("-",2);return{core:t.split(".").map(o=>{let a=Number.parseInt(o,10);return Number.isNaN(a)?0:a}),prerelease:s}}r(y1,"split_version");function vM(n,e){let t=y1(n),s=y1(e);if(!(s.core.length>0||s.prerelease.length>0))return 0;if(!(t.core.length>0||t.prerelease.length>0))return 1;let a=Math.max(t.core.length,s.core.length);for(let d=0;d<a;d+=1){let _=t.core[d]??0,u=s.core[d]??0;if(u>_)return 1;if(u<_)return-1}let c=t.prerelease.length>0,l=s.prerelease.length>0;return c&&!l?1:!c&&l?-1:!c&&!l||s.prerelease===t.prerelease?0:s.prerelease>t.prerelease?1:-1}r(vM,"compare_versions");function b1(n,e){return vM(n,e)>0}r(b1,"should_notify_update");var ae=require("obsidian");var Tr="smart_tasks",v1="Smart Tasks",k1="Returns number of tasks using Smart Environment.",w1=r(n=>{if(!n.app.internalPlugins.plugins?.bases?.enabled)return;let t=r(a=>{try{let l=globalThis.smart_env||{};if(l.state!=="loaded")return new ae.StringValue("Smart Env not ready.");let d=l.smart_sources;if(!d)return new ae.StringValue("Smart Sources not ready.");let _=kM(a);if(!_)return new ae.StringValue("Missing item.");let{metadata_cache:u}=n.app,p=n.app.vault.getAbstractFileByPath(_)??u.getFirstLinkpathDest(_,"");if(!p)return new ae.StringValue(`File not found: ${_}`);let f=d.get(p.path);if(!f)return new ae.StringValue(`No Smart Source for: ${_}`);let b=f.data?.tasks?.incomplete?.top||[],g=Object.entries(f.data?.blocks||{}).filter(([y,S])=>!!y.includes("next")),k=b.filter(y=>g.some(([S,A])=>y>=A[0]&&y<=A[1])),v={all:f.data?.task_lines?.length||0,incomplete:f.data?.tasks?.incomplete?.all?.length||0,incomplete_top:b?.length||0,next:k?.length||0};return new ae.ObjectValue(v)}catch(l){return console.error("Error in smart_tasks:",l),new ae.StringValue("Error retrieving tasks count, see console for details.")}},"tasks_count");n.registerGlobalFunc({name:Tr,params:[{name:"file",type:[ae.Value,ae.FileValue,ae.StringValue]}],docString:k1,ctx:null,applyWithContext(a,...c){return t(...c)}}),n.registerInstanceFunc(ae.FileValue,{name:Tr,params:[{name:"self",type:[ae.Value,ae.FileValue]}],docString:k1,ctx:null,applyWithContext(a,...c){return t(...c)}});let s=n.app.workspace,i=s.operatorFuncConfigs?.bases||[];i.some(a=>a?.funcName===Tr)||s.registerOperatorFuncConfigs("bases",[...i,{funcName:Tr,display:v1,inverseDisplay:"Inverse "+v1}]),n.register(()=>{s?.unregisterOperatorFuncConfigs?.("bases",[Tr])})},"register_bases_tasks_integration"),kM=r(n=>{if(n){if(typeof n=="string")return n;if(typeof n=="object"){let e=n;if(typeof e.path=="string")return e.path;if(typeof e.value=="string")return e.value;if(typeof e.file=="string")return e.file;if(e.file&&typeof e.file.path=="string")return e.file.path;if(e.file?.file&&typeof e.file.file.path=="string")return e.file.file.path;if(typeof e.data=="string")return e.data}}},"value_to_path");var ui=require("obsidian");function x1(n="",e,t=""){if(!e)return n??"";let s=t||e.split("/").pop().replace(/\.md$/i,""),i=e==="this.file.file"?"this.file.file":`"${e}"`,o=`  ${s}: score_connection(file.file, ${i})`,a=`  formula.${s}: ${s}`,c=`      - formula.${s}`,l=(n??"").split(/\r?\n/),d=l.findIndex(_=>/^formulas:\s*$/i.test(_));if(d===-1?l.unshift("formulas:",o):l.some(_=>_.trimStart()===o.trimStart())||(d=rf(l,d,/^\s{2}\S/),l.splice(d+1,0,o)),d=l.findIndex(_=>/^display:\s*$/i.test(_)),d===-1){let _=l.findIndex(p=>/^formulas:\s*$/i.test(p)),u=rf(l,_,/^\s{2}\S/)+1;l.splice(u,0,"display:",a)}else l.some(_=>_.trimStart()===a.trimStart())||(d=rf(l,d,/^\s{2}\S/),l.splice(d+1,0,a));if(d=l.findIndex(_=>/^views:\s*$/i.test(_)),d===-1)l.push("views:","  - type: table","    name: Table","    order:","      - file.name",c);else{let _=-1;for(let u=d+1;u<l.length;u++)if(/^\s*-\s+type:\s+table/i.test(l[u])){if(_=l.findIndex((p,f)=>f>u&&/^\s*order:\s*$/i.test(p)),_===-1){let p=l.findIndex((b,g)=>g>u&&/^\s*name:\s+/i.test(b)),f=p!==-1?p+1:u+1;l.splice(f,0,"    order:","      - file.name",c)}break}_!==-1&&!l.some(u=>u.trimStart()===c.trimStart())&&l.splice(_+1,0,c)}return l.filter(_=>_.trim()).join(`
`).trim()}r(x1,"insert_score_connection_column");var rf=r((n,e,t)=>{let s=e+1;for(;s<n.length&&t.test(n[s]);)s++;return s-1},"find_block_end"),af=r(n=>!!n&&n.extension==="base","is_base_file");var cf=class extends ui.FuzzySuggestModal{static{r(this,"ConnectionsScoreColumnModal")}constructor(e){super(e),this.items=["Current/active file (dynamic)",...Object.keys(window.smart_env?.smart_sources?.items||{})],this.setPlaceholder("Select note for similarity\u2026")}getItems(){return this.items}getItemText(e){return e}onChooseItem(e){this.#t(e)}async#t(e){let t=this.app.workspace.getActiveFile();if(!af(t)){new ui.Notice("No active .base file");return}let s;e==="Current/active file (dynamic)"&&(e="this.file.file",s="score");let i=await this.app.vault.read(t),o=x1(i,e,s);if(i===o){new ui.Notice("Connections score column already present");return}await this.app.vault.modify(t,o),this.#e(),new ui.Notice(`Added score_connection column for ${e}`)}#e(){this.app.workspace.getLeavesOfType("bases").forEach(e=>e.isVisible()&&e.rebuildView())}};function E1(n){n.addCommand({id:"sc-add-connections-score-column",name:"Add: Connections score bases column",checkCallback:r(e=>{let t=af(n.app.workspace.getActiveFile());return e?t:t?(new cf(n.app).open(),!0):!1},"checkCallback")})}r(E1,"register_connections_score_command");function Xd(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Xd,"collection_instance_name_from");function Bs(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(S1(e[t])&&S1(n[t])?Bs(n[t],e[t]):n[t]=e[t]);return n}r(Bs,"deep_merge");function S1(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(S1,"is_plain_object");function A1(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(A1,"create_uid");function C1(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(C1,"camel_case_to_snake_case");function Zd(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Zd(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Zd(n[o],e[o],t))}return n===e}r(Zd,"deep_equal");function lf(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(lf,"get_item_display_name");function Qd(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let q=Object.getOwnPropertyDescriptor(m,w);if(!q)continue;let E={...q};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let q of h){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E){let O=E.value;if(c(O)){w=!0;continue}if(s(O)){if(_(O)){w=!0;continue}return!1}if(typeof O>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),w=new Map;for(let q of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E&&_(E.value)){w.set(q,d(E.value));continue}try{Object.defineProperty(h,q,u(E))}catch{h[q]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:b}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=r((m,h,w=[])=>{if(!m||!h)return;let q=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(q.has(E))continue;let O=Object.getOwnPropertyDescriptor(m,E);if(O)try{Object.defineProperty(h,E,O)}catch{h[E]=O.value}}},"copy_metadata"),y=r(m=>{let h=new m(n),w=h.action||h.run||h.execute||h.call;if(i(w)){let q=w.bind(h);return v(m,q),v(h,q),q.instance=h,q}return v(m,h),h},"instantiate_class"),S=r(m=>{if(o(m))return y(m);if(a(m)){let h=m.action.bind(n);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return v(m,h),h}return s(m)?d(m):m},"bind_or_clone"),A=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=b.get(m);return h&&s(h)?h:null},"scope_actions_for"),$=r((m,h,w)=>(m[h]=w,w),"cache_result"),j=r((m,h)=>{let w=A();return w&&g(w,h)?$(m,h,S(w[h])):g(f,h)?$(m,h,S(f[h])):$(m,h,void 0)},"compute_and_cache"),C=r(()=>{let m=A(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let w=A();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:r(()=>C(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return x(m,h);let w=A();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:r((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(Qd,"create_actions_proxy");var ts=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Bs(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return A1(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return Bs(s,t),!Zd(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:b}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||b&&!b.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Qd(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Xd(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Xd(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),C1(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return lf(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var wM=Object.getPrototypeOf(async function(){}).constructor,jt=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof wM?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Bs(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Qd(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var e_=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Nr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Nr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var t_=class extends e_{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Pr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Pr=class extends Nr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var q1={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Ir=class extends t_{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=mi;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},mi=class extends Pr{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+u]=d,delete o[l]);let f=this.env[_];if(!f)continue;let b=f.get(u);if(d.key||(d.key=u),b)b.data=d,b._queue_load=!1,b.loaded_at=Date.now();else{let g=f.item_type,k=new g(this.env,d);k._queue_load=!1,k.loaded_at=Date.now(),f.set(k)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return q1[s]&&(s=q1[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function df(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():O1(a)?n[o]=df(O1(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(df,"ajson_merge");function O1(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(O1,"is_object");var $1={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function xM(n){let e=!1,[t,...s]=n.split(":");return $1[t]&&(t=$1[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(xM,"_parse_ajson_key");var Mr=class extends Ir{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:b,item_key:g,changed:k}=xM(p),v=`${b}:${g}`;f?(i[v]=f,(k||v!==p)&&(delete i[p],t=!0)):(delete i[v],(k||v!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=df(f.data,l);else{let b=p.item_type;f=new b(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},_f=class extends mi{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},Lr={collection:Mr,item:_f};function EM(n){if(n==null)return"";let e;if(Array.isArray(n))e=n.map(t=>t==null?"":String(t)).join(", ");else if(typeof n=="object")try{e=JSON.stringify(n)}catch{e=String(n)}else e=String(n);return e.startsWith("formula.")&&(e=e.replace("formula.","")),e.startsWith("note.")&&(e=e.replace("note.","")),e.startsWith("file.")&&(e=e.replace("file.","")),e.replace(/\|/g,"\\|").replace(/\r?\n/g,"<br>")}r(EM,"stringify_cell");function SM(n){if(!Array.isArray(n)||n.length===0)return[];let e=n.map(s=>Array.isArray(s)?s:[s]),t=e.reduce((s,i)=>Math.max(s,i.length),0);return e.map(s=>Array.from({length:t},(i,o)=>EM(s[o])))}r(SM,"normalize_table");function AM(n){if(n.length===0)return[];let e=n[0].length,t=Array.from({length:e},()=>0);return n.forEach(s=>{for(let i=0;i<e;i++){let o=(s[i]??"").length;o>t[i]&&(t[i]=o)}}),t.map(s=>Math.max(s,3))}r(AM,"compute_col_widths");function CM(n,e){let t=n??"";return t.length>=e?t:t+" ".repeat(e-t.length)}r(CM,"pad_cell");function uf(n,e){return`| ${n.map((s,i)=>CM(s,e[i])).join(" | ")} |`}r(uf,"build_row");function qM(n){let e=SM(n);if(e.length===0)return"";let t=AM(e),s=uf(e[0],t),i=t.map(c=>"-".repeat(c)),o=uf(i,t),a=e.slice(1).map(c=>uf(c,t));return[s,o,...a].join(`
`)}r(qM,"to_markdown_table");function OM(n,e){if(!(typeof e!="string"||e.length===0))return e.split(".").reduce((t,s)=>{if(t!=null){if(s==="formula")return t?.formulaResults?.cachedFormulaOutputs;if(s==="note")return t?.note?.data??t?.note;if(["size","mtime","ctime"].includes(s))return t?.stat?.[s];if(s==="links")try{return(globalThis.smart_env?.smart_sources?.get?.(n?.file?.path)?.outlinks||[]).map(o=>`[[${o?.key??o}]]`).join(", ")}catch{return""}return s==="name"?`[[${t?.name??""}]]`:t?.[s]}},n)}r(OM,"get_value_from_path");function $M(n){return n?.linkText?.includes(".base")??!1}r($M,"is_bases_child");async function jM(n,e=300){await new Promise(s=>setTimeout(s,e));let t=n?._children?.[0]?.view;return t?.data?t:null}r(jM,"get_base_file_view");function j1(n){let e=n?.propertiesCache;if(!Array.isArray(e)||e.length===0)return[];let t=n?.groupedDataCache;if(!Array.isArray(t)||t.length===0)return[];let s=t[t.length-1];if(!s||!Array.isArray(s.entries))return[];let i=e.map(a=>a),o=s.entries.map(a=>e.map(c=>{let l=OM(a,c);return Array.isArray(l?.data)&&typeof l.data?.[0]?.data=="string"?l.data.map(d=>d?.sourcePath?`[[${d.data}]]`:d?.data??"").join(", "):l&&typeof l=="object"&&"data"in l?l.data??"":typeof l!="object"?l??"":""}));return[i,...o]}r(j1,"get_bases_output");function TM(n){if(!Array.isArray(n))return new Set;let e=n.map(t=>t?.link??t?.path??t?.displayText??t?.original??t?.rawText??"").filter(t=>typeof t=="string"&&t.includes(".base"));return new Set(e)}r(TM,"get_base_links");var s_=class extends ts{static{r(this,"BasesCache")}get collection(){return this.env.bases_caches}get markdown_table(){let e=this.data?.bases_output;return qM(e)}},mf=class extends jt{static{r(this,"BasesCaches")}static version=1;#t=null;#e=new Map;#o="";#n=new WeakSet;#i=null;#s=200;#a=3e4;#l=3e4;#r=0;#c=!1;init(){if(this.#c)return;this.#c=!0;let e=globalThis.app?.workspace;if(!e){console.warn("BasesCaches.init: no app.workspace available");return}let t=r(()=>this.start_watchers(),"handler");this.env.plugin.registerEvent(e.on("active-leaf-change",t)),typeof this.env.plugin.register=="function"&&this.env.plugin.register(()=>this.stop_watchers()),this.start_watchers()}get_base_file_view(e){return jM(e)}start_watchers(){this.stop_watchers();let e=this.#r,t=globalThis.app?.workspace?.getActiveFileView?.();if(!t)return console.warn("No file view");let s=t.file?this.env.smart_sources?.get(t.file.path):null;this.#o=s?.key||t.file?.path||"",this.#n=new WeakSet,this.prune_missing_base_caches({source:s});let i=t?.editor?.editorComponent;if(i){let o=r(()=>{if(e!==this.#r)return;let a=[];try{a=i._children||[]}catch{a=[]}let c=new Set;a.forEach(l=>{$M(l)&&(c.add(l),!this.#n.has(l)&&(this.#n.add(l),this.watch_base_child(l,e)))}),this.sweep_orphan_watchers(c)},"scan_children");o(),this.#t=this.set_interval(o,this.#s)}this.get_base_file_view(t).then(o=>{e===this.#r&&(o?(this.#i=o,this.watch_base_file(o,e)):this.#i=null)}).catch(o=>{e===this.#r&&console.warn("BasesCaches: get_base_file_view failed",o)})}set_interval(e,t){return setInterval(e,t)}clear_interval(e){clearInterval(e)}sweep_orphan_watchers(e){let t=new Set(e);this.#i&&t.add(this.#i),this.#e.forEach((s,i)=>{if(s?.generation!==this.#r){this.clear_interval(s.id),this.#e.delete(i);return}let o=t.has(i),a=!0;try{let c=i?.containerEl||i?._children?.[0]?.viewContainerEl||i?.viewContainerEl||null;c&&typeof c.isConnected=="boolean"&&(a=c.isConnected)}catch{a=!1}(!o||!a)&&(this.clear_interval(s.id),this.#e.delete(i))})}watch_base_child(e,t=this.#r){if(this.#e.has(e))return;let s=e?.linkText??"",i=Date.now(),o=this.set_interval(()=>{if(t!==this.#r){this.clear_interval(o),this.#e.delete(e);return}let a=e?.containerEl||e?._children?.[0]?.viewContainerEl||null;if(a&&a.isConnected===!1){this.clear_interval(o),this.#e.delete(e);return}if(Date.now()-i>this.#a){this.clear_interval(o),this.#e.delete(e);return}let c=e?._children?.[0]?.view?.data;if(!c)return;let l=[];try{l=j1(c)}catch(d){console.warn("BasesCaches: get_bases_output failed for embedded base",d),l=[]}l.length&&(this.clear_interval(o),this.#e.delete(e),this.cache_bases_output({key:`${this.#o}#${s}`,bases_output:l}))},this.#s);this.#e.set(e,{id:o,started:i,generation:t})}watch_base_file(e,t=this.#r){if(this.#e.has(e))return;let s=Date.now(),i=this.set_interval(()=>{if(t!==this.#r){this.clear_interval(i),this.#e.delete(e);return}let o=e?.containerEl||e?.viewContainerEl||null;if(o&&o.isConnected===!1){this.clear_interval(i),this.#e.delete(e);return}if(Date.now()-s>this.#l){this.clear_interval(i),this.#e.delete(e);return}let a=e?.data;if(!a)return;let c=[];try{c=j1(a)}catch(l){console.warn("BasesCaches: get_bases_output failed for base file",l),c=[]}c.length&&(this.clear_interval(i),this.#e.delete(e),this.cache_bases_output({key:this.#o,bases_output:c}))},this.#s);this.#e.set(e,{id:i,started:s,generation:t})}stop_watchers(){this.#r+=1,this.#t&&(this.clear_interval(this.#t),this.#t=null),this.#e.forEach(e=>this.clear_interval(e.id)),this.#e.clear(),this.#i=null}prune_missing_base_caches(e={}){let{source:t=null,source_key:s=this.#o}=e,i=t?.data?.meta?.links||t?.meta?.links||[],o=TM(i);if(!s)return;let a=`${s}#`,c=!1;Object.entries(this.items).forEach(([l,d])=>{if(!l.startsWith(a))return;let _=l.slice(a.length);o.has(_)||(c=!0,d.delete())}),c&&this.process_save_queue()}cache_bases_output(e={}){let{key:t,bases_output:s}=e;if(!t||!Array.isArray(s)||s.length===0)return;let i=new s_(this.env,{key:t,bases_output:s});this.set(i),i.queue_save(),this.process_save_queue()}},T1={class:mf,collection_key:"bases_caches",data_adapter:Mr,item_type:s_};var Us=class extends ts{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var pi=class extends jt{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function n_(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(n_,"settings_config");var Ws=class extends Us{static{r(this,"ChatCompletionModel")}async complete(e){return this.instance.complete(e)}async stream(e,t={}){return this.instance.stream(e,t)}async test_model(){try{let e=await this.complete({messages:[{role:"user",content:"2+2="}]}),t=!e.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var i_=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var o_=class extends Jt{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};function hf(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(hf):e==="object"?Object.values(n).every(hf):!1}r(hf,"is_json_compatible");function r_(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||hf(i)&&(t[s]=i);return t}r(r_,"extract_json_details");function zr(n){return Object.keys(n).length===0}r(zr,"is_empty_object");function NM(n,e){return zr(n)?e:zr(e)?n:{...n,...e}}r(NM,"merge_details");function pf(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(pf,"get_message_from_object");function _e(n,e=null){if(Array.isArray(n)&&n.length>0)return _e(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=r_(n,["message"]);return{message:t,details:zr(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=pf(o),c=r_(o,["message"]),l=r_(t,["message","error"]),d=NM(l,c);return{message:a||pf(t)||"Unknown error",details:zr(d)?null:d,http_status:e}}return _e(i)}let s=pf(t);if(s){let i=r_(t,["message"]);return{message:s,details:zr(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(_e,"normalize_error");var hi={},ss={data:null,fetched_at:0},J=class extends o_{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return K}get res_adapter(){return W}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Ue({adapter:Ct})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=ss.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=_e(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new i_(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=_e({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=_e(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=_e(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(ss?.data&&t-ss?.fetched_at<e)return ss.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return ss.data=o,ss.fetched_at=t,console.log({MODELS_DEV_CACHE:ss}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),ss.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return hi[this.constructor.key]||(hi[this.constructor.key]={}),hi[this.constructor.key]}set model_data(e){hi[this.constructor.key]||(hi[this.constructor.key]={}),hi[this.constructor.key]=e}},K=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},W=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:_e(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var a_=class extends J{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return ff}get res_adapter(){return gf}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},ff=class extends K{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},gf=class extends W{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var yf=class extends a_{static{r(this,"OpenRouterChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},PM={api_key:{name:"API Key",type:"password",description:"Enter your API key for the chat model provider."}},c_={class:yf,settings_config:PM};var bf=class extends pi{static{r(this,"ChatCompletionModels")}model_type="Chat";get default_provider_key(){return"open_router"}};var IM={class:bf,data_dir:"chat_completion_models",collection_key:"chat_completion_models",data_adapter:Lr,item_type:Ws,providers:{open_router:c_},settings_config:n_},N1=IM;var P1=N1;var Gs=class extends Us{static{r(this,"RankingModel")}static get defaults(){return{data:{api_key:"",provider_key:"cohere",model_key:"rerank-v3.5"}}}async rank(e,t,s={}){return this.instance.rank(e,t,s)}async test_model(){try{let e=await this.rank("alphabetical order",["z","y","x","a","b","c"]),t=!!(!e.error&&Array.isArray(e)&&e.length);return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var vf=class extends Rn{static{r(this,"CohereRankingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get_models(){return this.models}},MM={api_key:{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},I1={class:vf,settings_config:MM};var kf=class extends pi{static{r(this,"RankingModels")}model_type="Ranking";get default_provider_key(){return"cohere"}},LM={class:kf,data_dir:"ranking_models",collection_key:"ranking_models",data_adapter:Lr,item_type:Gs,providers:{cohere:I1},settings_config:n_},M1=LM;var L1=M1;var l_=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}};function d_(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(d_,"cos_sim");function R1(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=z1(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=z1(n.results);n.min=s,n.minResult=i}}r(R1,"results_acc");function F1(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=D1(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=D1(n.results);n.max=s,n.maxResult=i}}r(F1,"furthest_acc");function z1(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(z1,"find_min");function D1(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(D1,"find_max");function fi(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(fi,"sort_by_score");function B1(n,e){return fi(n,e)}r(B1,"sort_by_score_descending");function U1(n,e){return fi(n,e)*-1}r(U1,"sort_by_score_ascending");var __=class extends l_{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:d_(e,a.vec)};return R1(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(B1)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:d_(e,a.vec)};return F1(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(U1)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}};function zM(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=gi(l,o),l=wf(l,15),l=gi(l,a),i^=l,i=wf(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=gi(l,o),l=wf(l,15),l=gi(l,a),i^=l;break}return i^=n.length,i=DM(i),i|0}r(zM,"murmur_hash_32");function W1(n,e=0){return(zM(n,e)>>>0).toString(36)}r(W1,"murmur_hash_32_alphanumeric");function gi(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(gi,"multiply_32");function wf(n,e){return n<<e|n>>>32-e}r(wf,"rotate_left_32");function DM(n){return n^=n>>>16,n=gi(n,2246822507),n^=n>>>13,n=gi(n,3266489909),n^=n>>>16,n|0}r(DM,"fmix_32");var RM="---frontmatter---",G1=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),FM=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),BM=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),UM=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(RM),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),WM=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=G1(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=G1(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),GM=r((n,e={})=>{let t=FM(n,e),s=BM(t),i=UM(s);return WM(i,n)},"create_find_connections_filter_opts");async function xf(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=GM(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+W1(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(fi).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(xf,"find_connections");xf.action_type="connections";var Dr=class extends jt{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new __(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(fi).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return u_}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return HM}},u_={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},HM={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};var Rr=class extends Dr{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var VM=r(n=>{let e={embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...u_};return n.settings.embed_blocks===!1&&e.min_chars&&(e.min_chars.disabled=!0),e},"settings_config"),H1={class:Rr,collection_key:"smart_blocks",settings_config:VM};var vi=require("obsidian");function Ke(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(Ke,"escape_html");function J1(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=yi(l,o),l=Ef(l,15),l=yi(l,a),i^=l,i=Ef(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=yi(l,o),l=Ef(l,15),l=yi(l,a),i^=l;break}return i^=n.length,i=KM(i),i|0}r(J1,"murmur_hash_32");function ce(n,e=0){return(J1(n,e)>>>0).toString(36)}r(ce,"murmur_hash_32_alphanumeric");function yi(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(yi,"multiply_32");function Ef(n,e){return n<<e|n>>>32-e}r(Ef,"rotate_left_32");function KM(n){return n^=n>>>16,n=yi(n,2246822507),n^=n>>>13,n=yi(n,3266489909),n^=n>>>16,n|0}r(KM,"fmix_32");function ke(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(ke,"camel_case_to_snake_case");function Sf(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(Sf,"convert_to_time_ago");function ht(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(V1(e[t])&&V1(n[t])?ht(n[t],e[t]):n[t]=e[t]);return n}r(ht,"deep_merge");function V1(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(V1,"is_plain_object");function Hs(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Hs,"cos_sim");function Te(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(Te,"get_by_path");function Ne(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(Ne,"set_by_path");function Af(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(Af,"delete_by_path");function Cf(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(Cf,"compute_centroid");function qf(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let u=Math.sqrt(_);s[a]+=u,s[l]+=u}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(qf,"compute_medoid");function YM(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(YM,"ensure_settings_config");function Of(n,e,t){let s=YM(n,e);return Object.entries(s||{}).reduce((i,[o,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][o]=a,i},{[t]:{}})}r(Of,"build_settings_group_map");function $f(n,e,t,s){return Of(n,e,s)[t]||{}}r($f,"resolve_group_settings_config");var m_=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new vi.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function ki(n,e,t,s={}){let{default_group_name:i="Settings"}=s,o=n,a=Of(n,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),u={...s,...s.group_params?.[l]||{},settings_config_source:o};return jf(l,e,d,_,u)})}r(ki,"render_settings_config");function jf(n,e,t,s,i={}){let o=i.settings_config_source||t,a=i.settings_config_source?$f(o,e,n,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=m_}catch{c=m_}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,b,g,k)=>{let v=$f(b,f,p,k.default_group_name||"Settings");return jf(p,f,v,g,k)}:jf,_=XM(e,{container:s,group_name:n,settings_config:o,group_params:i,render_group:d}),u=new c(s);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)K1(u,e,p);else K1(u,e,l);u.setHeading(n);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let b=f.scope_class==="pro-setting",g=!!e.env?.is_pro;u.addSetting(k=>{switch(f.name&&k.setName(f.name),k.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&k.setClass(`setting-type-${f.type}`),f.description&&k.setDesc(f.description),f.type){case"button":k.addButton(v=>{v.setButtonText(f.name||"Run"),v.onClick(async y=>{typeof f.callback=="function"&&await bi(k,y,f.callback,{scope:e})})});break;case"toggle":k.addToggle(v=>{v.setValue(Te(e.settings,p)||!1),v.onChange(y=>{Ne(e.settings,p,y),typeof f.callback=="function"&&bi(k,y,f.callback,{scope:e})})});break;case"text":k.addText(v=>{v.setValue(String(Te(e.settings,p)||"")),v.onChange(y=>{Ne(e.settings,p,y)})});break;case"number":k.addText(v=>{v.setValue(String(Te(e.settings,p)??"0")),v.inputEl.setAttribute("type","number"),v.onChange(y=>{let S=Number(y);isNaN(S)||Ne(e.settings,p,S),typeof f.callback=="function"&&bi(k,S,f.callback,{scope:e})})});break;case"dropdown":k.addDropdown(v=>{let y=f.options_callback;typeof y=="function"&&y.call(e,e).forEach(A=>{let $=A.label||A.name||A.value;v.addOption(A.value,$)}),v.setValue(Te(e.settings,p)||""),v.onChange(S=>{Ne(e.settings,p,S),typeof f.callback=="function"&&bi(k,S,f.callback,{scope:e}),_()})});break;case"textarea":k.addTextArea(v=>{v.setValue(String(Te(e.settings,p)||"")),v.onChange(y=>{if(b&&!g){new vi.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}Ne(e.settings,p,y)}),b&&!g&&v.setDisabled(!0)});break;case"slider":k.addSlider(v=>{let y=f.min||0,S=f.max||100,A=f.step||1;v.setLimits(y,S,A),v.setValue(Te(e.settings,p)||y),v.setDynamicTooltip(),v.onChange($=>{Ne(e.settings,p,$),typeof f.callback=="function"&&bi(k,$,f.callback,{scope:e})})});break;case"heading":k.setHeading();break;case"html":f.value&&k.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&k.settingEl.addClass(f.scope_class)})}return u}r(jf,"render_settings_group");function K1(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,vi.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await bi(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(K1,"render_heading_button");async function bi(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(bi,"handle_config_callback");function XM(n,e={}){let{container:t,group_name:s,settings_config:i,group_params:o={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(s,n,i,t,o))}r(XM,"create_settings_group_rerender");var Y1=require("obsidian");function ns(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(ns,"ensure_smart_sources_settings");function is(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(is,"parse_exclusions_csv");function p_(n,e){let t=(e??"").trim();if(!t)return n||"";let s=is(n);return s.includes(t)||s.push(t),s.join(",")}r(p_,"add_exclusion");function h_(n,e){let t=(e??"").trim();return t?is(n).filter(i=>i!==t).join(","):n?.trim()||""}r(h_,"remove_exclusion");var f_=class extends Y1.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=ns(this.env),t=is(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=ns(this.env);t.folder_exclusions=p_(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=ns(this.env),t=is(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=h_(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var X1=require("obsidian");var g_=class extends X1.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function ZM(n,e={}){return`
<div class="sources-settings">
</div>
`}r(ZM,"build_html");async function Z1(n,e={}){let t=await ZM.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return QM.call(this,n,i,e),i}r(Z1,"render");async function QM(n,e,t={}){ki({folder_exclusions:Nf,view_exclusions:Pf,re_import_sources:If},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",Tf(n,e))),this.attach_disposer(e,i),e}r(QM,"post_process");function Tf(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(Tf,"highlight_reset_data");var Nf={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new f_(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},Pf={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new g_(t.main.app,t).open()},"callback")},If={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let u=Date.now();t.events?.emit("sources:reimported",{time_ms:u-_}),t.main.notices?.show("reload_sources",{time_ms:u-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};var Q1=require("obsidian");var wi=class extends Q1.FuzzySuggestModal{static{r(this,"ExcludedFilesFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a file to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=ns(this.env),t=is(e.file_exclusions);return(this.env.smart_sources?.fs?.file_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=ns(this.env);t.file_exclusions=p_(t.file_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=ns(this.env),t=is(e.file_exclusions),s=this.modalEl.querySelector(".sc-excluded-files-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-files-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded files"),!t.length){s.createEl("p").setText("No files excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-file-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-file-btn"}).addEventListener("click",()=>{e.file_exclusions=h_(e.file_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};async function eL(n,e={}){return`
<div class="sources-pro-settings">
</div>
`}r(eL,"build_html");async function eS(n,e={}){let t=await eL.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return tL.call(this,n,i,e),i}r(eS,"render");async function tL(n,e,t={}){ki({folder_exclusions:Nf,file_exclusions:sL,view_exclusions:Pf,re_import_wait_time:{type:"number",name:"Re-import wait time",description:"Time in seconds to wait before re-importing a file after modification.",scope_class:"pro-setting"},"smart_blocks.embed_blocks":{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Embedding allows more granular results in semantic lookups.",scope_class:"pro-setting"},"smart_sources.min_chars":{name:"Minimum length to embed (Sources)",type:"number",description:"Minimum number of characters a source must have to be embedded.",scope_class:"pro-setting"},"smart_blocks.min_chars":{name:"Minimum length to embed (Blocks)",type:"number",description:"Minimum number of characters a block must have to be embedded.",scope_class:"pro-setting"},re_import_sources:If},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",Tf(n,e))),this.attach_disposer(e,i),e}r(tL,"post_process");var sL={type:"button",name:"Manage excluded files",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",scope_class:"pro-setting",callback:r(async function(n,e){let t=this,s=new wi(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")};async function nL(n,e={}){return`
<div class="setting-component pro-setting">
<div class="setting-item">
<div class="info setting-item-info">
<div class="setting-item-name">Excluded files</div>
<div class="setting-item-description">Manage files to exclude from the environment.</div>
</div>
<div class="control setting-item-control">
<button class="sc-add-excluded-file-btn" type="button">Edit excluded files</button>
</div>
</div>
</div>
`}r(nL,"build_html");async function tS(n,e={}){let t=await nL.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return iL.call(this,n,i,e),i}r(tS,"render");async function iL(n,e,t={}){let s=e.querySelector(".sc-add-excluded-file-btn");return s&&s.addEventListener("click",()=>{new wi(n.main.app,n).open(()=>{n.update_exclusions()})}),e}r(iL,"post_process");var sS={collections:{bases_caches:T1,chat_completion_models:P1,ranking_models:L1,smart_blocks:H1},item_types:{ChatCompletionModel:Ws,RankingModel:Gs},items:{chat_completion_model:{class:Ws},ranking_model:{class:Gs}},modules:{},components:{settings_env_sources:{render:eS},settings_sources_file_exclusions:{render:tS}},actions:{}};var us=require("obsidian");var y_=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var b_=class extends y_{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Js=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new b_(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};async function oL(n,e={}){let t=Object.entries(n.settings_config).map(([o,a])=>(a.setting||(a.setting=o),this.render_setting_html(a))).join(`
`),s=Object.entries(n.collections).map(([o,a])=>`<div data-smart-settings="${o}"></div>`).join(`
`);return`
<div class="">
${t}
${s}
</div>
`}r(oL,"build_html");async function nS(n,e={}){let t=await oL.call(this,n,e),s=this.create_doc_fragment(t);return await rL.call(this,n,s,e)}r(nS,"render");async function rL(n,e,t={}){await this.render_setting_components(e,{scope:n});let s=e.querySelectorAll("[data-smart-settings]");for(let i of s){let o=i.dataset.smartSettings;await n[o].render_settings(i)}return e}r(rL,"post_process");var v_=class{static{r(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let s=new this(e,t);return await s.load(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}static create_sync(e,t={}){let s=new this(e,t);return s.load_sync(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}get settings(){return aL(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",cL(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function aL(n,e){let t=new WeakMap,s=new WeakMap,i=r((a,c)=>{if(!Lf(a)||s.has(a))return a;if(t.has(a))return t.get(a);let l=o(a,c);return t.set(a,l),s.set(l,a),l},"wrap_value"),o=r((a,c)=>new Proxy(a,{set(l,d,_){let u=[...c,d],p=Mf(l[d]),f=Mf(_);return l[d]=i(_,u),lL(p,f)&&e({type:"set",path:u,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],u=Mf(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:u}),!0}}),"create_proxy");return i(n,[])}r(aL,"observe_object");function cL(n){let e=Array.isArray(n.path)?n.path:[];return{type:n.type,path:e,path_string:e.join("."),value:n.value,previous_value:n.previous_value}}r(cL,"build_settings_changed_event");function Mf(n){if(!Lf(n))return n;if(typeof structuredClone=="function")try{return structuredClone(n)}catch{}try{return JSON.parse(JSON.stringify(n))}catch{return n}}r(Mf,"snapshot_value");function lL(n,e){return iS(n)!==iS(e)}r(lL,"has_changed");function iS(n){if(n===void 0)return"undefined";if(Number.isNaN(n))return"number:NaN";if(n===1/0)return"number:Infinity";if(n===-1/0)return"number:-Infinity";if(!Lf(n))return`${typeof n}:${String(n)}`;try{return`object:${JSON.stringify(n)}`}catch{return`object:${String(n)}`}}r(iS,"serialize_value");function Lf(n){return typeof n=="object"&&n!==null}r(Lf,"is_observable");function oS(n){return n.collections||(n.collections={}),n.modules||(n.modules={}),n.items||(n.items={}),Object.entries(n.collections).forEach(([e,t])=>{typeof t=="function"&&(n.collections[e]={class:t});let s=ke(e);s!==e&&(n.collections[s]=n.collections[e],delete n.collections[e]),n.collections[s].collection_key||(n.collections[s].collection_key=s),t.item_type&&(n.items[t.item_type.key||ke(t.item_type.name)]={class:t.item_type})}),Object.entries(n.modules).forEach(([e,t])=>{typeof t=="function"&&(n.modules[e]={class:t});let s=ke(e);s!==e&&(n.modules[s]=n.modules[e],delete n.modules[e])}),n.item_types||(n.item_types={}),n.items||(n.items={}),Object.entries(n.item_types).forEach(([e,t])=>{if(typeof t=="function"){let s=ke(e);n.items[s]={class:t,actions:{},...n.items[s]||{}}}}),n}r(oS,"normalize_opts");function dL(n){if(!n||typeof n!="object")return!1;let e=Object.getPrototypeOf(n);return e===Object.prototype||e===null}r(dL,"is_plain_object");function k_(n){if(Array.isArray(n))return n.map(e=>k_(e));if(dL(n)){let e={};for(let[t,s]of Object.entries(n))e[t]=k_(s);return e}return n}r(k_,"deep_clone_config");function xi(n,e){let t=rS(n),s=rS(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(xi,"compare_versions");function rS(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(rS,"normalize_version_value");function Fr(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Fr,"is_plain_object");function Tt(n,e,t=[]){if(!Fr(n)||!Fr(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Fr(i)?(Fr(n[s])||(n[s]={}),Tt(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(Tt,"deep_merge_no_overwrite");function Nt(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(xi(d,_)>0){let p={...c};Tt(p,l),n.collections[a]=p}else Tt(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;xi(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):Tt(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),Tt(n[i],o)):n[i]=o}return n}r(Nt,"merge_env_config");function aS(n={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:s}=n;return(e!==void 0||t!==void 0||s!==void 0)&&(n.smart_sources=n.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!n.smart_sources?.file_exclusions?.length||n.smart_sources?.file_exclusions==="Untitled")&&(n.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!n.smart_sources.folder_exclusions?.length&&(n.smart_sources.folder_exclusions=t),s!==void 0&&s.length&&!n.smart_sources.excluded_headings?.length&&(n.smart_sources.excluded_headings=s)),delete n.file_exclusions,delete n.folder_exclusions,delete n.excluded_headings,n}r(aS,"migrate_exclusion_settings_2025_08_22");var _L=typeof globalThis<"u"?globalThis:Function("return this")(),Br=class{static{r(this,"SmartEnv")}static version="2.2.8";scope_name="smart_env";static global_ref=_L;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=Js.create(this,mL(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([s])=>this.primary_main_key&&s===this.primary_main_key?-1:0);for(let[s,i]of t){if(!i?.main){console.warn(`SmartEnv: '${s}' unloaded, skipping`),delete this.smart_env_configs[s];continue}if(!i?.opts){console.warn(`SmartEnv: '${s}' opts missing, skipping`);continue}Nt(this._config,k_(oS(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:s}=t||{};if(s)for(let[i,o]of Object.entries(s.collections||{})){let a=o?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:xi(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,uL(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let s=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(s),t(this.global_env))},1e3)}else{let s=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(s),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let s={};this.global_env&&xi(this.version,this.global_env.constructor?.version||0)>0&&(s.primary_main_key=ke(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(s);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let s=ke(e.constructor.name);this.smart_env_configs[s]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:r(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await v_.create(this),this.config.default_settings&&Tt(this.settings,this.config.default_settings),aS(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:s}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let s=e.collections[t]?.class;s&&(s.default_settings&&Tt(this.settings,{[t]:s.default_settings}),typeof s.init=="function"&&(await s.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((s,i)=>{let o=this.config.collections?.[s]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return o-a});for(let s of t){let i=Date.now();typeof this[s]?.process_load_queue=="function"&&(await this[s].process_load_queue(),this[s].load_time_ms=Date.now()-i,this.collections[s]="loaded",console.log(`Loaded ${this[s].collection_key} in ${this[s].load_time_ms}ms`))}}static unload_main(e){let t=ke(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let s=this.opts.modules[e];return s?(t={...s,class:null,...t},new s.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||nS}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,s={}){let i=this.get_component(e,t);return i?await i(t,s):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let s=t.collection_key??t.scope_name,i=s?`${s}-${e}`:e;if(!this._components[i])try{if(this.opts.components[s]?.[e]){let o=this.opts.components[s][e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let o=this.opts.components[e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${s}`)}catch(o){console.error("Error getting component",o),console.log(`scope_name: ${s}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[s]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.config.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(s=>s.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let s=e.map(i=>{let o=i.split("/").slice(-2,-1)[0];return{dir:o,count:this.fs.file_paths.filter(a=>a.includes(o)).length}});t=s.reduce((i,o)=>o.count>i.count?o:i,s[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(ht(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(s=>s.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((s,i,o)=>o.indexOf(s)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function uL(n){return{items:Object.fromEntries(Object.entries(n.items||{}).map(([e,t])=>[e,t.data]))}}r(uL,"collection_to_plain");function mL(n){if(!n)return{};if(typeof n=="function")return{adapter_class:n};let e=n.adapter_class||n.adapter;return e?{adapter_class:e}:{}}r(mL,"build_events_opts");function pL(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=fL(n,t),o=hL(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(pL,"create_regex");function hL(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(hL,"adjust_for_windows_paths");function fL(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(fL,"glob_to_regex_pattern");function cS(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:pL(n,s)}r(cS,"glob_to_regex");function lS(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(lS,"fuzzy_search");var w_=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(cS(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return lS(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var gL=Y(require("obsidian"),1);var x_=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=gL,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function E_(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(E_,"empty");var dS=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var _S=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var yL=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,S_=r((n,e)=>{let t=e.trim();(yL.test(t)?_S:dS)(n,t)},"safe_inner_html");var A_=new WeakMap,C_=new WeakMap,q_=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return Te(e,t,s)}set_by_path(e,t,s,i=null){Ne(e,t,s,i)}delete_by_path(e,t,s=null){Af(e,t,s)}escape_html(e){return Ke(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||C_.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");C_.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=C_.get(i);c&&(i.removeEventListener("change",c),C_.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=ce(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){E_(e)}safe_inner_html(e,t){S_(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=A_.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},A_.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(u){console.error("[smart-view] disposer error",u)}}finally{try{l.disconnect()}catch{}A_.get(e)===c&&A_.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var O_=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(u=>{let p=l.addOption(u.value,u.label??u.name??u.value);p.selected=u.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let u=l.addOption(_.value,_.label??_.name??_.value);u.selected=_.value===s,c.length===1&&u.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,u=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(u),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((b,g)=>{let k=document.createElement("div");k.className="array-item-row";let v=document.createElement("input");v.type="text",v.value=b,v.placeholder="Value";let y=document.createElement("button");y.textContent="\u2715",y.title="Remove",v.addEventListener("change",()=>{c[g]=v.value,f()}),y.addEventListener("click",()=>{c.splice(g,1),d(),f()}),k.appendChild(v),k.appendChild(y),l.appendChild(k)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let b=u.value.trim();b&&(c.push(b),u.value="",d(),f())}),_.appendChild(u),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,k],v)=>{let y=document.createElement("div");y.className="json-pair-row";let S=document.createElement("input");S.type="text",S.value=g,S.placeholder="Property";let A=document.createElement("input");A.type="text",A.value=k,A.placeholder="Value";let $=document.createElement("button");$.textContent="\u2715",$.title="Remove",S.addEventListener("change",()=>{let j=S.value.trim();j&&j!==g&&(c[j]=c[g],delete c[g],d(),b())}),A.addEventListener("change",()=>{c[S.value]=A.value,b()}),$.addEventListener("click",()=>{delete c[S.value],d(),b()}),y.appendChild(S),y.appendChild(A),y.appendChild($),l.appendChild(y)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let u=document.createElement("input");u.type="text",u.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=u.value.trim();!g||g in c||(c[g]=p.value,u.value="",p.value="",d(),b())}),_.appendChild(u),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let b=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){E_(e)}safe_inner_html(e,t){S_(e,t)}};var ft=require("obsidian");var $_=class extends O_{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return ft.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new ft.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await ft.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,ft.getIcon)(e).outerHTML}is_mod_event(e){return ft.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function j_(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(j_,"collection_instance_name_from");function uS(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(uS,"create_uid");function T_(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>T_(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>T_(n[o],e[o],t))}return n===e}r(T_,"deep_equal");function N_(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(N_,"get_item_display_name");function P_(n,e){let t=e||{},s=r(m=>typeof m=="object"&&m!==null&&!Array.isArray(m),"is_plain_object"),i=r(m=>typeof m=="function","is_function"),o=r(m=>i(m)&&/^class\s/.test(Function.prototype.toString.call(m)),"is_class_export"),a=r(m=>s(m)&&i(m.action),"is_action_object"),c=r(m=>i(m)||a(m)||o(m),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(m=>{if(!s(m))return m;let h=Object.create(Object.getPrototypeOf(m)||null);for(let w of Reflect.ownKeys(m)){let q=Object.getOwnPropertyDescriptor(m,w);if(!q)continue;let E={...q};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,w,E)}catch{h[w]=E.value}}return h},"clone_with_descriptors"),_=r(m=>{if(!s(m)||a(m))return!1;let h=Reflect.ownKeys(m);if(h.length===0)return!1;let w=!1;for(let q of h){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E){let O=E.value;if(c(O)){w=!0;continue}if(s(O)){if(_(O)){w=!0;continue}return!1}if(typeof O>"u")continue;return!1}return!1}}return w},"should_bucket_actions"),u=r(m=>{if(!m)return m;if(!("value"in m))return{...m};let h=s(m.value)?d(m.value):m.value;return{...m,value:h}},"clone_descriptor"),p=r(m=>{let h=Object.create(null),w=new Map;for(let q of Reflect.ownKeys(m)){let E=Object.getOwnPropertyDescriptor(m,q);if(E){if("value"in E&&_(E.value)){w.set(q,d(E.value));continue}try{Object.defineProperty(h,q,u(E))}catch{h[q]=E.value}}}return{global_source:h,scoped_sources:w}},"build_sources"),{global_source:f,scoped_sources:b}=p(t),g=r((m,h)=>Object.prototype.hasOwnProperty.call(m,h),"has_own"),k=Object.create(null),v=r((m,h,w=[])=>{if(!m||!h)return;let q=new Set([...l,...w]);for(let E of Reflect.ownKeys(m)){if(q.has(E))continue;let O=Object.getOwnPropertyDescriptor(m,E);if(O)try{Object.defineProperty(h,E,O)}catch{h[E]=O.value}}},"copy_metadata"),y=r(m=>{let h=new m(n),w=h.action||h.run||h.execute||h.call;if(i(w)){let q=w.bind(h);return v(m,q),v(h,q),q.instance=h,q}return v(m,h),h},"instantiate_class"),S=r(m=>{if(o(m))return y(m);if(a(m)){let h=m.action.bind(n);return v(m,h,["action"]),h}if(i(m)){let h=m.bind(n);return v(m,h),h}return s(m)?d(m):m},"bind_or_clone"),A=r(()=>{let m=n?.constructor?.key;if(typeof m>"u"||m===null)return null;let h=b.get(m);return h&&s(h)?h:null},"scope_actions_for"),$=r((m,h,w)=>(m[h]=w,w),"cache_result"),j=r((m,h)=>{let w=A();return w&&g(w,h)?$(m,h,S(w[h])):g(f,h)?$(m,h,S(f[h])):$(m,h,void 0)},"compute_and_cache"),C=r(()=>{let m=A(),h=new Set(Reflect.ownKeys(k));for(let w of Reflect.ownKeys(f))h.add(w);if(m)for(let w of Reflect.ownKeys(m))h.add(w);return Array.from(h)},"union_keys"),x=r((m,h)=>({configurable:!0,enumerable:!0,value:m[h]}),"descriptor_for");return new Proxy(k,{get:r((m,h)=>h===Symbol.toStringTag?"ActionsProxy":h in m?m[h]:j(m,h),"get"),has:r((m,h)=>{if(h in m)return!0;let w=A();return w&&g(w,h)?!0:g(f,h)},"has"),ownKeys:r(()=>C(),"ownKeys"),getOwnPropertyDescriptor:r((m,h)=>{if(g(m,h))return x(m,h);let w=A();if(w&&g(w,h)||g(f,h))return g(m,h)||j(m,h),x(m,h)},"getOwnPropertyDescriptor"),defineProperty:r((m,h,w)=>"value"in w?(m[h]=w.value,!0):!1,"defineProperty"),set:r((m,h,w)=>(m[h]=w,!0),"set"),deleteProperty:r((m,h)=>(g(m,h)&&delete m[h],!0),"deleteProperty")})}r(P_,"create_actions_proxy");var le=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&ht(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return uS(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return ht(s,t),!T_(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:u,key_starts_with_any:p,key_includes:f,key_includes_any:b}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||u&&!this.key.startsWith(u)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||b&&!b.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=P_(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),j_(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),j_(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),ke(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return N_(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var bL=Object.getPrototypeOf(async function(){}).constructor,de=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof bL?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return ht(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=P_(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var I_=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},M_=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function L_(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=mS(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=mS(n.results);n.min=s,n.minResult=i}}r(L_,"results_acc");function hS(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=pS(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=pS(n.results);n.max=s,n.maxResult=i}}r(hS,"furthest_acc");function mS(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(mS,"find_min");function pS(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(pS,"find_max");function Ye(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Ye,"sort_by_score");function z_(n,e){return Ye(n,e)}r(z_,"sort_by_score_descending");function fS(n,e){return Ye(n,e)*-1}r(fS,"sort_by_score_ascending");var D_=class extends I_{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Hs(e,a.vec)};return L_(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(z_)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Hs(e,a.vec)};return hS(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(fS)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},R_=class extends M_{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var vL="---frontmatter---",gS=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),kL=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),wL=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),xL=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(vL),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),EL=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=gS(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=gS(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),zf=r((n,e={})=>{let t=kL(n,e),s=wL(t),i=xL(s);return EL(i,n)},"create_find_connections_filter_opts");async function Ei(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=zf(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+ce(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Ye).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(Ei,"find_connections");Ei.action_type="connections";var Vs=class extends le{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new R_(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Ks=class extends de{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new D_(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let u=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!u[f.item.path]||f.score>u[f.item.path].score?u[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=u[f.item.path].score}),u},Promise.resolve({})),c=Object.values(a).sort(Ye).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return yS}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return SL}},yS={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},SL={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function Df(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await Ei.call(this,n);let o=zf(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+ce(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Ye).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Ye).slice(0,s)}return i}r(Df,"find_connections");Df.action_type="connections";var Si=class extends Vs{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=Cf(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=qf(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},bS={class:Si,actions:{find_connections:Df}};var Ur=class extends Ks{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let u=await _.search(e);return u?(this.search_results_ct++,{item:_,score:u}):null}catch(u){return console.error(`Error searching item ${_.id||"unknown"}:`,u),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Ye)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(AL),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},AL={};var F_=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Wr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Wr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var B_=class extends F_{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Gr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Gr=class extends Wr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var vS={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},rs=class extends B_{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=Pt;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},Pt=class extends Gr{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:u,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+u]=d,delete o[l]);let f=this.env[_];if(!f)continue;let b=f.get(u);if(d.key||(d.key=u),b)b.data=d,b._queue_load=!1,b.loaded_at=Date.now();else{let g=f.item_type,k=new g(this.env,d);k._queue_load=!1,k.loaded_at=Date.now(),f.set(k)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return vS[s]&&(s=vS[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Hr=class extends rs{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=Rf},Rf=class extends Pt{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var U_=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return ce(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return kS(this.constructor.name)}static get adapter_key(){return kS(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function kS(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(kS,"to_snake");function W_(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},u={},p=[],f={},b=null,g=null,k=!1,v=!1,y="#",S=!1,A=[],$=null;_[y]=0;for(let C=0;C<i.length;C++){let x=C+t,m=i[C],h=m.trim();if(h==="---"){if(!v&&x===1){v=!0,k=!0,l["#---frontmatter---"]=[x,null];continue}else if(k){k=!1,l["#---frontmatter---"][1]=x;continue}}if(k)continue;if(!S&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(m)&&f.incomplete.top.push(x)),h.startsWith("```")){if(S=!S,S&&!$?$=x:!S&&$&&(A.push([$,x]),$=null),!g){let E=c.length>0?c[c.length-1].key:y;if(E===y&&!l[y]&&(l[y]=[x,null]),E===y)g={key:y,start_line:x},(l[y][1]===null||l[y][1]<x)&&(l[y][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let O=_[E],N=`${E}#{${O}}`;l[N]=[x,null],g={key:N,start_line:x}}}continue}let w=h.match(/^(#{1,6})\s*(.+)$/);if(w&&!S){let E=w[1].length,O=w[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let X=c.pop();l[X.key][1]===null&&(l[X.key][1]=x-1)}c.length===0&&l[y]&&l[y][1]===null&&(l[y][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null);let N="",M=0;if(c.length>0?(N=c[c.length-1].key,M=c[c.length-1].level):(N="",M=0),c.length===0)d[O]=(d[O]||0)+1,d[O]>1&&(O+=`[${d[O]}]`);else{u[N]||(u[N]={}),u[N][O]=(u[N][O]||0)+1;let X=u[N][O];X>1&&(O+=`#{${X}}`)}let ue=E-M,ge="#".repeat(ue),ye=N+ge+O;l[ye]=[x,null],_[ye]=0,c.push({level:E,title:O,key:ye});continue}let q=m.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(q&&!S){if(q[1].length===0){b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null),g&&g.key!==y&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let O=c.length>0?c[c.length-1].key:y;O===y&&!l[y]&&(l[y]=[x,null]),_[O]===void 0&&(_[O]=0),_[O]+=1;let N=_[O],M;if(s){let ue=q[3].replace(/^\[(?: |x|X)\]\s*/,""),ge=CL(ue,o);M=`${O}#${ge}`}else M=`${O}#{${N}}`;l[M]=[x,null],b={key:M,start_line:x};continue}if(b)continue}if(h!==""&&!g){b&&(l[b.key][1]===null&&(l[b.key][1]=x-1),b=null);let E=c.length>0?c[c.length-1].key:y;if(E===y)l[y]||(l[y]=[x,null]),(l[y][1]===null||l[y][1]<x)&&(l[y][1]=null),g={key:y,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let O=_[E],N=`${E}#{${O}}`;l[N]=[x,null],g={key:N,start_line:x}}}}let j=i.length;for(;c.length>0;){let C=c.pop();l[C.key][1]===null&&(l[C.key][1]=j+t-1)}b&&(l[b.key][1]===null&&(l[b.key][1]=j+t-1),b=null),g&&(l[g.key][1]===null&&(l[g.key][1]=j+t-1),g=null),l[y]&&l[y][1]===null&&(l[y][1]=j+t-1);for(let C in l)a[C]=l[C];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:A}}r(W_,"parse_markdown_blocks");function CL(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(CL,"get_longest_words_in_order");var gt=class extends U_{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=W_(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let u=this.item.block_collection.get(_.key);s==="replace_blocks"?await u.update(_.content):await u.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],u=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:u,state:"new",content:p});continue}let f,b=l.split("#"),g;for(;!f&&b.length>0;)b.pop(),g=b.join("#"),f=!!c[g];if(f){i.push({key:u,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let k=this.item.block_collection.get(u);if(await this.create_hash(p)!==k.last_read?.hash){o.push({key:u,state:"changed",content:p});continue}a.push({key:u,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function as(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),u={title:c,target:l,line:d};_&&(u.embedded=!0),e.push(u)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,u=o(a.index),p={title:l,target:d,line:_};u&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(as,"get_markdown_links");function G_({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=as(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(G_,"get_bases_cache_links");function Ff(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(Ff,"parse_value");function qL(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=Ff(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let u=_.trim().slice(2);l.push(Ff(u)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=Ff(c)}return t}r(qL,"parse_yaml_block");function wS(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=qL(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(wS,"parse_frontmatter");var xS=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Jr=class extends gt{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=as(e),s=G_({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=wS(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),xS(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var cs=require("obsidian");function OL(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(OL,"merge_tags");var Ys=class extends Jr{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=OL(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!cs.MarkdownRenderer||!cs.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await cs.MarkdownRenderer.render(s,t,i,this.item.path,new cs.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(u=>setTimeout(u,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,cs.htmlToMarkdown)(i)}};var H_=class extends gt{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var J_=class extends gt{static{r(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function $L({content:n}={}){if(!n)return null;try{return JSON.parse(n)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}r($L,"parse_canvas_json");function ES({target:n,title:e}={}){return n?{title:e||n,target:n,line:1}:null}r(ES,"build_link_record");function jL({node:n}={}){if(!n||typeof n!="object")return[];if(n.type==="text"&&typeof n.text=="string")return as(n.text);if(n.type==="file"&&typeof n.file=="string"){let e=typeof n.subpath=="string"?n.subpath:"",t=`${n.file}${e}`,s=ES({target:t,title:n.file});return s?[s]:[]}if(n.type==="link"&&typeof n.url=="string"){let e=ES({target:n.url,title:n.url});return e?[e]:[]}return[]}r(jL,"get_canvas_node_links");function TL({nodes:n=[]}={}){return Array.isArray(n)?n.reduce((e,t)=>(e.push(...jL({node:t})),e),[]):[]}r(TL,"get_canvas_links_from_nodes");function NL({content:n}={}){let e=$L({content:n});return e?.nodes?TL({nodes:e.nodes}):[]}r(NL,"get_canvas_links");var V_=class extends gt{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=NL({content:e});let t=this.item.file?.stat,s=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:s,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var K_=class extends Ys{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function SS(n,e){let[t,...s]=n.split("#").filter(Boolean),i=N_(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(SS,"get_block_display_name");var Ai=class extends Vs{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return SS(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},AS={class:Ai,actions:{find_connections:Ei}};var Vr=class extends Ks{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var Y_=class extends rs{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=Bf;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},Bf=class extends Pt{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var X_=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return ce(e)}};function Z_(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(Z_,"get_line_range");var Ci=class extends X_{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return Z_(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var qi=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Kr=class extends qi{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var Oi=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Xs=class extends Oi{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var yt=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var $i=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},ji=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var Ti=class extends $i{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new Uf(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},Uf=class extends ji{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Zs=class extends $i{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new Wf(i)}},Wf=class extends ji{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var $S=Y(OS(),1);var FL=Object.defineProperty,BL=r((n,e,t)=>e in n?FL(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),UL=r((n,e,t)=>(BL(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function WL(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(WL,"bytePairMerge");function GL(n,e){return n.length===1?[e.get(n.join(","))]:WL(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(GL,"bytePairEncode");function HL(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(HL,"escapeRegex");var Hf=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=$S.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=Hf.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Hf.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??n.length;for(let f of n.substring(l,u).matchAll(s)){let b=this.textEncoder.encode(f[0]),g=this.rankMap.get(b.join(","));if(g!=null){o.push(g);continue}o.push(...GL(b,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},eu=Hf;UL(eu,"specialTokenRegex",n=>new RegExp(n.map(e=>HL(e)).join("|"),"g"));async function TS(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await jS(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await jS(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(TS,"fetch_json_cached");async function jS(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(jS,"do_fetch");function Vf(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(Vf):e==="object"?Object.values(n).every(Vf):!1}r(Vf,"is_json_compatible");function tu(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||Vf(i)&&(t[s]=i);return t}r(tu,"extract_json_details");function Yr(n){return Object.keys(n).length===0}r(Yr,"is_empty_object");function JL(n,e){return Yr(n)?e:Yr(e)?n:{...n,...e}}r(JL,"merge_details");function Jf(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(Jf,"get_message_from_object");function ee(n,e=null){if(Array.isArray(n)&&n.length>0)return ee(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=tu(n,["message"]);return{message:t,details:Yr(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=Jf(o),c=tu(o,["message"]),l=tu(t,["message","error"]),d=JL(l,c);return{message:a||Jf(t)||"Unknown error",details:Yr(d)?null:d,http_status:e}}return ee(i)}let s=Jf(t);if(s){let i=tu(t,["message"]);return{message:s,details:Yr(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(ee,"normalize_error");var VL="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",vt=class extends Xs{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Xe}get res_adapter(){return Ze}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new yt({adapter:Zs})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:ee(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await TS(VL,"cl100k_base.json");this.tiktoken=new eu(e)}},Xe=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Ze=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var su=class extends vt{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Kf}get res_adapter(){return Yf}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Kf=class extends Xe{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Yf=class extends Ze{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var nu=class extends Xs{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var iu=class extends nu{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var NS=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var PS={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:Xf};var Xf={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},IS={},Zf={};var Ni=class extends iu{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=PS;constructor(e){super(e),this.connector=NS.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...IS}}get_models(){return Promise.resolve(this.models)}get models(){return Xf}};var ou=class extends vt{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Qf}get res_adapter(){return eg}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of YL(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Qf=class extends Xe{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},eg=class extends Ze{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},KL=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),YL=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(KL)},"filter_embedding_models");var ru=class extends vt{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return tg}get res_adapter(){return sg}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},tg=class extends Xe{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},sg=class extends Ze{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function XL(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(XL,"parse_lm_studio_models");var au=class extends vt{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return ng}get res_adapter(){return ig}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return XL(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},ng=class extends Xe{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},ig=class extends Ze{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Xr=class extends qi{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw ee(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var cu=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var lu=class extends Oi{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var Pi={},ls={data:null,fetched_at:0},G=class extends lu{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return H}get res_adapter(){return D}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new yt({adapter:Zs})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=ls.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=ee(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new cu(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=ee({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=ee(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=ee(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(ls?.data&&t-ls?.fetched_at<e)return ls.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return ls.data=o,ls.fetched_at=t,console.log({MODELS_DEV_CACHE:ls}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),ls.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return Pi[this.constructor.key]||(Pi[this.constructor.key]={}),Pi[this.constructor.key]}set model_data(e){Pi[this.constructor.key]||(Pi[this.constructor.key]={}),Pi[this.constructor.key]=e}},H=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},D=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Zr=class extends G{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Qr}res_adapter=ea;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Qr=class extends H{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},ea=class extends D{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var ZL=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],en=class extends G{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=og;parse_model_data(e){return e.data.filter(t=>!ZL.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:QL(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function QL(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(QL,"get_max_input_tokens");var og=class extends D{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var ta=class extends en{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var Ii=class extends G{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=sa;res_adapter=na;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},sa=class extends H{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},na=class extends D{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:ee(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},ia=class extends Ii{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var oa=class extends G{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return rg}get res_adapter(){return ag}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},rg=class extends H{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},ag=class extends D{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var ra=class extends G{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return aa}get res_adapter(){return ca}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},aa=class extends H{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},ca=class extends D{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var la=class extends G{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=da;res_adapter=_a;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},da=class extends H{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},_a=class extends D{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:ee(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var cg={openai:{req:H,res:D},anthropic:{req:Qr,res:ea},gemini:{req:sa,res:na},lm_studio:{req:aa,res:ca},ollama:{req:da,res:_a}},ua=class extends G{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=cg[e];return t&&t.req?t.req:H}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=cg[e];return t&&t.res?t.res:D}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(cg).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var ma=class extends G{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return lg}get res_adapter(){return dg}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},lg=class extends H{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},dg=class extends D{static{r(this,"SmartChatModelGroqResponseAdapter")}};var pa=class extends G{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return H}get res_adapter(){return D}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var ha=class extends G{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return _g}get res_adapter(){return ug}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},_g=class extends H{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},ug=class extends D{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var Ng=require("obsidian");function MS(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=W_(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),u=Z_(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===u.length&&_.vec)continue;let p=as(u),f=G_({source:n,links:p}),b={key:d,lines:l,size:u.length,outlinks:[...p,...f],last_read:{at:a,hash:ce(u)}};if(!_||_?.data.last_read?.hash!==b.last_read.hash){let g=new n.block_collection.item_type(n.env,b);n.block_collection.set(g)}else _.data={..._.data,...b}}e4(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(MS,"parse_blocks");function e4(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(e4,"clean_and_update_source_blocks");function mg(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():LS(a)?n[o]=mg(LS(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(mg,"ajson_merge");function LS(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(LS,"is_object");var zS={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function t4(n){let e=!1,[t,...s]=n.split(":");return zS[t]&&(t=zS[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(t4,"_parse_ajson_key");var ds=class extends rs{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let u=JSON.parse(_),[p,f]=Object.entries(u)[0],{collection_key:b,item_key:g,changed:k}=t4(p),v=`${b}:${g}`;f?(i[v]=f,(k||v!==p)&&(delete i[p],t=!0)):(delete i[v],(k||v!==p)&&delete i[p],t=!0)}catch(u){console.warn("parse error for line: ",l,u),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),u=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(u);if(f)f.data=mg(f.data,l);else{let b=p.item_type;f=new b(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=u)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},pg=class extends Pt{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},fa={collection:ds,item:pg};var ga=class extends le{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function s4(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(s4,"parse_component_properties");async function n4(n,e){let{scope_key:t,component_key:s}=s4(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await ce(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(n4,"build_component_data");var du=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await n4(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var _u=class extends du{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function DS(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&DS(i,o,t)}}),t}r(DS,"flatten_components_config");var uu=class extends de{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=DS(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},RS={class:uu,item_type:ga,data_adapter:fa,component_adapters:{SmartViewComponentAdapter:_u}};var FS=RS;function BS(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(BS,"filter_redundant_context_items");var US=r((n,e)=>!e||!n?.[e]?!1:n[e].folder?n[e].exclude?!1:(n[e].exclude=!0,!0):(delete n[e],!0),"remove_context_item_data"),ya=class extends le{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:s=!0}=t;US(this.data.context_items,e)&&(this.queue_save(),s&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:s=!0}=t,i=Array.isArray(e)?e:[e],o=[];return i.forEach(a=>{US(this.data.context_items,a)&&o.push(a)}),o.length?(this.queue_save(),s&&this.emit_event("context:updated",{removed_keys:o}),o):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return BS(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var mu=class extends de{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var i4={class:mu,data_adapter:ds,item_type:ya};var WS=i4;var pu=class extends le{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var kt=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var hu=class extends kt{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var fu=class extends kt{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var GS=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var gu=class extends kt{static{r(this,"ImageContextItemAdapter")}static detect(e){return GS.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var yu=class extends kt{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var hg=class extends de{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},HS={version:1,class:hg,collection_key:"context_items",item_type:pu,context_item_adapters:{BlockContextItemAdapter:hu,SourceContextItemAdapter:fu,ImageContextItemAdapter:gu,PdfContextItemAdapter:yu}};function JS(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(JS,"next_log_stats");var Mi=class extends le{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var o4={"collection:save_started":!0,"collection:save_completed":!0},fg=class extends de{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return Mi}init(){this.env?.events||Js.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!o4[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new Mi(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=JS({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},VS={class:fg,collection_key:"event_logs",data_adapter:ds,item_type:Mi};var Li=require("obsidian");function KS(n,e={}){if(!n)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],s=n?.env?.config?.actions||{},i=n?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(s[c]||{}).display_name||c;return a.push({select_action:r(()=>{n.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}r(KS,"build_suggest_scope_items");var YS=r((n,e={})=>{let t=n?.inputEl,s=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(s===t&&i)},"should_handle_arrow_left");var bu=class extends Li.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,o=YS(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&o){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return KS(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,Li.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=Li.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var _Ne=require("obsidian");var vu=class extends bu{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var XS=require("obsidian");var ku=class extends XS.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var xu=require("obsidian");var r4="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",wu=class extends xu.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){a4(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function a4(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),c4(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(r4,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r(a4,"render_milestones_modal_title");function c4(n){l4(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(c4,"render_help_icon");function l4(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,xu.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(l4,"set_icon_with_fallback");var ZS={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var ba=class extends le{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],u=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),u},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var Eu=class extends de{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function QS(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(QS,"settings_config");var tn=class extends ba{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var gg=class extends Eu{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var d4={class:gg,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:fa,item_type:tn,providers:{},settings_config:QS},yg=d4;var bg=class extends Ni{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},eA={class:bg,settings_config:Zf};yg.providers={transformers:eA};var tA=yg;var _s=class extends le{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(L_(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(z_);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var sA={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},vg=class extends de{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=_4(new Date),i=ce(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new _s(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...sA}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function _4(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(_4,"format_ymd");var nA={class:vg,collection_key:"lookup_lists",item_type:_s,settings_config:sA};function va(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(va,"format_collection_name");async function u4(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${va(n.collection_key)}</h2>
${t}
</div></div></div>`}r(u4,"build_html");async function iA(n,e={}){let t=await u4.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(iA,"render");var zi=require("obsidian");function oA(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(zi.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new zi.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let u=d.hoverEl.querySelector(".markdown-preview-sizer");zi.MarkdownRenderer.render(o,l,u,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(oA,"register_block_hover_popover");var rA=require("obsidian");function aA(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),rA.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):oA(n.parentElement,n,e.env,e.key)}r(aA,"register_item_hover_popover");var lA=require("obsidian");function m4(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(m4,"format_score");function p4(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(p4,"format_size");function cA(n,e){return n?`<span class="${e}">${n}</span>`:""}r(cA,"build_badge_html");function h4(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=m4(n?.data?.score),i=p4(n?.size||n?.data?.size),o=cA(s,"sc-context-item-score"),a=cA(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(h4,"build_html");async function dA(n,e={}){let t=h4(n,e),i=this.create_doc_fragment(t).firstElementChild;return f4.call(this,n,i,e),i}r(dA,"render");async function f4(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${lA.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),aA(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(f4,"post_process");async function g4(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${va(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=b4(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(g4,"build_html");async function _A(n,e={}){let t=await g4.call(this,n,e),s=this.create_doc_fragment(t);return await y4.call(this,n,s,e)}r(_A,"render");async function y4(n,e,t={}){return e}r(y4,"post_process");function b4(n,e){let t=Object.values(n.items).length,s=va(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=v4(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=k4(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(b4,"generate_collection_stats");function v4(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(v4,"get_generic_collection_stats");function k4(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(k4,"calculate_embed_coverage");var uA=require("obsidian");function w4(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(w4,"build_html");async function kg(n,e={}){let t=w4.call(this,n,e),s=this.create_doc_fragment(t);return await x4.call(this,n,s,e)}r(kg,"render");async function x4(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new uA.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Te(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(u=>{_.addOption(u.value,u.label)}),l.childNodes.forEach(u=>{u.value===c&&(u.selected=!0),o.find(p=>p.value===u.value)?.disabled&&(u.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):Ne(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(x4,"post_process");kg.version=.2;var mA=require("obsidian");function E4(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(E4,"build_html");function pA(n,e={}){let t=E4.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,mA.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),S4.call(this,n,i,e),i}r(pA,"render");function S4(n,e){}r(S4,"post_process");var hA=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var vA=require("obsidian");var fA=require("obsidian");var C4={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},Di={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},q4=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function wg(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=q4.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(wg,"derive_events_checklist_groups");function ka(n,e){let t=O4(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(ka,"check_if_event_emitted");function O4(n,e){let t=C4[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!$4(a)))return!0}return!1}r(O4,"resolve_plugin_install_event");function $4(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r($4,"is_pro_manifest");function gA(n){n.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in Di){let s=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",o=document.createElement("p");o.textContent=i,s.appendChild(o);let a=document.createElement("p");a.textContent=`\u2705 ${Di[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",s.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{n.open_milestones_modal()}),s.appendChild(c),new fA.Notice(s,7e3)}})}r(gA,"register_first_of_event_notifications");function j4(n,e={}){let t=wg(Di),s=t.reduce((c,l)=>{let d=l.items.reduce((_,u)=>_+(ka(n,u.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((u,p)=>u+(ka(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(u=>{let p=ka(n,u.event_key)===!0;return N4(u,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Ke(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Ke(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Ke(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(j4,"build_html");async function kA(n,e={}){this.apply_style_sheet(hA);let t=j4.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return T4.call(this,n,i,e),i}r(kA,"render");async function T4(n,e,t={}){return P4(e),I4(e),e}r(T4,"post_process");function N4(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Ke(n.event_key)}"
data-link="${Ke(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${Ke(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Ke(n.milestone)}</span>
</div>
</li>
`}r(N4,"build_item_html");function P4(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=bA(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||yA(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=bA(n,e);s&&(e.preventDefault(),yA(s))}))}r(P4,"attach_item_link_listeners");function yA(n){let e=z4(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(yA,"open_item_link");function I4(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&M4(i,s)})}r(I4,"render_item_state_icons");function M4(n,e){L4(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(M4,"set_item_icon");function L4(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,vA.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(L4,"set_icon_with_fallback");function bA(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(bA,"get_item_el_from_event");function z4(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=Di[t];return!s||typeof s.link!="string"?"":s.link}r(z4,"get_item_link");function D4(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}r(D4,"build_html");var xg=100,Eg=100;function R4(n,e={}){let{limit:t=xg}=e;return n.slice(-t).reverse()}r(R4,"get_visible_entries");function F4(n,e={}){let{page_size:t=xg}=e;return Math.min(n,t)}r(F4,"get_visible_count");function B4(n,e={}){let{current_count:t=0,step_size:s=Eg}=e;return Math.min(n,t+s)}r(B4,"get_next_visible_count");function U4(n,e){return n>e}r(U4,"should_show_load_more");async function wA(n,e={}){let t=this.create_doc_fragment(D4()),s=t.firstElementChild;return W4.call(this,n,s,e),t}r(wA,"render");async function W4(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),o=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(s);let c=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!c.length){let _=s.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",s.appendChild(_),o&&(o.style.display="none");return}let l=F4(c.length,{page_size:xg}),d=r(()=>{a.empty(s),R4(c,{limit:l}).forEach(_=>{J4(s,_)}),G4(o,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=s.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),o&&o.addEventListener("click",()=>{l=B4(c.length,{current_count:l,step_size:Eg}),d()})}r(W4,"post_process");function G4(n,e={}){if(!n)return;let{entries_length:t=0,visible_count:s=0}=e,i=U4(t,s);if(n.style.display=i?"inline-block":"none",i){let o=t-s,a=Math.min(Eg,o);n.textContent=`Load ${a} more`}}r(G4,"update_load_more_button");function H4(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(H4,"get_level");function J4(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=H4(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${V4(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(J4,"append_entry");function V4(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(V4,"to_time_ago");var Qe=require("obsidian");var Ri=require("obsidian");function Fi(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Fi,"get_smart_server_url");function K4(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(K4,"try_get_zlib");function Y4(n){let e=K4();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(Y4,"inflate_deflate_data");async function wa(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let b=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let k=new Uint8Array(n.slice(t,t+b)),v=new TextDecoder("utf-8").decode(k);t+=b,t+=g;let y=(l&8)!==0,S=t,A;if(!y)A=S+p;else{let C=S,x=!1;for(;C+4<=s;){let m=e.getUint32(C,!0);if(m===134695760||m===67324752||m===33639248){x=!0;break}C++}A=x?C:s}if(A>s)break;let $=new Uint8Array(n.slice(S,A));if(t=A,y&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)u=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let j;if(d===0)j=$;else if(d===8)j=Y4($);else continue;if(i.push({fileName:v,data:j}),v.toLowerCase().endsWith("manifest.json")&&!v.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(j))}catch{}}return{files:i,pluginManifest:o}}r(wa,"parse_zip_into_files");function Su(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(Su,"validate_zip_buffer");async function xa(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(xa,"write_files_with_adapter");function Au(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(Au,"is_server_version_newer");async function Cu(n,e){let t=await(0,Ri.requestUrl)({url:`${Fi()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return Su(t.arrayBuffer,"Smart Plugins server")}r(Cu,"fetch_plugin_zip");async function xA(n,e=Ri.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return Su(t.arrayBuffer,"Download")}r(xA,"fetch_zip_from_url");async function EA(n,e,t=Ri.requestUrl){let s=await t({url:`${Fi()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(EA,"fetch_plugin_readme");async function SA(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(SA,"enable_plugin");function qu(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(qu,"get_oauth_storage_prefix");async function Ou(n){let e=await(0,Ri.requestUrl)({url:`${Fi()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(Ou,"fetch_server_plugin_list");async function AA(n={}){let e=String(n.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,Ri.requestUrl)({url:`${Fi()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}r(AA,"fetch_referral_stats");var CA=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var Z4='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',Q4='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function ez(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(ez,"derive_fallback_plugins");function tz(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${Z4}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${Q4}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}r(tz,"build_html");async function OA(n,e={}){this.apply_style_sheet(CA);let t=tz.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await sz.call(this,n,i,e),i}r(OA,"render");async function sz(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=qu(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=ez(),_=0,u="",p=null,f=r(C=>{if(C){if(typeof this.empty=="function"){this.empty(C);return}C.innerHTML=""}},"empty_container"),b=r(C=>{if(!a||!C)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let m=document.createElement("div");m.classList.add("smart-plugins-login-manual-controls"),p.appendChild(m);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=C,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),m.appendChild(h);let w=document.createElement("button");w.classList.add("mod-cta"),w.textContent="Copy",w.addEventListener("click",async()=>{await qA(C)?new Qe.Notice("Copied login link to clipboard."):new Qe.Notice("Copy failed. Please select and copy the link manually.")}),m.appendChild(w)},"render_manual_login_link"),g=r(async()=>{let C={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(m=>setTimeout(m,100));for(let m in x){if(!Object.prototype.hasOwnProperty.call(x,m))continue;let{name:h,version:w}=x[m];C[m]={name:h,version:w}}return C},"get_installed_info"),k=r(async()=>{_++,_>=2&&u&&b(u),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(u=nz()),new Qe.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),v=r(()=>{if(this.empty(a),p=null,!(localStorage.getItem(o+"token")||"")){new Qe.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await k()})});return}let x=new Qe.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(m=>{m.setButtonText("Logout"),m.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new Qe.Notice("Logged out of Smart Plugins"),v(),y(),$()})})},"render_oauth_login_section"),y=r(async(C={})=>{f(c);let x=String(C.token||"").trim();if(!x)return;let m=Number(C.sub_exp??0)||0;if(!(m&&m<Date.now()))try{let h=await AA({token:x}),w=String(h?.referral_link||"").trim();if(!w)return;let q=new Qe.Setting(c).setName("Referral link").setDesc("Share your link to give $30 off Pro and earn 30 days of Pro credit.");q.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let O=await qA(w);new Qe.Notice(O?"Referral link copied.":"Copy failed. Please try again.")})}),q.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),S=r(async()=>{if(this.empty(l),!(!l||d.length===0))for(let C of d){let x=await n.smart_components.render_component("pro_plugins_list_item",C,{env:n,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),A=r(()=>{let C=new Qe.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");C.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),C.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),C.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),$=r(async()=>{this.empty(l);let C=localStorage.getItem(o+"token")||"";if(!C){await S(),await y();return}try{let x=await g(),m=await Ou(C),{list:h=[],unauthorized:w=[],sub_exp:q}=m;if(typeof q=="number"&&q<Date.now()){A(),await S(),await y();return}if(await y({token:C,sub_exp:q}),!Array.isArray(h)||h.length===0){await S();return}for(let E of h){let O=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,token:C,installed_map:x,on_installed:$});l.appendChild(O)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),j=r(async()=>{v(),await $()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{j()}),await j(),e}r(sz,"post_process");function nz(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${Fi()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(nz,"initiate_smart_plugins_oauth");var qA=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var fe=require("obsidian");var iz="https://smartconnections.app/pro-plugins/";function oz(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(oz,"build_html");function rz(n){return!n||!n.repo}r(rz,"is_fallback_item");function az(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,Au(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(az,"compute_display_state");async function $A(n,e={}){let t=oz(n,e),i=this.create_doc_fragment(t).firstElementChild;return await cz.call(this,n,i,e),i}r($A,"render");async function cz(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(rz(n)){let u=new fe.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",u.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),u.controlEl.appendChild(p)}return u.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(iz,"_external")})}),u.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=az(n,l),_=new fe.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(u=>{u.setButtonText(d.button_label),u.setDisabled(d.is_disabled),u.onClick(()=>dz(n,{app:s,token:i,on_installed:a}))}),_.addButton(u=>{u.setButtonText("Docs"),n.docs_url?u.onClick(()=>window.open(n.docs_url,"_external")):u.onClick(()=>_z(n,{app:s,token:i,display_name:d.display_name}))}),e}r(cz,"post_process");var lz=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return xA(t);if(!e)throw new Error("Login required to install this plugin.");return Cu(n.repo,e)},"download_plugin_zip"),dz=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new fe.Notice(`Installing "${n.repo}" ...`);let o=await lz(n,s),{files:a,pluginManifest:c}=await wa(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await xa(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await SA(t,_),new fe.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new fe.Notice(`Install failed: ${o.message}`)}},"install_plugin"),_z=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await EA(n.repo,s),a=new fe.Modal(t);a.setTitle(i||n.name||n.repo),await fe.MarkdownRenderer.render(t,o,a.contentEl,"",new fe.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new fe.Notice("Failed to load README")}},"show_plugin_readme");var jA=require("obsidian");var sn=class extends jA.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var TA=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var NA=require("obsidian");function mz(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${IA(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(mz,"build_html");async function PA(n,e){this.apply_style_sheet(TA);let s=this.create_doc_fragment(mz.call(this,n,e)).firstElementChild;return pz.call(this,n,s,e),s}r(PA,"render");async function pz(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,NA.setIcon)(o,IA(n)),s.addEventListener("click",()=>{new sn(n).open()}),i.addEventListener("click",()=>{new sn(n,{test_on_open:!0}).open()}),e}r(pz,"post_process");function IA(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(IA,"get_test_result_icon_name");var LA=require("obsidian");var MA={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function $u(n,e,t={}){let s=(MA[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new LA.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new sn(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r($u,"show_new_model_menu");function hz(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(hz,"build_html");async function zA(n,e){let s=this.create_doc_fragment(hz.call(this,n,e)).firstElementChild;return fz.call(this,n,s,e),s}r(zA,"render");async function fz(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=ki(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{$u(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(fz,"post_process");function gz(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(gz,"build_html");async function DA(n,e){let s=this.create_doc_fragment(gz(n,e)).firstElementChild;return yz.call(this,n,s,e),s}r(DA,"render");async function yz(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(yz,"post_process");function bz(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(bz,"build_html");async function RA(n,e={}){let s=this.create_doc_fragment(bz(n,e)).firstElementChild;return vz.call(this,n,s,e),s}r(RA,"render");async function vz(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),$u(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(vz,"post_process");async function kz(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(kz,"build_html");async function FA(n,e={}){let t=await kz.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return wz.call(this,n,i,e),i}r(FA,"render");async function wz(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(wz,"post_process");var BA=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function Ez(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(Ez,"build_html");async function UA(n,e={}){this.apply_style_sheet(BA);let t=await Ez.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return Sz.call(this,n,i,e),i}r(UA,"render");async function Sz(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return Sg.call(this,"settings_env_sources",n,i),Sg.call(this,"settings_env_models",n,s),Sg.call(this,"settings_notifications",n,o),e}r(Sz,"post_process");function Sg(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(Sg,"render_if_available");var WA=require("obsidian");function Az(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(Az,"build_html");async function GA(n,e={}){let t=Az(),i=this.create_doc_fragment(t).firstElementChild;return Cz.call(this,n,i,e),i}r(GA,"render");async function Cz(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),qz(n,a),Oz(n,a),$z(n,a),jz(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Cz,"post_process");function qz(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(qz,"render_btn_open_selector");function Oz(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(Oz,"render_btn_copy_context");function $z(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r($z,"render_btn_clear_context");function jz(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,WA.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(jz,"render_btn_help");var HA=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var Ea=require("obsidian");async function ju(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(Ea.Platform.isMobile)new Ea.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new Ea.Notice("Failed to copy.")}}r(ju,"copy_to_clipboard");var Nz=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),Pz=r(n=>{let e=!1;return()=>{e||(e=!0,Nz(async()=>{e=!1,await n()}))}},"create_render_scheduler");function Iz(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(Iz,"build_html");async function JA(n,e={}){let t=Iz(n,e);this.apply_style_sheet(HA);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return Mz.call(this,n,i,e),i}r(JA,"render");async function Mz(n,e,t={}){let s=[],i=r(async()=>{let d=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(p=>{this.empty(_),_.appendChild(p)});let u=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(p=>{this.empty(u),u.appendChild(p)})},"render_children"),o=Pz(i),a=n.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,u)=>d.addEventListener(_,u)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(u=>u.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=Lz(e);await ju(p)})),_.showAtMouseEvent(d)}),await i(),s.push(n.on_event("context:updated",o)),this.attach_disposer(e,s),e}r(Mz,"post_process");function Lz(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(Lz,"tree_dom_to_wikilinks");function zz(n){return Math.ceil((n||0)/4)}r(zz,"estimate_tokens");function Dz(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(Dz,"build_html");async function VA(n,e={}){let t=Dz(),i=this.create_doc_fragment(t).firstElementChild;return Rz.call(this,n,i,e),i}r(VA,"render");async function Rz(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=zz(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Rz,"post_process");function KA(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-context-item-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let u=["sc-tree-label"];return n.exists===!1&&u.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${l}
<span class="${u.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(KA,"build_tree_item");function YA(n){let e=Fz(n),t=new Set(n.map(i=>i.key||i.path));return XA(e,t)}r(YA,"build_tree_html");function Fz(n=[]){let e=r(a=>a?.key||a?.path||"","get_item_key"),t=r(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,u=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),u=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),u=!0);let b=[];if(l){let g="",k=!1;for(let v=0;v<l.length;v++)!k&&l.slice(v,v+2)==="[["?(k=!0,g+="[[",v++):k&&l.slice(v,v+2)==="]]"?(k=!1,g+="]]",v++):!k&&l[v]==="/"?(b.push(g),g=""):g+=l[v];g&&b.push(g)}return _&&b.push(_),d&&b.push(d),{segments:b,has_block:u}},"split_path_segments"),s={name:"",children:{},selected:!1},i=r((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),o=n.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of n){let c=e(a),l=a?.exists;if(!c||i(c,o.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),u=s,p="";d.forEach((f,b)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=b===d.length-1,k=g&&_;u.children[f]||(u.children[f]={name:f,path:k?c:p,children:k?[]:{},selected:!1,is_file:k||g&&f.includes(".")}),u=u.children[f],g&&(u.selected=!0,u.exists=l)})}return s}r(Fz,"build_path_tree");function XA(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>KA(s,e,XA(s,e))).join("")}</ul>`}r(XA,"tree_to_html");var ZA=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var Uz=r((n,e)=>!n||!e?!1:n===e||n.startsWith(`${e}/`)?!0:n.startsWith(`${e}#`),"is_nested_context_item");function QA(n,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(n?.data?.context_items||{}).filter(o=>Uz(o,t));return[...new Set(i)]}r(QA,"get_nested_context_item_keys");var Wz=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),Gz=r(n=>{let e=!1;return()=>{e||(e=!0,Wz(()=>{e=!1,n()}))}},"create_render_scheduler"),Hz=r((n,e={})=>{let{target_path:t}=e,s=QA(n,{target_path:t});n.remove_items(s)},"remove_nested_context_items");function Jz(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(Jz,"build_html");async function eC(n,e={}){this.apply_style_sheet(ZA);let t=Jz(n,e),i=this.create_doc_fragment(t).firstElementChild;return Vz.call(this,n,i,e),i}r(eC,"render");async function Vz(n,e,t={}){let s=n?.env?.plugin,i=s?.registerDomEvent?.bind(s)||((l,d,_)=>l.addEventListener(d,_)),o=r(()=>{let l=n.env,d=n.context_items.filter(t.filter),_=YA(d),u=this.create_doc_fragment(_);this.empty(e),e.appendChild(u);for(let p=0;p<d.length;p++){let f=d[p],b=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!b){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(b),b.appendChild(g)})}},"render_tree_leaves"),a=Gz(o);o(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");Hz(n,{target_path:_})});let c=[];return c.push(n.on_event("context:updated",a)),this.attach_disposer(e,c),e}r(Vz,"post_process");var tC=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function Yz(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(Yz,"build_html");async function sC(n,e={}){let t=Yz(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(tC),await Xz.call(this,n,s,e),s}r(sC,"render");async function Xz(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let u=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of u){let b=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',k=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',v="",y="";try{let A=await p.read();v=A.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),y=(await p.get_embed_input(A)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(A){console.error("[source_inspector] Error reading block:",A),v='<em style="color:red;">Error reading block content</em>'}let S=this.create_doc_fragment(`
<p>
${b}<br>
${g} | ${k}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${y}</pre>
</details>
<blockquote>${v}</blockquote>
<hr>
`);s.appendChild(S)}return e}r(Xz,"post_process");var aC=require("obsidian");var Bi=require("obsidian");var nC=require("obsidian");var Tu=class extends nC.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var iC=require("obsidian");var Nu=class extends iC.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function oC(n,e,t={}){let{Menu:s=Bi.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new Bi.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new Bi.Notice("Active note is not indexed by Smart Environment");return}new Tu(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Nu(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new Bi.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(oC,"register_status_bar_context_menu");var rC=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function Qz(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(Qz,"build_html");async function cC(n,e={}){this.apply_style_sheet(rC);let s=this.create_doc_fragment(Qz()).firstElementChild;return e3.call(this,n,s,e),s}r(cC,"render");function e3(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),b=`Smart Env${a?" "+a:""}`,g="Smart Environment status",k=c(),v=n.event_logs?.notification_status||"info";f>0&&(b=`Embed now (${f})`,g="Click to re-import.",v="attention"),s&&(0,aC.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=y=>{y.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),k>0?i.dataset.count=String(k):delete i.dataset.count,v?i.dataset.level=String(v):delete i.dataset.level),o.setText?.(b),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=y=>{if(l()>0)y.preventDefault(),y.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let A=new MouseEvent("contextmenu",y);e.dispatchEvent?.(A)}},e.addEventListener("click",e._click_handler))},"render_status_elm");oC(n,e),d();let _=null,u=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",u)),this.attach_disposer(e,p)}r(e3,"post_process");var lC=require("obsidian");function t3(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(t3,"build_html");function dC(n,e={}){let t=t3.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return s3.call(this,n,i,e),i}r(dC,"render");async function s3(n,e){let t=e.querySelector(".callout-icon"),s=(0,lC.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(s3,"post_process");var _C=require("obsidian");function n3(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(n3,"build_html");function uC(n,e={}){let t=n3.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,_C.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),i3.call(this,n,i,e),i}r(uC,"render");function i3(n,e){}r(i3,"post_process");var Ag=require("obsidian");async function mC(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new Ag.Notice("No context items to copy.");let t=await this.get_text(n);await ju(t);let s=o3({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new Ag.Notice(s)}r(mC,"copy_to_clipboard");function o3(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${r3(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=a3(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(o3,"format_stats_message");function r3(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(r3,"format_char_count");function a3(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(a3,"sum_exclusions");var c3="xml_structured",Iu={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},pC=r((n={})=>{let e=n.template_preset||c3;return Iu[e]?e:"custom"},"get_preset_key"),Pu=r((n,e,t,s)=>{let i=pC(n),o=Iu[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function Mu(){return Object.entries(Iu).map(([n,e])=>({value:n,label:e.label||n}))}r(Mu,"get_template_preset_options");function hC(n={},e={}){return{template_before:Pu(n,e,"context_template_before","template_before"),template_after:Pu(n,e,"context_template_after","template_after")}}r(hC,"get_context_templates");function fC(n={},e={}){let t=pC(n),s=Iu[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:Pu(n,e,"item_template_before","template_before"),template_after:Pu(n,e,"item_template_after","template_after")}}r(fC,"get_item_templates");var l3=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),d3=r(n=>l3(n.key),"get_item_name");async function gC(n,e={}){let t={KEY:this.key,ITEM_NAME:d3(this),TIME_AGO:Sf(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(u,p)=>t[p]||"");return c},"replace_vars"),i=fC(this.settings,Cg);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(gC,"merge_template");var yC={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>Mu(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},Cg={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Ui(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=_3(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Lu(e),bC(e).trimEnd()}r(Ui,"build_file_tree_string");function _3(n){return typeof n=="string"&&n.endsWith("/")}r(_3,"is_folder_path");function Lu(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Lu(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Lu(n[i])}else Lu(t)}}}r(Lu,"compress_single_child_dirs");function bC(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=bC(o,e+(c?"    ":"\u2502   ")))}),t}r(bC,"build_tree_string");async function vC(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>Ui(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(u,p)=>s[p]?.()||"");return l},"replace_vars"),o=hC(this.settings,qg),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(vC,"merge_template");var kC={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>Mu(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},qg={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function Sa(n={}){n?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:u3(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:r(({modal:s})=>{s.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}r(Sa,"context_suggest_blocks");function u3(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(u3,"get_block_display_name");var wC="Add blocks";var EC=require("obsidian");var m3=EC.Platform.isMacOS?"\u2318":"Ctrl";function p3(n){return typeof n!="string"?"":n.replace(/\/+$/g,"")}r(p3,"normalize_folder_path");function h3(n,e){let t=p3(e);return!t||n===t?!0:n.startsWith(`${t}/`)}r(h3,"is_source_in_folder");function xC(n){n?.inputEl&&(n.last_input_value=n.inputEl.value,n.inputEl.value="")}r(xC,"reset_modal_input");function f3(n,e){return Object.values(n.env?.smart_sources?.items||{}).filter(s=>h3(s.key,e))}r(f3,"get_sources_list");function g3(n,e){return e.map(t=>({key:t.key,display:t.key,select_action:r(()=>{n.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s}={})=>(xC(s),Sa.call(n,{source_key:t.key,modal:s})),"mod_select_action"),arrow_right_action:r(({modal:s}={})=>(xC(s),Sa.call(n,{source_key:t.key,modal:s})),"arrow_right_action")}))}r(g3,"build_source_suggestions");function SC(n={}){console.log("context_suggest_sources",n);let e=n?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${m3} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=f3(this,n?.folder_path||"");return g3(this,t)}r(SC,"context_suggest_sources");var AC="Add sources";async function zu(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(zu,"pre_process");function Og(n){return this.vec?n.to_item?.vec?{score:Hs(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(Og,"similarity");Og.action_type="score";var $g="Cosine Similarity",jg="Ranks by cosine similarity between the current note and candidates.",CC={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${$g} algorithm`,value:`${jg}`}};var Tg=require("obsidian");async function qC(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=Tg.Keymap.isModEvent(e),l=Tg.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(qC,"open_source");async function OC(n=null){await qC(this,n)}r(OC,"source_open");var $C={collections:{embedding_models:tA,lookup_lists:nA},item_types:{EmbeddingModel:tn,LookupList:_s},items:{embedding_model:{class:tn},lookup_list:{class:_s}},modules:{},components:{collection_settings:{render:iA},context_item_leaf:{render:dA},env_stats:{render:_A},form_dropdown:{render:kg},lean_coffee_callout:{render:pA},milestones:{render:kA},notifications_feed:{render:wA},pro_plugins_list:{render:OA},pro_plugins_list_item:{render:$A},settings_env_model:{render:PA},settings_env_model_type:{render:zA},settings_env_models:{render:DA},settings_env_sources:{render:Z1},settings_model_actions:{render:RA},settings_notifications:{render:FA},settings_smart_env:{render:UA},smart_context_actions:{render:GA},smart_context_item:{render:JA},smart_context_meta:{render:VA},smart_context_tree:{render:eC},source_inspector:{render:sC},status_bar:{render:cC},supporter_callout:{render:dC},user_agreement_callout:{render:uC}},actions:{context_copy_to_clipboard:{action:mC},context_item_merge_template:{action:gC,settings_config:yC,default_settings:Cg},context_merge_template:{action:vC,settings_config:kC,default_settings:qg},context_suggest_blocks:{action:Sa,display_name:wC},context_suggest_sources:{action:SC,display_name:AC},lookup_list_pre_process:{action:zu,pre_process:zu},similarity:{action:Og,settings_config:CC,display_name:$g,display_description:jg},source_open:{action:OC}}};var jC={env_path:"",modules:{smart_fs:{class:w_,adapter:x_},smart_view:{class:q_,adapter:$_},smart_embed_model:{class:Kr,adapters:{transformers:Ni,openai:su,ollama:ou,gemini:ru,lm_studio:au}},smart_chat_model:{class:Xr,adapters:{anthropic:Zr,azure:ta,custom:ua,google:Ii,gemini:ia,groq:ma,lm_studio:ra,ollama:la,open_router:oa,openai:en,xai:pa,deepseek:ha},http_adapter:new yt({adapter:Ti,obsidian_request_url:Ng.requestUrl})},http_adapter:{class:yt,adapter:Ti,obsidian_request_url:Ng.requestUrl}},collections:{context_items:HS,event_logs:VS,smart_components:FS,smart_contexts:WS,smart_sources:{collection_key:"smart_sources",class:Ur,data_adapter:Hr,source_adapters:{md:Ys,txt:Ys,"excalidraw.md":K_,base:H_,canvas:V_,rendered:J_},content_parsers:[MS],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:Vr,data_adapter:Y_,block_adapters:{md:Ci,txt:Ci,"excalidraw.md":Ci}}},item_types:{SmartSource:Si,SmartBlock:Ai},items:{smart_source:bS,smart_block:AS},default_settings:ZS,modals:{context_selector:{class:vu,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:wu},notifications_feed_modal:{class:ku}}};Nt(jC,$C);var TC=jC;var Du=require("obsidian");function NC(){(0,Du.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}r(NC,"add_smart_chat_icon");function PC(){(0,Du.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}r(PC,"add_smart_connections_icon");function IC(){(0,Du.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}r(IC,"add_smart_lookup_icon");var MC=require("obsidian");var Ru={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function y3(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(y3,"define_default_create_methods");var Aa=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,y3(Ru)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=Ru[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,MC.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,Ru["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var LC=require("obsidian");var b3=require("obsidian");function Fu(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Fu,"get_smart_server_url");var v3="smart-plugins-op",k3="smart-plugins-op-secret";function w3({access_token:n,refresh_token:e},t){localStorage.setItem(t+"token",n),e&&localStorage.setItem(t+"refresh",e)}r(w3,"set_local_storage_token");async function zC(n,e){let t=E3(e.app.vault.getName()),s=`${Fu()}/auth/oauth_exchange2`,i=await(0,LC.requestUrl)({url:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:v3,client_secret:k3,code:n})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:o,refresh_token:a}=i.json;if(!o)throw new Error("No access_token in response");w3({access_token:o,refresh_token:a},t)}r(zC,"exchange_code_for_tokens");var x3="_smart_plugins_oauth_";function E3(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${x3}`}r(E3,"build_oauth_storage_prefix");function DC(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let s=Ui([...new Set(t)]);return n.replace(/{{\s*folder_tree\s*}}/gi,s)}r(DC,"replace_folder_tree_var");function RC(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let s=Ui([...new Set(t)]);return n.replace(/{{\s*folders_top\s*}}/gi,s)}r(RC,"replace_folders_top_var");function FC(n){console.log("replace_recent_n_var",n);let e=this;return n.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,s)=>{let i=parseInt(s,10)||0,o=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,o),o?`
- ${o}`:""}).trim()}r(FC,"replace_recent_n_var");function BC(n){let t=this.app?.metadataCache?.getTags?.()||{},s=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return n.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${s}
`).trim()}r(BC,"replace_vault_tags_var");function UC(n){n.register(e=>/{{\s*folder_tree\s*}}/i.test(e),DC,"{{ folder_tree }}"),n.register(e=>/{{\s*folders_top\s*}}/i.test(e),RC,"{{ folders_top }}"),n.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),BC,"{{ tags }}"),n.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),FC,"{{ recent_10 }}")}r(UC,"register_completion_variable_adapter_replacements");async function wt({app:n,plugin_ids:e=[]}={}){if(!n)return;let t=n.vault?.adapter;for(let s of e)await S3(n.plugins,s)&&console.warn(`Disabled legacy plugin: ${s}`),await A3(t,s)&&console.warn(`Removed legacy plugin: ${s}`)}r(wt,"remove_smart_plugins_plugin");async function S3(n,e){if(!(!n||!(n.plugins?.[e]||n.enabledPlugins?.has?.(e)||n.manifests&&e in n.manifests)))return n.plugins?.[e]&&await n.unloadPlugin?.(e),n.disablePluginAndSave&&await n.disablePluginAndSave(e),n.enabledPlugins?.has?.(e)&&n.enabledPlugins.delete(e),n.manifests&&e in n.manifests&&delete n.manifests[e],await n.loadManifests?.(),!0}r(S3,"disable_plugin_if_present");async function A3(n,e){if(!n?.exists)return;let t=`.obsidian/plugins/${e}`;if(await n.exists(t)){if(n.rmdir){await n.rmdir(t,!0);return}if(n.list&&n.remove){let i=[t];for(;i.length;){let o=i.pop(),a=await n.list(o);for(let c of a?.files||[])await n.remove(`${o}/${c}`);for(let c of a?.folders||[])i.push(`${o}/${c}`)}return await n.remove(t),!0}}}r(A3,"remove_plugin_folder");var Wi=class extends Br{static{r(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,NC(),PC(),IC(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new us.Notice(i,0),window.smart_env=null}let s=Nt(t,TC);return s.env_path="",await super.create(e,s)}async load(e=!1){if(this.run_migrations(),this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")||this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),us.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new us.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i.view?.file?.path;this.emit_source_opened(o,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i?.path;this.emit_source_opened(o,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&UC(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),gA(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let s=this.smart_sources.get(e);s&&(this._current_opened_source=e,s.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new Aa(this,{adapter:us.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),s=`${Fu()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(s,"_external"),s}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new us.Notice("No OAuth code provided in URL. Login failed.");return}try{await zC(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(s){console.error("OAuth callback error",s),new us.Notice(`OAuth callback error: ${s.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&C3(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){wt({app:this.plugin.app,plugin_ids:["smart-plugins"]}),wt({app:this.plugin.app,plugin_ids:["smart-editor"]}),wt({app:this.plugin.app,plugin_ids:["smart-sources"]}),wt({app:this.plugin.app,plugin_ids:["smart-claude"]}),wt({app:this.plugin.app,plugin_ids:["smart-gemini"]}),wt({app:this.plugin.app,plugin_ids:["smart-deepseek"]}),wt({app:this.plugin.app,plugin_ids:["smart-perplexity"]}),wt({app:this.plugin.app,plugin_ids:["smart-grok"]}),wt({app:this.plugin.app,plugin_ids:["smart-aistudio"]})}};function C3(n,e){let t=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}r(C3,"download_json");var O3=require("obsidian");var q3=require("obsidian");var WC=require("obsidian");var Bu=class extends Jt{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var VC=Y(JC(),1);var L3=Object.defineProperty,z3=r((n,e,t)=>e in n?L3(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),D3=r((n,e,t)=>(z3(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function R3(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(R3,"bytePairMerge");function F3(n,e){return n.length===1?[e.get(n.join(","))]:R3(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(F3,"bytePairEncode");function B3(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(B3,"escapeRegex");var Ig=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=VC.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=Ig.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Ig.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let u=d?.index??n.length;for(let f of n.substring(l,u).matchAll(s)){let b=this.textEncoder.encode(f[0]),g=this.rankMap.get(b.join(","));if(g!=null){o.push(g);continue}o.push(...F3(b,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},Wu=Ig;D3(Wu,"specialTokenRegex",n=>new RegExp(n.map(e=>B3(e)).join("|"),"g"));async function YC(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await KC(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await KC(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(YC,"fetch_json_cached");async function KC(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(KC,"do_fetch");var U3="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",Me=class extends Bu{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return we}get res_adapter(){return xe}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Ue({adapter:Ct})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:_e(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await YC(U3,"cl100k_base.json");this.tiktoken=new Wu(e)}},we=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},xe=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Gu=class extends Me{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Mg}get res_adapter(){return Lg}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},Mg=class extends we{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Lg=class extends xe{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};var zg=class extends Gu{static{r(this,"GoogleGeminiEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},W3={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."},gemini_note:{name:"Note about using Gemini Embeddings API",type:"html",value:'<p class="model-note"><b>WARNING: Gemini rate-limiting:</b> Google imposes strict rate limits on the Gemini Embeddings API. Smart Environment will attempt to retry. Retry details can be found in the developer console logs. Consistent rate limit errors may prevent all items from being properly embedded. Restarting Obsidian will attempt to re-embed any failed items. If you continue to experience issues, try disabling blocks to reduce the number of embeddings required by your Smart Environment.</p>'}},XC={class:zg,settings_config:W3};function G3(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(G3,"parse_lm_studio_models");var Hu=class extends Me{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Dg}get res_adapter(){return Rg}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return G3(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},Dg=class extends we{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Rg=class extends xe{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Fg=class extends Hu{static{r(this,"LmStudioEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},ZC={class:Fg};var Ju=class extends Me{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Bg}get res_adapter(){return Ug}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of J3(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Bg=class extends we{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},Ug=class extends xe{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},H3=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),J3=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(H3)},"filter_embedding_models");var Wg=class extends Ju{static{r(this,"OllamaEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},V3={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},QC={class:Wg,settings_config:V3};var Vu=class extends Me{static{r(this,"SmartEmbedOpenRouterAdapter")}static key="open_router";static defaults={description:"OpenRouter (Embeddings)",type:"API",adapter:"OpenRouterEmbeddings",endpoint:"https://openrouter.ai/api/v1/embeddings",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"text-embedding-3-small",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys",streaming:!1,api_key:null,batch_size:50,max_tokens:8191};get req_adapter(){return Gg}get res_adapter(){return Hg}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenRouter API key for embeddings",type:"password",description:"Required for OpenRouter embedding models.",placeholder:"Enter OpenRouter API key"}}}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}get models_endpoint(){return this.constructor.defaults.models_endpoint}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;if(!this.api_key){console.warn("[SmartEmbedOpenRouterAdapter] API key missing; cannot fetch models from OpenRouter.");let t=this.constructor.defaults.default_model,s={[t]:{id:t,model_name:t,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=s,s}try{let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET",headers:{Authorization:`Bearer ${this.api_key}`}})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}catch(t){if(console.error("[SmartEmbedOpenRouterAdapter] Failed to fetch models:",t),this.model.data.provider_models)return this.model.data.provider_models;let s=this.constructor.defaults.default_model,i={[s]:{id:s,model_name:s,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=i,i}}parse_model_data(e){let t=[];if(Array.isArray(e?.data))t=e.data;else if(Array.isArray(e))t=e;else return console.error("[SmartEmbedOpenRouterAdapter] Invalid model data format from OpenRouter:",e),{_:{id:"No models found."}};let s={};for(let i of t){let o=i.id||i.name;o&&K3(o)&&(s[o]={id:o,model_name:o,max_tokens:i.context_length||this.max_tokens,description:i.name||i.description||`Model: ${o}`,adapter:this.constructor.key})}return Object.keys(s).length?s:{_:{id:"No embedding models found."}}}},Gg=class extends we{static{r(this,"SmartEmbedOpenRouterRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Hg=class extends xe{static{r(this,"SmartEmbedOpenRouterResponseAdapter")}parse_response(){let e=this.response;if(!e||!Array.isArray(e.data))return console.error("[SmartEmbedOpenRouterResponseAdapter] Invalid embedding response format:",e),[];let t=null;return e.usage?.total_tokens&&e.data.length>0&&(t=e.usage.total_tokens/e.data.length),e.data.map(s=>({vec:s.embedding||s.data||[],tokens:t}))}},K3=r(n=>{let e=String(n||"").toLowerCase();return!!(e.split(/[-:/_]/).some(s=>["embed","embedding","bge"].includes(s))||e.includes("text-embedding"))},"is_embedding_model");var Jg=class extends Vu{static{r(this,"OpenRouterEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},e2={class:Jg};var Ku=class extends Me{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Vg}get res_adapter(){return Kg}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Vg=class extends we{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Kg=class extends xe{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var Yg=class extends Ku{static{r(this,"OpenAIEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get batch_size(){return 30}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Y3={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},dimensions:{name:"Embedding Dimensions",type:"dropdown",description:"Select the number of dimensions for the embeddings (only for text-embedding-3 models).",option_1:"256|256 (equivalent to ada using 'large' model)",option_2:"512|512 (equivalent to ada using 'small' model)",option_3:"1536|1536",option_4:"3072|3072 (uses >10X more RAM/storage than 256)",default:"512"}},t2={class:Yg,settings_config:Y3};var Yu=class extends J{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Xg}res_adapter=Zg;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Xg=class extends K{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Zg=class extends W{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:_e(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var Qg=class extends Yu{static{r(this,"AnthropicChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},X3={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."}},s2={class:Qg,settings_config:X3};var Z3=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Gi=class extends J{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=ey;parse_model_data(e){return e.data.filter(t=>!Z3.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:Q3(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function Q3(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(Q3,"get_max_input_tokens");var ey=class extends W{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Xu=class extends Gi{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var ty=class extends Xu{static{r(this,"AzureChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},eD={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."},azure_resource_name:{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},azure_deployment_name:{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},azure_api_version:{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}},n2={class:ty,settings_config:eD};var Zu=class extends J{static{r(this,"SmartChatModelCohereAdapter")}static key="cohere";static defaults={description:"Cohere Command-R",type:"API",endpoint:"https://api.cohere.ai/v1/chat",streaming:!1,adapter:"Cohere",models_endpoint:"https://api.cohere.ai/v1/models",default_model:"command-r",signup_url:"https://dashboard.cohere.com/welcome/register?redirect_uri=%2Fapi-keys"};get req_adapter(){return sy}get res_adapter(){return ny}async count_tokens(e){let t={url:`${this.endpoint}/tokenize`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.api_key}`},body:JSON.stringify({text:typeof e=="string"?e:JSON.stringify(e)})};return(await this.http_adapter.request(t)).json.tokens.length}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("command-")).reduce((t,s)=>(t[s.name]={model_name:s.name,id:s.name,max_input_tokens:s.context_length,tokenizer_url:s.tokenizer_url,finetuned:s.finetuned,description:`Max input tokens: ${s.context_length}, Finetuned: ${s.finetuned}`,raw:s},t),{})}},sy=class extends K{static{r(this,"SmartChatModelCohereRequestAdapter")}to_platform(){return this.to_cohere()}to_cohere(){let e={model:this.model_id,message:this._get_latest_user_message(),chat_history:this._transform_messages_to_cohere_chat_history(),max_tokens:this.max_tokens,temperature:this.temperature,stream:this.stream,...this.tools&&{tools:this._transform_tools_to_cohere()},...this._req.tool_choice&&{tool_choice:this._req.tool_choice},...this._req.preamble&&{preamble:this._req.preamble},...this._req.conversation_id&&{conversation_id:this._req.conversation_id},...this._req.connectors&&{connectors:this._req.connectors},...this._req.documents&&{documents:this._req.documents}};return this._req.response_format&&(e.response_format={type:this._req.response_format.type,...this._req.response_format.schema&&{schema:this._req.response_format.schema}}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}_get_latest_user_message(){if(this.messages.some(t=>Array.isArray(t.content)&&t.content.some(s=>s.type==="image_url")))throw new Error("Cohere API does not support image input");let e=this.messages.filter(t=>t.role==="user");return e[e.length-1]?.content||""}_transform_messages_to_cohere_chat_history(){return this.messages.slice(0,-1).map(e=>({role:this._get_cohere_role(e.role),message:this._get_cohere_content(e.content)}))}_get_cohere_role(e){return{system:"SYSTEM",user:"USER",assistant:"CHATBOT",function:"CHATBOT"}[e]||e.toUpperCase()}_get_cohere_content(e){if(Array.isArray(e)){for(let t of e)if(t.type==="image_url")throw new Error("Cohere API does not support image input");return e.map(t=>t.type==="text"?t.text:JSON.stringify(t)).join(`
`)}return e}_transform_tools_to_cohere(){return this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}},ny=class extends W{static{r(this,"SmartChatModelCohereResponseAdapter")}to_openai(){if(this._res.message)throw new Error(this._res.message);return{id:this._res.generation_id||"cohere_"+Date.now(),object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.finish_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:this._res.text||""};return this._res.citations&&(e.citations=this._res.citations),this._res.documents&&(e.documents=this._res.documents),this._res.search_queries&&(e.search_queries=this._res.search_queries),this._res.search_results&&(e.search_results=this._res.search_results),e}_get_openai_finish_reason(e){return{COMPLETE:"stop",MAX_TOKENS:"length",ERROR:"error",STOP_SEQUENCE:"stop"}[e]||"stop"}_transform_usage_to_openai(){return!this._res.meta||!this._res.meta.billed_units?{prompt_tokens:null,completion_tokens:null,total_tokens:null}:{prompt_tokens:this._res.meta.billed_units.input_tokens||null,completion_tokens:this._res.meta.billed_units.output_tokens||null,total_tokens:(this._res.meta.billed_units.input_tokens||0)+(this._res.meta.billed_units.output_tokens||0)}}};var iy=class extends Zu{static{r(this,"CohereChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},tD={api_key:{name:"API Key",type:"password",description:"Enter your Cohere API key."}},i2={class:iy,settings_config:tD};var Qu=class extends J{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return oy}get res_adapter(){return ry}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},oy=class extends K{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},ry=class extends W{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var ay=class extends Qu{static{r(this,"DeepseekChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},sD={api_key:{name:"API Key",type:"password",description:"Enter your Deepseek API key."}},o2={class:ay,settings_config:sD};var em=class extends J{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=cy;res_adapter=ly;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},cy=class extends K{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},ly=class extends W{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:_e(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}};var dy=class extends em{static{r(this,"GoogleChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},nD={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."}},r2={class:dy,settings_config:nD};var tm=class extends J{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return _y}get res_adapter(){return uy}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},_y=class extends K{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},uy=class extends W{static{r(this,"SmartChatModelGroqResponseAdapter")}};var my=class extends tm{static{r(this,"GroqChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},iD={api_key:{name:"API Key",type:"password",description:"Enter your Groq API key."}},a2={class:my,settings_config:iD};var sm=class extends J{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return py}get res_adapter(){return hy}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},py=class extends K{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},hy=class extends W{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var fy=class extends sm{static{r(this,"LmStudioChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},oD={},c2={class:fy,settings_config:oD};var nm=class extends J{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=gy;res_adapter=yy;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},gy=class extends K{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},yy=class extends W{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:_e(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var by=class extends nm{static{r(this,"OllamaChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},rD={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},l2={class:by,settings_config:rD};var vy=class extends Gi{static{r(this,"OpenAIChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},aD={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},openai_note:{name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."}},d2={class:vy,settings_config:aD};var im=class extends J{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return K}get res_adapter(){return W}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var ky=class extends im{static{r(this,"XaiChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},cD={api_key:{name:"API Key",type:"password",description:"Enter your xAI API key."}},_2={class:ky,settings_config:cD};var u2={collections:{embedding_models:{providers:{gemini:XC,lm_studio:ZC,ollama:QC,open_router:e2,openai:t2}},chat_completion_models:{providers:{anthropic:s2,azure:n2,cohere:i2,deepseek:o2,google:r2,groq:a2,lm_studio:c2,ollama:l2,open_router:c_,openai:d2,xai:_2}}}};var Hi=require("obsidian");async function wy(n){let e=n.plugin?.app||window.app,t=qu(e),s=(typeof localStorage<"u"?localStorage.getItem(t+"token"):"")||"";if(!s){console.warn("[smart_plugins] No OAuth token found; skipping Smart Plugins auto\u2011update."),om("Smart Plugins: connect your Smart Plugins account to keep using Pro plugins.");let i=t+"auth_misses",o=parseInt(localStorage.getItem(i)||"0",10);return localStorage.setItem(i,(o+1).toString()),{updated:[],skipped:[],checked:0}}try{let i=await _D(e);console.log("[smart_plugins] Built installed plugins map:",i);let o=await Ou(s);console.log("[smart_plugins] Fetched server plugin list:",o);let a=Array.isArray(o.list)?o.list:[],c=Array.isArray(o.unauthorized)?o.unauthorized:[],l=o.sub_exp,d=typeof l=="number"&&l<Date.now(),_=[],u=[],p=[];if(d){if(c.length){console.log("[smart_plugins] Subscription expired; handling unauthorized plugins.",{unauthorized_list:c});for(let y of c){if(!i[y.plugin_id]){p.push(y.plugin_id);continue}if(y.core_repo)await lD(e,y)&&u.push(y.plugin_id);else{await uD(e,y.plugin_id)&&_.push(y.plugin_id);continue}}}let v={updated:[],skipped:[],checked:0,removed:_,replaced:u,not_installed:p,unauthorized_count:c.length,sub_exp:l||null};return console.log({update_result:v}),v}let f=a.length,b=[];for(let v of a){if(!v||!v.repo)continue;let y=v.version||"unknown",S=(v.manifest_id||v.repo.replace("/","_")).trim(),A=i[S];!A||!A.version||Au(A.version,y)&&b.push({item:v,plugin_id:S,local_version:A.version,server_version:y})}if(!b.length)return{updated:[],skipped:[],checked:f};let g=[],k=[];for(let v of b){let{item:y,plugin_id:S,local_version:A,server_version:$}=v;try{let j=await Cu(y.repo,s),{files:C,pluginManifest:x}=await wa(j),m=x.id,h=`${e.vault.configDir}/plugins/${m}`;await xa(e.vault.adapter,h,C),g.push(`${y.repo}@${$}`)}catch(j){console.error("[smart_plugins] Failed to auto\u2011update plugin:",{repo:y.repo,plugin_id:S,local_version:A,server_version:$,error:j}),k.push(y.repo)}}if(g.length){let v=g.length===1?"":"s";om(`Smart Plugins: updated ${g.length} plugin${v}. Please restart Obsidian to apply updates.`)}else k.length||om("Smart Plugins: no updates applied.");return{updated:g,skipped:k,checked:f}}catch(i){return console.error("[smart_plugins] update_installed_smart_plugins error:",i),om("Smart Plugins: failed to check for updates. See console for details."),{updated:[],skipped:[],checked:0}}}r(wy,"update_installed_smart_plugins");async function lD(n,e){let t=await(0,Hi.requestUrl)({url:`https://api.github.com/repos/${e.core_repo}/releases/latest`,method:"GET"}),s=t?.json||{};if(!(s?.tag_name||null))return console.error("[smart_plugins] Failed to get latest core plugin version from GitHub:",{core_repo:e.core_repo,response:t}),null;try{let o=s?.assets?.find(u=>u.name.endsWith(".zip"))?.browser_download_url||null;if(!o)return console.error("[smart_plugins] Failed to find core plugin zip asset in GitHub release:",{core_repo:e.core_repo,release:s}),null;let a=await dD(o),{files:c,pluginManifest:l}=await wa(a),d=e.plugin_id,_=`${n.vault.configDir}/plugins/${d}`;return await xa(n.vault.adapter,_,c),!0}catch(o){return console.error("[smart_plugins] Failed to install core plugin:",{core_repo:e.core_repo,error:o}),null}}r(lD,"replace_pro_with_core");async function dD(n){console.log(`[smart_plugins] download plugin from URL: ${n}`);let e=await(0,Hi.requestUrl)({url:n,method:"GET",headers:{Accept:"application/zip"}});if(e.status&&e.status!==200)throw new Error(`Download error ${e.status}: ${e.text||""}`);return Su(e.arrayBuffer,"Download")}r(dD,"fetch_zip_from_public_url");async function _D(n){let e={},t=n.plugins;if(!t)return e;await t.loadManifests();let s=t.manifests||{};for(let i in s){if(!Object.prototype.hasOwnProperty.call(s,i))continue;let o=s[i]||{};e[i]={id:o.id||i,name:o.name||i,version:o.version||""}}return e}r(_D,"build_installed_plugins_map");function om(n){try{typeof Hi.Notice=="function"?new Hi.Notice(n):console.log("[smart_plugins]",n)}catch(e){console.log("[smart_plugins] notice error",e,n)}}r(om,"show_notice");async function uD(n,e){let t=n?.vault?.adapter;if(!t)return!1;let s=`${n.vault.configDir}/plugins/${e}`,i=`${s}/main.js`,o=`${s}/manifest.json`;try{return await t.exists(i)&&await t.remove(i),await t.exists(o)&&await t.remove(o),!0}catch(a){console.error("[smart_plugins] Failed to remove main.js for unauthorized plugin",{plugin_id:e,error:a})}return!1}r(uD,"remove_main_js_for_plugin");var Ji=class n extends Wi{static{r(this,"SmartEnv")}static version="2.3.11";is_pro=!0;async load(e=!1){await super.load(e),n.wait_for({loaded:!0}).then(async()=>{console.warn("[smart_env] Checking for Smart Plugins updates..."),wy(this),this._registered_refresh_event||(this._registered_refresh_event=!0,this.events.on("pro_plugins:refresh",async()=>{console.warn("[smart_env] Refreshing Smart Plugins list..."),wy(this)}))})}},QDe=Ji.version;var m2=Nt(sS,u2);var pD={modules:{smart_rank_model:{class:pl,adapters:{cohere:Rn},http_adapter:new Ue({adapter:Ho,obsidian_request_url:xy.requestUrl})}}},rm=class extends Go{static{r(this,"SmartConnectionsPlugin")}SmartEnv=Ji;get smart_env_config(){if(!this._smart_env_config){let e=super.smart_env_config;Ot(e,m2),Ot(e,Cx),Ot(e,pD),this._smart_env_config=e}return this._smart_env_config}async initialize(){await this.remove_deprecated_plugin_if_present(),p1(this),w1(this),await super.initialize?.(),console.log("Loading Smart Connections Early Release plugin..."),this.registerEditorExtension(Iw),this.registerEditorExtension(c1(this)),this.connections_footer_view=new Kd(this),this.app.workspace.onLayoutReady(()=>{this.toggled_inline_connections()}),this.toggled_footer_connections(),this.register_env_event_listeners(),console.log("Smart Connections Early Release plugin loaded."),E1(this)}get oauth_storage_prefix(){if(!this._oauth_storage_prefix){let e=this.app.vault.getName();this._oauth_storage_prefix=QE(e)}return this._oauth_storage_prefix}get_smart_plugins_token(){let{token:e}=ZE(this.oauth_storage_prefix);return e||""}async remove_deprecated_plugin_if_present(){let e="smart-connections-early-release";try{let t=this.app.plugins;t.enabledPlugins?.has(e)&&await t.disablePlugin(e);let i=`${String(this.app.vault.configDir||"").replace(/\/$/,"")}/plugins/${e}`;await this.app.vault.adapter.exists(i)&&(await this.app.vault.adapter.rmdir(i,!0),await t.loadManifests())}catch(t){console.warn("Smart Connections Early Release: failed to clean up deprecated plugin",t)}}get commands(){return{...super.commands,toggle_inline_connections:{id:"toggle-inline-connections",name:"Toggle: Inline connections",callback:r(()=>{let e=this.env.connections_lists.settings;e.inline_connections=!e.inline_connections},"callback")},toggle_footer_connections:{id:"toggle-footer-connections",name:"Toggle: Footer connections",callback:r(()=>{let e=this.env.connections_lists.settings;e.footer_connections=!e.footer_connections},"callback")}}}register_code_blocks(){super.register_code_blocks?.(),this.registerMarkdownCodeBlockProcessor("smart-connections-web",this.render_web_code_block.bind(this)),this.registerMarkdownCodeBlockProcessor("connections",(e,t,s)=>{new Yd(this).render(e,t,s)})}register_env_event_listeners(){this.env_listeners||(this.env_listeners=[]),this.env_listeners.push(this.env.events.on("settings:changed",e=>{e.path?.includes("inline_connections")&&this.toggled_inline_connections()})),this.env_listeners.push(this.env.events.on("settings:changed",e=>{e.path?.includes("footer_connections")&&this.toggled_footer_connections()}))}onunload(){console.log("Unloading Smart Connections Early Release plugin..."),this.env_listeners.forEach(e=>e()),this.connections_footer_view?.unload(),super.onunload?.()}get_editor_view(){if(!this.app.workspace.getActiveFile())return console.log("Smart Connections: No active file found"),null;let t=this.app.workspace.getActiveFileView();return t?t.editor?.cm||null:(console.log("Smart Connections: No active file view found"),null)}toggled_inline_connections(){this.app.workspace.getLeavesOfType("markdown").map(e=>e.view?.editor?.cm).filter(Boolean).forEach(e=>{e.plugin(sf)?.refresh()})}toggled_footer_connections(){this.get_editor_view()&&this.env.connections_lists.settings.footer_connections?this.connections_footer_view.render_view():this.connections_footer_view.remove()}async render_web_code_block(e,t,s){t.empty(),t.createEl("span",{text:"Loading\u2026"}),await this.SmartEnv.wait_for({loaded:!0});let i=[],o={};if(e.trim().length){let l=e.split(`
`).map(d=>d.trim()).filter(d=>d.length);for(let d of l){if(d.startsWith("include:")){let _=d.replace("include:","").trim();_&&(o.key_includes_any=_.split(",").map(u=>u.trim()));continue}if(d.startsWith("does not end with:")){let _=d.replace("does not end with:","").trim();_&&(o.exclude_key_ends_with_any=_.split(",").map(u=>u.trim()));continue}if(d.startsWith("limit:")){let _=d.replace("limit:","").trim();_&&(o.limit=parseInt(_));continue}i.push(d)}}if(i.length){e=i.join(`
`);let l=await this.env.render_component("lookup",this.env.smart_sources,{attribution:this.attribution,query:e,filter:o});t.empty(),t.appendChild(l);return}let a=this.env.smart_sources.get(s.sourcePath)??this.env.smart_sources.init_file_path(s.sourcePath);if(!a){t.empty(),t.createEl("p",{text:"Entity not found: "+s.sourcePath});return}let c=await this.env.render_component("connections_web",a,{attribution:this.attribution,filter:o});t.empty(),t.appendChild(c)}async check_for_update(){let e="brianpetro/smart-connections-obsidian-early";try{let t=this.get_smart_plugins_token();if(!t){console.log("Smart Connections Early Release: skipping update check (no Smart Plugins token)");return}let s=await(0,xy.requestUrl)({url:`${Hd()}/plugin_version`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({repo:e})});if(s.status!==200)throw new Error(`plugin_version responded with status ${s.status}`);let i=s.json?.version;if(!b1(this.manifest.version,i))return;this.env?.events?.emit("plugin:new_version_available",{version:i}),this.notices?.show("new_version_available",{version:i}),this.update_available=!0}catch(t){console.error("Smart Connections Early Release: failed to check for update",t)}}};

const smart_hash_id='b2733ca5b6f933e6d9270fdb1236c755672735a5f45434f868109ef5865bd421';