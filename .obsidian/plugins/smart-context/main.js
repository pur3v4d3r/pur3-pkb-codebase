var YC=Object.create;var Ri=Object.defineProperty;var ZC=Object.getOwnPropertyDescriptor;var QC=Object.getOwnPropertyNames;var e2=Object.getPrototypeOf,t2=Object.prototype.hasOwnProperty;var r=(n,e)=>Ri(n,"name",{value:e,configurable:!0});var Ea=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),s2=(n,e)=>{for(var t in e)Ri(n,t,{get:e[t],enumerable:!0})},Ay=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of QC(e))!t2.call(n,i)&&i!==t&&Ri(n,i,{get:()=>e[i],enumerable:!(s=ZC(e,i))||s.enumerable});return n};var P=(n,e,t)=>(t=n!=null?YC(e2(n)):{},Ay(e||!n||!n.__esModule?Ri(t,"default",{value:n,enumerable:!0}):t,n)),n2=n=>Ay(Ri({},"__esModule",{value:!0}),n);var eb=Ea(rc=>{"use strict";rc.byteLength=I2;rc.toByteArray=L2;rc.fromByteArray=R2;var Ye=[],ke=[],P2=typeof Uint8Array<"u"?Uint8Array:Array,Im="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(ms=0,Zy=Im.length;ms<Zy;++ms)Ye[ms]=Im[ms],ke[Im.charCodeAt(ms)]=ms;var ms,Zy;ke[45]=62;ke[95]=63;function Qy(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(Qy,"getLens");function I2(n){var e=Qy(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(I2,"byteLength");function M2(n,e,t){return(e+t)*3/4-t}r(M2,"_byteLength");function L2(n){var e,t=Qy(n),s=t[0],i=t[1],o=new P2(M2(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=ke[n.charCodeAt(l)]<<18|ke[n.charCodeAt(l+1)]<<12|ke[n.charCodeAt(l+2)]<<6|ke[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=ke[n.charCodeAt(l)]<<2|ke[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=ke[n.charCodeAt(l)]<<10|ke[n.charCodeAt(l+1)]<<4|ke[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(L2,"toByteArray");function z2(n){return Ye[n>>18&63]+Ye[n>>12&63]+Ye[n>>6&63]+Ye[n&63]}r(z2,"tripletToBase64");function D2(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(z2(s));return i.join("")}r(D2,"encodeChunk");function R2(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(D2(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(Ye[e>>2]+Ye[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(Ye[e>>10]+Ye[e>>4&63]+Ye[e<<2&63]+"=")),i.join("")}r(R2,"fromByteArray")});var Ww=Ea(Jl=>{"use strict";Jl.byteLength=Pj;Jl.toByteArray=Mj;Jl.fromByteArray=Dj;var ot=[],Ee=[],Nj=typeof Uint8Array<"u"?Uint8Array:Array,Qp="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Os=0,Bw=Qp.length;Os<Bw;++Os)ot[Os]=Qp[Os],Ee[Qp.charCodeAt(Os)]=Os;var Os,Bw;Ee[45]=62;Ee[95]=63;function Uw(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(Uw,"getLens");function Pj(n){var e=Uw(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(Pj,"byteLength");function Ij(n,e,t){return(e+t)*3/4-t}r(Ij,"_byteLength");function Mj(n){var e,t=Uw(n),s=t[0],i=t[1],o=new Nj(Ij(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Ee[n.charCodeAt(l)]<<18|Ee[n.charCodeAt(l+1)]<<12|Ee[n.charCodeAt(l+2)]<<6|Ee[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Ee[n.charCodeAt(l)]<<2|Ee[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Ee[n.charCodeAt(l)]<<10|Ee[n.charCodeAt(l+1)]<<4|Ee[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(Mj,"toByteArray");function Lj(n){return ot[n>>18&63]+ot[n>>12&63]+ot[n>>6&63]+ot[n&63]}r(Lj,"tripletToBase64");function zj(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(Lj(s));return i.join("")}r(zj,"encodeChunk");function Dj(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(zj(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(ot[e>>2]+ot[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(ot[e>>10]+ot[e>>4&63]+ot[e<<2&63]+"=")),i.join("")}r(Dj,"fromByteArray")});var LE=Ea(l_=>{"use strict";l_.byteLength=bI;l_.toByteArray=kI;l_.fromByteArray=EI;var lt=[],Ce=[],yI=typeof Uint8Array<"u"?Uint8Array:Array,Sf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Ls=0,IE=Sf.length;Ls<IE;++Ls)lt[Ls]=Sf[Ls],Ce[Sf.charCodeAt(Ls)]=Ls;var Ls,IE;Ce[45]=62;Ce[95]=63;function ME(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(ME,"getLens");function bI(n){var e=ME(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(bI,"byteLength");function vI(n,e,t){return(e+t)*3/4-t}r(vI,"_byteLength");function kI(n){var e,t=ME(n),s=t[0],i=t[1],o=new yI(vI(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Ce[n.charCodeAt(l)]<<18|Ce[n.charCodeAt(l+1)]<<12|Ce[n.charCodeAt(l+2)]<<6|Ce[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Ce[n.charCodeAt(l)]<<2|Ce[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Ce[n.charCodeAt(l)]<<10|Ce[n.charCodeAt(l+1)]<<4|Ce[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(kI,"toByteArray");function wI(n){return lt[n>>18&63]+lt[n>>12&63]+lt[n>>6&63]+lt[n&63]}r(wI,"tripletToBase64");function xI(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(wI(s));return i.join("")}r(xI,"encodeChunk");function EI(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(xI(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(lt[e>>2]+lt[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(lt[e>>10]+lt[e>>4&63]+lt[e<<2&63]+"=")),i.join("")}r(EI,"fromByteArray")});var NA=Ea($u=>{"use strict";$u.byteLength=zM;$u.toByteArray=RM;$u.fromByteArray=UM;var mt=[],qe=[],LM=typeof Uint8Array<"u"?Uint8Array:Array,Ng="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Vs=0,jA=Ng.length;Vs<jA;++Vs)mt[Vs]=Ng[Vs],qe[Ng.charCodeAt(Vs)]=Vs;var Vs,jA;qe[45]=62;qe[95]=63;function TA(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(TA,"getLens");function zM(n){var e=TA(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(zM,"byteLength");function DM(n,e,t){return(e+t)*3/4-t}r(DM,"_byteLength");function RM(n){var e,t=TA(n),s=t[0],i=t[1],o=new LM(DM(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=qe[n.charCodeAt(l)]<<18|qe[n.charCodeAt(l+1)]<<12|qe[n.charCodeAt(l+2)]<<6|qe[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=qe[n.charCodeAt(l)]<<2|qe[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=qe[n.charCodeAt(l)]<<10|qe[n.charCodeAt(l+1)]<<4|qe[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(RM,"toByteArray");function FM(n){return mt[n>>18&63]+mt[n>>12&63]+mt[n>>6&63]+mt[n&63]}r(FM,"tripletToBase64");function BM(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(FM(s));return i.join("")}r(BM,"encodeChunk");function UM(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(BM(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(mt[e>>2]+mt[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(mt[e>>10]+mt[e>>4&63]+mt[e<<2&63]+"=")),i.join("")}r(UM,"fromByteArray")});var D3={};s2(D3,{default:()=>vm});module.exports=n2(D3);var $n=require("obsidian");var Hc=require("obsidian");var Mt=require("obsidian");var Aa=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var Sa=class extends Aa{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var rs=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new Sa(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};async function i2(n,e={}){let t=Object.entries(n.settings_config).map(([o,a])=>(a.setting||(a.setting=o),this.render_setting_html(a))).join(`
`),s=Object.entries(n.collections).map(([o,a])=>`<div data-smart-settings="${o}"></div>`).join(`
`);return`
<div class="">
${t}
${s}
</div>
`}r(i2,"build_html");async function Sy(n,e={}){let t=await i2.call(this,n,e),s=this.create_doc_fragment(t);return await o2.call(this,n,s,e)}r(Sy,"render");async function o2(n,e,t={}){await this.render_setting_components(e,{scope:n});let s=e.querySelectorAll("[data-smart-settings]");for(let i of s){let o=i.dataset.smartSettings;await n[o].render_settings(i)}return e}r(o2,"post_process");var Ca=class{static{r(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let s=new this(e,t);return await s.load(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}static create_sync(e,t={}){let s=new this(e,t);return s.load_sync(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}get settings(){return r2(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",a2(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function r2(n,e){let t=new WeakMap,s=new WeakMap,i=r((a,c)=>{if(!wm(a)||s.has(a))return a;if(t.has(a))return t.get(a);let l=o(a,c);return t.set(a,l),s.set(l,a),l},"wrap_value"),o=r((a,c)=>new Proxy(a,{set(l,d,_){let m=[...c,d],p=km(l[d]),f=km(_);return l[d]=i(_,m),c2(p,f)&&e({type:"set",path:m,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],m=km(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:m}),!0}}),"create_proxy");return i(n,[])}r(r2,"observe_object");function a2(n){let e=Array.isArray(n.path)?n.path:[];return{type:n.type,path:e,path_string:e.join("."),value:n.value,previous_value:n.previous_value}}r(a2,"build_settings_changed_event");function km(n){if(!wm(n))return n;if(typeof structuredClone=="function")try{return structuredClone(n)}catch{}try{return JSON.parse(JSON.stringify(n))}catch{return n}}r(km,"snapshot_value");function c2(n,e){return Cy(n)!==Cy(e)}r(c2,"has_changed");function Cy(n){if(n===void 0)return"undefined";if(Number.isNaN(n))return"number:NaN";if(n===1/0)return"number:Infinity";if(n===-1/0)return"number:-Infinity";if(!wm(n))return`${typeof n}:${String(n)}`;try{return`object:${JSON.stringify(n)}`}catch{return`object:${String(n)}`}}r(Cy,"serialize_value");function wm(n){return typeof n=="object"&&n!==null}r(wm,"is_observable");function Je(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Oy(e[t])&&Oy(n[t])?Je(n[t],e[t]):n[t]=e[t]);return n}r(Je,"deep_merge");function Oy(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Oy,"is_plain_object");function pe(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(pe,"camel_case_to_snake_case");function qy(n){return n.collections||(n.collections={}),n.modules||(n.modules={}),n.items||(n.items={}),Object.entries(n.collections).forEach(([e,t])=>{typeof t=="function"&&(n.collections[e]={class:t});let s=pe(e);s!==e&&(n.collections[s]=n.collections[e],delete n.collections[e]),n.collections[s].collection_key||(n.collections[s].collection_key=s),t.item_type&&(n.items[t.item_type.key||pe(t.item_type.name)]={class:t.item_type})}),Object.entries(n.modules).forEach(([e,t])=>{typeof t=="function"&&(n.modules[e]={class:t});let s=pe(e);s!==e&&(n.modules[s]=n.modules[e],delete n.modules[e])}),n.item_types||(n.item_types={}),n.items||(n.items={}),Object.entries(n.item_types).forEach(([e,t])=>{if(typeof t=="function"){let s=pe(e);n.items[s]={class:t,actions:{},...n.items[s]||{}}}}),n}r(qy,"normalize_opts");function l2(n){if(!n||typeof n!="object")return!1;let e=Object.getPrototypeOf(n);return e===Object.prototype||e===null}r(l2,"is_plain_object");function Oa(n){if(Array.isArray(n))return n.map(e=>Oa(e));if(l2(n)){let e={};for(let[t,s]of Object.entries(n))e[t]=Oa(s);return e}return n}r(Oa,"deep_clone_config");function Qs(n,e){let t=$y(n),s=$y(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(Qs,"compare_versions");function $y(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r($y,"normalize_version_value");function Fi(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Fi,"is_plain_object");function gt(n,e,t=[]){if(!Fi(n)||!Fi(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Fi(i)?(Fi(n[s])||(n[s]={}),gt(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(gt,"deep_merge_no_overwrite");function yt(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(Qs(d,_)>0){let p={...c};gt(p,l),n.collections[a]=p}else gt(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;Qs(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):gt(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),gt(n[i],o)):n[i]=o}return n}r(yt,"merge_env_config");function jy(n={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:s}=n;return(e!==void 0||t!==void 0||s!==void 0)&&(n.smart_sources=n.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!n.smart_sources?.file_exclusions?.length||n.smart_sources?.file_exclusions==="Untitled")&&(n.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!n.smart_sources.folder_exclusions?.length&&(n.smart_sources.folder_exclusions=t),s!==void 0&&s.length&&!n.smart_sources.excluded_headings?.length&&(n.smart_sources.excluded_headings=s)),delete n.file_exclusions,delete n.folder_exclusions,delete n.excluded_headings,n}r(jy,"migrate_exclusion_settings_2025_08_22");var d2=typeof globalThis<"u"?globalThis:Function("return this")(),Bi=class{static{r(this,"SmartEnv")}static version="2.2.8";scope_name="smart_env";static global_ref=d2;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=rs.create(this,u2(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([s])=>this.primary_main_key&&s===this.primary_main_key?-1:0);for(let[s,i]of t){if(!i?.main){console.warn(`SmartEnv: '${s}' unloaded, skipping`),delete this.smart_env_configs[s];continue}if(!i?.opts){console.warn(`SmartEnv: '${s}' opts missing, skipping`);continue}yt(this._config,Oa(qy(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:s}=t||{};if(s)for(let[i,o]of Object.entries(s.collections||{})){let a=o?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:Qs(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,_2(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let s=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(s),t(this.global_env))},1e3)}else{let s=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(s),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let s={};this.global_env&&Qs(this.version,this.global_env.constructor?.version||0)>0&&(s.primary_main_key=pe(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(s);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let s=pe(e.constructor.name);this.smart_env_configs[s]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:r(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await Ca.create(this),this.config.default_settings&&gt(this.settings,this.config.default_settings),jy(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:s}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let s=e.collections[t]?.class;s&&(s.default_settings&&gt(this.settings,{[t]:s.default_settings}),typeof s.init=="function"&&(await s.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((s,i)=>{let o=this.config.collections?.[s]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return o-a});for(let s of t){let i=Date.now();typeof this[s]?.process_load_queue=="function"&&(await this[s].process_load_queue(),this[s].load_time_ms=Date.now()-i,this.collections[s]="loaded",console.log(`Loaded ${this[s].collection_key} in ${this[s].load_time_ms}ms`))}}static unload_main(e){let t=pe(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let s=this.opts.modules[e];return s?(t={...s,class:null,...t},new s.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||Sy}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,s={}){let i=this.get_component(e,t);return i?await i(t,s):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let s=t.collection_key??t.scope_name,i=s?`${s}-${e}`:e;if(!this._components[i])try{if(this.opts.components[s]?.[e]){let o=this.opts.components[s][e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let o=this.opts.components[e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${s}`)}catch(o){console.error("Error getting component",o),console.log(`scope_name: ${s}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[s]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.config.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(s=>s.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let s=e.map(i=>{let o=i.split("/").slice(-2,-1)[0];return{dir:o,count:this.fs.file_paths.filter(a=>a.includes(o)).length}});t=s.reduce((i,o)=>o.count>i.count?o:i,s[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(Je(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(s=>s.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((s,i,o)=>o.indexOf(s)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function _2(n){return{items:Object.fromEntries(Object.entries(n.items||{}).map(([e,t])=>[e,t.data]))}}r(_2,"collection_to_plain");function u2(n){if(!n)return{};if(typeof n=="function")return{adapter_class:n};let e=n.adapter_class||n.adapter;return e?{adapter_class:e}:{}}r(u2,"build_events_opts");function m2(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=h2(n,t),o=p2(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(m2,"create_regex");function p2(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(p2,"adjust_for_windows_paths");function h2(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(h2,"glob_to_regex_pattern");function Ty(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:m2(n,s)}r(Ty,"glob_to_regex");function Ny(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(Ny,"fuzzy_search");var qa=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(Ty(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return Ny(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var f2=P(require("obsidian"),1);var $a=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=f2,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function ja(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(ja,"empty");var Py=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var Iy=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var g2=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,Ta=r((n,e)=>{let t=e.trim();(g2.test(t)?Iy:Py)(n,t)},"safe_inner_html");function je(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(je,"escape_html");function My(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=en(l,o),l=xm(l,15),l=en(l,a),i^=l,i=xm(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=en(l,o),l=xm(l,15),l=en(l,a),i^=l;break}return i^=n.length,i=y2(i),i|0}r(My,"murmur_hash_32");function Q(n,e=0){return(My(n,e)>>>0).toString(36)}r(Q,"murmur_hash_32_alphanumeric");function en(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(en,"multiply_32");function xm(n,e){return n<<e|n>>>32-e}r(xm,"rotate_left_32");function y2(n){return n^=n>>>16,n=en(n,2246822507),n^=n>>>13,n=en(n,3266489909),n^=n>>>16,n|0}r(y2,"fmix_32");function Em(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(Em,"convert_to_time_ago");function as(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(as,"cos_sim");function be(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(be,"get_by_path");function ve(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(ve,"set_by_path");function Am(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(Am,"delete_by_path");function Sm(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(Sm,"compute_centroid");function Cm(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let m=Math.sqrt(_);s[a]+=m,s[l]+=m}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(Cm,"compute_medoid");var Na=new WeakMap,Pa=new WeakMap,Ia=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return be(e,t,s)}set_by_path(e,t,s,i=null){ve(e,t,s,i)}delete_by_path(e,t,s=null){Am(e,t,s)}escape_html(e){return je(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||Pa.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");Pa.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=Pa.get(i);c&&(i.removeEventListener("change",c),Pa.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=Q(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){ja(e)}safe_inner_html(e,t){Ta(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=Na.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},Na.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(m){console.error("[smart-view] disposer error",m)}}finally{try{l.disconnect()}catch{}Na.get(e)===c&&Na.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var Ma=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(m=>{let p=l.addOption(m.value,m.label??m.name??m.value);p.selected=m.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let m=l.addOption(_.value,_.label??_.name??_.value);m.selected=_.value===s,c.length===1&&m.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,m=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(m),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let w=document.createElement("div");w.className="array-item-row";let b=document.createElement("input");b.type="text",b.value=y,b.placeholder="Value";let k=document.createElement("button");k.textContent="\u2715",k.title="Remove",b.addEventListener("change",()=>{c[g]=b.value,f()}),k.addEventListener("click",()=>{c.splice(g,1),d(),f()}),w.appendChild(b),w.appendChild(k),l.appendChild(w)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=m.value.trim();y&&(c.push(y),m.value="",d(),f())}),_.appendChild(m),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,w],b)=>{let k=document.createElement("div");k.className="json-pair-row";let C=document.createElement("input");C.type="text",C.value=g,C.placeholder="Property";let O=document.createElement("input");O.type="text",O.value=w,O.placeholder="Value";let j=document.createElement("button");j.textContent="\u2715",j.title="Remove",C.addEventListener("change",()=>{let $=C.value.trim();$&&$!==g&&(c[$]=c[g],delete c[g],d(),y())}),O.addEventListener("change",()=>{c[C.value]=O.value,y()}),j.addEventListener("click",()=>{delete c[C.value],d(),y()}),k.appendChild(C),k.appendChild(O),k.appendChild(j),l.appendChild(k)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=m.value.trim();!g||g in c||(c[g]=p.value,m.value="",p.value="",d(),y())}),_.appendChild(m),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){ja(e)}safe_inner_html(e,t){Ta(e,t)}};var Ke=require("obsidian");var La=class extends Ma{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return Ke.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new Ke.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await Ke.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,Ke.getIcon)(e).outerHTML}is_mod_event(e){return Ke.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function za(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(za,"collection_instance_name_from");function Ly(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Ly,"create_uid");function Da(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Da(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Da(n[o],e[o],t))}return n===e}r(Da,"deep_equal");function Ra(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(Ra,"get_item_display_name");function Fa(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let v of Reflect.ownKeys(u)){let S=Object.getOwnPropertyDescriptor(u,v);if(!S)continue;let E={...S};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let v=!1;for(let S of h){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E){let q=E.value;if(c(q)){v=!0;continue}if(s(q)){if(_(q)){v=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),v=new Map;for(let S of Reflect.ownKeys(u)){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E&&_(E.value)){v.set(S,d(E.value));continue}try{Object.defineProperty(h,S,m(E))}catch{h[S]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),w=Object.create(null),b=r((u,h,v=[])=>{if(!u||!h)return;let S=new Set([...l,...v]);for(let E of Reflect.ownKeys(u)){if(S.has(E))continue;let q=Object.getOwnPropertyDescriptor(u,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),k=r(u=>{let h=new u(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let S=v.bind(h);return b(u,S),b(h,S),S.instance=h,S}return b(u,h),h},"instantiate_class"),C=r(u=>{if(o(u))return k(u);if(a(u)){let h=u.action.bind(n);return b(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return b(u,h),h}return s(u)?d(u):u},"bind_or_clone"),O=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),j=r((u,h,v)=>(u[h]=v,v),"cache_result"),$=r((u,h)=>{let v=O();return v&&g(v,h)?j(u,h,C(v[h])):g(f,h)?j(u,h,C(f[h])):j(u,h,void 0)},"compute_and_cache"),A=r(()=>{let u=O(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(u)for(let v of Reflect.ownKeys(u))h.add(v);return Array.from(h)},"union_keys"),x=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(w,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:$(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let v=O();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>A(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return x(u,h);let v=O();if(v&&g(v,h)||g(f,h))return g(u,h)||$(u,h),x(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,v)=>"value"in v?(u[h]=v.value,!0):!1,"defineProperty"),set:r((u,h,v)=>(u[h]=v,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(Fa,"create_actions_proxy");var ee=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Je(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Ly(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return Je(s,t),!Da(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Fa(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),za(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),za(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),pe(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Ra(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var b2=Object.getPrototypeOf(async function(){}).constructor,te=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof b2?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Je(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Fa(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var Ba=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},Ua=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function Wa(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=zy(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=zy(n.results);n.min=s,n.minResult=i}}r(Wa,"results_acc");function Ry(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=Dy(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=Dy(n.results);n.max=s,n.maxResult=i}}r(Ry,"furthest_acc");function zy(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(zy,"find_min");function Dy(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(Dy,"find_max");function Te(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Te,"sort_by_score");function Ga(n,e){return Te(n,e)}r(Ga,"sort_by_score_descending");function Fy(n,e){return Te(n,e)*-1}r(Fy,"sort_by_score_ascending");var Ha=class extends Ba{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:as(e,a.vec)};return Wa(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(Ga)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:as(e,a.vec)};return Ry(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(Fy)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},Ja=class extends Ua{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var v2="---frontmatter---",By=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),k2=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),w2=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),x2=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(v2),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),E2=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=By(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=By(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),Om=r((n,e={})=>{let t=k2(n,e),s=w2(t),i=x2(s);return E2(i,n)},"create_find_connections_filter_opts");async function tn(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=Om(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+Q(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Te).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(tn,"find_connections");tn.action_type="connections";var cs=class extends ee{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new Ja(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var ls=class extends te{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Ha(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let m=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!m[f.item.path]||f.score>m[f.item.path].score?m[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=m[f.item.path].score}),m},Promise.resolve({})),c=Object.values(a).sort(Te).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return Uy}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return A2}},Uy={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},A2={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function qm(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await tn.call(this,n);let o=Om(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+Q(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Te).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Te).slice(0,s)}return i}r(qm,"find_connections");qm.action_type="connections";var sn=class extends cs{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=Sm(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=Cm(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},Wy={class:sn,actions:{find_connections:qm}};var Ui=class extends ls{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let m=await _.search(e);return m?(this.search_results_ct++,{item:_,score:m}):null}catch(m){return console.error(`Error searching item ${_.id||"unknown"}:`,m),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Te)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(S2),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},S2={};var Ka=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Wi;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Wi=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Va=class extends Ka{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Gi;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Gi=class extends Wi{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var Gy={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},$t=class extends Va{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=bt;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},bt=class extends Gi{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return Gy[s]&&(s=Gy[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Hi=class extends $t{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=$m},$m=class extends bt{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var Xa=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return Q(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return Hy(this.constructor.name)}static get adapter_key(){return Hy(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function Hy(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(Hy,"to_snake");function Ya(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},m={},p=[],f={},y=null,g=null,w=!1,b=!1,k="#",C=!1,O=[],j=null;_[k]=0;for(let A=0;A<i.length;A++){let x=A+t,u=i[A],h=u.trim();if(h==="---"){if(!b&&x===1){b=!0,w=!0,l["#---frontmatter---"]=[x,null];continue}else if(w){w=!1,l["#---frontmatter---"][1]=x;continue}}if(w)continue;if(!C&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(u)&&f.incomplete.top.push(x)),h.startsWith("```")){if(C=!C,C&&!j?j=x:!C&&j&&(O.push([j,x]),j=null),!g){let E=c.length>0?c[c.length-1].key:k;if(E===k&&!l[k]&&(l[k]=[x,null]),E===k)g={key:k,start_line:x},(l[k][1]===null||l[k][1]<x)&&(l[k][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],T=`${E}#{${q}}`;l[T]=[x,null],g={key:T,start_line:x}}}continue}let v=h.match(/^(#{1,6})\s*(.+)$/);if(v&&!C){let E=v[1].length,q=v[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let Z=c.pop();l[Z.key][1]===null&&(l[Z.key][1]=x-1)}c.length===0&&l[k]&&l[k][1]===null&&(l[k][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let T="",N=0;if(c.length>0?(T=c[c.length-1].key,N=c[c.length-1].level):(T="",N=0),c.length===0)d[q]=(d[q]||0)+1,d[q]>1&&(q+=`[${d[q]}]`);else{m[T]||(m[T]={}),m[T][q]=(m[T][q]||0)+1;let Z=m[T][q];Z>1&&(q+=`#{${Z}}`)}let Y=E-N,H="#".repeat(Y),$e=T+H+q;l[$e]=[x,null],_[$e]=0,c.push({level:E,title:q,key:$e});continue}let S=u.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(S&&!C){if(S[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null),g&&g.key!==k&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let q=c.length>0?c[c.length-1].key:k;q===k&&!l[k]&&(l[k]=[x,null]),_[q]===void 0&&(_[q]=0),_[q]+=1;let T=_[q],N;if(s){let Y=S[3].replace(/^\[(?: |x|X)\]\s*/,""),H=C2(Y,o);N=`${q}#${H}`}else N=`${q}#{${T}}`;l[N]=[x,null],y={key:N,start_line:x};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let E=c.length>0?c[c.length-1].key:k;if(E===k)l[k]||(l[k]=[x,null]),(l[k][1]===null||l[k][1]<x)&&(l[k][1]=null),g={key:k,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],T=`${E}#{${q}}`;l[T]=[x,null],g={key:T,start_line:x}}}}let $=i.length;for(;c.length>0;){let A=c.pop();l[A.key][1]===null&&(l[A.key][1]=$+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=$+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=$+t-1),g=null),l[k]&&l[k][1]===null&&(l[k][1]=$+t-1);for(let A in l)a[A]=l[A];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:O}}r(Ya,"parse_markdown_blocks");function C2(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(C2,"get_longest_words_in_order");var Ve=class extends Xa{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=Ya(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let m=this.item.block_collection.get(_.key);s==="replace_blocks"?await m.update(_.content):await m.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],m=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:m,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:m,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let w=this.item.block_collection.get(m);if(await this.create_hash(p)!==w.last_read?.hash){o.push({key:m,state:"changed",content:p});continue}a.push({key:m,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function jt(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),m={title:c,target:l,line:d};_&&(m.embedded=!0),e.push(m)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,m=o(a.index),p={title:l,target:d,line:_};m&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(jt,"get_markdown_links");function Za({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=jt(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(Za,"get_bases_cache_links");function jm(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(jm,"parse_value");function O2(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=jm(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let m=_.trim().slice(2);l.push(jm(m)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=jm(c)}return t}r(O2,"parse_yaml_block");function Jy(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=O2(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(Jy,"parse_frontmatter");var Ky=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Ji=class extends Ve{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=jt(e),s=Za({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=Jy(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),Ky(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Tt=require("obsidian");function q2(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(q2,"merge_tags");var ds=class extends Ji{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=q2(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!Tt.MarkdownRenderer||!Tt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Tt.MarkdownRenderer.render(s,t,i,this.item.path,new Tt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(m=>setTimeout(m,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Tt.htmlToMarkdown)(i)}};var Qa=class extends Ve{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var ec=class extends Ve{static{r(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function $2({content:n}={}){if(!n)return null;try{return JSON.parse(n)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}r($2,"parse_canvas_json");function Vy({target:n,title:e}={}){return n?{title:e||n,target:n,line:1}:null}r(Vy,"build_link_record");function j2({node:n}={}){if(!n||typeof n!="object")return[];if(n.type==="text"&&typeof n.text=="string")return jt(n.text);if(n.type==="file"&&typeof n.file=="string"){let e=typeof n.subpath=="string"?n.subpath:"",t=`${n.file}${e}`,s=Vy({target:t,title:n.file});return s?[s]:[]}if(n.type==="link"&&typeof n.url=="string"){let e=Vy({target:n.url,title:n.url});return e?[e]:[]}return[]}r(j2,"get_canvas_node_links");function T2({nodes:n=[]}={}){return Array.isArray(n)?n.reduce((e,t)=>(e.push(...j2({node:t})),e),[]):[]}r(T2,"get_canvas_links_from_nodes");function N2({content:n}={}){let e=$2({content:n});return e?.nodes?T2({nodes:e.nodes}):[]}r(N2,"get_canvas_links");var tc=class extends Ve{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=N2({content:e});let t=this.item.file?.stat,s=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:s,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var sc=class extends ds{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function Xy(n,e){let[t,...s]=n.split("#").filter(Boolean),i=Ra(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(Xy,"get_block_display_name");var nn=class extends cs{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return Xy(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},Yy={class:nn,actions:{find_connections:tn}};var Ki=class extends ls{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var nc=class extends $t{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=Tm;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},Tm=class extends bt{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var ic=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return Q(e)}};function oc(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(oc,"get_line_range");var on=class extends ic{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return oc(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var rn=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Vi=class extends rn{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var an=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var _s=class extends an{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var Xe=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var cn=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},ln=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var dn=class extends cn{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new Nm(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},Nm=class extends ln{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var us=class extends cn{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new Pm(i)}},Pm=class extends ln{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var tb=P(eb(),1);var F2=Object.defineProperty,B2=r((n,e,t)=>e in n?F2(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),U2=r((n,e,t)=>(B2(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function W2(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(W2,"bytePairMerge");function G2(n,e){return n.length===1?[e.get(n.join(","))]:W2(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(G2,"bytePairEncode");function H2(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(H2,"escapeRegex");var Mm=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=tb.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=Mm.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Mm.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let m=d?.index??n.length;for(let f of n.substring(l,m).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...G2(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},ac=Mm;U2(ac,"specialTokenRegex",n=>new RegExp(n.map(e=>H2(e)).join("|"),"g"));async function nb(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await sb(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await sb(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(nb,"fetch_json_cached");async function sb(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(sb,"do_fetch");function zm(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(zm):e==="object"?Object.values(n).every(zm):!1}r(zm,"is_json_compatible");function cc(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||zm(i)&&(t[s]=i);return t}r(cc,"extract_json_details");function Xi(n){return Object.keys(n).length===0}r(Xi,"is_empty_object");function J2(n,e){return Xi(n)?e:Xi(e)?n:{...n,...e}}r(J2,"merge_details");function Lm(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(Lm,"get_message_from_object");function K(n,e=null){if(Array.isArray(n)&&n.length>0)return K(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=cc(n,["message"]);return{message:t,details:Xi(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=Lm(o),c=cc(o,["message"]),l=cc(t,["message","error"]),d=J2(l,c);return{message:a||Lm(t)||"Unknown error",details:Xi(d)?null:d,http_status:e}}return K(i)}let s=Lm(t);if(s){let i=cc(t,["message"]);return{message:s,details:Xi(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(K,"normalize_error");var K2="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",Ze=class extends _s{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Ne}get res_adapter(){return Pe}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Xe({adapter:us})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:K(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await nb(K2,"cl100k_base.json");this.tiktoken=new ac(e)}},Ne=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Pe=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var lc=class extends Ze{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Dm}get res_adapter(){return Rm}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Dm=class extends Ne{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Rm=class extends Pe{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var dc=class extends _s{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var _c=class extends dc{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var ib=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var ob={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:Fm};var Fm={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},rb={},Bm={};var _n=class extends _c{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=ob;constructor(e){super(e),this.connector=ib.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...rb}}get_models(){return Promise.resolve(this.models)}get models(){return Fm}};var uc=class extends Ze{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Um}get res_adapter(){return Wm}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of X2(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Um=class extends Ne{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},Wm=class extends Pe{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},V2=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),X2=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(V2)},"filter_embedding_models");var mc=class extends Ze{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Gm}get res_adapter(){return Hm}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},Gm=class extends Ne{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Hm=class extends Pe{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function Y2(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(Y2,"parse_lm_studio_models");var pc=class extends Ze{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Jm}get res_adapter(){return Km}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return Y2(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},Jm=class extends Ne{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Km=class extends Pe{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Yi=class extends rn{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw K(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var hc=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var fc=class extends an{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var un={},Nt={data:null,fetched_at:0},z=class extends fc{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return D}get res_adapter(){return I}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Xe({adapter:us})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Nt.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=K(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new hc(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=K({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=K(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=K(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Nt?.data&&t-Nt?.fetched_at<e)return Nt.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Nt.data=o,Nt.fetched_at=t,console.log({MODELS_DEV_CACHE:Nt}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Nt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return un[this.constructor.key]||(un[this.constructor.key]={}),un[this.constructor.key]}set model_data(e){un[this.constructor.key]||(un[this.constructor.key]={}),un[this.constructor.key]=e}},D=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},I=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:K(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Zi=class extends z{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Qi}res_adapter=eo;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Qi=class extends D{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},eo=class extends I{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:K(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var Z2=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],ps=class extends z{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Vm;parse_model_data(e){return e.data.filter(t=>!Z2.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:Q2(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function Q2(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(Q2,"get_max_input_tokens");var Vm=class extends I{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var to=class extends ps{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var mn=class extends z{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=so;res_adapter=no;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},so=class extends D{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},no=class extends I{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:K(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},io=class extends mn{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var oo=class extends z{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Xm}get res_adapter(){return Ym}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Xm=class extends D{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Ym=class extends I{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var ro=class extends z{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return ao}get res_adapter(){return co}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},ao=class extends D{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},co=class extends I{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var lo=class extends z{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=_o;res_adapter=uo;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},_o=class extends D{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},uo=class extends I{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:K(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Zm={openai:{req:D,res:I},anthropic:{req:Qi,res:eo},gemini:{req:so,res:no},lm_studio:{req:ao,res:co},ollama:{req:_o,res:uo}},mo=class extends z{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Zm[e];return t&&t.req?t.req:D}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Zm[e];return t&&t.res?t.res:I}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(Zm).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var po=class extends z{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Qm}get res_adapter(){return ep}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},Qm=class extends D{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},ep=class extends I{static{r(this,"SmartChatModelGroqResponseAdapter")}};var ho=class extends z{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return D}get res_adapter(){return I}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var fo=class extends z{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return tp}get res_adapter(){return sp}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},tp=class extends D{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},sp=class extends I{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var $p=require("obsidian");function ab(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=Ya(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),m=oc(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===m.length&&_.vec)continue;let p=jt(m),f=Za({source:n,links:p}),y={key:d,lines:l,size:m.length,outlinks:[...p,...f],last_read:{at:a,hash:Q(m)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new n.block_collection.item_type(n.env,y);n.block_collection.set(g)}else _.data={..._.data,...y}}eO(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(ab,"parse_blocks");function eO(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(eO,"clean_and_update_source_blocks");function np(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():cb(a)?n[o]=np(cb(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(np,"ajson_merge");function cb(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(cb,"is_object");var lb={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function tO(n){let e=!1,[t,...s]=n.split(":");return lb[t]&&(t=lb[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(tO,"_parse_ajson_key");var Pt=class extends $t{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:w}=tO(p),b=`${y}:${g}`;f?(i[b]=f,(w||b!==p)&&(delete i[p],t=!0)):(delete i[b],(w||b!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=np(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},ip=class extends bt{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},go={collection:Pt,item:ip};var yo=class extends ee{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function sO(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(sO,"parse_component_properties");async function nO(n,e){let{scope_key:t,component_key:s}=sO(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await Q(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(nO,"build_component_data");var gc=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await nO(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var yc=class extends gc{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function db(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&db(i,o,t)}}),t}r(db,"flatten_components_config");var bc=class extends te{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=db(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},_b={class:bc,item_type:yo,data_adapter:go,component_adapters:{SmartViewComponentAdapter:yc}};var ub=_b;function mb(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(mb,"filter_redundant_context_items");var pb=r((n,e)=>!e||!n?.[e]?!1:n[e].folder?n[e].exclude?!1:(n[e].exclude=!0,!0):(delete n[e],!0),"remove_context_item_data"),bo=class extends ee{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:s=!0}=t;pb(this.data.context_items,e)&&(this.queue_save(),s&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:s=!0}=t,i=Array.isArray(e)?e:[e],o=[];return i.forEach(a=>{pb(this.data.context_items,a)&&o.push(a)}),o.length?(this.queue_save(),s&&this.emit_event("context:updated",{removed_keys:o}),o):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return mb(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var vc=class extends te{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var iO={class:vc,data_adapter:Pt,item_type:bo};var hb=iO;var kc=class extends ee{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var Qe=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var wc=class extends Qe{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var xc=class extends Qe{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var fb=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var Ec=class extends Qe{static{r(this,"ImageContextItemAdapter")}static detect(e){return fb.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var Ac=class extends Qe{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var op=class extends te{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},gb={version:1,class:op,collection_key:"context_items",item_type:kc,context_item_adapters:{BlockContextItemAdapter:wc,SourceContextItemAdapter:xc,ImageContextItemAdapter:Ec,PdfContextItemAdapter:Ac}};function yb(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(yb,"next_log_stats");var pn=class extends ee{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var oO={"collection:save_started":!0,"collection:save_completed":!0},rp=class extends te{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return pn}init(){this.env?.events||rs.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!oO[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new pn(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=yb({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},bb={class:rp,collection_key:"event_logs",data_adapter:Pt,item_type:pn};var fn=require("obsidian");function vb(n,e={}){if(!n)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],s=n?.env?.config?.actions||{},i=n?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(s[c]||{}).display_name||c;return a.push({select_action:r(()=>{n.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}r(vb,"build_suggest_scope_items");var kb=r((n,e={})=>{let t=n?.inputEl,s=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(s===t&&i)},"should_handle_arrow_left");var hn=class extends fn.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,o=kb(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&o){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return vb(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,fn.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=fn.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var EG=require("obsidian");var Sc=class extends hn{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var wb=require("obsidian");var Cc=class extends wb.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var qc=require("obsidian");var rO="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",Oc=class extends qc.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){aO(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function aO(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),cO(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(rO,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r(aO,"render_milestones_modal_title");function cO(n){lO(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(cO,"render_help_icon");function lO(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,qc.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(lO,"set_icon_with_fallback");var xb={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var vo=class extends ee{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],m=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),m},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var $c=class extends te{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function Eb(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(Eb,"settings_config");var hs=class extends vo{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var ap=class extends $c{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var dO={class:ap,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:go,item_type:hs,providers:{},settings_config:Eb},cp=dO;var lp=class extends _n{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},Ab={class:lp,settings_config:Bm};cp.providers={transformers:Ab};var Sb=cp;var It=class extends ee{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(Wa(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(Ga);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var Cb={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},dp=class extends te{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=_O(new Date),i=Q(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new It(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...Cb}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function _O(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(_O,"format_ymd");var Ob={class:dp,collection_key:"lookup_lists",item_type:It,settings_config:Cb};function ko(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(ko,"format_collection_name");async function uO(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${ko(n.collection_key)}</h2>
${t}
</div></div></div>`}r(uO,"build_html");async function qb(n,e={}){let t=await uO.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(qb,"render");var gn=require("obsidian");function $b(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(gn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new gn.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let m=d.hoverEl.querySelector(".markdown-preview-sizer");gn.MarkdownRenderer.render(o,l,m,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r($b,"register_block_hover_popover");var jb=require("obsidian");function Tb(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),jb.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):$b(n.parentElement,n,e.env,e.key)}r(Tb,"register_item_hover_popover");var Pb=require("obsidian");function mO(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(mO,"format_score");function pO(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(pO,"format_size");function Nb(n,e){return n?`<span class="${e}">${n}</span>`:""}r(Nb,"build_badge_html");function hO(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=mO(n?.data?.score),i=pO(n?.size||n?.data?.size),o=Nb(s,"sc-context-item-score"),a=Nb(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(hO,"build_html");async function Ib(n,e={}){let t=hO(n,e),i=this.create_doc_fragment(t).firstElementChild;return fO.call(this,n,i,e),i}r(Ib,"render");async function fO(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${Pb.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),Tb(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(fO,"post_process");async function gO(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${ko(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=bO(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(gO,"build_html");async function Mb(n,e={}){let t=await gO.call(this,n,e),s=this.create_doc_fragment(t);return await yO.call(this,n,s,e)}r(Mb,"render");async function yO(n,e,t={}){return e}r(yO,"post_process");function bO(n,e){let t=Object.values(n.items).length,s=ko(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=vO(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=kO(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(bO,"generate_collection_stats");function vO(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(vO,"get_generic_collection_stats");function kO(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(kO,"calculate_embed_coverage");var Lb=require("obsidian");function wO(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(wO,"build_html");async function _p(n,e={}){let t=wO.call(this,n,e),s=this.create_doc_fragment(t);return await xO.call(this,n,s,e)}r(_p,"render");async function xO(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new Lb.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=be(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(m=>{_.addOption(m.value,m.label)}),l.childNodes.forEach(m=>{m.value===c&&(m.selected=!0),o.find(p=>p.value===m.value)?.disabled&&(m.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):ve(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(xO,"post_process");_p.version=.2;var zb=require("obsidian");function EO(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(EO,"build_html");function Db(n,e={}){let t=EO.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,zb.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),AO.call(this,n,i,e),i}r(Db,"render");function AO(n,e){}r(AO,"post_process");var Rb=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var Gb=require("obsidian");var Fb=require("obsidian");var CO={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},yn={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},OO=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function up(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=OO.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(up,"derive_events_checklist_groups");function wo(n,e){let t=qO(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(wo,"check_if_event_emitted");function qO(n,e){let t=CO[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!$O(a)))return!0}return!1}r(qO,"resolve_plugin_install_event");function $O(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r($O,"is_pro_manifest");function Bb(n){n.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in yn){let s=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",o=document.createElement("p");o.textContent=i,s.appendChild(o);let a=document.createElement("p");a.textContent=`\u2705 ${yn[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",s.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{n.open_milestones_modal()}),s.appendChild(c),new Fb.Notice(s,7e3)}})}r(Bb,"register_first_of_event_notifications");function jO(n,e={}){let t=up(yn),s=t.reduce((c,l)=>{let d=l.items.reduce((_,m)=>_+(wo(n,m.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((m,p)=>m+(wo(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(m=>{let p=wo(n,m.event_key)===!0;return NO(m,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${je(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${je(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${je(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(jO,"build_html");async function Hb(n,e={}){this.apply_style_sheet(Rb);let t=jO.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return TO.call(this,n,i,e),i}r(Hb,"render");async function TO(n,e,t={}){return PO(e),IO(e),e}r(TO,"post_process");function NO(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${je(n.event_key)}"
data-link="${je(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${je(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${je(n.milestone)}</span>
</div>
</li>
`}r(NO,"build_item_html");function PO(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=Wb(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||Ub(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=Wb(n,e);s&&(e.preventDefault(),Ub(s))}))}r(PO,"attach_item_link_listeners");function Ub(n){let e=zO(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(Ub,"open_item_link");function IO(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&MO(i,s)})}r(IO,"render_item_state_icons");function MO(n,e){LO(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(MO,"set_item_icon");function LO(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,Gb.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(LO,"set_icon_with_fallback");function Wb(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(Wb,"get_item_el_from_event");function zO(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=yn[t];return!s||typeof s.link!="string"?"":s.link}r(zO,"get_item_link");function DO(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}r(DO,"build_html");var mp=100,pp=100;function RO(n,e={}){let{limit:t=mp}=e;return n.slice(-t).reverse()}r(RO,"get_visible_entries");function FO(n,e={}){let{page_size:t=mp}=e;return Math.min(n,t)}r(FO,"get_visible_count");function BO(n,e={}){let{current_count:t=0,step_size:s=pp}=e;return Math.min(n,t+s)}r(BO,"get_next_visible_count");function UO(n,e){return n>e}r(UO,"should_show_load_more");async function Jb(n,e={}){let t=this.create_doc_fragment(DO()),s=t.firstElementChild;return WO.call(this,n,s,e),t}r(Jb,"render");async function WO(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),o=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(s);let c=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!c.length){let _=s.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",s.appendChild(_),o&&(o.style.display="none");return}let l=FO(c.length,{page_size:mp}),d=r(()=>{a.empty(s),RO(c,{limit:l}).forEach(_=>{JO(s,_)}),GO(o,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=s.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),o&&o.addEventListener("click",()=>{l=BO(c.length,{current_count:l,step_size:pp}),d()})}r(WO,"post_process");function GO(n,e={}){if(!n)return;let{entries_length:t=0,visible_count:s=0}=e,i=UO(t,s);if(n.style.display=i?"inline-block":"none",i){let o=t-s,a=Math.min(pp,o);n.textContent=`Load ${a} more`}}r(GO,"update_load_more_button");function HO(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(HO,"get_level");function JO(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=HO(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${KO(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(JO,"append_entry");function KO(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(KO,"to_time_ago");var Ie=require("obsidian");var bn=require("obsidian");function vn(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(vn,"get_smart_server_url");function VO(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(VO,"try_get_zlib");function XO(n){let e=VO();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(XO,"inflate_deflate_data");async function Kb(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let w=new Uint8Array(n.slice(t,t+y)),b=new TextDecoder("utf-8").decode(w);t+=y,t+=g;let k=(l&8)!==0,C=t,O;if(!k)O=C+p;else{let A=C,x=!1;for(;A+4<=s;){let u=e.getUint32(A,!0);if(u===134695760||u===67324752||u===33639248){x=!0;break}A++}O=x?A:s}if(O>s)break;let j=new Uint8Array(n.slice(C,O));if(t=O,k&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let $;if(d===0)$=j;else if(d===8)$=XO(j);else continue;if(i.push({fileName:b,data:$}),b.toLowerCase().endsWith("manifest.json")&&!b.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode($))}catch{}}return{files:i,pluginManifest:o}}r(Kb,"parse_zip_into_files");function Vb(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(Vb,"validate_zip_buffer");async function Xb(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(Xb,"write_files_with_adapter");function Yb(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(Yb,"is_server_version_newer");async function Zb(n,e){let t=await(0,bn.requestUrl)({url:`${vn()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return Vb(t.arrayBuffer,"Smart Plugins server")}r(Zb,"fetch_plugin_zip");async function Qb(n,e=bn.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return Vb(t.arrayBuffer,"Download")}r(Qb,"fetch_zip_from_url");async function ev(n,e,t=bn.requestUrl){let s=await t({url:`${vn()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(ev,"fetch_plugin_readme");async function tv(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(tv,"enable_plugin");function sv(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(sv,"get_oauth_storage_prefix");async function nv(n){let e=await(0,bn.requestUrl)({url:`${vn()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(nv,"fetch_server_plugin_list");async function iv(n={}){let e=String(n.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,bn.requestUrl)({url:`${vn()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}r(iv,"fetch_referral_stats");var ov=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var ZO='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',QO='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function eq(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(eq,"derive_fallback_plugins");function tq(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${ZO}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${QO}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}r(tq,"build_html");async function av(n,e={}){this.apply_style_sheet(ov);let t=tq.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await sq.call(this,n,i,e),i}r(av,"render");async function sq(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=sv(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=eq(),_=0,m="",p=null,f=r(A=>{if(A){if(typeof this.empty=="function"){this.empty(A);return}A.innerHTML=""}},"empty_container"),y=r(A=>{if(!a||!A)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let u=document.createElement("div");u.classList.add("smart-plugins-login-manual-controls"),p.appendChild(u);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=A,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),u.appendChild(h);let v=document.createElement("button");v.classList.add("mod-cta"),v.textContent="Copy",v.addEventListener("click",async()=>{await rv(A)?new Ie.Notice("Copied login link to clipboard."):new Ie.Notice("Copy failed. Please select and copy the link manually.")}),u.appendChild(v)},"render_manual_login_link"),g=r(async()=>{let A={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(u=>setTimeout(u,100));for(let u in x){if(!Object.prototype.hasOwnProperty.call(x,u))continue;let{name:h,version:v}=x[u];A[u]={name:h,version:v}}return A},"get_installed_info"),w=r(async()=>{_++,_>=2&&m&&y(m),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(m=nq()),new Ie.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),b=r(()=>{if(this.empty(a),p=null,!(localStorage.getItem(o+"token")||"")){new Ie.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await w()})});return}let x=new Ie.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(u=>{u.setButtonText("Logout"),u.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new Ie.Notice("Logged out of Smart Plugins"),b(),k(),j()})})},"render_oauth_login_section"),k=r(async(A={})=>{f(c);let x=String(A.token||"").trim();if(!x)return;let u=Number(A.sub_exp??0)||0;if(!(u&&u<Date.now()))try{let h=await iv({token:x}),v=String(h?.referral_link||"").trim();if(!v)return;let S=new Ie.Setting(c).setName("Referral link").setDesc("Share your link to give $30 off Pro and earn 30 days of Pro credit.");S.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let q=await rv(v);new Ie.Notice(q?"Referral link copied.":"Copy failed. Please try again.")})}),S.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),C=r(async()=>{if(this.empty(l),!(!l||d.length===0))for(let A of d){let x=await n.smart_components.render_component("pro_plugins_list_item",A,{env:n,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),O=r(()=>{let A=new Ie.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");A.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),A.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),A.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),j=r(async()=>{this.empty(l);let A=localStorage.getItem(o+"token")||"";if(!A){await C(),await k();return}try{let x=await g(),u=await nv(A),{list:h=[],unauthorized:v=[],sub_exp:S}=u;if(typeof S=="number"&&S<Date.now()){O(),await C(),await k();return}if(await k({token:A,sub_exp:S}),!Array.isArray(h)||h.length===0){await C();return}for(let E of h){let q=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,token:A,installed_map:x,on_installed:j});l.appendChild(q)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),$=r(async()=>{b(),await j()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{$()}),await $(),e}r(sq,"post_process");function nq(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${vn()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(nq,"initiate_smart_plugins_oauth");var rv=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var le=require("obsidian");var iq="https://smartconnections.app/pro-plugins/";function oq(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(oq,"build_html");function rq(n){return!n||!n.repo}r(rq,"is_fallback_item");function aq(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,Yb(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(aq,"compute_display_state");async function cv(n,e={}){let t=oq(n,e),i=this.create_doc_fragment(t).firstElementChild;return await cq.call(this,n,i,e),i}r(cv,"render");async function cq(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(rq(n)){let m=new le.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",m.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),m.controlEl.appendChild(p)}return m.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(iq,"_external")})}),m.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=aq(n,l),_=new le.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(m=>{m.setButtonText(d.button_label),m.setDisabled(d.is_disabled),m.onClick(()=>dq(n,{app:s,token:i,on_installed:a}))}),_.addButton(m=>{m.setButtonText("Docs"),n.docs_url?m.onClick(()=>window.open(n.docs_url,"_external")):m.onClick(()=>_q(n,{app:s,token:i,display_name:d.display_name}))}),e}r(cq,"post_process");var lq=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return Qb(t);if(!e)throw new Error("Login required to install this plugin.");return Zb(n.repo,e)},"download_plugin_zip"),dq=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new le.Notice(`Installing "${n.repo}" ...`);let o=await lq(n,s),{files:a,pluginManifest:c}=await Kb(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await Xb(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await tv(t,_),new le.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new le.Notice(`Install failed: ${o.message}`)}},"install_plugin"),_q=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await ev(n.repo,s),a=new le.Modal(t);a.setTitle(i||n.name||n.repo),await le.MarkdownRenderer.render(t,o,a.contentEl,"",new le.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new le.Notice("Failed to load README")}},"show_plugin_readme");var lv=require("obsidian");var fs=class extends lv.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var dv=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var _v=require("obsidian");function mq(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${mv(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(mq,"build_html");async function uv(n,e){this.apply_style_sheet(dv);let s=this.create_doc_fragment(mq.call(this,n,e)).firstElementChild;return pq.call(this,n,s,e),s}r(uv,"render");async function pq(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,_v.setIcon)(o,mv(n)),s.addEventListener("click",()=>{new fs(n).open()}),i.addEventListener("click",()=>{new fs(n,{test_on_open:!0}).open()}),e}r(pq,"post_process");function mv(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(mv,"get_test_result_icon_name");var hv=require("obsidian");var pv={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function jc(n,e,t={}){let s=(pv[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new hv.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new fs(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(jc,"show_new_model_menu");var wn=require("obsidian");function hq(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(hq,"ensure_settings_config");function hp(n,e,t){let s=hq(n,e);return Object.entries(s||{}).reduce((i,[o,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][o]=a,i},{[t]:{}})}r(hp,"build_settings_group_map");function fp(n,e,t,s){return hp(n,e,s)[t]||{}}r(fp,"resolve_group_settings_config");var Tc=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new wn.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function gs(n,e,t,s={}){let{default_group_name:i="Settings"}=s,o=n,a=hp(n,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),m={...s,...s.group_params?.[l]||{},settings_config_source:o};return gp(l,e,d,_,m)})}r(gs,"render_settings_config");function gp(n,e,t,s,i={}){let o=i.settings_config_source||t,a=i.settings_config_source?fp(o,e,n,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=Tc}catch{c=Tc}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,y,g,w)=>{let b=fp(y,f,p,w.default_group_name||"Settings");return gp(p,f,b,g,w)}:gp,_=fq(e,{container:s,group_name:n,settings_config:o,group_params:i,render_group:d}),m=new c(s);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)fv(m,e,p);else fv(m,e,l);m.setHeading(n);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let y=f.scope_class==="pro-setting",g=!!e.env?.is_pro;m.addSetting(w=>{switch(f.name&&w.setName(f.name),w.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&w.setClass(`setting-type-${f.type}`),f.description&&w.setDesc(f.description),f.type){case"button":w.addButton(b=>{b.setButtonText(f.name||"Run"),b.onClick(async k=>{typeof f.callback=="function"&&await kn(w,k,f.callback,{scope:e})})});break;case"toggle":w.addToggle(b=>{b.setValue(be(e.settings,p)||!1),b.onChange(k=>{ve(e.settings,p,k),typeof f.callback=="function"&&kn(w,k,f.callback,{scope:e})})});break;case"text":w.addText(b=>{b.setValue(String(be(e.settings,p)||"")),b.onChange(k=>{ve(e.settings,p,k)})});break;case"number":w.addText(b=>{b.setValue(String(be(e.settings,p)??"0")),b.inputEl.setAttribute("type","number"),b.onChange(k=>{let C=Number(k);isNaN(C)||ve(e.settings,p,C),typeof f.callback=="function"&&kn(w,C,f.callback,{scope:e})})});break;case"dropdown":w.addDropdown(b=>{let k=f.options_callback;typeof k=="function"&&k.call(e,e).forEach(O=>{let j=O.label||O.name||O.value;b.addOption(O.value,j)}),b.setValue(be(e.settings,p)||""),b.onChange(C=>{ve(e.settings,p,C),typeof f.callback=="function"&&kn(w,C,f.callback,{scope:e}),_()})});break;case"textarea":w.addTextArea(b=>{b.setValue(String(be(e.settings,p)||"")),b.onChange(k=>{if(y&&!g){new wn.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}ve(e.settings,p,k)}),y&&!g&&b.setDisabled(!0)});break;case"slider":w.addSlider(b=>{let k=f.min||0,C=f.max||100,O=f.step||1;b.setLimits(k,C,O),b.setValue(be(e.settings,p)||k),b.setDynamicTooltip(),b.onChange(j=>{ve(e.settings,p,j),typeof f.callback=="function"&&kn(w,j,f.callback,{scope:e})})});break;case"heading":w.setHeading();break;case"html":f.value&&w.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&w.settingEl.addClass(f.scope_class)})}return m}r(gp,"render_settings_group");function fv(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,wn.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await kn(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(fv,"render_heading_button");async function kn(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(kn,"handle_config_callback");function fq(n,e={}){let{container:t,group_name:s,settings_config:i,group_params:o={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(s,n,i,t,o))}r(fq,"create_settings_group_rerender");function gq(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(gq,"build_html");async function gv(n,e){let s=this.create_doc_fragment(gq.call(this,n,e)).firstElementChild;return yq.call(this,n,s,e),s}r(gv,"render");async function yq(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=gs(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{jc(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(yq,"post_process");function bq(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(bq,"build_html");async function yv(n,e){let s=this.create_doc_fragment(bq(n,e)).firstElementChild;return vq.call(this,n,s,e),s}r(yv,"render");async function vq(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(vq,"post_process");var kv=require("obsidian");function Nc(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(Nc,"ensure_smart_sources_settings");function xo(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(xo,"parse_exclusions_csv");function bv(n,e){let t=(e??"").trim();if(!t)return n||"";let s=xo(n);return s.includes(t)||s.push(t),s.join(",")}r(bv,"add_exclusion");function vv(n,e){let t=(e??"").trim();return t?xo(n).filter(i=>i!==t).join(","):n?.trim()||""}r(vv,"remove_exclusion");var Pc=class extends kv.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Nc(this.env),t=xo(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Nc(this.env);t.folder_exclusions=bv(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Nc(this.env),t=xo(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=vv(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var wv=require("obsidian");var Ic=class extends wv.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function kq(n,e={}){return`
<div class="sources-settings">
</div>
`}r(kq,"build_html");async function xv(n,e={}){let t=await kq.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return wq.call(this,n,i,e),i}r(xv,"render");async function wq(n,e,t={}){gs({folder_exclusions:Eq,view_exclusions:Aq,re_import_sources:Sq},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",xq(n,e))),this.attach_disposer(e,i),e}r(wq,"post_process");function xq(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(xq,"highlight_reset_data");var Eq={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new Pc(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},Aq={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new Ic(t.main.app,t).open()},"callback")},Sq={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let m=Date.now();t.events?.emit("sources:reimported",{time_ms:m-_}),t.main.notices?.show("reload_sources",{time_ms:m-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};function Cq(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(Cq,"build_html");async function Ev(n,e={}){let s=this.create_doc_fragment(Cq(n,e)).firstElementChild;return Oq.call(this,n,s,e),s}r(Ev,"render");async function Oq(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),jc(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(Oq,"post_process");async function qq(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(qq,"build_html");async function Av(n,e={}){let t=await qq.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return $q.call(this,n,i,e),i}r(Av,"render");async function $q(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r($q,"post_process");var Sv=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function Tq(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(Tq,"build_html");async function Cv(n,e={}){this.apply_style_sheet(Sv);let t=await Tq.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return Nq.call(this,n,i,e),i}r(Cv,"render");async function Nq(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return yp.call(this,"settings_env_sources",n,i),yp.call(this,"settings_env_models",n,s),yp.call(this,"settings_notifications",n,o),e}r(Nq,"post_process");function yp(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(yp,"render_if_available");var Ov=require("obsidian");function Pq(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(Pq,"build_html");async function qv(n,e={}){let t=Pq(),i=this.create_doc_fragment(t).firstElementChild;return Iq.call(this,n,i,e),i}r(qv,"render");async function Iq(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),bp(n,a),vp(n,a),kp(n,a),wp(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Iq,"post_process");function bp(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(bp,"render_btn_open_selector");function vp(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(vp,"render_btn_copy_context");function kp(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(kp,"render_btn_clear_context");function wp(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,Ov.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(wp,"render_btn_help");var $v=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var Eo=require("obsidian");async function xn(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(Eo.Platform.isMobile)new Eo.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new Eo.Notice("Failed to copy.")}}r(xn,"copy_to_clipboard");var Lq=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),zq=r(n=>{let e=!1;return()=>{e||(e=!0,Lq(async()=>{e=!1,await n()}))}},"create_render_scheduler");function Dq(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(Dq,"build_html");async function jv(n,e={}){let t=Dq(n,e);this.apply_style_sheet($v);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return Rq.call(this,n,i,e),i}r(jv,"render");async function Rq(n,e,t={}){let s=[],i=r(async()=>{let d=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(p=>{this.empty(_),_.appendChild(p)});let m=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(p=>{this.empty(m),m.appendChild(p)})},"render_children"),o=zq(i),a=n.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,m)=>d.addEventListener(_,m)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(m=>m.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=Fq(e);await xn(p)})),_.showAtMouseEvent(d)}),await i(),s.push(n.on_event("context:updated",o)),this.attach_disposer(e,s),e}r(Rq,"post_process");function Fq(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(Fq,"tree_dom_to_wikilinks");function Bq(n){return Math.ceil((n||0)/4)}r(Bq,"estimate_tokens");function Uq(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(Uq,"build_html");async function Tv(n,e={}){let t=Uq(),i=this.create_doc_fragment(t).firstElementChild;return Wq.call(this,n,i,e),i}r(Tv,"render");async function Wq(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=Bq(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Wq,"post_process");function Nv(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-context-item-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let m=["sc-tree-label"];return n.exists===!1&&m.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${l}
<span class="${m.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(Nv,"build_tree_item");function Pv(n){let e=Gq(n),t=new Set(n.map(i=>i.key||i.path));return Iv(e,t)}r(Pv,"build_tree_html");function Gq(n=[]){let e=r(a=>a?.key||a?.path||"","get_item_key"),t=r(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,m=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),m=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),m=!0);let y=[];if(l){let g="",w=!1;for(let b=0;b<l.length;b++)!w&&l.slice(b,b+2)==="[["?(w=!0,g+="[[",b++):w&&l.slice(b,b+2)==="]]"?(w=!1,g+="]]",b++):!w&&l[b]==="/"?(y.push(g),g=""):g+=l[b];g&&y.push(g)}return _&&y.push(_),d&&y.push(d),{segments:y,has_block:m}},"split_path_segments"),s={name:"",children:{},selected:!1},i=r((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),o=n.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of n){let c=e(a),l=a?.exists;if(!c||i(c,o.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),m=s,p="";d.forEach((f,y)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=y===d.length-1,w=g&&_;m.children[f]||(m.children[f]={name:f,path:w?c:p,children:w?[]:{},selected:!1,is_file:w||g&&f.includes(".")}),m=m.children[f],g&&(m.selected=!0,m.exists=l)})}return s}r(Gq,"build_path_tree");function Iv(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>Nv(s,e,Iv(s,e))).join("")}</ul>`}r(Iv,"tree_to_html");var Mv=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var Jq=r((n,e)=>!n||!e?!1:n===e||n.startsWith(`${e}/`)?!0:n.startsWith(`${e}#`),"is_nested_context_item");function Lv(n,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(n?.data?.context_items||{}).filter(o=>Jq(o,t));return[...new Set(i)]}r(Lv,"get_nested_context_item_keys");var Kq=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),Vq=r(n=>{let e=!1;return()=>{e||(e=!0,Kq(()=>{e=!1,n()}))}},"create_render_scheduler"),Xq=r((n,e={})=>{let{target_path:t}=e,s=Lv(n,{target_path:t});n.remove_items(s)},"remove_nested_context_items");function Yq(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(Yq,"build_html");async function zv(n,e={}){this.apply_style_sheet(Mv);let t=Yq(n,e),i=this.create_doc_fragment(t).firstElementChild;return Zq.call(this,n,i,e),i}r(zv,"render");async function Zq(n,e,t={}){let s=n?.env?.plugin,i=s?.registerDomEvent?.bind(s)||((l,d,_)=>l.addEventListener(d,_)),o=r(()=>{let l=n.env,d=n.context_items.filter(t.filter),_=Pv(d),m=this.create_doc_fragment(_);this.empty(e),e.appendChild(m);for(let p=0;p<d.length;p++){let f=d[p],y=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!y){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(y),y.appendChild(g)})}},"render_tree_leaves"),a=Vq(o);o(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");Xq(n,{target_path:_})});let c=[];return c.push(n.on_event("context:updated",a)),this.attach_disposer(e,c),e}r(Zq,"post_process");var Dv=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function e$(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(e$,"build_html");async function Rv(n,e={}){let t=e$(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(Dv),await t$.call(this,n,s,e),s}r(Rv,"render");async function t$(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let m=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of m){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',w=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',b="",k="";try{let O=await p.read();b=O.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),k=(await p.get_embed_input(O)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(O){console.error("[source_inspector] Error reading block:",O),b='<em style="color:red;">Error reading block content</em>'}let C=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${w}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${k}</pre>
</details>
<blockquote>${b}</blockquote>
<hr>
`);s.appendChild(C)}return e}r(t$,"post_process");var Gv=require("obsidian");var En=require("obsidian");var Fv=require("obsidian");var Mc=class extends Fv.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var Bv=require("obsidian");var Lc=class extends Bv.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function Uv(n,e,t={}){let{Menu:s=En.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new En.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new En.Notice("Active note is not indexed by Smart Environment");return}new Mc(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Lc(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new En.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(Uv,"register_status_bar_context_menu");var Wv=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function n$(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(n$,"build_html");async function Hv(n,e={}){this.apply_style_sheet(Wv);let s=this.create_doc_fragment(n$()).firstElementChild;return i$.call(this,n,s,e),s}r(Hv,"render");function i$(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",w=c(),b=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",b="attention"),s&&(0,Gv.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=k=>{k.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),w>0?i.dataset.count=String(w):delete i.dataset.count,b?i.dataset.level=String(b):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=k=>{if(l()>0)k.preventDefault(),k.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let O=new MouseEvent("contextmenu",k);e.dispatchEvent?.(O)}},e.addEventListener("click",e._click_handler))},"render_status_elm");Uv(n,e),d();let _=null,m=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",m)),this.attach_disposer(e,p)}r(i$,"post_process");var Jv=require("obsidian");function o$(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(o$,"build_html");function Kv(n,e={}){let t=o$.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return r$.call(this,n,i,e),i}r(Kv,"render");async function r$(n,e){let t=e.querySelector(".callout-icon"),s=(0,Jv.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(r$,"post_process");var Vv=require("obsidian");function a$(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(a$,"build_html");function Xv(n,e={}){let t=a$.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,Vv.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),c$.call(this,n,i,e),i}r(Xv,"render");function c$(n,e){}r(c$,"post_process");var xp=require("obsidian");async function Yv(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new xp.Notice("No context items to copy.");let t=await this.get_text(n);await xn(t);let s=l$({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new xp.Notice(s)}r(Yv,"copy_to_clipboard");function l$(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${d$(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=_$(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(l$,"format_stats_message");function d$(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(d$,"format_char_count");function _$(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(_$,"sum_exclusions");var u$="xml_structured",Dc={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},Zv=r((n={})=>{let e=n.template_preset||u$;return Dc[e]?e:"custom"},"get_preset_key"),zc=r((n,e,t,s)=>{let i=Zv(n),o=Dc[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function Rc(){return Object.entries(Dc).map(([n,e])=>({value:n,label:e.label||n}))}r(Rc,"get_template_preset_options");function Qv(n={},e={}){return{template_before:zc(n,e,"context_template_before","template_before"),template_after:zc(n,e,"context_template_after","template_after")}}r(Qv,"get_context_templates");function ek(n={},e={}){let t=Zv(n),s=Dc[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:zc(n,e,"item_template_before","template_before"),template_after:zc(n,e,"item_template_after","template_after")}}r(ek,"get_item_templates");var m$=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),p$=r(n=>m$(n.key),"get_item_name");async function tk(n,e={}){let t={KEY:this.key,ITEM_NAME:p$(this),TIME_AGO:Em(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(m,p)=>t[p]||"");return c},"replace_vars"),i=ek(this.settings,Ep);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(tk,"merge_template");var sk={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>Rc(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},Ep={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function An(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=h$(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Fc(e),nk(e).trimEnd()}r(An,"build_file_tree_string");function h$(n){return typeof n=="string"&&n.endsWith("/")}r(h$,"is_folder_path");function Fc(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Fc(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Fc(n[i])}else Fc(t)}}}r(Fc,"compress_single_child_dirs");function nk(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=nk(o,e+(c?"    ":"\u2502   ")))}),t}r(nk,"build_tree_string");async function ik(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>An(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(m,p)=>s[p]?.()||"");return l},"replace_vars"),o=Qv(this.settings,Ap),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(ik,"merge_template");var ok={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>Rc(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},Ap={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function Ao(n={}){n?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:f$(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:r(({modal:s})=>{s.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}r(Ao,"context_suggest_blocks");function f$(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(f$,"get_block_display_name");var rk="Add blocks";var ck=require("obsidian");var g$=ck.Platform.isMacOS?"\u2318":"Ctrl";function y$(n){return typeof n!="string"?"":n.replace(/\/+$/g,"")}r(y$,"normalize_folder_path");function b$(n,e){let t=y$(e);return!t||n===t?!0:n.startsWith(`${t}/`)}r(b$,"is_source_in_folder");function ak(n){n?.inputEl&&(n.last_input_value=n.inputEl.value,n.inputEl.value="")}r(ak,"reset_modal_input");function v$(n,e){return Object.values(n.env?.smart_sources?.items||{}).filter(s=>b$(s.key,e))}r(v$,"get_sources_list");function k$(n,e){return e.map(t=>({key:t.key,display:t.key,select_action:r(()=>{n.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s}={})=>(ak(s),Ao.call(n,{source_key:t.key,modal:s})),"mod_select_action"),arrow_right_action:r(({modal:s}={})=>(ak(s),Ao.call(n,{source_key:t.key,modal:s})),"arrow_right_action")}))}r(k$,"build_source_suggestions");function lk(n={}){console.log("context_suggest_sources",n);let e=n?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${g$} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=v$(this,n?.folder_path||"");return k$(this,t)}r(lk,"context_suggest_sources");var dk="Add sources";async function Bc(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(Bc,"pre_process");function Sp(n){return this.vec?n.to_item?.vec?{score:as(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(Sp,"similarity");Sp.action_type="score";var Cp="Cosine Similarity",Op="Ranks by cosine similarity between the current note and candidates.",_k={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${Cp} algorithm`,value:`${Op}`}};var qp=require("obsidian");async function uk(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=qp.Keymap.isModEvent(e),l=qp.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(uk,"open_source");async function mk(n=null){await uk(this,n)}r(mk,"source_open");var pk={collections:{embedding_models:Sb,lookup_lists:Ob},item_types:{EmbeddingModel:hs,LookupList:It},items:{embedding_model:{class:hs},lookup_list:{class:It}},modules:{},components:{collection_settings:{render:qb},context_item_leaf:{render:Ib},env_stats:{render:Mb},form_dropdown:{render:_p},lean_coffee_callout:{render:Db},milestones:{render:Hb},notifications_feed:{render:Jb},pro_plugins_list:{render:av},pro_plugins_list_item:{render:cv},settings_env_model:{render:uv},settings_env_model_type:{render:gv},settings_env_models:{render:yv},settings_env_sources:{render:xv},settings_model_actions:{render:Ev},settings_notifications:{render:Av},settings_smart_env:{render:Cv},smart_context_actions:{render:qv},smart_context_item:{render:jv},smart_context_meta:{render:Tv},smart_context_tree:{render:zv},source_inspector:{render:Rv},status_bar:{render:Hv},supporter_callout:{render:Kv},user_agreement_callout:{render:Xv}},actions:{context_copy_to_clipboard:{action:Yv},context_item_merge_template:{action:tk,settings_config:sk,default_settings:Ep},context_merge_template:{action:ik,settings_config:ok,default_settings:Ap},context_suggest_blocks:{action:Ao,display_name:rk},context_suggest_sources:{action:lk,display_name:dk},lookup_list_pre_process:{action:Bc,pre_process:Bc},similarity:{action:Sp,settings_config:_k,display_name:Cp,display_description:Op},source_open:{action:mk}}};var hk={env_path:"",modules:{smart_fs:{class:qa,adapter:$a},smart_view:{class:Ia,adapter:La},smart_embed_model:{class:Vi,adapters:{transformers:_n,openai:lc,ollama:uc,gemini:mc,lm_studio:pc}},smart_chat_model:{class:Yi,adapters:{anthropic:Zi,azure:to,custom:mo,google:mn,gemini:io,groq:po,lm_studio:ro,ollama:lo,open_router:oo,openai:ps,xai:ho,deepseek:fo},http_adapter:new Xe({adapter:dn,obsidian_request_url:$p.requestUrl})},http_adapter:{class:Xe,adapter:dn,obsidian_request_url:$p.requestUrl}},collections:{context_items:gb,event_logs:bb,smart_components:ub,smart_contexts:hb,smart_sources:{collection_key:"smart_sources",class:Ui,data_adapter:Hi,source_adapters:{md:ds,txt:ds,"excalidraw.md":sc,base:Qa,canvas:tc,rendered:ec},content_parsers:[ab],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:Ki,data_adapter:nc,block_adapters:{md:on,txt:on,"excalidraw.md":on}}},item_types:{SmartSource:sn,SmartBlock:nn},items:{smart_source:Wy,smart_block:Yy},default_settings:xb,modals:{context_selector:{class:Sc,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:Oc},notifications_feed_modal:{class:Cc}}};yt(hk,pk);var fk=hk;var Uc=require("obsidian");function gk(){(0,Uc.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}r(gk,"add_smart_chat_icon");function yk(){(0,Uc.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}r(yk,"add_smart_connections_icon");function bk(){(0,Uc.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}r(bk,"add_smart_lookup_icon");var vk=require("obsidian");var Wc={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function w$(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(w$,"define_default_create_methods");var Sn=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,w$(Wc)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=Wc[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,vk.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,Wc["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var kk=require("obsidian");var x$=require("obsidian");function Gc(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Gc,"get_smart_server_url");var E$="smart-plugins-op",A$="smart-plugins-op-secret";function S$({access_token:n,refresh_token:e},t){localStorage.setItem(t+"token",n),e&&localStorage.setItem(t+"refresh",e)}r(S$,"set_local_storage_token");async function wk(n,e){let t=O$(e.app.vault.getName()),s=`${Gc()}/auth/oauth_exchange2`,i=await(0,kk.requestUrl)({url:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:E$,client_secret:A$,code:n})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:o,refresh_token:a}=i.json;if(!o)throw new Error("No access_token in response");S$({access_token:o,refresh_token:a},t)}r(wk,"exchange_code_for_tokens");var C$="_smart_plugins_oauth_";function O$(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${C$}`}r(O$,"build_oauth_storage_prefix");function xk(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let s=An([...new Set(t)]);return n.replace(/{{\s*folder_tree\s*}}/gi,s)}r(xk,"replace_folder_tree_var");function Ek(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let s=An([...new Set(t)]);return n.replace(/{{\s*folders_top\s*}}/gi,s)}r(Ek,"replace_folders_top_var");function Ak(n){console.log("replace_recent_n_var",n);let e=this;return n.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,s)=>{let i=parseInt(s,10)||0,o=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,o),o?`
- ${o}`:""}).trim()}r(Ak,"replace_recent_n_var");function Sk(n){let t=this.app?.metadataCache?.getTags?.()||{},s=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return n.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${s}
`).trim()}r(Sk,"replace_vault_tags_var");function Ck(n){n.register(e=>/{{\s*folder_tree\s*}}/i.test(e),xk,"{{ folder_tree }}"),n.register(e=>/{{\s*folders_top\s*}}/i.test(e),Ek,"{{ folders_top }}"),n.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),Sk,"{{ tags }}"),n.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),Ak,"{{ recent_10 }}")}r(Ck,"register_completion_variable_adapter_replacements");async function et({app:n,plugin_ids:e=[]}={}){if(!n)return;let t=n.vault?.adapter;for(let s of e)await q$(n.plugins,s)&&console.warn(`Disabled legacy plugin: ${s}`),await $$(t,s)&&console.warn(`Removed legacy plugin: ${s}`)}r(et,"remove_smart_plugins_plugin");async function q$(n,e){if(!(!n||!(n.plugins?.[e]||n.enabledPlugins?.has?.(e)||n.manifests&&e in n.manifests)))return n.plugins?.[e]&&await n.unloadPlugin?.(e),n.disablePluginAndSave&&await n.disablePluginAndSave(e),n.enabledPlugins?.has?.(e)&&n.enabledPlugins.delete(e),n.manifests&&e in n.manifests&&delete n.manifests[e],await n.loadManifests?.(),!0}r(q$,"disable_plugin_if_present");async function $$(n,e){if(!n?.exists)return;let t=`.obsidian/plugins/${e}`;if(await n.exists(t)){if(n.rmdir){await n.rmdir(t,!0);return}if(n.list&&n.remove){let i=[t];for(;i.length;){let o=i.pop(),a=await n.list(o);for(let c of a?.files||[])await n.remove(`${o}/${c}`);for(let c of a?.folders||[])i.push(`${o}/${c}`)}return await n.remove(t),!0}}}r($$,"remove_plugin_folder");var ys=class extends Bi{static{r(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,gk(),yk(),bk(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new Mt.Notice(i,0),window.smart_env=null}let s=yt(t,fk);return s.env_path="",await super.create(e,s)}async load(e=!1){if(this.run_migrations(),this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")||this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),Mt.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new Mt.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i.view?.file?.path;this.emit_source_opened(o,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i?.path;this.emit_source_opened(o,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&Ck(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),Bb(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let s=this.smart_sources.get(e);s&&(this._current_opened_source=e,s.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new Sn(this,{adapter:Mt.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),s=`${Gc()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(s,"_external"),s}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new Mt.Notice("No OAuth code provided in URL. Login failed.");return}try{await wk(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(s){console.error("OAuth callback error",s),new Mt.Notice(`OAuth callback error: ${s.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&j$(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){et({app:this.plugin.app,plugin_ids:["smart-plugins"]}),et({app:this.plugin.app,plugin_ids:["smart-editor"]}),et({app:this.plugin.app,plugin_ids:["smart-sources"]}),et({app:this.plugin.app,plugin_ids:["smart-claude"]}),et({app:this.plugin.app,plugin_ids:["smart-gemini"]}),et({app:this.plugin.app,plugin_ids:["smart-deepseek"]}),et({app:this.plugin.app,plugin_ids:["smart-perplexity"]}),et({app:this.plugin.app,plugin_ids:["smart-grok"]}),et({app:this.plugin.app,plugin_ids:["smart-aistudio"]})}};function j$(n,e){let t=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}r(j$,"download_json");var So=class extends Hc.Plugin{static{r(this,"SmartPlugin")}SmartEnv=ys;get commands(){return{show_release_notes:{id:"show-release-notes",name:"Show release notes",callback:r(()=>this.show_release_notes(),"callback")}}}register_commands(){Object.values(this.commands).forEach(e=>{this.addCommand(e)})}get ribbon_icons(){return{}}register_ribbon_icons(){let e=Object.values(this.ribbon_icons);for(let t=0;t<e.length;t++){let s=e[t];this.addRibbonIcon(s.icon_name,s.description,s.callback)}}get item_views(){return{}}register_item_views(){let e=Object.values(this.item_views);for(let t=0;t<e.length;t++){let s=e[t];typeof s.register_item_view=="function"&&s.register_item_view(this)}}async is_new_user(){let e=await this.loadData()||{};return e.installed_at?!1:(e.installed_at=Date.now(),await this.saveData(e),!0)}async get_last_known_version(){return(await this.loadData()||{}).last_version||""}async set_last_known_version(e){let t=await this.loadData()||{};t.last_version=e,await this.saveData(t)}async is_new_plugin_version(e){return await this.get_last_known_version()!==e}get notices(){return this.env?.notices?this.env.notices:(this._notices||(this._notices=new Sn(this.env,Hc.Notice)),this._notices)}};var Np=require("obsidian");var Ok=require("obsidian");async function qk(n,e={}){let{wait_for_states:t=["loaded"]}=e,s=n.container||n.containerEl;if(!t.includes(n.env?.state)){let i=!1;for(;n.env.state==="init"&&Ok.Platform.isMobile&&!i;)s?(s.empty(),n.env.smart_view.safe_inner_html(s,"<button>Load Smart Environment</button>"),s.querySelector("button").addEventListener("click",()=>{n.env.load(!0),i=!0})):console.log("Waiting for env to load (mobile)..."),await new Promise(o=>setTimeout(o,2e3));for(;!t.includes(n.env.state);){if(s){let o=n.env?.obsidian_is_syncing?"Waiting for Obsidian Sync to finish...":"Loading Obsidian Smart Environment...";s.empty(),n.env.smart_view.safe_inner_html(s,o)}else console.log("Waiting for env to load...");await new Promise(o=>setTimeout(o,2e3))}}}r(qk,"wait_for_env_to_load");var jp=`/* 1) Host elements that should get a PRO badge */\r
:is(\r
.pro-setting .setting-item-name\r
) {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
:is(\r
.pro-setting .setting-item-name:not(:empty)\r
)::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
:is(\r
.pro-setting .setting-item-name\r
):hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
.pro-plugins-container {\r
border: 1px solid var(--interactive-accent);\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-top: 1rem;\r
background-color: var(--background-secondary);\r
}\r
\r
.smart-plugin-settings-header .actions-container {\r
display: flex;\r
flex-wrap: wrap;\r
gap: var(--pill-padding-y);\r
}\r
\r
.setting-component:has(.dropdown-no-options) {\r
display: none;\r
}\r
\r
/* wrap Obsidian native styles within smart plugin settings main class */\r
.smart-plugin-settings-main, .smart-plugin-settings-env {\r
.setting-group {\r
margin-top: var(--size-4-6);\r
margin-bottom: var(--size-4-6);\r
}\r
/* polyfill */\r
.setting-group .setting-items {\r
background-color: var(--setting-items-background, var(--background-primary-alt));\r
padding: var(--setting-items-padding, var(--size-4-5));\r
border-radius: var(--setting-items-radius, var(--radius-l));\r
border: var(--setting-items-border-width, 0) solid var(--setting-items-border-color, var(--background-modifier-border));\r
}\r
}\r
`;var Co=class extends Np.PluginSettingTab{static{r(this,"SmartPluginSettingsTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.env.is_pro&&!this.env_settings_tab&&this.plugin.addSettingTab(new Tp(this.plugin.app,this.plugin)),this.icon="smart-connections",this.env.is_pro&&(this.name=this.name.replace("Smart ",""))}get smart_view(){return this.env?.smart_view}async display(){await this.render()}async render(){this.containerEl.empty(),$k(this),await this.env.constructor.wait_for({loaded:!0}),this.prepare_layout(),await this.render_header(this.header_container),await this.render_plugin_settings(this.plugin_container),await this.render_global_settings(this.global_settings_container)}prepare_layout(){this.smart_view.apply_style_sheet(jp),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.global_settings_container=this.containerEl.createDiv({cls:"smart-plugin-settings-env"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"})}async render_header(e){}async render_plugin_settings(e){}async render_global_settings(e){if(!e||(e.empty?.(),!this.env))return;if(this.env.is_pro){let s=e.createDiv({cls:"setting-item"}),i=s.createDiv({cls:"setting-item-info"});i.createDiv({cls:"setting-item-name",text:"Smart Environment"}),i.createDiv({cls:"setting-item-description",text:"Manage global settings in the dedicated Smart Environment settings tab."}),s.createDiv({cls:"setting-item-control"}).createEl("button",{text:"Open settings"}).addEventListener("click",()=>{this.app.setting.openTabById("smart-environment")})}else{let s=await this.render_component("settings_smart_env",this.env);s&&e.appendChild(s)}let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}async render_component(e,t,s={}){return await this.env.smart_components.render_component(e,t,s)}get env_settings_tab(){return(this.plugin.app||window.app).setting.pluginTabs.find(t=>t.id==="smart-environment")}},Tp=class extends Np.PluginSettingTab{static{r(this,"SmartEnvSettingTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.plugin=t,this.name="Smart Env Pro",this.id="smart-environment",this.icon="smart-connections"}get smart_view(){return this.env?.smart_view}display(){this.render()}async render_component(e,t,s={}){return await this.env.smart_components.render_component(e,t,s)}async render(){this.containerEl.empty(),this.smart_view.apply_style_sheet(jp),$k(this),await this.env.constructor.wait_for({loaded:!0}),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"}),this.header_container.createEl("p",{text:"Manage all global Smart Environment settings from one tab. These settings apply to all Smart Plugins."});let e=await this.render_component("settings_smart_env",this.env);e&&this.plugin_container.appendChild(e);let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}};function $k(n){let e=n.containerEl,t=n.env;if(t.state!=="loaded")if(t.state==="loading")e.createEl("p",{text:"Smart Environment is loading\u2026"});else{e.createEl("p",{text:"Smart Environment not yet initialized."});let s=e.createEl("button",{text:"Load Smart Environment"});s.addEventListener("click",async()=>{s.disabled=!0,s.textContent="Loading Smart Environment\u2026",await t.load(!0)})}}r($k,"render_pre_env_load");var Jc=require("obsidian");function Pp(n,e){let t=n.app.internalPlugins?.plugins?.webviewer?.instance;window.open(e,t?"_external":"_blank")}r(Pp,"open_url_externally");var Lt=class n extends Jc.Modal{static{r(this,"StoryModal")}constructor(e,{title:t,url:s}){super(e.app),this.plugin=e,this.title=t,this.url=s}static open(e,t){new n(e,t).open()}onOpen(){this.titleEl.setText(this.title),this.modalEl.addClass("sc-story-modal");let e=this.contentEl.createEl("div",{cls:"sc-story-container"});if(Jc.Platform.isMobile){e.createEl("button",{text:"Open in browser"}).addEventListener("click",()=>{Pp(this.plugin,this.url),this.close()});return}else{let t=e.createEl("webview",{attr:{src:this.url,allowpopups:""}});t.style.width="100%",t.style.height="100%",t.addEventListener("did-navigate",s=>{let i=s.url||t.getAttribute("src");i&&i!==this.url&&(Pp(this.plugin,i),this.close())})}}onClose(){this.contentEl.empty()}};var Kc=class extends Co{static{r(this,"SmartContextSettingTab")}constructor(e,t){super(e,t),this.plugin=t}async render_plugin_settings(e){if(!e)return;e.empty?.();let t=e.createDiv({cls:"smart-context-getting-started-container"});t.style.marginBottom="1em",t.createEl("button",{cls:"sc-getting-started-button",text:"Getting started guide"}).addEventListener("click",()=>{Lt.open(this.plugin,{title:"Getting Started With Smart Context",url:"https://smartconnections.app/story/smart-context-getting-started/?utm_source=context-settings"})}),this.env.smart_components.render_component("smart_context_settings_tab",this).then(i=>{e.appendChild(i)})}};var jk=require("obsidian");function Tk(n,e){let t=`Copied to clipboard! (${e})`;if(n){let s=n.char_count<1e5?n.char_count:`~${Math.round(n.char_count/1e3)}k`;if(t+=`, ${s} chars`,n.exclusions){let i=Object.values(n.exclusions).reduce((o,a)=>o+a,0);i>0&&(t+=`, ${i} section(s) excluded`)}}new jk.Notice(t)}r(Tk,"show_stats_notice");function Ip(n=[],e){if(!Array.isArray(n)||!e?.get)return[];let t=new Set;return n.reduce((s,i)=>{if(i?.extension?.toLowerCase?.()!=="md")return s;let a=i?.path;if(!a||t.has(a))return s;let c=e.get(a);return c?.key&&(t.add(a),s.push(c.key)),s},[])}r(Ip,"get_selected_note_keys");function Mp(n){let e=String(n??"").trim();return e?e.endsWith("/")?e:`${e}/`:""}r(Mp,"normalize_folder_prefix");function Lp(n=[]){if(!Array.isArray(n))return[];let e=new Set,t=[];for(let s of n){if(!Array.isArray(s?.children))continue;let o=s?.path;!o||e.has(o)||(e.add(o),t.push(o))}return t}r(Lp,"get_selected_folder_paths");function Oo(n=[],e){if(!Array.isArray(n)||n.length===0)return[];if(!e||typeof e.filter!="function")return[];let t=new Set,s=[];for(let i of n){let o=Mp(i);if(o)try{let a=e.filter({key_starts_with:o});if(!Array.isArray(a))continue;for(let c of a){let l=c?.key;!l||t.has(l)||!l.startsWith(o)||(t.add(l),s.push(l))}}catch(a){return console.warn("expand_folders_to_item_keys: smart_sources.filter failed",a),[]}}return s}r(Oo,"expand_folders_to_item_keys");function Nk(n=[],e){if(!Array.isArray(n))return[];let t=new Set,s=[];for(let i of n){if(Array.isArray(i?.children)){let d=i?.path,_=Oo([d],e);for(let m of _)!m||t.has(m)||(t.add(m),s.push(m));continue}let a=i?.path;if(!a)continue;let c=(i?.extension?.toLowerCase?.()||"").trim(),l=null;c==="md"?l=e?.get?.(a)?.key||a:c==="pdf"||N$(c)?l=a:l=e?.get?.(a)?.key||null,l&&(t.has(l)||(t.add(l),s.push(l)))}return s}r(Nk,"get_selected_context_item_keys");function N$(n){return new Set(["png","jpg","jpeg","gif","bmp","webp","svg","ico","avif"]).has(String(n||"").toLowerCase())}r(N$,"is_supported_image_extension");var Vc=require("obsidian");var Cn=class extends Vc.ItemView{static{r(this,"SmartItemView")}constructor(e,t){super(e),this.app=t.app,this.plugin=t}static get view_type(){throw new Error("view_type must be implemented in subclass")}static get display_text(){throw new Error("display_text must be implemented in subclass")}static get icon_name(){return"smart-connections"}static register_item_view(e){let t=this;e.registerView(t.view_type,l=>new t(l,e)),e.addCommand({id:t.view_type,name:"Open: "+t.display_text+" view",callback:r(()=>{t.open(e.app.workspace)},"callback")});let s=t.view_type.replace(/^smart-/,"").replace(/-/g,"_"),i="open_"+s;Object.getOwnPropertyDescriptor(e,s)||Object.defineProperty(e,s,{configurable:!0,enumerable:!1,get:r(()=>t.get_view(e.app.workspace),"get")}),e[i]=()=>t.open(e.app.workspace);let o=`${s}:open`,a=r(l=>{let d=typeof l?.active=="boolean"?l.active:!0;t.open(e.app.workspace,d)},"handler"),c=e?.env?.events.on(o,a);return typeof e.register=="function"&&typeof c=="function"&&e.register(()=>c()),{method_name:s,open_method_name:i,event_name:o}}static get_leaf(e){return e.getLeavesOfType(this.view_type)[0]}static get_view(e){let t=this.get_leaf(e);return t?t.view:void 0}static open(e,t={}){let{active:s=!0}=t,i=this.get_leaf(e);this.default_open_location==="root"?i?i.setViewState({type:this.view_type,active:s}):e.getLeaf(!1).setViewState({type:this.view_type,active:s}):(i?i.setViewState({type:this.view_type,active:s}):e.getRightLeaf(!1).setViewState({type:this.view_type,active:s}),e.rightSplit?.collapsed&&e.rightSplit.toggle()),setTimeout(()=>{this.get_view(e)?.render_view(t)},100)}static is_open(e){return this.get_leaf(e)?.view instanceof this}getViewType(){return this.constructor.view_type}getDisplayText(){return this.constructor.display_text}getIcon(){return this.constructor.icon_name}async onOpen(){this.app.workspace.onLayoutReady(this.initialize.bind(this))}async initialize(){if(await qk(this),this.container.empty(),this.register_plugin_events(),this.app.workspace.registerHoverLinkSource(this.constructor.view_type,{display:this.getDisplayText(),defaultMod:!0}),this.render_view(),Vc.Platform.isMobile){let e=this.containerEl.querySelector(".status-bar-mobile")??this.containerEl.createDiv({cls:"status-bar-mobile"});e.empty();let t=e.createDiv({cls:"status-bar-item"});this.env.smart_components.render_component("status_bar",this.env).then(s=>t.appendChild(s))}}register_plugin_events(){}render_view(e={}){throw new Error("render_view must be implemented in subclass")}get container(){return this.containerEl.children[1]}get env(){return this.plugin.env}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}};var P$="smart-contexts-dashboard",Xc=class extends Cn{static{r(this,"ContextsDashboardView")}static get view_type(){return P$}static get display_text(){return"Management dashboard (show named contexts)"}static get icon_name(){return"layout-dashboard"}async render_view(e={}){let t=await this.env.render_component("smart_context_list",this.env.smart_contexts,{...e});t.classList.add("item-view"),this.container.empty(),this.container.append(t)}};var Ik=require("obsidian");var Pk=`> [!NOTE] Patch v2.0.3
> - Added: template presets for context and item templates
> - Added: \`{{ITEM_NAME}}\` variable for context item templates
> - Added: \`{{EXT}}\` variable for context item templates
> - Added: \`json_stringify\` setting for custom context item templates

> [!NOTE]- Previous patches
> > [!NOTE]- v2.0.2
> > - Added option to open context builder using file/folder selections in file nav
> > - Added command/modal for selecting named contexts (open copy modal or builder modal)
> > - Added help button to CopyContextModal for user guidance
> > - Added functionality to copy multiple selected folders as context using files menu
> > - Updated named context list styles and add help button
>
>
# Smart Context \`v2\`\r
\r
**Feed large language models better inputs, faster.** **Smart Context *collects, cleans, and copies* every note you need** in a single click.\r
\r
> Build your Context Engineering workflow with Obsidian.\r
\r
- Copy selected files in file navigator to clipboard\r
- right-click on multi-file selection in file navigator to reveal option\r
- Use links to quickly copy current and relevant notes as context\r
- embedded links are treated as depth 0\r
- Name context bundles for easy re-use\r
\r
Learn more: https://smartconnections.app/smart-context/#docs
`;var On=class n extends Cn{static{r(this,"ReleaseNotesView")}static get view_type(){return"smart-context-release-notes-view"}static get display_text(){return"Release Notes"}static get icon_name(){return"file-text"}static open(e,t,s=!0){e.getLeaf("tab").setViewState({type:this.view_type,active:s,state:{version:t}})}getViewType(){return n.view_type}getDisplayText(){return n.display_text}getIcon(){return n.icon_name}onOpen(){this.titleEl.setText(`What's new in v${this.version}`),this.render()}get container(){let e=this.containerEl?.querySelector(".view-content"),t=e?.querySelector(".markdown-preview-view");return t||(t=e?.createDiv("cm-scroller is-readable-line-width")?.createDiv("markdown-preview-view markdown-rendered")),t}async render(){for(;!this.container;)await new Promise(e=>setTimeout(e,100)),console.warn("Waiting for containerEl to be ready...",this.container);await Ik.MarkdownRenderer.render(this.app,Pk,this.container,"",this),this.container.querySelectorAll("a").forEach(e=>{e.setAttribute("target","_external")}),requestAnimationFrame(()=>this.#t(this.container,this.version))}get version(){return this.leaf.viewState?.state?.version??this.app.plugins.getPlugin("smart-context")?.manifest.version??""}#t(e,t){if(!t)return;let s=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`\\bv?${s}\\b`,"i");e.querySelectorAll("h1,h2,h3,h4,h5,h6").forEach(o=>{i.test(o.textContent??"")&&o.scrollIntoView({behavior:"smooth",block:"start"})})}};function Yc(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Yc,"collection_instance_name_from");function bs(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Mk(e[t])&&Mk(n[t])?bs(n[t],e[t]):n[t]=e[t]);return n}r(bs,"deep_merge");function Mk(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Mk,"is_plain_object");function Lk(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Lk,"create_uid");function zk(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(zk,"camel_case_to_snake_case");function Zc(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Zc(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Zc(n[o],e[o],t))}return n===e}r(Zc,"deep_equal");function Dk(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(Dk,"get_item_display_name");function Qc(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let v of Reflect.ownKeys(u)){let S=Object.getOwnPropertyDescriptor(u,v);if(!S)continue;let E={...S};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let v=!1;for(let S of h){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E){let q=E.value;if(c(q)){v=!0;continue}if(s(q)){if(_(q)){v=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),v=new Map;for(let S of Reflect.ownKeys(u)){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E&&_(E.value)){v.set(S,d(E.value));continue}try{Object.defineProperty(h,S,m(E))}catch{h[S]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),w=Object.create(null),b=r((u,h,v=[])=>{if(!u||!h)return;let S=new Set([...l,...v]);for(let E of Reflect.ownKeys(u)){if(S.has(E))continue;let q=Object.getOwnPropertyDescriptor(u,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),k=r(u=>{let h=new u(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let S=v.bind(h);return b(u,S),b(h,S),S.instance=h,S}return b(u,h),h},"instantiate_class"),C=r(u=>{if(o(u))return k(u);if(a(u)){let h=u.action.bind(n);return b(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return b(u,h),h}return s(u)?d(u):u},"bind_or_clone"),O=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),j=r((u,h,v)=>(u[h]=v,v),"cache_result"),$=r((u,h)=>{let v=O();return v&&g(v,h)?j(u,h,C(v[h])):g(f,h)?j(u,h,C(f[h])):j(u,h,void 0)},"compute_and_cache"),A=r(()=>{let u=O(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(u)for(let v of Reflect.ownKeys(u))h.add(v);return Array.from(h)},"union_keys"),x=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(w,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:$(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let v=O();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>A(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return x(u,h);let v=O();if(v&&g(v,h)||g(f,h))return g(u,h)||$(u,h),x(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,v)=>"value"in v?(u[h]=v.value,!0):!1,"defineProperty"),set:r((u,h,v)=>(u[h]=v,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(Qc,"create_actions_proxy");var qo=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&bs(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Lk(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return bs(s,t),!Zc(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Qc(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Yc(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Yc(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),zk(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Dk(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var I$=Object.getPrototypeOf(async function(){}).constructor,$o=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof I$?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return bs(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Qc(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var el=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=jo;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},jo=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var tl=class extends el{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=To;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},To=class extends jo{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var Rk={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},sl=class extends tl{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=nl;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},nl=class extends To{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return Rk[s]&&(s=Rk[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function zp(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():Fk(a)?n[o]=zp(Fk(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(zp,"ajson_merge");function Fk(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(Fk,"is_object");var Bk={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function M$(n){let e=!1,[t,...s]=n.split(":");return Bk[t]&&(t=Bk[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(M$,"_parse_ajson_key");var No=class extends sl{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:w}=M$(p),b=`${y}:${g}`;f?(i[b]=f,(w||b!==p)&&(delete i[p],t=!0)):(delete i[b],(w||b!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=zp(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}};function Uk(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(Uk,"filter_redundant_context_items");var Wk=r((n,e)=>!e||!n?.[e]?!1:n[e].folder?n[e].exclude?!1:(n[e].exclude=!0,!0):(delete n[e],!0),"remove_context_item_data"),vs=class extends qo{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:s=!0}=t;Wk(this.data.context_items,e)&&(this.queue_save(),s&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:s=!0}=t,i=Array.isArray(e)?e:[e],o=[];return i.forEach(a=>{Wk(this.data.context_items,a)&&o.push(a)}),o.length?(this.queue_save(),s&&this.emit_event("context:updated",{removed_keys:o}),o):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return Uk(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var il=class extends $o{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var Gk={class:il,data_adapter:No,item_type:vs};var qn=require("obsidian");var ol=class extends qn.SuggestModal{static{r(this,"CopyContextModal")}constructor(e,t={}){let s=e.env,i=s.plugin,o=i.app;super(o),this.app=o,s.create_env_getter(this),this.plugin=i,this.ctx=e,this.params=t,this.modalEl.prepend(this.titleEl),this.setTitle("Smart Context - Copy to clipboard");let a=this.titleEl.createEl("button");(0,qn.setIcon)(a,"help-circle"),a.addEventListener("click",c=>{window.open("https://smartconnections.app/smart-context/clipboard/?utm_source=copy-modal","_external")}),this.titleEl.style.display="flex",this.titleEl.style.justifyContent="space-between",this.titleEl.style.margin="var(--size-4-4)",setTimeout(()=>this.inputEl.focus(),0)}async onOpen(){let e=this.ctx.context_items.filter(i=>!(i.data.exclude||i.is_media&&!this.params.with_media)),t=Math.max(...e.map(i=>typeof i.data.d=="number"?i.data.d:0)),s=e.reduce((i,o)=>{if(typeof o.data.d=="number")for(let a=o.data.d;a<=t;a++)i[a]||(i[a]={d:a,size:0,sizes:0,count:0}),i[a].count+=1,typeof o.size=="number"&&o.size>0&&(i[a].size+=o.size,i[a].sizes+=1);return i},Array.from({length:t+1}));this.suggestions=s.filter(Boolean),super.onOpen()}getSuggestions(){return this.suggestions}renderSuggestion(e,t){t.createDiv({text:`Depth ${e.d} (${L$(e.size)} chars, ${e.count} items)`})}async onChooseSuggestion(e){let t=new qn.Notice("Copying context\u2026",0);await this.ctx.actions.context_copy_to_clipboard({filter:r(s=>s.data.d<=e.d,"filter"),max_depth:e.d,...this.params}),t.hide()}};function L$(n){let e=Number(n)||0;if(e>=1e7){let t=e/1e6;return`${t>=10?Math.round(t):Math.round(t*10)/10}M`}if(e>=1e4){let t=e/1e3;return`${t>=10?Math.round(t):Math.round(t*10)/10}K`}return e.toLocaleString()}r(L$,"format_suggestion_size");function z$(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(z$,"build_html");async function Hk(n,e={}){let t=z$(),i=this.create_doc_fragment(t).firstElementChild;return D$.call(this,n,i,e),i}r(Hk,"render");async function D$(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o),Dp(n,o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),bp(n,a),vp(n,a),kp(n,a),wp(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(D$,"post_process");function Dp(n,e){let t=document.createElement("input");t.type="text",t.className="sc-context-name-input",t.placeholder="Context name\u2026",t.setAttribute("aria-label","Context name"),e.appendChild(t);let s=r(()=>{t.value=n?.data?.name?String(n.data.name):""},"refresh_name"),i=r(()=>{let a=o(t.value);a!==(n.data.name||"")&&(n.name=a)},"save_name");s(),t.addEventListener("keydown",a=>{a.stopPropagation(),a.key==="Enter"&&(i(),t.blur()),a.key==="Escape"&&(s(),t.blur())}),t.addEventListener("blur",()=>i());function o(a){let c=String(a??"").trim();if(!c)return"";let l=c.replace(/\s+/g," "),d=120;return l.length>d?l.slice(0,d):l}r(o,"sanitize_context_name")}r(Dp,"render_name_input");var Jk="2.0.0";var Kk=`.sc-contexts-dashboard-list {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-contexts-dashboard .top-bar {\r
display: flex;\r
align-items: center;\r
justify-content: space-between;\r
margin-bottom: 1rem;\r
}`;var Yk=require("obsidian");var Vk="sc-contexts-dashboard",Xk="sc-contexts-dashboard-list";function F$(){return`<div class="${Vk}">
<div class="top-bar">
<small><b>Smart Context</b></small>
<button class="help"></button>
</div>
<div class="${Xk}"></div>
</div>`}r(F$,"build_html");async function Zk(n,e={}){this.apply_style_sheet(Kk);let t=F$(),i=this.create_doc_fragment(t).querySelector(`.${Vk}`);return B$.call(this,n,i,e),i}r(Zk,"render");async function B$(n,e,t={}){let s=[],i=e.querySelector(`.${Xk}`),o=n?.env,a=e.querySelector("button.help");(0,Yk.setIcon)(a,"help-circle"),a?.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-list-help#manage-named","_external")});let c=r(async()=>{let l=n.filter(d=>d?.data?.name&&String(d.data.name).trim().length>0);if(this.empty(i),!l.length){let d=document.createElement("div");d.classList.add("sc-contexts-dashboard-empty"),d.textContent="No named contexts yet. Save a context to see it here.",i.appendChild(d);return}for(let d of l){let _=await o.smart_components.render_component("smart_context_list_item",d,t);_&&i.appendChild(_)}},"render_list_items");return await c(),s.push(n?.env?.events?.on("context:created",c)),this.attach_disposer(e,s),e}r(B$,"post_process");var Qk=require("obsidian");var ew="sc-contexts-dashboard-item";function U$(n,e={}){return`<div>
<div class="${ew}" data-context-key="${n?.data?.key||""}">
<div class="sc-contexts-dashboard-item-header" tabindex="0" aria-label="${n.name}">
<button class="sc-contexts-dashboard-show" aria-expanded="false" aria-label="Show ${n.name}">Show</button>
<span class="sc-contexts-dashboard-name">${n.name}</span>
<span class="sc-contexts-dashboard-count">${n.item_count} items</span>
</div>
<div class="sc-contexts-dashboard-item-detail" hidden></div>
</div>
</div>`}r(U$,"build_html");async function tw(n,e={}){let t=U$(n,e),i=this.create_doc_fragment(t).querySelector(`.${ew}`);return W$.call(this,n,i,e),i}r(tw,"render");async function W$(n,e,t={}){e.querySelector(".sc-contexts-dashboard-show").addEventListener("click",async()=>{n.emit_event("context_selector:open")}),e.addEventListener("contextmenu",c=>{c.preventDefault(),c.stopPropagation();let l=n?.env?.smart_context_plugin?.app||n?.env?.plugin?.app||window.app||null;if(!l)return;let d=new Qk.Menu(l);d.addItem(_=>_.setTitle("Copy context to clipboard").setIcon("copy").onClick(async(m,...p)=>{n.actions.context_copy_to_clipboard()})),d.showAtMouseEvent(c)});let i=[],o=r(()=>{let c=e.querySelector(".sc-contexts-dashboard-count");c&&(c.textContent=`${n.item_count} item${n.item_count===1?"":"s"}`)},"update_count"),a=r(c=>{let l=e.querySelector(".sc-contexts-dashboard-name");l&&c?.name?l.textContent=c.name:console.warn("Received context:renamed event without name payload or missing name_span element",{payload:c,name_span:l})},"rename_handler");return i.push(n.on_event("context:renamed",a)),i.push(n.on_event("context:updated",o)),this.attach_disposer(e,i),e}r(W$,"post_process");var sw=`.smart-context-settings-tab {\r
.setting-item-control textarea {\r
width: 100%;\r
}\r
\r
.setting-item-description code {\r
cursor: text;\r
user-select: all;\r
}\r
\r
@media (min-width: 720px) {\r
.setting-item-info:has(+ .setting-item-control:not(:empty)) {\r
max-width: 50%;\r
}\r
}\r
}\r
\r
/* hide custom inputs unles custom selected */\r
.setting-group:has(.template-preset option[value='custom']:not(:checked)) {\r
.setting-item.context-explanation,\r
.setting-item.item-explanation,\r
.setting-item.template-before,\r
.setting-item.template-after {\r
display: none;\r
}\r
}`;async function H$(n,e={}){return`<div class="smart-context-settings-tab">
<div class="smart-contexts"></div>
<div class="context-items"></div>
</div>`}r(H$,"build_html");async function nw(n,e={}){this.apply_style_sheet(sw);let t=await H$.call(this,n,e),s=this.create_doc_fragment(t),i=s.firstElementChild;return J$.call(this,n,i,e),s}r(nw,"render");async function J$(n,e,t={}){let s=n.env,i=s.smart_components?.render_component.bind(s.smart_components),o=s.smart_contexts,a=e.querySelector(".smart-contexts");gs(o.settings_config,o,a,{default_group_name:"Smart Contexts",heading_btn:[{label:"Settings documentation for Contexts Templates",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-context/settings/?utm_source=context-settings-tab#context-templates","_external"),"callback")}],group_params:{"External sources":{heading_btn:[{label:"Settings documentation for External Sources",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-context/settings/?utm_source=context-settings-tab#external-sources","_external"),"callback")}]}}});let c=s.context_items,l=e.querySelector(".context-items");gs(c.settings_config,c,l,{default_group_name:"Context Items",heading_btn:[{label:"Settings documentation for Context Items",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-context/settings/?utm_source=context-settings-tab#context-items","_external"),"callback")}]})}r(J$,"post_process");var he={OUT:"out",IN:"in",BOTH:"both"};function rl(n,e=1,{direction:t=he.OUT,include_self:s=!1}={}){if(!n||typeof n!="object"||!n.collection)return[];let i=n.collection,o=i.links||{},a=new Set,c=[],l=r((_,m)=>{_&&(a.has(_.key)||(a.add(_.key),d.push({src:_,depth:m}),c.push({depth:m,item:_})))},"enqueue"),d=[{src:n,depth:0}];for(s&&(a.add(n.key),c.push({depth:0,item:n}));d.length;){let _=d.shift();if(_.depth>=e)continue;let m=_.depth+1;if(t===he.OUT||t===he.BOTH)for(let p of _.src.outlinks)l(i.get(p.key),m);if(t===he.IN||t===he.BOTH){let p=Object.keys(o[_.src.path]||{});for(let f of p)l(i.get(f),m)}}return c}r(rl,"get_links_to_depth");function K$(n=[],e=null){let t={},s=e.outlinks;for(let i of n){if(!i||!i.item)continue;let o=i.item,a=o.key;if(!a)continue;let c=typeof i.depth=="number"?i.depth:0,l=c;Array.isArray(s)&&c>0&&typeof a=="string"&&e.outlinks.find(p=>p.key===a&&p.embedded===!0)&&(l=0);let d=t[a]||{},_=typeof d.d=="number"?Math.min(d.d,l):l;t[a]={...d,d:_,mtime:o.mtime,size:o.size,link:!0}}return t}r(K$,"build_context_items_from_graph");async function iw(n={}){let t=n.direction&&Object.values(he).includes(n.direction)?n.direction:he.BOTH,s=typeof n.include_self=="boolean"?n.include_self:!0,i=await rl(this,5,{direction:t,include_self:s}),o=K$(i,this),a=this.env.smart_contexts,c=this.key,l=await a.create_or_update({key:c,context_items:o});return this.once_event("sources:imported",()=>{a.items[c]&&delete a.items[c],console.log(`Invalidated SmartContext cache for source ${c}`)}),l||null}r(iw,"source_get_context");var ow={collections:{},item_types:{},items:{},modules:{},components:{smart_context_actions:{render:Hk,version:Jk},smart_context_list:{render:Zk},smart_context_list_item:{render:tw},smart_context_settings_tab:{render:nw}},actions:{source_get_context:{action:iw}}};var V$={collections:{smart_contexts:Gk},item_types:{SmartContext:vs},modals:{copy_context_modal:{class:ol}}},al=yt(ow,V$);var ll=require("obsidian");var cl=class extends ll.SuggestModal{static{r(this,"FolderSelectModal")}constructor(e,t){super(e),this.onChoose=t,this.setInstructions([{command:"Enter",purpose:"Select a folder to copy its contents to the clipboard."}])}getAllFolders(e,t=[]){t.push(e);for(let s of e.children)s instanceof ll.TFolder&&this.getAllFolders(s,t);return t}getSuggestions(e){return this.getAllFolders(this.app.vault.getRoot()).filter(s=>s.path.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e.path})}onChooseSuggestion(e){this.onChoose(e)}};var zt=require("obsidian");var dl=class extends hn{static{r(this,"NamedContextSelectModal")}constructor(e,t,s={}){let o=t?.env?.smart_contexts;super(o),this.params={...s},this.setTitle("Smart Context - Select named context"),this.emptyStateText="No named contexts yet.",this.setInstructions([{command:"Enter",purpose:"Copy named context (choose depth)"},{command:"Mod + Enter",purpose:"Edit named context"},{command:"Esc",purpose:"Close"},{command:"\u2192",purpose:"Edit (same as Mod+Enter)"}])}open(e={}){this.params={...this.params,...e},this.suggestions=this.get_named_context_suggestions(),super.open()}get_named_context_suggestions(){let e=this.env?.smart_contexts;return((Array.isArray(e?.items)?e.items:e?.items?Object.values(e.items):[])||[]).filter(i=>(i?.data?.name?String(i.data.name).trim():"").length>0).sort((i,o)=>{let a=(i?.data?.name||"").toString().toLowerCase(),c=(o?.data?.name||"").toString().toLowerCase();return a.localeCompare(c)}).map(i=>{let o=String(i.data.name||"").trim(),a=typeof i.item_count=="number"?i.item_count:0;return{key:i?.data?.key||i?.key||o,display:`${o} (${a} item${a===1?"":"s"})`,ctx:i,select_action:r(async()=>{await this.open_copy_modal_for_named_context(i)},"select_action"),mod_select_action:r(async()=>{await this.open_builder_for_named_context(i)},"mod_select_action")}})}async onChooseSuggestion(e,t){let s=e?.item||e,i=this.use_arrow_right,o=t&&zt.Keymap.isModifier(t,"Mod")||this.use_mod_select;this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1;let a=(i||o)&&typeof s?.mod_select_action=="function"?"mod_select_action":"select_action";if(typeof s?.[a]!="function"){new zt.Notice("No action available for selection."),this.prevent_close=!1,super.close();return}try{await s[a]({modal:this,event:t})}catch(c){console.error("NamedContextSelectModal: selection failed",c),new zt.Notice("Failed to open named context action.")}this.prevent_close=!1,super.close()}async open_builder_for_named_context(e){e&&e.emit_event("context_selector:open")}async open_copy_modal_for_named_context(e){if(!e)return;let t=typeof this.params?.max_depth=="number"?this.params.max_depth:3,s=this.params?.direction&&Object.values(he).includes(this.params.direction)?this.params.direction:he.BOTH,i=this.env?.config?.modals?.copy_context_modal?.class;if(!i){new zt.Notice("Copy modal not available.");return}let o=new zt.Notice("Building linked context\u2026",0),a=null;try{a=await X$(e,{max_depth:t,direction:s})}catch(l){console.error("NamedContextSelectModal: build_named_context_copy_ctx failed",l),a=null}finally{o.hide()}if(!a){new zt.Notice("Failed to build linked context.");return}new i(a,{max_depth:t}).open()}};async function X$(n,e){if(!n?.env)return null;let t=typeof e?.max_depth=="number"?e.max_depth:3,s=e?.direction&&Object.values(he).includes(e.direction)?e.direction:he.BOTH,i=n?.data?.context_items||{},o={},a=[];for(let[f,y]of Object.entries(i)){if(!f)continue;let g=y&&typeof y=="object"?y:{},w=typeof g.d=="number"?g.d:0;o[f]={...g,d:w},!g.exclude&&w===0&&Y$(n.env,f)&&a.push(f)}let c=[...new Set(a)];for(let f of c){let y=n.env?.smart_sources?.get?.(f);if(!y)continue;let g=[];try{g=await rl(y,t,{direction:s,include_self:!0})}catch(b){console.warn("build_named_context_copy_ctx: get_links_to_depth failed",f,b);continue}let w=Z$(g,y);Q$(o,w)}let d=`${n?.data?.key||n?.key||Date.now().toString()}#copy`,_={...n.data,key:d,context_items:o},m=n.constructor,p=new m(n.env,_);return p.collection=n.collection,p}r(X$,"build_named_context_copy_ctx");function Y$(n,e){return typeof e!="string"||!e||e.startsWith("external:")||e.includes("#")||!n?.smart_sources?.get?!1:!!n.smart_sources.get(e)}r(Y$,"is_traversable_source_key");function Z$(n=[],e=null){let t={},s=e?.outlinks;for(let i of n){if(!i||!i.item)continue;let o=i.item,a=o.key;if(!a)continue;let c=typeof i.depth=="number"?i.depth:0,l=c;Array.isArray(s)&&c>0&&typeof a=="string"&&s.find(p=>p?.key===a&&p?.embedded===!0)&&(l=0);let d=t[a]||{},_=typeof d.d=="number"?Math.min(d.d,l):l;t[a]={...d,d:_,mtime:o.mtime,size:o.size,link:!0}}return t}r(Z$,"build_context_items_from_graph");function Q$(n,e){if(!(!n||typeof n!="object"))for(let[t,s]of Object.entries(e||{})){if(!t)continue;let i=s&&typeof s=="object"?s:{},o=typeof i.d=="number"?i.d:0,a=n[t];if(a?.exclude)continue;if(!a){n[t]={...i,d:o,at:Date.now()};continue}let c=typeof a.d=="number"?a.d:0;n[t]={...a,...i,d:Math.min(c,o)}}}r(Q$,"merge_context_items_min_depth");function rw(n){return{new_context:{id:"new-context-open-selector",name:"Open Selector for New Context",checkCallback:r(e=>n?.env?.smart_contexts?(e||n.open_new_context_modal(),!0):!1,"checkCallback")},copy_named_context:{id:"copy-named-context-with-depth",name:"Copy named context to clipboard (choose depth)",checkCallback:r(e=>n?.env?.smart_contexts?(e||new dl(n.app,n,{max_depth:3}).open(),!0):!1,"checkCallback")},get_started:{id:"show-getting-started",name:"Help: Show getting started",callback:r(()=>{Lt.open(n,{title:"Getting Started With Smart Context",url:"https://smartconnections.app/story/smart-context-getting-started/?utm_source=sc-command"})},"callback")},copy_current:{id:"copy-current-note-with-depth",name:"Copy current to clipboard",editorCheckCallback:r((e,t,s)=>{let i=s.file?.path;if(!i)return!1;let o=n.env.smart_sources.get(i);if(!o)return!1;let a=n.env.config.modals?.copy_context_modal?.class;return a?(e||o.actions.source_get_context().then(c=>{if(!c){n.env.events.emit("notification:error",{message:"Failed to build context for current note."}),new Notice("Failed to build context for current note.");return}new a(c).open()}),!0):!1},"editorCheckCallback")},copy_folder:{id:"copy-folder-to-clipboard",name:"Copy entire folder to clipboard",callback:r(()=>{new cl(n.app,async e=>{e&&await n.copy_folder_to_clipboard(e)}).open()},"callback")}}}r(rw,"context_commands");var Po=class extends So{static{r(this,"SmartContextPlugin")}SmartEnv=ys;onload(){this.app.workspace.onLayoutReady(this.initialize.bind(this)),this.SmartEnv.create(this,al)}onunload(){try{this.unregister_event_bus_handlers()}catch{}this.env.unload_main(this)}async initialize(){await this.load_new_user_state(),await this.SmartEnv.wait_for({loaded:!0}),this.register_commands(),this.register_folder_menu(),this.register_files_menu(),Xc.register_item_view(this),On.register_item_view(this),this.addSettingTab(new Kc(this.app,this)),this.is_new_user()&&(setTimeout(()=>{Lt.open(this,{title:"Getting Started With Smart Context",url:"https://smartconnections.app/story/smart-context-getting-started/?utm_source=sc-new-user"})},1e3),await this.save_installed_at(Date.now())),await this.check_for_updates()}async check_for_updates(){let e=this.manifest?.version;if(!e)return;if(typeof this.is_new_plugin_version=="function"&&typeof this.set_last_known_version=="function"){try{if(!await this.is_new_plugin_version(e))return;try{On.open(this.app.workspace,e)}catch(i){console.error("Failed to open ReleaseNotesView",i)}await this.set_last_known_version(e)}catch(s){console.warn("check_for_updates failed (base helpers)",s)}return}try{let s=await this.loadData()??{};if(s.last_known_version===e)return;try{On.open(this.app.workspace,e)}catch(o){console.error("Failed to open ReleaseNotesView",o)}s.last_known_version=e,await this.saveData(s)}catch(s){console.warn("check_for_updates failed (fallback)",s)}}async load_new_user_state(){this._installed_at=null;let e=await this.loadData();e&&typeof e.installed_at<"u"&&(this._installed_at=e.installed_at)}async save_installed_at(e){this._installed_at=e;let t=await this.loadData()??{};t.installed_at=e,await this.saveData(t)}is_new_user(){return!this._installed_at}register_folder_menu(){this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof $n.TFolder&&(e.addItem(s=>{s.setTitle("Copy folder contents to clipboard").setIcon("documents").onClick(async()=>{await this.copy_folder_to_clipboard(t)})}),e.addItem(s=>{s.setTitle("Open folder in Context Builder").setIcon("layout-list").onClick(async()=>{let i=Mp(t.path),o=this.env.smart_sources.filter({key_starts_with:i}).map(a=>a.key);this.open_new_context_modal({add_items:o})})}))}))}register_files_menu(){this.registerEvent(this.app.workspace.on("files-menu",(e,t)=>{let s=Lp(t),i=s.length>0,o=Nk(t,this.env.smart_sources);(o.length>0||i)&&e.addItem(c=>{c.setTitle("Open selection in Context Builder").setIcon("layout-list").onClick(async()=>{this.open_new_context_modal({add_items:o})})}),Ip(t,this.env.smart_sources).length>1&&e.addItem(c=>{c.setTitle("Copy selected notes as context").setIcon("documents").onClick(async()=>{await this.copy_selected_files_to_clipboard(t)})}),s.length>1&&e.addItem(c=>{c.setTitle("Copy selected folders as context").setIcon("documents").onClick(async()=>{await this.copy_selected_folders_to_clipboard(t)})})}))}get_relative_path(e,t){if(e===t)return"";if(!e.startsWith(t))return e;let s=e.slice(t.length);return s.startsWith("/")&&(s=s.slice(1)),s}get commands(){return{...rw(this)}}open_new_context_modal(e={}){let t=Array.isArray(e.add_items)?e.add_items:[],s=this.env.smart_contexts.new_context({},{add_items:t}),{add_items:i,...o}=e||{};s.emit_event("context_selector:open",o)}emit_file_nav_copy_event(e){e?.emit_event&&e.emit_event("context:file_nav_copied")}async copy_folder_to_clipboard(e){let t=Oo([e?.path],this.env.smart_sources),s=this.env.smart_contexts.new_context({},{add_items:t});this.emit_file_nav_copy_event(s),s.actions.context_copy_to_clipboard()}async copy_selected_files_to_clipboard(e){let t=Ip(e,this.env.smart_sources);if(!t.length){new $n.Notice("No Smart Context notes found in selection.");return}let s=this.env.smart_contexts.new_context({},{add_items:t});this.emit_file_nav_copy_event(s),s.actions.context_copy_to_clipboard()}async copy_selected_folders_to_clipboard(e){let t=Lp(e);if(!t.length){new $n.Notice("No folders found in selection.");return}let s=Oo(t,this.env.smart_sources);if(!s.length){new $n.Notice("No Smart Context notes found in selected folders.");return}let i=this.env.smart_contexts.new_context({},{add_items:s});this.emit_file_nav_copy_event(i),i.actions.context_copy_to_clipboard()}async copy_to_clipboard(e){await xn(e)}showStatsNotice(e,t){Tk(e,t)}};var yw=require("obsidian");var hw=P(require("path"),1),fw=require("node:fs");function tj(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=jn(l,o),l=Rp(l,15),l=jn(l,a),i^=l,i=Rp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=jn(l,o),l=Rp(l,15),l=jn(l,a),i^=l;break}return i^=n.length,i=sj(i),i|0}r(tj,"murmur_hash_32");function aw(n,e=0){return(tj(n,e)>>>0).toString(36)}r(aw,"murmur_hash_32_alphanumeric");function jn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(jn,"multiply_32");function Rp(n,e){return n<<e|n>>>32-e}r(Rp,"rotate_left_32");function sj(n){return n^=n>>>16,n=jn(n,2246822507),n^=n>>>13,n=jn(n,3266489909),n^=n>>>16,n|0}r(sj,"fmix_32");var vt=require("fs"),ul=P(require("path"),1);function nj(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=oj(n,t),o=ij(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(nj,"create_regex");function ij(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(ij,"adjust_for_windows_paths");function oj(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(oj,"glob_to_regex_pattern");function cw(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:nj(n,s)}r(cw,"glob_to_regex");function lw(n,e,t={}){return cw(n,t).test(e)}r(lw,"match_glob");var dw=["Dockerfile","Appfile","Matchfile","Deliverfile","Gymfile","Fastfile","Gemfile","Guardfile","Jenkinsfile","Makefile","Procfile","Rakefile"],_w=[".adoc",".asciidoc",".asm",".ass",".awk",".bash",".bash_profile",".bashrc",".bas",".bat",".bats",".bib",".c",".canvas",".cfg",".cjs",".cl",".clj",".cljc",".cljs",".cmake",".cmd",".cnf",".conf",".config",".cpp",".cr",".cs",".csh",".css",".csv",".cue",".cxx",".d",".dart",".dockerfile",".dockerignore",".drawio",".dtd",".edn",".eex",".editorconfig",".ejs",".el",".elm",".eml",".erb",".erl",".ex",".expect",".exs",".f",".f03",".f08",".f77",".f90",".f95",".fish",".ftl",".gcloudignore",".gitattributes",".gitignore",".gitmodules",".go",".gql",".gradle",".graphql",".groovy",".gv",".h",".haml",".hbs",".hcl",".hh",".hpp",".hrl",".hs",".htaccess",".htm",".html",".hxx",".ics",".inc",".inf",".ini",".ipynb",".ixx",".j2",".jade",".java",".jinja",".jinja2",".jl",".js",".json",".json5",".jsonc",".jsx",".ksh",".kt",".kts",".latex",".leex",".less",".lhs",".liquid",".lisp",".lock",".log",".lua",".m",".makefile",".map",".markdown",".md",".mdx",".mermaid",".mjs",".ml",".mli",".mll",".mly",".mm",".mmd",".mustache",".nfo",".nim",".nims",".njk",".ninja",".npmignore",".npmrc",".nvmrc",".org",".pas",".php",".pl",".plantuml",".plist",".pm",".po",".pot",".pp",".properties",".proto",".ps1",".psd1",".psm1",".psv",".pug",".puml",".py",".pyw",".r",".rb",".rct",".re",".rei",".rego",".rendered",".res",".resi",".rkt",".rmd",".rs",".rst",".rss",".s",".sass",".scala",".scheme",".scm",".scss",".sed",".service",".sh",".shtml",".slim",".srt",".ssa",".sql",".styl",".svelte",".svg",".swift",".t",".target",".tcl",".tex",".tf",".tfvars",".thrift",".toml",".tpl",".ts",".tsv",".tsx",".twig",".txt",".vb",".vba",".vbs",".vtt",".vue",".xhtml",".xml",".xsd",".xsl",".xslt",".yaml",".yang",".yar",".yara",".yarnrc",".yml",".zig",".zprofile",".zsh",".zshrc"];function _l(n){let e=n.lastIndexOf(".");if(e===-1)return!!dw.some(s=>n.endsWith(s));let t=n.substring(e).toLowerCase();return _w.includes(t)}r(_l,"is_text_file");function rj(n){let e=n.startsWith("/"),t=e?n.slice(1):n,s=t.endsWith("/");if(s&&(t=t.slice(0,-1)),!t)return[];let i=t.includes("/"),o=t.includes("*"),a=[];return s?e?(a.push(`/${t}`),a.push(`/${t}/**`),a):i?(a.push(t),a.push(`${t}/**`),e||(a.push(`**/${t}`),a.push(`**/${t}/**`)),a):(a.push(t),a.push(`${t}/**`),a.push(`**/${t}`),a.push(`**/${t}/**`),a):!e&&!i?(o?(a.push(t),a.push(`**/${t}`)):(a.push(t),a.push(`${t}/**`),a.push(`**/${t}`),a.push(`**/${t}/**`)),a):e?(a.push(`/${t}`),o&&a.push(`/${t}`),a):(a.push(t),a.push(`**/${t}`),a)}r(rj,"expand_pattern");function uw(n,e,t=[]){n=n.replace(/\\/g,"/"),e=[...new Set([...e,"**/.git/**",".git/**","**/node_modules/**","node_modules/**","package-lock.json"])];for(let s of e){let i=rj(s);for(let o of i)if(lw(o,n,{case_sensitive:!0}))return t.push(o),!0}return!1}r(uw,"should_ignore");var aj=[".git","node_modules","package-lock.json",".obsidian",".smart-env"],mw=1e3,cj=50,Io=new Map;function lj(n){let e=new Set,t=[];for(let s of n)s&&(e.has(s)||(e.add(s),t.push(s)));return t}r(lj,"unique_strings");function dj(n){let e=new Set;for(let t of n){if(!t||t.startsWith("!")||/[\*\?\[\]\{\}]/.test(t))continue;let s=t.replace(/\\/g,"/").trim();if(!s)continue;let i=s.endsWith("/**")?s.slice(0,-3):s;i.includes("/")||e.add(i)}return e}r(dj,"build_ignore_name_set");function Mo(n,e,t=[]){let s=[],i=ul.default.relative(e||n,n).replace(/\\/g,"/"),o=pw(n,".gitignore"),a=pw(n,".scignore");t=lj([...t,...o,...a,...aj]);let c=dj(t),l=!1,d=[{dir:n,root_rel_dir:""}];for(;d.length>0;){if(s.length>=mw){l||(l=!0,console.warn("get_context_items_in_external_folder: max 1000 items reached, stopping scan"));break}let{dir:_,root_rel_dir:m}=d.pop(),p;try{p=(0,vt.readdirSync)(_,{withFileTypes:!0})}catch{continue}for(let f of p){if(s.length>=mw)break;if(c.has(f.name))continue;let y=m?`${m}/${f.name}`:f.name;if(uw(y,t))continue;let g=ul.default.join(_,f.name);if(f.isDirectory()){d.push({dir:g,root_rel_dir:y});continue}if(!_l(g))continue;let w=(0,vt.statSync)(g),b=i?`${i}/${y}`:y;s.push({key:`external:${b}`,size:w.size,mtime:w.mtimeMs,folder:i,ctx_codeblock:!0})}}return s}r(Mo,"get_context_items_in_external_folder");function pw(n,e){let t=ul.default.join(n,e);if(!(0,vt.existsSync)(t))return[];let s;try{s=(0,vt.statSync)(t).mtimeMs}catch{return[]}let i=Io.get(t);if(i&&i.mtime_ms===s)return i.patterns;let o=[];try{let c=(0,vt.readFileSync)(t,"utf-8").split(`
`);for(let l of c){let d=l.trim();if(d&&!d.startsWith("#")){if(!d.includes(".")&&!d.includes("/")&&!d.includes("*")){o.push(`${d}/**`);continue}o.push(d)}}}catch{return[]}for(Io.set(t,{mtime_ms:s,patterns:o});Io.size>cj;){let a=Io.keys().next().value;Io.delete(a)}return o}r(pw,"load_ignore_file");function gw(n,e,t={}){let s=t.get_stat||fw.statSync,i=t.scan_folder||Mo,o=aw(n),a=n.split(`
`).map(d=>d.trim()).filter(Boolean),c=a.filter(d=>d.startsWith("!")).map(d=>d.slice(1).trim().replace("../","**/"));c.push(".*");let l=[];for(let d of a)if(d.startsWith("../")){let _=hw.default.join(e,d),m;try{m=s(_)}catch{console.warn("smart-context: missing path in codeblock",_);continue}if(m.isDirectory()){let p=i(_,e,c);for(let f of p)l.push({...f,ctx_codeblock:!0})}else l.push({key:"external:"+d,size:m.size,mtime:m.mtimeMs,ctx_codeblock:!0})}else d.startsWith("!../")?l.push({key:"external:"+d.slice(1),exclude:!0,ctx_codeblock:!0}):l.push({key:d,ctx_codeblock:!0});return{cb_hash:o,context_items:l,ignore_patterns:c}}r(gw,"parse_codeblock_to_context_items");async function bw(n){let e=n.env;n.registerMarkdownCodeBlockProcessor("smart-context",async(t,s,i)=>{let o=i?.sourcePath;if(!o)return;let a=e.smart_contexts.get(o+"#codeblock");a||(a=e.smart_contexts.new_context({key:o+"#codeblock"}));let c=(0,yw.normalizePath)(n.app.vault.adapter.basePath),{cb_hash:l,context_items:d}=gw(t,c);a._cb_hash!==l&&(a._cb_hash=l,a.data.context_items={},a.add_items(d));try{e.smart_components.render_component("context_codeblock",a).then(p=>{s.empty(),s.appendChild(p)})}catch(p){console.error("smart-context render error",p),s.createEl("pre",{text:p.message})}a._dispose_codeblock_listener&&a._dispose_codeblock_listener();let _=typeof i?.replaceCode=="function",m=s;a._dispose_codeblock_listener=a.on_event("context:updated",async()=>{a._cb_update_timeout&&clearTimeout(a._cb_update_timeout),a._cb_update_timeout=setTimeout(()=>{if(a._cb_update_timeout=null,!m.isConnected||!_)return;let f=Object.entries(a.data.context_items).map(([y,g])=>g.folder&&!g.exclude?g.folder:g.exclude?`!${g.key.replace("external:","")}`:y.replace("external:","")).filter((y,g,w)=>w.indexOf(y)===g).join(`
`)+`
`;try{i.replaceCode(f)}catch(y){console.error("smart-context: replaceCode failed",y)}},200)})})}r(bw,"register_smart_context_codeblock");var sE=require("obsidian");var ml=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var pl=class extends ml{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Tn=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new pl(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};function kt(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(vw(e[t])&&vw(n[t])?kt(n[t],e[t]):n[t]=e[t]);return n}r(kt,"deep_merge");function vw(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(vw,"is_plain_object");function Nn(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(Nn,"camel_case_to_snake_case");function hl(n,e){let t=kw(n),s=kw(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(hl,"compare_versions");function kw(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(kw,"normalize_version_value");function Lo(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Lo,"is_plain_object");function ks(n,e,t=[]){if(!Lo(n)||!Lo(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Lo(i)?(Lo(n[s])||(n[s]={}),ks(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(ks,"deep_merge_no_overwrite");function tt(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(hl(d,_)>0){let p={...c};ks(p,l),n.collections[a]=p}else ks(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;hl(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):ks(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),ks(n[i],o)):n[i]=o}return n}r(tt,"merge_env_config");var yee=typeof globalThis<"u"?globalThis:Function("return this")();function uj(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=pj(n,t),o=mj(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(uj,"create_regex");function mj(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(mj,"adjust_for_windows_paths");function pj(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(pj,"glob_to_regex_pattern");function ww(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:uj(n,s)}r(ww,"glob_to_regex");function xw(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(xw,"fuzzy_search");var fl=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(ww(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return xw(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var hj=P(require("obsidian"),1);var gl=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=hj,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function yl(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(yl,"empty");var Ew=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var Aw=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var fj=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,bl=r((n,e)=>{let t=e.trim();(fj.test(t)?Aw:Ew)(n,t)},"safe_inner_html");function Me(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(Me,"escape_html");function Sw(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Pn(l,o),l=Fp(l,15),l=Pn(l,a),i^=l,i=Fp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Pn(l,o),l=Fp(l,15),l=Pn(l,a),i^=l;break}return i^=n.length,i=gj(i),i|0}r(Sw,"murmur_hash_32");function se(n,e=0){return(Sw(n,e)>>>0).toString(36)}r(se,"murmur_hash_32_alphanumeric");function Pn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Pn,"multiply_32");function Fp(n,e){return n<<e|n>>>32-e}r(Fp,"rotate_left_32");function gj(n){return n^=n>>>16,n=Pn(n,2246822507),n^=n>>>13,n=Pn(n,3266489909),n^=n>>>16,n|0}r(gj,"fmix_32");function Bp(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(Bp,"convert_to_time_ago");function ws(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(ws,"cos_sim");function we(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(we,"get_by_path");function xe(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(xe,"set_by_path");function Up(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(Up,"delete_by_path");function Wp(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(Wp,"compute_centroid");function Gp(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let m=Math.sqrt(_);s[a]+=m,s[l]+=m}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(Gp,"compute_medoid");var vl=new WeakMap,kl=new WeakMap,wl=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return we(e,t,s)}set_by_path(e,t,s,i=null){xe(e,t,s,i)}delete_by_path(e,t,s=null){Up(e,t,s)}escape_html(e){return Me(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||kl.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");kl.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=kl.get(i);c&&(i.removeEventListener("change",c),kl.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=se(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){yl(e)}safe_inner_html(e,t){bl(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=vl.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},vl.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(m){console.error("[smart-view] disposer error",m)}}finally{try{l.disconnect()}catch{}vl.get(e)===c&&vl.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var xl=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(m=>{let p=l.addOption(m.value,m.label??m.name??m.value);p.selected=m.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let m=l.addOption(_.value,_.label??_.name??_.value);m.selected=_.value===s,c.length===1&&m.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,m=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(m),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let w=document.createElement("div");w.className="array-item-row";let b=document.createElement("input");b.type="text",b.value=y,b.placeholder="Value";let k=document.createElement("button");k.textContent="\u2715",k.title="Remove",b.addEventListener("change",()=>{c[g]=b.value,f()}),k.addEventListener("click",()=>{c.splice(g,1),d(),f()}),w.appendChild(b),w.appendChild(k),l.appendChild(w)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=m.value.trim();y&&(c.push(y),m.value="",d(),f())}),_.appendChild(m),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,w],b)=>{let k=document.createElement("div");k.className="json-pair-row";let C=document.createElement("input");C.type="text",C.value=g,C.placeholder="Property";let O=document.createElement("input");O.type="text",O.value=w,O.placeholder="Value";let j=document.createElement("button");j.textContent="\u2715",j.title="Remove",C.addEventListener("change",()=>{let $=C.value.trim();$&&$!==g&&(c[$]=c[g],delete c[g],d(),y())}),O.addEventListener("change",()=>{c[C.value]=O.value,y()}),j.addEventListener("click",()=>{delete c[C.value],d(),y()}),k.appendChild(C),k.appendChild(O),k.appendChild(j),l.appendChild(k)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=m.value.trim();!g||g in c||(c[g]=p.value,m.value="",p.value="",d(),y())}),_.appendChild(m),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){yl(e)}safe_inner_html(e,t){bl(e,t)}};var st=require("obsidian");var El=class extends xl{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return st.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new st.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await st.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,st.getIcon)(e).outerHTML}is_mod_event(e){return st.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function Al(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Al,"collection_instance_name_from");function Cw(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Cw,"create_uid");function Sl(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Sl(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Sl(n[o],e[o],t))}return n===e}r(Sl,"deep_equal");function Cl(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(Cl,"get_item_display_name");function Ol(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let v of Reflect.ownKeys(u)){let S=Object.getOwnPropertyDescriptor(u,v);if(!S)continue;let E={...S};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let v=!1;for(let S of h){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E){let q=E.value;if(c(q)){v=!0;continue}if(s(q)){if(_(q)){v=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),v=new Map;for(let S of Reflect.ownKeys(u)){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E&&_(E.value)){v.set(S,d(E.value));continue}try{Object.defineProperty(h,S,m(E))}catch{h[S]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),w=Object.create(null),b=r((u,h,v=[])=>{if(!u||!h)return;let S=new Set([...l,...v]);for(let E of Reflect.ownKeys(u)){if(S.has(E))continue;let q=Object.getOwnPropertyDescriptor(u,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),k=r(u=>{let h=new u(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let S=v.bind(h);return b(u,S),b(h,S),S.instance=h,S}return b(u,h),h},"instantiate_class"),C=r(u=>{if(o(u))return k(u);if(a(u)){let h=u.action.bind(n);return b(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return b(u,h),h}return s(u)?d(u):u},"bind_or_clone"),O=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),j=r((u,h,v)=>(u[h]=v,v),"cache_result"),$=r((u,h)=>{let v=O();return v&&g(v,h)?j(u,h,C(v[h])):g(f,h)?j(u,h,C(f[h])):j(u,h,void 0)},"compute_and_cache"),A=r(()=>{let u=O(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(u)for(let v of Reflect.ownKeys(u))h.add(v);return Array.from(h)},"union_keys"),x=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(w,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:$(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let v=O();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>A(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return x(u,h);let v=O();if(v&&g(v,h)||g(f,h))return g(u,h)||$(u,h),x(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,v)=>"value"in v?(u[h]=v.value,!0):!1,"defineProperty"),set:r((u,h,v)=>(u[h]=v,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(Ol,"create_actions_proxy");var ne=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&kt(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Cw(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return kt(s,t),!Sl(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Ol(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Al(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Al(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Nn(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Cl(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var yj=Object.getPrototypeOf(async function(){}).constructor,ie=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof yj?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return kt(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Ol(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var ql=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},$l=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function jl(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=Ow(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=Ow(n.results);n.min=s,n.minResult=i}}r(jl,"results_acc");function $w(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=qw(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=qw(n.results);n.max=s,n.maxResult=i}}r($w,"furthest_acc");function Ow(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(Ow,"find_min");function qw(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(qw,"find_max");function Le(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Le,"sort_by_score");function Tl(n,e){return Le(n,e)}r(Tl,"sort_by_score_descending");function jw(n,e){return Le(n,e)*-1}r(jw,"sort_by_score_ascending");var Nl=class extends ql{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:ws(e,a.vec)};return jl(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(Tl)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:ws(e,a.vec)};return $w(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(jw)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},Pl=class extends $l{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var bj="---frontmatter---",Tw=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),vj=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),kj=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),wj=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(bj),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),xj=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=Tw(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=Tw(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),Hp=r((n,e={})=>{let t=vj(n,e),s=kj(t),i=wj(s);return xj(i,n)},"create_find_connections_filter_opts");async function In(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=Hp(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+se(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Le).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(In,"find_connections");In.action_type="connections";var xs=class extends ne{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new Pl(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Es=class extends ie{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Nl(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let m=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!m[f.item.path]||f.score>m[f.item.path].score?m[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=m[f.item.path].score}),m},Promise.resolve({})),c=Object.values(a).sort(Le).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return Nw}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return Ej}},Nw={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},Ej={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function Jp(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await In.call(this,n);let o=Hp(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+se(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Le).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Le).slice(0,s)}return i}r(Jp,"find_connections");Jp.action_type="connections";var Mn=class extends xs{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=Wp(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=Gp(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},Pw={class:Mn,actions:{find_connections:Jp}};var zo=class extends Es{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let m=await _.search(e);return m?(this.search_results_ct++,{item:_,score:m}):null}catch(m){return console.error(`Error searching item ${_.id||"unknown"}:`,m),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Le)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(Aj),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},Aj={};var Il=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Do;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Do=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Ml=class extends Il{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Ro;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Ro=class extends Do{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var Iw={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Rt=class extends Ml{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=wt;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},wt=class extends Ro{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return Iw[s]&&(s=Iw[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Fo=class extends Rt{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=Kp},Kp=class extends wt{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var Ll=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return se(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return Mw(this.constructor.name)}static get adapter_key(){return Mw(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function Mw(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(Mw,"to_snake");function zl(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},m={},p=[],f={},y=null,g=null,w=!1,b=!1,k="#",C=!1,O=[],j=null;_[k]=0;for(let A=0;A<i.length;A++){let x=A+t,u=i[A],h=u.trim();if(h==="---"){if(!b&&x===1){b=!0,w=!0,l["#---frontmatter---"]=[x,null];continue}else if(w){w=!1,l["#---frontmatter---"][1]=x;continue}}if(w)continue;if(!C&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(u)&&f.incomplete.top.push(x)),h.startsWith("```")){if(C=!C,C&&!j?j=x:!C&&j&&(O.push([j,x]),j=null),!g){let E=c.length>0?c[c.length-1].key:k;if(E===k&&!l[k]&&(l[k]=[x,null]),E===k)g={key:k,start_line:x},(l[k][1]===null||l[k][1]<x)&&(l[k][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],T=`${E}#{${q}}`;l[T]=[x,null],g={key:T,start_line:x}}}continue}let v=h.match(/^(#{1,6})\s*(.+)$/);if(v&&!C){let E=v[1].length,q=v[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let Z=c.pop();l[Z.key][1]===null&&(l[Z.key][1]=x-1)}c.length===0&&l[k]&&l[k][1]===null&&(l[k][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let T="",N=0;if(c.length>0?(T=c[c.length-1].key,N=c[c.length-1].level):(T="",N=0),c.length===0)d[q]=(d[q]||0)+1,d[q]>1&&(q+=`[${d[q]}]`);else{m[T]||(m[T]={}),m[T][q]=(m[T][q]||0)+1;let Z=m[T][q];Z>1&&(q+=`#{${Z}}`)}let Y=E-N,H="#".repeat(Y),$e=T+H+q;l[$e]=[x,null],_[$e]=0,c.push({level:E,title:q,key:$e});continue}let S=u.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(S&&!C){if(S[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null),g&&g.key!==k&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let q=c.length>0?c[c.length-1].key:k;q===k&&!l[k]&&(l[k]=[x,null]),_[q]===void 0&&(_[q]=0),_[q]+=1;let T=_[q],N;if(s){let Y=S[3].replace(/^\[(?: |x|X)\]\s*/,""),H=Sj(Y,o);N=`${q}#${H}`}else N=`${q}#{${T}}`;l[N]=[x,null],y={key:N,start_line:x};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let E=c.length>0?c[c.length-1].key:k;if(E===k)l[k]||(l[k]=[x,null]),(l[k][1]===null||l[k][1]<x)&&(l[k][1]=null),g={key:k,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],T=`${E}#{${q}}`;l[T]=[x,null],g={key:T,start_line:x}}}}let $=i.length;for(;c.length>0;){let A=c.pop();l[A.key][1]===null&&(l[A.key][1]=$+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=$+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=$+t-1),g=null),l[k]&&l[k][1]===null&&(l[k][1]=$+t-1);for(let A in l)a[A]=l[A];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:O}}r(zl,"parse_markdown_blocks");function Sj(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(Sj,"get_longest_words_in_order");var nt=class extends Ll{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=zl(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let m=this.item.block_collection.get(_.key);s==="replace_blocks"?await m.update(_.content):await m.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],m=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:m,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:m,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let w=this.item.block_collection.get(m);if(await this.create_hash(p)!==w.last_read?.hash){o.push({key:m,state:"changed",content:p});continue}a.push({key:m,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function Ft(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),m={title:c,target:l,line:d};_&&(m.embedded=!0),e.push(m)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,m=o(a.index),p={title:l,target:d,line:_};m&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(Ft,"get_markdown_links");function Dl({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=Ft(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(Dl,"get_bases_cache_links");function Vp(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(Vp,"parse_value");function Cj(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=Vp(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let m=_.trim().slice(2);l.push(Vp(m)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=Vp(c)}return t}r(Cj,"parse_yaml_block");function Lw(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=Cj(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(Lw,"parse_frontmatter");var zw=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Bo=class extends nt{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=Ft(e),s=Dl({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=Lw(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),zw(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Bt=require("obsidian");function Oj(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(Oj,"merge_tags");var As=class extends Bo{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=Oj(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!Bt.MarkdownRenderer||!Bt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Bt.MarkdownRenderer.render(s,t,i,this.item.path,new Bt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(m=>setTimeout(m,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Bt.htmlToMarkdown)(i)}};var Rl=class extends nt{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var Fl=class extends nt{static{r(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function qj({content:n}={}){if(!n)return null;try{return JSON.parse(n)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}r(qj,"parse_canvas_json");function Dw({target:n,title:e}={}){return n?{title:e||n,target:n,line:1}:null}r(Dw,"build_link_record");function $j({node:n}={}){if(!n||typeof n!="object")return[];if(n.type==="text"&&typeof n.text=="string")return Ft(n.text);if(n.type==="file"&&typeof n.file=="string"){let e=typeof n.subpath=="string"?n.subpath:"",t=`${n.file}${e}`,s=Dw({target:t,title:n.file});return s?[s]:[]}if(n.type==="link"&&typeof n.url=="string"){let e=Dw({target:n.url,title:n.url});return e?[e]:[]}return[]}r($j,"get_canvas_node_links");function jj({nodes:n=[]}={}){return Array.isArray(n)?n.reduce((e,t)=>(e.push(...$j({node:t})),e),[]):[]}r(jj,"get_canvas_links_from_nodes");function Tj({content:n}={}){let e=qj({content:n});return e?.nodes?jj({nodes:e.nodes}):[]}r(Tj,"get_canvas_links");var Bl=class extends nt{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=Tj({content:e});let t=this.item.file?.stat,s=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:s,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var Ul=class extends As{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function Rw(n,e){let[t,...s]=n.split("#").filter(Boolean),i=Cl(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(Rw,"get_block_display_name");var Ln=class extends xs{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return Rw(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},Fw={class:Ln,actions:{find_connections:In}};var Uo=class extends Es{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var Wl=class extends Rt{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=Xp;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},Xp=class extends wt{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var Gl=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return se(e)}};function Hl(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(Hl,"get_line_range");var zn=class extends Gl{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return Hl(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var Dn=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Wo=class extends Dn{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var Rn=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Ss=class extends Rn{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var it=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var Fn=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},Bn=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var Un=class extends Fn{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new Yp(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},Yp=class extends Bn{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Cs=class extends Fn{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new Zp(i)}},Zp=class extends Bn{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var Gw=P(Ww(),1);var Rj=Object.defineProperty,Fj=r((n,e,t)=>e in n?Rj(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),Bj=r((n,e,t)=>(Fj(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function Uj(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(Uj,"bytePairMerge");function Wj(n,e){return n.length===1?[e.get(n.join(","))]:Uj(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(Wj,"bytePairEncode");function Gj(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(Gj,"escapeRegex");var eh=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=Gw.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=eh.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=eh.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let m=d?.index??n.length;for(let f of n.substring(l,m).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...Wj(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},Kl=eh;Bj(Kl,"specialTokenRegex",n=>new RegExp(n.map(e=>Gj(e)).join("|"),"g"));async function Jw(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await Hw(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await Hw(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(Jw,"fetch_json_cached");async function Hw(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(Hw,"do_fetch");function sh(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(sh):e==="object"?Object.values(n).every(sh):!1}r(sh,"is_json_compatible");function Vl(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||sh(i)&&(t[s]=i);return t}r(Vl,"extract_json_details");function Go(n){return Object.keys(n).length===0}r(Go,"is_empty_object");function Hj(n,e){return Go(n)?e:Go(e)?n:{...n,...e}}r(Hj,"merge_details");function th(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(th,"get_message_from_object");function V(n,e=null){if(Array.isArray(n)&&n.length>0)return V(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Vl(n,["message"]);return{message:t,details:Go(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=th(o),c=Vl(o,["message"]),l=Vl(t,["message","error"]),d=Hj(l,c);return{message:a||th(t)||"Unknown error",details:Go(d)?null:d,http_status:e}}return V(i)}let s=th(t);if(s){let i=Vl(t,["message"]);return{message:s,details:Go(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(V,"normalize_error");var Jj="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",rt=class extends Ss{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return ze}get res_adapter(){return De}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new it({adapter:Cs})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:V(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await Jw(Jj,"cl100k_base.json");this.tiktoken=new Kl(e)}},ze=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},De=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Xl=class extends rt{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return nh}get res_adapter(){return ih}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},nh=class extends ze{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},ih=class extends De{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var Yl=class extends Ss{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var Zl=class extends Yl{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var Kw=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var Vw={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:oh};var oh={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},Xw={},rh={};var Wn=class extends Zl{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=Vw;constructor(e){super(e),this.connector=Kw.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...Xw}}get_models(){return Promise.resolve(this.models)}get models(){return oh}};var Ql=class extends rt{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return ah}get res_adapter(){return ch}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of Vj(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},ah=class extends ze{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},ch=class extends De{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},Kj=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),Vj=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(Kj)},"filter_embedding_models");var ed=class extends rt{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return lh}get res_adapter(){return dh}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},lh=class extends ze{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},dh=class extends De{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function Xj(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(Xj,"parse_lm_studio_models");var td=class extends rt{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return _h}get res_adapter(){return uh}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return Xj(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},_h=class extends ze{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},uh=class extends De{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Ho=class extends Dn{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw V(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var sd=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var nd=class extends Rn{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var Gn={},Ut={data:null,fetched_at:0},R=class extends nd{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return F}get res_adapter(){return M}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new it({adapter:Cs})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Ut.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=V(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new sd(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=V({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=V(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=V(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Ut?.data&&t-Ut?.fetched_at<e)return Ut.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Ut.data=o,Ut.fetched_at=t,console.log({MODELS_DEV_CACHE:Ut}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Ut.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return Gn[this.constructor.key]||(Gn[this.constructor.key]={}),Gn[this.constructor.key]}set model_data(e){Gn[this.constructor.key]||(Gn[this.constructor.key]={}),Gn[this.constructor.key]=e}},F=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},M=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:V(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Jo=class extends R{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Ko}res_adapter=Vo;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Ko=class extends F{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Vo=class extends M{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:V(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var Yj=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],qs=class extends R{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=mh;parse_model_data(e){return e.data.filter(t=>!Yj.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:Zj(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function Zj(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(Zj,"get_max_input_tokens");var mh=class extends M{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Xo=class extends qs{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var Hn=class extends R{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Yo;res_adapter=Zo;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Yo=class extends F{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Zo=class extends M{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:V(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},Qo=class extends Hn{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var er=class extends R{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return ph}get res_adapter(){return hh}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},ph=class extends F{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},hh=class extends M{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var tr=class extends R{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return sr}get res_adapter(){return nr}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},sr=class extends F{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},nr=class extends M{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var ir=class extends R{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=or;res_adapter=rr;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},or=class extends F{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},rr=class extends M{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:V(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var fh={openai:{req:F,res:M},anthropic:{req:Ko,res:Vo},gemini:{req:Yo,res:Zo},lm_studio:{req:sr,res:nr},ollama:{req:or,res:rr}},ar=class extends R{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=fh[e];return t&&t.req?t.req:F}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=fh[e];return t&&t.res?t.res:M}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(fh).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var cr=class extends R{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return gh}get res_adapter(){return yh}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},gh=class extends F{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},yh=class extends M{static{r(this,"SmartChatModelGroqResponseAdapter")}};var lr=class extends R{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return F}get res_adapter(){return M}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var dr=class extends R{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return bh}get res_adapter(){return vh}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},bh=class extends F{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},vh=class extends M{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var Jh=require("obsidian");function Yw(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=zl(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),m=Hl(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===m.length&&_.vec)continue;let p=Ft(m),f=Dl({source:n,links:p}),y={key:d,lines:l,size:m.length,outlinks:[...p,...f],last_read:{at:a,hash:se(m)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new n.block_collection.item_type(n.env,y);n.block_collection.set(g)}else _.data={..._.data,...y}}Qj(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(Yw,"parse_blocks");function Qj(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(Qj,"clean_and_update_source_blocks");function kh(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():Zw(a)?n[o]=kh(Zw(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(kh,"ajson_merge");function Zw(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(Zw,"is_object");var Qw={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function eT(n){let e=!1,[t,...s]=n.split(":");return Qw[t]&&(t=Qw[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(eT,"_parse_ajson_key");var Wt=class extends Rt{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:w}=eT(p),b=`${y}:${g}`;f?(i[b]=f,(w||b!==p)&&(delete i[p],t=!0)):(delete i[b],(w||b!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=kh(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},wh=class extends wt{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},_r={collection:Wt,item:wh};var ur=class extends ne{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function tT(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(tT,"parse_component_properties");async function sT(n,e){let{scope_key:t,component_key:s}=tT(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await se(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(sT,"build_component_data");var id=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await sT(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var od=class extends id{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function ex(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&ex(i,o,t)}}),t}r(ex,"flatten_components_config");var rd=class extends ie{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=ex(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},tx={class:rd,item_type:ur,data_adapter:_r,component_adapters:{SmartViewComponentAdapter:od}};var sx=tx;function nx(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(nx,"filter_redundant_context_items");var ix=r((n,e)=>!e||!n?.[e]?!1:n[e].folder?n[e].exclude?!1:(n[e].exclude=!0,!0):(delete n[e],!0),"remove_context_item_data"),mr=class extends ne{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:s=!0}=t;ix(this.data.context_items,e)&&(this.queue_save(),s&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:s=!0}=t,i=Array.isArray(e)?e:[e],o=[];return i.forEach(a=>{ix(this.data.context_items,a)&&o.push(a)}),o.length?(this.queue_save(),s&&this.emit_event("context:updated",{removed_keys:o}),o):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return nx(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var ad=class extends ie{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var nT={class:ad,data_adapter:Wt,item_type:mr};var ox=nT;var cd=class extends ne{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var at=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var ld=class extends at{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var dd=class extends at{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var rx=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var _d=class extends at{static{r(this,"ImageContextItemAdapter")}static detect(e){return rx.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var ud=class extends at{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var xh=class extends ie{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},ax={version:1,class:xh,collection_key:"context_items",item_type:cd,context_item_adapters:{BlockContextItemAdapter:ld,SourceContextItemAdapter:dd,ImageContextItemAdapter:_d,PdfContextItemAdapter:ud}};function cx(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(cx,"next_log_stats");var Jn=class extends ne{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var iT={"collection:save_started":!0,"collection:save_completed":!0},Eh=class extends ie{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return Jn}init(){this.env?.events||Tn.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!iT[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new Jn(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=cx({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},lx={class:Eh,collection_key:"event_logs",data_adapter:Wt,item_type:Jn};var Kn=require("obsidian");function dx(n,e={}){if(!n)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],s=n?.env?.config?.actions||{},i=n?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(s[c]||{}).display_name||c;return a.push({select_action:r(()=>{n.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}r(dx,"build_suggest_scope_items");var _x=r((n,e={})=>{let t=n?.inputEl,s=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(s===t&&i)},"should_handle_arrow_left");var md=class extends Kn.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,o=_x(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&o){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return dx(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,Kn.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=Kn.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var lle=require("obsidian");var pd=class extends md{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var ux=require("obsidian");var hd=class extends ux.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var gd=require("obsidian");var oT="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",fd=class extends gd.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){rT(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function rT(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),aT(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(oT,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r(rT,"render_milestones_modal_title");function aT(n){cT(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(aT,"render_help_icon");function cT(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,gd.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(cT,"set_icon_with_fallback");var mx={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var pr=class extends ne{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],m=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),m},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var yd=class extends ie{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function px(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(px,"settings_config");var $s=class extends pr{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Ah=class extends yd{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var lT={class:Ah,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:_r,item_type:$s,providers:{},settings_config:px},Sh=lT;var Ch=class extends Wn{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},hx={class:Ch,settings_config:rh};Sh.providers={transformers:hx};var fx=Sh;var Gt=class extends ne{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(jl(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(Tl);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var gx={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},Oh=class extends ie{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=dT(new Date),i=se(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new Gt(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...gx}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function dT(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(dT,"format_ymd");var yx={class:Oh,collection_key:"lookup_lists",item_type:Gt,settings_config:gx};function hr(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(hr,"format_collection_name");async function _T(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${hr(n.collection_key)}</h2>
${t}
</div></div></div>`}r(_T,"build_html");async function bx(n,e={}){let t=await _T.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(bx,"render");var Vn=require("obsidian");function vx(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(Vn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new Vn.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let m=d.hoverEl.querySelector(".markdown-preview-sizer");Vn.MarkdownRenderer.render(o,l,m,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(vx,"register_block_hover_popover");var kx=require("obsidian");function wx(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),kx.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):vx(n.parentElement,n,e.env,e.key)}r(wx,"register_item_hover_popover");var Ex=require("obsidian");function uT(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(uT,"format_score");function mT(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(mT,"format_size");function xx(n,e){return n?`<span class="${e}">${n}</span>`:""}r(xx,"build_badge_html");function pT(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=uT(n?.data?.score),i=mT(n?.size||n?.data?.size),o=xx(s,"sc-context-item-score"),a=xx(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(pT,"build_html");async function Ax(n,e={}){let t=pT(n,e),i=this.create_doc_fragment(t).firstElementChild;return hT.call(this,n,i,e),i}r(Ax,"render");async function hT(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${Ex.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),wx(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(hT,"post_process");async function fT(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${hr(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=yT(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(fT,"build_html");async function Sx(n,e={}){let t=await fT.call(this,n,e),s=this.create_doc_fragment(t);return await gT.call(this,n,s,e)}r(Sx,"render");async function gT(n,e,t={}){return e}r(gT,"post_process");function yT(n,e){let t=Object.values(n.items).length,s=hr(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=bT(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=vT(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(yT,"generate_collection_stats");function bT(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(bT,"get_generic_collection_stats");function vT(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(vT,"calculate_embed_coverage");var Cx=require("obsidian");function kT(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(kT,"build_html");async function qh(n,e={}){let t=kT.call(this,n,e),s=this.create_doc_fragment(t);return await wT.call(this,n,s,e)}r(qh,"render");async function wT(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new Cx.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=we(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(m=>{_.addOption(m.value,m.label)}),l.childNodes.forEach(m=>{m.value===c&&(m.selected=!0),o.find(p=>p.value===m.value)?.disabled&&(m.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):xe(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(wT,"post_process");qh.version=.2;var Ox=require("obsidian");function xT(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(xT,"build_html");function qx(n,e={}){let t=xT.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,Ox.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),ET.call(this,n,i,e),i}r(qx,"render");function ET(n,e){}r(ET,"post_process");var $x=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var Nx=require("obsidian");var $T=require("obsidian");var ST={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},bd={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},CT=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function $h(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=CT.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r($h,"derive_events_checklist_groups");function fr(n,e){let t=OT(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(fr,"check_if_event_emitted");function OT(n,e){let t=ST[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!qT(a)))return!0}return!1}r(OT,"resolve_plugin_install_event");function qT(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r(qT,"is_pro_manifest");function jT(n,e={}){let t=$h(bd),s=t.reduce((c,l)=>{let d=l.items.reduce((_,m)=>_+(fr(n,m.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((m,p)=>m+(fr(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(m=>{let p=fr(n,m.event_key)===!0;return NT(m,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Me(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Me(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Me(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(jT,"build_html");async function Px(n,e={}){this.apply_style_sheet($x);let t=jT.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return TT.call(this,n,i,e),i}r(Px,"render");async function TT(n,e,t={}){return PT(e),IT(e),e}r(TT,"post_process");function NT(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Me(n.event_key)}"
data-link="${Me(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${Me(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Me(n.milestone)}</span>
</div>
</li>
`}r(NT,"build_item_html");function PT(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=Tx(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||jx(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=Tx(n,e);s&&(e.preventDefault(),jx(s))}))}r(PT,"attach_item_link_listeners");function jx(n){let e=zT(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(jx,"open_item_link");function IT(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&MT(i,s)})}r(IT,"render_item_state_icons");function MT(n,e){LT(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(MT,"set_item_icon");function LT(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,Nx.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(LT,"set_icon_with_fallback");function Tx(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(Tx,"get_item_el_from_event");function zT(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=bd[t];return!s||typeof s.link!="string"?"":s.link}r(zT,"get_item_link");function DT(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}r(DT,"build_html");var jh=100,Th=100;function RT(n,e={}){let{limit:t=jh}=e;return n.slice(-t).reverse()}r(RT,"get_visible_entries");function FT(n,e={}){let{page_size:t=jh}=e;return Math.min(n,t)}r(FT,"get_visible_count");function BT(n,e={}){let{current_count:t=0,step_size:s=Th}=e;return Math.min(n,t+s)}r(BT,"get_next_visible_count");function UT(n,e){return n>e}r(UT,"should_show_load_more");async function Ix(n,e={}){let t=this.create_doc_fragment(DT()),s=t.firstElementChild;return WT.call(this,n,s,e),t}r(Ix,"render");async function WT(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),o=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(s);let c=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!c.length){let _=s.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",s.appendChild(_),o&&(o.style.display="none");return}let l=FT(c.length,{page_size:jh}),d=r(()=>{a.empty(s),RT(c,{limit:l}).forEach(_=>{JT(s,_)}),GT(o,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=s.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),o&&o.addEventListener("click",()=>{l=BT(c.length,{current_count:l,step_size:Th}),d()})}r(WT,"post_process");function GT(n,e={}){if(!n)return;let{entries_length:t=0,visible_count:s=0}=e,i=UT(t,s);if(n.style.display=i?"inline-block":"none",i){let o=t-s,a=Math.min(Th,o);n.textContent=`Load ${a} more`}}r(GT,"update_load_more_button");function HT(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(HT,"get_level");function JT(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=HT(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${KT(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(JT,"append_entry");function KT(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(KT,"to_time_ago");var Re=require("obsidian");var Xn=require("obsidian");function Yn(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Yn,"get_smart_server_url");function VT(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(VT,"try_get_zlib");function XT(n){let e=VT();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(XT,"inflate_deflate_data");async function Mx(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let w=new Uint8Array(n.slice(t,t+y)),b=new TextDecoder("utf-8").decode(w);t+=y,t+=g;let k=(l&8)!==0,C=t,O;if(!k)O=C+p;else{let A=C,x=!1;for(;A+4<=s;){let u=e.getUint32(A,!0);if(u===134695760||u===67324752||u===33639248){x=!0;break}A++}O=x?A:s}if(O>s)break;let j=new Uint8Array(n.slice(C,O));if(t=O,k&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let $;if(d===0)$=j;else if(d===8)$=XT(j);else continue;if(i.push({fileName:b,data:$}),b.toLowerCase().endsWith("manifest.json")&&!b.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode($))}catch{}}return{files:i,pluginManifest:o}}r(Mx,"parse_zip_into_files");function Lx(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(Lx,"validate_zip_buffer");async function zx(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(zx,"write_files_with_adapter");function Dx(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(Dx,"is_server_version_newer");async function Rx(n,e){let t=await(0,Xn.requestUrl)({url:`${Yn()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return Lx(t.arrayBuffer,"Smart Plugins server")}r(Rx,"fetch_plugin_zip");async function Fx(n,e=Xn.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return Lx(t.arrayBuffer,"Download")}r(Fx,"fetch_zip_from_url");async function Bx(n,e,t=Xn.requestUrl){let s=await t({url:`${Yn()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(Bx,"fetch_plugin_readme");async function Ux(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(Ux,"enable_plugin");function Wx(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(Wx,"get_oauth_storage_prefix");async function Gx(n){let e=await(0,Xn.requestUrl)({url:`${Yn()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(Gx,"fetch_server_plugin_list");async function Hx(n={}){let e=String(n.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,Xn.requestUrl)({url:`${Yn()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}r(Hx,"fetch_referral_stats");var Jx=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var ZT='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',QT='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function eN(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(eN,"derive_fallback_plugins");function tN(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${ZT}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${QT}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}r(tN,"build_html");async function Vx(n,e={}){this.apply_style_sheet(Jx);let t=tN.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await sN.call(this,n,i,e),i}r(Vx,"render");async function sN(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=Wx(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=eN(),_=0,m="",p=null,f=r(A=>{if(A){if(typeof this.empty=="function"){this.empty(A);return}A.innerHTML=""}},"empty_container"),y=r(A=>{if(!a||!A)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let u=document.createElement("div");u.classList.add("smart-plugins-login-manual-controls"),p.appendChild(u);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=A,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),u.appendChild(h);let v=document.createElement("button");v.classList.add("mod-cta"),v.textContent="Copy",v.addEventListener("click",async()=>{await Kx(A)?new Re.Notice("Copied login link to clipboard."):new Re.Notice("Copy failed. Please select and copy the link manually.")}),u.appendChild(v)},"render_manual_login_link"),g=r(async()=>{let A={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(u=>setTimeout(u,100));for(let u in x){if(!Object.prototype.hasOwnProperty.call(x,u))continue;let{name:h,version:v}=x[u];A[u]={name:h,version:v}}return A},"get_installed_info"),w=r(async()=>{_++,_>=2&&m&&y(m),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(m=nN()),new Re.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),b=r(()=>{if(this.empty(a),p=null,!(localStorage.getItem(o+"token")||"")){new Re.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await w()})});return}let x=new Re.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(u=>{u.setButtonText("Logout"),u.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new Re.Notice("Logged out of Smart Plugins"),b(),k(),j()})})},"render_oauth_login_section"),k=r(async(A={})=>{f(c);let x=String(A.token||"").trim();if(!x)return;let u=Number(A.sub_exp??0)||0;if(!(u&&u<Date.now()))try{let h=await Hx({token:x}),v=String(h?.referral_link||"").trim();if(!v)return;let S=new Re.Setting(c).setName("Referral link").setDesc("Share your link to give $30 off Pro and earn 30 days of Pro credit.");S.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let q=await Kx(v);new Re.Notice(q?"Referral link copied.":"Copy failed. Please try again.")})}),S.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),C=r(async()=>{if(this.empty(l),!(!l||d.length===0))for(let A of d){let x=await n.smart_components.render_component("pro_plugins_list_item",A,{env:n,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),O=r(()=>{let A=new Re.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");A.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),A.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),A.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),j=r(async()=>{this.empty(l);let A=localStorage.getItem(o+"token")||"";if(!A){await C(),await k();return}try{let x=await g(),u=await Gx(A),{list:h=[],unauthorized:v=[],sub_exp:S}=u;if(typeof S=="number"&&S<Date.now()){O(),await C(),await k();return}if(await k({token:A,sub_exp:S}),!Array.isArray(h)||h.length===0){await C();return}for(let E of h){let q=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,token:A,installed_map:x,on_installed:j});l.appendChild(q)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),$=r(async()=>{b(),await j()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{$()}),await $(),e}r(sN,"post_process");function nN(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${Yn()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(nN,"initiate_smart_plugins_oauth");var Kx=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var de=require("obsidian");var iN="https://smartconnections.app/pro-plugins/";function oN(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(oN,"build_html");function rN(n){return!n||!n.repo}r(rN,"is_fallback_item");function aN(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,Dx(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(aN,"compute_display_state");async function Xx(n,e={}){let t=oN(n,e),i=this.create_doc_fragment(t).firstElementChild;return await cN.call(this,n,i,e),i}r(Xx,"render");async function cN(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(rN(n)){let m=new de.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",m.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),m.controlEl.appendChild(p)}return m.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(iN,"_external")})}),m.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=aN(n,l),_=new de.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(m=>{m.setButtonText(d.button_label),m.setDisabled(d.is_disabled),m.onClick(()=>dN(n,{app:s,token:i,on_installed:a}))}),_.addButton(m=>{m.setButtonText("Docs"),n.docs_url?m.onClick(()=>window.open(n.docs_url,"_external")):m.onClick(()=>_N(n,{app:s,token:i,display_name:d.display_name}))}),e}r(cN,"post_process");var lN=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return Fx(t);if(!e)throw new Error("Login required to install this plugin.");return Rx(n.repo,e)},"download_plugin_zip"),dN=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new de.Notice(`Installing "${n.repo}" ...`);let o=await lN(n,s),{files:a,pluginManifest:c}=await Mx(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await zx(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await Ux(t,_),new de.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new de.Notice(`Install failed: ${o.message}`)}},"install_plugin"),_N=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await Bx(n.repo,s),a=new de.Modal(t);a.setTitle(i||n.name||n.repo),await de.MarkdownRenderer.render(t,o,a.contentEl,"",new de.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new de.Notice("Failed to load README")}},"show_plugin_readme");var Yx=require("obsidian");var js=class extends Yx.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var Zx=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var Qx=require("obsidian");function mN(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${t0(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(mN,"build_html");async function e0(n,e){this.apply_style_sheet(Zx);let s=this.create_doc_fragment(mN.call(this,n,e)).firstElementChild;return pN.call(this,n,s,e),s}r(e0,"render");async function pN(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,Qx.setIcon)(o,t0(n)),s.addEventListener("click",()=>{new js(n).open()}),i.addEventListener("click",()=>{new js(n,{test_on_open:!0}).open()}),e}r(pN,"post_process");function t0(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(t0,"get_test_result_icon_name");var n0=require("obsidian");var s0={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function vd(n,e,t={}){let s=(s0[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new n0.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new js(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(vd,"show_new_model_menu");var Qn=require("obsidian");function hN(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(hN,"ensure_settings_config");function Nh(n,e,t){let s=hN(n,e);return Object.entries(s||{}).reduce((i,[o,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][o]=a,i},{[t]:{}})}r(Nh,"build_settings_group_map");function Ph(n,e,t,s){return Nh(n,e,s)[t]||{}}r(Ph,"resolve_group_settings_config");var kd=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new Qn.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function wd(n,e,t,s={}){let{default_group_name:i="Settings"}=s,o=n,a=Nh(n,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),m={...s,...s.group_params?.[l]||{},settings_config_source:o};return Ih(l,e,d,_,m)})}r(wd,"render_settings_config");function Ih(n,e,t,s,i={}){let o=i.settings_config_source||t,a=i.settings_config_source?Ph(o,e,n,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=kd}catch{c=kd}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,y,g,w)=>{let b=Ph(y,f,p,w.default_group_name||"Settings");return Ih(p,f,b,g,w)}:Ih,_=fN(e,{container:s,group_name:n,settings_config:o,group_params:i,render_group:d}),m=new c(s);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)i0(m,e,p);else i0(m,e,l);m.setHeading(n);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let y=f.scope_class==="pro-setting",g=!!e.env?.is_pro;m.addSetting(w=>{switch(f.name&&w.setName(f.name),w.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&w.setClass(`setting-type-${f.type}`),f.description&&w.setDesc(f.description),f.type){case"button":w.addButton(b=>{b.setButtonText(f.name||"Run"),b.onClick(async k=>{typeof f.callback=="function"&&await Zn(w,k,f.callback,{scope:e})})});break;case"toggle":w.addToggle(b=>{b.setValue(we(e.settings,p)||!1),b.onChange(k=>{xe(e.settings,p,k),typeof f.callback=="function"&&Zn(w,k,f.callback,{scope:e})})});break;case"text":w.addText(b=>{b.setValue(String(we(e.settings,p)||"")),b.onChange(k=>{xe(e.settings,p,k)})});break;case"number":w.addText(b=>{b.setValue(String(we(e.settings,p)??"0")),b.inputEl.setAttribute("type","number"),b.onChange(k=>{let C=Number(k);isNaN(C)||xe(e.settings,p,C),typeof f.callback=="function"&&Zn(w,C,f.callback,{scope:e})})});break;case"dropdown":w.addDropdown(b=>{let k=f.options_callback;typeof k=="function"&&k.call(e,e).forEach(O=>{let j=O.label||O.name||O.value;b.addOption(O.value,j)}),b.setValue(we(e.settings,p)||""),b.onChange(C=>{xe(e.settings,p,C),typeof f.callback=="function"&&Zn(w,C,f.callback,{scope:e}),_()})});break;case"textarea":w.addTextArea(b=>{b.setValue(String(we(e.settings,p)||"")),b.onChange(k=>{if(y&&!g){new Qn.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}xe(e.settings,p,k)}),y&&!g&&b.setDisabled(!0)});break;case"slider":w.addSlider(b=>{let k=f.min||0,C=f.max||100,O=f.step||1;b.setLimits(k,C,O),b.setValue(we(e.settings,p)||k),b.setDynamicTooltip(),b.onChange(j=>{xe(e.settings,p,j),typeof f.callback=="function"&&Zn(w,j,f.callback,{scope:e})})});break;case"heading":w.setHeading();break;case"html":f.value&&w.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&w.settingEl.addClass(f.scope_class)})}return m}r(Ih,"render_settings_group");function i0(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,Qn.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await Zn(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(i0,"render_heading_button");async function Zn(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(Zn,"handle_config_callback");function fN(n,e={}){let{container:t,group_name:s,settings_config:i,group_params:o={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(s,n,i,t,o))}r(fN,"create_settings_group_rerender");function gN(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(gN,"build_html");async function o0(n,e){let s=this.create_doc_fragment(gN.call(this,n,e)).firstElementChild;return yN.call(this,n,s,e),s}r(o0,"render");async function yN(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=wd(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{vd(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(yN,"post_process");function bN(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(bN,"build_html");async function r0(n,e){let s=this.create_doc_fragment(bN(n,e)).firstElementChild;return vN.call(this,n,s,e),s}r(r0,"render");async function vN(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(vN,"post_process");var l0=require("obsidian");function xd(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(xd,"ensure_smart_sources_settings");function gr(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(gr,"parse_exclusions_csv");function a0(n,e){let t=(e??"").trim();if(!t)return n||"";let s=gr(n);return s.includes(t)||s.push(t),s.join(",")}r(a0,"add_exclusion");function c0(n,e){let t=(e??"").trim();return t?gr(n).filter(i=>i!==t).join(","):n?.trim()||""}r(c0,"remove_exclusion");var Ed=class extends l0.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=xd(this.env),t=gr(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=xd(this.env);t.folder_exclusions=a0(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=xd(this.env),t=gr(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=c0(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var d0=require("obsidian");var Ad=class extends d0.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function kN(n,e={}){return`
<div class="sources-settings">
</div>
`}r(kN,"build_html");async function _0(n,e={}){let t=await kN.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return wN.call(this,n,i,e),i}r(_0,"render");async function wN(n,e,t={}){wd({folder_exclusions:EN,view_exclusions:AN,re_import_sources:SN},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",xN(n,e))),this.attach_disposer(e,i),e}r(wN,"post_process");function xN(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(xN,"highlight_reset_data");var EN={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new Ed(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},AN={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new Ad(t.main.app,t).open()},"callback")},SN={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let m=Date.now();t.events?.emit("sources:reimported",{time_ms:m-_}),t.main.notices?.show("reload_sources",{time_ms:m-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};function CN(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(CN,"build_html");async function u0(n,e={}){let s=this.create_doc_fragment(CN(n,e)).firstElementChild;return ON.call(this,n,s,e),s}r(u0,"render");async function ON(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),vd(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(ON,"post_process");async function qN(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(qN,"build_html");async function m0(n,e={}){let t=await qN.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return $N.call(this,n,i,e),i}r(m0,"render");async function $N(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r($N,"post_process");var p0=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function TN(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(TN,"build_html");async function h0(n,e={}){this.apply_style_sheet(p0);let t=await TN.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return NN.call(this,n,i,e),i}r(h0,"render");async function NN(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return Mh.call(this,"settings_env_sources",n,i),Mh.call(this,"settings_env_models",n,s),Mh.call(this,"settings_notifications",n,o),e}r(NN,"post_process");function Mh(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(Mh,"render_if_available");var f0=require("obsidian");function PN(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(PN,"build_html");async function g0(n,e={}){let t=PN(),i=this.create_doc_fragment(t).firstElementChild;return IN.call(this,n,i,e),i}r(g0,"render");async function IN(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),Lh(n,a),MN(n,a),zh(n,a),Dh(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(IN,"post_process");function Lh(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(Lh,"render_btn_open_selector");function MN(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(MN,"render_btn_copy_context");function zh(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(zh,"render_btn_clear_context");function Dh(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,f0.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(Dh,"render_btn_help");var y0=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var yr=require("obsidian");async function Sd(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(yr.Platform.isMobile)new yr.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new yr.Notice("Failed to copy.")}}r(Sd,"copy_to_clipboard");var zN=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),DN=r(n=>{let e=!1;return()=>{e||(e=!0,zN(async()=>{e=!1,await n()}))}},"create_render_scheduler");function RN(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(RN,"build_html");async function b0(n,e={}){let t=RN(n,e);this.apply_style_sheet(y0);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return FN.call(this,n,i,e),i}r(b0,"render");async function FN(n,e,t={}){let s=[],i=r(async()=>{let d=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(p=>{this.empty(_),_.appendChild(p)});let m=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(p=>{this.empty(m),m.appendChild(p)})},"render_children"),o=DN(i),a=n.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,m)=>d.addEventListener(_,m)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(m=>m.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=BN(e);await Sd(p)})),_.showAtMouseEvent(d)}),await i(),s.push(n.on_event("context:updated",o)),this.attach_disposer(e,s),e}r(FN,"post_process");function BN(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(BN,"tree_dom_to_wikilinks");function UN(n){return Math.ceil((n||0)/4)}r(UN,"estimate_tokens");function WN(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(WN,"build_html");async function v0(n,e={}){let t=WN(),i=this.create_doc_fragment(t).firstElementChild;return GN.call(this,n,i,e),i}r(v0,"render");async function GN(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=UN(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(GN,"post_process");function k0(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-context-item-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let m=["sc-tree-label"];return n.exists===!1&&m.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${l}
<span class="${m.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(k0,"build_tree_item");function w0(n){let e=HN(n),t=new Set(n.map(i=>i.key||i.path));return x0(e,t)}r(w0,"build_tree_html");function HN(n=[]){let e=r(a=>a?.key||a?.path||"","get_item_key"),t=r(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,m=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),m=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),m=!0);let y=[];if(l){let g="",w=!1;for(let b=0;b<l.length;b++)!w&&l.slice(b,b+2)==="[["?(w=!0,g+="[[",b++):w&&l.slice(b,b+2)==="]]"?(w=!1,g+="]]",b++):!w&&l[b]==="/"?(y.push(g),g=""):g+=l[b];g&&y.push(g)}return _&&y.push(_),d&&y.push(d),{segments:y,has_block:m}},"split_path_segments"),s={name:"",children:{},selected:!1},i=r((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),o=n.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of n){let c=e(a),l=a?.exists;if(!c||i(c,o.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),m=s,p="";d.forEach((f,y)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=y===d.length-1,w=g&&_;m.children[f]||(m.children[f]={name:f,path:w?c:p,children:w?[]:{},selected:!1,is_file:w||g&&f.includes(".")}),m=m.children[f],g&&(m.selected=!0,m.exists=l)})}return s}r(HN,"build_path_tree");function x0(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>k0(s,e,x0(s,e))).join("")}</ul>`}r(x0,"tree_to_html");var E0=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var KN=r((n,e)=>!n||!e?!1:n===e||n.startsWith(`${e}/`)?!0:n.startsWith(`${e}#`),"is_nested_context_item");function A0(n,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(n?.data?.context_items||{}).filter(o=>KN(o,t));return[...new Set(i)]}r(A0,"get_nested_context_item_keys");var VN=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),XN=r(n=>{let e=!1;return()=>{e||(e=!0,VN(()=>{e=!1,n()}))}},"create_render_scheduler"),YN=r((n,e={})=>{let{target_path:t}=e,s=A0(n,{target_path:t});n.remove_items(s)},"remove_nested_context_items");function ZN(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(ZN,"build_html");async function S0(n,e={}){this.apply_style_sheet(E0);let t=ZN(n,e),i=this.create_doc_fragment(t).firstElementChild;return QN.call(this,n,i,e),i}r(S0,"render");async function QN(n,e,t={}){let s=n?.env?.plugin,i=s?.registerDomEvent?.bind(s)||((l,d,_)=>l.addEventListener(d,_)),o=r(()=>{let l=n.env,d=n.context_items.filter(t.filter),_=w0(d),m=this.create_doc_fragment(_);this.empty(e),e.appendChild(m);for(let p=0;p<d.length;p++){let f=d[p],y=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!y){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(y),y.appendChild(g)})}},"render_tree_leaves"),a=XN(o);o(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");YN(n,{target_path:_})});let c=[];return c.push(n.on_event("context:updated",a)),this.attach_disposer(e,c),e}r(QN,"post_process");var C0=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function tP(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(tP,"build_html");async function O0(n,e={}){let t=tP(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(C0),await sP.call(this,n,s,e),s}r(O0,"render");async function sP(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let m=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of m){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',w=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',b="",k="";try{let O=await p.read();b=O.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),k=(await p.get_embed_input(O)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(O){console.error("[source_inspector] Error reading block:",O),b='<em style="color:red;">Error reading block content</em>'}let C=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${w}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${k}</pre>
</details>
<blockquote>${b}</blockquote>
<hr>
`);s.appendChild(C)}return e}r(sP,"post_process");var N0=require("obsidian");var ei=require("obsidian");var q0=require("obsidian");var Cd=class extends q0.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var $0=require("obsidian");var Od=class extends $0.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function j0(n,e,t={}){let{Menu:s=ei.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new ei.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new ei.Notice("Active note is not indexed by Smart Environment");return}new Cd(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new Od(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new ei.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(j0,"register_status_bar_context_menu");var T0=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function iP(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(iP,"build_html");async function P0(n,e={}){this.apply_style_sheet(T0);let s=this.create_doc_fragment(iP()).firstElementChild;return oP.call(this,n,s,e),s}r(P0,"render");function oP(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",w=c(),b=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",b="attention"),s&&(0,N0.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=k=>{k.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),w>0?i.dataset.count=String(w):delete i.dataset.count,b?i.dataset.level=String(b):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=k=>{if(l()>0)k.preventDefault(),k.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let O=new MouseEvent("contextmenu",k);e.dispatchEvent?.(O)}},e.addEventListener("click",e._click_handler))},"render_status_elm");j0(n,e),d();let _=null,m=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",m)),this.attach_disposer(e,p)}r(oP,"post_process");var I0=require("obsidian");function rP(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(rP,"build_html");function M0(n,e={}){let t=rP.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return aP.call(this,n,i,e),i}r(M0,"render");async function aP(n,e){let t=e.querySelector(".callout-icon"),s=(0,I0.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(aP,"post_process");var L0=require("obsidian");function cP(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(cP,"build_html");function z0(n,e={}){let t=cP.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,L0.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),lP.call(this,n,i,e),i}r(z0,"render");function lP(n,e){}r(lP,"post_process");var Rh=require("obsidian");async function D0(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new Rh.Notice("No context items to copy.");let t=await this.get_text(n);await Sd(t);let s=dP({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new Rh.Notice(s)}r(D0,"copy_to_clipboard");function dP(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${_P(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=uP(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(dP,"format_stats_message");function _P(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(_P,"format_char_count");function uP(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(uP,"sum_exclusions");var mP="xml_structured",$d={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},R0=r((n={})=>{let e=n.template_preset||mP;return $d[e]?e:"custom"},"get_preset_key"),qd=r((n,e,t,s)=>{let i=R0(n),o=$d[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function jd(){return Object.entries($d).map(([n,e])=>({value:n,label:e.label||n}))}r(jd,"get_template_preset_options");function F0(n={},e={}){return{template_before:qd(n,e,"context_template_before","template_before"),template_after:qd(n,e,"context_template_after","template_after")}}r(F0,"get_context_templates");function B0(n={},e={}){let t=R0(n),s=$d[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:qd(n,e,"item_template_before","template_before"),template_after:qd(n,e,"item_template_after","template_after")}}r(B0,"get_item_templates");var pP=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),hP=r(n=>pP(n.key),"get_item_name");async function U0(n,e={}){let t={KEY:this.key,ITEM_NAME:hP(this),TIME_AGO:Bp(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(m,p)=>t[p]||"");return c},"replace_vars"),i=B0(this.settings,Fh);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(U0,"merge_template");var W0={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>jd(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},Fh={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Nd(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=fP(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Td(e),G0(e).trimEnd()}r(Nd,"build_file_tree_string");function fP(n){return typeof n=="string"&&n.endsWith("/")}r(fP,"is_folder_path");function Td(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Td(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Td(n[i])}else Td(t)}}}r(Td,"compress_single_child_dirs");function G0(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=G0(o,e+(c?"    ":"\u2502   ")))}),t}r(G0,"build_tree_string");async function H0(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>Nd(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(m,p)=>s[p]?.()||"");return l},"replace_vars"),o=F0(this.settings,Bh),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(H0,"merge_template");var J0={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>jd(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},Bh={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function br(n={}){n?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:gP(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:r(({modal:s})=>{s.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}r(br,"context_suggest_blocks");function gP(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(gP,"get_block_display_name");var K0="Add blocks";var X0=require("obsidian");var yP=X0.Platform.isMacOS?"\u2318":"Ctrl";function bP(n){return typeof n!="string"?"":n.replace(/\/+$/g,"")}r(bP,"normalize_folder_path");function vP(n,e){let t=bP(e);return!t||n===t?!0:n.startsWith(`${t}/`)}r(vP,"is_source_in_folder");function V0(n){n?.inputEl&&(n.last_input_value=n.inputEl.value,n.inputEl.value="")}r(V0,"reset_modal_input");function kP(n,e){return Object.values(n.env?.smart_sources?.items||{}).filter(s=>vP(s.key,e))}r(kP,"get_sources_list");function wP(n,e){return e.map(t=>({key:t.key,display:t.key,select_action:r(()=>{n.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s}={})=>(V0(s),br.call(n,{source_key:t.key,modal:s})),"mod_select_action"),arrow_right_action:r(({modal:s}={})=>(V0(s),br.call(n,{source_key:t.key,modal:s})),"arrow_right_action")}))}r(wP,"build_source_suggestions");function vr(n={}){console.log("context_suggest_sources",n);let e=n?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${yP} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=kP(this,n?.folder_path||"");return wP(this,t)}r(vr,"context_suggest_sources");var Y0="Add sources";async function Pd(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(Pd,"pre_process");function Uh(n){return this.vec?n.to_item?.vec?{score:ws(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(Uh,"similarity");Uh.action_type="score";var Wh="Cosine Similarity",Gh="Ranks by cosine similarity between the current note and candidates.",Z0={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${Wh} algorithm`,value:`${Gh}`}};var Hh=require("obsidian");async function Q0(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=Hh.Keymap.isModEvent(e),l=Hh.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(Q0,"open_source");async function eE(n=null){await Q0(this,n)}r(eE,"source_open");var tE={collections:{embedding_models:fx,lookup_lists:yx},item_types:{EmbeddingModel:$s,LookupList:Gt},items:{embedding_model:{class:$s},lookup_list:{class:Gt}},modules:{},components:{collection_settings:{render:bx},context_item_leaf:{render:Ax},env_stats:{render:Sx},form_dropdown:{render:qh},lean_coffee_callout:{render:qx},milestones:{render:Px},notifications_feed:{render:Ix},pro_plugins_list:{render:Vx},pro_plugins_list_item:{render:Xx},settings_env_model:{render:e0},settings_env_model_type:{render:o0},settings_env_models:{render:r0},settings_env_sources:{render:_0},settings_model_actions:{render:u0},settings_notifications:{render:m0},settings_smart_env:{render:h0},smart_context_actions:{render:g0},smart_context_item:{render:b0},smart_context_meta:{render:v0},smart_context_tree:{render:S0},source_inspector:{render:O0},status_bar:{render:P0},supporter_callout:{render:M0},user_agreement_callout:{render:z0}},actions:{context_copy_to_clipboard:{action:D0},context_item_merge_template:{action:U0,settings_config:W0,default_settings:Fh},context_merge_template:{action:H0,settings_config:J0,default_settings:Bh},context_suggest_blocks:{action:br,display_name:K0},context_suggest_sources:{action:vr,display_name:Y0},lookup_list_pre_process:{action:Pd,pre_process:Pd},similarity:{action:Uh,settings_config:Z0,display_name:Wh,display_description:Gh},source_open:{action:eE}}};var xP={env_path:"",modules:{smart_fs:{class:fl,adapter:gl},smart_view:{class:wl,adapter:El},smart_embed_model:{class:Wo,adapters:{transformers:Wn,openai:Xl,ollama:Ql,gemini:ed,lm_studio:td}},smart_chat_model:{class:Ho,adapters:{anthropic:Jo,azure:Xo,custom:ar,google:Hn,gemini:Qo,groq:cr,lm_studio:tr,ollama:ir,open_router:er,openai:qs,xai:lr,deepseek:dr},http_adapter:new it({adapter:Un,obsidian_request_url:Jh.requestUrl})},http_adapter:{class:it,adapter:Un,obsidian_request_url:Jh.requestUrl}},collections:{context_items:ax,event_logs:lx,smart_components:sx,smart_contexts:ox,smart_sources:{collection_key:"smart_sources",class:zo,data_adapter:Fo,source_adapters:{md:As,txt:As,"excalidraw.md":Ul,base:Rl,canvas:Bl,rendered:Fl},content_parsers:[Yw],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:Uo,data_adapter:Wl,block_adapters:{md:zn,txt:zn,"excalidraw.md":zn}}},item_types:{SmartSource:Mn,SmartBlock:Ln},items:{smart_source:Pw,smart_block:Fw},default_settings:mx,modals:{context_selector:{class:pd,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:fd},notifications_feed_modal:{class:hd}}};tt(xP,tE);var EP=require("obsidian");var AP=require("obsidian");var OP=require("obsidian");var SP=require("obsidian");var jP=require("obsidian");var $P=require("obsidian");var nE=require("obsidian");function Id(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Id,"collection_instance_name_from");function Ts(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(iE(e[t])&&iE(n[t])?Ts(n[t],e[t]):n[t]=e[t]);return n}r(Ts,"deep_merge");function iE(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(iE,"is_plain_object");function oE(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(oE,"create_uid");function rE(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(rE,"camel_case_to_snake_case");function Md(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Md(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Md(n[o],e[o],t))}return n===e}r(Md,"deep_equal");function Kh(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(Kh,"get_item_display_name");function Ld(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let v of Reflect.ownKeys(u)){let S=Object.getOwnPropertyDescriptor(u,v);if(!S)continue;let E={...S};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let v=!1;for(let S of h){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E){let q=E.value;if(c(q)){v=!0;continue}if(s(q)){if(_(q)){v=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),v=new Map;for(let S of Reflect.ownKeys(u)){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E&&_(E.value)){v.set(S,d(E.value));continue}try{Object.defineProperty(h,S,m(E))}catch{h[S]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),w=Object.create(null),b=r((u,h,v=[])=>{if(!u||!h)return;let S=new Set([...l,...v]);for(let E of Reflect.ownKeys(u)){if(S.has(E))continue;let q=Object.getOwnPropertyDescriptor(u,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),k=r(u=>{let h=new u(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let S=v.bind(h);return b(u,S),b(h,S),S.instance=h,S}return b(u,h),h},"instantiate_class"),C=r(u=>{if(o(u))return k(u);if(a(u)){let h=u.action.bind(n);return b(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return b(u,h),h}return s(u)?d(u):u},"bind_or_clone"),O=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),j=r((u,h,v)=>(u[h]=v,v),"cache_result"),$=r((u,h)=>{let v=O();return v&&g(v,h)?j(u,h,C(v[h])):g(f,h)?j(u,h,C(f[h])):j(u,h,void 0)},"compute_and_cache"),A=r(()=>{let u=O(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(u)for(let v of Reflect.ownKeys(u))h.add(v);return Array.from(h)},"union_keys"),x=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(w,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:$(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let v=O();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>A(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return x(u,h);let v=O();if(v&&g(v,h)||g(f,h))return g(u,h)||$(u,h),x(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,v)=>"value"in v?(u[h]=v.value,!0):!1,"defineProperty"),set:r((u,h,v)=>(u[h]=v,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(Ld,"create_actions_proxy");var Ht=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Ts(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return oE(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return Ts(s,t),!Md(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Ld(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Id(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Id(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),rE(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Kh(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var NP=Object.getPrototypeOf(async function(){}).constructor,xt=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof NP?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Ts(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Ld(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var zd=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=kr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},kr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Dd=class extends zd{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=wr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},wr=class extends kr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var aE={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},xr=class extends Dd{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=ti;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},ti=class extends wr{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return aE[s]&&(s=aE[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function Vh(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():cE(a)?n[o]=Vh(cE(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(Vh,"ajson_merge");function cE(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(cE,"is_object");var lE={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function PP(n){let e=!1,[t,...s]=n.split(":");return lE[t]&&(t=lE[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(PP,"_parse_ajson_key");var Er=class extends xr{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:w}=PP(p),b=`${y}:${g}`;f?(i[b]=f,(w||b!==p)&&(delete i[p],t=!0)):(delete i[b],(w||b!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=Vh(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Xh=class extends ti{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},Ar={collection:Er,item:Xh};function IP(n){if(n==null)return"";let e;if(Array.isArray(n))e=n.map(t=>t==null?"":String(t)).join(", ");else if(typeof n=="object")try{e=JSON.stringify(n)}catch{e=String(n)}else e=String(n);return e.startsWith("formula.")&&(e=e.replace("formula.","")),e.startsWith("note.")&&(e=e.replace("note.","")),e.startsWith("file.")&&(e=e.replace("file.","")),e.replace(/\|/g,"\\|").replace(/\r?\n/g,"<br>")}r(IP,"stringify_cell");function MP(n){if(!Array.isArray(n)||n.length===0)return[];let e=n.map(s=>Array.isArray(s)?s:[s]),t=e.reduce((s,i)=>Math.max(s,i.length),0);return e.map(s=>Array.from({length:t},(i,o)=>IP(s[o])))}r(MP,"normalize_table");function LP(n){if(n.length===0)return[];let e=n[0].length,t=Array.from({length:e},()=>0);return n.forEach(s=>{for(let i=0;i<e;i++){let o=(s[i]??"").length;o>t[i]&&(t[i]=o)}}),t.map(s=>Math.max(s,3))}r(LP,"compute_col_widths");function zP(n,e){let t=n??"";return t.length>=e?t:t+" ".repeat(e-t.length)}r(zP,"pad_cell");function Yh(n,e){return`| ${n.map((s,i)=>zP(s,e[i])).join(" | ")} |`}r(Yh,"build_row");function DP(n){let e=MP(n);if(e.length===0)return"";let t=LP(e),s=Yh(e[0],t),i=t.map(c=>"-".repeat(c)),o=Yh(i,t),a=e.slice(1).map(c=>Yh(c,t));return[s,o,...a].join(`
`)}r(DP,"to_markdown_table");function RP(n,e){if(!(typeof e!="string"||e.length===0))return e.split(".").reduce((t,s)=>{if(t!=null){if(s==="formula")return t?.formulaResults?.cachedFormulaOutputs;if(s==="note")return t?.note?.data??t?.note;if(["size","mtime","ctime"].includes(s))return t?.stat?.[s];if(s==="links")try{return(globalThis.smart_env?.smart_sources?.get?.(n?.file?.path)?.outlinks||[]).map(o=>`[[${o?.key??o}]]`).join(", ")}catch{return""}return s==="name"?`[[${t?.name??""}]]`:t?.[s]}},n)}r(RP,"get_value_from_path");function FP(n){return n?.linkText?.includes(".base")??!1}r(FP,"is_bases_child");async function BP(n,e=300){await new Promise(s=>setTimeout(s,e));let t=n?._children?.[0]?.view;return t?.data?t:null}r(BP,"get_base_file_view");function dE(n){let e=n?.propertiesCache;if(!Array.isArray(e)||e.length===0)return[];let t=n?.groupedDataCache;if(!Array.isArray(t)||t.length===0)return[];let s=t[t.length-1];if(!s||!Array.isArray(s.entries))return[];let i=e.map(a=>a),o=s.entries.map(a=>e.map(c=>{let l=RP(a,c);return Array.isArray(l?.data)&&typeof l.data?.[0]?.data=="string"?l.data.map(d=>d?.sourcePath?`[[${d.data}]]`:d?.data??"").join(", "):l&&typeof l=="object"&&"data"in l?l.data??"":typeof l!="object"?l??"":""}));return[i,...o]}r(dE,"get_bases_output");function UP(n){if(!Array.isArray(n))return new Set;let e=n.map(t=>t?.link??t?.path??t?.displayText??t?.original??t?.rawText??"").filter(t=>typeof t=="string"&&t.includes(".base"));return new Set(e)}r(UP,"get_base_links");var Rd=class extends Ht{static{r(this,"BasesCache")}get collection(){return this.env.bases_caches}get markdown_table(){let e=this.data?.bases_output;return DP(e)}},Zh=class extends xt{static{r(this,"BasesCaches")}static version=1;#t=null;#e=new Map;#o="";#n=new WeakSet;#i=null;#s=200;#a=3e4;#l=3e4;#r=0;#c=!1;init(){if(this.#c)return;this.#c=!0;let e=globalThis.app?.workspace;if(!e){console.warn("BasesCaches.init: no app.workspace available");return}let t=r(()=>this.start_watchers(),"handler");this.env.plugin.registerEvent(e.on("active-leaf-change",t)),typeof this.env.plugin.register=="function"&&this.env.plugin.register(()=>this.stop_watchers()),this.start_watchers()}get_base_file_view(e){return BP(e)}start_watchers(){this.stop_watchers();let e=this.#r,t=globalThis.app?.workspace?.getActiveFileView?.();if(!t)return console.warn("No file view");let s=t.file?this.env.smart_sources?.get(t.file.path):null;this.#o=s?.key||t.file?.path||"",this.#n=new WeakSet,this.prune_missing_base_caches({source:s});let i=t?.editor?.editorComponent;if(i){let o=r(()=>{if(e!==this.#r)return;let a=[];try{a=i._children||[]}catch{a=[]}let c=new Set;a.forEach(l=>{FP(l)&&(c.add(l),!this.#n.has(l)&&(this.#n.add(l),this.watch_base_child(l,e)))}),this.sweep_orphan_watchers(c)},"scan_children");o(),this.#t=this.set_interval(o,this.#s)}this.get_base_file_view(t).then(o=>{e===this.#r&&(o?(this.#i=o,this.watch_base_file(o,e)):this.#i=null)}).catch(o=>{e===this.#r&&console.warn("BasesCaches: get_base_file_view failed",o)})}set_interval(e,t){return setInterval(e,t)}clear_interval(e){clearInterval(e)}sweep_orphan_watchers(e){let t=new Set(e);this.#i&&t.add(this.#i),this.#e.forEach((s,i)=>{if(s?.generation!==this.#r){this.clear_interval(s.id),this.#e.delete(i);return}let o=t.has(i),a=!0;try{let c=i?.containerEl||i?._children?.[0]?.viewContainerEl||i?.viewContainerEl||null;c&&typeof c.isConnected=="boolean"&&(a=c.isConnected)}catch{a=!1}(!o||!a)&&(this.clear_interval(s.id),this.#e.delete(i))})}watch_base_child(e,t=this.#r){if(this.#e.has(e))return;let s=e?.linkText??"",i=Date.now(),o=this.set_interval(()=>{if(t!==this.#r){this.clear_interval(o),this.#e.delete(e);return}let a=e?.containerEl||e?._children?.[0]?.viewContainerEl||null;if(a&&a.isConnected===!1){this.clear_interval(o),this.#e.delete(e);return}if(Date.now()-i>this.#a){this.clear_interval(o),this.#e.delete(e);return}let c=e?._children?.[0]?.view?.data;if(!c)return;let l=[];try{l=dE(c)}catch(d){console.warn("BasesCaches: get_bases_output failed for embedded base",d),l=[]}l.length&&(this.clear_interval(o),this.#e.delete(e),this.cache_bases_output({key:`${this.#o}#${s}`,bases_output:l}))},this.#s);this.#e.set(e,{id:o,started:i,generation:t})}watch_base_file(e,t=this.#r){if(this.#e.has(e))return;let s=Date.now(),i=this.set_interval(()=>{if(t!==this.#r){this.clear_interval(i),this.#e.delete(e);return}let o=e?.containerEl||e?.viewContainerEl||null;if(o&&o.isConnected===!1){this.clear_interval(i),this.#e.delete(e);return}if(Date.now()-s>this.#l){this.clear_interval(i),this.#e.delete(e);return}let a=e?.data;if(!a)return;let c=[];try{c=dE(a)}catch(l){console.warn("BasesCaches: get_bases_output failed for base file",l),c=[]}c.length&&(this.clear_interval(i),this.#e.delete(e),this.cache_bases_output({key:this.#o,bases_output:c}))},this.#s);this.#e.set(e,{id:i,started:s,generation:t})}stop_watchers(){this.#r+=1,this.#t&&(this.clear_interval(this.#t),this.#t=null),this.#e.forEach(e=>this.clear_interval(e.id)),this.#e.clear(),this.#i=null}prune_missing_base_caches(e={}){let{source:t=null,source_key:s=this.#o}=e,i=t?.data?.meta?.links||t?.meta?.links||[],o=UP(i);if(!s)return;let a=`${s}#`,c=!1;Object.entries(this.items).forEach(([l,d])=>{if(!l.startsWith(a))return;let _=l.slice(a.length);o.has(_)||(c=!0,d.delete())}),c&&this.process_save_queue()}cache_bases_output(e={}){let{key:t,bases_output:s}=e;if(!t||!Array.isArray(s)||s.length===0)return;let i=new Rd(this.env,{key:t,bases_output:s});this.set(i),i.queue_save(),this.process_save_queue()}},_E={class:Zh,collection_key:"bases_caches",data_adapter:Er,item_type:Rd};var Ns=class extends Ht{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],m=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),m},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var si=class extends xt{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function Fd(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(Fd,"settings_config");var Ps=class extends Ns{static{r(this,"ChatCompletionModel")}async complete(e){return this.instance.complete(e)}async stream(e,t={}){return this.instance.stream(e,t)}async test_model(){try{let e=await this.complete({messages:[{role:"user",content:"2+2="}]}),t=!e.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Et=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var Sr=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},Cr=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var At=class extends Sr{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new Qh(i)}},Qh=class extends Cr{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var Bd=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var Jt=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Ud=class extends Jt{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};function tf(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(tf):e==="object"?Object.values(n).every(tf):!1}r(tf,"is_json_compatible");function Wd(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||tf(i)&&(t[s]=i);return t}r(Wd,"extract_json_details");function Or(n){return Object.keys(n).length===0}r(Or,"is_empty_object");function WP(n,e){return Or(n)?e:Or(e)?n:{...n,...e}}r(WP,"merge_details");function ef(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(ef,"get_message_from_object");function ce(n,e=null){if(Array.isArray(n)&&n.length>0)return ce(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Wd(n,["message"]);return{message:t,details:Or(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=ef(o),c=Wd(o,["message"]),l=Wd(t,["message","error"]),d=WP(l,c);return{message:a||ef(t)||"Unknown error",details:Or(d)?null:d,http_status:e}}return ce(i)}let s=ef(t);if(s){let i=Wd(t,["message"]);return{message:s,details:Or(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(ce,"normalize_error");var ni={},Kt={data:null,fetched_at:0},G=class extends Ud{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return J}get res_adapter(){return B}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Et({adapter:At})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Kt.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=ce(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new Bd(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=ce({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=ce(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=ce(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Kt?.data&&t-Kt?.fetched_at<e)return Kt.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Kt.data=o,Kt.fetched_at=t,console.log({MODELS_DEV_CACHE:Kt}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Kt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return ni[this.constructor.key]||(ni[this.constructor.key]={}),ni[this.constructor.key]}set model_data(e){ni[this.constructor.key]||(ni[this.constructor.key]={}),ni[this.constructor.key]=e}},J=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},B=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:ce(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Gd=class extends G{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return sf}get res_adapter(){return nf}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},sf=class extends J{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},nf=class extends B{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var of=class extends Gd{static{r(this,"OpenRouterChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},GP={api_key:{name:"API Key",type:"password",description:"Enter your API key for the chat model provider."}},Hd={class:of,settings_config:GP};var rf=class extends si{static{r(this,"ChatCompletionModels")}model_type="Chat";get default_provider_key(){return"open_router"}};var HP={class:rf,data_dir:"chat_completion_models",collection_key:"chat_completion_models",data_adapter:Ar,item_type:Ps,providers:{open_router:Hd},settings_config:Fd},uE=HP;var mE=uE;var Is=class extends Ns{static{r(this,"RankingModel")}static get defaults(){return{data:{api_key:"",provider_key:"cohere",model_key:"rerank-v3.5"}}}async rank(e,t,s={}){return this.instance.rank(e,t,s)}async test_model(){try{let e=await this.rank("alphabetical order",["z","y","x","a","b","c"]),t=!!(!e.error&&Array.isArray(e)&&e.length);return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var af={"[ADAPTER].model_key":{name:"Ranking Model",type:"dropdown",description:"Select a ranking model to use.",options_callback:"adapter.get_models_as_options",callback:"reload_model"}},Jd=class extends Jt{static{r(this,"SmartRankAdapter")}constructor(e){super(e),this.smart_rank=e}async rank(e,t){throw new Error("rank method not implemented")}get settings_config(){return af}};var Kd=class extends Jd{static{r(this,"SmartRankModelApiAdapter")}get endpoint(){return this.model.data.endpoint||this.constructor.defaults.endpoint}get api_key(){return this.model.data.api_key}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Et({adapter:At})),this._http_adapter}async load(){this.model.model_loaded=!0,this.api_key&&this.set_state("loaded")}async request(e,t=0){try{e.throw=!1,e.url=this.endpoint,console.log("API Request:",e);let s=await this.http_adapter.request(e);return console.log("API Response:",s),await this.get_resp_json(s)}catch(s){return await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.rank("test query",["Test document"]);return Array.isArray(e)&&e.length>0&&e[0].score!==null}},Vd=class{static{r(this,"SmartRankModelRequestAdapter")}constructor(e,t,s){this.adapter=e,this.query=t,this.documents=s}get_headers(){let e={"Content-Type":"application/json"};return this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`),e}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Xd=class{static{r(this,"SmartRankModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_standard(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Yd=class extends Kd{static{r(this,"SmartRankCohereAdapter")}static defaults={adapter:"cohere",description:"Cohere",default_model:"rerank-v3.5",endpoint:"https://api.cohere.ai/v2/rerank"};get req_adapter(){return cf}get res_adapter(){return lf}async load(){this.model.model_loaded=!0,this.set_state("loaded")}async rank(e,t){let i=new this.req_adapter(this,e,t).to_platform(),o=await this.request(i);return!o||!o.results?{message:o?.message||"Invalid response from Cohere API",resp:o}:new this.res_adapter(this,o).to_standard()}async handle_request_err(e,t,s){if(e&&e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Cohere API rate limit exceeded. Retrying in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error("Cohere API Error:",e),null}get settings_config(){return JP}get models(){return KP}},JP={...af,"[ADAPTER].api_key":{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},KP={"rerank-v3.5":{id:"rerank-v3.5",description:"State-of-the-art performance in English and non-English languages. Supports documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-english-v3.0":{id:"rerank-english-v3.0",description:"English language documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-multilingual-v3.0":{id:"rerank-multilingual-v3.0",description:"Non-English documents and semi-structured data (JSON). Supports same languages as embed-multilingual-v3.0. Context length: 4096 tokens"}},cf=class extends Vd{static{r(this,"SmartRankCohereRequestAdapter")}prepare_request_body(){return{query:this.query,documents:this.documents,model:this.adapter.model_key,top_n:1e3,max_tokens_per_doc:4096}}},lf=class extends Xd{static{r(this,"SmartRankCohereResponseAdapter")}parse_response(){return this.response.results?this.response.results.map(e=>({index:e.index,score:e.relevance_score})):(console.error("Invalid response format from Cohere API:",this.response),[])}};var df=class extends Yd{static{r(this,"CohereRankingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get_models(){return this.models}},VP={api_key:{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},pE={class:df,settings_config:VP};var _f=class extends si{static{r(this,"RankingModels")}model_type="Ranking";get default_provider_key(){return"cohere"}},XP={class:_f,data_dir:"ranking_models",collection_key:"ranking_models",data_adapter:Ar,item_type:Is,providers:{cohere:pE},settings_config:Fd},hE=XP;var fE=hE;var Zd=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}};function Qd(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Qd,"cos_sim");function bE(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=gE(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=gE(n.results);n.min=s,n.minResult=i}}r(bE,"results_acc");function vE(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=yE(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=yE(n.results);n.max=s,n.maxResult=i}}r(vE,"furthest_acc");function gE(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(gE,"find_min");function yE(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(yE,"find_max");function ii(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(ii,"sort_by_score");function kE(n,e){return ii(n,e)}r(kE,"sort_by_score_descending");function wE(n,e){return ii(n,e)*-1}r(wE,"sort_by_score_ascending");var e_=class extends Zd{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Qd(e,a.vec)};return bE(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(kE)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Qd(e,a.vec)};return vE(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(wE)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}};function YP(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=oi(l,o),l=uf(l,15),l=oi(l,a),i^=l,i=uf(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=oi(l,o),l=uf(l,15),l=oi(l,a),i^=l;break}return i^=n.length,i=ZP(i),i|0}r(YP,"murmur_hash_32");function xE(n,e=0){return(YP(n,e)>>>0).toString(36)}r(xE,"murmur_hash_32_alphanumeric");function oi(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(oi,"multiply_32");function uf(n,e){return n<<e|n>>>32-e}r(uf,"rotate_left_32");function ZP(n){return n^=n>>>16,n=oi(n,2246822507),n^=n>>>13,n=oi(n,3266489909),n^=n>>>16,n|0}r(ZP,"fmix_32");var QP="---frontmatter---",EE=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),eI=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),tI=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),sI=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(QP),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),nI=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=EE(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=EE(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),iI=r((n,e={})=>{let t=eI(n,e),s=tI(t),i=sI(s);return nI(i,n)},"create_find_connections_filter_opts");async function mf(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=iI(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+xE(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(ii).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(mf,"find_connections");mf.action_type="connections";var qr=class extends xt{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new e_(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let m=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!m[f.item.path]||f.score>m[f.item.path].score?m[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=m[f.item.path].score}),m},Promise.resolve({})),c=Object.values(a).sort(ii).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return t_}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return oI}},t_={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},oI={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};var $r=class extends qr{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var aI=r(n=>{let e={embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...t_};return n.settings.embed_blocks===!1&&e.min_chars&&(e.min_chars.disabled=!0),e},"settings_config"),AE={class:$r,collection_key:"smart_blocks",settings_config:aI};var ci=require("obsidian");function Fe(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(Fe,"escape_html");function SE(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=ri(l,o),l=pf(l,15),l=ri(l,a),i^=l,i=pf(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=ri(l,o),l=pf(l,15),l=ri(l,a),i^=l;break}return i^=n.length,i=cI(i),i|0}r(SE,"murmur_hash_32");function oe(n,e=0){return(SE(n,e)>>>0).toString(36)}r(oe,"murmur_hash_32_alphanumeric");function ri(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(ri,"multiply_32");function pf(n,e){return n<<e|n>>>32-e}r(pf,"rotate_left_32");function cI(n){return n^=n>>>16,n=ri(n,2246822507),n^=n>>>13,n=ri(n,3266489909),n^=n>>>16,n|0}r(cI,"fmix_32");function fe(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(fe,"camel_case_to_snake_case");function hf(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(hf,"convert_to_time_ago");function ct(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(CE(e[t])&&CE(n[t])?ct(n[t],e[t]):n[t]=e[t]);return n}r(ct,"deep_merge");function CE(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(CE,"is_plain_object");function Ms(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Ms,"cos_sim");function Ae(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(Ae,"get_by_path");function Se(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(Se,"set_by_path");function ff(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(ff,"delete_by_path");function gf(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(gf,"compute_centroid");function yf(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let m=Math.sqrt(_);s[a]+=m,s[l]+=m}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(yf,"compute_medoid");function lI(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(lI,"ensure_settings_config");function bf(n,e,t){let s=lI(n,e);return Object.entries(s||{}).reduce((i,[o,a])=>{let c=a.group||t;return i[c]||(i[c]={}),i[c][o]=a,i},{[t]:{}})}r(bf,"build_settings_group_map");function vf(n,e,t,s){return bf(n,e,s)[t]||{}}r(vf,"resolve_group_settings_config");var s_=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new ci.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function li(n,e,t,s={}){let{default_group_name:i="Settings"}=s,o=n,a=bf(n,e,i);return Object.entries(a).sort(([l],[d])=>l===i?-1:d===i?1:0).filter(([,l])=>Object.keys(l).length>0).map(([l,d])=>{let _=t.createDiv(),m={...s,...s.group_params?.[l]||{},settings_config_source:o};return kf(l,e,d,_,m)})}r(li,"render_settings_config");function kf(n,e,t,s,i={}){let o=i.settings_config_source||t,a=i.settings_config_source?vf(o,e,n,i.default_group_name||"Settings"):t,c;try{let p=require("obsidian");p.SettingGroup?c=p.SettingGroup:c=s_}catch{c=s_}t=a;let{heading_btn:l=null}=i,d=i.settings_config_source?(p,f,y,g,w)=>{let b=vf(y,f,p,w.default_group_name||"Settings");return kf(p,f,b,g,w)}:kf,_=dI(e,{container:s,group_name:n,settings_config:o,group_params:i,render_group:d}),m=new c(s);if(l&&typeof l=="object")if(Array.isArray(l))for(let p of l)OE(m,e,p);else OE(m,e,l);m.setHeading(n);for(let[p,f]of Object.entries(t)){if(!f||typeof f!="object"){console.warn(`Invalid setting config for ${p}:`,f);continue}let y=f.scope_class==="pro-setting",g=!!e.env?.is_pro;m.addSetting(w=>{switch(f.name&&w.setName(f.name),w.setClass(p.replace(/[^a-zA-Z0-9]/g,"-")),f.type&&w.setClass(`setting-type-${f.type}`),f.description&&w.setDesc(f.description),f.type){case"button":w.addButton(b=>{b.setButtonText(f.name||"Run"),b.onClick(async k=>{typeof f.callback=="function"&&await ai(w,k,f.callback,{scope:e})})});break;case"toggle":w.addToggle(b=>{b.setValue(Ae(e.settings,p)||!1),b.onChange(k=>{Se(e.settings,p,k),typeof f.callback=="function"&&ai(w,k,f.callback,{scope:e})})});break;case"text":w.addText(b=>{b.setValue(String(Ae(e.settings,p)||"")),b.onChange(k=>{Se(e.settings,p,k)})});break;case"number":w.addText(b=>{b.setValue(String(Ae(e.settings,p)??"0")),b.inputEl.setAttribute("type","number"),b.onChange(k=>{let C=Number(k);isNaN(C)||Se(e.settings,p,C),typeof f.callback=="function"&&ai(w,C,f.callback,{scope:e})})});break;case"dropdown":w.addDropdown(b=>{let k=f.options_callback;typeof k=="function"&&k.call(e,e).forEach(O=>{let j=O.label||O.name||O.value;b.addOption(O.value,j)}),b.setValue(Ae(e.settings,p)||""),b.onChange(C=>{Se(e.settings,p,C),typeof f.callback=="function"&&ai(w,C,f.callback,{scope:e}),_()})});break;case"textarea":w.addTextArea(b=>{b.setValue(String(Ae(e.settings,p)||"")),b.onChange(k=>{if(y&&!g){new ci.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}Se(e.settings,p,k)}),y&&!g&&b.setDisabled(!0)});break;case"slider":w.addSlider(b=>{let k=f.min||0,C=f.max||100,O=f.step||1;b.setLimits(k,C,O),b.setValue(Ae(e.settings,p)||k),b.setDynamicTooltip(),b.onChange(j=>{Se(e.settings,p,j),typeof f.callback=="function"&&ai(w,j,f.callback,{scope:e})})});break;case"heading":w.setHeading();break;case"html":f.value&&w.descEl.replaceChildren(document.createRange().createContextualFragment(f.value));break;default:console.warn(`Unsupported setting type for ${p}:`,f.type);break}f.scope_class&&w.settingEl.addClass(f.scope_class)})}return m}r(kf,"render_settings_group");function OE(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,ci.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await ai(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(OE,"render_heading_button");async function ai(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(ai,"handle_config_callback");function dI(n,e={}){let{container:t,group_name:s,settings_config:i,group_params:o={},render_group:a}=e;return()=>!t||typeof a!="function"?null:(t.replaceChildren(),a(s,n,i,t,o))}r(dI,"create_settings_group_rerender");var qE=require("obsidian");function Vt(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(Vt,"ensure_smart_sources_settings");function Xt(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(Xt,"parse_exclusions_csv");function n_(n,e){let t=(e??"").trim();if(!t)return n||"";let s=Xt(n);return s.includes(t)||s.push(t),s.join(",")}r(n_,"add_exclusion");function i_(n,e){let t=(e??"").trim();return t?Xt(n).filter(i=>i!==t).join(","):n?.trim()||""}r(i_,"remove_exclusion");var o_=class extends qE.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Vt(this.env),t=Xt(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Vt(this.env);t.folder_exclusions=n_(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Vt(this.env),t=Xt(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=i_(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var $E=require("obsidian");var r_=class extends $E.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function _I(n,e={}){return`
<div class="sources-settings">
</div>
`}r(_I,"build_html");async function jE(n,e={}){let t=await _I.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return uI.call(this,n,i,e),i}r(jE,"render");async function uI(n,e,t={}){li({folder_exclusions:xf,view_exclusions:Ef,re_import_sources:Af},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",wf(n,e))),this.attach_disposer(e,i),e}r(uI,"post_process");function wf(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(wf,"highlight_reset_data");var xf={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new o_(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},Ef={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new r_(t.main.app,t).open()},"callback")},Af={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let m=Date.now();t.events?.emit("sources:reimported",{time_ms:m-_}),t.main.notices?.show("reload_sources",{time_ms:m-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};var TE=require("obsidian");var di=class extends TE.FuzzySuggestModal{static{r(this,"ExcludedFilesFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a file to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Vt(this.env),t=Xt(e.file_exclusions);return(this.env.smart_sources?.fs?.file_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Vt(this.env);t.file_exclusions=n_(t.file_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Vt(this.env),t=Xt(e.file_exclusions),s=this.modalEl.querySelector(".sc-excluded-files-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-files-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded files"),!t.length){s.createEl("p").setText("No files excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-file-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-file-btn"}).addEventListener("click",()=>{e.file_exclusions=i_(e.file_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};async function mI(n,e={}){return`
<div class="sources-pro-settings">
</div>
`}r(mI,"build_html");async function NE(n,e={}){let t=await mI.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return pI.call(this,n,i,e),i}r(NE,"render");async function pI(n,e,t={}){li({folder_exclusions:xf,file_exclusions:hI,view_exclusions:Ef,re_import_wait_time:{type:"number",name:"Re-import wait time",description:"Time in seconds to wait before re-importing a file after modification.",scope_class:"pro-setting"},"smart_blocks.embed_blocks":{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Embedding allows more granular results in semantic lookups.",scope_class:"pro-setting"},"smart_sources.min_chars":{name:"Minimum length to embed (Sources)",type:"number",description:"Minimum number of characters a source must have to be embedded.",scope_class:"pro-setting"},"smart_blocks.min_chars":{name:"Minimum length to embed (Blocks)",type:"number",description:"Minimum number of characters a block must have to be embedded.",scope_class:"pro-setting"},re_import_sources:Af},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",wf(n,e))),this.attach_disposer(e,i),e}r(pI,"post_process");var hI={type:"button",name:"Manage excluded files",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",scope_class:"pro-setting",callback:r(async function(n,e){let t=this,s=new di(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")};async function fI(n,e={}){return`
<div class="setting-component pro-setting">
<div class="setting-item">
<div class="info setting-item-info">
<div class="setting-item-name">Excluded files</div>
<div class="setting-item-description">Manage files to exclude from the environment.</div>
</div>
<div class="control setting-item-control">
<button class="sc-add-excluded-file-btn" type="button">Edit excluded files</button>
</div>
</div>
</div>
`}r(fI,"build_html");async function PE(n,e={}){let t=await fI.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return gI.call(this,n,i,e),i}r(PE,"render");async function gI(n,e,t={}){let s=e.querySelector(".sc-add-excluded-file-btn");return s&&s.addEventListener("click",()=>{new di(n.main.app,n).open(()=>{n.update_exclusions()})}),e}r(gI,"post_process");var a_={collections:{bases_caches:_E,chat_completion_models:mE,ranking_models:fE,smart_blocks:AE},item_types:{ChatCompletionModel:Ps,RankingModel:Is},items:{chat_completion_model:{class:Ps},ranking_model:{class:Is}},modules:{},components:{settings_env_sources:{render:NE},settings_sources_file_exclusions:{render:PE}},actions:{}};var c_=class extends Jt{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var zE=P(LE(),1);var AI=Object.defineProperty,SI=r((n,e,t)=>e in n?AI(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),CI=r((n,e,t)=>(SI(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function OI(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(OI,"bytePairMerge");function qI(n,e){return n.length===1?[e.get(n.join(","))]:OI(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(qI,"bytePairEncode");function $I(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r($I,"escapeRegex");var Cf=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=zE.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=Cf.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Cf.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let m=d?.index??n.length;for(let f of n.substring(l,m).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...qI(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},d_=Cf;CI(d_,"specialTokenRegex",n=>new RegExp(n.map(e=>$I(e)).join("|"),"g"));async function RE(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await DE(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await DE(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(RE,"fetch_json_cached");async function DE(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(DE,"do_fetch");var jI="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",Oe=class extends c_{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return ge}get res_adapter(){return ye}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Et({adapter:At})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:ce(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await RE(jI,"cl100k_base.json");this.tiktoken=new d_(e)}},ge=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},ye=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var __=class extends Oe{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Of}get res_adapter(){return qf}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},Of=class extends ge{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},qf=class extends ye{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};var $f=class extends __{static{r(this,"GoogleGeminiEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},TI={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."},gemini_note:{name:"Note about using Gemini Embeddings API",type:"html",value:'<p class="model-note"><b>WARNING: Gemini rate-limiting:</b> Google imposes strict rate limits on the Gemini Embeddings API. Smart Environment will attempt to retry. Retry details can be found in the developer console logs. Consistent rate limit errors may prevent all items from being properly embedded. Restarting Obsidian will attempt to re-embed any failed items. If you continue to experience issues, try disabling blocks to reduce the number of embeddings required by your Smart Environment.</p>'}},FE={class:$f,settings_config:TI};function NI(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(NI,"parse_lm_studio_models");var u_=class extends Oe{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return jf}get res_adapter(){return Tf}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return NI(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},jf=class extends ge{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Tf=class extends ye{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Nf=class extends u_{static{r(this,"LmStudioEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},BE={class:Nf};var m_=class extends Oe{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Pf}get res_adapter(){return If}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of II(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Pf=class extends ge{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},If=class extends ye{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},PI=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),II=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(PI)},"filter_embedding_models");var Mf=class extends m_{static{r(this,"OllamaEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},MI={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},UE={class:Mf,settings_config:MI};var p_=class extends Oe{static{r(this,"SmartEmbedOpenRouterAdapter")}static key="open_router";static defaults={description:"OpenRouter (Embeddings)",type:"API",adapter:"OpenRouterEmbeddings",endpoint:"https://openrouter.ai/api/v1/embeddings",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"text-embedding-3-small",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys",streaming:!1,api_key:null,batch_size:50,max_tokens:8191};get req_adapter(){return Lf}get res_adapter(){return zf}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenRouter API key for embeddings",type:"password",description:"Required for OpenRouter embedding models.",placeholder:"Enter OpenRouter API key"}}}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}get models_endpoint(){return this.constructor.defaults.models_endpoint}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;if(!this.api_key){console.warn("[SmartEmbedOpenRouterAdapter] API key missing; cannot fetch models from OpenRouter.");let t=this.constructor.defaults.default_model,s={[t]:{id:t,model_name:t,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=s,s}try{let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET",headers:{Authorization:`Bearer ${this.api_key}`}})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}catch(t){if(console.error("[SmartEmbedOpenRouterAdapter] Failed to fetch models:",t),this.model.data.provider_models)return this.model.data.provider_models;let s=this.constructor.defaults.default_model,i={[s]:{id:s,model_name:s,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=i,i}}parse_model_data(e){let t=[];if(Array.isArray(e?.data))t=e.data;else if(Array.isArray(e))t=e;else return console.error("[SmartEmbedOpenRouterAdapter] Invalid model data format from OpenRouter:",e),{_:{id:"No models found."}};let s={};for(let i of t){let o=i.id||i.name;o&&LI(o)&&(s[o]={id:o,model_name:o,max_tokens:i.context_length||this.max_tokens,description:i.name||i.description||`Model: ${o}`,adapter:this.constructor.key})}return Object.keys(s).length?s:{_:{id:"No embedding models found."}}}},Lf=class extends ge{static{r(this,"SmartEmbedOpenRouterRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},zf=class extends ye{static{r(this,"SmartEmbedOpenRouterResponseAdapter")}parse_response(){let e=this.response;if(!e||!Array.isArray(e.data))return console.error("[SmartEmbedOpenRouterResponseAdapter] Invalid embedding response format:",e),[];let t=null;return e.usage?.total_tokens&&e.data.length>0&&(t=e.usage.total_tokens/e.data.length),e.data.map(s=>({vec:s.embedding||s.data||[],tokens:t}))}},LI=r(n=>{let e=String(n||"").toLowerCase();return!!(e.split(/[-:/_]/).some(s=>["embed","embedding","bge"].includes(s))||e.includes("text-embedding"))},"is_embedding_model");var Df=class extends p_{static{r(this,"OpenRouterEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},WE={class:Df};var h_=class extends Oe{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Rf}get res_adapter(){return Ff}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Rf=class extends ge{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Ff=class extends ye{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var Bf=class extends h_{static{r(this,"OpenAIEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get batch_size(){return 30}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},zI={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},dimensions:{name:"Embedding Dimensions",type:"dropdown",description:"Select the number of dimensions for the embeddings (only for text-embedding-3 models).",option_1:"256|256 (equivalent to ada using 'large' model)",option_2:"512|512 (equivalent to ada using 'small' model)",option_3:"1536|1536",option_4:"3072|3072 (uses >10X more RAM/storage than 256)",default:"512"}},GE={class:Bf,settings_config:zI};var f_=class extends G{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Uf}res_adapter=Wf;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Uf=class extends J{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Wf=class extends B{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:ce(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var Gf=class extends f_{static{r(this,"AnthropicChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},DI={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."}},HE={class:Gf,settings_config:DI};var RI=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],_i=class extends G{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Hf;parse_model_data(e){return e.data.filter(t=>!RI.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:FI(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function FI(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(FI,"get_max_input_tokens");var Hf=class extends B{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var g_=class extends _i{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var Jf=class extends g_{static{r(this,"AzureChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},BI={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."},azure_resource_name:{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},azure_deployment_name:{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},azure_api_version:{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}},JE={class:Jf,settings_config:BI};var y_=class extends G{static{r(this,"SmartChatModelCohereAdapter")}static key="cohere";static defaults={description:"Cohere Command-R",type:"API",endpoint:"https://api.cohere.ai/v1/chat",streaming:!1,adapter:"Cohere",models_endpoint:"https://api.cohere.ai/v1/models",default_model:"command-r",signup_url:"https://dashboard.cohere.com/welcome/register?redirect_uri=%2Fapi-keys"};get req_adapter(){return Kf}get res_adapter(){return Vf}async count_tokens(e){let t={url:`${this.endpoint}/tokenize`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.api_key}`},body:JSON.stringify({text:typeof e=="string"?e:JSON.stringify(e)})};return(await this.http_adapter.request(t)).json.tokens.length}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("command-")).reduce((t,s)=>(t[s.name]={model_name:s.name,id:s.name,max_input_tokens:s.context_length,tokenizer_url:s.tokenizer_url,finetuned:s.finetuned,description:`Max input tokens: ${s.context_length}, Finetuned: ${s.finetuned}`,raw:s},t),{})}},Kf=class extends J{static{r(this,"SmartChatModelCohereRequestAdapter")}to_platform(){return this.to_cohere()}to_cohere(){let e={model:this.model_id,message:this._get_latest_user_message(),chat_history:this._transform_messages_to_cohere_chat_history(),max_tokens:this.max_tokens,temperature:this.temperature,stream:this.stream,...this.tools&&{tools:this._transform_tools_to_cohere()},...this._req.tool_choice&&{tool_choice:this._req.tool_choice},...this._req.preamble&&{preamble:this._req.preamble},...this._req.conversation_id&&{conversation_id:this._req.conversation_id},...this._req.connectors&&{connectors:this._req.connectors},...this._req.documents&&{documents:this._req.documents}};return this._req.response_format&&(e.response_format={type:this._req.response_format.type,...this._req.response_format.schema&&{schema:this._req.response_format.schema}}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}_get_latest_user_message(){if(this.messages.some(t=>Array.isArray(t.content)&&t.content.some(s=>s.type==="image_url")))throw new Error("Cohere API does not support image input");let e=this.messages.filter(t=>t.role==="user");return e[e.length-1]?.content||""}_transform_messages_to_cohere_chat_history(){return this.messages.slice(0,-1).map(e=>({role:this._get_cohere_role(e.role),message:this._get_cohere_content(e.content)}))}_get_cohere_role(e){return{system:"SYSTEM",user:"USER",assistant:"CHATBOT",function:"CHATBOT"}[e]||e.toUpperCase()}_get_cohere_content(e){if(Array.isArray(e)){for(let t of e)if(t.type==="image_url")throw new Error("Cohere API does not support image input");return e.map(t=>t.type==="text"?t.text:JSON.stringify(t)).join(`
`)}return e}_transform_tools_to_cohere(){return this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}},Vf=class extends B{static{r(this,"SmartChatModelCohereResponseAdapter")}to_openai(){if(this._res.message)throw new Error(this._res.message);return{id:this._res.generation_id||"cohere_"+Date.now(),object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.finish_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:this._res.text||""};return this._res.citations&&(e.citations=this._res.citations),this._res.documents&&(e.documents=this._res.documents),this._res.search_queries&&(e.search_queries=this._res.search_queries),this._res.search_results&&(e.search_results=this._res.search_results),e}_get_openai_finish_reason(e){return{COMPLETE:"stop",MAX_TOKENS:"length",ERROR:"error",STOP_SEQUENCE:"stop"}[e]||"stop"}_transform_usage_to_openai(){return!this._res.meta||!this._res.meta.billed_units?{prompt_tokens:null,completion_tokens:null,total_tokens:null}:{prompt_tokens:this._res.meta.billed_units.input_tokens||null,completion_tokens:this._res.meta.billed_units.output_tokens||null,total_tokens:(this._res.meta.billed_units.input_tokens||0)+(this._res.meta.billed_units.output_tokens||0)}}};var Xf=class extends y_{static{r(this,"CohereChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},UI={api_key:{name:"API Key",type:"password",description:"Enter your Cohere API key."}},KE={class:Xf,settings_config:UI};var b_=class extends G{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Yf}get res_adapter(){return Zf}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Yf=class extends J{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Zf=class extends B{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var Qf=class extends b_{static{r(this,"DeepseekChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},WI={api_key:{name:"API Key",type:"password",description:"Enter your Deepseek API key."}},VE={class:Qf,settings_config:WI};var v_=class extends G{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=eg;res_adapter=tg;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},eg=class extends J{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},tg=class extends B{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:ce(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}};var sg=class extends v_{static{r(this,"GoogleChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},GI={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."}},XE={class:sg,settings_config:GI};var k_=class extends G{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return ng}get res_adapter(){return ig}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},ng=class extends J{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},ig=class extends B{static{r(this,"SmartChatModelGroqResponseAdapter")}};var og=class extends k_{static{r(this,"GroqChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},HI={api_key:{name:"API Key",type:"password",description:"Enter your Groq API key."}},YE={class:og,settings_config:HI};var w_=class extends G{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return rg}get res_adapter(){return ag}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},rg=class extends J{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},ag=class extends B{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var cg=class extends w_{static{r(this,"LmStudioChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},JI={},ZE={class:cg,settings_config:JI};var x_=class extends G{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=lg;res_adapter=dg;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},lg=class extends J{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},dg=class extends B{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:ce(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var _g=class extends x_{static{r(this,"OllamaChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},KI={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},QE={class:_g,settings_config:KI};var ug=class extends _i{static{r(this,"OpenAIChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},VI={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},openai_note:{name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."}},e1={class:ug,settings_config:VI};var E_=class extends G{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return J}get res_adapter(){return B}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var mg=class extends E_{static{r(this,"XaiChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},XI={api_key:{name:"API Key",type:"password",description:"Enter your xAI API key."}},t1={class:mg,settings_config:XI};var A_={collections:{embedding_models:{providers:{gemini:FE,lm_studio:BE,ollama:UE,open_router:WE,openai:GE}},chat_completion_models:{providers:{anthropic:HE,azure:JE,cohere:KE,deepseek:VE,google:XE,groq:YE,lm_studio:ZE,ollama:QE,open_router:Hd,openai:e1,xai:t1}}}};function S_(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(S_,"collection_instance_name_from");function zs(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(s1(e[t])&&s1(n[t])?zs(n[t],e[t]):n[t]=e[t]);return n}r(zs,"deep_merge");function s1(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(s1,"is_plain_object");function n1(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(n1,"create_uid");function i1(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(i1,"camel_case_to_snake_case");function C_(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>C_(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>C_(n[o],e[o],t))}return n===e}r(C_,"deep_equal");function o1(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(o1,"get_item_display_name");function O_(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let v of Reflect.ownKeys(u)){let S=Object.getOwnPropertyDescriptor(u,v);if(!S)continue;let E={...S};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let v=!1;for(let S of h){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E){let q=E.value;if(c(q)){v=!0;continue}if(s(q)){if(_(q)){v=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),v=new Map;for(let S of Reflect.ownKeys(u)){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E&&_(E.value)){v.set(S,d(E.value));continue}try{Object.defineProperty(h,S,m(E))}catch{h[S]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),w=Object.create(null),b=r((u,h,v=[])=>{if(!u||!h)return;let S=new Set([...l,...v]);for(let E of Reflect.ownKeys(u)){if(S.has(E))continue;let q=Object.getOwnPropertyDescriptor(u,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),k=r(u=>{let h=new u(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let S=v.bind(h);return b(u,S),b(h,S),S.instance=h,S}return b(u,h),h},"instantiate_class"),C=r(u=>{if(o(u))return k(u);if(a(u)){let h=u.action.bind(n);return b(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return b(u,h),h}return s(u)?d(u):u},"bind_or_clone"),O=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),j=r((u,h,v)=>(u[h]=v,v),"cache_result"),$=r((u,h)=>{let v=O();return v&&g(v,h)?j(u,h,C(v[h])):g(f,h)?j(u,h,C(f[h])):j(u,h,void 0)},"compute_and_cache"),A=r(()=>{let u=O(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(u)for(let v of Reflect.ownKeys(u))h.add(v);return Array.from(h)},"union_keys"),x=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(w,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:$(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let v=O();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>A(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return x(u,h);let v=O();if(v&&g(v,h)||g(f,h))return g(u,h)||$(u,h),x(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,v)=>"value"in v?(u[h]=v.value,!0):!1,"defineProperty"),set:r((u,h,v)=>(u[h]=v,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(O_,"create_actions_proxy");var Ds=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&zs(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return n1(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return zs(s,t),!C_(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=O_(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),S_(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),S_(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),i1(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return o1(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var YI=Object.getPrototypeOf(async function(){}).constructor,Rs=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof YI?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return zs(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=O_(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var q_=class extends Ds{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var _e=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var $_=class extends _e{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var j_=class extends _e{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var r1=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var T_=class extends _e{static{r(this,"ImageContextItemAdapter")}static detect(e){return r1.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var N_=class extends _e{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var jr=class extends Rs{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},ui={version:1,class:jr,collection_key:"context_items",item_type:q_,context_item_adapters:{BlockContextItemAdapter:$_,SourceContextItemAdapter:j_,ImageContextItemAdapter:T_,PdfContextItemAdapter:N_}};var v1=require("obsidian");var I_=require("obsidian");var ZI=r((n="")=>{if(typeof n!="string")return"";let e=n.lastIndexOf("#");return e===-1||e===n.length-1?"":n.slice(e+1)},"extract_heading_from_key"),QI=r((n="")=>!n||n==="---frontmatter---"?!0:/^\{?\d+\}?$/.test(n),"is_invalid_heading_candidate"),d1=r((n=[])=>{if(!Array.isArray(n))return[];let e=n.reduce((t,s)=>{let i=s?.key||s?.data?.key;if(!i)return t;let o=ZI(i);return QI(o)||(t[o]=(t[o]||0)+1),t},{});return Object.entries(e).sort((t,s)=>{let i=s[1]-t[1];return i!==0?i:t[0].localeCompare(s[0])}).map(([t,s])=>({heading:t,count:s}))},"collect_heading_candidates"),a1=r((n="")=>String(n).trim().toLowerCase(),"normalize_heading"),e4=r(n=>Array.isArray(n)?{include_headings:[],exclude_headings:n.map(e=>e?.trim()).filter(Boolean)}:!n||typeof n!="object"?{include_headings:[],exclude_headings:[]}:Object.entries(n).reduce((e,[t,s])=>(typeof t!="string"||!t.trim()||(s?.include===!0?e.include_headings.push(t.trim()):e.exclude_headings.push(t.trim())),e),{include_headings:[],exclude_headings:[]}),"split_heading_settings"),c1=r((n={})=>{let{block_ranges:e={},headings:t=[]}=n;if(!t.length||!e||typeof e!="object")return[];let s=new Set(t.map(i=>a1(i)).filter(Boolean));return s.size?Object.entries(e).reduce((i,[o,a])=>{if(!Array.isArray(a)||a.length<2)return i;let c=a1(o);return Array.from(s).some(d=>c.endsWith(`#${d}`))&&i.push({start:a[0],end:a[1]}),i},[]):[]},"get_heading_line_ranges"),t4=r((n=[],e=0)=>!Array.isArray(n)||!n.length?[]:n.map(({start:s,end:i})=>({start:Math.max(1,Math.min(s,e||s)),end:Math.max(1,Math.min(i,e||i))})).filter(({start:s,end:i})=>Number.isFinite(s)&&Number.isFinite(i)&&i>=s).sort((s,i)=>s.start-i.start).reduce((s,i)=>{let o=s[s.length-1];return!o||i.start>o.end+1?(s.push({...i}),s):(o.end=Math.max(o.end,i.end),s)},[]),"normalize_line_ranges"),l1=r((n=[],e={})=>{let{ranges:t=[],mode:s="exclude"}=e;if(!Array.isArray(n)||!n.length)return"";let i=t4(t,n.length);if(!i.length)return n.join(`
`);let o=new Array(n.length).fill(s==="exclude");return i.forEach(({start:a,end:c})=>{let l=Math.max(0,a-1),d=Math.min(n.length-1,c-1);for(let _=l;_<=d;_+=1)o[_]=s==="include"}),n.filter((a,c)=>o[c]).join(`
`)},"filter_lines_by_ranges"),_1=r((n,e={})=>{if(typeof n!="string"||!n.length)return n;let{block_ranges:t={},heading_settings:s={}}=e,{include_headings:i,exclude_headings:o}=e4(s);if(!i.length&&!o.length||!t||typeof t!="object")return n;let a=c1({block_ranges:t,headings:i});if(i.length&&a.length)return l1(n.split(`
`),{ranges:a,mode:"include"});let c=c1({block_ranges:t,headings:o});return c.length?l1(n.split(`
`),{ranges:c,mode:"exclude"}):n},"apply_heading_filters");var u1=`.sc-heading-modal .sc-heading-filters {\r
padding: 14px 14px 10px 14px;\r
border-bottom: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-heading-modal .sc-heading-filters__top {\r
display: flex;\r
align-items: flex-start;\r
justify-content: space-between;\r
gap: 12px;\r
}\r
\r
.sc-heading-modal .sc-heading-filters__title {\r
margin: 0;\r
padding: 0;\r
font-size: 16px;\r
line-height: 1.2;\r
letter-spacing: -0.01em;\r
}\r
\r
.sc-heading-modal .sc-heading-filters__subtitle {\r
margin: 6px 0 0 0;\r
padding: 0;\r
font-size: 12px;\r
line-height: 1.35;\r
color: var(--text-muted);\r
max-width: 52ch;\r
}\r
\r
.sc-heading-modal .sc-heading-filters__meta {\r
display: flex;\r
align-items: center;\r
justify-content: space-between;\r
gap: 12px;\r
margin-top: 10px;\r
}\r
\r
.sc-heading-modal .sc-heading-count {\r
font-size: 12px;\r
color: var(--text-muted);\r
}\r
\r
.sc-heading-modal .sc-heading-clear {\r
font-size: 12px;\r
padding: 6px 10px;\r
border-radius: 999px;\r
border: 1px solid var(--background-modifier-border);\r
background: transparent;\r
color: var(--text-muted);\r
cursor: pointer;\r
transition: background-color 120ms ease, color 120ms ease, transform 120ms ease;\r
user-select: none;\r
}\r
\r
.sc-heading-modal .sc-heading-clear:hover {\r
background: var(--background-modifier-hover);\r
color: var(--text-normal);\r
}\r
\r
.sc-heading-modal .sc-heading-clear:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-heading-modal .sc-heading-list {\r
margin-top: 10px;\r
display: flex;\r
flex-direction: column;\r
gap: 8px;\r
max-height: 210px;\r
overflow: auto;\r
padding-right: 2px;\r
}\r
\r
.sc-heading-modal .sc-heading-empty {\r
padding: 10px 10px;\r
border-radius: 12px;\r
border: 1px dashed var(--background-modifier-border);\r
color: var(--text-muted);\r
font-size: 12px;\r
line-height: 1.35;\r
background: var(--background-secondary);\r
}\r
\r
.sc-heading-modal .sc-heading-row {\r
display: flex;\r
align-items: center;\r
justify-content: space-between;\r
gap: 12px;\r
padding: 8px 10px;\r
border-radius: 12px;\r
border: 1px solid var(--background-modifier-border);\r
background: var(--background-secondary);\r
transition: background-color 120ms ease, border-color 120ms ease, box-shadow 120ms ease;\r
}\r
\r
.sc-heading-modal .sc-heading-row:hover {\r
background: var(--background-modifier-hover);\r
}\r
\r
.sc-heading-modal .sc-heading-row.is-flash {\r
border-color: var(--interactive-accent);\r
box-shadow: 0 0 0 1px var(--interactive-accent);\r
}\r
\r
.sc-heading-modal .sc-heading-row__label {\r
flex: 1;\r
min-width: 0;\r
font-size: 13px;\r
line-height: 1.25;\r
color: var(--text-normal);\r
word-break: break-word;\r
}\r
\r
.sc-heading-modal .sc-heading-row__controls {\r
display: flex;\r
align-items: center;\r
gap: 8px;\r
flex-shrink: 0;\r
}\r
\r
.sc-heading-modal .sc-segment {\r
display: inline-flex;\r
align-items: center;\r
padding: 2px;\r
border-radius: 999px;\r
border: 1px solid var(--background-modifier-border);\r
background: var(--background-modifier-hover);\r
}\r
\r
.sc-heading-modal .sc-segment__btn {\r
border: 0;\r
background: transparent;\r
padding: 4px 10px;\r
border-radius: 999px;\r
font-size: 12px;\r
line-height: 1.2;\r
color: var(--text-muted);\r
cursor: pointer;\r
transition: background-color 120ms ease, color 120ms ease, transform 120ms ease;\r
user-select: none;\r
}\r
\r
.sc-heading-modal .sc-segment__btn:hover {\r
color: var(--text-normal);\r
}\r
\r
.sc-heading-modal .sc-segment__btn.is-active {\r
background: var(--background-primary);\r
color: var(--text-normal);\r
box-shadow: 0 1px 2px rgba(0,0,0,0.18);\r
}\r
\r
.sc-heading-modal .sc-segment__btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-heading-modal .sc-heading-remove {\r
width: 26px;\r
height: 26px;\r
border-radius: 999px;\r
border: 1px solid var(--background-modifier-border);\r
background: transparent;\r
color: var(--text-muted);\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
cursor: pointer;\r
transition: background-color 120ms ease, color 120ms ease, transform 120ms ease;\r
user-select: none;\r
}\r
\r
.sc-heading-modal .sc-heading-remove:hover {\r
background: var(--background-modifier-hover);\r
color: var(--text-normal);\r
}\r
\r
.sc-heading-modal .sc-heading-remove:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-heading-modal .sc-heading-footer {\r
margin-top: 8px;\r
display: flex;\r
align-items: center;\r
justify-content: flex-start;\r
}\r
\r
.sc-heading-modal .sc-heading-toggle {\r
font-size: 12px;\r
padding: 6px 10px;\r
border-radius: 999px;\r
border: 1px solid var(--background-modifier-border);\r
background: transparent;\r
color: var(--text-muted);\r
cursor: pointer;\r
transition: background-color 120ms ease, color 120ms ease, transform 120ms ease;\r
user-select: none;\r
}\r
\r
.sc-heading-modal .sc-heading-toggle:hover {\r
background: var(--background-modifier-hover);\r
color: var(--text-normal);\r
}\r
\r
.sc-heading-modal .sc-heading-toggle:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-heading-modal .sc-heading-clear:focus-visible,\r
.sc-heading-modal .sc-segment__btn:focus-visible,\r
.sc-heading-modal .sc-heading-remove:focus-visible,\r
.sc-heading-modal .sc-heading-toggle:focus-visible {\r
outline: none;\r
box-shadow: 0 0 0 2px var(--interactive-accent);\r
}\r
\r
@media (prefers-reduced-motion: reduce) {\r
.sc-heading-modal .sc-heading-clear,\r
.sc-heading-modal .sc-heading-row,\r
.sc-heading-modal .sc-segment__btn,\r
.sc-heading-modal .sc-heading-remove,\r
.sc-heading-modal .sc-heading-toggle {\r
transition: none;\r
}\r
}`;var m1=r(n=>{let e=0,t=0;return!n||typeof n.forEach!="function"?{include_count:e,exclude_count:t,total:0}:(n.forEach(s=>{s===!0?e+=1:t+=1}),{include_count:e,exclude_count:t,total:e+t})},"count_heading_modes"),p1=r(n=>!n||typeof n.entries!="function"?[]:Array.from(n.entries()).filter(([e])=>typeof e=="string"&&e.trim().length>0).map(([e,t])=>[e,t===!0]).sort((e,t)=>e[0].localeCompare(t[0])),"get_sorted_heading_entries"),h1=r((n=[],e={})=>{if(!Array.isArray(n))return[];let t=e.show_all===!0,s=Number.isFinite(e.max_visible)?e.max_visible:8;return n.length<=s||t?n:n.slice(0,s)},"get_visible_heading_entries"),f1=r((n={})=>{if((Number.isFinite(n.total)?n.total:0)===0)return"No filters selected";let t=Number.isFinite(n.include_count)?n.include_count:0,s=Number.isFinite(n.exclude_count)?n.exclude_count:0;return`${t} include, ${s} exclude`},"get_count_text"),g1=r((n={})=>{let e=n.show_all===!0,t=Number.isFinite(n.total)?n.total:0;return e?"Show less":`Show all (${t})`},"get_toggle_text");var n4=r(n=>n?n.nodeType===1?n:n.nodeType===11&&n.firstElementChild||null:null,"get_container_el"),i4=r(n=>{let e=n?.heading_map,t=n?.show_all===!0,s=Number.isFinite(n?.max_visible)?n.max_visible:8;return{heading_map:e&&typeof e.forEach=="function"?e:new Map,show_all:t,max_visible:s}},"get_modal_state"),o4=r((n={})=>{let e=Array.isArray(n.entries)?n.entries.length:0,t=Number.isFinite(n.max_visible)?n.max_visible:8;return{should_collapse:e>t,visible:h1(n.entries,{show_all:n.show_all===!0,max_visible:t})}},"derive_visibility");function r4(n,e={}){let t=r(w=>this.escape_html(String(w??"")),"escape_html"),{heading_map:s,show_all:i,max_visible:o}=i4(n),a=p1(s),{include_count:c,exclude_count:l,total:d}=m1(s),_=f1({include_count:c,exclude_count:l,total:d}),{should_collapse:m,visible:p}=o4({modal:n,entries:a,max_visible:o,show_all:i}),f=d>0?`
<button
type="button"
class="sc-heading-clear"
data-sc-action="clear_all"
aria-label="Clear all heading filters"
>Clear</button>
`:"",y=a.length?p.map(([w,b])=>{let k=t(w);return`
<div class="sc-heading-row" data-heading="${k}">
<div class="sc-heading-row__label">${k}</div>

<div class="sc-heading-row__controls">
<div class="sc-segment">
<button
type="button"
class="${`sc-segment__btn${b===!0?" is-active":""}`}"
data-sc-action="set_include"
data-sc-heading="${k}"
aria-label="Set &quot;${k}&quot; to Include"
>Include</button>

<button
type="button"
class="${`sc-segment__btn${b!==!0?" is-active":""}`}"
data-sc-action="set_exclude"
data-sc-heading="${k}"
aria-label="Set &quot;${k}&quot; to Exclude"
>Exclude</button>
</div>

<button
type="button"
class="sc-heading-remove"
data-sc-action="remove"
data-sc-heading="${k}"
aria-label="Remove heading filter &quot;${k}&quot;"
>x</button>
</div>
</div>
`}).join(""):`
<div class="sc-heading-empty">
Add headings below to include or exclude sections from exports.
</div>
`,g=m?(()=>{let w=g1({show_all:i,total:a.length}),b=t(w);return`
<div class="sc-heading-footer">
<button
type="button"
class="sc-heading-toggle"
data-sc-action="toggle_show_all"
aria-label="${b}"
>${b}</button>
</div>
`})():"";return`
<div class="sc-heading-filters" data-component="context_headings_filters">
<div class="sc-heading-filters__top">
<div>
<h3 class="sc-heading-filters__title">Heading filters</h3>
<p class="sc-heading-filters__subtitle">
Include wins. If no included headings exist in a file, excludes apply.
</p>
</div>

${f}
</div>

<div class="sc-heading-filters__meta">
<div class="sc-heading-count">${t(_)}</div>
</div>

<div class="sc-heading-list">
${y}
</div>

${a.length?g:""}
</div>
`.trim()}r(r4,"build_html");function a4(n,e,t={}){if(!e||!n)return e;let s=r((o,a)=>{let c=n?.heading_map;if(!(!c||typeof c.get!="function")){if(o==="clear_all"){c.clear(),n.show_all=!1,n.persist_selection?.(),n.render_heading_list?.(),n.updateSuggestions?.();return}if(o==="toggle_show_all"){n.show_all=!n.show_all,n.render_heading_list?.(),n.updateSuggestions?.();return}if(!(typeof a!="string"||a.trim().length===0)){if(o==="set_include"){if(c.get(a)===!0)return;c.set(a,!0),n.persist_selection?.(),n.render_heading_list?.(),n.updateSuggestions?.(),n.flash_heading_row?.(a);return}if(o==="set_exclude"){if(c.get(a)!==!0)return;c.set(a,!1),n.persist_selection?.(),n.render_heading_list?.(),n.updateSuggestions?.(),n.flash_heading_row?.(a);return}o==="remove"&&(c.delete(a),c.size<=(n.max_visible||8)&&(n.show_all=!1),n.persist_selection?.(),n.render_heading_list?.(),n.updateSuggestions?.())}}},"handle_action"),i=r(o=>{let c=o?.target?.closest?.("button[data-sc-action]");if(!c||!e.contains(c))return;o.preventDefault?.();let l=c.getAttribute("data-sc-action")||"",d=c.getAttribute("data-sc-heading")||"";s(l,d)},"on_click");return e.addEventListener("click",i),this.attach_disposer(e,()=>e.removeEventListener("click",i)),e}r(a4,"post_process");function mi(n,e={}){this.apply_style_sheet(u1);let t=r4.call(this,n,e),s=this.create_doc_fragment(t),i=n4(s)||document.createElement("div");return a4.call(this,n,i,e),i}r(mi,"render");mi.version=1;var c4=r((n="")=>typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(String(n)):String(n).replace(/["\\]/g,"\\$&"),"css_escape"),l4=r((n={})=>!n||typeof n!="object"?new Map:Object.entries(n).reduce((e,[t,s])=>(!t||typeof t!="string"||e.set(t,s?.include===!0),e),new Map),"build_heading_map"),d4=r(n=>{if(!n||typeof n.forEach!="function")return{};let e={};return n.forEach((t,s)=>{!s||typeof s!="string"||(e[s]={include:t===!0})}),e},"serialize_heading_map"),P_=class extends I_.FuzzySuggestModal{static{r(this,"ContextHeadingsModal")}constructor(e,t){super(e),this.context_items=t,this.heading_map=l4(this.context_items?.settings?.headings),this.prevent_close=!1,this.show_all=!1,this.max_visible=8,this.setPlaceholder("Search headings...")}open(){super.open(),this.modalEl&&this.modalEl.classList.add("sc-heading-modal"),this.render_heading_list()}getItems(){let e=Object.values(this.context_items?.env?.smart_blocks?.items||{}),t=d1(e);return t.length||new I_.Notice("No headings detected in your vault yet."),t}getItemText(e){let t=e?.heading||"",s=e?.count;return t?Number.isFinite(s)?`${t} (${s})`:t:""}onChooseItem(e){this.prevent_close=!0;let t=e?.heading||"";if(!t)return;if(!this.heading_map.has(t)){this.heading_map.set(t,!1),this.persist_selection(),this.render_heading_list(),this.updateSuggestions(),this.flash_heading_row(t);return}this.render_heading_list(),this.updateSuggestions(),this.flash_heading_row(t)}persist_selection(){let e=d4(this.heading_map);this.context_items?.settings&&(this.context_items.settings.headings=e)}render_heading_list(){if(!this.modalEl)return;let e=this.context_items?.env,t=e?.smart_components,s=e?.smart_view,i=r(o=>{if(!o)return;let a=this.modalEl.querySelector(".sc-heading-filters");a&&a.remove(),this.modalEl.prepend(o)},"apply_root");if(t?.render_component){t.render_component("context_headings_filters",this).then(o=>i(o)).catch(o=>{console.error("ContextHeadingsModal: failed to render heading filters component",o),s&&i(mi.call(s,this))});return}s&&i(mi.call(s,this))}flash_heading_row(e){if(!this.modalEl||!e)return;let t=`[data-heading="${c4(e)}"]`,s=this.modalEl.querySelector(t);if(s){try{s.scrollIntoView({block:"nearest"})}catch{}s.classList.add("is-flash"),window.setTimeout(()=>s.classList.remove("is-flash"),450)}}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var y1=P(require("node:fs/promises"),1),b1=P(require("node:fs"),1),M_=P(require("node:path"),1);var L_=class extends _e{static{r(this,"ExternalContextItemAdapter")}static detect(e){return e.startsWith("external:")?"external":!1}get path(){return this.item.key.replace(/^external(-folder)?:/,"")}async get_text(){let t=(this.item.env?.smart_context_plugin?.app||window.app).vault.adapter.basePath,s=M_.default.join(t,this.path);try{return await y1.default.readFile(s,"utf8")}catch(i){return console.error(`ExternalContextItemAdapter: Error reading file at ${s}`,i),{error:`Error reading file at ${this.path}: ${i.message}`}}}async open(){let t=(this.item.env?.smart_context_plugin?.app||window.app).vault.adapter.basePath,s=M_.default.join(t,this.path);_4(s)}get exists(){let e=this.item.env.smart_context_plugin.app.vault.adapter.basePath,t=M_.default.join(e,this.path);return b1.default.existsSync(t)}};function _4(n){try{let{shell:e}=window.require("electron");e.openPath(n)}catch(e){console.error("shell.openPath failed",e)}}r(_4,"open_external");var z_=/!\[\[\s*([^\]\|#]+\.base)\s*(#[^\]\|]+)?\s*(?:\|\s*[^\]]*)?\s*\]\]/g,u4=r(n=>Object.values(n.data?.outlinks||{}).some(e=>e.target.includes(".base")),"has_base_outlink"),m4=r((n,e={})=>{let{file_path:t,cache:s}=e;return!n||!s||!t||(z_.lastIndex=0,!z_.test(n))?n:(z_.lastIndex=0,n.replace(z_,(i,o,a="")=>{let c=`${t}#${o}${a}`;return s?.[c]?.markdown_table?.trim?.()||i}))},"render_bases_embeds"),D_=class extends _e{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){let e=await this.ref?.read();if(!e)return"MISSING SOURCE";let t=this.item?.settings?.headings||{},s=this.ref?.data?.blocks||{};e=_1(e,{block_ranges:s,heading_settings:t});let i=this.env?.bases_caches?.items;return!u4(this.ref)||!i?e:m4(e,{file_path:this.ref?.path||this.item.key,cache:i})}async open(e=null){this.ref.actions.source_open(e)}};var hg=class extends jr{static{r(this,"ContextItems")}static get default_settings(){return{...super.default_settings,headings:{}}}get settings_config(){return{...super.settings_config,headings:{group:"Headings",type:"button",name:"Manage heading filters",description:"Choose headings to include or exclude when exporting context items.",scope_class:"pro-setting",callback:r(function(){if(!this.env?.is_pro){new v1.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}let e=this.env?.main?.app;if(!e){console.warn("Context headings modal requires Obsidian app context.");return}new P_(e,this).open()},"callback")},headings_explanation:{group:"Headings",type:"html",value:`
<b>Include</b> keeps only the selected headings when found.<br />
<b>Exclude</b> removes those heading sections from exports.
`}}}};ui.context_item_adapters.SourceContextItemAdapter=D_;ui.version=2;ui.context_item_adapters.ExternalContextItemAdapter=L_;ui.class=hg;var k1=ui;var R_=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Tr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Tr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var F_=class extends R_{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Nr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Nr=class extends Tr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var w1={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},B_=class extends F_{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=U_;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},U_=class extends Nr{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return w1[s]&&(s=w1[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function fg(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():x1(a)?n[o]=fg(x1(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(fg,"ajson_merge");function x1(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(x1,"is_object");var E1={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function p4(n){let e=!1,[t,...s]=n.split(":");return E1[t]&&(t=E1[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(p4,"_parse_ajson_key");var Pr=class extends B_{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:w}=p4(p),b=`${y}:${g}`;f?(i[b]=f,(w||b!==p)&&(delete i[p],t=!0)):(delete i[b],(w||b!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=fg(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}};function A1(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(A1,"filter_redundant_context_items");var S1=r((n,e)=>!e||!n?.[e]?!1:n[e].folder?n[e].exclude?!1:(n[e].exclude=!0,!0):(delete n[e],!0),"remove_context_item_data"),Ir=class extends Ds{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:s=!0}=t;S1(this.data.context_items,e)&&(this.queue_save(),s&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:s=!0}=t,i=Array.isArray(e)?e:[e],o=[];return i.forEach(a=>{S1(this.data.context_items,a)&&o.push(a)}),o.length?(this.queue_save(),s&&this.emit_event("context:updated",{removed_keys:o}),o):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return A1(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var pi=class extends Rs{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var h4={class:pi,data_adapter:Pr,item_type:Ir};var W_=h4;var gg=class extends pi{static{r(this,"SmartContexts")}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>",actions:{context_suggest_external:{max_search_depth:5,max_search_items:1e4}}}}async process_load_queue(){await super.process_load_queue(),Object.entries(this.items).forEach(([e,t])=>{e.endsWith("#codeblock")&&t.delete()}),this.process_save_queue()}get settings_config(){return{"actions.context_suggest_external.max_search_depth":{group:"External sources",type:"number",name:"Max search depth",description:"Max folder depth to scan for external sources.",scope_class:"pro-setting"},"actions.context_suggest_external.max_search_items":{group:"External sources",type:"number",name:"Max search items",description:"Max items to keep after each full depth scan.",scope_class:"pro-setting"},...super.settings_config}}};W_.class=gg;W_.version="3.0.0";var C1=W_;var O1=`.sc-context-codeblock-container {\r
background-color: var(--code-background);\r
.cb-actions {\r
display: flex;\r
align-items: center;\r
gap: 8px;\r
padding: 8px;\r
width: 100%;\r
}\r
.cb-actions > .sc-codeblock-help {\r
margin-left: auto; /* justifty at the end */\r
margin-right: var(--size-4-8);\r
}\r
}`;var q1=require("obsidian");function g4(n,e={}){return`<div>
<div class="sc-context-codeblock-container">
<div class="cb-actions">
<button class="sc-add-external" type="button">Edit context</button>
<button class="sc-copy-clipboard" type="button" style="display:none;">Copy to clipboard</button>
<div class="cb-meta"></div>
<button class="sc-codeblock-help"></button>
</div>
</div>
</div>`}r(g4,"build_html");async function $1(n,e={}){this.apply_style_sheet(O1);let t=g4.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".sc-context-codeblock-container");return y4.call(this,n,i,e),i}r($1,"render");async function y4(n,e,t={}){let s=e.querySelector(".cb-meta"),i=r(async()=>{this.empty(s),s.appendChild(await n.env.render_component("smart_context_meta",n,{...t}))},"render_ctx_meta");e.querySelector(".sc-add-external").addEventListener("click",()=>{n.emit_event("context_selector:open",{default_suggest_action_keys:["context_suggest_external"]})});let a=e.querySelector(".sc-copy-clipboard");n.has_context_items&&(a.style.display="inline-block",a.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()}));let c=e.querySelector(".sc-codeblock-help");(0,q1.setIcon)(c,"help-circle"),c.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/codeblock/?utm_source=codeblock-help","_external")}),i();let l=[];return l.push(n.on_event("context:updated",async()=>{i()})),this.attach_disposer(e,l),e}r(y4,"post_process");function b4(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(b4,"build_html");async function j1(n,e={}){let t=b4(),i=this.create_doc_fragment(t).firstElementChild;return v4.call(this,n,i,e),i}r(j1,"render");async function v4(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o),Dp(n,o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),Lh(n,a),k4(n,a),w4(n,a),zh(n,a),Dh(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(v4,"post_process");var T1="3.0.0";function k4(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.setAttribute("aria-label","Copies an image with copiled media to clipboard"),t.textContent="Copy media",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard({with_media:!0})})}r(k4,"render_btn_copy_text");function w4(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.setAttribute("aria-label","Copies text to clipboard"),t.textContent="Copy text",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard({with_media:!1})})}r(w4,"render_btn_copy_with_media");var Be=require("obsidian");function N1(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${x4(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=E4(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(N1,"format_stats_message");function x4(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(x4,"format_char_count");function E4(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(E4,"sum_exclusions");async function M1(n={}){let e=this.context_items.filter(n.filter);if(!e.length){this.emit_event("notification:warning",{message:"No context items to copy."}),new Be.Notice("No context items to copy.");return}let t=await this.get_text(n),s=typeof t=="string"?t:String(t??""),i={item_count:e.length,char_count:s.length,max_depth:n.max_depth,exclusions:n.exclusions};if(!n.with_media){if(!await Lr(s)){this.emit_event("notification:error",{message:"Failed to copy context to clipboard."}),new Be.Notice("Failed to copy context to clipboard.");return}Mr(i),this.emit_event("context:copied");return}let o=[];try{o=await this.get_media(n),Array.isArray(o)||(o=[])}catch(d){console.error("context_copy_to_clipboard: get_media failed",d),o=[]}let a=$4(s,o);if(!o.length){if(!await Lr(a)){this.emit_event("notification:error",{message:"Failed to copy context (text-only) to clipboard."}),new Be.Notice("Failed to copy context (text-only) to clipboard.");return}Mr({...i,char_count:a.length}),this.emit_event("context:copied");return}if(typeof document>"u"||!document.createElement){if(console.warn("copy_to_clipboard(with_media): no DOM/canvas available; falling back to text-only"),!await Lr(a)){this.emit_event("notification:error",{message:"Failed to copy context (text-only) to clipboard."}),new Be.Notice("Failed to copy context (text-only) to clipboard.");return}Mr({...i,char_count:a.length}),this.emit_event("context:copied");return}let c;try{c=await A4(o)}catch(d){if(console.error("copy_to_clipboard(with_media): failed to build context canvas",d),!await Lr(a)){this.emit_event("notification:error",{message:"Failed to copy context (text-only) to clipboard."}),new Be.Notice("Failed to copy context (text-only) to clipboard.");return}Mr({...i,char_count:a.length}),this.emit_event("context:copied");return}if(!await O4(c,a)){this.emit_event("notification:error",{message:"Failed to copy context image to clipboard."}),new Be.Notice("Failed to copy context image to clipboard.");return}Mr({...i,char_count:a.length}),this.emit_event("context:copied"),this.emit_event("context:copied_with_media")}r(M1,"copy_to_clipboard");async function A4(n){let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("Canvas 2D context not available");let s=24,i=1200,o=18,a='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',c='bold 13px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';e.width=i,e.height=s*2+o*2;let{image_entries:l,other_entries:d}=await C4(n),_=l.length>0||d.length>0,m=0;_&&(m=o+d.length*o);let p=null;l.length>0&&(t.font=a,p=S4(l,{canvas_width:i,padding:s,heading_height:m,line_height:o,ctx:t,base_font:a}));let f;p?f=p.total_height:_?f=s+m+s:f=s*2+o,e.height=Math.max(f,s*2+o),t.fillStyle="#ffffff",t.fillRect(0,0,e.width,e.height),t.fillStyle="#000000",t.textBaseline="top";let y=s;if(_){t.font=c,t.fillText("Attachments",s,y),y+=o,t.font=a;for(let g of d){let b=`- ${yg(g.key||g.name||"",80)} (${g.mime_type})`;t.fillText(b,s,y),y+=o}}if(p&&p.placements&&p.placements.length>0){t.font=a;for(let g of p.placements){let{entry:w,x:b,label_y:k,image_y:C,width:O,height:j,label_lines:$}=g;for(let A=0;A<$.length;A+=1){let x=k+A*o;t.fillText($[A],b,x)}w.image&&O>0&&j>0&&t.drawImage(w.image,b,C,O,j)}}return e}r(A4,"build_context_canvas");function P1(n,e){let s=n.natural_width||n.image?.naturalWidth||n.image?.width||e,i=n.natural_height||n.image?.naturalHeight||n.image?.height||e*.75;if(!(s>0)||!(i>0))return{width:Math.max(1,Math.floor(e)),height:Math.max(1,Math.floor(e*.75))};let o=Math.min(1,e/s),a=Math.max(1,Math.floor(s*o)),c=Math.max(1,Math.floor(i*o));return{width:a,height:c}}r(P1,"compute_scaled_dimensions");function S4(n,e){let{canvas_width:t,padding:s,heading_height:i,line_height:o,ctx:a,base_font:c}=e||{};if(!Array.isArray(n)||n.length===0||!a)return null;let l=16,d=16,_=t-s*2,m=220,p=n.length;if(!(_>0))return null;let f=Math.max(1,Math.floor((_+l)/(m+l))),y=Math.min(p,f,6),g=s+i;a.font=c||a.font||"12px monospace",a.textBaseline="top";let w=4,b=null;for(let $=1;$<=y;$+=1){let A=Math.floor((_-($-1)*l)/$);if(!(A>0))continue;let x=new Array($).fill(0);for(let S of n){let E=P1(S,A),q=S.key||S.name||"image",T=yg(q,80),{height:N}=I1(a,T,E.width,o,w),Y=0;for(let H=1;H<$;H+=1)x[H]<x[Y]&&(Y=H);x[Y]+=N+E.height+d}let u=Math.max(0,...x),h=g+u+s,v=Math.abs(h-t);(!b||v<b.diff||v===b.diff&&h<b.total_height)&&(b={cols:$,cell_width:A,gap_x:l,row_gap:d,top_y:g,image_area_height:u,total_height:h,diff:v})}if(!b)return null;let k=[],C=new Array(b.cols).fill(0);for(let $ of n){let A=P1($,b.cell_width),x=$.key||$.name||"image",u=yg(x,80),{lines:h,height:v}=I1(a,u,A.width,o,w),S=0;for(let H=1;H<b.cols;H+=1)C[H]<C[S]&&(S=H);let E=C[S],T=s+S*(b.cell_width+b.gap_x)+Math.floor((b.cell_width-A.width)/2),N=b.top_y+E,Y=N+v;k.push({entry:$,col:S,x:T,label_y:N,image_y:Y,width:A.width,height:A.height,label_lines:h}),C[S]+=v+A.height+b.row_gap}let O=Math.max(0,...C),j=Math.ceil(p/b.cols);return{cols:b.cols,rows:j,cell_width:b.cell_width,gap_x:b.gap_x,row_gap:b.row_gap,top_y:b.top_y,image_area_height:O,total_height:b.top_y+O+s,placements:k}}r(S4,"compute_best_image_layout");async function C4(n){let e=[],t=[],s=[],i=1;for(let o of n||[]){if(!o||typeof o!="object")continue;let a=typeof o.url=="string"?o.url:"";if(!a)continue;let c=z1(a)||"application/octet-stream",l=typeof o.key=="string"?o.key:"",d=o.name||D1(l,c)||`attachment-${i}`,_=l||d,m=c.startsWith("image/");if((c==="application/pdf"||o.type==="pdf_url")&&a.startsWith("data:")){s.push((async()=>{try{if(typeof Be.loadPdfJs!="function")throw new Error("loadPdfJs not available");let g=await(0,Be.loadPdfJs)(),b=await L1(a).arrayBuffer(),k=new Uint8Array(b),C=await g.getDocument({data:k}).promise,O=C.numPages||0;if(!O)throw new Error("PDF has no pages");for(let $=1;$<=O;$+=1)try{let A=await C.getPage($),x=A.getViewport({scale:1.5}),u=document.createElement("canvas"),h=u.getContext("2d");if(!h)throw new Error("Canvas 2D context not available for PDF");u.width=x.width,u.height=x.height,await A.render({canvasContext:h,viewport:x}).promise;let v=u.toDataURL("image/png"),S=new Image;S.src=v;let E=O>1?` (p${$})`:"",q={key:_+E,name:d+E,mime_type:c,url:v,image:S,natural_width:u.width,natural_height:u.height};e.push(q),await new Promise(T=>{S.onload=()=>T(),S.onerror=()=>{let N=e.indexOf(q);N!==-1&&e.splice(N,1),T()}})}catch(A){console.warn("normalize_media_for_canvas: failed to render PDF page",$,_,A)}e.some($=>!$||!$.key?!1:$.key===_?!0:$.key.startsWith(_+" (p"))||t.push({key:_,name:d,mime_type:c})}catch(g){console.warn("normalize_media_for_canvas: failed to render PDF via loadPdfJs",g),t.push({key:_,name:d,mime_type:c})}})()),i+=1;continue}if(!m||!a.startsWith("data:")){t.push({key:_,name:d,mime_type:c}),i+=1;continue}let f=new Image;f.src=a;let y={key:_,name:d,mime_type:c,url:a,image:f,natural_width:0,natural_height:0};e.push(y),i+=1,s.push(new Promise(g=>{f.onload=()=>{try{y.natural_width=f.naturalWidth||f.width||0,y.natural_height=f.naturalHeight||f.height||0}catch{let b=e.indexOf(y);b!==-1&&e.splice(b,1),t.push({key:_,name:d,mime_type:c})}g()},f.onerror=()=>{let w=e.indexOf(y);w!==-1&&e.splice(w,1),t.push({key:_,name:d,mime_type:c}),g()}}))}return await Promise.all(s),{image_entries:e,other_entries:t}}r(C4,"normalize_media_for_canvas");async function O4(n,e){if(!n)return!1;try{if(typeof navigator<"u"&&navigator.clipboard&&typeof navigator.clipboard.write=="function"&&typeof ClipboardItem<"u"){let t=await q4(n);if(t){let s={[t.type]:t};typeof Blob<"u"&&(s["text/plain"]=new Blob([e],{type:"text/plain"}));let i=new ClipboardItem(s);return await navigator.clipboard.write([i]),!0}}}catch(t){console.warn("copy_canvas_with_fallback: navigator.clipboard.write failed",t)}try{if(typeof window<"u"&&typeof window.require=="function"){let t=n.toDataURL("image/png"),{clipboard:s,nativeImage:i}=window.require("electron");if(s&&i){let o=i.createFromDataURL(t);return typeof s.write=="function"?s.write({image:o,text:e}):typeof s.writeImage=="function"&&(s.writeImage(o),typeof s.writeText=="function"&&s.writeText(e)),!0}}}catch(t){console.warn("copy_canvas_with_fallback: electron clipboard.write failed",t)}return await Lr(e)}r(O4,"copy_canvas_with_fallback");function q4(n){return new Promise((e,t)=>{if(!n)return t(new Error("Canvas is null"));if(typeof n.toBlob=="function"){n.toBlob(s=>{s?e(s):t(new Error("canvas.toBlob returned null"))},"image/png");return}try{let s=n.toDataURL("image/png"),i=L1(s);e(i)}catch(s){t(s)}})}r(q4,"get_canvas_blob");function L1(n){let e=/^data:([^;]+);base64,(.+)$/.exec(n);if(!e)throw new Error("Invalid data URL");let t=e[1],s=e[2],i="";if(typeof atob=="function")i=atob(s);else if(typeof Buffer<"u")i=Buffer.from(s,"base64").toString("binary");else throw new Error("No base64 decoder available");let o=i.length,a=new Uint8Array(o);for(let c=0;c<o;c++)a[c]=i.charCodeAt(c);return new Blob([a],{type:t})}r(L1,"data_url_to_blob");async function Lr(n){try{if(typeof navigator<"u"&&navigator.clipboard&&typeof navigator.clipboard.writeText=="function")return await navigator.clipboard.writeText(n),!0}catch(e){console.warn("copy_text_to_clipboard: navigator.clipboard.writeText failed",e)}try{if(typeof window<"u"&&typeof window.require=="function"){let{clipboard:e}=window.require("electron");if(e&&typeof e.writeText=="function")return e.writeText(n),!0}}catch(e){console.warn("copy_text_to_clipboard: electron.clipboard.writeText failed",e)}try{if(typeof document<"u"){let e=document.createElement("textarea");e.value=n,e.style.position="fixed",e.style.opacity="0",e.style.pointerEvents="none",document.body.appendChild(e),e.focus(),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}}catch(e){console.warn('copy_text_to_clipboard: execCommand("copy") failed',e)}return!1}r(Lr,"copy_text_to_clipboard");function $4(n,e){let t=[];t.push(n.trimEnd()),t.push(""),t.push("Attachments:");let s=!1;for(let i of e||[]){if(!i||typeof i!="object")continue;let o=typeof i.url=="string"?i.url:"",a=o&&z1(o)||"file",c=i.key||i.name||D1(i.key,a)||"attachment";t.push(`- ${c} (${a})`),s=!0}return s||t.pop(),t.push(""),t.join(`
`)}r($4,"build_plaintext_with_media");function z1(n){if(typeof n!="string")return null;let e=/^data:([^;]+);base64,/i.exec(n);return e?e[1]:null}r(z1,"extract_mime_type_from_data_url");function D1(n,e){if(typeof n=="string"&&n.trim()){let s=n.split(/[\\/]/),i=s[s.length-1];if(i)return i}return`context.${e.includes("/")?e.split("/")[1]:"bin"}`}r(D1,"derive_name_from_key");function yg(n,e){let t=String(n??"");if(t.length<=e)return t;if(e<=3)return t.slice(0,e);let s=Math.floor((e-3)/2);return t.slice(0,s)+"..."+t.slice(t.length-s)}r(yg,"truncate_middle");function I1(n,e,t,s,i=4){let o=String(e??"");if(!o)return{lines:[""],height:s};if(!(t>0))return{lines:[o],height:s};let a=[],c=0,l=o.length;for(;c<l&&a.length<i;){let _=c,m=-1;for(;_<l;){let p=o[_];(p===" "||p==="	"||p==="/"||p==="\\"||p==="-")&&(m=_+1);let f=o.slice(c,_+1);if(n.measureText(f).width>t){if(m>c){let g=o.slice(c,m).trimEnd();g&&a.push(g),c=m}else{let g=o.slice(c,_).trimEnd();g?(a.push(g),c=_):(a.push(o.slice(c,_+1)),c=_+1)}break}_+=1}if(_>=l){let p=o.slice(c).trimEnd();p&&a.push(p),c=l}}if(c<l&&a.length>=i){let _=a.length-1,m=a[_],p="...",f=m+p,y=n.measureText(f).width;if(y<=t)a[_]=f;else{for(;m.length>1&&y>t;)m=m.slice(0,-1),f=m+p,y=n.measureText(f).width;a[_]=f}}return a.length||a.push(o),{lines:a,height:a.length*s}}r(I1,"wrap_text_lines");function Mr(n){new Be.Notice(N1(n))}r(Mr,"show_stats_notice");var R1=2;var F1="Chat Threads";function j4(n){return n?.chat_threads||n?.smart_chat_threads||null}r(j4,"get_threads_collection");async function B1(n={}){let e=this,t=e?.env,s=n?.modal;s?.setInstructions&&s.setInstructions([{command:"Enter",purpose:"Add chat thread to context"}]);let i=j4(t);if(!i?.items)return[{key:"chat_threads:missing",display:"Chat Threads: collection not available (stub)"}];let o=Object.values(i.items||{}).filter(Boolean);return o.length?o.map(a=>{let c=a?.key||a?.data?.key,l=a?.data?.name||a?.data?.title||c;return{key:`chat_thread:${c}`,display:String(l),select_action:r(()=>{e.add_item({key:`thread:${c}`,d:0})},"select_action")}}):[{key:"chat_threads:none",display:"No chat threads found"}]}r(B1,"context_suggest_chat_threads");var U1="Named contexts";function T4(n){let t=n?.smart_contexts?.items;return!t||typeof t!="object"?[]:Object.values(t).filter(Boolean)}r(T4,"list_context_items");function N4(n,e){let t=[];for(let s=0;s<e.length;s+=1){let i=e[s];if(!i||typeof i.key!="string")continue;let o=Number.isFinite(i.d)?i.d:0,a=n?.data?.context_items?.[i.key],c=Number.isFinite(a?.d)?a.d:null;t.push({key:i.key,d:c===null?o:Math.min(c,o)})}return t}r(N4,"normalize_items_preserving_depth");function P4(n){let e=n?.data?.context_items||{},t=Object.entries(e),s=[];for(let i=0;i<t.length;i+=1){let[o,a]=t[i];if(!o||a?.exclude)continue;let c=Number.isFinite(a?.d)?a.d:0;s.push({key:o,d:c})}return s}r(P4,"get_items_from_context");async function W1(n={}){let e=this,t=e?.env,s=n?.modal;s?.setInstructions&&s.setInstructions([{command:"Enter",purpose:"Merge selected context into current context"},{command:"Mod + Enter",purpose:"Open in Context Selector"}]);let i=T4(t).filter(a=>{let c=a?.data?.name;return typeof c=="string"&&c.trim().length>0}).sort((a,c)=>{let l=String(a.data.name).trim().toLowerCase(),d=String(c.data.name).trim().toLowerCase();return l.localeCompare(d)});if(!i.length)return[{key:"contexts:none",display:"No named contexts found"}];let o=[];for(let a=0;a<i.length;a+=1){let c=i[a],l=c?.key||c?.data?.key,d=String(c?.data?.name||"").trim(),_=c?.item_count||Object.keys(c?.data?.context_items||{}).length;o.push({key:`named_context:${l}`,display:`${d} (${_})`,item:c,select_action:r(({modal:m})=>{let p=P4(c),f=N4(e,p);e.add_items(f),m?.setInstructions&&m.setInstructions([{command:"Enter",purpose:`Merged ${f.length} item(s) from ${d}`}])},"select_action"),mod_select_action:r(({modal:m})=>{m?.close&&m.close(),e.emit_event("context_selector:open",{collection_key:"smart_contexts",item_key:l})},"mod_select_action")})}return o}r(W1,"context_suggest_contexts");var ue=P(require("path"),1),vg=P(require("fs"),1);var V1="Add external sources",H_=5,J_=1e4,kg={max_search_depth:H_,max_search_items:J_},I4=[".git","node_modules","package-lock.json",".obsidian",".smart-env"],M4=new Set(I4),L4=3e4,z4=10,Yt=new Map,D4=3e4,R4=10,bg=new WeakMap;function G_(n,e){if(typeof n=="string"&&n.trim()!==""){let s=Number(n);Number.isFinite(s)&&(n=s)}if(typeof n!="number"||!Number.isFinite(n))return e;let t=Math.floor(n);return t>=0?t:e}r(G_,"coerce_non_negative_int");function F4(n,e={}){let t=n.collection?.constructor?.default_settings?.actions?.context_suggest_external||{},s={...kg,...t,...e.default_settings||{}},o=(n?.settings||{})?.actions?.context_suggest_external||{};return{max_search_depth:G_(o.max_search_depth,s.max_search_depth),max_search_items:G_(o.max_search_items,s.max_search_items)}}r(F4,"resolve_action_settings");function B4(n,e={}){let{max_search_depth:t,max_search_items:s}=F4(n,e);return{max_depth:G_(e.max_depth,t),max_results:G_(e.max_results,s)}}r(B4,"resolve_action_limits");function U4(n){let e=Yt.get(n);return e?Date.now()-e.ts>L4?(Yt.delete(n),null):(Yt.delete(n),Yt.set(n,e),e.items):null}r(U4,"get_listing_cache");function W4(n,e){for(Yt.set(n,{ts:Date.now(),items:e});Yt.size>z4;){let t=Yt.keys().next().value;Yt.delete(t)}}r(W4,"set_listing_cache");function X1(n){let e=bg.get(n);if(e)return e;let t=new Map;return bg.set(n,t),t}r(X1,"get_ctx_suggestion_cache");var G1=H_,H1=J_;function G4(n,e,t,s){if(t!==G1||s!==H1)return bg.delete(n),G1=t,H1=s,null;let i=X1(n),o=i.get(e);return o?Date.now()-o.ts>D4?(i.delete(e),null):(i.delete(e),i.set(e,o),o.suggestions):null}r(G4,"get_suggestions_cache");function H4(n,e,t){let s=X1(n);for(s.set(e,{ts:Date.now(),suggestions:t});s.size>R4;){let i=s.keys().next().value;s.delete(i)}}r(H4,"set_suggestions_cache");function J1(n,e){let t=n&&n!=="."?n.replace(/\\/g,"/"):"",s=e?e.replace(/\\/g,"/"):"";return t?s?`${t}/${s}`:t:s}r(J1,"join_rel_paths");function K1(n){return typeof n!="string"?"":ue.default.normalize(n).replace(/\\/g,"/")}r(K1,"normalize_path");function J4(n,e,t=0,s=H_,i=!0,o="",a=J_){let c=[];if(t>s)return c;let l=i&&t===0?`${ue.default.normalize(n)}::${ue.default.normalize(e)}::${s}::${a}`:null;if(l){let p=U4(l);if(p)return p}let d=[{dir_path:n,rel_dir:o}],_=t;for(;d.length>0;){let p=[];for(let{dir_path:f,rel_dir:y}of d){let g;try{g=vg.default.readdirSync(f,{withFileTypes:!0})}catch{continue}for(let w of g){if(M4.has(w.name))continue;let b=ue.default.join(f,w.name),k=y?`${y}/${w.name}`:w.name,C=w.isDirectory();!C&&!_l(b)||(c.push({fullPath:b,relativePath:k,isDirectory:C,depth:_+1}),C&&_+1<=s&&p.push({dir_path:b,rel_dir:k}))}}if(c.length>=a){console.log("Too many results, stopping at depth: ",{dir_depth:_,current_level:d,items_length:c.length});break}if(d=p,_+=1,_>s)break}if(!i)return c;let m=c.sort((p,f)=>p.isDirectory&&!f.isDirectory?-1:!p.isDirectory&&f.isDirectory?1:p.depth!==f.depth?p.depth-f.depth:p.relativePath===f.relativePath?0:p.relativePath<f.relativePath?-1:1);return l&&W4(l,m),m}r(J4,"list_dir_files_to_depth");function K4(n,e=H_,t=J_){return J4(n,n,0,e,!0,"",t)}r(K4,"get_external_items");function V4(n,e){if(typeof e?.vault_path=="string"&&e.vault_path)return K1(e.vault_path);let t=n.env?.plugin?.app||window.app;return K1(t.vault.adapter.basePath)}r(V4,"resolve_vault_path");function Fs(n={}){let e=this||{},t=n?.modal;t?.setInstructions&&t.setInstructions([{command:"Enter",purpose:"Open folder / add file to context"},{command:"Mod + Enter",purpose:"Add all items in folder to context"},{command:"\u2192",purpose:"Open folder"},{command:"\u2190",purpose:"Parent folder"}]);let s={...n};delete s.modal;let{max_depth:i,max_results:o}=B4(e,s),a=V4(e,s);if(!a)return[];let c=s.scope||ue.default.dirname(a);if(!c)return[];let l=ue.default.normalize(a),d=l.endsWith(ue.default.sep)?l.slice(0,-1):l,_=ue.default.normalize(c),m=_.endsWith(ue.default.sep)?_.slice(0,-1):_,p=`${d}::${m}::${i}::${o}`,f=G4(e,p,i,o);if(f)return f;let y=K4(c,i,o),g=`${d}${ue.default.sep}`,w=J1(ue.default.relative(d,m),""),b=[],k={key:"up",display:".. (parent folder)",select_action:r(({modal:A}={})=>{let x=ue.default.dirname(c),u={...s,scope:x,modal:A};return Fs.call(e,u)},"select_action")};b.push(k);let O={key:"current",display:`${m} (current folder)`,icon:"folder",select_action:r(({modal:A}={})=>(A?.inputEl&&(A.inputEl.value=""),Fs.call(e,{...s,scope:c,modal:A})),"select_action"),arrow_right_action:r(({modal:A}={})=>(A?.inputEl&&(A.inputEl.value=""),Fs.call(e,{...s,scope:c,modal:A})),"arrow_right_action"),arrow_left_action:r(({modal:A}={})=>j(A),"arrow_left_action"),mod_select_action:r(()=>{e.add_items(Mo(c,a,[".*"]))},"mod_select_action")};b.push(O);for(let A of y){if(A.fullPath===d)continue;let x;if(A.fullPath.startsWith(g)?x=A.fullPath.slice(g.length).replace(/\\/g,"/"):x=J1(w,A.relativePath),!x||!A.relativePath)continue;let u=`external:${x}`,h=A.relativePath,v={vault_path:a,relativePath:A.relativePath,vault_relative_path:x,fullPath:A.fullPath,isDirectory:A.isDirectory,show_path:h,is_external:!0,path:u,key:u},S={key:u,display:h||x,item:v};A.isDirectory?(S.icon="folder",S.select_action=({modal:E}={})=>(E?.inputEl&&(E.inputEl.value=""),$(A,E)),S.arrow_right_action=({modal:E}={})=>(E?.inputEl&&(E.inputEl.value=""),$(A,E)),S.arrow_left_action=({modal:E}={})=>j(E),S.mod_select_action=()=>{e.add_items(Mo(A.fullPath,a,[".*"]))}):S.select_action=()=>{let E=vg.default.statSync(v.fullPath);v.size=E.size,v.mtime=E.mtimeMs,e.add_item(v)},b.push(S)}return H4(e,p,b),b;function j(A){let x=ue.default.join(c,".."),u={...s,scope:x,modal:A};return Fs.call(e,u)}r(j,"goto_parent_folder");function $(A,x){let u=A.fullPath,h={...s,scope:u,modal:x};return Fs.call(e,h)}r($,"show_folder")}r(Fs,"context_suggest_external");var Y1="Add folders";function X4(n){return typeof n!="string"?"":n.replace(/\/+$/g,"")}r(X4,"normalize_folder_path");function Y4(n,e){let t=X4(e);return!t||n===t?!0:n.startsWith(`${t}/`)}r(Y4,"is_source_in_folder");function Z4(n,e){return Object.values(n.env?.smart_sources?.items||{}).filter(s=>Y4(s.key,e)).map(s=>s.key)}r(Z4,"get_source_keys_in_folder");function wg(n){n?.inputEl&&(n.last_input_value=n.inputEl.value,n.inputEl.value="")}r(wg,"reset_modal_input");function Z1(n={}){let e=n?.modal;return e?.setInstructions&&e.setInstructions([{command:"Enter",purpose:"Browse folder sources"},{command:"Mod + Enter",purpose:"Add all sources in folder to context"},{command:"\u2192",purpose:"Browse folder sources"}]),(Array.isArray(n.folder_paths)?n.folder_paths:this.env?.smart_sources?.fs?.folder_paths||[]).map(s=>({key:s,display:s,select_action:r(({modal:i}={})=>(wg(i),vr.call(this,{folder_path:s,modal:i})),"select_action"),mod_select_action:r(({modal:i}={})=>{wg(i);let o=Z4(this,s);this.add_items(o)},"mod_select_action"),arrow_right_action:r(({modal:i}={})=>(wg(i),vr.call(this,{folder_path:s,modal:i})),"arrow_right_action")}))}r(Z1,"context_suggest_folders");var Bs={OUT:"out",IN:"in",BOTH:"both"};function Q1(n,e=1,{direction:t=Bs.OUT,include_self:s=!1}={}){if(!n||typeof n!="object"||!n.collection)return[];let i=n.collection,o=i.links||{},a=new Set,c=[],l=r((_,m)=>{_&&(a.has(_.key)||(a.add(_.key),d.push({src:_,depth:m}),c.push({depth:m,item:_})))},"enqueue"),d=[{src:n,depth:0}];for(s&&(a.add(n.key),c.push({depth:0,item:n}));d.length;){let _=d.shift();if(_.depth>=e)continue;let m=_.depth+1;if(t===Bs.OUT||t===Bs.BOTH)for(let p of _.src.outlinks)l(i.get(p.key),m);if(t===Bs.IN||t===Bs.BOTH){let p=Object.keys(o[_.src.path]||{});for(let f of p)l(i.get(f),m)}}return c}r(Q1,"get_links_to_depth");function Q4(n,e={}){return e.source&&typeof e.source=="object"?e.source:typeof e.source_key=="string"&&n?.env?.smart_sources?.get?.(e.source_key)||null}r(Q4,"resolve_target_source");function eM(n){return Number.isInteger(n)?Math.max(n,1):1}r(eM,"normalize_max_depth");function tM(n=[]){return[...new Set(n.map(e=>e.item?.key).filter(Boolean))]}r(tM,"get_link_keys");function sM(n,e={}){let t=tM(e.links);return{key:`links_depth_${e.max_depth}`,display:`Add all links (depth <= ${e.max_depth})`,select_action:r(()=>{t.length&&n.add_items(t)},"select_action")}}r(sM,"build_add_all_links_suggestion");function nM(n,e={}){return(e.links||[]).filter(s=>s?.item?.key).map(s=>({key:s.item.key,display:`[${s.depth}] ${s.item.key}`,select_action:r(()=>{n.add_item(s.item.key)},"select_action")}))}r(nM,"build_link_suggestions");async function eA(n={}){let e=n?.modal;e?.setInstructions&&e.setInstructions([{command:"Enter",purpose:"Add link(s) to context"}]);let t=Q4(this,n);if(!t)return[];let s=eM(n.max_depth),i=n.direction||Bs.OUT,o=await Q1(t,s,{direction:i});return o.length?[sM(this,{max_depth:s,links:o}),...nM(this,{links:o})]:[]}r(eA,"context_suggest_links");var tA="Add links";function sA(n){let e=n.metadataCache.getTags();return Object.keys(e)}r(sA,"get_all_tags");function xg(n,e){let t=n.vault.getMarkdownFiles(),s=[];for(let i of t){let o=n.metadataCache.getFileCache(i);[...o?.tags?.map(c=>c.tag)||[],...o?.frontmatter?.tags||[]].map(c=>c.startsWith("#")?c:`#${c}`).includes(e)&&s.push(i.path)}return s}r(xg,"get_files_with_tag");function nA(n){return n?.env?.obsidian_app||n?.env?.plugin?.app||null}r(nA,"get_obsidian_app");function iM(n,e={}){let{tags:t}=e;return t.map(s=>({key:s,display:s,select_action:r(({modal:i}={})=>K_.call(n,{tag:s,modal:i}),"select_action"),mod_select_action:r(()=>oM(n,{tag:s}),"mod_select_action"),arrow_right_action:r(({modal:i}={})=>K_.call(n,{tag:s,modal:i}),"arrow_right_action")}))}r(iM,"build_tag_suggestions");function oM(n,e={}){let t=nA(n);if(!t)return[];let s=xg(t,e.tag);return s.length&&n.add_items(s),s}r(oM,"add_tagged_sources");function rM(n,e={}){let{file_paths:t}=e;return t.map(s=>({key:s,display:s,select_action:r(()=>{n.add_item(s)},"select_action")}))}r(rM,"build_tag_source_suggestions");function K_(n={}){let e=n?.modal;e?.setInstructions&&(typeof n.tag=="string"&&n.tag.length?e.setInstructions([{command:"Enter",purpose:"Add file to context"}]):e.setInstructions([{command:"Enter",purpose:"Browse tag sources"},{command:"Mod + Enter",purpose:"Add all tagged sources to context"},{command:"\u2192",purpose:"Browse tag sources"}]));let t=nA(this);if(!t)return[];if(typeof n.tag=="string"&&n.tag.length){let i=xg(t,n.tag);return rM(this,{tag:n.tag,file_paths:i})}let s=sA(t);return iM(this,{tags:s,modal:e})}r(K_,"context_suggest_tags");var iA="Add tags";var oA={collections:{context_items:k1,smart_contexts:C1},item_types:{},items:{},modules:{},components:{context_codeblock:{render:$1},context_headings_filters:{render:mi},smart_context_actions:{render:j1,version:T1}},actions:{context_copy_to_clipboard:{action:M1,version:R1},context_suggest_chat_threads:{action:B1,display_name:F1},context_suggest_contexts:{action:W1,display_name:U1},context_suggest_external:{action:Fs,default_settings:kg,display_name:V1},context_suggest_folders:{action:Z1,display_name:Y1},context_suggest_links:{action:eA,display_name:tA},context_suggest_tags:{action:K_,display_name:iA}}};var aM={modals:{context_selector:{default_suggest_action_keys:["context_suggest_blocks","context_suggest_external","context_suggest_folders","context_suggest_links","context_suggest_tags"]}}},rA=tt(al,tt(a_,tt(oA,tt(aM,A_))));var os=require("obsidian");var V_=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var X_=class extends V_{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Us=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new X_(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};async function cM(n,e={}){let t=Object.entries(n.settings_config).map(([o,a])=>(a.setting||(a.setting=o),this.render_setting_html(a))).join(`
`),s=Object.entries(n.collections).map(([o,a])=>`<div data-smart-settings="${o}"></div>`).join(`
`);return`
<div class="">
${t}
${s}
</div>
`}r(cM,"build_html");async function aA(n,e={}){let t=await cM.call(this,n,e),s=this.create_doc_fragment(t);return await lM.call(this,n,s,e)}r(aA,"render");async function lM(n,e,t={}){await this.render_setting_components(e,{scope:n});let s=e.querySelectorAll("[data-smart-settings]");for(let i of s){let o=i.dataset.smartSettings;await n[o].render_settings(i)}return e}r(lM,"post_process");var Y_=class{static{r(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let s=new this(e,t);return await s.load(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}static create_sync(e,t={}){let s=new this(e,t);return s.load_sync(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}get settings(){return dM(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",_M(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function dM(n,e){let t=new WeakMap,s=new WeakMap,i=r((a,c)=>{if(!Ag(a)||s.has(a))return a;if(t.has(a))return t.get(a);let l=o(a,c);return t.set(a,l),s.set(l,a),l},"wrap_value"),o=r((a,c)=>new Proxy(a,{set(l,d,_){let m=[...c,d],p=Eg(l[d]),f=Eg(_);return l[d]=i(_,m),uM(p,f)&&e({type:"set",path:m,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],m=Eg(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:m}),!0}}),"create_proxy");return i(n,[])}r(dM,"observe_object");function _M(n){let e=Array.isArray(n.path)?n.path:[];return{type:n.type,path:e,path_string:e.join("."),value:n.value,previous_value:n.previous_value}}r(_M,"build_settings_changed_event");function Eg(n){if(!Ag(n))return n;if(typeof structuredClone=="function")try{return structuredClone(n)}catch{}try{return JSON.parse(JSON.stringify(n))}catch{return n}}r(Eg,"snapshot_value");function uM(n,e){return cA(n)!==cA(e)}r(uM,"has_changed");function cA(n){if(n===void 0)return"undefined";if(Number.isNaN(n))return"number:NaN";if(n===1/0)return"number:Infinity";if(n===-1/0)return"number:-Infinity";if(!Ag(n))return`${typeof n}:${String(n)}`;try{return`object:${JSON.stringify(n)}`}catch{return`object:${String(n)}`}}r(cA,"serialize_value");function Ag(n){return typeof n=="object"&&n!==null}r(Ag,"is_observable");function lA(n){return n.collections||(n.collections={}),n.modules||(n.modules={}),n.items||(n.items={}),Object.entries(n.collections).forEach(([e,t])=>{typeof t=="function"&&(n.collections[e]={class:t});let s=fe(e);s!==e&&(n.collections[s]=n.collections[e],delete n.collections[e]),n.collections[s].collection_key||(n.collections[s].collection_key=s),t.item_type&&(n.items[t.item_type.key||fe(t.item_type.name)]={class:t.item_type})}),Object.entries(n.modules).forEach(([e,t])=>{typeof t=="function"&&(n.modules[e]={class:t});let s=fe(e);s!==e&&(n.modules[s]=n.modules[e],delete n.modules[e])}),n.item_types||(n.item_types={}),n.items||(n.items={}),Object.entries(n.item_types).forEach(([e,t])=>{if(typeof t=="function"){let s=fe(e);n.items[s]={class:t,actions:{},...n.items[s]||{}}}}),n}r(lA,"normalize_opts");function mM(n){if(!n||typeof n!="object")return!1;let e=Object.getPrototypeOf(n);return e===Object.prototype||e===null}r(mM,"is_plain_object");function Z_(n){if(Array.isArray(n))return n.map(e=>Z_(e));if(mM(n)){let e={};for(let[t,s]of Object.entries(n))e[t]=Z_(s);return e}return n}r(Z_,"deep_clone_config");function hi(n,e){let t=dA(n),s=dA(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(hi,"compare_versions");function dA(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(dA,"normalize_version_value");function zr(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(zr,"is_plain_object");function St(n,e,t=[]){if(!zr(n)||!zr(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else zr(i)?(zr(n[s])||(n[s]={}),St(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(St,"deep_merge_no_overwrite");function Ct(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(hi(d,_)>0){let p={...c};St(p,l),n.collections[a]=p}else St(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;hi(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):St(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),St(n[i],o)):n[i]=o}return n}r(Ct,"merge_env_config");function _A(n={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:s}=n;return(e!==void 0||t!==void 0||s!==void 0)&&(n.smart_sources=n.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!n.smart_sources?.file_exclusions?.length||n.smart_sources?.file_exclusions==="Untitled")&&(n.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!n.smart_sources.folder_exclusions?.length&&(n.smart_sources.folder_exclusions=t),s!==void 0&&s.length&&!n.smart_sources.excluded_headings?.length&&(n.smart_sources.excluded_headings=s)),delete n.file_exclusions,delete n.folder_exclusions,delete n.excluded_headings,n}r(_A,"migrate_exclusion_settings_2025_08_22");var pM=typeof globalThis<"u"?globalThis:Function("return this")(),Dr=class{static{r(this,"SmartEnv")}static version="2.2.8";scope_name="smart_env";static global_ref=pM;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=Us.create(this,fM(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([s])=>this.primary_main_key&&s===this.primary_main_key?-1:0);for(let[s,i]of t){if(!i?.main){console.warn(`SmartEnv: '${s}' unloaded, skipping`),delete this.smart_env_configs[s];continue}if(!i?.opts){console.warn(`SmartEnv: '${s}' opts missing, skipping`);continue}Ct(this._config,Z_(lA(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:s}=t||{};if(s)for(let[i,o]of Object.entries(s.collections||{})){let a=o?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:hi(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,hM(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let s=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(s),t(this.global_env))},1e3)}else{let s=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(s),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let s={};this.global_env&&hi(this.version,this.global_env.constructor?.version||0)>0&&(s.primary_main_key=fe(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(s);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let s=fe(e.constructor.name);this.smart_env_configs[s]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:r(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await Y_.create(this),this.config.default_settings&&St(this.settings,this.config.default_settings),_A(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:s}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let s=e.collections[t]?.class;s&&(s.default_settings&&St(this.settings,{[t]:s.default_settings}),typeof s.init=="function"&&(await s.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((s,i)=>{let o=this.config.collections?.[s]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return o-a});for(let s of t){let i=Date.now();typeof this[s]?.process_load_queue=="function"&&(await this[s].process_load_queue(),this[s].load_time_ms=Date.now()-i,this.collections[s]="loaded",console.log(`Loaded ${this[s].collection_key} in ${this[s].load_time_ms}ms`))}}static unload_main(e){let t=fe(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let s=this.opts.modules[e];return s?(t={...s,class:null,...t},new s.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||aA}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,s={}){let i=this.get_component(e,t);return i?await i(t,s):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let s=t.collection_key??t.scope_name,i=s?`${s}-${e}`:e;if(!this._components[i])try{if(this.opts.components[s]?.[e]){let o=this.opts.components[s][e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let o=this.opts.components[e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${s}`)}catch(o){console.error("Error getting component",o),console.log(`scope_name: ${s}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[s]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.config.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(s=>s.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let s=e.map(i=>{let o=i.split("/").slice(-2,-1)[0];return{dir:o,count:this.fs.file_paths.filter(a=>a.includes(o)).length}});t=s.reduce((i,o)=>o.count>i.count?o:i,s[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(ct(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(s=>s.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((s,i,o)=>o.indexOf(s)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function hM(n){return{items:Object.fromEntries(Object.entries(n.items||{}).map(([e,t])=>[e,t.data]))}}r(hM,"collection_to_plain");function fM(n){if(!n)return{};if(typeof n=="function")return{adapter_class:n};let e=n.adapter_class||n.adapter;return e?{adapter_class:e}:{}}r(fM,"build_events_opts");function gM(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=bM(n,t),o=yM(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(gM,"create_regex");function yM(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(yM,"adjust_for_windows_paths");function bM(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(bM,"glob_to_regex_pattern");function uA(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:gM(n,s)}r(uA,"glob_to_regex");function mA(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(mA,"fuzzy_search");var Q_=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(uA(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return mA(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var vM=P(require("obsidian"),1);var eu=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=vM,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function tu(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(tu,"empty");var pA=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var hA=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var kM=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,su=r((n,e)=>{let t=e.trim();(kM.test(t)?hA:pA)(n,t)},"safe_inner_html");var nu=new WeakMap,iu=new WeakMap,ou=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return Ae(e,t,s)}set_by_path(e,t,s,i=null){Se(e,t,s,i)}delete_by_path(e,t,s=null){ff(e,t,s)}escape_html(e){return Fe(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||iu.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");iu.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=iu.get(i);c&&(i.removeEventListener("change",c),iu.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=oe(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){tu(e)}safe_inner_html(e,t){su(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=nu.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},nu.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(m){console.error("[smart-view] disposer error",m)}}finally{try{l.disconnect()}catch{}nu.get(e)===c&&nu.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var ru=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(m=>{let p=l.addOption(m.value,m.label??m.name??m.value);p.selected=m.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let m=l.addOption(_.value,_.label??_.name??_.value);m.selected=_.value===s,c.length===1&&m.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,m=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(m),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let w=document.createElement("div");w.className="array-item-row";let b=document.createElement("input");b.type="text",b.value=y,b.placeholder="Value";let k=document.createElement("button");k.textContent="\u2715",k.title="Remove",b.addEventListener("change",()=>{c[g]=b.value,f()}),k.addEventListener("click",()=>{c.splice(g,1),d(),f()}),w.appendChild(b),w.appendChild(k),l.appendChild(w)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=m.value.trim();y&&(c.push(y),m.value="",d(),f())}),_.appendChild(m),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,w],b)=>{let k=document.createElement("div");k.className="json-pair-row";let C=document.createElement("input");C.type="text",C.value=g,C.placeholder="Property";let O=document.createElement("input");O.type="text",O.value=w,O.placeholder="Value";let j=document.createElement("button");j.textContent="\u2715",j.title="Remove",C.addEventListener("change",()=>{let $=C.value.trim();$&&$!==g&&(c[$]=c[g],delete c[g],d(),y())}),O.addEventListener("change",()=>{c[C.value]=O.value,y()}),j.addEventListener("click",()=>{delete c[C.value],d(),y()}),k.appendChild(C),k.appendChild(O),k.appendChild(j),l.appendChild(k)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=m.value.trim();!g||g in c||(c[g]=p.value,m.value="",p.value="",d(),y())}),_.appendChild(m),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){tu(e)}safe_inner_html(e,t){su(e,t)}};var dt=require("obsidian");var au=class extends ru{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return dt.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new dt.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await dt.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,dt.getIcon)(e).outerHTML}is_mod_event(e){return dt.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function cu(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(cu,"collection_instance_name_from");function fA(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(fA,"create_uid");function lu(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>lu(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>lu(n[o],e[o],t))}return n===e}r(lu,"deep_equal");function du(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(du,"get_item_display_name");function _u(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let v of Reflect.ownKeys(u)){let S=Object.getOwnPropertyDescriptor(u,v);if(!S)continue;let E={...S};"value"in E&&s(E.value)&&(E.value=d(E.value));try{Object.defineProperty(h,v,E)}catch{h[v]=E.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let v=!1;for(let S of h){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E){let q=E.value;if(c(q)){v=!0;continue}if(s(q)){if(_(q)){v=!0;continue}return!1}if(typeof q>"u")continue;return!1}return!1}}return v},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),v=new Map;for(let S of Reflect.ownKeys(u)){let E=Object.getOwnPropertyDescriptor(u,S);if(E){if("value"in E&&_(E.value)){v.set(S,d(E.value));continue}try{Object.defineProperty(h,S,m(E))}catch{h[S]=E.value}}}return{global_source:h,scoped_sources:v}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),w=Object.create(null),b=r((u,h,v=[])=>{if(!u||!h)return;let S=new Set([...l,...v]);for(let E of Reflect.ownKeys(u)){if(S.has(E))continue;let q=Object.getOwnPropertyDescriptor(u,E);if(q)try{Object.defineProperty(h,E,q)}catch{h[E]=q.value}}},"copy_metadata"),k=r(u=>{let h=new u(n),v=h.action||h.run||h.execute||h.call;if(i(v)){let S=v.bind(h);return b(u,S),b(h,S),S.instance=h,S}return b(u,h),h},"instantiate_class"),C=r(u=>{if(o(u))return k(u);if(a(u)){let h=u.action.bind(n);return b(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return b(u,h),h}return s(u)?d(u):u},"bind_or_clone"),O=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),j=r((u,h,v)=>(u[h]=v,v),"cache_result"),$=r((u,h)=>{let v=O();return v&&g(v,h)?j(u,h,C(v[h])):g(f,h)?j(u,h,C(f[h])):j(u,h,void 0)},"compute_and_cache"),A=r(()=>{let u=O(),h=new Set(Reflect.ownKeys(w));for(let v of Reflect.ownKeys(f))h.add(v);if(u)for(let v of Reflect.ownKeys(u))h.add(v);return Array.from(h)},"union_keys"),x=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(w,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:$(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let v=O();return v&&g(v,h)?!0:g(f,h)},"has"),ownKeys:r(()=>A(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return x(u,h);let v=O();if(v&&g(v,h)||g(f,h))return g(u,h)||$(u,h),x(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,v)=>"value"in v?(u[h]=v.value,!0):!1,"defineProperty"),set:r((u,h,v)=>(u[h]=v,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(_u,"create_actions_proxy");var re=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&ct(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return fA(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return ct(s,t),!lu(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=_u(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),cu(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),cu(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),fe(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return du(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var wM=Object.getPrototypeOf(async function(){}).constructor,ae=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof wM?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return ct(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=_u(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var uu=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},mu=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function pu(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=gA(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=gA(n.results);n.min=s,n.minResult=i}}r(pu,"results_acc");function bA(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=yA(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=yA(n.results);n.max=s,n.maxResult=i}}r(bA,"furthest_acc");function gA(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(gA,"find_min");function yA(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(yA,"find_max");function Ue(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Ue,"sort_by_score");function hu(n,e){return Ue(n,e)}r(hu,"sort_by_score_descending");function vA(n,e){return Ue(n,e)*-1}r(vA,"sort_by_score_ascending");var fu=class extends uu{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Ms(e,a.vec)};return pu(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(hu)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Ms(e,a.vec)};return bA(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(vA)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},gu=class extends mu{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var xM="---frontmatter---",kA=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),EM=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),AM=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),SM=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(xM),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),CM=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=kA(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=kA(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),Sg=r((n,e={})=>{let t=EM(n,e),s=AM(t),i=SM(s);return CM(i,n)},"create_find_connections_filter_opts");async function fi(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=Sg(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+oe(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Ue).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(fi,"find_connections");fi.action_type="connections";var Ws=class extends re{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new gu(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Gs=class extends ae{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new fu(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let m=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!m[f.item.path]||f.score>m[f.item.path].score?m[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=m[f.item.path].score}),m},Promise.resolve({})),c=Object.values(a).sort(Ue).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return wA}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return OM}},wA={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},OM={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function Cg(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await fi.call(this,n);let o=Sg(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+oe(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Ue).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Ue).slice(0,s)}return i}r(Cg,"find_connections");Cg.action_type="connections";var gi=class extends Ws{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=gf(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=yf(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},xA={class:gi,actions:{find_connections:Cg}};var Rr=class extends Gs{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let m=await _.search(e);return m?(this.search_results_ct++,{item:_,score:m}):null}catch(m){return console.error(`Error searching item ${_.id||"unknown"}:`,m),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Ue)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(qM),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},qM={};var yu=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Fr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Fr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var bu=class extends yu{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Br;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Br=class extends Fr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var EA={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Qt=class extends bu{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=Ot;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},Ot=class extends Br{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,w=new g(this.env,d);w._queue_load=!1,w.loaded_at=Date.now(),f.set(w)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return EA[s]&&(s=EA[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Ur=class extends Qt{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=Og},Og=class extends Ot{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var vu=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return oe(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return AA(this.constructor.name)}static get adapter_key(){return AA(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function AA(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(AA,"to_snake");function ku(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},m={},p=[],f={},y=null,g=null,w=!1,b=!1,k="#",C=!1,O=[],j=null;_[k]=0;for(let A=0;A<i.length;A++){let x=A+t,u=i[A],h=u.trim();if(h==="---"){if(!b&&x===1){b=!0,w=!0,l["#---frontmatter---"]=[x,null];continue}else if(w){w=!1,l["#---frontmatter---"][1]=x;continue}}if(w)continue;if(!C&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(x),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(x)),/^[-*+]\s+\[ \]/.test(u)&&f.incomplete.top.push(x)),h.startsWith("```")){if(C=!C,C&&!j?j=x:!C&&j&&(O.push([j,x]),j=null),!g){let E=c.length>0?c[c.length-1].key:k;if(E===k&&!l[k]&&(l[k]=[x,null]),E===k)g={key:k,start_line:x},(l[k][1]===null||l[k][1]<x)&&(l[k][1]=null);else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],T=`${E}#{${q}}`;l[T]=[x,null],g={key:T,start_line:x}}}continue}let v=h.match(/^(#{1,6})\s*(.+)$/);if(v&&!C){let E=v[1].length,q=v[2].trim();for(;c.length>0&&c[c.length-1].level>=E;){let Z=c.pop();l[Z.key][1]===null&&(l[Z.key][1]=x-1)}c.length===0&&l[k]&&l[k][1]===null&&(l[k][1]=x-1),g&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let T="",N=0;if(c.length>0?(T=c[c.length-1].key,N=c[c.length-1].level):(T="",N=0),c.length===0)d[q]=(d[q]||0)+1,d[q]>1&&(q+=`[${d[q]}]`);else{m[T]||(m[T]={}),m[T][q]=(m[T][q]||0)+1;let Z=m[T][q];Z>1&&(q+=`#{${Z}}`)}let Y=E-N,H="#".repeat(Y),$e=T+H+q;l[$e]=[x,null],_[$e]=0,c.push({level:E,title:q,key:$e});continue}let S=u.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(S&&!C){if(S[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null),g&&g.key!==k&&(l[g.key][1]===null&&(l[g.key][1]=x-1),g=null);let q=c.length>0?c[c.length-1].key:k;q===k&&!l[k]&&(l[k]=[x,null]),_[q]===void 0&&(_[q]=0),_[q]+=1;let T=_[q],N;if(s){let Y=S[3].replace(/^\[(?: |x|X)\]\s*/,""),H=$M(Y,o);N=`${q}#${H}`}else N=`${q}#{${T}}`;l[N]=[x,null],y={key:N,start_line:x};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=x-1),y=null);let E=c.length>0?c[c.length-1].key:k;if(E===k)l[k]||(l[k]=[x,null]),(l[k][1]===null||l[k][1]<x)&&(l[k][1]=null),g={key:k,start_line:x};else{_[E]===void 0&&(_[E]=0),_[E]+=1;let q=_[E],T=`${E}#{${q}}`;l[T]=[x,null],g={key:T,start_line:x}}}}let $=i.length;for(;c.length>0;){let A=c.pop();l[A.key][1]===null&&(l[A.key][1]=$+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=$+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=$+t-1),g=null),l[k]&&l[k][1]===null&&(l[k][1]=$+t-1);for(let A in l)a[A]=l[A];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:O}}r(ku,"parse_markdown_blocks");function $M(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r($M,"get_longest_words_in_order");var _t=class extends vu{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=ku(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let m=this.item.block_collection.get(_.key);s==="replace_blocks"?await m.update(_.content):await m.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],m=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:m,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:m,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let w=this.item.block_collection.get(m);if(await this.create_hash(p)!==w.last_read?.hash){o.push({key:m,state:"changed",content:p});continue}a.push({key:m,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function es(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),m={title:c,target:l,line:d};_&&(m.embedded=!0),e.push(m)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,m=o(a.index),p={title:l,target:d,line:_};m&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(es,"get_markdown_links");function wu({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=es(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(wu,"get_bases_cache_links");function qg(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(qg,"parse_value");function jM(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=qg(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let m=_.trim().slice(2);l.push(qg(m)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=qg(c)}return t}r(jM,"parse_yaml_block");function SA(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=jM(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(SA,"parse_frontmatter");var CA=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Wr=class extends _t{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=es(e),s=wu({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=SA(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),CA(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var ts=require("obsidian");function TM(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(TM,"merge_tags");var Hs=class extends Wr{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=TM(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!ts.MarkdownRenderer||!ts.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await ts.MarkdownRenderer.render(s,t,i,this.item.path,new ts.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(m=>setTimeout(m,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,ts.htmlToMarkdown)(i)}};var xu=class extends _t{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var Eu=class extends _t{static{r(this,"RenderedSourceContentAdapter")}static extensions=["rendered"];async import(){}};function NM({content:n}={}){if(!n)return null;try{return JSON.parse(n)}catch(e){return console.warn("CanvasSourceContentAdapter: invalid JSON content.",e),null}}r(NM,"parse_canvas_json");function OA({target:n,title:e}={}){return n?{title:e||n,target:n,line:1}:null}r(OA,"build_link_record");function PM({node:n}={}){if(!n||typeof n!="object")return[];if(n.type==="text"&&typeof n.text=="string")return es(n.text);if(n.type==="file"&&typeof n.file=="string"){let e=typeof n.subpath=="string"?n.subpath:"",t=`${n.file}${e}`,s=OA({target:t,title:n.file});return s?[s]:[]}if(n.type==="link"&&typeof n.url=="string"){let e=OA({target:n.url,title:n.url});return e?[e]:[]}return[]}r(PM,"get_canvas_node_links");function IM({nodes:n=[]}={}){return Array.isArray(n)?n.reduce((e,t)=>(e.push(...PM({node:t})),e),[]):[]}r(IM,"get_canvas_links_from_nodes");function MM({content:n}={}){let e=NM({content:n});return e?.nodes?IM({nodes:e.nodes}):[]}r(MM,"get_canvas_links");var Au=class extends _t{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){if(!this.item.file){console.warn(`CanvasSourceContentAdapter: Skipping missing-file: ${this.file_path}`);return}let e=await this.read();if(!e||this.data.last_import?.hash===this.data.last_read?.hash&&Array.isArray(this.data.outlinks))return;this.data.outlinks=MM({content:e});let t=this.item.file?.stat,s=t?.size??e.length,i=t?.mtime??0;this.data.last_import={mtime:i,size:s,at:Date.now(),hash:this.data.last_read?.hash},this.item.loaded_at=Date.now(),this.item.queue_save()}};var Su=class extends Hs{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function qA(n,e){let[t,...s]=n.split("#").filter(Boolean),i=du(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(qA,"get_block_display_name");var yi=class extends Ws{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return qA(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},$A={class:yi,actions:{find_connections:fi}};var Gr=class extends Gs{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var Cu=class extends Qt{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=$g;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},$g=class extends Ot{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var Ou=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return oe(e)}};function qu(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(qu,"get_line_range");var bi=class extends Ou{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return qu(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var vi=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Hr=class extends vi{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var ki=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Js=class extends ki{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var ut=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var wi=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},xi=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var Ei=class extends wi{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new jg(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},jg=class extends xi{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Ks=class extends wi{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new Tg(i)}},Tg=class extends xi{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var PA=P(NA(),1);var WM=Object.defineProperty,GM=r((n,e,t)=>e in n?WM(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),HM=r((n,e,t)=>(GM(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function JM(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(JM,"bytePairMerge");function KM(n,e){return n.length===1?[e.get(n.join(","))]:JM(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(KM,"bytePairEncode");function VM(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(VM,"escapeRegex");var Pg=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=PA.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=Pg.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Pg.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let m=d?.index??n.length;for(let f of n.substring(l,m).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...KM(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},ju=Pg;HM(ju,"specialTokenRegex",n=>new RegExp(n.map(e=>VM(e)).join("|"),"g"));async function MA(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await IA(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await IA(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(MA,"fetch_json_cached");async function IA(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(IA,"do_fetch");function Mg(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(Mg):e==="object"?Object.values(n).every(Mg):!1}r(Mg,"is_json_compatible");function Tu(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||Mg(i)&&(t[s]=i);return t}r(Tu,"extract_json_details");function Jr(n){return Object.keys(n).length===0}r(Jr,"is_empty_object");function XM(n,e){return Jr(n)?e:Jr(e)?n:{...n,...e}}r(XM,"merge_details");function Ig(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(Ig,"get_message_from_object");function X(n,e=null){if(Array.isArray(n)&&n.length>0)return X(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Tu(n,["message"]);return{message:t,details:Jr(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=Ig(o),c=Tu(o,["message"]),l=Tu(t,["message","error"]),d=XM(l,c);return{message:a||Ig(t)||"Unknown error",details:Jr(d)?null:d,http_status:e}}return X(i)}let s=Ig(t);if(s){let i=Tu(t,["message"]);return{message:s,details:Jr(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(X,"normalize_error");var YM="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",pt=class extends Js{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return We}get res_adapter(){return Ge}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new ut({adapter:Ks})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:X(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await MA(YM,"cl100k_base.json");this.tiktoken=new ju(e)}},We=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Ge=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Nu=class extends pt{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Lg}get res_adapter(){return zg}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Lg=class extends We{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},zg=class extends Ge{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var Pu=class extends Js{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var Iu=class extends Pu{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var LA=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var zA={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:Dg};var Dg={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},DA={},Rg={};var Ai=class extends Iu{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=zA;constructor(e){super(e),this.connector=LA.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...DA}}get_models(){return Promise.resolve(this.models)}get models(){return Dg}};var Mu=class extends pt{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Fg}get res_adapter(){return Bg}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of QM(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Fg=class extends We{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},Bg=class extends Ge{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},ZM=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),QM=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(ZM)},"filter_embedding_models");var Lu=class extends pt{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Ug}get res_adapter(){return Wg}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},Ug=class extends We{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Wg=class extends Ge{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function eL(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(eL,"parse_lm_studio_models");var zu=class extends pt{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Gg}get res_adapter(){return Hg}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return eL(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},Gg=class extends We{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Hg=class extends Ge{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Kr=class extends vi{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw X(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var Du=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#t(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#a.bind(this)),this.xhr.addEventListener("error",this.#e.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#t(this.CLOSED))}#t(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#e(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#e(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#t(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#a(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#t(this.CLOSED)}};var Ru=class extends ki{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var Si={},ss={data:null,fetched_at:0},U=class extends Ru{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return W}get res_adapter(){return L}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new ut({adapter:Ks})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=ss.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=X(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new Du(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=X({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=X(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=X(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(ss?.data&&t-ss?.fetched_at<e)return ss.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return ss.data=o,ss.fetched_at=t,console.log({MODELS_DEV_CACHE:ss}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),ss.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return Si[this.constructor.key]||(Si[this.constructor.key]={}),Si[this.constructor.key]}set model_data(e){Si[this.constructor.key]||(Si[this.constructor.key]={}),Si[this.constructor.key]=e}},W=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},L=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:X(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Vr=class extends U{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Xr}res_adapter=Yr;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Xr=class extends W{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Yr=class extends L{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:X(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var tL=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Xs=class extends U{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Jg;parse_model_data(e){return e.data.filter(t=>!tL.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:sL(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function sL(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(sL,"get_max_input_tokens");var Jg=class extends L{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Zr=class extends Xs{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var Ci=class extends U{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Qr;res_adapter=ea;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Qr=class extends W{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},ea=class extends L{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:X(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},ta=class extends Ci{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var sa=class extends U{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Kg}get res_adapter(){return Vg}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Kg=class extends W{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Vg=class extends L{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var na=class extends U{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return ia}get res_adapter(){return oa}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},ia=class extends W{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},oa=class extends L{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var ra=class extends U{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=aa;res_adapter=ca;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},aa=class extends W{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},ca=class extends L{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:X(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Xg={openai:{req:W,res:L},anthropic:{req:Xr,res:Yr},gemini:{req:Qr,res:ea},lm_studio:{req:ia,res:oa},ollama:{req:aa,res:ca}},la=class extends U{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Xg[e];return t&&t.req?t.req:W}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Xg[e];return t&&t.res?t.res:L}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(Xg).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var da=class extends U{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Yg}get res_adapter(){return Zg}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},Yg=class extends W{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Zg=class extends L{static{r(this,"SmartChatModelGroqResponseAdapter")}};var _a=class extends U{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return W}get res_adapter(){return L}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var ua=class extends U{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Qg}get res_adapter(){return ey}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Qg=class extends W{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},ey=class extends L{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var ky=require("obsidian");function RA(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=ku(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),m=qu(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===m.length&&_.vec)continue;let p=es(m),f=wu({source:n,links:p}),y={key:d,lines:l,size:m.length,outlinks:[...p,...f],last_read:{at:a,hash:oe(m)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new n.block_collection.item_type(n.env,y);n.block_collection.set(g)}else _.data={..._.data,...y}}nL(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(RA,"parse_blocks");function nL(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(nL,"clean_and_update_source_blocks");function ty(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():FA(a)?n[o]=ty(FA(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(ty,"ajson_merge");function FA(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(FA,"is_object");var BA={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function iL(n){let e=!1,[t,...s]=n.split(":");return BA[t]&&(t=BA[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(iL,"_parse_ajson_key");var ns=class extends Qt{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:w}=iL(p),b=`${y}:${g}`;f?(i[b]=f,(w||b!==p)&&(delete i[p],t=!0)):(delete i[b],(w||b!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=ty(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},sy=class extends Ot{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},ma={collection:ns,item:sy};var pa=class extends re{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function oL(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(oL,"parse_component_properties");async function rL(n,e){let{scope_key:t,component_key:s}=oL(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await oe(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(rL,"build_component_data");var Fu=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await rL(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var Bu=class extends Fu{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function UA(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&UA(i,o,t)}}),t}r(UA,"flatten_components_config");var Uu=class extends ae{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=UA(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},WA={class:Uu,item_type:pa,data_adapter:ma,component_adapters:{SmartViewComponentAdapter:Bu}};var GA=WA;function HA(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(HA,"filter_redundant_context_items");var JA=r((n,e)=>!e||!n?.[e]?!1:n[e].folder?n[e].exclude?!1:(n[e].exclude=!0,!0):(delete n[e],!0),"remove_context_item_data"),ha=class extends re{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e,t={}){let{emit_updated:s=!0}=t;JA(this.data.context_items,e)&&(this.queue_save(),s&&this.emit_event("context:updated",{removed_key:e,removed_keys:[e]}))}remove_items(e,t={}){let{emit_updated:s=!0}=t,i=Array.isArray(e)?e:[e],o=[];return i.forEach(a=>{JA(this.data.context_items,a)&&o.push(a)}),o.length?(this.queue_save(),s&&this.emit_event("context:updated",{removed_keys:o}),o):[]}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this._context_items_listener_registered||(this.on_event("context:updated",()=>{this._context_items=null}),this._context_items_listener_registered=!0)}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return HA(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var Wu=class extends ae{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var aL={class:Wu,data_adapter:ns,item_type:ha};var KA=aL;var Gu=class extends re{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var ht=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var Hu=class extends ht{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var Ju=class extends ht{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var VA=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var Ku=class extends ht{static{r(this,"ImageContextItemAdapter")}static detect(e){return VA.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var Vu=class extends ht{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var ny=class extends ae{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},XA={version:1,class:ny,collection_key:"context_items",item_type:Gu,context_item_adapters:{BlockContextItemAdapter:Hu,SourceContextItemAdapter:Ju,ImageContextItemAdapter:Ku,PdfContextItemAdapter:Vu}};function YA(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(YA,"next_log_stats");var Oi=class extends re{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var cL={"collection:save_started":!0,"collection:save_completed":!0},iy=class extends ae{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return Oi}init(){this.env?.events||Us.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!cL[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new Oi(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=YA({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},ZA={class:iy,collection_key:"event_logs",data_adapter:ns,item_type:Oi};var qi=require("obsidian");function QA(n,e={}){if(!n)return[];let t=Array.isArray(e.action_keys)?e.action_keys:[],s=n?.env?.config?.actions||{},i=n?.item_or_collection?.actions||{};return[...new Set(t)].reduce((a,c)=>{if(typeof i[c]!="function")return a;let _=(s[c]||{}).display_name||c;return a.push({select_action:r(()=>{n.update_suggestions(c)},"select_action"),key:c,display:_}),a},[])}r(QA,"build_suggest_scope_items");var eS=r((n,e={})=>{let t=n?.inputEl,s=e.event_target,i=typeof e.input_value=="string"?e.input_value:t?.value||"";return!(s===t&&i)},"should_handle_arrow_left");var Xu=class extends qi.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available",this._set_custom_instructions=!1}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}setInstructions(e,t=!0){this._set_custom_instructions=t,super.setInstructions(e)}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Select"}],!1)}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&(t.shiftKey&&(this.use_shift_select=!0),this.selectActiveSuggestion(t));let i=this.inputEl.selectionStart===this.inputEl.value.length||t.target!==this.inputEl||!this.inputEl.value,o=eS(this,{event_target:t.target,input_value:this.inputEl.value});if(t.key==="ArrowLeft"&&o){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&i){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return QA(this,{action_keys:this.default_suggest_action_keys})}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){this._set_custom_instructions=!1;let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e)),this._set_custom_instructions||this.set_default_instructions()}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,qi.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=t?.shiftKey||this.use_shift_select,l=qi.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,this.use_shift_select=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let d=this.inputEl.value.length;this.inputEl.setSelectionRange(d,d)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):l&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):c&&typeof i.shift_select_action=="function"?this.handle_choose_action(i,"shift_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var KTe=require("obsidian");var Yu=class extends Xu{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.set_default_instructions()}set_default_instructions(){this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var tS=require("obsidian");var Zu=class extends tS.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var em=require("obsidian");var lL="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",Qu=class extends em.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){dL(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function dL(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),_L(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(lL,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r(dL,"render_milestones_modal_title");function _L(n){uL(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(_L,"render_help_icon");function uL(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,em.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(uL,"set_icon_with_fallback");var sS={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var fa=class extends re{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],m=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),m},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var tm=class extends ae{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function nS(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(nS,"settings_config");var Ys=class extends fa{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var oy=class extends tm{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var mL={class:oy,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:ma,item_type:Ys,providers:{},settings_config:nS},ry=mL;var ay=class extends Ai{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},iS={class:ay,settings_config:Rg};ry.providers={transformers:iS};var oS=ry;var is=class extends re{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(pu(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(hu);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var rS={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},cy=class extends ae{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=pL(new Date),i=oe(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new is(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...rS}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function pL(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(pL,"format_ymd");var aS={class:cy,collection_key:"lookup_lists",item_type:is,settings_config:rS};function ga(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(ga,"format_collection_name");async function hL(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${ga(n.collection_key)}</h2>
${t}
</div></div></div>`}r(hL,"build_html");async function cS(n,e={}){let t=await hL.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(cS,"render");var $i=require("obsidian");function lS(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if($i.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new $i.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let m=d.hoverEl.querySelector(".markdown-preview-sizer");$i.MarkdownRenderer.render(o,l,m,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(lS,"register_block_hover_popover");var dS=require("obsidian");function _S(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),dS.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):lS(n.parentElement,n,e.env,e.key)}r(_S,"register_item_hover_popover");var mS=require("obsidian");function fL(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(fL,"format_score");function gL(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(gL,"format_size");function uS(n,e){return n?`<span class="${e}">${n}</span>`:""}r(uS,"build_badge_html");function yL(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=fL(n?.data?.score),i=gL(n?.size||n?.data?.size),o=uS(s,"sc-context-item-score"),a=uS(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(yL,"build_html");async function pS(n,e={}){let t=yL(n,e),i=this.create_doc_fragment(t).firstElementChild;return bL.call(this,n,i,e),i}r(pS,"render");async function bL(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${mS.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),_S(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(bL,"post_process");async function vL(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${ga(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=wL(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(vL,"build_html");async function hS(n,e={}){let t=await vL.call(this,n,e),s=this.create_doc_fragment(t);return await kL.call(this,n,s,e)}r(hS,"render");async function kL(n,e,t={}){return e}r(kL,"post_process");function wL(n,e){let t=Object.values(n.items).length,s=ga(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=xL(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=EL(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(wL,"generate_collection_stats");function xL(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(xL,"get_generic_collection_stats");function EL(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(EL,"calculate_embed_coverage");var fS=require("obsidian");function AL(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(AL,"build_html");async function ly(n,e={}){let t=AL.call(this,n,e),s=this.create_doc_fragment(t);return await SL.call(this,n,s,e)}r(ly,"render");async function SL(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new fS.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Ae(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(m=>{_.addOption(m.value,m.label)}),l.childNodes.forEach(m=>{m.value===c&&(m.selected=!0),o.find(p=>p.value===m.value)?.disabled&&(m.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):Se(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(SL,"post_process");ly.version=.2;var gS=require("obsidian");function CL(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(CL,"build_html");function yS(n,e={}){let t=CL.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,gS.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),OL.call(this,n,i,e),i}r(yS,"render");function OL(n,e){}r(OL,"post_process");var bS=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var ES=require("obsidian");var vS=require("obsidian");var $L={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}},ji={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections:hidden_item":{group:"Connections",milestone:"Hidden a connection item from the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections:pinned_item":{group:"Connections",milestone:"Pinned a connection item in the list.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#manage-noise"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context:file_nav_copied":{group:"Context",milestone:"Copied context from the file navigator.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-selected"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},jL=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function dy(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=jL.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(dy,"derive_events_checklist_groups");function ya(n,e){let t=TL(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(ya,"check_if_event_emitted");function TL(n,e){let t=$L[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!NL(a)))return!0}return!1}r(TL,"resolve_plugin_install_event");function NL(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r(NL,"is_pro_manifest");function kS(n){n.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in ji){let s=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",o=document.createElement("p");o.textContent=i,s.appendChild(o);let a=document.createElement("p");a.textContent=`\u2705 ${ji[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",s.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{n.open_milestones_modal()}),s.appendChild(c),new vS.Notice(s,7e3)}})}r(kS,"register_first_of_event_notifications");function PL(n,e={}){let t=dy(ji),s=t.reduce((c,l)=>{let d=l.items.reduce((_,m)=>_+(ya(n,m.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((m,p)=>m+(ya(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(m=>{let p=ya(n,m.event_key)===!0;return ML(m,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Fe(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Fe(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Fe(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(PL,"build_html");async function AS(n,e={}){this.apply_style_sheet(bS);let t=PL.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return IL.call(this,n,i,e),i}r(AS,"render");async function IL(n,e,t={}){return LL(e),zL(e),e}r(IL,"post_process");function ML(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Fe(n.event_key)}"
data-link="${Fe(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${Fe(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Fe(n.milestone)}</span>
</div>
</li>
`}r(ML,"build_item_html");function LL(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=xS(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||wS(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=xS(n,e);s&&(e.preventDefault(),wS(s))}))}r(LL,"attach_item_link_listeners");function wS(n){let e=FL(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(wS,"open_item_link");function zL(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&DL(i,s)})}r(zL,"render_item_state_icons");function DL(n,e){RL(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(DL,"set_item_icon");function RL(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,ES.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(RL,"set_icon_with_fallback");function xS(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(xS,"get_item_el_from_event");function FL(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=ji[t];return!s||typeof s.link!="string"?"":s.link}r(FL,"get_item_link");function BL(){return`<div>
<div class="smart-env-notifications-controls">
<button class="copy-all-notifications-btn">Copy All Notifications</button>
</div>
<div class="smart-env-notifications-feed"></div>
<button class="load-more-notifications-btn">Load More</button>
</div>`}r(BL,"build_html");var _y=100,uy=100;function UL(n,e={}){let{limit:t=_y}=e;return n.slice(-t).reverse()}r(UL,"get_visible_entries");function WL(n,e={}){let{page_size:t=_y}=e;return Math.min(n,t)}r(WL,"get_visible_count");function GL(n,e={}){let{current_count:t=0,step_size:s=uy}=e;return Math.min(n,t+s)}r(GL,"get_next_visible_count");function HL(n,e){return n>e}r(HL,"should_show_load_more");async function SS(n,e={}){let t=this.create_doc_fragment(BL()),s=t.firstElementChild;return JL.call(this,n,s,e),t}r(SS,"render");async function JL(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed"),i=e.querySelector(".copy-all-notifications-btn"),o=e.querySelector(".load-more-notifications-btn"),a=this;this.empty(s);let c=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!c.length){let _=s.ownerDocument.createElement("p");_.className="smart-env-notifications-empty",_.textContent="No Smart Env notifications yet.",s.appendChild(_),o&&(o.style.display="none");return}let l=WL(c.length,{page_size:_y}),d=r(()=>{a.empty(s),UL(c,{limit:l}).forEach(_=>{XL(s,_)}),KL(o,{entries_length:c.length,visible_count:l})},"render_entries");d(),i&&i.addEventListener("click",()=>{let _=s.textContent;navigator.clipboard.writeText(_).then(()=>{i.textContent="Copied!",setTimeout(()=>{i.textContent="Copy All Notifications"},2e3)})}),o&&o.addEventListener("click",()=>{l=GL(c.length,{current_count:l,step_size:uy}),d()})}r(JL,"post_process");function KL(n,e={}){if(!n)return;let{entries_length:t=0,visible_count:s=0}=e,i=HL(t,s);if(n.style.display=i?"inline-block":"none",i){let o=t-s,a=Math.min(uy,o);n.textContent=`Load ${a} more`}}r(KL,"update_load_more_button");function VL(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(VL,"get_level");function XL(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=VL(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${YL(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(XL,"append_entry");function YL(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(YL,"to_time_ago");var He=require("obsidian");var Ti=require("obsidian");function Ni(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Ni,"get_smart_server_url");function ZL(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(ZL,"try_get_zlib");function QL(n){let e=ZL();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(QL,"inflate_deflate_data");async function ba(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let w=new Uint8Array(n.slice(t,t+y)),b=new TextDecoder("utf-8").decode(w);t+=y,t+=g;let k=(l&8)!==0,C=t,O;if(!k)O=C+p;else{let A=C,x=!1;for(;A+4<=s;){let u=e.getUint32(A,!0);if(u===134695760||u===67324752||u===33639248){x=!0;break}A++}O=x?A:s}if(O>s)break;let j=new Uint8Array(n.slice(C,O));if(t=O,k&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let $;if(d===0)$=j;else if(d===8)$=QL(j);else continue;if(i.push({fileName:b,data:$}),b.toLowerCase().endsWith("manifest.json")&&!b.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode($))}catch{}}return{files:i,pluginManifest:o}}r(ba,"parse_zip_into_files");function sm(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(sm,"validate_zip_buffer");async function va(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(va,"write_files_with_adapter");function nm(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(nm,"is_server_version_newer");async function im(n,e){let t=await(0,Ti.requestUrl)({url:`${Ni()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return sm(t.arrayBuffer,"Smart Plugins server")}r(im,"fetch_plugin_zip");async function CS(n,e=Ti.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return sm(t.arrayBuffer,"Download")}r(CS,"fetch_zip_from_url");async function OS(n,e,t=Ti.requestUrl){let s=await t({url:`${Ni()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(OS,"fetch_plugin_readme");async function qS(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(qS,"enable_plugin");function om(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(om,"get_oauth_storage_prefix");async function rm(n){let e=await(0,Ti.requestUrl)({url:`${Ni()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(rm,"fetch_server_plugin_list");async function $S(n={}){let e=String(n.token||"").trim();if(!e)return{ok:!1,error:"missing_token"};let t=await(0,Ti.requestUrl)({url:`${Ni()}/api/referrals/stats`,method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===401)return{ok:!1,unauthorized:!0};if(t.status!==200)throw new Error(`referrals stats error ${t.status}: ${t.text}`);return t.json}r($S,"fetch_referral_stats");var jS=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var tz='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',sz='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function nz(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(nz,"derive_fallback_plugins");function iz(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${tz}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${sz}</p>
<div class="smart-plugins-referral"></div>
</div>
</div>
`}r(iz,"build_html");async function NS(n,e={}){this.apply_style_sheet(jS);let t=iz.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await oz.call(this,n,i,e),i}r(NS,"render");async function oz(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=om(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".smart-plugins-referral"),l=e.querySelector(".pro-plugins-list"),d=nz(),_=0,m="",p=null,f=r(A=>{if(A){if(typeof this.empty=="function"){this.empty(A);return}A.innerHTML=""}},"empty_container"),y=r(A=>{if(!a||!A)return;(!p||!p.isConnected)&&(p=document.createElement("div"),p.classList.add("smart-plugins-login-manual"),a.appendChild(p)),p.innerHTML="";let x=document.createElement("div");x.classList.add("smart-plugins-login-manual-instructions"),x.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",p.appendChild(x);let u=document.createElement("div");u.classList.add("smart-plugins-login-manual-controls"),p.appendChild(u);let h=document.createElement("input");h.classList.add("smart-plugins-login-manual-input"),h.type="text",h.value=A,h.readOnly=!0,h.addEventListener("focus",()=>h.select()),u.appendChild(h);let v=document.createElement("button");v.classList.add("mod-cta"),v.textContent="Copy",v.addEventListener("click",async()=>{await TS(A)?new He.Notice("Copied login link to clipboard."):new He.Notice("Copy failed. Please select and copy the link manually.")}),u.appendChild(v)},"render_manual_login_link"),g=r(async()=>{let A={},{manifests:x}=i.plugins;for(;Object.keys(x).length===0;)x=i.plugins.manifests,await new Promise(u=>setTimeout(u,100));for(let u in x){if(!Object.prototype.hasOwnProperty.call(x,u))continue;let{name:h,version:v}=x[u];A[u]={name:h,version:v}}return A},"get_installed_info"),w=r(async()=>{_++,_>=2&&m&&y(m),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(m=rz()),new He.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),b=r(()=>{if(this.empty(a),p=null,!(localStorage.getItem(o+"token")||"")){new He.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(h=>{h.setButtonText("Login"),h.onClick(async()=>{await w()})});return}let x=new He.Setting(a);x.setDesc("Signed in to Smart Plugins Pro account."),x.addButton(u=>{u.setButtonText("Logout"),u.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new He.Notice("Logged out of Smart Plugins"),b(),k(),j()})})},"render_oauth_login_section"),k=r(async(A={})=>{f(c);let x=String(A.token||"").trim();if(!x)return;let u=Number(A.sub_exp??0)||0;if(!(u&&u<Date.now()))try{let h=await $S({token:x}),v=String(h?.referral_link||"").trim();if(!v)return;let S=new He.Setting(c).setName("Referral link").setDesc("Share your link to give $30 off Pro and earn 30 days of Pro credit.");S.addButton(E=>{E.setButtonText("Copy link"),E.onClick(async()=>{let q=await TS(v);new He.Notice(q?"Referral link copied.":"Copy failed. Please try again.")})}),S.addButton(E=>{E.setButtonText("Open referrals"),E.onClick(()=>{window.open("https://smartconnections.app/my-referrals/","_external")})})}catch(h){console.error("[pro-plugins:list] Failed to load referral stats:",h)}},"render_referral_section"),C=r(async()=>{if(this.empty(l),!(!l||d.length===0))for(let A of d){let x=await n.smart_components.render_component("pro_plugins_list_item",A,{env:n,app:i,installed_map:{}});l.appendChild(x)}},"render_fallback_plugin_list"),O=r(()=>{let A=new He.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");A.addButton(x=>{x.setButtonText("Get Pro"),x.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),A.addButton(x=>{x.setButtonText("Update subscription"),x.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),A.addButton(x=>{x.setButtonText("Refresh"),x.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),j=r(async()=>{this.empty(l);let A=localStorage.getItem(o+"token")||"";if(!A){await C(),await k();return}try{let x=await g(),u=await rm(A),{list:h=[],unauthorized:v=[],sub_exp:S}=u;if(typeof S=="number"&&S<Date.now()){O(),await C(),await k();return}if(await k({token:A,sub_exp:S}),!Array.isArray(h)||h.length===0){await C();return}for(let E of h){let q=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,token:A,installed_map:x,on_installed:j});l.appendChild(q)}}catch(x){console.error("[pro-plugins:list] Failed to fetch plugin list:",x),l.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),$=r(async()=>{b(),await j()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{$()}),await $(),e}r(oz,"post_process");function rz(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${Ni()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(rz,"initiate_smart_plugins_oauth");var TS=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var me=require("obsidian");var az="https://smartconnections.app/pro-plugins/";function cz(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(cz,"build_html");function lz(n){return!n||!n.repo}r(lz,"is_fallback_item");function dz(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,nm(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(dz,"compute_display_state");async function PS(n,e={}){let t=cz(n,e),i=this.create_doc_fragment(t).firstElementChild;return await _z.call(this,n,i,e),i}r(PS,"render");async function _z(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(lz(n)){let m=new me.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",m.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),m.controlEl.appendChild(p)}return m.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(az,"_external")})}),m.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=dz(n,l),_=new me.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(m=>{m.setButtonText(d.button_label),m.setDisabled(d.is_disabled),m.onClick(()=>mz(n,{app:s,token:i,on_installed:a}))}),_.addButton(m=>{m.setButtonText("Docs"),n.docs_url?m.onClick(()=>window.open(n.docs_url,"_external")):m.onClick(()=>pz(n,{app:s,token:i,display_name:d.display_name}))}),e}r(_z,"post_process");var uz=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return CS(t);if(!e)throw new Error("Login required to install this plugin.");return im(n.repo,e)},"download_plugin_zip"),mz=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new me.Notice(`Installing "${n.repo}" ...`);let o=await uz(n,s),{files:a,pluginManifest:c}=await ba(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await va(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await qS(t,_),new me.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new me.Notice(`Install failed: ${o.message}`)}},"install_plugin"),pz=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await OS(n.repo,s),a=new me.Modal(t);a.setTitle(i||n.name||n.repo),await me.MarkdownRenderer.render(t,o,a.contentEl,"",new me.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new me.Notice("Failed to load README")}},"show_plugin_readme");var IS=require("obsidian");var Zs=class extends IS.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var MS=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var LS=require("obsidian");function fz(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${DS(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(fz,"build_html");async function zS(n,e){this.apply_style_sheet(MS);let s=this.create_doc_fragment(fz.call(this,n,e)).firstElementChild;return gz.call(this,n,s,e),s}r(zS,"render");async function gz(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,LS.setIcon)(o,DS(n)),s.addEventListener("click",()=>{new Zs(n).open()}),i.addEventListener("click",()=>{new Zs(n,{test_on_open:!0}).open()}),e}r(gz,"post_process");function DS(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(DS,"get_test_result_icon_name");var FS=require("obsidian");var RS={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function am(n,e,t={}){let s=(RS[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new FS.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new Zs(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(am,"show_new_model_menu");function yz(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(yz,"build_html");async function BS(n,e){let s=this.create_doc_fragment(yz.call(this,n,e)).firstElementChild;return bz.call(this,n,s,e),s}r(BS,"render");async function bz(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=li(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{am(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(bz,"post_process");function vz(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(vz,"build_html");async function US(n,e){let s=this.create_doc_fragment(vz(n,e)).firstElementChild;return kz.call(this,n,s,e),s}r(US,"render");async function kz(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(kz,"post_process");function wz(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(wz,"build_html");async function WS(n,e={}){let s=this.create_doc_fragment(wz(n,e)).firstElementChild;return xz.call(this,n,s,e),s}r(WS,"render");async function xz(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),am(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(xz,"post_process");async function Ez(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(Ez,"build_html");async function GS(n,e={}){let t=await Ez.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return Az.call(this,n,i,e),i}r(GS,"render");async function Az(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(Az,"post_process");var HS=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function Cz(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(Cz,"build_html");async function JS(n,e={}){this.apply_style_sheet(HS);let t=await Cz.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return Oz.call(this,n,i,e),i}r(JS,"render");async function Oz(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return my.call(this,"settings_env_sources",n,i),my.call(this,"settings_env_models",n,s),my.call(this,"settings_notifications",n,o),e}r(Oz,"post_process");function my(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(my,"render_if_available");var KS=require("obsidian");function qz(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(qz,"build_html");async function VS(n,e={}){let t=qz(),i=this.create_doc_fragment(t).firstElementChild;return $z.call(this,n,i,e),i}r(VS,"render");async function $z(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),jz(n,a),Tz(n,a),Nz(n,a),Pz(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r($z,"post_process");function jz(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(jz,"render_btn_open_selector");function Tz(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(Tz,"render_btn_copy_context");function Nz(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(Nz,"render_btn_clear_context");function Pz(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,KS.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(Pz,"render_btn_help");var XS=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var ka=require("obsidian");async function cm(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(ka.Platform.isMobile)new ka.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new ka.Notice("Failed to copy.")}}r(cm,"copy_to_clipboard");var Mz=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),Lz=r(n=>{let e=!1;return()=>{e||(e=!0,Mz(async()=>{e=!1,await n()}))}},"create_render_scheduler");function zz(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(zz,"build_html");async function YS(n,e={}){let t=zz(n,e);this.apply_style_sheet(XS);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return Dz.call(this,n,i,e),i}r(YS,"render");async function Dz(n,e,t={}){let s=[],i=r(async()=>{let d=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(p=>{this.empty(d),d.appendChild(p)});let _=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(p=>{this.empty(_),_.appendChild(p)});let m=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(p=>{this.empty(m),m.appendChild(p)})},"render_children"),o=Lz(i),a=n.env.plugin,c=a?.app||window.app;return(a?.registerDomEvent?.bind(a)||((d,_,m)=>d.addEventListener(_,m)))(e,"contextmenu",d=>{if(d.preventDefault(),d.stopPropagation(),!c)return;let _=new Menu(c);_.addItem(m=>m.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let p=Rz(e);await cm(p)})),_.showAtMouseEvent(d)}),await i(),s.push(n.on_event("context:updated",o)),this.attach_disposer(e,s),e}r(Dz,"post_process");function Rz(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(Rz,"tree_dom_to_wikilinks");function Fz(n){return Math.ceil((n||0)/4)}r(Fz,"estimate_tokens");function Bz(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(Bz,"build_html");async function ZS(n,e={}){let t=Bz(),i=this.create_doc_fragment(t).firstElementChild;return Uz.call(this,n,i,e),i}r(ZS,"render");async function Uz(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=Fz(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Uz,"post_process");function QS(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-context-item-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let m=["sc-tree-label"];return n.exists===!1&&m.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${l}
<span class="${m.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(QS,"build_tree_item");function eC(n){let e=Wz(n),t=new Set(n.map(i=>i.key||i.path));return tC(e,t)}r(eC,"build_tree_html");function Wz(n=[]){let e=r(a=>a?.key||a?.path||"","get_item_key"),t=r(a=>{let c=/#\{\d+\}$/u,l=a,d=null,_=null,m=!1,p=l.match(c);p&&(d=p[0],l=l.slice(0,-d.length),m=!0);let f=l.indexOf("##");f!==-1&&(_=l.slice(f),l=l.slice(0,f),m=!0);let y=[];if(l){let g="",w=!1;for(let b=0;b<l.length;b++)!w&&l.slice(b,b+2)==="[["?(w=!0,g+="[[",b++):w&&l.slice(b,b+2)==="]]"?(w=!1,g+="]]",b++):!w&&l[b]==="/"?(y.push(g),g=""):g+=l[b];g&&y.push(g)}return _&&y.push(_),d&&y.push(d),{segments:y,has_block:m}},"split_path_segments"),s={name:"",children:{},selected:!1},i=r((a,c)=>c.some(l=>a.startsWith(`${l}/`)),"is_redundant"),o=n.filter(a=>{let c=e(a);return c?!(c.includes("#")?c.split("#")[0]:c).match(/\.[a-zA-Z0-9]+$/u):!1}).map(a=>e(a)).filter(Boolean);for(let a of n){let c=e(a),l=a?.exists;if(!c||i(c,o.filter(f=>f!==c)))continue;let{segments:d,has_block:_}=t(c),m=s,p="";d.forEach((f,y)=>{if(p=p?`${p}/${f}`:f,f.startsWith("external:.."))return;let g=y===d.length-1,w=g&&_;m.children[f]||(m.children[f]={name:f,path:w?c:p,children:w?[]:{},selected:!1,is_file:w||g&&f.includes(".")}),m=m.children[f],g&&(m.selected=!0,m.exists=l)})}return s}r(Wz,"build_path_tree");function tC(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>QS(s,e,tC(s,e))).join("")}</ul>`}r(tC,"tree_to_html");var sC=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf, .sc-context-item-remove {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;var Hz=r((n,e)=>!n||!e?!1:n===e||n.startsWith(`${e}/`)?!0:n.startsWith(`${e}#`),"is_nested_context_item");function nC(n,e={}){let{target_path:t}=e;if(!t)return[];let i=Object.keys(n?.data?.context_items||{}).filter(o=>Hz(o,t));return[...new Set(i)]}r(nC,"get_nested_context_item_keys");var Jz=r(n=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(n);return}setTimeout(n,0)},"schedule_next_frame"),Kz=r(n=>{let e=!1;return()=>{e||(e=!0,Jz(()=>{e=!1,n()}))}},"create_render_scheduler"),Vz=r((n,e={})=>{let{target_path:t}=e,s=nC(n,{target_path:t});n.remove_items(s)},"remove_nested_context_items");function Xz(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(Xz,"build_html");async function iC(n,e={}){this.apply_style_sheet(sC);let t=Xz(n,e),i=this.create_doc_fragment(t).firstElementChild;return Yz.call(this,n,i,e),i}r(iC,"render");async function Yz(n,e,t={}){let s=n?.env?.plugin,i=s?.registerDomEvent?.bind(s)||((l,d,_)=>l.addEventListener(d,_)),o=r(()=>{let l=n.env,d=n.context_items.filter(t.filter),_=eC(d),m=this.create_doc_fragment(_);this.empty(e),e.appendChild(m);for(let p=0;p<d.length;p++){let f=d[p],y=e.querySelector(`.sc-tree-item[data-path="${f.key}"]`);if(!y){console.warn(`Smart Context: Could not find tree item for path: ${f.key}`);continue}l.smart_components.render_component("context_item_leaf",f).then(g=>{this.empty(y),y.appendChild(g)})}},"render_tree_leaves"),a=Kz(o);o(),i(e,"click",l=>{let d=l.target.closest(".sc-context-item-remove");if(!d)return;l.preventDefault(),l.stopPropagation();let _=d.getAttribute("data-path");Vz(n,{target_path:_})});let c=[];return c.push(n.on_event("context:updated",a)),this.attach_disposer(e,c),e}r(Yz,"post_process");var oC=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function Qz(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(Qz,"build_html");async function rC(n,e={}){let t=Qz(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(oC),await e3.call(this,n,s,e),s}r(rC,"render");async function e3(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let m=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of m){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',w=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',b="",k="";try{let O=await p.read();b=O.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),k=(await p.get_embed_input(O)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(O){console.error("[source_inspector] Error reading block:",O),b='<em style="color:red;">Error reading block content</em>'}let C=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${w}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${k}</pre>
</details>
<blockquote>${b}</blockquote>
<hr>
`);s.appendChild(C)}return e}r(e3,"post_process");var _C=require("obsidian");var Pi=require("obsidian");var aC=require("obsidian");var lm=class extends aC.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var cC=require("obsidian");var dm=class extends cC.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function lC(n,e,t={}){let{Menu:s=Pi.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new Pi.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new Pi.Notice("Active note is not indexed by Smart Environment");return}new lm(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new dm(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new Pi.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(lC,"register_status_bar_context_menu");var dC=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function s3(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(s3,"build_html");async function uC(n,e={}){this.apply_style_sheet(dC);let s=this.create_doc_fragment(s3()).firstElementChild;return n3.call(this,n,s,e),s}r(uC,"render");function n3(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",w=c(),b=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",b="attention"),s&&(0,_C.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=k=>{k.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),w>0?i.dataset.count=String(w):delete i.dataset.count,b?i.dataset.level=String(b):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=k=>{if(l()>0)k.preventDefault(),k.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let O=new MouseEvent("contextmenu",k);e.dispatchEvent?.(O)}},e.addEventListener("click",e._click_handler))},"render_status_elm");lC(n,e),d();let _=null,m=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",m)),this.attach_disposer(e,p)}r(n3,"post_process");var mC=require("obsidian");function i3(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(i3,"build_html");function pC(n,e={}){let t=i3.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return o3.call(this,n,i,e),i}r(pC,"render");async function o3(n,e){let t=e.querySelector(".callout-icon"),s=(0,mC.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(o3,"post_process");var hC=require("obsidian");function r3(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(r3,"build_html");function fC(n,e={}){let t=r3.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,hC.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),a3.call(this,n,i,e),i}r(fC,"render");function a3(n,e){}r(a3,"post_process");var py=require("obsidian");async function gC(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new py.Notice("No context items to copy.");let t=await this.get_text(n);await cm(t);let s=c3({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new py.Notice(s)}r(gC,"copy_to_clipboard");function c3(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${l3(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=d3(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(c3,"format_stats_message");function l3(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(l3,"format_char_count");function d3(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(d3,"sum_exclusions");var _3="xml_structured",um={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},yC=r((n={})=>{let e=n.template_preset||_3;return um[e]?e:"custom"},"get_preset_key"),_m=r((n,e,t,s)=>{let i=yC(n),o=um[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function mm(){return Object.entries(um).map(([n,e])=>({value:n,label:e.label||n}))}r(mm,"get_template_preset_options");function bC(n={},e={}){return{template_before:_m(n,e,"context_template_before","template_before"),template_after:_m(n,e,"context_template_after","template_after")}}r(bC,"get_context_templates");function vC(n={},e={}){let t=yC(n),s=um[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:_m(n,e,"item_template_before","template_before"),template_after:_m(n,e,"item_template_after","template_after")}}r(vC,"get_item_templates");var u3=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),m3=r(n=>u3(n.key),"get_item_name");async function kC(n,e={}){let t={KEY:this.key,ITEM_NAME:m3(this),TIME_AGO:hf(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(m,p)=>t[p]||"");return c},"replace_vars"),i=vC(this.settings,hy);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(kC,"merge_template");var wC={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>mm(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},hy={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Ii(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=p3(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return pm(e),xC(e).trimEnd()}r(Ii,"build_file_tree_string");function p3(n){return typeof n=="string"&&n.endsWith("/")}r(p3,"is_folder_path");function pm(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,pm(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],pm(n[i])}else pm(t)}}}r(pm,"compress_single_child_dirs");function xC(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=xC(o,e+(c?"    ":"\u2502   ")))}),t}r(xC,"build_tree_string");async function EC(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>Ii(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(m,p)=>s[p]?.()||"");return l},"replace_vars"),o=bC(this.settings,fy),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(EC,"merge_template");var AC={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>mm(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},fy={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function wa(n={}){n?.modal?.setInstructions([{command:"Enter",purpose:"Add block to context"},{command:"\u2190",purpose:"Back to sources"}]);let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:h3(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action"),arrow_left_action:r(({modal:s})=>{s.update_suggestions("context_suggest_sources")},"arrow_left_action")}))}r(wa,"context_suggest_blocks");function h3(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(h3,"get_block_display_name");var SC="Add blocks";var OC=require("obsidian");var f3=OC.Platform.isMacOS?"\u2318":"Ctrl";function g3(n){return typeof n!="string"?"":n.replace(/\/+$/g,"")}r(g3,"normalize_folder_path");function y3(n,e){let t=g3(e);return!t||n===t?!0:n.startsWith(`${t}/`)}r(y3,"is_source_in_folder");function CC(n){n?.inputEl&&(n.last_input_value=n.inputEl.value,n.inputEl.value="")}r(CC,"reset_modal_input");function b3(n,e){return Object.values(n.env?.smart_sources?.items||{}).filter(s=>y3(s.key,e))}r(b3,"get_sources_list");function v3(n,e){return e.map(t=>({key:t.key,display:t.key,select_action:r(()=>{n.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s}={})=>(CC(s),wa.call(n,{source_key:t.key,modal:s})),"mod_select_action"),arrow_right_action:r(({modal:s}={})=>(CC(s),wa.call(n,{source_key:t.key,modal:s})),"arrow_right_action")}))}r(v3,"build_source_suggestions");function qC(n={}){console.log("context_suggest_sources",n);let e=n?.modal;e&&e.setInstructions([{command:"Enter",purpose:"Add source to context"},{command:`${f3} + Enter / \u2192`,purpose:"Suggest source blocks"}]);let t=b3(this,n?.folder_path||"");return v3(this,t)}r(qC,"context_suggest_sources");var $C="Add sources";async function hm(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(hm,"pre_process");function gy(n){return this.vec?n.to_item?.vec?{score:Ms(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(gy,"similarity");gy.action_type="score";var yy="Cosine Similarity",by="Ranks by cosine similarity between the current note and candidates.",jC={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${yy} algorithm`,value:`${by}`}};var vy=require("obsidian");async function TC(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=vy.Keymap.isModEvent(e),l=vy.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(TC,"open_source");async function NC(n=null){await TC(this,n)}r(NC,"source_open");var PC={collections:{embedding_models:oS,lookup_lists:aS},item_types:{EmbeddingModel:Ys,LookupList:is},items:{embedding_model:{class:Ys},lookup_list:{class:is}},modules:{},components:{collection_settings:{render:cS},context_item_leaf:{render:pS},env_stats:{render:hS},form_dropdown:{render:ly},lean_coffee_callout:{render:yS},milestones:{render:AS},notifications_feed:{render:SS},pro_plugins_list:{render:NS},pro_plugins_list_item:{render:PS},settings_env_model:{render:zS},settings_env_model_type:{render:BS},settings_env_models:{render:US},settings_env_sources:{render:jE},settings_model_actions:{render:WS},settings_notifications:{render:GS},settings_smart_env:{render:JS},smart_context_actions:{render:VS},smart_context_item:{render:YS},smart_context_meta:{render:ZS},smart_context_tree:{render:iC},source_inspector:{render:rC},status_bar:{render:uC},supporter_callout:{render:pC},user_agreement_callout:{render:fC}},actions:{context_copy_to_clipboard:{action:gC},context_item_merge_template:{action:kC,settings_config:wC,default_settings:hy},context_merge_template:{action:EC,settings_config:AC,default_settings:fy},context_suggest_blocks:{action:wa,display_name:SC},context_suggest_sources:{action:qC,display_name:$C},lookup_list_pre_process:{action:hm,pre_process:hm},similarity:{action:gy,settings_config:jC,display_name:yy,display_description:by},source_open:{action:NC}}};var IC={env_path:"",modules:{smart_fs:{class:Q_,adapter:eu},smart_view:{class:ou,adapter:au},smart_embed_model:{class:Hr,adapters:{transformers:Ai,openai:Nu,ollama:Mu,gemini:Lu,lm_studio:zu}},smart_chat_model:{class:Kr,adapters:{anthropic:Vr,azure:Zr,custom:la,google:Ci,gemini:ta,groq:da,lm_studio:na,ollama:ra,open_router:sa,openai:Xs,xai:_a,deepseek:ua},http_adapter:new ut({adapter:Ei,obsidian_request_url:ky.requestUrl})},http_adapter:{class:ut,adapter:Ei,obsidian_request_url:ky.requestUrl}},collections:{context_items:XA,event_logs:ZA,smart_components:GA,smart_contexts:KA,smart_sources:{collection_key:"smart_sources",class:Rr,data_adapter:Ur,source_adapters:{md:Hs,txt:Hs,"excalidraw.md":Su,base:xu,canvas:Au,rendered:Eu},content_parsers:[RA],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:Gr,data_adapter:Cu,block_adapters:{md:bi,txt:bi,"excalidraw.md":bi}}},item_types:{SmartSource:gi,SmartBlock:yi},items:{smart_source:xA,smart_block:$A},default_settings:sS,modals:{context_selector:{class:Yu,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:Qu},notifications_feed_modal:{class:Zu}}};Ct(IC,PC);var MC=IC;var fm=require("obsidian");function LC(){(0,fm.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}r(LC,"add_smart_chat_icon");function zC(){(0,fm.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}r(zC,"add_smart_connections_icon");function DC(){(0,fm.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}r(DC,"add_smart_lookup_icon");var RC=require("obsidian");var gm={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function k3(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(k3,"define_default_create_methods");var xa=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,k3(gm)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=gm[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,RC.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,gm["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var FC=require("obsidian");var w3=require("obsidian");function ym(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(ym,"get_smart_server_url");var x3="smart-plugins-op",E3="smart-plugins-op-secret";function A3({access_token:n,refresh_token:e},t){localStorage.setItem(t+"token",n),e&&localStorage.setItem(t+"refresh",e)}r(A3,"set_local_storage_token");async function BC(n,e){let t=C3(e.app.vault.getName()),s=`${ym()}/auth/oauth_exchange2`,i=await(0,FC.requestUrl)({url:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:x3,client_secret:E3,code:n})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:o,refresh_token:a}=i.json;if(!o)throw new Error("No access_token in response");A3({access_token:o,refresh_token:a},t)}r(BC,"exchange_code_for_tokens");var S3="_smart_plugins_oauth_";function C3(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${S3}`}r(C3,"build_oauth_storage_prefix");function UC(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let s=Ii([...new Set(t)]);return n.replace(/{{\s*folder_tree\s*}}/gi,s)}r(UC,"replace_folder_tree_var");function WC(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let s=Ii([...new Set(t)]);return n.replace(/{{\s*folders_top\s*}}/gi,s)}r(WC,"replace_folders_top_var");function GC(n){console.log("replace_recent_n_var",n);let e=this;return n.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,s)=>{let i=parseInt(s,10)||0,o=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,o),o?`
- ${o}`:""}).trim()}r(GC,"replace_recent_n_var");function HC(n){let t=this.app?.metadataCache?.getTags?.()||{},s=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return n.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${s}
`).trim()}r(HC,"replace_vault_tags_var");function JC(n){n.register(e=>/{{\s*folder_tree\s*}}/i.test(e),UC,"{{ folder_tree }}"),n.register(e=>/{{\s*folders_top\s*}}/i.test(e),WC,"{{ folders_top }}"),n.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),HC,"{{ tags }}"),n.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),GC,"{{ recent_10 }}")}r(JC,"register_completion_variable_adapter_replacements");async function ft({app:n,plugin_ids:e=[]}={}){if(!n)return;let t=n.vault?.adapter;for(let s of e)await O3(n.plugins,s)&&console.warn(`Disabled legacy plugin: ${s}`),await q3(t,s)&&console.warn(`Removed legacy plugin: ${s}`)}r(ft,"remove_smart_plugins_plugin");async function O3(n,e){if(!(!n||!(n.plugins?.[e]||n.enabledPlugins?.has?.(e)||n.manifests&&e in n.manifests)))return n.plugins?.[e]&&await n.unloadPlugin?.(e),n.disablePluginAndSave&&await n.disablePluginAndSave(e),n.enabledPlugins?.has?.(e)&&n.enabledPlugins.delete(e),n.manifests&&e in n.manifests&&delete n.manifests[e],await n.loadManifests?.(),!0}r(O3,"disable_plugin_if_present");async function q3(n,e){if(!n?.exists)return;let t=`.obsidian/plugins/${e}`;if(await n.exists(t)){if(n.rmdir){await n.rmdir(t,!0);return}if(n.list&&n.remove){let i=[t];for(;i.length;){let o=i.pop(),a=await n.list(o);for(let c of a?.files||[])await n.remove(`${o}/${c}`);for(let c of a?.folders||[])i.push(`${o}/${c}`)}return await n.remove(t),!0}}}r(q3,"remove_plugin_folder");var Mi=class extends Dr{static{r(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,LC(),zC(),DC(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new os.Notice(i,0),window.smart_env=null}let s=Ct(t,MC);return s.env_path="",await super.create(e,s)}async load(e=!1){if(this.run_migrations(),this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")||this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),os.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new os.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i.view?.file?.path;this.emit_source_opened(o,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i?.path;this.emit_source_opened(o,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&JC(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),kS(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let s=this.smart_sources.get(e);s&&(this._current_opened_source=e,s.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new xa(this,{adapter:os.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),s=`${ym()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(s,"_external"),s}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new os.Notice("No OAuth code provided in URL. Login failed.");return}try{await BC(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(s){console.error("OAuth callback error",s),new os.Notice(`OAuth callback error: ${s.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&$3(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){ft({app:this.plugin.app,plugin_ids:["smart-plugins"]}),ft({app:this.plugin.app,plugin_ids:["smart-editor"]}),ft({app:this.plugin.app,plugin_ids:["smart-sources"]}),ft({app:this.plugin.app,plugin_ids:["smart-claude"]}),ft({app:this.plugin.app,plugin_ids:["smart-gemini"]}),ft({app:this.plugin.app,plugin_ids:["smart-deepseek"]}),ft({app:this.plugin.app,plugin_ids:["smart-perplexity"]}),ft({app:this.plugin.app,plugin_ids:["smart-grok"]}),ft({app:this.plugin.app,plugin_ids:["smart-aistudio"]})}};function $3(n,e){let t=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}r($3,"download_json");var T3=require("obsidian");var j3=require("obsidian");var KC=require("obsidian");var Li=require("obsidian");async function wy(n){let e=n.plugin?.app||window.app,t=om(e),s=(typeof localStorage<"u"?localStorage.getItem(t+"token"):"")||"";if(!s){console.warn("[smart_plugins] No OAuth token found; skipping Smart Plugins auto\u2011update."),bm("Smart Plugins: connect your Smart Plugins account to keep using Pro plugins.");let i=t+"auth_misses",o=parseInt(localStorage.getItem(i)||"0",10);return localStorage.setItem(i,(o+1).toString()),{updated:[],skipped:[],checked:0}}try{let i=await I3(e);console.log("[smart_plugins] Built installed plugins map:",i);let o=await rm(s);console.log("[smart_plugins] Fetched server plugin list:",o);let a=Array.isArray(o.list)?o.list:[],c=Array.isArray(o.unauthorized)?o.unauthorized:[],l=o.sub_exp,d=typeof l=="number"&&l<Date.now(),_=[],m=[],p=[];if(d){if(c.length){console.log("[smart_plugins] Subscription expired; handling unauthorized plugins.",{unauthorized_list:c});for(let k of c){if(!i[k.plugin_id]){p.push(k.plugin_id);continue}if(k.core_repo)await N3(e,k)&&m.push(k.plugin_id);else{await M3(e,k.plugin_id)&&_.push(k.plugin_id);continue}}}let b={updated:[],skipped:[],checked:0,removed:_,replaced:m,not_installed:p,unauthorized_count:c.length,sub_exp:l||null};return console.log({update_result:b}),b}let f=a.length,y=[];for(let b of a){if(!b||!b.repo)continue;let k=b.version||"unknown",C=(b.manifest_id||b.repo.replace("/","_")).trim(),O=i[C];!O||!O.version||nm(O.version,k)&&y.push({item:b,plugin_id:C,local_version:O.version,server_version:k})}if(!y.length)return{updated:[],skipped:[],checked:f};let g=[],w=[];for(let b of y){let{item:k,plugin_id:C,local_version:O,server_version:j}=b;try{let $=await im(k.repo,s),{files:A,pluginManifest:x}=await ba($),u=x.id,h=`${e.vault.configDir}/plugins/${u}`;await va(e.vault.adapter,h,A),g.push(`${k.repo}@${j}`)}catch($){console.error("[smart_plugins] Failed to auto\u2011update plugin:",{repo:k.repo,plugin_id:C,local_version:O,server_version:j,error:$}),w.push(k.repo)}}if(g.length){let b=g.length===1?"":"s";bm(`Smart Plugins: updated ${g.length} plugin${b}. Please restart Obsidian to apply updates.`)}else w.length||bm("Smart Plugins: no updates applied.");return{updated:g,skipped:w,checked:f}}catch(i){return console.error("[smart_plugins] update_installed_smart_plugins error:",i),bm("Smart Plugins: failed to check for updates. See console for details."),{updated:[],skipped:[],checked:0}}}r(wy,"update_installed_smart_plugins");async function N3(n,e){let t=await(0,Li.requestUrl)({url:`https://api.github.com/repos/${e.core_repo}/releases/latest`,method:"GET"}),s=t?.json||{};if(!(s?.tag_name||null))return console.error("[smart_plugins] Failed to get latest core plugin version from GitHub:",{core_repo:e.core_repo,response:t}),null;try{let o=s?.assets?.find(m=>m.name.endsWith(".zip"))?.browser_download_url||null;if(!o)return console.error("[smart_plugins] Failed to find core plugin zip asset in GitHub release:",{core_repo:e.core_repo,release:s}),null;let a=await P3(o),{files:c,pluginManifest:l}=await ba(a),d=e.plugin_id,_=`${n.vault.configDir}/plugins/${d}`;return await va(n.vault.adapter,_,c),!0}catch(o){return console.error("[smart_plugins] Failed to install core plugin:",{core_repo:e.core_repo,error:o}),null}}r(N3,"replace_pro_with_core");async function P3(n){console.log(`[smart_plugins] download plugin from URL: ${n}`);let e=await(0,Li.requestUrl)({url:n,method:"GET",headers:{Accept:"application/zip"}});if(e.status&&e.status!==200)throw new Error(`Download error ${e.status}: ${e.text||""}`);return sm(e.arrayBuffer,"Download")}r(P3,"fetch_zip_from_public_url");async function I3(n){let e={},t=n.plugins;if(!t)return e;await t.loadManifests();let s=t.manifests||{};for(let i in s){if(!Object.prototype.hasOwnProperty.call(s,i))continue;let o=s[i]||{};e[i]={id:o.id||i,name:o.name||i,version:o.version||""}}return e}r(I3,"build_installed_plugins_map");function bm(n){try{typeof Li.Notice=="function"?new Li.Notice(n):console.log("[smart_plugins]",n)}catch(e){console.log("[smart_plugins] notice error",e,n)}}r(bm,"show_notice");async function M3(n,e){let t=n?.vault?.adapter;if(!t)return!1;let s=`${n.vault.configDir}/plugins/${e}`,i=`${s}/main.js`,o=`${s}/manifest.json`;try{return await t.exists(i)&&await t.remove(i),await t.exists(o)&&await t.remove(o),!0}catch(a){console.error("[smart_plugins] Failed to remove main.js for unauthorized plugin",{plugin_id:e,error:a})}return!1}r(M3,"remove_main_js_for_plugin");var zi=class n extends Mi{static{r(this,"SmartEnv")}static version="2.3.11";is_pro=!0;async load(e=!1){await super.load(e),n.wait_for({loaded:!0}).then(async()=>{console.warn("[smart_env] Checking for Smart Plugins updates..."),wy(this),this._registered_refresh_event||(this._registered_refresh_event=!0,this.events.on("pro_plugins:refresh",async()=>{console.warn("[smart_env] Refreshing Smart Plugins list..."),wy(this)}))})}},mze=zi.version;var jze=Ct(a_,A_);var Di=require("obsidian");function xy(n={}){let{view:e,active_file:t}=n;return e?.file?.path||t?.path}r(xy,"resolve_active_source_path");function Ey(n,e={}){if(!n?.smart_sources)return null;let{source_path:t}=e;if(!t)return null;let s=n.smart_sources.get(t);if(!s)return null;let i=n.config?.modals?.copy_context_modal?.class;return i?{source_path:t,source:s,modal_class:i}:null}r(Ey,"get_copy_current_dependencies");var VC=r((n,e={})=>{let{source_path:t,source:s,modal_class:i,with_media:o}=e;s.actions.source_get_context().then(a=>{if(!a){n.env.events.emit("notification:error",{message:"Failed to build context for current note."}),new Di.Notice("Failed to build context for current note.");return}let c=n.env.smart_contexts.get(t+"#codeblock");c&&(a=n.env.smart_contexts.new_context({key:t+"#combined_copy",context_items:{...a.data.context_items,...c.data.context_items}})),new i(a,o?{with_media:!0}:void 0).open()})},"open_copy_current_modal");function XC(n){return{select_ext:{id:"external-file-codeblock",name:"External source file context codeblock",editorCheckCallback:r((e,t,s)=>{if(n.app.isMobile)return e||new Di.Notice("This command is only available on desktop."),!1;if(!e){let o=s.file?.path+"#codeblock",a=n.env.smart_contexts;(a.get(o)||a.new_context({key:o})).emit_event("context_selector:open",{default_suggest_action_keys:["context_suggest_external"]});let l=/```smart-context[\s\S]*?```/g,d=t.getValue();if(!l.test(d)){let _=t.getCursor();t.replaceRange("\n```smart-context\n\n```\n",_)}}return!0},"editorCheckCallback")},copy_current:{id:"copy-current-note-with-depth",name:"Copy current to clipboard (with media)",checkCallback:r(e=>{let t=n.app.workspace.getActiveViewOfType(Di.MarkdownView),s=n.app.workspace.getActiveFile?.(),i=xy({view:t,active_file:s}),o=Ey(n.env,{source_path:i});return o?(e||VC(n,{...o,with_media:!0}),!0):!1},"checkCallback")},copy_current_no_media:{id:"copy-current-note-with-depth-text-only",name:"Copy current to clipboard (text only)",checkCallback:r(e=>{let t=n.app.workspace.getActiveViewOfType(Di.MarkdownView),s=n.app.workspace.getActiveFile?.(),i=xy({view:t,active_file:s}),o=Ey(n.env,{source_path:i});return o?(e||VC(n,o),!0):!1},"checkCallback")}}}r(XC,"pro_commands");var z3=Po,vm=class extends z3{static{r(this,"SmartContextPlugin")}SmartEnv=zi;onload(){this.app.workspace.onLayoutReady(this.initialize.bind(this)),this.SmartEnv.create(this,rA)}get commands(){return{...super.commands,...XC(this)}}register_commands(){super.register_commands(),bw(this)}};

const smart_hash_id='b2733ca5b6f933e6d9270fdb1236c755672735a5f45434f868109ef5865bd421';