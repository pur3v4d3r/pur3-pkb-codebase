var vS=Object.create;var Ci=Object.defineProperty;var kS=Object.getOwnPropertyDescriptor;var wS=Object.getOwnPropertyNames;var xS=Object.getPrototypeOf,ES=Object.prototype.hasOwnProperty;var r=(n,e)=>Ci(n,"name",{value:e,configurable:!0});var fa=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),AS=(n,e)=>{for(var t in e)Ci(n,t,{get:e[t],enumerable:!0})},Bg=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of wS(e))!ES.call(n,i)&&i!==t&&Ci(n,i,{get:()=>e[i],enumerable:!(s=kS(e,i))||s.enumerable});return n};var P=(n,e,t)=>(t=n!=null?vS(xS(n)):{},Bg(e||!n||!n.__esModule?Ci(t,"default",{value:n,enumerable:!0}):t,n)),SS=n=>Bg(Ci({},"__esModule",{value:!0}),n);var fy=fa(Ya=>{"use strict";Ya.byteLength=eC;Ya.toByteArray=sC;Ya.fromByteArray=oC;var Je=[],ke=[],QS=typeof Uint8Array<"u"?Uint8Array:Array,vm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(ds=0,py=vm.length;ds<py;++ds)Je[ds]=vm[ds],ke[vm.charCodeAt(ds)]=ds;var ds,py;ke[45]=62;ke[95]=63;function hy(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(hy,"getLens");function eC(n){var e=hy(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(eC,"byteLength");function tC(n,e,t){return(e+t)*3/4-t}r(tC,"_byteLength");function sC(n){var e,t=hy(n),s=t[0],i=t[1],o=new QS(tC(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=ke[n.charCodeAt(l)]<<18|ke[n.charCodeAt(l+1)]<<12|ke[n.charCodeAt(l+2)]<<6|ke[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=ke[n.charCodeAt(l)]<<2|ke[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=ke[n.charCodeAt(l)]<<10|ke[n.charCodeAt(l+1)]<<4|ke[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(sC,"toByteArray");function nC(n){return Je[n>>18&63]+Je[n>>12&63]+Je[n>>6&63]+Je[n&63]}r(nC,"tripletToBase64");function iC(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(nC(s));return i.join("")}r(iC,"encodeChunk");function oC(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(iC(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(Je[e>>2]+Je[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(Je[e>>10]+Je[e>>4&63]+Je[e<<2&63]+"=")),i.join("")}r(oC,"fromByteArray")});var Zk=fa(Dl=>{"use strict";Dl.byteLength=Nq;Dl.toByteArray=Iq;Dl.fromByteArray=zq;var Qe=[],Ee=[],Tq=typeof Uint8Array<"u"?Uint8Array:Array,Tp="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Ss=0,Xk=Tp.length;Ss<Xk;++Ss)Qe[Ss]=Tp[Ss],Ee[Tp.charCodeAt(Ss)]=Ss;var Ss,Xk;Ee[45]=62;Ee[95]=63;function Yk(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(Yk,"getLens");function Nq(n){var e=Yk(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(Nq,"byteLength");function Pq(n,e,t){return(e+t)*3/4-t}r(Pq,"_byteLength");function Iq(n){var e,t=Yk(n),s=t[0],i=t[1],o=new Tq(Pq(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Ee[n.charCodeAt(l)]<<18|Ee[n.charCodeAt(l+1)]<<12|Ee[n.charCodeAt(l+2)]<<6|Ee[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Ee[n.charCodeAt(l)]<<2|Ee[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Ee[n.charCodeAt(l)]<<10|Ee[n.charCodeAt(l+1)]<<4|Ee[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(Iq,"toByteArray");function Mq(n){return Qe[n>>18&63]+Qe[n>>12&63]+Qe[n>>6&63]+Qe[n&63]}r(Mq,"tripletToBase64");function Lq(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(Mq(s));return i.join("")}r(Lq,"encodeChunk");function zq(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(Lq(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(Qe[e>>2]+Qe[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(Qe[e>>10]+Qe[e>>4&63]+Qe[e<<2&63]+"=")),i.join("")}r(zq,"fromByteArray")});var BE=fa(X_=>{"use strict";X_.byteLength=oP;X_.toByteArray=aP;X_.fromByteArray=dP;var ot=[],Ce=[],iP=typeof Uint8Array<"u"?Uint8Array:Array,mf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Gs=0,RE=mf.length;Gs<RE;++Gs)ot[Gs]=mf[Gs],Ce[mf.charCodeAt(Gs)]=Gs;var Gs,RE;Ce[45]=62;Ce[95]=63;function FE(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(FE,"getLens");function oP(n){var e=FE(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(oP,"byteLength");function rP(n,e,t){return(e+t)*3/4-t}r(rP,"_byteLength");function aP(n){var e,t=FE(n),s=t[0],i=t[1],o=new iP(rP(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Ce[n.charCodeAt(l)]<<18|Ce[n.charCodeAt(l+1)]<<12|Ce[n.charCodeAt(l+2)]<<6|Ce[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Ce[n.charCodeAt(l)]<<2|Ce[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Ce[n.charCodeAt(l)]<<10|Ce[n.charCodeAt(l+1)]<<4|Ce[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(aP,"toByteArray");function cP(n){return ot[n>>18&63]+ot[n>>12&63]+ot[n>>6&63]+ot[n&63]}r(cP,"tripletToBase64");function lP(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(cP(s));return i.join("")}r(lP,"encodeChunk");function dP(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(lP(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(ot[e>>2]+ot[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(ot[e>>10]+ot[e>>4&63]+ot[e<<2&63]+"=")),i.join("")}r(dP,"fromByteArray")});var QA=fa(Fu=>{"use strict";Fu.byteLength=R4;Fu.toByteArray=B4;Fu.fromByteArray=G4;var lt=[],Oe=[],D4=typeof Uint8Array<"u"?Uint8Array:Array,Qf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Xs=0,YA=Qf.length;Xs<YA;++Xs)lt[Xs]=Qf[Xs],Oe[Qf.charCodeAt(Xs)]=Xs;var Xs,YA;Oe[45]=62;Oe[95]=63;function ZA(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}r(ZA,"getLens");function R4(n){var e=ZA(n),t=e[0],s=e[1];return(t+s)*3/4-s}r(R4,"byteLength");function F4(n,e,t){return(e+t)*3/4-t}r(F4,"_byteLength");function B4(n){var e,t=ZA(n),s=t[0],i=t[1],o=new D4(F4(n,s,i)),a=0,c=i>0?s-4:s,l;for(l=0;l<c;l+=4)e=Oe[n.charCodeAt(l)]<<18|Oe[n.charCodeAt(l+1)]<<12|Oe[n.charCodeAt(l+2)]<<6|Oe[n.charCodeAt(l+3)],o[a++]=e>>16&255,o[a++]=e>>8&255,o[a++]=e&255;return i===2&&(e=Oe[n.charCodeAt(l)]<<2|Oe[n.charCodeAt(l+1)]>>4,o[a++]=e&255),i===1&&(e=Oe[n.charCodeAt(l)]<<10|Oe[n.charCodeAt(l+1)]<<4|Oe[n.charCodeAt(l+2)]>>2,o[a++]=e>>8&255,o[a++]=e&255),o}r(B4,"toByteArray");function U4(n){return lt[n>>18&63]+lt[n>>12&63]+lt[n>>6&63]+lt[n&63]}r(U4,"tripletToBase64");function W4(n,e,t){for(var s,i=[],o=e;o<t;o+=3)s=(n[o]<<16&16711680)+(n[o+1]<<8&65280)+(n[o+2]&255),i.push(U4(s));return i.join("")}r(W4,"encodeChunk");function G4(n){for(var e,t=n.length,s=t%3,i=[],o=16383,a=0,c=t-s;a<c;a+=o)i.push(W4(n,a,a+o>c?c:a+o));return s===1?(e=n[t-1],i.push(lt[e>>2]+lt[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],i.push(lt[e>>10]+lt[e>>4&63]+lt[e<<2&63]+"=")),i.join("")}r(G4,"fromByteArray")});var EM={};AS(EM,{default:()=>om});module.exports=SS(EM);var An=require("obsidian");var zc=require("obsidian");var pt=require("obsidian");var ga=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var ya=class extends ga{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var ns=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new ya(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};async function CS(n,e={}){let t=Object.entries(n.settings_config).map(([o,a])=>(a.setting||(a.setting=o),this.render_setting_html(a))).join(`
`),s=Object.entries(n.collections).map(([o,a])=>`<div data-smart-settings="${o}"></div>`).join(`
`);return`
<div class="">
${t}
${s}
</div>
`}r(CS,"build_html");async function Ug(n,e={}){let t=await CS.call(this,n,e),s=this.create_doc_fragment(t);return await OS.call(this,n,s,e)}r(Ug,"render");async function OS(n,e,t={}){await this.render_setting_components(e,{scope:n});let s=e.querySelectorAll("[data-smart-settings]");for(let i of s){let o=i.dataset.smartSettings;await n[o].render_settings(i)}return e}r(OS,"post_process");var ba=class{static{r(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let s=new this(e,t);return await s.load(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}static create_sync(e,t={}){let s=new this(e,t);return s.load_sync(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}get settings(){return qS(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",$S(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function qS(n,e){let t=new WeakMap,s=new WeakMap,i=r((a,c)=>{if(!am(a)||s.has(a))return a;if(t.has(a))return t.get(a);let l=o(a,c);return t.set(a,l),s.set(l,a),l},"wrap_value"),o=r((a,c)=>new Proxy(a,{set(l,d,_){let m=[...c,d],p=rm(l[d]),f=rm(_);return l[d]=i(_,m),jS(p,f)&&e({type:"set",path:m,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],m=rm(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:m}),!0}}),"create_proxy");return i(n,[])}r(qS,"observe_object");function $S(n){let e=Array.isArray(n.path)?n.path:[];return{type:n.type,path:e,path_string:e.join("."),value:n.value,previous_value:n.previous_value}}r($S,"build_settings_changed_event");function rm(n){if(!am(n))return n;if(typeof structuredClone=="function")try{return structuredClone(n)}catch{}try{return JSON.parse(JSON.stringify(n))}catch{return n}}r(rm,"snapshot_value");function jS(n,e){return Wg(n)!==Wg(e)}r(jS,"has_changed");function Wg(n){if(n===void 0)return"undefined";if(Number.isNaN(n))return"number:NaN";if(n===1/0)return"number:Infinity";if(n===-1/0)return"number:-Infinity";if(!am(n))return`${typeof n}:${String(n)}`;try{return`object:${JSON.stringify(n)}`}catch{return`object:${String(n)}`}}r(Wg,"serialize_value");function am(n){return typeof n=="object"&&n!==null}r(am,"is_observable");function We(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Gg(e[t])&&Gg(n[t])?We(n[t],e[t]):n[t]=e[t]);return n}r(We,"deep_merge");function Gg(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Gg,"is_plain_object");function me(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(me,"camel_case_to_snake_case");function Hg(n){return n.collections||(n.collections={}),n.modules||(n.modules={}),n.items||(n.items={}),Object.entries(n.collections).forEach(([e,t])=>{typeof t=="function"&&(n.collections[e]={class:t});let s=me(e);s!==e&&(n.collections[s]=n.collections[e],delete n.collections[e]),n.collections[s].collection_key||(n.collections[s].collection_key=s),t.item_type&&(n.items[t.item_type.key||me(t.item_type.name)]={class:t.item_type})}),Object.entries(n.modules).forEach(([e,t])=>{typeof t=="function"&&(n.modules[e]={class:t});let s=me(e);s!==e&&(n.modules[s]=n.modules[e],delete n.modules[e])}),n.item_types||(n.item_types={}),n.items||(n.items={}),Object.entries(n.item_types).forEach(([e,t])=>{if(typeof t=="function"){let s=me(e);n.items[s]={class:t,actions:{},...n.items[s]||{}}}}),n}r(Hg,"normalize_opts");function TS(n){if(!n||typeof n!="object")return!1;let e=Object.getPrototypeOf(n);return e===Object.prototype||e===null}r(TS,"is_plain_object");function va(n){if(Array.isArray(n))return n.map(e=>va(e));if(TS(n)){let e={};for(let[t,s]of Object.entries(n))e[t]=va(s);return e}return n}r(va,"deep_clone_config");function Ys(n,e){let t=Jg(n),s=Jg(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(Ys,"compare_versions");function Jg(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(Jg,"normalize_version_value");function Oi(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Oi,"is_plain_object");function dt(n,e,t=[]){if(!Oi(n)||!Oi(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Oi(i)?(Oi(n[s])||(n[s]={}),dt(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(dt,"deep_merge_no_overwrite");function _t(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(Ys(d,_)>0){let p={...c};dt(p,l),n.collections[a]=p}else dt(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;Ys(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):dt(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),dt(n[i],o)):n[i]=o}return n}r(_t,"merge_env_config");function Kg(n={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:s}=n;return(e!==void 0||t!==void 0||s!==void 0)&&(n.smart_sources=n.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!n.smart_sources?.file_exclusions?.length||n.smart_sources?.file_exclusions==="Untitled")&&(n.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!n.smart_sources.folder_exclusions?.length&&(n.smart_sources.folder_exclusions=t),s!==void 0&&s.length&&!n.smart_sources.excluded_headings?.length&&(n.smart_sources.excluded_headings=s)),delete n.file_exclusions,delete n.folder_exclusions,delete n.excluded_headings,n}r(Kg,"migrate_exclusion_settings_2025_08_22");var NS=typeof globalThis<"u"?globalThis:Function("return this")(),qi=class{static{r(this,"SmartEnv")}static version="2.2.7";scope_name="smart_env";static global_ref=NS;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=ns.create(this,IS(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([s])=>this.primary_main_key&&s===this.primary_main_key?-1:0);for(let[s,i]of t){if(!i?.main){console.warn(`SmartEnv: '${s}' unloaded, skipping`),delete this.smart_env_configs[s];continue}if(!i?.opts){console.warn(`SmartEnv: '${s}' opts missing, skipping`);continue}_t(this._config,va(Hg(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:s}=t||{};if(s)for(let[i,o]of Object.entries(s.collections||{})){let a=o?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:Ys(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,PS(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let s=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(s),t(this.global_env))},1e3)}else{let s=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(s),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let s={};this.global_env&&Ys(this.version,this.global_env.constructor?.version||0)>0&&(s.primary_main_key=me(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(s);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let s=me(e.constructor.name);this.smart_env_configs[s]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:r(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await ba.create(this),this.config.default_settings&&dt(this.settings,this.config.default_settings),Kg(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:s}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let s=e.collections[t]?.class;s&&(s.default_settings&&dt(this.settings,{[t]:s.default_settings}),typeof s.init=="function"&&(await s.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((s,i)=>{let o=this.config.collections?.[s]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return o-a});for(let s of t){let i=Date.now();typeof this[s]?.process_load_queue=="function"&&(await this[s].process_load_queue(),this[s].load_time_ms=Date.now()-i,this.collections[s]="loaded",console.log(`Loaded ${this[s].collection_key} in ${this[s].load_time_ms}ms`))}}static unload_main(e){let t=me(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let s=this.opts.modules[e];return s?(t={...s,class:null,...t},new s.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||Ug}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,s={}){let i=this.get_component(e,t);return i?await i(t,s):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let s=t.collection_key??t.scope_name,i=s?`${s}-${e}`:e;if(!this._components[i])try{if(this.opts.components[s]?.[e]){let o=this.opts.components[s][e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let o=this.opts.components[e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${s}`)}catch(o){console.error("Error getting component",o),console.log(`scope_name: ${s}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[s]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.config.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(s=>s.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let s=e.map(i=>{let o=i.split("/").slice(-2,-1)[0];return{dir:o,count:this.fs.file_paths.filter(a=>a.includes(o)).length}});t=s.reduce((i,o)=>o.count>i.count?o:i,s[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(We(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(s=>s.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((s,i,o)=>o.indexOf(s)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function PS(n){return{items:Object.fromEntries(Object.entries(n.items||{}).map(([e,t])=>[e,t.data]))}}r(PS,"collection_to_plain");function IS(n){if(!n)return{};if(typeof n=="function")return{adapter_class:n};let e=n.adapter_class||n.adapter;return e?{adapter_class:e}:{}}r(IS,"build_events_opts");function MS(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=zS(n,t),o=LS(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(MS,"create_regex");function LS(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(LS,"adjust_for_windows_paths");function zS(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(zS,"glob_to_regex_pattern");function Vg(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:MS(n,s)}r(Vg,"glob_to_regex");function Xg(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(Xg,"fuzzy_search");var ka=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(Vg(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return Xg(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var DS=P(require("obsidian"),1);var wa=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=DS,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function xa(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(xa,"empty");var Yg=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var Zg=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var RS=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,Ea=r((n,e)=>{let t=e.trim();(RS.test(t)?Zg:Yg)(n,t)},"safe_inner_html");function je(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(je,"escape_html");function Qg(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Zs(l,o),l=cm(l,15),l=Zs(l,a),i^=l,i=cm(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Zs(l,o),l=cm(l,15),l=Zs(l,a),i^=l;break}return i^=n.length,i=FS(i),i|0}r(Qg,"murmur_hash_32");function Q(n,e=0){return(Qg(n,e)>>>0).toString(36)}r(Q,"murmur_hash_32_alphanumeric");function Zs(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Zs,"multiply_32");function cm(n,e){return n<<e|n>>>32-e}r(cm,"rotate_left_32");function FS(n){return n^=n>>>16,n=Zs(n,2246822507),n^=n>>>13,n=Zs(n,3266489909),n^=n>>>16,n|0}r(FS,"fmix_32");function lm(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(lm,"convert_to_time_ago");function is(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(is,"cos_sim");function be(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(be,"get_by_path");function ve(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(ve,"set_by_path");function dm(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(dm,"delete_by_path");function _m(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(_m,"compute_centroid");function um(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let m=Math.sqrt(_);s[a]+=m,s[l]+=m}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(um,"compute_medoid");var Aa=new WeakMap,Sa=new WeakMap,Ca=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return be(e,t,s)}set_by_path(e,t,s,i=null){ve(e,t,s,i)}delete_by_path(e,t,s=null){dm(e,t,s)}escape_html(e){return je(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||Sa.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");Sa.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=Sa.get(i);c&&(i.removeEventListener("change",c),Sa.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=Q(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){xa(e)}safe_inner_html(e,t){Ea(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=Aa.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},Aa.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(m){console.error("[smart-view] disposer error",m)}}finally{try{l.disconnect()}catch{}Aa.get(e)===c&&Aa.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var Oa=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(m=>{let p=l.addOption(m.value,m.label??m.name??m.value);p.selected=m.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let m=l.addOption(_.value,_.label??_.name??_.value);m.selected=_.value===s,c.length===1&&m.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,m=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(m),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let v=document.createElement("div");v.className="array-item-row";let k=document.createElement("input");k.type="text",k.value=y,k.placeholder="Value";let w=document.createElement("button");w.textContent="\u2715",w.title="Remove",k.addEventListener("change",()=>{c[g]=k.value,f()}),w.addEventListener("click",()=>{c.splice(g,1),d(),f()}),v.appendChild(k),v.appendChild(w),l.appendChild(v)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=m.value.trim();y&&(c.push(y),m.value="",d(),f())}),_.appendChild(m),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,v],k)=>{let w=document.createElement("div");w.className="json-pair-row";let q=document.createElement("input");q.type="text",q.value=g,q.placeholder="Property";let E=document.createElement("input");E.type="text",E.value=v,E.placeholder="Value";let S=document.createElement("button");S.textContent="\u2715",S.title="Remove",q.addEventListener("change",()=>{let C=q.value.trim();C&&C!==g&&(c[C]=c[g],delete c[g],d(),y())}),E.addEventListener("change",()=>{c[q.value]=E.value,y()}),S.addEventListener("click",()=>{delete c[q.value],d(),y()}),w.appendChild(q),w.appendChild(E),w.appendChild(S),l.appendChild(w)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=m.value.trim();!g||g in c||(c[g]=p.value,m.value="",p.value="",d(),y())}),_.appendChild(m),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){xa(e)}safe_inner_html(e,t){Ea(e,t)}};var Ge=require("obsidian");var qa=class extends Oa{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return Ge.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new Ge.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await Ge.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,Ge.getIcon)(e).outerHTML}is_mod_event(e){return Ge.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function $a(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r($a,"collection_instance_name_from");function ey(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(ey,"create_uid");function ja(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>ja(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>ja(n[o],e[o],t))}return n===e}r(ja,"deep_equal");function Ta(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(Ta,"get_item_display_name");function Na(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let b of Reflect.ownKeys(u)){let j=Object.getOwnPropertyDescriptor(u,b);if(!j)continue;let x={...j};"value"in x&&s(x.value)&&(x.value=d(x.value));try{Object.defineProperty(h,b,x)}catch{h[b]=x.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let b=!1;for(let j of h){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x){let $=x.value;if(c($)){b=!0;continue}if(s($)){if(_($)){b=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return b},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),b=new Map;for(let j of Reflect.ownKeys(u)){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x&&_(x.value)){b.set(j,d(x.value));continue}try{Object.defineProperty(h,j,m(x))}catch{h[j]=x.value}}}return{global_source:h,scoped_sources:b}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),v=Object.create(null),k=r((u,h,b=[])=>{if(!u||!h)return;let j=new Set([...l,...b]);for(let x of Reflect.ownKeys(u)){if(j.has(x))continue;let $=Object.getOwnPropertyDescriptor(u,x);if($)try{Object.defineProperty(h,x,$)}catch{h[x]=$.value}}},"copy_metadata"),w=r(u=>{let h=new u(n),b=h.action||h.run||h.execute||h.call;if(i(b)){let j=b.bind(h);return k(u,j),k(h,j),j.instance=h,j}return k(u,h),h},"instantiate_class"),q=r(u=>{if(o(u))return w(u);if(a(u)){let h=u.action.bind(n);return k(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return k(u,h),h}return s(u)?d(u):u},"bind_or_clone"),E=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),S=r((u,h,b)=>(u[h]=b,b),"cache_result"),C=r((u,h)=>{let b=E();return b&&g(b,h)?S(u,h,q(b[h])):g(f,h)?S(u,h,q(f[h])):S(u,h,void 0)},"compute_and_cache"),O=r(()=>{let u=E(),h=new Set(Reflect.ownKeys(v));for(let b of Reflect.ownKeys(f))h.add(b);if(u)for(let b of Reflect.ownKeys(u))h.add(b);return Array.from(h)},"union_keys"),A=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(v,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:C(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let b=E();return b&&g(b,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return A(u,h);let b=E();if(b&&g(b,h)||g(f,h))return g(u,h)||C(u,h),A(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,b)=>"value"in b?(u[h]=b.value,!0):!1,"defineProperty"),set:r((u,h,b)=>(u[h]=b,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(Na,"create_actions_proxy");var ee=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&We(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return ey(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return We(s,t),!ja(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Na(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),$a(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),$a(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),me(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Ta(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var BS=Object.getPrototypeOf(async function(){}).constructor,te=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof BS?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return We(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Na(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var Pa=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},Ia=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function Ma(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=ty(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=ty(n.results);n.min=s,n.minResult=i}}r(Ma,"results_acc");function ny(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=sy(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=sy(n.results);n.max=s,n.maxResult=i}}r(ny,"furthest_acc");function ty(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(ty,"find_min");function sy(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(sy,"find_max");function Te(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Te,"sort_by_score");function La(n,e){return Te(n,e)}r(La,"sort_by_score_descending");function iy(n,e){return Te(n,e)*-1}r(iy,"sort_by_score_ascending");var za=class extends Pa{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:is(e,a.vec)};return Ma(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(La)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:is(e,a.vec)};return ny(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(iy)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},Da=class extends Ia{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var US="---frontmatter---",oy=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),WS=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),GS=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),HS=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(US),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),JS=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=oy(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=oy(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),mm=r((n,e={})=>{let t=WS(n,e),s=GS(t),i=HS(s);return JS(i,n)},"create_find_connections_filter_opts");async function Qs(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=mm(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+Q(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Te).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(Qs,"find_connections");Qs.action_type="connections";var os=class extends ee{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new Da(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var rs=class extends te{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new za(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let m=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!m[f.item.path]||f.score>m[f.item.path].score?m[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=m[f.item.path].score}),m},Promise.resolve({})),c=Object.values(a).sort(Te).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return ry}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return KS}},ry={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},KS={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function pm(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await Qs.call(this,n);let o=mm(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+Q(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Te).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Te).slice(0,s)}return i}r(pm,"find_connections");pm.action_type="connections";var en=class extends os{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=_m(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=um(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},ay={class:en,actions:{find_connections:pm}};var $i=class extends rs{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let m=await _.search(e);return m?(this.search_results_ct++,{item:_,score:m}):null}catch(m){return console.error(`Error searching item ${_.id||"unknown"}:`,m),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Te)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(VS),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},VS={};var Ra=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=ji;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},ji=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Fa=class extends Ra{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Ti;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Ti=class extends ji{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var cy={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},qt=class extends Fa{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=ut;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},ut=class extends Ti{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,v=new g(this.env,d);v._queue_load=!1,v.loaded_at=Date.now(),f.set(v)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return cy[s]&&(s=cy[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Ni=class extends qt{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=hm},hm=class extends ut{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var Ba=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return Q(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return ly(this.constructor.name)}static get adapter_key(){return ly(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function ly(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(ly,"to_snake");function Ua(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},m={},p=[],f={},y=null,g=null,v=!1,k=!1,w="#",q=!1,E=[],S=null;_[w]=0;for(let O=0;O<i.length;O++){let A=O+t,u=i[O],h=u.trim();if(h==="---"){if(!k&&A===1){k=!0,v=!0,l["#---frontmatter---"]=[A,null];continue}else if(v){v=!1,l["#---frontmatter---"][1]=A;continue}}if(v)continue;if(!q&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(A),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(A)),/^[-*+]\s+\[ \]/.test(u)&&f.incomplete.top.push(A)),h.startsWith("```")){if(q=!q,q&&!S?S=A:!q&&S&&(E.push([S,A]),S=null),!g){let x=c.length>0?c[c.length-1].key:w;if(x===w&&!l[w]&&(l[w]=[A,null]),x===w)g={key:w,start_line:A},(l[w][1]===null||l[w][1]<A)&&(l[w][1]=null);else{_[x]===void 0&&(_[x]=0),_[x]+=1;let $=_[x],T=`${x}#{${$}}`;l[T]=[A,null],g={key:T,start_line:A}}}continue}let b=h.match(/^(#{1,6})\s*(.+)$/);if(b&&!q){let x=b[1].length,$=b[2].trim();for(;c.length>0&&c[c.length-1].level>=x;){let Z=c.pop();l[Z.key][1]===null&&(l[Z.key][1]=A-1)}c.length===0&&l[w]&&l[w][1]===null&&(l[w][1]=A-1),g&&(l[g.key][1]===null&&(l[g.key][1]=A-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null);let T="",N=0;if(c.length>0?(T=c[c.length-1].key,N=c[c.length-1].level):(T="",N=0),c.length===0)d[$]=(d[$]||0)+1,d[$]>1&&($+=`[${d[$]}]`);else{m[T]||(m[T]={}),m[T][$]=(m[T][$]||0)+1;let Z=m[T][$];Z>1&&($+=`#{${Z}}`)}let Y=x-N,H="#".repeat(Y),$e=T+H+$;l[$e]=[A,null],_[$e]=0,c.push({level:x,title:$,key:$e});continue}let j=u.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(j&&!q){if(j[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null),g&&g.key!==w&&(l[g.key][1]===null&&(l[g.key][1]=A-1),g=null);let $=c.length>0?c[c.length-1].key:w;$===w&&!l[w]&&(l[w]=[A,null]),_[$]===void 0&&(_[$]=0),_[$]+=1;let T=_[$],N;if(s){let Y=j[3].replace(/^\[(?: |x|X)\]\s*/,""),H=XS(Y,o);N=`${$}#${H}`}else N=`${$}#{${T}}`;l[N]=[A,null],y={key:N,start_line:A};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null);let x=c.length>0?c[c.length-1].key:w;if(x===w)l[w]||(l[w]=[A,null]),(l[w][1]===null||l[w][1]<A)&&(l[w][1]=null),g={key:w,start_line:A};else{_[x]===void 0&&(_[x]=0),_[x]+=1;let $=_[x],T=`${x}#{${$}}`;l[T]=[A,null],g={key:T,start_line:A}}}}let C=i.length;for(;c.length>0;){let O=c.pop();l[O.key][1]===null&&(l[O.key][1]=C+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=C+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=C+t-1),g=null),l[w]&&l[w][1]===null&&(l[w][1]=C+t-1);for(let O in l)a[O]=l[O];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:E}}r(Ua,"parse_markdown_blocks");function XS(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(XS,"get_longest_words_in_order");var $t=class extends Ba{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=Ua(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let m=this.item.block_collection.get(_.key);s==="replace_blocks"?await m.update(_.content):await m.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],m=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:m,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:m,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let v=this.item.block_collection.get(m);if(await this.create_hash(p)!==v.last_read?.hash){o.push({key:m,state:"changed",content:p});continue}a.push({key:m,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function tn(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),m={title:c,target:l,line:d};_&&(m.embedded=!0),e.push(m)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,m=o(a.index),p={title:l,target:d,line:_};m&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(tn,"get_markdown_links");function Wa({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=tn(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(Wa,"get_bases_cache_links");function fm(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(fm,"parse_value");function YS(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=fm(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let m=_.trim().slice(2);l.push(fm(m)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=fm(c)}return t}r(YS,"parse_yaml_block");function dy(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=YS(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(dy,"parse_frontmatter");var _y=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Pi=class extends $t{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=tn(e),s=Wa({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=dy(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),_y(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var jt=require("obsidian");function ZS(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(ZS,"merge_tags");var as=class extends Pi{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=ZS(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!jt.MarkdownRenderer||!jt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await jt.MarkdownRenderer.render(s,t,i,this.item.path,new jt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(m=>setTimeout(m,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,jt.htmlToMarkdown)(i)}};var Ga=class extends $t{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var Ha=class extends $t{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){}};var Ja=class extends as{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function uy(n,e){let[t,...s]=n.split("#").filter(Boolean),i=Ta(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(uy,"get_block_display_name");var sn=class extends os{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return uy(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},my={class:sn,actions:{find_connections:Qs}};var Ii=class extends rs{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var Ka=class extends qt{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=gm;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},gm=class extends ut{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var Va=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return Q(e)}};function Xa(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(Xa,"get_line_range");var nn=class extends Va{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return Xa(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var on=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Mi=class extends on{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var rn=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var cs=class extends rn{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var He=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var an=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},cn=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var ln=class extends an{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new ym(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},ym=class extends cn{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var ls=class extends an{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new bm(i)}},bm=class extends cn{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var gy=P(fy(),1);var rC=Object.defineProperty,aC=r((n,e,t)=>e in n?rC(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),cC=r((n,e,t)=>(aC(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function lC(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(lC,"bytePairMerge");function dC(n,e){return n.length===1?[e.get(n.join(","))]:lC(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(dC,"bytePairEncode");function _C(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(_C,"escapeRegex");var km=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=gy.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=km.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=km.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let m=d?.index??n.length;for(let f of n.substring(l,m).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...dC(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},Za=km;cC(Za,"specialTokenRegex",n=>new RegExp(n.map(e=>_C(e)).join("|"),"g"));async function by(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await yy(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await yy(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(by,"fetch_json_cached");async function yy(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(yy,"do_fetch");function xm(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(xm):e==="object"?Object.values(n).every(xm):!1}r(xm,"is_json_compatible");function Qa(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||xm(i)&&(t[s]=i);return t}r(Qa,"extract_json_details");function Li(n){return Object.keys(n).length===0}r(Li,"is_empty_object");function uC(n,e){return Li(n)?e:Li(e)?n:{...n,...e}}r(uC,"merge_details");function wm(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(wm,"get_message_from_object");function K(n,e=null){if(Array.isArray(n)&&n.length>0)return K(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Qa(n,["message"]);return{message:t,details:Li(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=wm(o),c=Qa(o,["message"]),l=Qa(t,["message","error"]),d=uC(l,c);return{message:a||wm(t)||"Unknown error",details:Li(d)?null:d,http_status:e}}return K(i)}let s=wm(t);if(s){let i=Qa(t,["message"]);return{message:s,details:Li(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(K,"normalize_error");var mC="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",Ke=class extends cs{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Ne}get res_adapter(){return Pe}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new He({adapter:ls})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:K(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await by(mC,"cl100k_base.json");this.tiktoken=new Za(e)}},Ne=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Pe=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var ec=class extends Ke{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Em}get res_adapter(){return Am}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Em=class extends Ne{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Am=class extends Pe{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var tc=class extends cs{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var sc=class extends tc{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var vy=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var ky={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:Sm};var Sm={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},wy={},Cm={};var dn=class extends sc{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=ky;constructor(e){super(e),this.connector=vy.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...wy}}get_models(){return Promise.resolve(this.models)}get models(){return Sm}};var nc=class extends Ke{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Om}get res_adapter(){return qm}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of hC(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Om=class extends Ne{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},qm=class extends Pe{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},pC=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),hC=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(pC)},"filter_embedding_models");var ic=class extends Ke{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return $m}get res_adapter(){return jm}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},$m=class extends Ne{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},jm=class extends Pe{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function fC(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(fC,"parse_lm_studio_models");var oc=class extends Ke{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Tm}get res_adapter(){return Nm}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return fC(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},Tm=class extends Ne{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Nm=class extends Pe{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var zi=class extends on{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw K(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var rc=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#e(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#r.bind(this)),this.xhr.addEventListener("error",this.#t.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#e(this.CLOSED))}#e(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#t(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#t(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#e(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#r(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#e(this.CLOSED)}};var ac=class extends rn{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var _n={},Tt={data:null,fetched_at:0},z=class extends ac{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return D}get res_adapter(){return I}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new He({adapter:ls})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Tt.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=K(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new rc(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=K({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=K(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=K(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Tt?.data&&t-Tt?.fetched_at<e)return Tt.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Tt.data=o,Tt.fetched_at=t,console.log({MODELS_DEV_CACHE:Tt}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Tt.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return _n[this.constructor.key]||(_n[this.constructor.key]={}),_n[this.constructor.key]}set model_data(e){_n[this.constructor.key]||(_n[this.constructor.key]={}),_n[this.constructor.key]=e}},D=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},I=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:K(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Di=class extends z{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Ri}res_adapter=Fi;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Ri=class extends D{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Fi=class extends I{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:K(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var gC=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],_s=class extends z{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Pm;parse_model_data(e){return e.data.filter(t=>!gC.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:yC(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function yC(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(yC,"get_max_input_tokens");var Pm=class extends I{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Bi=class extends _s{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var un=class extends z{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Ui;res_adapter=Wi;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Ui=class extends D{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Wi=class extends I{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:K(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},Gi=class extends un{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var Hi=class extends z{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Im}get res_adapter(){return Mm}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Im=class extends D{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Mm=class extends I{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Ji=class extends z{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Ki}get res_adapter(){return Vi}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Ki=class extends D{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},Vi=class extends I{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var Xi=class extends z{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=Yi;res_adapter=Zi;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},Yi=class extends D{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},Zi=class extends I{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:K(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Lm={openai:{req:D,res:I},anthropic:{req:Ri,res:Fi},gemini:{req:Ui,res:Wi},lm_studio:{req:Ki,res:Vi},ollama:{req:Yi,res:Zi}},Qi=class extends z{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Lm[e];return t&&t.req?t.req:D}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Lm[e];return t&&t.res?t.res:I}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(Lm).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var eo=class extends z{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return zm}get res_adapter(){return Dm}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},zm=class extends D{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Dm=class extends I{static{r(this,"SmartChatModelGroqResponseAdapter")}};var to=class extends z{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return D}get res_adapter(){return I}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var so=class extends z{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Rm}get res_adapter(){return Fm}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Rm=class extends D{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Fm=class extends I{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var lp=require("obsidian");function xy(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=Ua(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),m=Xa(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===m.length&&_.vec)continue;let p=tn(m),f=Wa({source:n,links:p}),y={key:d,lines:l,size:m.length,outlinks:[...p,...f],last_read:{at:a,hash:Q(m)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new n.block_collection.item_type(n.env,y);n.block_collection.set(g)}else _.data={..._.data,...y}}bC(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(xy,"parse_blocks");function bC(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(bC,"clean_and_update_source_blocks");function Bm(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():Ey(a)?n[o]=Bm(Ey(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(Bm,"ajson_merge");function Ey(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(Ey,"is_object");var Ay={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function vC(n){let e=!1,[t,...s]=n.split(":");return Ay[t]&&(t=Ay[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(vC,"_parse_ajson_key");var Nt=class extends qt{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:v}=vC(p),k=`${y}:${g}`;f?(i[k]=f,(v||k!==p)&&(delete i[p],t=!0)):(delete i[k],(v||k!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=Bm(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Um=class extends ut{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},no={collection:Nt,item:Um};var io=class extends ee{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function kC(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(kC,"parse_component_properties");async function wC(n,e){let{scope_key:t,component_key:s}=kC(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await Q(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(wC,"build_component_data");var cc=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await wC(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var lc=class extends cc{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function Sy(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&Sy(i,o,t)}}),t}r(Sy,"flatten_components_config");var dc=class extends te{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=Sy(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},Cy={class:dc,item_type:io,data_adapter:no,component_adapters:{SmartViewComponentAdapter:lc}};var Oy=Cy;function qy(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(qy,"filter_redundant_context_items");var oo=class extends ee{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e){!e||!this.data?.context_items?.[e]||(this.data.context_items[e].folder?this.data.context_items[e].exclude=!0:delete this.data.context_items[e],this.queue_save(),this.emit_event("context:updated",{removed_key:e}))}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this.on_event("context:updated",()=>{this._context_items=null})}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return qy(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var _c=class extends te{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var xC={class:_c,data_adapter:Nt,item_type:oo};var $y=xC;var uc=class extends ee{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var Ve=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var mc=class extends Ve{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var pc=class extends Ve{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var jy=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var hc=class extends Ve{static{r(this,"ImageContextItemAdapter")}static detect(e){return jy.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var fc=class extends Ve{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var Wm=class extends te{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},Ty={version:1,class:Wm,collection_key:"context_items",item_type:uc,context_item_adapters:{BlockContextItemAdapter:mc,SourceContextItemAdapter:pc,ImageContextItemAdapter:hc,PdfContextItemAdapter:fc}};function Ny(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(Ny,"next_log_stats");var mn=class extends ee{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var EC={"collection:save_started":!0,"collection:save_completed":!0},Gm=class extends te{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return mn}init(){this.env?.events||ns.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!EC[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new mn(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=Ny({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},Py={class:Gm,collection_key:"event_logs",data_adapter:Nt,item_type:mn};var us=require("obsidian");var pn=class extends us.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available"}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&this.selectActiveSuggestion(t);let s=this.inputEl.selectionStart===this.inputEl.value.length;if(t.target!==this.inputEl||!this.inputEl.value||s||us.Keymap.isModEvent(t)){if(t.key==="ArrowLeft"){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&(s||t.target!==this.inputEl||!this.inputEl.value)){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return this.default_suggest_action_keys.map(e=>{let t=this.env.config.actions[e];if(!t)return null;let s=t.display_name||e;return{select_action:r(()=>{this.update_suggestions(e)},"select_action"),key:e,display:s}}).filter(Boolean)}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e))}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,us.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=us.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let l=this.inputEl.value.length;this.inputEl.setSelectionRange(l,l)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):c&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var sB=require("obsidian");var gc=class extends pn{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var Iy=require("obsidian");var yc=class extends Iy.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var vc=require("obsidian");var AC="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",bc=class extends vc.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){SC(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function SC(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),CC(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(AC,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r(SC,"render_milestones_modal_title");function CC(n){OC(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(CC,"render_help_icon");function OC(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,vc.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(OC,"set_icon_with_fallback");var My={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var ro=class extends ee{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],m=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),m},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var kc=class extends te{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function Ly(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(Ly,"settings_config");var ms=class extends ro{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Hm=class extends kc{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var qC={class:Hm,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:no,item_type:ms,providers:{},settings_config:Ly},Jm=qC;var Km=class extends dn{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},zy={class:Km,settings_config:Cm};Jm.providers={transformers:zy};var Dy=Jm;var Pt=class extends ee{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(Ma(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(La);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var Ry={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},Vm=class extends te{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=$C(new Date),i=Q(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new Pt(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...Ry}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function $C(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r($C,"format_ymd");var Fy={class:Vm,collection_key:"lookup_lists",item_type:Pt,settings_config:Ry};function ao(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(ao,"format_collection_name");async function jC(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${ao(n.collection_key)}</h2>
${t}
</div></div></div>`}r(jC,"build_html");async function By(n,e={}){let t=await jC.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(By,"render");var hn=require("obsidian");function Uy(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(hn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new hn.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let m=d.hoverEl.querySelector(".markdown-preview-sizer");hn.MarkdownRenderer.render(o,l,m,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(Uy,"register_block_hover_popover");var Wy=require("obsidian");function Gy(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),Wy.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):Uy(n.parentElement,n,e.env,e.key)}r(Gy,"register_item_hover_popover");var Jy=require("obsidian");function TC(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(TC,"format_score");function NC(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(NC,"format_size");function Hy(n,e){return n?`<span class="${e}">${n}</span>`:""}r(Hy,"build_badge_html");function PC(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=TC(n?.data?.score),i=NC(n?.size||n?.data?.size),o=Hy(s,"sc-context-item-score"),a=Hy(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(PC,"build_html");async function Ky(n,e={}){let t=PC(n,e),i=this.create_doc_fragment(t).firstElementChild;return IC.call(this,n,i,e),i}r(Ky,"render");async function IC(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${Jy.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),Gy(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(IC,"post_process");async function MC(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${ao(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=zC(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(MC,"build_html");async function Vy(n,e={}){let t=await MC.call(this,n,e),s=this.create_doc_fragment(t);return await LC.call(this,n,s,e)}r(Vy,"render");async function LC(n,e,t={}){return e}r(LC,"post_process");function zC(n,e){let t=Object.values(n.items).length,s=ao(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=DC(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=RC(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(zC,"generate_collection_stats");function DC(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(DC,"get_generic_collection_stats");function RC(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(RC,"calculate_embed_coverage");var Xy=require("obsidian");function FC(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(FC,"build_html");async function Xm(n,e={}){let t=FC.call(this,n,e),s=this.create_doc_fragment(t);return await BC.call(this,n,s,e)}r(Xm,"render");async function BC(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new Xy.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=be(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(m=>{_.addOption(m.value,m.label)}),l.childNodes.forEach(m=>{m.value===c&&(m.selected=!0),o.find(p=>p.value===m.value)?.disabled&&(m.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):ve(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(BC,"post_process");Xm.version=.2;var Yy=require("obsidian");function UC(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(UC,"build_html");function Zy(n,e={}){let t=UC.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,Yy.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),WC.call(this,n,i,e),i}r(Zy,"render");function WC(n,e){}r(WC,"post_process");var Qy=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var ob=require("obsidian");var eb=require("obsidian");var HC={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}};function tb(n){n.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in co){let s=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",o=document.createElement("p");o.textContent=i,s.appendChild(o);let a=document.createElement("p");a.textContent=`\u2705 ${co[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",s.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{n.open_milestones_modal()}),s.appendChild(c),new eb.Notice(s,7e3)}})}r(tb,"register_first_of_event_notifications");function wc(n,e){let t=KC(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(wc,"check_if_event_emitted");var co={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},JC=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function sb(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=JC.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(sb,"derive_events_checklist_groups");function KC(n,e){let t=HC[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!VC(a)))return!0}return!1}r(KC,"resolve_plugin_install_event");function VC(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r(VC,"is_pro_manifest");function XC(n,e={}){let t=sb(co),s=t.reduce((c,l)=>{let d=l.items.reduce((_,m)=>_+(wc(n,m.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((m,p)=>m+(wc(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(m=>{let p=wc(n,m.event_key)===!0;return ZC(m,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${je(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${je(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${je(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(XC,"build_html");async function rb(n,e={}){this.apply_style_sheet(Qy);let t=XC.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return YC.call(this,n,i,e),i}r(rb,"render");async function YC(n,e,t={}){return QC(e),e2(e),e}r(YC,"post_process");function ZC(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${je(n.event_key)}"
data-link="${je(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${je(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${je(n.milestone)}</span>
</div>
</li>
`}r(ZC,"build_item_html");function QC(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=ib(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||nb(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=ib(n,e);s&&(e.preventDefault(),nb(s))}))}r(QC,"attach_item_link_listeners");function nb(n){let e=n2(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(nb,"open_item_link");function e2(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&t2(i,s)})}r(e2,"render_item_state_icons");function t2(n,e){s2(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(t2,"set_item_icon");function s2(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,ob.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(s2,"set_icon_with_fallback");function ib(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(ib,"get_item_el_from_event");function n2(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=co[t];return!s||typeof s.link!="string"?"":s.link}r(n2,"get_item_link");function i2(){return`<div>
<button class="copy-all-notifications-btn">Copy All Notifications</button>
<div class="smart-env-notifications-feed"></div>
</div>`}r(i2,"build_html");async function ab(n,e={}){let t=this.create_doc_fragment(i2()),s=t.firstElementChild;return o2.call(this,n,s,e),t}r(ab,"render");async function o2(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed");this.empty(s);let i=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!i.length){let a=s.ownerDocument.createElement("p");a.className="smart-env-notifications-empty",a.textContent="No Smart Env notifications yet.",s.appendChild(a);return}i.slice(-100).reverse().forEach(a=>{a2(s,a)});let o=e.querySelector(".copy-all-notifications-btn");o.addEventListener("click",()=>{let a=s.textContent;navigator.clipboard.writeText(a).then(()=>{o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy All Notifications"},2e3)})})}r(o2,"post_process");function r2(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(r2,"get_level");function a2(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=r2(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${c2(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(a2,"append_entry");function c2(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(c2,"to_time_ago");var mt=require("obsidian");var lo=require("obsidian");function _o(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(_o,"get_smart_server_url");function l2(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(l2,"try_get_zlib");function d2(n){let e=l2();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(d2,"inflate_deflate_data");async function cb(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let v=new Uint8Array(n.slice(t,t+y)),k=new TextDecoder("utf-8").decode(v);t+=y,t+=g;let w=(l&8)!==0,q=t,E;if(!w)E=q+p;else{let O=q,A=!1;for(;O+4<=s;){let u=e.getUint32(O,!0);if(u===134695760||u===67324752||u===33639248){A=!0;break}O++}E=A?O:s}if(E>s)break;let S=new Uint8Array(n.slice(q,E));if(t=E,w&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let C;if(d===0)C=S;else if(d===8)C=d2(S);else continue;if(i.push({fileName:k,data:C}),k.toLowerCase().endsWith("manifest.json")&&!k.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(C))}catch{}}return{files:i,pluginManifest:o}}r(cb,"parse_zip_into_files");function lb(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(lb,"validate_zip_buffer");async function db(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(db,"write_files_with_adapter");function _b(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(_b,"is_server_version_newer");async function ub(n,e){let t=await(0,lo.requestUrl)({url:`${_o()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return lb(t.arrayBuffer,"Smart Plugins server")}r(ub,"fetch_plugin_zip");async function mb(n,e=lo.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return lb(t.arrayBuffer,"Download")}r(mb,"fetch_zip_from_url");async function pb(n,e,t=lo.requestUrl){let s=await t({url:`${_o()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(pb,"fetch_plugin_readme");async function hb(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(hb,"enable_plugin");function fb(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(fb,"get_oauth_storage_prefix");async function gb(n){let e=await(0,lo.requestUrl)({url:`${_o()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(gb,"fetch_server_plugin_list");var yb=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var u2='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',m2='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function p2(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(p2,"derive_fallback_plugins");function h2(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${u2}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${m2}</p>
</div>
</div>
`}r(h2,"build_html");async function bb(n,e={}){this.apply_style_sheet(yb);let t=h2.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await f2.call(this,n,i,e),i}r(bb,"render");async function f2(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=fb(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".pro-plugins-list"),l=p2(),d=0,_="",m=null,p=r(E=>{if(!a||!E)return;(!m||!m.isConnected)&&(m=document.createElement("div"),m.classList.add("smart-plugins-login-manual"),a.appendChild(m)),m.innerHTML="";let S=document.createElement("div");S.classList.add("smart-plugins-login-manual-instructions"),S.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",m.appendChild(S);let C=document.createElement("div");C.classList.add("smart-plugins-login-manual-controls"),m.appendChild(C);let O=document.createElement("input");O.classList.add("smart-plugins-login-manual-input"),O.type="text",O.value=E,O.readOnly=!0,O.addEventListener("focus",()=>O.select()),C.appendChild(O);let A=document.createElement("button");A.classList.add("mod-cta"),A.textContent="Copy",A.addEventListener("click",async()=>{await y2(E)?new mt.Notice("Copied login link to clipboard."):new mt.Notice("Copy failed. Please select and copy the link manually.")}),C.appendChild(A)},"render_manual_login_link"),f=r(async()=>{let E={},{manifests:S}=i.plugins;for(;Object.keys(S).length===0;)S=i.plugins.manifests,await new Promise(C=>setTimeout(C,100));for(let C in S){if(!Object.prototype.hasOwnProperty.call(S,C))continue;let{name:O,version:A}=S[C];E[C]={name:O,version:A}}return E},"get_installed_info"),y=r(async()=>{d++,d>=2&&_&&p(_),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(_=g2()),new mt.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),g=r(()=>{if(this.empty(a),m=null,!(localStorage.getItem(o+"token")||"")){new mt.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(O=>{O.setButtonText("Login"),O.onClick(async()=>{await y()})});return}let S=new mt.Setting(a);S.setDesc("Signed in to Smart Plugins Pro account."),S.addButton(C=>{C.setButtonText("Logout"),C.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new mt.Notice("Logged out of Smart Plugins"),g(),w()})})},"render_oauth_login_section"),v=r(async()=>{if(this.empty(c),!(!c||l.length===0))for(let E of l){let S=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,installed_map:{}});c.appendChild(S)}},"render_fallback_plugin_list"),k=r(()=>{let E=new mt.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");E.addButton(S=>{S.setButtonText("Get Pro"),S.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),E.addButton(S=>{S.setButtonText("Update subscription"),S.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),E.addButton(S=>{S.setButtonText("Refresh"),S.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),w=r(async()=>{this.empty(c);let E=localStorage.getItem(o+"token")||"";if(!E){await v();return}try{let S=await f(),C=await gb(E),{list:O=[],unauthorized:A=[],sub_exp:u}=C;if(typeof u=="number"&&u<Date.now()){k(),await v();return}if(!Array.isArray(O)||O.length===0){await v();return}for(let h of O){let b=await n.smart_components.render_component("pro_plugins_list_item",h,{env:n,app:i,token:E,installed_map:S,on_installed:w});c.appendChild(b)}}catch(S){console.error("[pro-plugins:list] Failed to fetch plugin list:",S),c.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),q=r(async()=>{g(),await w()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{q()}),await q(),e}r(f2,"post_process");function g2(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${_o()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(g2,"initiate_smart_plugins_oauth");var y2=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var le=require("obsidian");var b2="https://smartconnections.app/pro-plugins/";function v2(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(v2,"build_html");function k2(n){return!n||!n.repo}r(k2,"is_fallback_item");function w2(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,_b(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(w2,"compute_display_state");async function vb(n,e={}){let t=v2(n,e),i=this.create_doc_fragment(t).firstElementChild;return await x2.call(this,n,i,e),i}r(vb,"render");async function x2(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(k2(n)){let m=new le.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",m.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),m.controlEl.appendChild(p)}return m.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(b2,"_external")})}),m.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=w2(n,l),_=new le.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(m=>{m.setButtonText(d.button_label),m.setDisabled(d.is_disabled),m.onClick(()=>A2(n,{app:s,token:i,on_installed:a}))}),_.addButton(m=>{m.setButtonText("Docs"),n.docs_url?m.onClick(()=>window.open(n.docs_url,"_external")):m.onClick(()=>S2(n,{app:s,token:i,display_name:d.display_name}))}),e}r(x2,"post_process");var E2=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return mb(t);if(!e)throw new Error("Login required to install this plugin.");return ub(n.repo,e)},"download_plugin_zip"),A2=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new le.Notice(`Installing "${n.repo}" ...`);let o=await E2(n,s),{files:a,pluginManifest:c}=await cb(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await db(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await hb(t,_),new le.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new le.Notice(`Install failed: ${o.message}`)}},"install_plugin"),S2=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await pb(n.repo,s),a=new le.Modal(t);a.setTitle(i||n.name||n.repo),await le.MarkdownRenderer.render(t,o,a.contentEl,"",new le.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new le.Notice("Failed to load README")}},"show_plugin_readme");var kb=require("obsidian");var ps=class extends kb.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var wb=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var xb=require("obsidian");function O2(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${Ab(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(O2,"build_html");async function Eb(n,e){this.apply_style_sheet(wb);let s=this.create_doc_fragment(O2.call(this,n,e)).firstElementChild;return q2.call(this,n,s,e),s}r(Eb,"render");async function q2(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,xb.setIcon)(o,Ab(n)),s.addEventListener("click",()=>{new ps(n).open()}),i.addEventListener("click",()=>{new ps(n,{test_on_open:!0}).open()}),e}r(q2,"post_process");function Ab(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(Ab,"get_test_result_icon_name");var Cb=require("obsidian");var Sb={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function xc(n,e,t={}){let s=(Sb[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new Cb.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new ps(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(xc,"show_new_model_menu");var gn=require("obsidian");var Ec=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new gn.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function hs(n,e,t,s={}){let{default_group_name:i="Settings"}=s;n=qb(n,e);let o=Object.entries(n||{}).reduce((c,[l,d])=>{let _=d.group||i;return c[_]||(c[_]={}),c[_][l]=d,c},{[i]:{}});return Object.entries(o).sort(([c],[l])=>c===i?-1:l===i?1:0).filter(([,c])=>Object.keys(c).length>0).map(([c,l])=>{let d=t.createDiv(),_={...s,...s.group_params?.[c]||{}};return $2(c,e,l,d,_)})}r(hs,"render_settings_config");function $2(n,e,t,s,i={}){let o;try{let l=require("obsidian");l.SettingGroup?o=l.SettingGroup:o=Ec}catch{o=Ec}t=qb(t,e);let{heading_btn:a=null}=i,c=new o(s);if(a&&typeof a=="object")if(Array.isArray(a))for(let l of a)Ob(c,e,l);else Ob(c,e,a);c.setHeading(n);for(let[l,d]of Object.entries(t)){if(!d||typeof d!="object"){console.warn(`Invalid setting config for ${l}:`,d);continue}let _=d.scope_class==="pro-setting",m=!!e.env?.is_pro;c.addSetting(p=>{switch(d.name&&p.setName(d.name),p.setClass(l.replace(/[^a-zA-Z0-9]/g,"-")),d.type&&p.setClass(`setting-type-${d.type}`),d.description&&p.setDesc(d.description),d.type){case"button":p.addButton(f=>{f.setButtonText(d.name||"Run"),f.onClick(async y=>{typeof d.callback=="function"&&await fn(p,y,d.callback,{scope:e})})});break;case"toggle":p.addToggle(f=>{f.setValue(be(e.settings,l)||!1),f.onChange(y=>{ve(e.settings,l,y),typeof d.callback=="function"&&fn(p,y,d.callback,{scope:e})})});break;case"text":p.addText(f=>{f.setValue(String(be(e.settings,l)||"")),f.onChange(y=>{ve(e.settings,l,y)})});break;case"number":p.addText(f=>{f.setValue(String(be(e.settings,l)||"")),f.inputEl.setAttribute("type","number"),f.onChange(y=>{let g=Number(y);isNaN(g)||ve(e.settings,l,g),typeof d.callback=="function"&&fn(p,g,d.callback,{scope:e})})});break;case"dropdown":p.addDropdown(f=>{let y=d.options_callback;typeof y=="function"&&y.call(e,e).forEach(v=>{let k=v.label||v.name||v.value;f.addOption(v.value,k)}),f.setValue(be(e.settings,l)||""),f.onChange(g=>{ve(e.settings,l,g),typeof d.callback=="function"&&fn(p,g,d.callback,{scope:e})})});break;case"textarea":p.addTextArea(f=>{f.setValue(String(be(e.settings,l)||"")),f.onChange(y=>{if(_&&!m){new gn.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}ve(e.settings,l,y)}),_&&!m&&f.setDisabled(!0)});break;case"slider":p.addSlider(f=>{let y=d.min||0,g=d.max||100,v=d.step||1;f.setLimits(y,g,v),f.setValue(be(e.settings,l)||y),f.setDynamicTooltip(),f.onChange(k=>{ve(e.settings,l,k),typeof d.callback=="function"&&fn(p,k,d.callback,{scope:e})})});break;case"heading":p.setHeading();break;case"html":d.value&&p.descEl.replaceChildren(document.createRange().createContextualFragment(d.value));break;default:console.warn(`Unsupported setting type for ${l}:`,d.type);break}d.scope_class&&p.settingEl.addClass(d.scope_class)})}return c}r($2,"render_settings_group");function Ob(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,gn.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await fn(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(Ob,"render_heading_button");async function fn(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(fn,"handle_config_callback");function qb(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(qb,"ensure_settings_config");function j2(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(j2,"build_html");async function $b(n,e){let s=this.create_doc_fragment(j2.call(this,n,e)).firstElementChild;return T2.call(this,n,s,e),s}r($b,"render");async function T2(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=hs(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{xc(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(T2,"post_process");function N2(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(N2,"build_html");async function jb(n,e){let s=this.create_doc_fragment(N2(n,e)).firstElementChild;return P2.call(this,n,s,e),s}r(jb,"render");async function P2(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(P2,"post_process");var Pb=require("obsidian");function Ac(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(Ac,"ensure_smart_sources_settings");function uo(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(uo,"parse_exclusions_csv");function Tb(n,e){let t=(e??"").trim();if(!t)return n||"";let s=uo(n);return s.includes(t)||s.push(t),s.join(",")}r(Tb,"add_exclusion");function Nb(n,e){let t=(e??"").trim();return t?uo(n).filter(i=>i!==t).join(","):n?.trim()||""}r(Nb,"remove_exclusion");var Sc=class extends Pb.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Ac(this.env),t=uo(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Ac(this.env);t.folder_exclusions=Tb(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Ac(this.env),t=uo(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=Nb(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var Ib=require("obsidian");var Cc=class extends Ib.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function I2(n,e={}){return`
<div class="sources-settings">
</div>
`}r(I2,"build_html");async function Mb(n,e={}){let t=await I2.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return M2.call(this,n,i,e),i}r(Mb,"render");async function M2(n,e,t={}){hs({folder_exclusions:z2,view_exclusions:D2,re_import_sources:R2},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",L2(n,e))),this.attach_disposer(e,i),e}r(M2,"post_process");function L2(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(L2,"highlight_reset_data");var z2={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new Sc(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},D2={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new Cc(t.main.app,t).open()},"callback")},R2={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let m=Date.now();t.events?.emit("sources:reimported",{time_ms:m-_}),t.main.notices?.show("reload_sources",{time_ms:m-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};function F2(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(F2,"build_html");async function Lb(n,e={}){let s=this.create_doc_fragment(F2(n,e)).firstElementChild;return B2.call(this,n,s,e),s}r(Lb,"render");async function B2(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),xc(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(B2,"post_process");async function U2(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(U2,"build_html");async function zb(n,e={}){let t=await U2.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return W2.call(this,n,i,e),i}r(zb,"render");async function W2(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(W2,"post_process");var Db=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function H2(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(H2,"build_html");async function Rb(n,e={}){this.apply_style_sheet(Db);let t=await H2.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return J2.call(this,n,i,e),i}r(Rb,"render");async function J2(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return Ym.call(this,"settings_env_sources",n,i),Ym.call(this,"settings_env_models",n,s),Ym.call(this,"settings_notifications",n,o),e}r(J2,"post_process");function Ym(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(Ym,"render_if_available");var Fb=require("obsidian");function K2(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(K2,"build_html");async function Bb(n,e={}){let t=K2(),i=this.create_doc_fragment(t).firstElementChild;return V2.call(this,n,i,e),i}r(Bb,"render");async function V2(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),Zm(n,a),Qm(n,a),ep(n,a),tp(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(V2,"post_process");function Zm(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(Zm,"render_btn_open_selector");function Qm(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(Qm,"render_btn_copy_context");function ep(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(ep,"render_btn_clear_context");function tp(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,Fb.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(tp,"render_btn_help");var Ub=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var mo=require("obsidian");async function yn(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(mo.Platform.isMobile)new mo.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new mo.Notice("Failed to copy.")}}r(yn,"copy_to_clipboard");function Y2(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(Y2,"build_html");async function Wb(n,e={}){let t=Y2(n,e);this.apply_style_sheet(Ub);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return Z2.call(this,n,i,e),i}r(Wb,"render");async function Z2(n,e,t={}){let s=[],i=r(async()=>{let l=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(m=>{this.empty(l),l.appendChild(m)});let d=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(m=>{this.empty(d),d.appendChild(m)});let _=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(m=>{this.empty(_),_.appendChild(m)})},"render_children"),o=n.env.plugin,a=o?.app||window.app;return(o?.registerDomEvent?.bind(o)||((l,d,_)=>l.addEventListener(d,_)))(e,"contextmenu",l=>{if(l.preventDefault(),l.stopPropagation(),!a)return;let d=new Menu(a);d.addItem(_=>_.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let m=Q2(e);await yn(m)})),d.showAtMouseEvent(l)}),await i(),s.push(n.on_event("context:updated",i)),this.attach_disposer(e,s),e}r(Z2,"post_process");function Q2(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(Q2,"tree_dom_to_wikilinks");function eO(n){return Math.ceil((n||0)/4)}r(eO,"estimate_tokens");function tO(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(tO,"build_html");async function Gb(n,e={}){let t=tO(),i=this.create_doc_fragment(t).firstElementChild;return sO.call(this,n,i,e),i}r(Gb,"render");async function sO(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=eO(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(sO,"post_process");function Hb(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-tree-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let m=["sc-tree-label"];return n.exists===!1&&m.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${a?l:""}
<span class="${m.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(Hb,"build_tree_item");function Jb(n){let e=nO(n),t=new Set(n.map(i=>i.key||i.path));return Kb(e,t)}r(Jb,"build_tree_html");function nO(n=[]){let e=r(o=>{let a=/#\{\d+\}$/u,c=o,l=null,d=null,_=!1,m=c.match(a);m&&(l=m[0],c=c.slice(0,-l.length),_=!0);let p=c.indexOf("##");p!==-1&&(d=c.slice(p),c=c.slice(0,p),_=!0);let f=[];if(c){let y="",g=!1;for(let v=0;v<c.length;v++)!g&&c.slice(v,v+2)==="[["?(g=!0,y+="[[",v++):g&&c.slice(v,v+2)==="]]"?(g=!1,y+="]]",v++):!g&&c[v]==="/"?(f.push(y),y=""):y+=c[v];y&&f.push(y)}return d&&f.push(d),l&&f.push(l),{segments:f,has_block:_}},"split_path_segments"),t={name:"",children:{},selected:!1},s=r((o,a)=>a.some(c=>o.startsWith(`${c}/`)),"is_redundant"),i=n.filter(o=>!(o.key.includes("#")?o.key.split("#")[0]:o.key).match(/\.[a-zA-Z0-9]+$/u)).map(o=>o.key);for(let{key:o,exists:a}of n){if(s(o,i.filter(m=>m!==o)))continue;let{segments:c,has_block:l}=e(o),d=t,_="";c.forEach((m,p)=>{if(_=_?`${_}/${m}`:m,m.startsWith("external:.."))return;let f=p===c.length-1,y=f&&l;d.children[m]||(d.children[m]={name:m,path:y?o:_,children:y?[]:{},selected:!1,is_file:y||f&&m.includes(".")}),d=d.children[m],f&&(d.selected=!0,d.exists=a)})}return t}r(nO,"build_path_tree");function Kb(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>Hb(s,e,Kb(s,e))).join("")}</ul>`}r(Kb,"tree_to_html");var Vb=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;function oO(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(oO,"build_html");async function Xb(n,e={}){this.apply_style_sheet(Vb);let t=oO(n,e),i=this.create_doc_fragment(t).firstElementChild;return rO.call(this,n,i,e),i}r(Xb,"render");async function rO(n,e,t={}){let s=r(()=>{let o=n.env,a=n.context_items.filter(t.filter),c=Jb(a),l=this.create_doc_fragment(c);this.empty(e),e.appendChild(l);for(let d=0;d<a.length;d++){let _=a[d],m=e.querySelector(`.sc-tree-item[data-path="${_.key}"]`);if(!m){console.warn(`Smart Context: Could not find tree item for path: ${_.key}`);continue}o.smart_components.render_component("context_item_leaf",_).then(p=>{this.empty(m),m.appendChild(p)})}},"render_tree_leaves");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(rO,"post_process");var Yb=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function cO(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(cO,"build_html");async function Zb(n,e={}){let t=cO(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(Yb),await lO.call(this,n,s,e),s}r(Zb,"render");async function lO(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let m=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of m){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',v=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',k="",w="";try{let E=await p.read();k=E.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),w=(await p.get_embed_input(E)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(E){console.error("[source_inspector] Error reading block:",E),k='<em style="color:red;">Error reading block content</em>'}let q=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${v}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${w}</pre>
</details>
<blockquote>${k}</blockquote>
<hr>
`);s.appendChild(q)}return e}r(lO,"post_process");var nv=require("obsidian");var bn=require("obsidian");var Qb=require("obsidian");var Oc=class extends Qb.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var ev=require("obsidian");var qc=class extends ev.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function tv(n,e,t={}){let{Menu:s=bn.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new bn.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new bn.Notice("Active note is not indexed by Smart Environment");return}new Oc(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new qc(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new bn.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(tv,"register_status_bar_context_menu");var sv=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function _O(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(_O,"build_html");async function iv(n,e={}){this.apply_style_sheet(sv);let s=this.create_doc_fragment(_O()).firstElementChild;return uO.call(this,n,s,e),s}r(iv,"render");function uO(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",v=c(),k=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",k="attention"),s&&(0,nv.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=w=>{w.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),v>0?i.dataset.count=String(v):delete i.dataset.count,k?i.dataset.level=String(k):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=w=>{if(l()>0)w.preventDefault(),w.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let E=new MouseEvent("contextmenu",w);e.dispatchEvent?.(E)}},e.addEventListener("click",e._click_handler))},"render_status_elm");tv(n,e),d();let _=null,m=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",m)),this.attach_disposer(e,p)}r(uO,"post_process");var ov=require("obsidian");function mO(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(mO,"build_html");function rv(n,e={}){let t=mO.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return pO.call(this,n,i,e),i}r(rv,"render");async function pO(n,e){let t=e.querySelector(".callout-icon"),s=(0,ov.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(pO,"post_process");var av=require("obsidian");function hO(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(hO,"build_html");function cv(n,e={}){let t=hO.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,av.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),fO.call(this,n,i,e),i}r(cv,"render");function fO(n,e){}r(fO,"post_process");var sp=require("obsidian");async function lv(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new sp.Notice("No context items to copy.");let t=await this.get_text(n);await yn(t);let s=gO({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new sp.Notice(s)}r(lv,"copy_to_clipboard");function gO(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${yO(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=bO(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(gO,"format_stats_message");function yO(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(yO,"format_char_count");function bO(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(bO,"sum_exclusions");var vO="xml_structured",jc={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},dv=r((n={})=>{let e=n.template_preset||vO;return jc[e]?e:"custom"},"get_preset_key"),$c=r((n,e,t,s)=>{let i=dv(n),o=jc[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function Tc(){return Object.entries(jc).map(([n,e])=>({value:n,label:e.label||n}))}r(Tc,"get_template_preset_options");function _v(n={},e={}){return{template_before:$c(n,e,"context_template_before","template_before"),template_after:$c(n,e,"context_template_after","template_after")}}r(_v,"get_context_templates");function uv(n={},e={}){let t=dv(n),s=jc[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:$c(n,e,"item_template_before","template_before"),template_after:$c(n,e,"item_template_after","template_after")}}r(uv,"get_item_templates");var kO=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),wO=r(n=>kO(n.key),"get_item_name");async function mv(n,e={}){let t={KEY:this.key,ITEM_NAME:wO(this),TIME_AGO:lm(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(m,p)=>t[p]||"");return c},"replace_vars"),i=uv(this.settings,np);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(mv,"merge_template");var pv={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>Tc(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},np={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function vn(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=xO(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Nc(e),hv(e).trimEnd()}r(vn,"build_file_tree_string");function xO(n){return typeof n=="string"&&n.endsWith("/")}r(xO,"is_folder_path");function Nc(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Nc(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Nc(n[i])}else Nc(t)}}}r(Nc,"compress_single_child_dirs");function hv(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=hv(o,e+(c?"    ":"\u2502   ")))}),t}r(hv,"build_tree_string");async function fv(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>vn(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(m,p)=>s[p]?.()||"");return l},"replace_vars"),o=_v(this.settings,ip),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(fv,"merge_template");var gv={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>Tc(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},ip={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function po(n={}){let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:EO(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action")}))}r(po,"context_suggest_blocks");function EO(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(EO,"get_block_display_name");var yv="Add blocks";function bv(n={}){return Object.values(this.env.smart_sources.items).map(t=>({key:t.key,display:t.key,select_action:r(()=>{this.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",po.call(this,{source_key:t.key})),"mod_select_action"),arrow_right_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",po.call(this,{source_key:t.key})),"arrow_right_action")}))}r(bv,"context_suggest_sources");var vv="Add sources";async function Pc(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(Pc,"pre_process");function op(n){return this.vec?n.to_item?.vec?{score:is(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(op,"similarity");op.action_type="score";var rp="Cosine Similarity",ap="Ranks by cosine similarity between the current note and candidates.",kv={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${rp} algorithm`,value:`${ap}`}};var cp=require("obsidian");async function wv(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=cp.Keymap.isModEvent(e),l=cp.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(wv,"open_source");async function xv(n=null){await wv(this,n)}r(xv,"source_open");var Ev={collections:{embedding_models:Dy,lookup_lists:Fy},item_types:{EmbeddingModel:ms,LookupList:Pt},items:{embedding_model:{class:ms},lookup_list:{class:Pt}},modules:{},components:{collection_settings:{render:By},context_item_leaf:{render:Ky},env_stats:{render:Vy},form_dropdown:{render:Xm},lean_coffee_callout:{render:Zy},milestones:{render:rb},notifications_feed:{render:ab},pro_plugins_list:{render:bb},pro_plugins_list_item:{render:vb},settings_env_model:{render:Eb},settings_env_model_type:{render:$b},settings_env_models:{render:jb},settings_env_sources:{render:Mb},settings_model_actions:{render:Lb},settings_notifications:{render:zb},settings_smart_env:{render:Rb},smart_context_actions:{render:Bb},smart_context_item:{render:Wb},smart_context_meta:{render:Gb},smart_context_tree:{render:Xb},source_inspector:{render:Zb},status_bar:{render:iv},supporter_callout:{render:rv},user_agreement_callout:{render:cv}},actions:{context_copy_to_clipboard:{action:lv},context_item_merge_template:{action:mv,settings_config:pv,default_settings:np},context_merge_template:{action:fv,settings_config:gv,default_settings:ip},context_suggest_blocks:{action:po,display_name:yv},context_suggest_sources:{action:bv,display_name:vv},lookup_list_pre_process:{action:Pc,pre_process:Pc},similarity:{action:op,settings_config:kv,display_name:rp,display_description:ap},source_open:{action:xv}}};var Av={env_path:"",modules:{smart_fs:{class:ka,adapter:wa},smart_view:{class:Ca,adapter:qa},smart_embed_model:{class:Mi,adapters:{transformers:dn,openai:ec,ollama:nc,gemini:ic,lm_studio:oc}},smart_chat_model:{class:zi,adapters:{anthropic:Di,azure:Bi,custom:Qi,google:un,gemini:Gi,groq:eo,lm_studio:Ji,ollama:Xi,open_router:Hi,openai:_s,xai:to,deepseek:so},http_adapter:new He({adapter:ln,obsidian_request_url:lp.requestUrl})},http_adapter:{class:He,adapter:ln,obsidian_request_url:lp.requestUrl}},collections:{context_items:Ty,event_logs:Py,smart_components:Oy,smart_contexts:$y,smart_sources:{collection_key:"smart_sources",class:$i,data_adapter:Ni,source_adapters:{md:as,txt:as,"excalidraw.md":Ja,base:Ga,canvas:Ha},content_parsers:[xy],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:Ii,data_adapter:Ka,block_adapters:{md:nn,txt:nn,"excalidraw.md":nn}}},item_types:{SmartSource:en,SmartBlock:sn},items:{smart_source:ay,smart_block:my},default_settings:My,modals:{context_selector:{class:gc,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:bc},notifications_feed_modal:{class:yc}}};_t(Av,Ev);var Sv=Av;var Ic=require("obsidian");function Cv(){(0,Ic.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}r(Cv,"add_smart_chat_icon");function Ov(){(0,Ic.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}r(Ov,"add_smart_connections_icon");function qv(){(0,Ic.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}r(qv,"add_smart_lookup_icon");var $v=require("obsidian");var Mc={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function AO(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(AO,"define_default_create_methods");var kn=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,AO(Mc)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=Mc[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,$v.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,Mc["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var jv=require("obsidian");var SO=require("obsidian");function Lc(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Lc,"get_smart_server_url");var CO="smart-plugins-op",OO="smart-plugins-op-secret";function qO({access_token:n,refresh_token:e},t){localStorage.setItem(t+"token",n),e&&localStorage.setItem(t+"refresh",e)}r(qO,"set_local_storage_token");async function Tv(n,e){let t=jO(e.app.vault.getName()),s=`${Lc()}/auth/oauth_exchange2`,i=await(0,jv.requestUrl)({url:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:CO,client_secret:OO,code:n})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:o,refresh_token:a}=i.json;if(!o)throw new Error("No access_token in response");qO({access_token:o,refresh_token:a},t)}r(Tv,"exchange_code_for_tokens");var $O="_smart_plugins_oauth_";function jO(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${$O}`}r(jO,"build_oauth_storage_prefix");function Nv(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let s=vn([...new Set(t)]);return n.replace(/{{\s*folder_tree\s*}}/gi,s)}r(Nv,"replace_folder_tree_var");function Pv(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let s=vn([...new Set(t)]);return n.replace(/{{\s*folders_top\s*}}/gi,s)}r(Pv,"replace_folders_top_var");function Iv(n){console.log("replace_recent_n_var",n);let e=this;return n.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,s)=>{let i=parseInt(s,10)||0,o=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,o),o?`
- ${o}`:""}).trim()}r(Iv,"replace_recent_n_var");function Mv(n){let t=this.app?.metadataCache?.getTags?.()||{},s=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return n.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${s}
`).trim()}r(Mv,"replace_vault_tags_var");function Lv(n){n.register(e=>/{{\s*folder_tree\s*}}/i.test(e),Nv,"{{ folder_tree }}"),n.register(e=>/{{\s*folders_top\s*}}/i.test(e),Pv,"{{ folders_top }}"),n.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),Mv,"{{ tags }}"),n.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),Iv,"{{ recent_10 }}")}r(Lv,"register_completion_variable_adapter_replacements");async function Xe({app:n,plugin_ids:e=[]}={}){if(!n)return;let t=n.vault?.adapter;for(let s of e)await TO(n.plugins,s)&&console.warn(`Disabled legacy plugin: ${s}`),await NO(t,s)&&console.warn(`Removed legacy plugin: ${s}`)}r(Xe,"remove_smart_plugins_plugin");async function TO(n,e){if(!(!n||!(n.plugins?.[e]||n.enabledPlugins?.has?.(e)||n.manifests&&e in n.manifests)))return n.plugins?.[e]&&await n.unloadPlugin?.(e),n.disablePluginAndSave&&await n.disablePluginAndSave(e),n.enabledPlugins?.has?.(e)&&n.enabledPlugins.delete(e),n.manifests&&e in n.manifests&&delete n.manifests[e],await n.loadManifests?.(),!0}r(TO,"disable_plugin_if_present");async function NO(n,e){if(!n?.exists)return;let t=`.obsidian/plugins/${e}`;if(await n.exists(t)){if(n.rmdir){await n.rmdir(t,!0);return}if(n.list&&n.remove){let i=[t];for(;i.length;){let o=i.pop(),a=await n.list(o);for(let c of a?.files||[])await n.remove(`${o}/${c}`);for(let c of a?.folders||[])i.push(`${o}/${c}`)}return await n.remove(t),!0}}}r(NO,"remove_plugin_folder");var fs=class extends qi{static{r(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,Cv(),Ov(),qv(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new pt.Notice(i,0),window.smart_env=null}let s=_t(t,Sv);return s.env_path="",await super.create(e,s)}async load(e=!1){if(this.run_migrations(),!pt.Platform.isMobile&&!this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")&&this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),pt.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new pt.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i.view?.file?.path;this.emit_source_opened(o,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i?.path;this.emit_source_opened(o,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&Lv(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),tb(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let s=this.smart_sources.get(e);s&&(this._current_opened_source=e,s.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new kn(this,{adapter:pt.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),s=`${Lc()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(s,"_external"),s}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new pt.Notice("No OAuth code provided in URL. Login failed.");return}try{await Tv(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(s){console.error("OAuth callback error",s),new pt.Notice(`OAuth callback error: ${s.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&PO(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){Xe({app:this.plugin.app,plugin_ids:["smart-plugins"]}),Xe({app:this.plugin.app,plugin_ids:["smart-editor"]}),Xe({app:this.plugin.app,plugin_ids:["smart-sources"]}),Xe({app:this.plugin.app,plugin_ids:["smart-claude"]}),Xe({app:this.plugin.app,plugin_ids:["smart-gemini"]}),Xe({app:this.plugin.app,plugin_ids:["smart-deepseek"]}),Xe({app:this.plugin.app,plugin_ids:["smart-perplexity"]}),Xe({app:this.plugin.app,plugin_ids:["smart-grok"]}),Xe({app:this.plugin.app,plugin_ids:["smart-aistudio"]})}};function PO(n,e){let t=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}r(PO,"download_json");var ho=class extends zc.Plugin{static{r(this,"SmartPlugin")}SmartEnv=fs;get commands(){return{show_release_notes:{id:"show-release-notes",name:"Show release notes",callback:r(()=>this.show_release_notes(),"callback")}}}register_commands(){Object.values(this.commands).forEach(e=>{this.addCommand(e)})}get ribbon_icons(){return{}}register_ribbon_icons(){let e=Object.values(this.ribbon_icons);for(let t=0;t<e.length;t++){let s=e[t];this.addRibbonIcon(s.icon_name,s.description,s.callback)}}get item_views(){return{}}register_item_views(){let e=Object.values(this.item_views);for(let t=0;t<e.length;t++){let s=e[t];typeof s.register_item_view=="function"&&s.register_item_view(this)}}async is_new_user(){let e=await this.loadData()||{};return e.installed_at?!1:(e.installed_at=Date.now(),await this.saveData(e),!0)}async get_last_known_version(){return(await this.loadData()||{}).last_version||""}async set_last_known_version(e){let t=await this.loadData()||{};t.last_version=e,await this.saveData(t)}async is_new_plugin_version(e){return await this.get_last_known_version()!==e}get notices(){return this.env?.notices?this.env.notices:(this._notices||(this._notices=new kn(this.env,zc.Notice)),this._notices)}};var up=require("obsidian");var zv=require("obsidian");async function Dv(n,e={}){let{wait_for_states:t=["loaded"]}=e,s=n.container||n.containerEl;if(!t.includes(n.env?.state)){let i=!1;for(;n.env.state==="init"&&zv.Platform.isMobile&&!i;)s?(s.empty(),n.env.smart_view.safe_inner_html(s,"<button>Load Smart Environment</button>"),s.querySelector("button").addEventListener("click",()=>{n.env.load(!0),i=!0})):console.log("Waiting for env to load (mobile)..."),await new Promise(o=>setTimeout(o,2e3));for(;!t.includes(n.env.state);){if(s){let o=n.env?.obsidian_is_syncing?"Waiting for Obsidian Sync to finish...":"Loading Obsidian Smart Environment...";s.empty(),n.env.smart_view.safe_inner_html(s,o)}else console.log("Waiting for env to load...");await new Promise(o=>setTimeout(o,2e3))}}}r(Dv,"wait_for_env_to_load");var dp=`/* 1) Host elements that should get a PRO badge */\r
:is(\r
.pro-setting .setting-item-name\r
) {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
:is(\r
.pro-setting .setting-item-name:not(:empty)\r
)::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
:is(\r
.pro-setting .setting-item-name\r
):hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
.pro-plugins-container {\r
border: 1px solid var(--interactive-accent);\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-top: 1rem;\r
background-color: var(--background-secondary);\r
}\r
\r
.smart-plugin-settings-header .actions-container {\r
display: flex;\r
flex-wrap: wrap;\r
gap: var(--pill-padding-y);\r
}\r
\r
.setting-component:has(.dropdown-no-options) {\r
display: none;\r
}\r
\r
/* wrap Obsidian native styles within smart plugin settings main class */\r
.smart-plugin-settings-main, .smart-plugin-settings-env {\r
.setting-group {\r
margin-top: var(--size-4-6);\r
margin-bottom: var(--size-4-6);\r
}\r
/* polyfill */\r
.setting-group .setting-items {\r
background-color: var(--setting-items-background, var(--background-primary-alt));\r
padding: var(--setting-items-padding, var(--size-4-5));\r
border-radius: var(--setting-items-radius, var(--radius-l));\r
border: var(--setting-items-border-width, 0) solid var(--setting-items-border-color, var(--background-modifier-border));\r
}\r
}\r
`;var fo=class extends up.PluginSettingTab{static{r(this,"SmartPluginSettingsTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.env.is_pro&&!this.env_settings_tab&&this.plugin.addSettingTab(new _p(this.plugin.app,this.plugin)),this.icon="smart-connections",this.env.is_pro&&(this.name=this.name.replace("Smart ",""))}get smart_view(){return this.env?.smart_view}async display(){await this.render()}async render(){this.containerEl.empty(),Rv(this),await this.env.constructor.wait_for({loaded:!0}),this.prepare_layout(),await this.render_header(this.header_container),await this.render_plugin_settings(this.plugin_container),await this.render_global_settings(this.global_settings_container)}prepare_layout(){this.smart_view.apply_style_sheet(dp),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.global_settings_container=this.containerEl.createDiv({cls:"smart-plugin-settings-env"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"})}async render_header(e){}async render_plugin_settings(e){}async render_global_settings(e){if(!e||(e.empty?.(),!this.env))return;if(this.env.is_pro){let s=e.createDiv({cls:"setting-item"}),i=s.createDiv({cls:"setting-item-info"});i.createDiv({cls:"setting-item-name",text:"Smart Environment"}),i.createDiv({cls:"setting-item-description",text:"Manage global settings in the dedicated Smart Environment settings tab."}),s.createDiv({cls:"setting-item-control"}).createEl("button",{text:"Open settings"}).addEventListener("click",()=>{this.app.setting.openTabById("smart-environment")})}else{let s=await this.render_component("settings_smart_env",this.env);s&&e.appendChild(s)}let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}async render_component(e,t,s={}){return await this.env.smart_components.render_component(e,t,s)}get env_settings_tab(){return(this.plugin.app||window.app).setting.pluginTabs.find(t=>t.id==="smart-environment")}},_p=class extends up.PluginSettingTab{static{r(this,"SmartEnvSettingTab")}constructor(e,t){super(e,t),this.plugin=t,this.header_container=null,this.plugin_container=null,this.global_settings_container=null,this.plugin?.env?.create_env_getter?.(this),this.plugin=t,this.name="Smart Env Pro",this.id="smart-environment",this.icon="smart-connections"}get smart_view(){return this.env?.smart_view}display(){this.render()}async render_component(e,t,s={}){return await this.env.smart_components.render_component(e,t,s)}async render(){this.containerEl.empty(),this.smart_view.apply_style_sheet(dp),Rv(this),await this.env.constructor.wait_for({loaded:!0}),this.containerEl.empty(),this.header_container=this.containerEl.createDiv({cls:"smart-plugin-settings-header"}),this.plugin_container=this.containerEl.createDiv({cls:"smart-plugin-settings-main"}),this.pro_plugins_container=this.containerEl.createDiv({cls:"smart-plugin-settings-pro-plugins"}),this.header_container.createEl("p",{text:"Manage all global Smart Environment settings from one tab. These settings apply to all Smart Plugins."});let e=await this.render_component("settings_smart_env",this.env);e&&this.plugin_container.appendChild(e);let t=await this.render_component("pro_plugins_list",this.env);this.pro_plugins_container.empty?.(),this.pro_plugins_container.appendChild(t)}};function Rv(n){let e=n.containerEl,t=n.env;if(t.state!=="loaded")if(t.state==="loading")e.createEl("p",{text:"Smart Environment is loading\u2026"});else{e.createEl("p",{text:"Smart Environment not yet initialized."});let s=e.createEl("button",{text:"Load Smart Environment"});s.addEventListener("click",async()=>{s.disabled=!0,s.textContent="Loading Smart Environment\u2026",await t.load(!0)})}}r(Rv,"render_pre_env_load");var Dc=require("obsidian");function mp(n,e){let t=n.app.internalPlugins?.plugins?.webviewer?.instance;window.open(e,t?"_external":"_blank")}r(mp,"open_url_externally");var It=class n extends Dc.Modal{static{r(this,"StoryModal")}constructor(e,{title:t,url:s}){super(e.app),this.plugin=e,this.title=t,this.url=s}static open(e,t){new n(e,t).open()}onOpen(){this.titleEl.setText(this.title),this.modalEl.addClass("sc-story-modal");let e=this.contentEl.createEl("div",{cls:"sc-story-container"});if(Dc.Platform.isMobile){e.createEl("button",{text:"Open in browser"}).addEventListener("click",()=>{mp(this.plugin,this.url),this.close()});return}else{let t=e.createEl("webview",{attr:{src:this.url,allowpopups:""}});t.style.width="100%",t.style.height="100%",t.addEventListener("did-navigate",s=>{let i=s.url||t.getAttribute("src");i&&i!==this.url&&(mp(this.plugin,i),this.close())})}}onClose(){this.contentEl.empty()}};var Rc=class extends fo{static{r(this,"SmartContextSettingTab")}constructor(e,t){super(e,t),this.plugin=t}async render_plugin_settings(e){if(!e)return;e.empty?.();let t=e.createDiv({cls:"smart-context-getting-started-container"});t.style.marginBottom="1em",t.createEl("button",{cls:"sc-getting-started-button",text:"Getting started guide"}).addEventListener("click",()=>{It.open(this.plugin,{title:"Getting Started With Smart Context",url:"https://smartconnections.app/story/smart-context-getting-started/?utm_source=context-settings"})}),this.env.smart_components.render_component("smart_context_settings_tab",this).then(i=>{e.appendChild(i)})}};var Fv=require("obsidian");function Bv(n,e){let t=`Copied to clipboard! (${e})`;if(n){let s=n.char_count<1e5?n.char_count:`~${Math.round(n.char_count/1e3)}k`;if(t+=`, ${s} chars`,n.exclusions){let i=Object.values(n.exclusions).reduce((o,a)=>o+a,0);i>0&&(t+=`, ${i} section(s) excluded`)}}new Fv.Notice(t)}r(Bv,"show_stats_notice");function pp(n=[],e){if(!Array.isArray(n)||!e?.get)return[];let t=new Set;return n.reduce((s,i)=>{if(i?.extension?.toLowerCase?.()!=="md")return s;let a=i?.path;if(!a||t.has(a))return s;let c=e.get(a);return c?.key&&(t.add(a),s.push(c.key)),s},[])}r(pp,"get_selected_note_keys");function hp(n){let e=String(n??"").trim();return e?e.endsWith("/")?e:`${e}/`:""}r(hp,"normalize_folder_prefix");function fp(n=[]){if(!Array.isArray(n))return[];let e=new Set,t=[];for(let s of n){if(!Array.isArray(s?.children))continue;let o=s?.path;!o||e.has(o)||(e.add(o),t.push(o))}return t}r(fp,"get_selected_folder_paths");function go(n=[],e){if(!Array.isArray(n)||n.length===0)return[];if(!e||typeof e.filter!="function")return[];let t=new Set,s=[];for(let i of n){let o=hp(i);if(o)try{let a=e.filter({key_starts_with:o});if(!Array.isArray(a))continue;for(let c of a){let l=c?.key;!l||t.has(l)||!l.startsWith(o)||(t.add(l),s.push(l))}}catch(a){return console.warn("expand_folders_to_item_keys: smart_sources.filter failed",a),[]}}return s}r(go,"expand_folders_to_item_keys");function Uv(n=[],e){if(!Array.isArray(n))return[];let t=new Set,s=[];for(let i of n){if(Array.isArray(i?.children)){let d=i?.path,_=go([d],e);for(let m of _)!m||t.has(m)||(t.add(m),s.push(m));continue}let a=i?.path;if(!a)continue;let c=(i?.extension?.toLowerCase?.()||"").trim(),l=null;c==="md"?l=e?.get?.(a)?.key||a:c==="pdf"||MO(c)?l=a:l=e?.get?.(a)?.key||null,l&&(t.has(l)||(t.add(l),s.push(l)))}return s}r(Uv,"get_selected_context_item_keys");function MO(n){return new Set(["png","jpg","jpeg","gif","bmp","webp","svg","ico","avif"]).has(String(n||"").toLowerCase())}r(MO,"is_supported_image_extension");var Fc=require("obsidian");var wn=class extends Fc.ItemView{static{r(this,"SmartItemView")}constructor(e,t){super(e),this.app=t.app,this.plugin=t}static get view_type(){throw new Error("view_type must be implemented in subclass")}static get display_text(){throw new Error("display_text must be implemented in subclass")}static get icon_name(){return"smart-connections"}static register_item_view(e){let t=this;e.registerView(t.view_type,l=>new t(l,e)),e.addCommand({id:t.view_type,name:"Open: "+t.display_text+" view",callback:r(()=>{t.open(e.app.workspace)},"callback")});let s=t.view_type.replace(/^smart-/,"").replace(/-/g,"_"),i="open_"+s;Object.getOwnPropertyDescriptor(e,s)||Object.defineProperty(e,s,{configurable:!0,enumerable:!1,get:r(()=>t.get_view(e.app.workspace),"get")}),e[i]=()=>t.open(e.app.workspace);let o=`${s}:open`,a=r(l=>{let d=typeof l?.active=="boolean"?l.active:!0;t.open(e.app.workspace,d)},"handler"),c=e?.env?.events.on(o,a);return typeof e.register=="function"&&typeof c=="function"&&e.register(()=>c()),{method_name:s,open_method_name:i,event_name:o}}static get_leaf(e){return e.getLeavesOfType(this.view_type)[0]}static get_view(e){let t=this.get_leaf(e);return t?t.view:void 0}static open(e,t={}){let{active:s=!0}=t,i=this.get_leaf(e);this.default_open_location==="root"?i?i.setViewState({type:this.view_type,active:s}):e.getLeaf(!1).setViewState({type:this.view_type,active:s}):(i?i.setViewState({type:this.view_type,active:s}):e.getRightLeaf(!1).setViewState({type:this.view_type,active:s}),e.rightSplit?.collapsed&&e.rightSplit.toggle()),setTimeout(()=>{this.get_view(e)?.render_view(t)},100)}static is_open(e){return this.get_leaf(e)?.view instanceof this}getViewType(){return this.constructor.view_type}getDisplayText(){return this.constructor.display_text}getIcon(){return this.constructor.icon_name}async onOpen(){this.app.workspace.onLayoutReady(this.initialize.bind(this))}async initialize(){if(await Dv(this),this.container.empty(),this.register_plugin_events(),this.app.workspace.registerHoverLinkSource(this.constructor.view_type,{display:this.getDisplayText(),defaultMod:!0}),this.render_view(),Fc.Platform.isMobile){let e=this.containerEl.querySelector(".status-bar-mobile")??this.containerEl.createDiv({cls:"status-bar-mobile"});e.empty();let t=e.createDiv({cls:"status-bar-item"});this.env.smart_components.render_component("status_bar",this.env).then(s=>t.appendChild(s))}}register_plugin_events(){}render_view(e={}){throw new Error("render_view must be implemented in subclass")}get container(){return this.containerEl.children[1]}get env(){return this.plugin.env}async open_settings(){await this.app.setting.open(),await this.app.setting.openTabById(this.plugin.manifest.id)}};var LO="smart-contexts-dashboard",Bc=class extends wn{static{r(this,"ContextsDashboardView")}static get view_type(){return LO}static get display_text(){return"Management dashboard (show named contexts)"}static get icon_name(){return"layout-dashboard"}async render_view(e={}){let t=await this.env.render_component("smart_context_list",this.env.smart_contexts,{...e});t.classList.add("item-view"),this.container.empty(),this.container.append(t)}};var Gv=require("obsidian");var Wv=`> [!NOTE] Patch v2.0.3
> - Added: template presets for context and item templates
> - Added: \`{{ITEM_NAME}}\` variable for context item templates
> - Added: \`{{EXT}}\` variable for context item templates
> - Added: \`json_stringify\` setting for custom context item templates

> [!NOTE]- Previous patches
> > [!NOTE]- v2.0.2
> > - Added option to open context builder using file/folder selections in file nav
> > - Added command/modal for selecting named contexts (open copy modal or builder modal)
> > - Added help button to CopyContextModal for user guidance
> > - Added functionality to copy multiple selected folders as context using files menu
> > - Updated named context list styles and add help button
>
>
# Smart Context \`v2\`\r
\r
**Feed large language models better inputs, faster.** **Smart Context *collects, cleans, and copies* every note you need** in a single click.\r
\r
> Build your Context Engineering workflow with Obsidian.\r
\r
- Copy selected files in file navigator to clipboard\r
- right-click on multi-file selection in file navigator to reveal option\r
- Use links to quickly copy current and relevant notes as context\r
- embedded links are treated as depth 0\r
- Name context bundles for easy re-use\r
\r
Learn more: https://smartconnections.app/smart-context/#docs
`;var xn=class n extends wn{static{r(this,"ReleaseNotesView")}static get view_type(){return"smart-context-release-notes-view"}static get display_text(){return"Release Notes"}static get icon_name(){return"file-text"}static open(e,t,s=!0){e.getLeaf("tab").setViewState({type:this.view_type,active:s,state:{version:t}})}getViewType(){return n.view_type}getDisplayText(){return n.display_text}getIcon(){return n.icon_name}onOpen(){this.titleEl.setText(`What's new in v${this.version}`),this.render()}get container(){let e=this.containerEl?.querySelector(".view-content"),t=e?.querySelector(".markdown-preview-view");return t||(t=e?.createDiv("cm-scroller is-readable-line-width")?.createDiv("markdown-preview-view markdown-rendered")),t}async render(){for(;!this.container;)await new Promise(e=>setTimeout(e,100)),console.warn("Waiting for containerEl to be ready...",this.container);await Gv.MarkdownRenderer.render(this.app,Wv,this.container,"",this),this.container.querySelectorAll("a").forEach(e=>{e.setAttribute("target","_external")}),requestAnimationFrame(()=>this.#e(this.container,this.version))}get version(){return this.leaf.viewState?.state?.version??this.app.plugins.getPlugin("smart-context")?.manifest.version??""}#e(e,t){if(!t)return;let s=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`\\bv?${s}\\b`,"i");e.querySelectorAll("h1,h2,h3,h4,h5,h6").forEach(o=>{i.test(o.textContent??"")&&o.scrollIntoView({behavior:"smooth",block:"start"})})}};function Uc(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Uc,"collection_instance_name_from");function gs(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Hv(e[t])&&Hv(n[t])?gs(n[t],e[t]):n[t]=e[t]);return n}r(gs,"deep_merge");function Hv(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(Hv,"is_plain_object");function Jv(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Jv,"create_uid");function Kv(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(Kv,"camel_case_to_snake_case");function Wc(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Wc(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Wc(n[o],e[o],t))}return n===e}r(Wc,"deep_equal");function Vv(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(Vv,"get_item_display_name");function Gc(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let b of Reflect.ownKeys(u)){let j=Object.getOwnPropertyDescriptor(u,b);if(!j)continue;let x={...j};"value"in x&&s(x.value)&&(x.value=d(x.value));try{Object.defineProperty(h,b,x)}catch{h[b]=x.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let b=!1;for(let j of h){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x){let $=x.value;if(c($)){b=!0;continue}if(s($)){if(_($)){b=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return b},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),b=new Map;for(let j of Reflect.ownKeys(u)){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x&&_(x.value)){b.set(j,d(x.value));continue}try{Object.defineProperty(h,j,m(x))}catch{h[j]=x.value}}}return{global_source:h,scoped_sources:b}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),v=Object.create(null),k=r((u,h,b=[])=>{if(!u||!h)return;let j=new Set([...l,...b]);for(let x of Reflect.ownKeys(u)){if(j.has(x))continue;let $=Object.getOwnPropertyDescriptor(u,x);if($)try{Object.defineProperty(h,x,$)}catch{h[x]=$.value}}},"copy_metadata"),w=r(u=>{let h=new u(n),b=h.action||h.run||h.execute||h.call;if(i(b)){let j=b.bind(h);return k(u,j),k(h,j),j.instance=h,j}return k(u,h),h},"instantiate_class"),q=r(u=>{if(o(u))return w(u);if(a(u)){let h=u.action.bind(n);return k(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return k(u,h),h}return s(u)?d(u):u},"bind_or_clone"),E=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),S=r((u,h,b)=>(u[h]=b,b),"cache_result"),C=r((u,h)=>{let b=E();return b&&g(b,h)?S(u,h,q(b[h])):g(f,h)?S(u,h,q(f[h])):S(u,h,void 0)},"compute_and_cache"),O=r(()=>{let u=E(),h=new Set(Reflect.ownKeys(v));for(let b of Reflect.ownKeys(f))h.add(b);if(u)for(let b of Reflect.ownKeys(u))h.add(b);return Array.from(h)},"union_keys"),A=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(v,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:C(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let b=E();return b&&g(b,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return A(u,h);let b=E();if(b&&g(b,h)||g(f,h))return g(u,h)||C(u,h),A(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,b)=>"value"in b?(u[h]=b.value,!0):!1,"defineProperty"),set:r((u,h,b)=>(u[h]=b,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(Gc,"create_actions_proxy");var yo=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&gs(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Jv(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return gs(s,t),!Wc(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=Gc(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Uc(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Uc(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Kv(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return Vv(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var zO=Object.getPrototypeOf(async function(){}).constructor,bo=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof zO?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return gs(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=Gc(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var Hc=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=vo;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},vo=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var Jc=class extends Hc{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=ko;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},ko=class extends vo{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var Xv={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Kc=class extends Jc{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=Vc;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},Vc=class extends ko{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,v=new g(this.env,d);v._queue_load=!1,v.loaded_at=Date.now(),f.set(v)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return Xv[s]&&(s=Xv[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function gp(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():Yv(a)?n[o]=gp(Yv(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(gp,"ajson_merge");function Yv(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(Yv,"is_object");var Zv={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function DO(n){let e=!1,[t,...s]=n.split(":");return Zv[t]&&(t=Zv[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(DO,"_parse_ajson_key");var wo=class extends Kc{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:v}=DO(p),k=`${y}:${g}`;f?(i[k]=f,(v||k!==p)&&(delete i[p],t=!0)):(delete i[k],(v||k!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=gp(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}};function Qv(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(Qv,"filter_redundant_context_items");var ys=class extends yo{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e){!e||!this.data?.context_items?.[e]||(this.data.context_items[e].folder?this.data.context_items[e].exclude=!0:delete this.data.context_items[e],this.queue_save(),this.emit_event("context:updated",{removed_key:e}))}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this.on_event("context:updated",()=>{this._context_items=null})}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return Qv(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var Xc=class extends bo{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var ek={class:Xc,data_adapter:wo,item_type:ys};var En=require("obsidian");var Yc=class extends En.SuggestModal{static{r(this,"CopyContextModal")}constructor(e,t={}){let s=e.env,i=s.plugin,o=i.app;super(o),this.app=o,s.create_env_getter(this),this.plugin=i,this.ctx=e,this.params=t,this.modalEl.prepend(this.titleEl),this.setTitle("Smart Context - Copy to clipboard");let a=this.titleEl.createEl("button");(0,En.setIcon)(a,"help-circle"),a.addEventListener("click",c=>{window.open("https://smartconnections.app/smart-context/clipboard/?utm_source=copy-modal","_external")}),this.titleEl.style.display="flex",this.titleEl.style.justifyContent="space-between",this.titleEl.style.margin="var(--size-4-4)",setTimeout(()=>this.inputEl.focus(),0)}async onOpen(){let e=this.ctx.context_items.filter(i=>!(i.data.exclude||i.is_media&&!this.params.with_media)),t=Math.max(...e.map(i=>typeof i.data.d=="number"?i.data.d:0)),s=e.reduce((i,o)=>{if(typeof o.data.d=="number")for(let a=o.data.d;a<=t;a++)i[a]||(i[a]={d:a,size:0,sizes:0,count:0}),i[a].count+=1,typeof o.size=="number"&&o.size>0&&(i[a].size+=o.size,i[a].sizes+=1);return i},Array.from({length:t+1}));this.suggestions=s.filter(Boolean),super.onOpen()}getSuggestions(){return this.suggestions}renderSuggestion(e,t){t.createDiv({text:`Depth ${e.d} (${RO(e.size)} chars, ${e.count} items)`})}async onChooseSuggestion(e){let t=new En.Notice("Copying context\u2026",0);await this.ctx.actions.context_copy_to_clipboard({filter:r(s=>s.data.d<=e.d,"filter"),max_depth:e.d,...this.params}),t.hide()}};function RO(n){let e=Number(n)||0;if(e>=1e7){let t=e/1e6;return`${t>=10?Math.round(t):Math.round(t*10)/10}M`}if(e>=1e4){let t=e/1e3;return`${t>=10?Math.round(t):Math.round(t*10)/10}K`}return e.toLocaleString()}r(RO,"format_suggestion_size");function FO(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(FO,"build_html");async function tk(n,e={}){let t=FO(),i=this.create_doc_fragment(t).firstElementChild;return BO.call(this,n,i,e),i}r(tk,"render");async function BO(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o),yp(n,o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),Zm(n,a),Qm(n,a),ep(n,a),tp(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(BO,"post_process");function yp(n,e){let t=document.createElement("input");t.type="text",t.className="sc-context-name-input",t.placeholder="Context name\u2026",t.setAttribute("aria-label","Context name"),e.appendChild(t);let s=r(()=>{t.value=n?.data?.name?String(n.data.name):""},"refresh_name"),i=r(()=>{let a=o(t.value);a!==(n.data.name||"")&&(n.name=a)},"save_name");s(),t.addEventListener("keydown",a=>{a.stopPropagation(),a.key==="Enter"&&(i(),t.blur()),a.key==="Escape"&&(s(),t.blur())}),t.addEventListener("blur",()=>i());function o(a){let c=String(a??"").trim();if(!c)return"";let l=c.replace(/\s+/g," "),d=120;return l.length>d?l.slice(0,d):l}r(o,"sanitize_context_name")}r(yp,"render_name_input");var sk="2.0.0";var nk=`.sc-contexts-dashboard-list {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-contexts-dashboard .top-bar {\r
display: flex;\r
align-items: center;\r
justify-content: space-between;\r
margin-bottom: 1rem;\r
}`;var rk=require("obsidian");var ik="sc-contexts-dashboard",ok="sc-contexts-dashboard-list";function WO(){return`<div class="${ik}">
<div class="top-bar">
<small><b>Smart Context</b></small>
<button class="help"></button>
</div>
<div class="${ok}"></div>
</div>`}r(WO,"build_html");async function ak(n,e={}){this.apply_style_sheet(nk);let t=WO(),i=this.create_doc_fragment(t).querySelector(`.${ik}`);return GO.call(this,n,i,e),i}r(ak,"render");async function GO(n,e,t={}){let s=[],i=e.querySelector(`.${ok}`),o=n?.env,a=e.querySelector("button.help");(0,rk.setIcon)(a,"help-circle"),a?.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-list-help#manage-named","_external")});let c=r(async()=>{let l=n.filter(d=>d?.data?.name&&String(d.data.name).trim().length>0);if(this.empty(i),!l.length){let d=document.createElement("div");d.classList.add("sc-contexts-dashboard-empty"),d.textContent="No named contexts yet. Save a context to see it here.",i.appendChild(d);return}for(let d of l){let _=await o.smart_components.render_component("smart_context_list_item",d,t);_&&i.appendChild(_)}},"render_list_items");return await c(),s.push(n?.env?.events?.on("context:created",c)),this.attach_disposer(e,s),e}r(GO,"post_process");var ck=require("obsidian");var lk="sc-contexts-dashboard-item";function HO(n,e={}){return`<div>
<div class="${lk}" data-context-key="${n?.data?.key||""}">
<div class="sc-contexts-dashboard-item-header" tabindex="0" aria-label="${n.name}">
<button class="sc-contexts-dashboard-show" aria-expanded="false" aria-label="Show ${n.name}">Show</button>
<span class="sc-contexts-dashboard-name">${n.name}</span>
<span class="sc-contexts-dashboard-count">${n.item_count} items</span>
</div>
<div class="sc-contexts-dashboard-item-detail" hidden></div>
</div>
</div>`}r(HO,"build_html");async function dk(n,e={}){let t=HO(n,e),i=this.create_doc_fragment(t).querySelector(`.${lk}`);return JO.call(this,n,i,e),i}r(dk,"render");async function JO(n,e,t={}){e.querySelector(".sc-contexts-dashboard-show").addEventListener("click",async()=>{n.emit_event("context_selector:open")}),e.addEventListener("contextmenu",c=>{c.preventDefault(),c.stopPropagation();let l=n?.env?.smart_context_plugin?.app||n?.env?.plugin?.app||window.app||null;if(!l)return;let d=new ck.Menu(l);d.addItem(_=>_.setTitle("Copy context to clipboard").setIcon("copy").onClick(async(m,...p)=>{n.actions.context_copy_to_clipboard()})),d.showAtMouseEvent(c)});let i=[],o=r(()=>{let c=e.querySelector(".sc-contexts-dashboard-count");c&&(c.textContent=`${n.item_count} item${n.item_count===1?"":"s"}`)},"update_count"),a=r(c=>{let l=e.querySelector(".sc-contexts-dashboard-name");l&&c?.name?l.textContent=c.name:console.warn("Received context:renamed event without name payload or missing name_span element",{payload:c,name_span:l})},"rename_handler");return i.push(n.on_event("context:renamed",a)),i.push(n.on_event("context:updated",o)),this.attach_disposer(e,i),e}r(JO,"post_process");var _k=`.smart-context-settings-tab {\r
.setting-item-control textarea {\r
width: 100%;\r
}\r
\r
.setting-item-description code {\r
cursor: text;\r
user-select: all;\r
}\r
\r
@media (min-width: 720px) {\r
.setting-item-info:has(+ .setting-item-control:not(:empty)) {\r
max-width: 50%;\r
}\r
}\r
}\r
\r
/* hide custom inputs unles custom selected */\r
.setting-group:has(.template-preset option[value='custom']:not(:checked)) {\r
.setting-item.context-explanation,\r
.setting-item.item-explanation,\r
.setting-item.template-before,\r
.setting-item.template-after {\r
display: none;\r
}\r
}`;async function VO(n,e={}){return`<div class="smart-context-settings-tab">
<div class="smart-contexts"></div>
<div class="context-items"></div>
</div>`}r(VO,"build_html");async function uk(n,e={}){this.apply_style_sheet(_k);let t=await VO.call(this,n,e),s=this.create_doc_fragment(t),i=s.firstElementChild;return XO.call(this,n,i,e),s}r(uk,"render");async function XO(n,e,t={}){let s=n.env,i=s.smart_components?.render_component.bind(s.smart_components),o=s.smart_contexts,a=e.querySelector(".smart-contexts");hs(o.settings_config,o,a,{default_group_name:"Smart Contexts",heading_btn:[{label:"Settings documentation for Contexts Templates",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-context/settings/?utm_source=context-settings-tab#context-templates","_external"),"callback")}]});let c=s.context_items,l=e.querySelector(".context-items");hs(c.settings_config,c,l,{default_group_name:"Context Items",heading_btn:[{label:"Settings documentation for Context Items",btn_icon:"help-circle",callback:r(()=>window.open("https://smartconnections.app/smart-context/settings/?utm_source=context-settings-tab#context-items","_external"),"callback")}]})}r(XO,"post_process");var pe={OUT:"out",IN:"in",BOTH:"both"};function Zc(n,e=1,{direction:t=pe.OUT,include_self:s=!1}={}){if(!n||typeof n!="object"||!n.collection)return[];let i=n.collection,o=i.links||{},a=new Set,c=[],l=r((_,m)=>{_&&(a.has(_.key)||(a.add(_.key),d.push({src:_,depth:m}),c.push({depth:m,item:_})))},"enqueue"),d=[{src:n,depth:0}];for(s&&(a.add(n.key),c.push({depth:0,item:n}));d.length;){let _=d.shift();if(_.depth>=e)continue;let m=_.depth+1;if(t===pe.OUT||t===pe.BOTH)for(let p of _.src.outlinks)l(i.get(p.key),m);if(t===pe.IN||t===pe.BOTH){let p=Object.keys(o[_.src.path]||{});for(let f of p)l(i.get(f),m)}}return c}r(Zc,"get_links_to_depth");function YO(n=[],e=null){let t={},s=e.outlinks;for(let i of n){if(!i||!i.item)continue;let o=i.item,a=o.key;if(!a)continue;let c=typeof i.depth=="number"?i.depth:0,l=c;Array.isArray(s)&&c>0&&typeof a=="string"&&e.outlinks.find(p=>p.key===a&&p.embedded===!0)&&(l=0);let d=t[a]||{},_=typeof d.d=="number"?Math.min(d.d,l):l;t[a]={...d,d:_,mtime:o.mtime,size:o.size,link:!0}}return t}r(YO,"build_context_items_from_graph");async function mk(n={}){let t=n.direction&&Object.values(pe).includes(n.direction)?n.direction:pe.BOTH,s=typeof n.include_self=="boolean"?n.include_self:!0,i=await Zc(this,5,{direction:t,include_self:s}),o=YO(i,this),a=this.env.smart_contexts,c=this.key,l=await a.create_or_update({key:c,context_items:o});return this.once_event("sources:imported",()=>{a.items[c]&&delete a.items[c],console.log(`Invalidated SmartContext cache for source ${c}`)}),l||null}r(mk,"source_get_context");var pk={collections:{},item_types:{},items:{},modules:{},components:{smart_context_actions:{render:tk,version:sk},smart_context_list:{render:ak},smart_context_list_item:{render:dk},smart_context_settings_tab:{render:uk}},actions:{source_get_context:{action:mk}}};var ZO={collections:{smart_contexts:ek},item_types:{SmartContext:ys},modals:{copy_context_modal:{class:Yc}}},Qc=_t(pk,ZO);var tl=require("obsidian");var el=class extends tl.SuggestModal{static{r(this,"FolderSelectModal")}constructor(e,t){super(e),this.onChoose=t,this.setInstructions([{command:"Enter",purpose:"Select a folder to copy its contents to the clipboard."}])}getAllFolders(e,t=[]){t.push(e);for(let s of e.children)s instanceof tl.TFolder&&this.getAllFolders(s,t);return t}getSuggestions(e){return this.getAllFolders(this.app.vault.getRoot()).filter(s=>s.path.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e.path})}onChooseSuggestion(e){this.onChoose(e)}};var Mt=require("obsidian");var sl=class extends pn{static{r(this,"NamedContextSelectModal")}constructor(e,t,s={}){let o=t?.env?.smart_contexts;super(o),this.params={...s},this.setTitle("Smart Context - Select named context"),this.emptyStateText="No named contexts yet.",this.setInstructions([{command:"Enter",purpose:"Copy named context (choose depth)"},{command:"Mod + Enter",purpose:"Edit named context"},{command:"Esc",purpose:"Close"},{command:"\u2192",purpose:"Edit (same as Mod+Enter)"}])}open(e={}){this.params={...this.params,...e},this.suggestions=this.get_named_context_suggestions(),super.open()}get_named_context_suggestions(){let e=this.env?.smart_contexts;return((Array.isArray(e?.items)?e.items:e?.items?Object.values(e.items):[])||[]).filter(i=>(i?.data?.name?String(i.data.name).trim():"").length>0).sort((i,o)=>{let a=(i?.data?.name||"").toString().toLowerCase(),c=(o?.data?.name||"").toString().toLowerCase();return a.localeCompare(c)}).map(i=>{let o=String(i.data.name||"").trim(),a=typeof i.item_count=="number"?i.item_count:0;return{key:i?.data?.key||i?.key||o,display:`${o} (${a} item${a===1?"":"s"})`,ctx:i,select_action:r(async()=>{await this.open_copy_modal_for_named_context(i)},"select_action"),mod_select_action:r(async()=>{await this.open_builder_for_named_context(i)},"mod_select_action")}})}async onChooseSuggestion(e,t){let s=e?.item||e,i=this.use_arrow_right,o=t&&Mt.Keymap.isModifier(t,"Mod")||this.use_mod_select;this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1;let a=(i||o)&&typeof s?.mod_select_action=="function"?"mod_select_action":"select_action";if(typeof s?.[a]!="function"){new Mt.Notice("No action available for selection."),this.prevent_close=!1,super.close();return}try{await s[a]({modal:this,event:t})}catch(c){console.error("NamedContextSelectModal: selection failed",c),new Mt.Notice("Failed to open named context action.")}this.prevent_close=!1,super.close()}async open_builder_for_named_context(e){e&&e.emit_event("context_selector:open")}async open_copy_modal_for_named_context(e){if(!e)return;let t=typeof this.params?.max_depth=="number"?this.params.max_depth:3,s=this.params?.direction&&Object.values(pe).includes(this.params.direction)?this.params.direction:pe.BOTH,i=this.env?.config?.modals?.copy_context_modal?.class;if(!i){new Mt.Notice("Copy modal not available.");return}let o=new Mt.Notice("Building linked context\u2026",0),a=null;try{a=await QO(e,{max_depth:t,direction:s})}catch(l){console.error("NamedContextSelectModal: build_named_context_copy_ctx failed",l),a=null}finally{o.hide()}if(!a){new Mt.Notice("Failed to build linked context.");return}new i(a,{max_depth:t}).open()}};async function QO(n,e){if(!n?.env)return null;let t=typeof e?.max_depth=="number"?e.max_depth:3,s=e?.direction&&Object.values(pe).includes(e.direction)?e.direction:pe.BOTH,i=n?.data?.context_items||{},o={},a=[];for(let[f,y]of Object.entries(i)){if(!f)continue;let g=y&&typeof y=="object"?y:{},v=typeof g.d=="number"?g.d:0;o[f]={...g,d:v},!g.exclude&&v===0&&eq(n.env,f)&&a.push(f)}let c=[...new Set(a)];for(let f of c){let y=n.env?.smart_sources?.get?.(f);if(!y)continue;let g=[];try{g=await Zc(y,t,{direction:s,include_self:!0})}catch(k){console.warn("build_named_context_copy_ctx: get_links_to_depth failed",f,k);continue}let v=tq(g,y);sq(o,v)}let d=`${n?.data?.key||n?.key||Date.now().toString()}#copy`,_={...n.data,key:d,context_items:o},m=n.constructor,p=new m(n.env,_);return p.collection=n.collection,p}r(QO,"build_named_context_copy_ctx");function eq(n,e){return typeof e!="string"||!e||e.startsWith("external:")||e.includes("#")||!n?.smart_sources?.get?!1:!!n.smart_sources.get(e)}r(eq,"is_traversable_source_key");function tq(n=[],e=null){let t={},s=e?.outlinks;for(let i of n){if(!i||!i.item)continue;let o=i.item,a=o.key;if(!a)continue;let c=typeof i.depth=="number"?i.depth:0,l=c;Array.isArray(s)&&c>0&&typeof a=="string"&&s.find(p=>p?.key===a&&p?.embedded===!0)&&(l=0);let d=t[a]||{},_=typeof d.d=="number"?Math.min(d.d,l):l;t[a]={...d,d:_,mtime:o.mtime,size:o.size,link:!0}}return t}r(tq,"build_context_items_from_graph");function sq(n,e){if(!(!n||typeof n!="object"))for(let[t,s]of Object.entries(e||{})){if(!t)continue;let i=s&&typeof s=="object"?s:{},o=typeof i.d=="number"?i.d:0,a=n[t];if(a?.exclude)continue;if(!a){n[t]={...i,d:o,at:Date.now()};continue}let c=typeof a.d=="number"?a.d:0;n[t]={...a,...i,d:Math.min(c,o)}}}r(sq,"merge_context_items_min_depth");function hk(n){return{new_context:{id:"new-context-open-selector",name:"Open Selector for New Context",checkCallback:r(e=>n?.env?.smart_contexts?(e||n.open_new_context_modal(),!0):!1,"checkCallback")},copy_named_context:{id:"copy-named-context-with-depth",name:"Copy named context to clipboard (choose depth)",checkCallback:r(e=>n?.env?.smart_contexts?(e||new sl(n.app,n,{max_depth:3}).open(),!0):!1,"checkCallback")},get_started:{id:"show-getting-started",name:"Help: Show getting started",callback:r(()=>{It.open(n,{title:"Getting Started With Smart Context",url:"https://smartconnections.app/story/smart-context-getting-started/?utm_source=sc-command"})},"callback")},copy_current:{id:"copy-current-note-with-depth",name:"Copy current to clipboard",editorCheckCallback:r((e,t,s)=>{let i=s.file?.path;if(!i)return!1;let o=n.env.smart_sources.get(i);if(!o)return!1;let a=n.env.config.modals?.copy_context_modal?.class;return a?(e||o.actions.source_get_context().then(c=>{if(!c){n.env.events.emit("notification:error",{message:"Failed to build context for current note."}),new Notice("Failed to build context for current note.");return}new a(c).open()}),!0):!1},"editorCheckCallback")},copy_folder:{id:"copy-folder-to-clipboard",name:"Copy entire folder to clipboard",callback:r(()=>{new el(n.app,async e=>{e&&await n.copy_folder_to_clipboard(e)}).open()},"callback")}}}r(hk,"context_commands");var xo=class extends ho{static{r(this,"SmartContextPlugin")}SmartEnv=fs;onload(){this.app.workspace.onLayoutReady(this.initialize.bind(this)),this.SmartEnv.create(this,Qc)}onunload(){try{this.unregister_event_bus_handlers()}catch{}this.env.unload_main(this)}async initialize(){await this.load_new_user_state(),await this.SmartEnv.wait_for({loaded:!0}),this.register_commands(),this.register_folder_menu(),this.register_files_menu(),Bc.register_item_view(this),xn.register_item_view(this),this.addSettingTab(new Rc(this.app,this)),this.is_new_user()&&(setTimeout(()=>{It.open(this,{title:"Getting Started With Smart Context",url:"https://smartconnections.app/story/smart-context-getting-started/?utm_source=sc-new-user"})},1e3),await this.save_installed_at(Date.now())),await this.check_for_updates()}async check_for_updates(){let e=this.manifest?.version;if(!e)return;if(typeof this.is_new_plugin_version=="function"&&typeof this.set_last_known_version=="function"){try{if(!await this.is_new_plugin_version(e))return;try{xn.open(this.app.workspace,e)}catch(i){console.error("Failed to open ReleaseNotesView",i)}await this.set_last_known_version(e)}catch(s){console.warn("check_for_updates failed (base helpers)",s)}return}try{let s=await this.loadData()??{};if(s.last_known_version===e)return;try{xn.open(this.app.workspace,e)}catch(o){console.error("Failed to open ReleaseNotesView",o)}s.last_known_version=e,await this.saveData(s)}catch(s){console.warn("check_for_updates failed (fallback)",s)}}async load_new_user_state(){this._installed_at=null;let e=await this.loadData();e&&typeof e.installed_at<"u"&&(this._installed_at=e.installed_at)}async save_installed_at(e){this._installed_at=e;let t=await this.loadData()??{};t.installed_at=e,await this.saveData(t)}is_new_user(){return!this._installed_at}register_folder_menu(){this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof An.TFolder&&(e.addItem(s=>{s.setTitle("Copy folder contents to clipboard").setIcon("documents").onClick(async()=>{await this.copy_folder_to_clipboard(t)})}),e.addItem(s=>{s.setTitle("Open folder in Context Builder").setIcon("layout-list").onClick(async()=>{let i=hp(t.path),o=this.env.smart_sources.filter({key_starts_with:i}).map(a=>a.key);this.open_new_context_modal({add_items:o})})}))}))}register_files_menu(){this.registerEvent(this.app.workspace.on("files-menu",(e,t)=>{let s=fp(t),i=s.length>0,o=Uv(t,this.env.smart_sources);(o.length>0||i)&&e.addItem(c=>{c.setTitle("Open selection in Context Builder").setIcon("layout-list").onClick(async()=>{this.open_new_context_modal({add_items:o})})}),pp(t,this.env.smart_sources).length>1&&e.addItem(c=>{c.setTitle("Copy selected notes as context").setIcon("documents").onClick(async()=>{await this.copy_selected_files_to_clipboard(t)})}),s.length>1&&e.addItem(c=>{c.setTitle("Copy selected folders as context").setIcon("documents").onClick(async()=>{await this.copy_selected_folders_to_clipboard(t)})})}))}get_relative_path(e,t){if(e===t)return"";if(!e.startsWith(t))return e;let s=e.slice(t.length);return s.startsWith("/")&&(s=s.slice(1)),s}get commands(){return{...hk(this)}}open_new_context_modal(e={}){let t=Array.isArray(e.add_items)?e.add_items:[],s=this.env.smart_contexts.new_context({},{add_items:t}),{add_items:i,...o}=e||{};s.emit_event("context_selector:open",o)}async copy_folder_to_clipboard(e){let t=go([e?.path],this.env.smart_sources);this.env.smart_contexts.new_context({},{add_items:t}).actions.context_copy_to_clipboard()}async copy_selected_files_to_clipboard(e){let t=pp(e,this.env.smart_sources);if(!t.length){new An.Notice("No Smart Context notes found in selection.");return}this.env.smart_contexts.new_context({},{add_items:t}).actions.context_copy_to_clipboard()}async copy_selected_folders_to_clipboard(e){let t=fp(e);if(!t.length){new An.Notice("No folders found in selection.");return}let s=go(t,this.env.smart_sources);if(!s.length){new An.Notice("No Smart Context notes found in selected folders.");return}this.env.smart_contexts.new_context({},{add_items:s}).actions.context_copy_to_clipboard()}async copy_to_clipboard(e){await yn(e)}showStatsNotice(e,t){Bv(e,t)}};var Ck=require("obsidian");var Ek=P(require("path"),1),Ak=require("node:fs");function iq(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Sn(l,o),l=bp(l,15),l=Sn(l,a),i^=l,i=bp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Sn(l,o),l=bp(l,15),l=Sn(l,a),i^=l;break}return i^=n.length,i=oq(i),i|0}r(iq,"murmur_hash_32");function fk(n,e=0){return(iq(n,e)>>>0).toString(36)}r(fk,"murmur_hash_32_alphanumeric");function Sn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Sn,"multiply_32");function bp(n,e){return n<<e|n>>>32-e}r(bp,"rotate_left_32");function oq(n){return n^=n>>>16,n=Sn(n,2246822507),n^=n>>>13,n=Sn(n,3266489909),n^=n>>>16,n|0}r(oq,"fmix_32");var ht=require("fs"),il=P(require("path"),1);function rq(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=cq(n,t),o=aq(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(rq,"create_regex");function aq(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(aq,"adjust_for_windows_paths");function cq(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(cq,"glob_to_regex_pattern");function gk(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:rq(n,s)}r(gk,"glob_to_regex");function yk(n,e,t={}){return gk(n,t).test(e)}r(yk,"match_glob");var bk=["Dockerfile","Appfile","Matchfile","Deliverfile","Gymfile","Fastfile","Gemfile","Guardfile","Jenkinsfile","Makefile","Procfile","Rakefile"],vk=[".adoc",".asciidoc",".asm",".ass",".awk",".bash",".bash_profile",".bashrc",".bas",".bat",".bats",".bib",".c",".canvas",".cfg",".cjs",".cl",".clj",".cljc",".cljs",".cmake",".cmd",".cnf",".conf",".config",".cpp",".cr",".cs",".csh",".css",".csv",".cue",".cxx",".d",".dart",".dockerfile",".dockerignore",".drawio",".dtd",".edn",".eex",".editorconfig",".ejs",".el",".elm",".eml",".erb",".erl",".ex",".expect",".exs",".f",".f03",".f08",".f77",".f90",".f95",".fish",".ftl",".gcloudignore",".gitattributes",".gitignore",".gitmodules",".go",".gql",".gradle",".graphql",".groovy",".gv",".h",".haml",".hbs",".hcl",".hh",".hpp",".hrl",".hs",".htaccess",".htm",".html",".hxx",".ics",".inc",".inf",".ini",".ipynb",".ixx",".j2",".jade",".java",".jinja",".jinja2",".jl",".js",".json",".json5",".jsonc",".jsx",".ksh",".kt",".kts",".latex",".leex",".less",".lhs",".liquid",".lisp",".lock",".log",".lua",".m",".makefile",".map",".markdown",".md",".mdx",".mermaid",".mjs",".ml",".mli",".mll",".mly",".mm",".mmd",".mustache",".nfo",".nim",".nims",".njk",".ninja",".npmignore",".npmrc",".nvmrc",".org",".pas",".php",".pl",".plantuml",".plist",".pm",".po",".pot",".pp",".properties",".proto",".ps1",".psd1",".psm1",".psv",".pug",".puml",".py",".pyw",".r",".rb",".rct",".re",".rei",".rego",".res",".resi",".rkt",".rmd",".rs",".rst",".rss",".s",".sass",".scala",".scheme",".scm",".scss",".sed",".service",".sh",".shtml",".slim",".srt",".ssa",".sql",".styl",".svelte",".svg",".swift",".t",".target",".tcl",".tex",".tf",".tfvars",".thrift",".toml",".tpl",".ts",".tsv",".tsx",".twig",".txt",".vb",".vba",".vbs",".vtt",".vue",".xhtml",".xml",".xsd",".xsl",".xslt",".yaml",".yang",".yar",".yara",".yarnrc",".yml",".zig",".zprofile",".zsh",".zshrc"];function nl(n){let e=n.lastIndexOf(".");if(e===-1)return!!bk.some(s=>n.endsWith(s));let t=n.substring(e).toLowerCase();return vk.includes(t)}r(nl,"is_text_file");function lq(n){let e=n.startsWith("/"),t=e?n.slice(1):n,s=t.endsWith("/");if(s&&(t=t.slice(0,-1)),!t)return[];let i=t.includes("/"),o=t.includes("*"),a=[];return s?e?(a.push(`/${t}`),a.push(`/${t}/**`),a):i?(a.push(t),a.push(`${t}/**`),e||(a.push(`**/${t}`),a.push(`**/${t}/**`)),a):(a.push(t),a.push(`${t}/**`),a.push(`**/${t}`),a.push(`**/${t}/**`),a):!e&&!i?(o?(a.push(t),a.push(`**/${t}`)):(a.push(t),a.push(`${t}/**`),a.push(`**/${t}`),a.push(`**/${t}/**`)),a):e?(a.push(`/${t}`),o&&a.push(`/${t}`),a):(a.push(t),a.push(`**/${t}`),a)}r(lq,"expand_pattern");function kk(n,e,t=[]){n=n.replace(/\\/g,"/"),e=[...new Set([...e,"**/.git/**",".git/**","**/node_modules/**","node_modules/**","package-lock.json"])];for(let s of e){let i=lq(s);for(let o of i)if(yk(o,n,{case_sensitive:!0}))return t.push(o),!0}return!1}r(kk,"should_ignore");var dq=[".git","node_modules","package-lock.json",".obsidian",".smart-env"],wk=1e3,_q=50,Eo=new Map;function uq(n){let e=new Set,t=[];for(let s of n)s&&(e.has(s)||(e.add(s),t.push(s)));return t}r(uq,"unique_strings");function mq(n){let e=new Set;for(let t of n){if(!t||t.startsWith("!")||/[\*\?\[\]\{\}]/.test(t))continue;let s=t.replace(/\\/g,"/").trim();if(!s)continue;let i=s.endsWith("/**")?s.slice(0,-3):s;i.includes("/")||e.add(i)}return e}r(mq,"build_ignore_name_set");function ol(n,e,t=[]){let s=[],i=il.default.relative(e||n,n).replace(/\\/g,"/"),o=xk(n,".gitignore"),a=xk(n,".scignore");t=uq([...t,...o,...a,...dq]);let c=mq(t),l=!1,d=[{dir:n,root_rel_dir:""}];for(;d.length>0;){if(s.length>=wk){l||(l=!0,console.warn("get_context_items_in_external_folder: max 1000 items reached, stopping scan"));break}let{dir:_,root_rel_dir:m}=d.pop(),p;try{p=(0,ht.readdirSync)(_,{withFileTypes:!0})}catch{continue}for(let f of p){if(s.length>=wk)break;if(c.has(f.name))continue;let y=m?`${m}/${f.name}`:f.name;if(kk(y,t))continue;let g=il.default.join(_,f.name);if(f.isDirectory()){d.push({dir:g,root_rel_dir:y});continue}if(!nl(g))continue;let v=(0,ht.statSync)(g),k=i?`${i}/${y}`:y;s.push({key:`external:${k}`,size:v.size,mtime:v.mtimeMs,folder:i,ctx_codeblock:!0})}}return s}r(ol,"get_context_items_in_external_folder");function xk(n,e){let t=il.default.join(n,e);if(!(0,ht.existsSync)(t))return[];let s;try{s=(0,ht.statSync)(t).mtimeMs}catch{return[]}let i=Eo.get(t);if(i&&i.mtime_ms===s)return i.patterns;let o=[];try{let c=(0,ht.readFileSync)(t,"utf-8").split(`
`);for(let l of c){let d=l.trim();if(d&&!d.startsWith("#")){if(!d.includes(".")&&!d.includes("/")&&!d.includes("*")){o.push(`${d}/**`);continue}o.push(d)}}}catch{return[]}for(Eo.set(t,{mtime_ms:s,patterns:o});Eo.size>_q;){let a=Eo.keys().next().value;Eo.delete(a)}return o}r(xk,"load_ignore_file");function Sk(n,e,t={}){let s=t.get_stat||Ak.statSync,i=t.scan_folder||ol,o=fk(n),a=n.split(`
`).map(d=>d.trim()).filter(Boolean),c=a.filter(d=>d.startsWith("!")).map(d=>d.slice(1).trim().replace("../","**/"));c.push(".*");let l=[];for(let d of a)if(d.startsWith("../")){let _=Ek.default.join(e,d),m;try{m=s(_)}catch{console.warn("smart-context: missing path in codeblock",_);continue}if(m.isDirectory()){let p=i(_,e,c);for(let f of p)l.push({...f,ctx_codeblock:!0})}else l.push({key:"external:"+d,size:m.size,mtime:m.mtimeMs,ctx_codeblock:!0})}else d.startsWith("!../")?l.push({key:"external:"+d.slice(1),exclude:!0,ctx_codeblock:!0}):l.push({key:d,ctx_codeblock:!0});return{cb_hash:o,context_items:l,ignore_patterns:c}}r(Sk,"parse_codeblock_to_context_items");async function Ok(n){let e=n.env;n.registerMarkdownCodeBlockProcessor("smart-context",async(t,s,i)=>{let o=i?.sourcePath;if(!o)return;let a=e.smart_contexts.get(o+"#codeblock");a||(a=e.smart_contexts.new_context({key:o+"#codeblock"}));let c=(0,Ck.normalizePath)(n.app.vault.adapter.basePath),{cb_hash:l,context_items:d}=Sk(t,c);a._cb_hash!==l&&(a._cb_hash=l,a.data.context_items={},a.add_items(d));try{e.smart_components.render_component("context_codeblock",a).then(p=>{s.empty(),s.appendChild(p)})}catch(p){console.error("smart-context render error",p),s.createEl("pre",{text:p.message})}a._dispose_codeblock_listener&&a._dispose_codeblock_listener();let _=typeof i?.replaceCode=="function",m=s;a._dispose_codeblock_listener=a.on_event("context:updated",async()=>{a._cb_update_timeout&&clearTimeout(a._cb_update_timeout),a._cb_update_timeout=setTimeout(()=>{if(a._cb_update_timeout=null,!m.isConnected||!_)return;let f=Object.entries(a.data.context_items).map(([y,g])=>g.folder&&!g.exclude?g.folder:g.exclude?`!${g.key.replace("external:","")}`:y.replace("external:","")).filter((y,g,v)=>v.indexOf(y)===g).join(`
`)+`
`;try{i.replaceCode(f)}catch(y){console.error("smart-context: replaceCode failed",y)}},200)})})}r(Ok,"register_smart_context_codeblock");var o0=require("obsidian");var rl=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var al=class extends rl{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Cn=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new al(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};function ft(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(qk(e[t])&&qk(n[t])?ft(n[t],e[t]):n[t]=e[t]);return n}r(ft,"deep_merge");function qk(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(qk,"is_plain_object");function On(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(On,"camel_case_to_snake_case");function cl(n,e){let t=$k(n),s=$k(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(cl,"compare_versions");function $k(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r($k,"normalize_version_value");function Ao(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Ao,"is_plain_object");function bs(n,e,t=[]){if(!Ao(n)||!Ao(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Ao(i)?(Ao(n[s])||(n[s]={}),bs(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(bs,"deep_merge_no_overwrite");function gt(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(cl(d,_)>0){let p={...c};bs(p,l),n.collections[a]=p}else bs(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;cl(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):bs(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),bs(n[i],o)):n[i]=o}return n}r(gt,"merge_env_config");var RX=typeof globalThis<"u"?globalThis:Function("return this")();function hq(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=gq(n,t),o=fq(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(hq,"create_regex");function fq(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(fq,"adjust_for_windows_paths");function gq(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(gq,"glob_to_regex_pattern");function jk(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:hq(n,s)}r(jk,"glob_to_regex");function Tk(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(Tk,"fuzzy_search");var ll=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(jk(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return Tk(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var yq=P(require("obsidian"),1);var dl=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=yq,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function _l(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(_l,"empty");var Nk=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var Pk=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var bq=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,ul=r((n,e)=>{let t=e.trim();(bq.test(t)?Pk:Nk)(n,t)},"safe_inner_html");function Ie(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(Ie,"escape_html");function Ik(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=qn(l,o),l=vp(l,15),l=qn(l,a),i^=l,i=vp(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=qn(l,o),l=vp(l,15),l=qn(l,a),i^=l;break}return i^=n.length,i=vq(i),i|0}r(Ik,"murmur_hash_32");function se(n,e=0){return(Ik(n,e)>>>0).toString(36)}r(se,"murmur_hash_32_alphanumeric");function qn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(qn,"multiply_32");function vp(n,e){return n<<e|n>>>32-e}r(vp,"rotate_left_32");function vq(n){return n^=n>>>16,n=qn(n,2246822507),n^=n>>>13,n=qn(n,3266489909),n^=n>>>16,n|0}r(vq,"fmix_32");function kp(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(kp,"convert_to_time_ago");function vs(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(vs,"cos_sim");function we(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(we,"get_by_path");function xe(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(xe,"set_by_path");function wp(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(wp,"delete_by_path");function xp(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(xp,"compute_centroid");function Ep(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let m=Math.sqrt(_);s[a]+=m,s[l]+=m}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(Ep,"compute_medoid");var ml=new WeakMap,pl=new WeakMap,hl=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return we(e,t,s)}set_by_path(e,t,s,i=null){xe(e,t,s,i)}delete_by_path(e,t,s=null){wp(e,t,s)}escape_html(e){return Ie(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||pl.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");pl.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=pl.get(i);c&&(i.removeEventListener("change",c),pl.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=se(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){_l(e)}safe_inner_html(e,t){ul(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=ml.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},ml.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(m){console.error("[smart-view] disposer error",m)}}finally{try{l.disconnect()}catch{}ml.get(e)===c&&ml.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var fl=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(m=>{let p=l.addOption(m.value,m.label??m.name??m.value);p.selected=m.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let m=l.addOption(_.value,_.label??_.name??_.value);m.selected=_.value===s,c.length===1&&m.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,m=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(m),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let v=document.createElement("div");v.className="array-item-row";let k=document.createElement("input");k.type="text",k.value=y,k.placeholder="Value";let w=document.createElement("button");w.textContent="\u2715",w.title="Remove",k.addEventListener("change",()=>{c[g]=k.value,f()}),w.addEventListener("click",()=>{c.splice(g,1),d(),f()}),v.appendChild(k),v.appendChild(w),l.appendChild(v)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=m.value.trim();y&&(c.push(y),m.value="",d(),f())}),_.appendChild(m),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,v],k)=>{let w=document.createElement("div");w.className="json-pair-row";let q=document.createElement("input");q.type="text",q.value=g,q.placeholder="Property";let E=document.createElement("input");E.type="text",E.value=v,E.placeholder="Value";let S=document.createElement("button");S.textContent="\u2715",S.title="Remove",q.addEventListener("change",()=>{let C=q.value.trim();C&&C!==g&&(c[C]=c[g],delete c[g],d(),y())}),E.addEventListener("change",()=>{c[q.value]=E.value,y()}),S.addEventListener("click",()=>{delete c[q.value],d(),y()}),w.appendChild(q),w.appendChild(E),w.appendChild(S),l.appendChild(w)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=m.value.trim();!g||g in c||(c[g]=p.value,m.value="",p.value="",d(),y())}),_.appendChild(m),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){_l(e)}safe_inner_html(e,t){ul(e,t)}};var Ye=require("obsidian");var gl=class extends fl{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return Ye.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new Ye.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await Ye.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,Ye.getIcon)(e).outerHTML}is_mod_event(e){return Ye.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function yl(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(yl,"collection_instance_name_from");function Mk(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(Mk,"create_uid");function bl(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>bl(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>bl(n[o],e[o],t))}return n===e}r(bl,"deep_equal");function vl(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(vl,"get_item_display_name");function kl(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let b of Reflect.ownKeys(u)){let j=Object.getOwnPropertyDescriptor(u,b);if(!j)continue;let x={...j};"value"in x&&s(x.value)&&(x.value=d(x.value));try{Object.defineProperty(h,b,x)}catch{h[b]=x.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let b=!1;for(let j of h){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x){let $=x.value;if(c($)){b=!0;continue}if(s($)){if(_($)){b=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return b},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),b=new Map;for(let j of Reflect.ownKeys(u)){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x&&_(x.value)){b.set(j,d(x.value));continue}try{Object.defineProperty(h,j,m(x))}catch{h[j]=x.value}}}return{global_source:h,scoped_sources:b}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),v=Object.create(null),k=r((u,h,b=[])=>{if(!u||!h)return;let j=new Set([...l,...b]);for(let x of Reflect.ownKeys(u)){if(j.has(x))continue;let $=Object.getOwnPropertyDescriptor(u,x);if($)try{Object.defineProperty(h,x,$)}catch{h[x]=$.value}}},"copy_metadata"),w=r(u=>{let h=new u(n),b=h.action||h.run||h.execute||h.call;if(i(b)){let j=b.bind(h);return k(u,j),k(h,j),j.instance=h,j}return k(u,h),h},"instantiate_class"),q=r(u=>{if(o(u))return w(u);if(a(u)){let h=u.action.bind(n);return k(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return k(u,h),h}return s(u)?d(u):u},"bind_or_clone"),E=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),S=r((u,h,b)=>(u[h]=b,b),"cache_result"),C=r((u,h)=>{let b=E();return b&&g(b,h)?S(u,h,q(b[h])):g(f,h)?S(u,h,q(f[h])):S(u,h,void 0)},"compute_and_cache"),O=r(()=>{let u=E(),h=new Set(Reflect.ownKeys(v));for(let b of Reflect.ownKeys(f))h.add(b);if(u)for(let b of Reflect.ownKeys(u))h.add(b);return Array.from(h)},"union_keys"),A=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(v,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:C(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let b=E();return b&&g(b,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return A(u,h);let b=E();if(b&&g(b,h)||g(f,h))return g(u,h)||C(u,h),A(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,b)=>"value"in b?(u[h]=b.value,!0):!1,"defineProperty"),set:r((u,h,b)=>(u[h]=b,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(kl,"create_actions_proxy");var ne=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&ft(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return Mk(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return ft(s,t),!bl(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=kl(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),yl(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),yl(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),On(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return vl(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var kq=Object.getPrototypeOf(async function(){}).constructor,ie=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof kq?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return ft(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=kl(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var wl=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},xl=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function El(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=Lk(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=Lk(n.results);n.min=s,n.minResult=i}}r(El,"results_acc");function Dk(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=zk(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=zk(n.results);n.max=s,n.maxResult=i}}r(Dk,"furthest_acc");function Lk(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(Lk,"find_min");function zk(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(zk,"find_max");function Me(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Me,"sort_by_score");function Al(n,e){return Me(n,e)}r(Al,"sort_by_score_descending");function Rk(n,e){return Me(n,e)*-1}r(Rk,"sort_by_score_ascending");var Sl=class extends wl{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:vs(e,a.vec)};return El(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(Al)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:vs(e,a.vec)};return Dk(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(Rk)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},Cl=class extends xl{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var wq="---frontmatter---",Fk=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),xq=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),Eq=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),Aq=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(wq),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),Sq=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=Fk(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=Fk(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),Ap=r((n,e={})=>{let t=xq(n,e),s=Eq(t),i=Aq(s);return Sq(i,n)},"create_find_connections_filter_opts");async function $n(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=Ap(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+se(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Me).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r($n,"find_connections");$n.action_type="connections";var ks=class extends ne{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new Cl(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var ws=class extends ie{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Sl(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let m=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!m[f.item.path]||f.score>m[f.item.path].score?m[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=m[f.item.path].score}),m},Promise.resolve({})),c=Object.values(a).sort(Me).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return Bk}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return Cq}},Bk={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},Cq={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function Sp(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await $n.call(this,n);let o=Ap(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+se(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Me).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Me).slice(0,s)}return i}r(Sp,"find_connections");Sp.action_type="connections";var jn=class extends ks{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=xp(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=Ep(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},Uk={class:jn,actions:{find_connections:Sp}};var So=class extends ws{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let m=await _.search(e);return m?(this.search_results_ct++,{item:_,score:m}):null}catch(m){return console.error(`Error searching item ${_.id||"unknown"}:`,m),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Me)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(Oq),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},Oq={};var Ol=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=Co;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},Co=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var ql=class extends Ol{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Oo;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Oo=class extends Co{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var Wk={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},zt=class extends ql{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=yt;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},yt=class extends Oo{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,v=new g(this.env,d);v._queue_load=!1,v.loaded_at=Date.now(),f.set(v)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return Wk[s]&&(s=Wk[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var qo=class extends zt{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=Cp},Cp=class extends yt{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var $l=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return se(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return Gk(this.constructor.name)}static get adapter_key(){return Gk(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function Gk(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(Gk,"to_snake");function jl(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},m={},p=[],f={},y=null,g=null,v=!1,k=!1,w="#",q=!1,E=[],S=null;_[w]=0;for(let O=0;O<i.length;O++){let A=O+t,u=i[O],h=u.trim();if(h==="---"){if(!k&&A===1){k=!0,v=!0,l["#---frontmatter---"]=[A,null];continue}else if(v){v=!1,l["#---frontmatter---"][1]=A;continue}}if(v)continue;if(!q&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(A),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(A)),/^[-*+]\s+\[ \]/.test(u)&&f.incomplete.top.push(A)),h.startsWith("```")){if(q=!q,q&&!S?S=A:!q&&S&&(E.push([S,A]),S=null),!g){let x=c.length>0?c[c.length-1].key:w;if(x===w&&!l[w]&&(l[w]=[A,null]),x===w)g={key:w,start_line:A},(l[w][1]===null||l[w][1]<A)&&(l[w][1]=null);else{_[x]===void 0&&(_[x]=0),_[x]+=1;let $=_[x],T=`${x}#{${$}}`;l[T]=[A,null],g={key:T,start_line:A}}}continue}let b=h.match(/^(#{1,6})\s*(.+)$/);if(b&&!q){let x=b[1].length,$=b[2].trim();for(;c.length>0&&c[c.length-1].level>=x;){let Z=c.pop();l[Z.key][1]===null&&(l[Z.key][1]=A-1)}c.length===0&&l[w]&&l[w][1]===null&&(l[w][1]=A-1),g&&(l[g.key][1]===null&&(l[g.key][1]=A-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null);let T="",N=0;if(c.length>0?(T=c[c.length-1].key,N=c[c.length-1].level):(T="",N=0),c.length===0)d[$]=(d[$]||0)+1,d[$]>1&&($+=`[${d[$]}]`);else{m[T]||(m[T]={}),m[T][$]=(m[T][$]||0)+1;let Z=m[T][$];Z>1&&($+=`#{${Z}}`)}let Y=x-N,H="#".repeat(Y),$e=T+H+$;l[$e]=[A,null],_[$e]=0,c.push({level:x,title:$,key:$e});continue}let j=u.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(j&&!q){if(j[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null),g&&g.key!==w&&(l[g.key][1]===null&&(l[g.key][1]=A-1),g=null);let $=c.length>0?c[c.length-1].key:w;$===w&&!l[w]&&(l[w]=[A,null]),_[$]===void 0&&(_[$]=0),_[$]+=1;let T=_[$],N;if(s){let Y=j[3].replace(/^\[(?: |x|X)\]\s*/,""),H=qq(Y,o);N=`${$}#${H}`}else N=`${$}#{${T}}`;l[N]=[A,null],y={key:N,start_line:A};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null);let x=c.length>0?c[c.length-1].key:w;if(x===w)l[w]||(l[w]=[A,null]),(l[w][1]===null||l[w][1]<A)&&(l[w][1]=null),g={key:w,start_line:A};else{_[x]===void 0&&(_[x]=0),_[x]+=1;let $=_[x],T=`${x}#{${$}}`;l[T]=[A,null],g={key:T,start_line:A}}}}let C=i.length;for(;c.length>0;){let O=c.pop();l[O.key][1]===null&&(l[O.key][1]=C+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=C+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=C+t-1),g=null),l[w]&&l[w][1]===null&&(l[w][1]=C+t-1);for(let O in l)a[O]=l[O];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:E}}r(jl,"parse_markdown_blocks");function qq(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(qq,"get_longest_words_in_order");var Dt=class extends $l{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=jl(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let m=this.item.block_collection.get(_.key);s==="replace_blocks"?await m.update(_.content):await m.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],m=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:m,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:m,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let v=this.item.block_collection.get(m);if(await this.create_hash(p)!==v.last_read?.hash){o.push({key:m,state:"changed",content:p});continue}a.push({key:m,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function Tn(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),m={title:c,target:l,line:d};_&&(m.embedded=!0),e.push(m)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,m=o(a.index),p={title:l,target:d,line:_};m&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(Tn,"get_markdown_links");function Tl({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=Tn(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(Tl,"get_bases_cache_links");function Op(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(Op,"parse_value");function $q(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=Op(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let m=_.trim().slice(2);l.push(Op(m)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=Op(c)}return t}r($q,"parse_yaml_block");function Hk(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=$q(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(Hk,"parse_frontmatter");var Jk=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var $o=class extends Dt{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=Tn(e),s=Tl({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=Hk(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),Jk(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Rt=require("obsidian");function jq(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(jq,"merge_tags");var xs=class extends $o{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=jq(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!Rt.MarkdownRenderer||!Rt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Rt.MarkdownRenderer.render(s,t,i,this.item.path,new Rt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(m=>setTimeout(m,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Rt.htmlToMarkdown)(i)}};var Nl=class extends Dt{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var Pl=class extends Dt{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){}};var Il=class extends xs{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function Kk(n,e){let[t,...s]=n.split("#").filter(Boolean),i=vl(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(Kk,"get_block_display_name");var Nn=class extends ks{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return Kk(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},Vk={class:Nn,actions:{find_connections:$n}};var jo=class extends ws{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var Ml=class extends zt{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=qp;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},qp=class extends yt{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var Ll=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return se(e)}};function zl(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(zl,"get_line_range");var Pn=class extends Ll{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return zl(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var In=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var To=class extends In{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var Mn=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Es=class extends Mn{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var Ze=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var Ln=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},zn=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var Dn=class extends Ln{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new $p(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},$p=class extends zn{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var As=class extends Ln{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new jp(i)}},jp=class extends zn{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var Qk=P(Zk(),1);var Dq=Object.defineProperty,Rq=r((n,e,t)=>e in n?Dq(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),Fq=r((n,e,t)=>(Rq(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function Bq(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(Bq,"bytePairMerge");function Uq(n,e){return n.length===1?[e.get(n.join(","))]:Bq(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(Uq,"bytePairEncode");function Wq(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(Wq,"escapeRegex");var Np=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=Qk.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=Np.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=Np.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let m=d?.index??n.length;for(let f of n.substring(l,m).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...Uq(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},Rl=Np;Fq(Rl,"specialTokenRegex",n=>new RegExp(n.map(e=>Wq(e)).join("|"),"g"));async function tw(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await ew(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await ew(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(tw,"fetch_json_cached");async function ew(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(ew,"do_fetch");function Ip(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(Ip):e==="object"?Object.values(n).every(Ip):!1}r(Ip,"is_json_compatible");function Fl(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||Ip(i)&&(t[s]=i);return t}r(Fl,"extract_json_details");function No(n){return Object.keys(n).length===0}r(No,"is_empty_object");function Gq(n,e){return No(n)?e:No(e)?n:{...n,...e}}r(Gq,"merge_details");function Pp(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(Pp,"get_message_from_object");function V(n,e=null){if(Array.isArray(n)&&n.length>0)return V(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Fl(n,["message"]);return{message:t,details:No(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=Pp(o),c=Fl(o,["message"]),l=Fl(t,["message","error"]),d=Gq(l,c);return{message:a||Pp(t)||"Unknown error",details:No(d)?null:d,http_status:e}}return V(i)}let s=Pp(t);if(s){let i=Fl(t,["message"]);return{message:s,details:No(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(V,"normalize_error");var Hq="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",et=class extends Es{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Le}get res_adapter(){return ze}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Ze({adapter:As})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:V(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await tw(Hq,"cl100k_base.json");this.tiktoken=new Rl(e)}},Le=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},ze=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Bl=class extends et{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Mp}get res_adapter(){return Lp}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},Mp=class extends Le{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},Lp=class extends ze{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var Ul=class extends Es{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var Wl=class extends Ul{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var sw=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var nw={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:zp};var zp={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},iw={},Dp={};var Rn=class extends Wl{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=nw;constructor(e){super(e),this.connector=sw.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...iw}}get_models(){return Promise.resolve(this.models)}get models(){return zp}};var Gl=class extends et{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return Rp}get res_adapter(){return Fp}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of Kq(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},Rp=class extends Le{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},Fp=class extends ze{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},Jq=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),Kq=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(Jq)},"filter_embedding_models");var Hl=class extends et{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return Bp}get res_adapter(){return Up}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},Bp=class extends Le{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Up=class extends ze{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function Vq(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(Vq,"parse_lm_studio_models");var Jl=class extends et{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Wp}get res_adapter(){return Gp}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return Vq(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},Wp=class extends Le{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Gp=class extends ze{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var Po=class extends In{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw V(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var Kl=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#e(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#r.bind(this)),this.xhr.addEventListener("error",this.#t.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#e(this.CLOSED))}#e(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#t(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#t(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#e(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#r(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#e(this.CLOSED)}};var Vl=class extends Mn{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var Fn={},Ft={data:null,fetched_at:0},R=class extends Vl{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return F}get res_adapter(){return M}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new Ze({adapter:As})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Ft.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=V(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new Kl(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=V({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=V(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=V(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Ft?.data&&t-Ft?.fetched_at<e)return Ft.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Ft.data=o,Ft.fetched_at=t,console.log({MODELS_DEV_CACHE:Ft}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Ft.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return Fn[this.constructor.key]||(Fn[this.constructor.key]={}),Fn[this.constructor.key]}set model_data(e){Fn[this.constructor.key]||(Fn[this.constructor.key]={}),Fn[this.constructor.key]=e}},F=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},M=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:V(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Io=class extends R{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Mo}res_adapter=Lo;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Mo=class extends F{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Lo=class extends M{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:V(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var Xq=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Cs=class extends R{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Hp;parse_model_data(e){return e.data.filter(t=>!Xq.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:Yq(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function Yq(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(Yq,"get_max_input_tokens");var Hp=class extends M{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var zo=class extends Cs{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var Bn=class extends R{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Do;res_adapter=Ro;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Do=class extends F{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Ro=class extends M{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:V(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},Fo=class extends Bn{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var Bo=class extends R{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Jp}get res_adapter(){return Kp}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Jp=class extends F{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},Kp=class extends M{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Uo=class extends R{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Wo}get res_adapter(){return Go}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Wo=class extends F{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},Go=class extends M{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var Ho=class extends R{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=Jo;res_adapter=Ko;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},Jo=class extends F{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},Ko=class extends M{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:V(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var Vp={openai:{req:F,res:M},anthropic:{req:Mo,res:Lo},gemini:{req:Do,res:Ro},lm_studio:{req:Wo,res:Go},ollama:{req:Jo,res:Ko}},Vo=class extends R{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=Vp[e];return t&&t.req?t.req:F}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=Vp[e];return t&&t.res?t.res:M}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys(Vp).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var Xo=class extends R{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return Xp}get res_adapter(){return Yp}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},Xp=class extends F{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Yp=class extends M{static{r(this,"SmartChatModelGroqResponseAdapter")}};var Yo=class extends R{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return F}get res_adapter(){return M}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var Zo=class extends R{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Zp}get res_adapter(){return Qp}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Zp=class extends F{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Qp=class extends M{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var kh=require("obsidian");function ow(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=jl(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),m=zl(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===m.length&&_.vec)continue;let p=Tn(m),f=Tl({source:n,links:p}),y={key:d,lines:l,size:m.length,outlinks:[...p,...f],last_read:{at:a,hash:se(m)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new n.block_collection.item_type(n.env,y);n.block_collection.set(g)}else _.data={..._.data,...y}}Zq(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(ow,"parse_blocks");function Zq(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(Zq,"clean_and_update_source_blocks");function eh(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():rw(a)?n[o]=eh(rw(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(eh,"ajson_merge");function rw(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(rw,"is_object");var aw={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function Qq(n){let e=!1,[t,...s]=n.split(":");return aw[t]&&(t=aw[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(Qq,"_parse_ajson_key");var Bt=class extends zt{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:v}=Qq(p),k=`${y}:${g}`;f?(i[k]=f,(v||k!==p)&&(delete i[p],t=!0)):(delete i[k],(v||k!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=eh(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},th=class extends yt{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},Qo={collection:Bt,item:th};var er=class extends ne{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function e$(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(e$,"parse_component_properties");async function t$(n,e){let{scope_key:t,component_key:s}=e$(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await se(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(t$,"build_component_data");var Xl=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await t$(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var Yl=class extends Xl{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function cw(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&cw(i,o,t)}}),t}r(cw,"flatten_components_config");var Zl=class extends ie{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=cw(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},lw={class:Zl,item_type:er,data_adapter:Qo,component_adapters:{SmartViewComponentAdapter:Yl}};var dw=lw;function _w(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(_w,"filter_redundant_context_items");var tr=class extends ne{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e){!e||!this.data?.context_items?.[e]||(this.data.context_items[e].folder?this.data.context_items[e].exclude=!0:delete this.data.context_items[e],this.queue_save(),this.emit_event("context:updated",{removed_key:e}))}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this.on_event("context:updated",()=>{this._context_items=null})}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return _w(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var Ql=class extends ie{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var s$={class:Ql,data_adapter:Bt,item_type:tr};var uw=s$;var ed=class extends ne{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var tt=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var td=class extends tt{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var sd=class extends tt{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var mw=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var nd=class extends tt{static{r(this,"ImageContextItemAdapter")}static detect(e){return mw.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var id=class extends tt{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var sh=class extends ie{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},pw={version:1,class:sh,collection_key:"context_items",item_type:ed,context_item_adapters:{BlockContextItemAdapter:td,SourceContextItemAdapter:sd,ImageContextItemAdapter:nd,PdfContextItemAdapter:id}};function hw(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(hw,"next_log_stats");var Un=class extends ne{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var n$={"collection:save_started":!0,"collection:save_completed":!0},nh=class extends ie{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return Un}init(){this.env?.events||Cn.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!n$[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new Un(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=hw({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},fw={class:nh,collection_key:"event_logs",data_adapter:Bt,item_type:Un};var Os=require("obsidian");var od=class extends Os.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available"}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&this.selectActiveSuggestion(t);let s=this.inputEl.selectionStart===this.inputEl.value.length;if(t.target!==this.inputEl||!this.inputEl.value||s||Os.Keymap.isModEvent(t)){if(t.key==="ArrowLeft"){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&(s||t.target!==this.inputEl||!this.inputEl.value)){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return this.default_suggest_action_keys.map(e=>{let t=this.env.config.actions[e];if(!t)return null;let s=t.display_name||e;return{select_action:r(()=>{this.update_suggestions(e)},"select_action"),key:e,display:s}}).filter(Boolean)}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e))}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,Os.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=Os.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let l=this.inputEl.value.length;this.inputEl.setSelectionRange(l,l)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):c&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var Eoe=require("obsidian");var rd=class extends od{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var gw=require("obsidian");var ad=class extends gw.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var ld=require("obsidian");var i$="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",cd=class extends ld.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){o$(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function o$(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),r$(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open(i$,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r(o$,"render_milestones_modal_title");function r$(n){a$(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(r$,"render_help_icon");function a$(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,ld.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(a$,"set_icon_with_fallback");var yw={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var sr=class extends ne{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],m=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),m},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var dd=class extends ie{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function bw(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(bw,"settings_config");var qs=class extends sr{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var ih=class extends dd{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var c$={class:ih,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:Qo,item_type:qs,providers:{},settings_config:bw},oh=c$;var rh=class extends Rn{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},vw={class:rh,settings_config:Dp};oh.providers={transformers:vw};var kw=oh;var Ut=class extends ne{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(El(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(Al);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var ww={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},ah=class extends ie{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=l$(new Date),i=se(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new Ut(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...ww}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function l$(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(l$,"format_ymd");var xw={class:ah,collection_key:"lookup_lists",item_type:Ut,settings_config:ww};function nr(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(nr,"format_collection_name");async function d$(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${nr(n.collection_key)}</h2>
${t}
</div></div></div>`}r(d$,"build_html");async function Ew(n,e={}){let t=await d$.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(Ew,"render");var Wn=require("obsidian");function Aw(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(Wn.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new Wn.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let m=d.hoverEl.querySelector(".markdown-preview-sizer");Wn.MarkdownRenderer.render(o,l,m,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(Aw,"register_block_hover_popover");var Sw=require("obsidian");function Cw(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),Sw.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):Aw(n.parentElement,n,e.env,e.key)}r(Cw,"register_item_hover_popover");var qw=require("obsidian");function _$(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(_$,"format_score");function u$(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(u$,"format_size");function Ow(n,e){return n?`<span class="${e}">${n}</span>`:""}r(Ow,"build_badge_html");function m$(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=_$(n?.data?.score),i=u$(n?.size||n?.data?.size),o=Ow(s,"sc-context-item-score"),a=Ow(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(m$,"build_html");async function $w(n,e={}){let t=m$(n,e),i=this.create_doc_fragment(t).firstElementChild;return p$.call(this,n,i,e),i}r($w,"render");async function p$(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${qw.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),Cw(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(p$,"post_process");async function h$(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${nr(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=g$(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(h$,"build_html");async function jw(n,e={}){let t=await h$.call(this,n,e),s=this.create_doc_fragment(t);return await f$.call(this,n,s,e)}r(jw,"render");async function f$(n,e,t={}){return e}r(f$,"post_process");function g$(n,e){let t=Object.values(n.items).length,s=nr(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=y$(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=b$(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(g$,"generate_collection_stats");function y$(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(y$,"get_generic_collection_stats");function b$(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(b$,"calculate_embed_coverage");var Tw=require("obsidian");function v$(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(v$,"build_html");async function ch(n,e={}){let t=v$.call(this,n,e),s=this.create_doc_fragment(t);return await k$.call(this,n,s,e)}r(ch,"render");async function k$(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new Tw.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=we(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(m=>{_.addOption(m.value,m.label)}),l.childNodes.forEach(m=>{m.value===c&&(m.selected=!0),o.find(p=>p.value===m.value)?.disabled&&(m.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):xe(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(k$,"post_process");ch.version=.2;var Nw=require("obsidian");function w$(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(w$,"build_html");function Pw(n,e={}){let t=w$.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,Nw.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),x$.call(this,n,i,e),i}r(Pw,"render");function x$(n,e){}r(x$,"post_process");var Iw=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var Dw=require("obsidian");var A$=require("obsidian");var S$={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}};function _d(n,e){let t=O$(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(_d,"check_if_event_emitted");var lh={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},C$=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function Mw(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=C$.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(Mw,"derive_events_checklist_groups");function O$(n,e){let t=S$[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!q$(a)))return!0}return!1}r(O$,"resolve_plugin_install_event");function q$(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r(q$,"is_pro_manifest");function $$(n,e={}){let t=Mw(lh),s=t.reduce((c,l)=>{let d=l.items.reduce((_,m)=>_+(_d(n,m.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((m,p)=>m+(_d(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(m=>{let p=_d(n,m.event_key)===!0;return T$(m,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${Ie(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${Ie(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${Ie(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r($$,"build_html");async function Rw(n,e={}){this.apply_style_sheet(Iw);let t=$$.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return j$.call(this,n,i,e),i}r(Rw,"render");async function j$(n,e,t={}){return N$(e),P$(e),e}r(j$,"post_process");function T$(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${Ie(n.event_key)}"
data-link="${Ie(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${Ie(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${Ie(n.milestone)}</span>
</div>
</li>
`}r(T$,"build_item_html");function N$(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=zw(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||Lw(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=zw(n,e);s&&(e.preventDefault(),Lw(s))}))}r(N$,"attach_item_link_listeners");function Lw(n){let e=L$(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(Lw,"open_item_link");function P$(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&I$(i,s)})}r(P$,"render_item_state_icons");function I$(n,e){M$(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(I$,"set_item_icon");function M$(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,Dw.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(M$,"set_icon_with_fallback");function zw(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r(zw,"get_item_el_from_event");function L$(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=lh[t];return!s||typeof s.link!="string"?"":s.link}r(L$,"get_item_link");function z$(){return`<div>
<button class="copy-all-notifications-btn">Copy All Notifications</button>
<div class="smart-env-notifications-feed"></div>
</div>`}r(z$,"build_html");async function Fw(n,e={}){let t=this.create_doc_fragment(z$()),s=t.firstElementChild;return D$.call(this,n,s,e),t}r(Fw,"render");async function D$(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed");this.empty(s);let i=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!i.length){let a=s.ownerDocument.createElement("p");a.className="smart-env-notifications-empty",a.textContent="No Smart Env notifications yet.",s.appendChild(a);return}i.slice(-100).reverse().forEach(a=>{F$(s,a)});let o=e.querySelector(".copy-all-notifications-btn");o.addEventListener("click",()=>{let a=s.textContent;navigator.clipboard.writeText(a).then(()=>{o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy All Notifications"},2e3)})})}r(D$,"post_process");function R$(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(R$,"get_level");function F$(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=R$(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${B$(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(F$,"append_entry");function B$(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(B$,"to_time_ago");var bt=require("obsidian");var ir=require("obsidian");function or(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(or,"get_smart_server_url");function U$(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(U$,"try_get_zlib");function W$(n){let e=U$();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(W$,"inflate_deflate_data");async function Bw(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let v=new Uint8Array(n.slice(t,t+y)),k=new TextDecoder("utf-8").decode(v);t+=y,t+=g;let w=(l&8)!==0,q=t,E;if(!w)E=q+p;else{let O=q,A=!1;for(;O+4<=s;){let u=e.getUint32(O,!0);if(u===134695760||u===67324752||u===33639248){A=!0;break}O++}E=A?O:s}if(E>s)break;let S=new Uint8Array(n.slice(q,E));if(t=E,w&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let C;if(d===0)C=S;else if(d===8)C=W$(S);else continue;if(i.push({fileName:k,data:C}),k.toLowerCase().endsWith("manifest.json")&&!k.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(C))}catch{}}return{files:i,pluginManifest:o}}r(Bw,"parse_zip_into_files");function Uw(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(Uw,"validate_zip_buffer");async function Ww(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(Ww,"write_files_with_adapter");function Gw(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(Gw,"is_server_version_newer");async function Hw(n,e){let t=await(0,ir.requestUrl)({url:`${or()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return Uw(t.arrayBuffer,"Smart Plugins server")}r(Hw,"fetch_plugin_zip");async function Jw(n,e=ir.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return Uw(t.arrayBuffer,"Download")}r(Jw,"fetch_zip_from_url");async function Kw(n,e,t=ir.requestUrl){let s=await t({url:`${or()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(Kw,"fetch_plugin_readme");async function Vw(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(Vw,"enable_plugin");function Xw(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(Xw,"get_oauth_storage_prefix");async function Yw(n){let e=await(0,ir.requestUrl)({url:`${or()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(Yw,"fetch_server_plugin_list");var Zw=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var H$='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',J$='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function K$(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(K$,"derive_fallback_plugins");function V$(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${H$}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${J$}</p>
</div>
</div>
`}r(V$,"build_html");async function Qw(n,e={}){this.apply_style_sheet(Zw);let t=V$.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await X$.call(this,n,i,e),i}r(Qw,"render");async function X$(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=Xw(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".pro-plugins-list"),l=K$(),d=0,_="",m=null,p=r(E=>{if(!a||!E)return;(!m||!m.isConnected)&&(m=document.createElement("div"),m.classList.add("smart-plugins-login-manual"),a.appendChild(m)),m.innerHTML="";let S=document.createElement("div");S.classList.add("smart-plugins-login-manual-instructions"),S.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",m.appendChild(S);let C=document.createElement("div");C.classList.add("smart-plugins-login-manual-controls"),m.appendChild(C);let O=document.createElement("input");O.classList.add("smart-plugins-login-manual-input"),O.type="text",O.value=E,O.readOnly=!0,O.addEventListener("focus",()=>O.select()),C.appendChild(O);let A=document.createElement("button");A.classList.add("mod-cta"),A.textContent="Copy",A.addEventListener("click",async()=>{await Z$(E)?new bt.Notice("Copied login link to clipboard."):new bt.Notice("Copy failed. Please select and copy the link manually.")}),C.appendChild(A)},"render_manual_login_link"),f=r(async()=>{let E={},{manifests:S}=i.plugins;for(;Object.keys(S).length===0;)S=i.plugins.manifests,await new Promise(C=>setTimeout(C,100));for(let C in S){if(!Object.prototype.hasOwnProperty.call(S,C))continue;let{name:O,version:A}=S[C];E[C]={name:O,version:A}}return E},"get_installed_info"),y=r(async()=>{d++,d>=2&&_&&p(_),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(_=Y$()),new bt.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),g=r(()=>{if(this.empty(a),m=null,!(localStorage.getItem(o+"token")||"")){new bt.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(O=>{O.setButtonText("Login"),O.onClick(async()=>{await y()})});return}let S=new bt.Setting(a);S.setDesc("Signed in to Smart Plugins Pro account."),S.addButton(C=>{C.setButtonText("Logout"),C.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new bt.Notice("Logged out of Smart Plugins"),g(),w()})})},"render_oauth_login_section"),v=r(async()=>{if(this.empty(c),!(!c||l.length===0))for(let E of l){let S=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,installed_map:{}});c.appendChild(S)}},"render_fallback_plugin_list"),k=r(()=>{let E=new bt.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");E.addButton(S=>{S.setButtonText("Get Pro"),S.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),E.addButton(S=>{S.setButtonText("Update subscription"),S.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),E.addButton(S=>{S.setButtonText("Refresh"),S.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),w=r(async()=>{this.empty(c);let E=localStorage.getItem(o+"token")||"";if(!E){await v();return}try{let S=await f(),C=await Yw(E),{list:O=[],unauthorized:A=[],sub_exp:u}=C;if(typeof u=="number"&&u<Date.now()){k(),await v();return}if(!Array.isArray(O)||O.length===0){await v();return}for(let h of O){let b=await n.smart_components.render_component("pro_plugins_list_item",h,{env:n,app:i,token:E,installed_map:S,on_installed:w});c.appendChild(b)}}catch(S){console.error("[pro-plugins:list] Failed to fetch plugin list:",S),c.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),q=r(async()=>{g(),await w()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{q()}),await q(),e}r(X$,"post_process");function Y$(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${or()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(Y$,"initiate_smart_plugins_oauth");var Z$=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var de=require("obsidian");var Q$="https://smartconnections.app/pro-plugins/";function ej(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(ej,"build_html");function tj(n){return!n||!n.repo}r(tj,"is_fallback_item");function sj(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,Gw(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(sj,"compute_display_state");async function ex(n,e={}){let t=ej(n,e),i=this.create_doc_fragment(t).firstElementChild;return await nj.call(this,n,i,e),i}r(ex,"render");async function nj(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(tj(n)){let m=new de.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",m.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),m.controlEl.appendChild(p)}return m.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(Q$,"_external")})}),m.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=sj(n,l),_=new de.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(m=>{m.setButtonText(d.button_label),m.setDisabled(d.is_disabled),m.onClick(()=>oj(n,{app:s,token:i,on_installed:a}))}),_.addButton(m=>{m.setButtonText("Docs"),n.docs_url?m.onClick(()=>window.open(n.docs_url,"_external")):m.onClick(()=>rj(n,{app:s,token:i,display_name:d.display_name}))}),e}r(nj,"post_process");var ij=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return Jw(t);if(!e)throw new Error("Login required to install this plugin.");return Hw(n.repo,e)},"download_plugin_zip"),oj=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new de.Notice(`Installing "${n.repo}" ...`);let o=await ij(n,s),{files:a,pluginManifest:c}=await Bw(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await Ww(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await Vw(t,_),new de.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new de.Notice(`Install failed: ${o.message}`)}},"install_plugin"),rj=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await Kw(n.repo,s),a=new de.Modal(t);a.setTitle(i||n.name||n.repo),await de.MarkdownRenderer.render(t,o,a.contentEl,"",new de.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new de.Notice("Failed to load README")}},"show_plugin_readme");var tx=require("obsidian");var $s=class extends tx.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var sx=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var nx=require("obsidian");function cj(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${ox(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(cj,"build_html");async function ix(n,e){this.apply_style_sheet(sx);let s=this.create_doc_fragment(cj.call(this,n,e)).firstElementChild;return lj.call(this,n,s,e),s}r(ix,"render");async function lj(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,nx.setIcon)(o,ox(n)),s.addEventListener("click",()=>{new $s(n).open()}),i.addEventListener("click",()=>{new $s(n,{test_on_open:!0}).open()}),e}r(lj,"post_process");function ox(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(ox,"get_test_result_icon_name");var ax=require("obsidian");var rx={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function ud(n,e,t={}){let s=(rx[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new ax.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new $s(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(ud,"show_new_model_menu");var Hn=require("obsidian");var md=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new Hn.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function pd(n,e,t,s={}){let{default_group_name:i="Settings"}=s;n=lx(n,e);let o=Object.entries(n||{}).reduce((c,[l,d])=>{let _=d.group||i;return c[_]||(c[_]={}),c[_][l]=d,c},{[i]:{}});return Object.entries(o).sort(([c],[l])=>c===i?-1:l===i?1:0).filter(([,c])=>Object.keys(c).length>0).map(([c,l])=>{let d=t.createDiv(),_={...s,...s.group_params?.[c]||{}};return dj(c,e,l,d,_)})}r(pd,"render_settings_config");function dj(n,e,t,s,i={}){let o;try{let l=require("obsidian");l.SettingGroup?o=l.SettingGroup:o=md}catch{o=md}t=lx(t,e);let{heading_btn:a=null}=i,c=new o(s);if(a&&typeof a=="object")if(Array.isArray(a))for(let l of a)cx(c,e,l);else cx(c,e,a);c.setHeading(n);for(let[l,d]of Object.entries(t)){if(!d||typeof d!="object"){console.warn(`Invalid setting config for ${l}:`,d);continue}let _=d.scope_class==="pro-setting",m=!!e.env?.is_pro;c.addSetting(p=>{switch(d.name&&p.setName(d.name),p.setClass(l.replace(/[^a-zA-Z0-9]/g,"-")),d.type&&p.setClass(`setting-type-${d.type}`),d.description&&p.setDesc(d.description),d.type){case"button":p.addButton(f=>{f.setButtonText(d.name||"Run"),f.onClick(async y=>{typeof d.callback=="function"&&await Gn(p,y,d.callback,{scope:e})})});break;case"toggle":p.addToggle(f=>{f.setValue(we(e.settings,l)||!1),f.onChange(y=>{xe(e.settings,l,y),typeof d.callback=="function"&&Gn(p,y,d.callback,{scope:e})})});break;case"text":p.addText(f=>{f.setValue(String(we(e.settings,l)||"")),f.onChange(y=>{xe(e.settings,l,y)})});break;case"number":p.addText(f=>{f.setValue(String(we(e.settings,l)||"")),f.inputEl.setAttribute("type","number"),f.onChange(y=>{let g=Number(y);isNaN(g)||xe(e.settings,l,g),typeof d.callback=="function"&&Gn(p,g,d.callback,{scope:e})})});break;case"dropdown":p.addDropdown(f=>{let y=d.options_callback;typeof y=="function"&&y.call(e,e).forEach(v=>{let k=v.label||v.name||v.value;f.addOption(v.value,k)}),f.setValue(we(e.settings,l)||""),f.onChange(g=>{xe(e.settings,l,g),typeof d.callback=="function"&&Gn(p,g,d.callback,{scope:e})})});break;case"textarea":p.addTextArea(f=>{f.setValue(String(we(e.settings,l)||"")),f.onChange(y=>{if(_&&!m){new Hn.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}xe(e.settings,l,y)}),_&&!m&&f.setDisabled(!0)});break;case"slider":p.addSlider(f=>{let y=d.min||0,g=d.max||100,v=d.step||1;f.setLimits(y,g,v),f.setValue(we(e.settings,l)||y),f.setDynamicTooltip(),f.onChange(k=>{xe(e.settings,l,k),typeof d.callback=="function"&&Gn(p,k,d.callback,{scope:e})})});break;case"heading":p.setHeading();break;case"html":d.value&&p.descEl.replaceChildren(document.createRange().createContextualFragment(d.value));break;default:console.warn(`Unsupported setting type for ${l}:`,d.type);break}d.scope_class&&p.settingEl.addClass(d.scope_class)})}return c}r(dj,"render_settings_group");function cx(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,Hn.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await Gn(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(cx,"render_heading_button");async function Gn(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(Gn,"handle_config_callback");function lx(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(lx,"ensure_settings_config");function _j(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(_j,"build_html");async function dx(n,e){let s=this.create_doc_fragment(_j.call(this,n,e)).firstElementChild;return uj.call(this,n,s,e),s}r(dx,"render");async function uj(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=pd(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{ud(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(uj,"post_process");function mj(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(mj,"build_html");async function _x(n,e){let s=this.create_doc_fragment(mj(n,e)).firstElementChild;return pj.call(this,n,s,e),s}r(_x,"render");async function pj(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(pj,"post_process");var px=require("obsidian");function hd(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(hd,"ensure_smart_sources_settings");function rr(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(rr,"parse_exclusions_csv");function ux(n,e){let t=(e??"").trim();if(!t)return n||"";let s=rr(n);return s.includes(t)||s.push(t),s.join(",")}r(ux,"add_exclusion");function mx(n,e){let t=(e??"").trim();return t?rr(n).filter(i=>i!==t).join(","):n?.trim()||""}r(mx,"remove_exclusion");var fd=class extends px.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=hd(this.env),t=rr(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=hd(this.env);t.folder_exclusions=ux(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=hd(this.env),t=rr(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=mx(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var hx=require("obsidian");var gd=class extends hx.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function hj(n,e={}){return`
<div class="sources-settings">
</div>
`}r(hj,"build_html");async function fx(n,e={}){let t=await hj.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return fj.call(this,n,i,e),i}r(fx,"render");async function fj(n,e,t={}){pd({folder_exclusions:yj,view_exclusions:bj,re_import_sources:vj},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",gj(n,e))),this.attach_disposer(e,i),e}r(fj,"post_process");function gj(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(gj,"highlight_reset_data");var yj={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new fd(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},bj={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new gd(t.main.app,t).open()},"callback")},vj={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let m=Date.now();t.events?.emit("sources:reimported",{time_ms:m-_}),t.main.notices?.show("reload_sources",{time_ms:m-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};function kj(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(kj,"build_html");async function gx(n,e={}){let s=this.create_doc_fragment(kj(n,e)).firstElementChild;return wj.call(this,n,s,e),s}r(gx,"render");async function wj(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),ud(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(wj,"post_process");async function xj(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(xj,"build_html");async function yx(n,e={}){let t=await xj.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return Ej.call(this,n,i,e),i}r(yx,"render");async function Ej(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(Ej,"post_process");var bx=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function Sj(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(Sj,"build_html");async function vx(n,e={}){this.apply_style_sheet(bx);let t=await Sj.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return Cj.call(this,n,i,e),i}r(vx,"render");async function Cj(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return dh.call(this,"settings_env_sources",n,i),dh.call(this,"settings_env_models",n,s),dh.call(this,"settings_notifications",n,o),e}r(Cj,"post_process");function dh(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(dh,"render_if_available");var kx=require("obsidian");function Oj(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(Oj,"build_html");async function wx(n,e={}){let t=Oj(),i=this.create_doc_fragment(t).firstElementChild;return qj.call(this,n,i,e),i}r(wx,"render");async function qj(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),_h(n,a),$j(n,a),uh(n,a),mh(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(qj,"post_process");function _h(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(_h,"render_btn_open_selector");function $j(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r($j,"render_btn_copy_context");function uh(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(uh,"render_btn_clear_context");function mh(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,kx.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(mh,"render_btn_help");var xx=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var ar=require("obsidian");async function yd(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(ar.Platform.isMobile)new ar.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new ar.Notice("Failed to copy.")}}r(yd,"copy_to_clipboard");function Tj(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(Tj,"build_html");async function Ex(n,e={}){let t=Tj(n,e);this.apply_style_sheet(xx);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return Nj.call(this,n,i,e),i}r(Ex,"render");async function Nj(n,e,t={}){let s=[],i=r(async()=>{let l=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(m=>{this.empty(l),l.appendChild(m)});let d=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(m=>{this.empty(d),d.appendChild(m)});let _=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(m=>{this.empty(_),_.appendChild(m)})},"render_children"),o=n.env.plugin,a=o?.app||window.app;return(o?.registerDomEvent?.bind(o)||((l,d,_)=>l.addEventListener(d,_)))(e,"contextmenu",l=>{if(l.preventDefault(),l.stopPropagation(),!a)return;let d=new Menu(a);d.addItem(_=>_.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let m=Pj(e);await yd(m)})),d.showAtMouseEvent(l)}),await i(),s.push(n.on_event("context:updated",i)),this.attach_disposer(e,s),e}r(Nj,"post_process");function Pj(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(Pj,"tree_dom_to_wikilinks");function Ij(n){return Math.ceil((n||0)/4)}r(Ij,"estimate_tokens");function Mj(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(Mj,"build_html");async function Ax(n,e={}){let t=Mj(),i=this.create_doc_fragment(t).firstElementChild;return Lj.call(this,n,i,e),i}r(Ax,"render");async function Lj(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=Ij(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Lj,"post_process");function Sx(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-tree-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let m=["sc-tree-label"];return n.exists===!1&&m.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${a?l:""}
<span class="${m.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(Sx,"build_tree_item");function Cx(n){let e=zj(n),t=new Set(n.map(i=>i.key||i.path));return Ox(e,t)}r(Cx,"build_tree_html");function zj(n=[]){let e=r(o=>{let a=/#\{\d+\}$/u,c=o,l=null,d=null,_=!1,m=c.match(a);m&&(l=m[0],c=c.slice(0,-l.length),_=!0);let p=c.indexOf("##");p!==-1&&(d=c.slice(p),c=c.slice(0,p),_=!0);let f=[];if(c){let y="",g=!1;for(let v=0;v<c.length;v++)!g&&c.slice(v,v+2)==="[["?(g=!0,y+="[[",v++):g&&c.slice(v,v+2)==="]]"?(g=!1,y+="]]",v++):!g&&c[v]==="/"?(f.push(y),y=""):y+=c[v];y&&f.push(y)}return d&&f.push(d),l&&f.push(l),{segments:f,has_block:_}},"split_path_segments"),t={name:"",children:{},selected:!1},s=r((o,a)=>a.some(c=>o.startsWith(`${c}/`)),"is_redundant"),i=n.filter(o=>!(o.key.includes("#")?o.key.split("#")[0]:o.key).match(/\.[a-zA-Z0-9]+$/u)).map(o=>o.key);for(let{key:o,exists:a}of n){if(s(o,i.filter(m=>m!==o)))continue;let{segments:c,has_block:l}=e(o),d=t,_="";c.forEach((m,p)=>{if(_=_?`${_}/${m}`:m,m.startsWith("external:.."))return;let f=p===c.length-1,y=f&&l;d.children[m]||(d.children[m]={name:m,path:y?o:_,children:y?[]:{},selected:!1,is_file:y||f&&m.includes(".")}),d=d.children[m],f&&(d.selected=!0,d.exists=a)})}return t}r(zj,"build_path_tree");function Ox(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>Sx(s,e,Ox(s,e))).join("")}</ul>`}r(Ox,"tree_to_html");var qx=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;function Rj(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(Rj,"build_html");async function $x(n,e={}){this.apply_style_sheet(qx);let t=Rj(n,e),i=this.create_doc_fragment(t).firstElementChild;return Fj.call(this,n,i,e),i}r($x,"render");async function Fj(n,e,t={}){let s=r(()=>{let o=n.env,a=n.context_items.filter(t.filter),c=Cx(a),l=this.create_doc_fragment(c);this.empty(e),e.appendChild(l);for(let d=0;d<a.length;d++){let _=a[d],m=e.querySelector(`.sc-tree-item[data-path="${_.key}"]`);if(!m){console.warn(`Smart Context: Could not find tree item for path: ${_.key}`);continue}o.smart_components.render_component("context_item_leaf",_).then(p=>{this.empty(m),m.appendChild(p)})}},"render_tree_leaves");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(Fj,"post_process");var jx=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function Uj(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(Uj,"build_html");async function Tx(n,e={}){let t=Uj(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(jx),await Wj.call(this,n,s,e),s}r(Tx,"render");async function Wj(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let m=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of m){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',v=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',k="",w="";try{let E=await p.read();k=E.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),w=(await p.get_embed_input(E)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(E){console.error("[source_inspector] Error reading block:",E),k='<em style="color:red;">Error reading block content</em>'}let q=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${v}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${w}</pre>
</details>
<blockquote>${k}</blockquote>
<hr>
`);s.appendChild(q)}return e}r(Wj,"post_process");var Lx=require("obsidian");var Jn=require("obsidian");var Nx=require("obsidian");var bd=class extends Nx.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var Px=require("obsidian");var vd=class extends Px.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function Ix(n,e,t={}){let{Menu:s=Jn.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new Jn.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new Jn.Notice("Active note is not indexed by Smart Environment");return}new bd(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new vd(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new Jn.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(Ix,"register_status_bar_context_menu");var Mx=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function Hj(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(Hj,"build_html");async function zx(n,e={}){this.apply_style_sheet(Mx);let s=this.create_doc_fragment(Hj()).firstElementChild;return Jj.call(this,n,s,e),s}r(zx,"render");function Jj(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",v=c(),k=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",k="attention"),s&&(0,Lx.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=w=>{w.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),v>0?i.dataset.count=String(v):delete i.dataset.count,k?i.dataset.level=String(k):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=w=>{if(l()>0)w.preventDefault(),w.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let E=new MouseEvent("contextmenu",w);e.dispatchEvent?.(E)}},e.addEventListener("click",e._click_handler))},"render_status_elm");Ix(n,e),d();let _=null,m=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",m)),this.attach_disposer(e,p)}r(Jj,"post_process");var Dx=require("obsidian");function Kj(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(Kj,"build_html");function Rx(n,e={}){let t=Kj.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return Vj.call(this,n,i,e),i}r(Rx,"render");async function Vj(n,e){let t=e.querySelector(".callout-icon"),s=(0,Dx.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(Vj,"post_process");var Fx=require("obsidian");function Xj(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(Xj,"build_html");function Bx(n,e={}){let t=Xj.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,Fx.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),Yj.call(this,n,i,e),i}r(Bx,"render");function Yj(n,e){}r(Yj,"post_process");var ph=require("obsidian");async function Ux(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new ph.Notice("No context items to copy.");let t=await this.get_text(n);await yd(t);let s=Zj({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new ph.Notice(s)}r(Ux,"copy_to_clipboard");function Zj(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${Qj(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=eT(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(Zj,"format_stats_message");function Qj(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(Qj,"format_char_count");function eT(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(eT,"sum_exclusions");var tT="xml_structured",wd={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},Wx=r((n={})=>{let e=n.template_preset||tT;return wd[e]?e:"custom"},"get_preset_key"),kd=r((n,e,t,s)=>{let i=Wx(n),o=wd[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function xd(){return Object.entries(wd).map(([n,e])=>({value:n,label:e.label||n}))}r(xd,"get_template_preset_options");function Gx(n={},e={}){return{template_before:kd(n,e,"context_template_before","template_before"),template_after:kd(n,e,"context_template_after","template_after")}}r(Gx,"get_context_templates");function Hx(n={},e={}){let t=Wx(n),s=wd[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:kd(n,e,"item_template_before","template_before"),template_after:kd(n,e,"item_template_after","template_after")}}r(Hx,"get_item_templates");var sT=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),nT=r(n=>sT(n.key),"get_item_name");async function Jx(n,e={}){let t={KEY:this.key,ITEM_NAME:nT(this),TIME_AGO:kp(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(m,p)=>t[p]||"");return c},"replace_vars"),i=Hx(this.settings,hh);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(Jx,"merge_template");var Kx={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>xd(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},hh={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function Ad(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=iT(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Ed(e),Vx(e).trimEnd()}r(Ad,"build_file_tree_string");function iT(n){return typeof n=="string"&&n.endsWith("/")}r(iT,"is_folder_path");function Ed(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Ed(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Ed(n[i])}else Ed(t)}}}r(Ed,"compress_single_child_dirs");function Vx(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=Vx(o,e+(c?"    ":"\u2502   ")))}),t}r(Vx,"build_tree_string");async function Xx(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>Ad(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(m,p)=>s[p]?.()||"");return l},"replace_vars"),o=Gx(this.settings,fh),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(Xx,"merge_template");var Yx={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>xd(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},fh={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function cr(n={}){let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:oT(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action")}))}r(cr,"context_suggest_blocks");function oT(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(oT,"get_block_display_name");var Zx="Add blocks";function Qx(n={}){return Object.values(this.env.smart_sources.items).map(t=>({key:t.key,display:t.key,select_action:r(()=>{this.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",cr.call(this,{source_key:t.key})),"mod_select_action"),arrow_right_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",cr.call(this,{source_key:t.key})),"arrow_right_action")}))}r(Qx,"context_suggest_sources");var e0="Add sources";async function Sd(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(Sd,"pre_process");function gh(n){return this.vec?n.to_item?.vec?{score:vs(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(gh,"similarity");gh.action_type="score";var yh="Cosine Similarity",bh="Ranks by cosine similarity between the current note and candidates.",t0={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${yh} algorithm`,value:`${bh}`}};var vh=require("obsidian");async function s0(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=vh.Keymap.isModEvent(e),l=vh.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(s0,"open_source");async function n0(n=null){await s0(this,n)}r(n0,"source_open");var i0={collections:{embedding_models:kw,lookup_lists:xw},item_types:{EmbeddingModel:qs,LookupList:Ut},items:{embedding_model:{class:qs},lookup_list:{class:Ut}},modules:{},components:{collection_settings:{render:Ew},context_item_leaf:{render:$w},env_stats:{render:jw},form_dropdown:{render:ch},lean_coffee_callout:{render:Pw},milestones:{render:Rw},notifications_feed:{render:Fw},pro_plugins_list:{render:Qw},pro_plugins_list_item:{render:ex},settings_env_model:{render:ix},settings_env_model_type:{render:dx},settings_env_models:{render:_x},settings_env_sources:{render:fx},settings_model_actions:{render:gx},settings_notifications:{render:yx},settings_smart_env:{render:vx},smart_context_actions:{render:wx},smart_context_item:{render:Ex},smart_context_meta:{render:Ax},smart_context_tree:{render:$x},source_inspector:{render:Tx},status_bar:{render:zx},supporter_callout:{render:Rx},user_agreement_callout:{render:Bx}},actions:{context_copy_to_clipboard:{action:Ux},context_item_merge_template:{action:Jx,settings_config:Kx,default_settings:hh},context_merge_template:{action:Xx,settings_config:Yx,default_settings:fh},context_suggest_blocks:{action:cr,display_name:Zx},context_suggest_sources:{action:Qx,display_name:e0},lookup_list_pre_process:{action:Sd,pre_process:Sd},similarity:{action:gh,settings_config:t0,display_name:yh,display_description:bh},source_open:{action:n0}}};var rT={env_path:"",modules:{smart_fs:{class:ll,adapter:dl},smart_view:{class:hl,adapter:gl},smart_embed_model:{class:To,adapters:{transformers:Rn,openai:Bl,ollama:Gl,gemini:Hl,lm_studio:Jl}},smart_chat_model:{class:Po,adapters:{anthropic:Io,azure:zo,custom:Vo,google:Bn,gemini:Fo,groq:Xo,lm_studio:Uo,ollama:Ho,open_router:Bo,openai:Cs,xai:Yo,deepseek:Zo},http_adapter:new Ze({adapter:Dn,obsidian_request_url:kh.requestUrl})},http_adapter:{class:Ze,adapter:Dn,obsidian_request_url:kh.requestUrl}},collections:{context_items:pw,event_logs:fw,smart_components:dw,smart_contexts:uw,smart_sources:{collection_key:"smart_sources",class:So,data_adapter:qo,source_adapters:{md:xs,txt:xs,"excalidraw.md":Il,base:Nl,canvas:Pl},content_parsers:[ow],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:jo,data_adapter:Ml,block_adapters:{md:Pn,txt:Pn,"excalidraw.md":Pn}}},item_types:{SmartSource:jn,SmartBlock:Nn},items:{smart_source:Uk,smart_block:Vk},default_settings:yw,modals:{context_selector:{class:rd,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:cd},notifications_feed_modal:{class:ad}}};gt(rT,i0);var aT=require("obsidian");var cT=require("obsidian");var _T=require("obsidian");var lT=require("obsidian");var pT=require("obsidian");var mT=require("obsidian");var r0=require("obsidian");function Cd(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Cd,"collection_instance_name_from");function js(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a0(e[t])&&a0(n[t])?js(n[t],e[t]):n[t]=e[t]);return n}r(js,"deep_merge");function a0(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(a0,"is_plain_object");function c0(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(c0,"create_uid");function l0(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(l0,"camel_case_to_snake_case");function Od(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>Od(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>Od(n[o],e[o],t))}return n===e}r(Od,"deep_equal");function wh(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(wh,"get_item_display_name");function qd(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let b of Reflect.ownKeys(u)){let j=Object.getOwnPropertyDescriptor(u,b);if(!j)continue;let x={...j};"value"in x&&s(x.value)&&(x.value=d(x.value));try{Object.defineProperty(h,b,x)}catch{h[b]=x.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let b=!1;for(let j of h){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x){let $=x.value;if(c($)){b=!0;continue}if(s($)){if(_($)){b=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return b},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),b=new Map;for(let j of Reflect.ownKeys(u)){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x&&_(x.value)){b.set(j,d(x.value));continue}try{Object.defineProperty(h,j,m(x))}catch{h[j]=x.value}}}return{global_source:h,scoped_sources:b}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),v=Object.create(null),k=r((u,h,b=[])=>{if(!u||!h)return;let j=new Set([...l,...b]);for(let x of Reflect.ownKeys(u)){if(j.has(x))continue;let $=Object.getOwnPropertyDescriptor(u,x);if($)try{Object.defineProperty(h,x,$)}catch{h[x]=$.value}}},"copy_metadata"),w=r(u=>{let h=new u(n),b=h.action||h.run||h.execute||h.call;if(i(b)){let j=b.bind(h);return k(u,j),k(h,j),j.instance=h,j}return k(u,h),h},"instantiate_class"),q=r(u=>{if(o(u))return w(u);if(a(u)){let h=u.action.bind(n);return k(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return k(u,h),h}return s(u)?d(u):u},"bind_or_clone"),E=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),S=r((u,h,b)=>(u[h]=b,b),"cache_result"),C=r((u,h)=>{let b=E();return b&&g(b,h)?S(u,h,q(b[h])):g(f,h)?S(u,h,q(f[h])):S(u,h,void 0)},"compute_and_cache"),O=r(()=>{let u=E(),h=new Set(Reflect.ownKeys(v));for(let b of Reflect.ownKeys(f))h.add(b);if(u)for(let b of Reflect.ownKeys(u))h.add(b);return Array.from(h)},"union_keys"),A=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(v,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:C(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let b=E();return b&&g(b,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return A(u,h);let b=E();if(b&&g(b,h)||g(f,h))return g(u,h)||C(u,h),A(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,b)=>"value"in b?(u[h]=b.value,!0):!1,"defineProperty"),set:r((u,h,b)=>(u[h]=b,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(qd,"create_actions_proxy");var Wt=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&js(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return c0(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return js(s,t),!Od(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=qd(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Cd(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Cd(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),l0(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return wh(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var fT=Object.getPrototypeOf(async function(){}).constructor,vt=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof fT?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return js(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=qd(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var $d=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=lr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},lr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var jd=class extends $d{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=dr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},dr=class extends lr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var d0={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},_r=class extends jd{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=Kn;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},Kn=class extends dr{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,v=new g(this.env,d);v._queue_load=!1,v.loaded_at=Date.now(),f.set(v)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return d0[s]&&(s=d0[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function xh(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():_0(a)?n[o]=xh(_0(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(xh,"ajson_merge");function _0(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(_0,"is_object");var u0={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function gT(n){let e=!1,[t,...s]=n.split(":");return u0[t]&&(t=u0[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(gT,"_parse_ajson_key");var ur=class extends _r{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:v}=gT(p),k=`${y}:${g}`;f?(i[k]=f,(v||k!==p)&&(delete i[p],t=!0)):(delete i[k],(v||k!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=xh(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Eh=class extends Kn{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},mr={collection:ur,item:Eh};function yT(n){if(n==null)return"";let e;if(Array.isArray(n))e=n.map(t=>t==null?"":String(t)).join(", ");else if(typeof n=="object")try{e=JSON.stringify(n)}catch{e=String(n)}else e=String(n);return e.startsWith("formula.")&&(e=e.replace("formula.","")),e.startsWith("note.")&&(e=e.replace("note.","")),e.startsWith("file.")&&(e=e.replace("file.","")),e.replace(/\|/g,"\\|").replace(/\r?\n/g,"<br>")}r(yT,"stringify_cell");function bT(n){if(!Array.isArray(n)||n.length===0)return[];let e=n.map(s=>Array.isArray(s)?s:[s]),t=e.reduce((s,i)=>Math.max(s,i.length),0);return e.map(s=>Array.from({length:t},(i,o)=>yT(s[o])))}r(bT,"normalize_table");function vT(n){if(n.length===0)return[];let e=n[0].length,t=Array.from({length:e},()=>0);return n.forEach(s=>{for(let i=0;i<e;i++){let o=(s[i]??"").length;o>t[i]&&(t[i]=o)}}),t.map(s=>Math.max(s,3))}r(vT,"compute_col_widths");function kT(n,e){let t=n??"";return t.length>=e?t:t+" ".repeat(e-t.length)}r(kT,"pad_cell");function Ah(n,e){return`| ${n.map((s,i)=>kT(s,e[i])).join(" | ")} |`}r(Ah,"build_row");function wT(n){let e=bT(n);if(e.length===0)return"";let t=vT(e),s=Ah(e[0],t),i=t.map(c=>"-".repeat(c)),o=Ah(i,t),a=e.slice(1).map(c=>Ah(c,t));return[s,o,...a].join(`
`)}r(wT,"to_markdown_table");function xT(n,e){return e.split(".").reduce((t,s)=>{if(t!=null)return["formula"].includes(s)?t.formulaResults.cachedFormulaOutputs:["note"].includes(s)&&t.note?.data?t.note.data:["size","mtime","ctime"].includes(s)?t.stat[s]:["links"].includes(s)?(smart_env.smart_sources.get(n.file.path)?.outlinks||[]).map(o=>`[[${o.key}]]`).join(", "):["name"].includes(s)?`[[${t.name}]]`:t[s]},n)}r(xT,"get_value_from_path");function ET(n){return n?.linkText?.includes(".base")??!1}r(ET,"is_bases_child");async function AT(n){await new Promise(t=>setTimeout(t,300));let e=n?._children?.[0]?.view;return e?.data?e:null}r(AT,"get_base_file_view");function m0(n){if(!n?.propertiesCache||!Array.isArray(n.data))return[];let e=n.propertiesCache,t=e.map(a=>a),s=n.groupedDataCache||[],i=s[s.length-1];if(!i?.entries)return[t];let o=i.entries.map(a=>e.map(c=>{let l=xT(a,c);return Array.isArray(l?.data)&&typeof l.data?.[0]?.data=="string"?l.data.map(d=>d.sourcePath?`[[${d.data}]]`:d.data).join(", "):l?.data??(typeof l!="object"?l:"")??""}));return[t,...o]}r(m0,"get_bases_output");function ST(n){if(!Array.isArray(n))return new Set;let e=n.map(t=>t?.link??t?.path??t?.displayText??t?.original??t?.rawText??"").filter(t=>typeof t=="string"&&t.includes(".base"));return new Set(e)}r(ST,"get_base_links");var pr=class extends Wt{static{r(this,"BasesCache")}get collection(){return this.env.bases_caches}get markdown_table(){let e=this.data?.bases_output;return wT(e)}},Sh=class extends vt{static{r(this,"BasesCaches")}static version=1;#e=null;#t=new Map;#o="";#n=new WeakSet;#i=null;#s=200;#r=3e4;#a=3e4;init(){let e=app.workspace,t=r(()=>this.start_watchers(),"handler");this.env.plugin.registerEvent(e.on("active-leaf-change",t)),typeof this.env.plugin.register=="function"&&this.env.plugin.register(()=>this.stop_watchers()),this.start_watchers()}start_watchers(){this.stop_watchers();let e=app.workspace.getActiveFileView();if(!e)return console.warn("No file view");let t=e.file?this.env.smart_sources?.get(e.file.path):null;this.#o=t?.key||e.file?.path||"",this.#n=new WeakSet,this.prune_missing_base_caches({source:t});let s=e?.editor?.editorComponent;if(s){let i=r(()=>{let o=s._children||[],a=new Set;o.forEach(c=>{ET(c)&&(a.add(c),!this.#n.has(c)&&(this.#n.add(c),this.watch_base_child(c)))}),this.sweep_orphan_watchers(a)},"scan_children");i(),this.#e=this.set_interval(i,this.#s)}AT(e).then(i=>{i?(this.#i=i,this.watch_base_file(i)):(this.#i=null,console.warn("No bases view"))})}set_interval(e,t){return setInterval(e,t)}clear_interval(e){clearInterval(e)}sweep_orphan_watchers(e){let t=new Set(e);this.#i&&t.add(this.#i),this.#t.forEach((s,i)=>{let o=t.has(i),a=!0;try{let c=i?.containerEl||i?._children?.[0]?.viewContainerEl||i?.viewContainerEl||null;c&&typeof c.isConnected=="boolean"&&(a=c.isConnected)}catch{a=!1}(!o||!a)&&(this.clear_interval(s.id),this.#t.delete(i))})}watch_base_child(e){let t=e.linkText,s=Date.now(),i=this.set_interval(()=>{let o=e?.containerEl||e?._children?.[0]?.viewContainerEl||null;if(o&&o.isConnected===!1){this.clear_interval(i),this.#t.delete(e);return}if(Date.now()-s>this.#r){this.clear_interval(i),this.#t.delete(e);return}let a=e?._children?.[0]?.view?.data;if(!a)return;let c=m0(a);if(c.length){this.clear_interval(i),this.#t.delete(e);let l=new pr(this.env,{key:`${this.#o}#${t}`,bases_output:c});this.set(l),l.queue_save(),this.process_save_queue()}},this.#s);this.#t.set(e,{id:i,started:s})}watch_base_file(e){let t=Date.now(),s=this.set_interval(()=>{let i=e?.containerEl||e?.viewContainerEl||null;if(i&&i.isConnected===!1){this.clear_interval(s),this.#t.delete(e);return}if(Date.now()-t>this.#a){this.clear_interval(s),this.#t.delete(e);return}let o=e?.data;if(!o)return;let a=m0(o);if(a.length){this.clear_interval(s),this.#t.delete(e);let c=new pr(this.env,{key:this.#o,bases_output:a});this.set(c),c.queue_save(),this.process_save_queue()}},this.#s);this.#t.set(e,{id:s,started:t})}stop_watchers(){this.#e&&(this.clear_interval(this.#e),this.#e=null),this.#t.forEach(e=>this.clear_interval(e.id)),this.#t.clear(),this.#i=null}prune_missing_base_caches(e={}){let{source:t=null,source_key:s=this.#o}=e,i=t?.data?.meta?.links||t?.meta?.links||[],o=ST(i);if(!s)return;let a=`${s}#`,c=!1;Object.entries(this.items).forEach(([l,d])=>{if(!l.startsWith(a))return;let _=l.slice(a.length);o.has(_)||(c=!0,d.delete())}),c&&this.process_save_queue()}},p0={class:Sh,collection_key:"bases_caches",data_adapter:ur,item_type:pr};var Ts=class extends Wt{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],m=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),m},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var Vn=class extends vt{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function Td(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(Td,"settings_config");var Ns=class extends Ts{static{r(this,"ChatCompletionModel")}async complete(e){return this.instance.complete(e)}async stream(e,t={}){return this.instance.stream(e,t)}async test_model(){try{let e=await this.complete({messages:[{role:"user",content:"2+2="}]}),t=!e.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var kt=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var hr=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},fr=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var wt=class extends hr{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new Ch(i)}},Ch=class extends fr{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var Nd=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#e(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#r.bind(this)),this.xhr.addEventListener("error",this.#t.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#e(this.CLOSED))}#e(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#t(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#t(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#e(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#r(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#e(this.CLOSED)}};var Gt=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Pd=class extends Gt{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};function qh(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(qh):e==="object"?Object.values(n).every(qh):!1}r(qh,"is_json_compatible");function Id(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||qh(i)&&(t[s]=i);return t}r(Id,"extract_json_details");function gr(n){return Object.keys(n).length===0}r(gr,"is_empty_object");function CT(n,e){return gr(n)?e:gr(e)?n:{...n,...e}}r(CT,"merge_details");function Oh(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(Oh,"get_message_from_object");function ce(n,e=null){if(Array.isArray(n)&&n.length>0)return ce(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Id(n,["message"]);return{message:t,details:gr(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=Oh(o),c=Id(o,["message"]),l=Id(t,["message","error"]),d=CT(l,c);return{message:a||Oh(t)||"Unknown error",details:gr(d)?null:d,http_status:e}}return ce(i)}let s=Oh(t);if(s){let i=Id(t,["message"]);return{message:s,details:gr(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(ce,"normalize_error");var Xn={},Ht={data:null,fetched_at:0},G=class extends Pd{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return J}get res_adapter(){return B}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new kt({adapter:wt})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=Ht.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=ce(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new Nd(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=ce({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=ce(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=ce(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(Ht?.data&&t-Ht?.fetched_at<e)return Ht.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return Ht.data=o,Ht.fetched_at=t,console.log({MODELS_DEV_CACHE:Ht}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),Ht.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return Xn[this.constructor.key]||(Xn[this.constructor.key]={}),Xn[this.constructor.key]}set model_data(e){Xn[this.constructor.key]||(Xn[this.constructor.key]={}),Xn[this.constructor.key]=e}},J=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},B=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:ce(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Md=class extends G{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return $h}get res_adapter(){return jh}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},$h=class extends J{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},jh=class extends B{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Th=class extends Md{static{r(this,"OpenRouterChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},OT={api_key:{name:"API Key",type:"password",description:"Enter your API key for the chat model provider."}},Ld={class:Th,settings_config:OT};var Nh=class extends Vn{static{r(this,"ChatCompletionModels")}model_type="Chat";get default_provider_key(){return"open_router"}};var qT={class:Nh,data_dir:"chat_completion_models",collection_key:"chat_completion_models",data_adapter:mr,item_type:Ns,providers:{open_router:Ld},settings_config:Td},h0=qT;var f0=h0;var Ps=class extends Ts{static{r(this,"RankingModel")}static get defaults(){return{data:{api_key:"",provider_key:"cohere",model_key:"rerank-v3.5"}}}async rank(e,t,s={}){return this.instance.rank(e,t,s)}async test_model(){try{let e=await this.rank("alphabetical order",["z","y","x","a","b","c"]),t=!!(!e.error&&Array.isArray(e)&&e.length);return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Ph={"[ADAPTER].model_key":{name:"Ranking Model",type:"dropdown",description:"Select a ranking model to use.",options_callback:"adapter.get_models_as_options",callback:"reload_model"}},zd=class extends Gt{static{r(this,"SmartRankAdapter")}constructor(e){super(e),this.smart_rank=e}async rank(e,t){throw new Error("rank method not implemented")}get settings_config(){return Ph}};var Dd=class extends zd{static{r(this,"SmartRankModelApiAdapter")}get endpoint(){return this.model.data.endpoint||this.constructor.defaults.endpoint}get api_key(){return this.model.data.api_key}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new kt({adapter:wt})),this._http_adapter}async load(){this.model.model_loaded=!0,this.api_key&&this.set_state("loaded")}async request(e,t=0){try{e.throw=!1,e.url=this.endpoint,console.log("API Request:",e);let s=await this.http_adapter.request(e);return console.log("API Response:",s),await this.get_resp_json(s)}catch(s){return await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.rank("test query",["Test document"]);return Array.isArray(e)&&e.length>0&&e[0].score!==null}},Rd=class{static{r(this,"SmartRankModelRequestAdapter")}constructor(e,t,s){this.adapter=e,this.query=t,this.documents=s}get_headers(){let e={"Content-Type":"application/json"};return this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`),e}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Fd=class{static{r(this,"SmartRankModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_standard(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Bd=class extends Dd{static{r(this,"SmartRankCohereAdapter")}static defaults={adapter:"cohere",description:"Cohere",default_model:"rerank-v3.5",endpoint:"https://api.cohere.ai/v2/rerank"};get req_adapter(){return Ih}get res_adapter(){return Mh}async load(){this.model.model_loaded=!0,this.set_state("loaded")}async rank(e,t){let i=new this.req_adapter(this,e,t).to_platform(),o=await this.request(i);return!o||!o.results?{message:o?.message||"Invalid response from Cohere API",resp:o}:new this.res_adapter(this,o).to_standard()}async handle_request_err(e,t,s){if(e&&e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Cohere API rate limit exceeded. Retrying in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error("Cohere API Error:",e),null}get settings_config(){return $T}get models(){return jT}},$T={...Ph,"[ADAPTER].api_key":{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},jT={"rerank-v3.5":{id:"rerank-v3.5",description:"State-of-the-art performance in English and non-English languages. Supports documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-english-v3.0":{id:"rerank-english-v3.0",description:"English language documents and semi-structured data (JSON). Context length: 4096 tokens"},"rerank-multilingual-v3.0":{id:"rerank-multilingual-v3.0",description:"Non-English documents and semi-structured data (JSON). Supports same languages as embed-multilingual-v3.0. Context length: 4096 tokens"}},Ih=class extends Rd{static{r(this,"SmartRankCohereRequestAdapter")}prepare_request_body(){return{query:this.query,documents:this.documents,model:this.adapter.model_key,top_n:1e3,max_tokens_per_doc:4096}}},Mh=class extends Fd{static{r(this,"SmartRankCohereResponseAdapter")}parse_response(){return this.response.results?this.response.results.map(e=>({index:e.index,score:e.relevance_score})):(console.error("Invalid response format from Cohere API:",this.response),[])}};var Lh=class extends Bd{static{r(this,"CohereRankingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get_models(){return this.models}},TT={api_key:{name:"Cohere API Key",type:"password",description:"Enter your Cohere API key for ranking.",placeholder:"Enter Cohere API Key"}},g0={class:Lh,settings_config:TT};var zh=class extends Vn{static{r(this,"RankingModels")}model_type="Ranking";get default_provider_key(){return"cohere"}},NT={class:zh,data_dir:"ranking_models",collection_key:"ranking_models",data_adapter:mr,item_type:Ps,providers:{cohere:g0},settings_config:Td},y0=NT;var b0=y0;var Ud=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}};function Wd(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Wd,"cos_sim");function w0(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=v0(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=v0(n.results);n.min=s,n.minResult=i}}r(w0,"results_acc");function x0(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=k0(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=k0(n.results);n.max=s,n.maxResult=i}}r(x0,"furthest_acc");function v0(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(v0,"find_min");function k0(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(k0,"find_max");function Yn(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Yn,"sort_by_score");function E0(n,e){return Yn(n,e)}r(E0,"sort_by_score_descending");function A0(n,e){return Yn(n,e)*-1}r(A0,"sort_by_score_ascending");var Gd=class extends Ud{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Wd(e,a.vec)};return w0(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(E0)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Wd(e,a.vec)};return x0(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort(A0)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}};function PT(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Zn(l,o),l=Dh(l,15),l=Zn(l,a),i^=l,i=Dh(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Zn(l,o),l=Dh(l,15),l=Zn(l,a),i^=l;break}return i^=n.length,i=IT(i),i|0}r(PT,"murmur_hash_32");function S0(n,e=0){return(PT(n,e)>>>0).toString(36)}r(S0,"murmur_hash_32_alphanumeric");function Zn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Zn,"multiply_32");function Dh(n,e){return n<<e|n>>>32-e}r(Dh,"rotate_left_32");function IT(n){return n^=n>>>16,n=Zn(n,2246822507),n^=n>>>13,n=Zn(n,3266489909),n^=n>>>16,n|0}r(IT,"fmix_32");var MT="---frontmatter---",C0=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),LT=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),zT=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),DT=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(MT),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),RT=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=C0(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=C0(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),FT=r((n,e={})=>{let t=LT(n,e),s=zT(t),i=DT(s);return RT(i,n)},"create_find_connections_filter_opts");async function Rh(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=FT(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+S0(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Yn).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(Rh,"find_connections");Rh.action_type="connections";var yr=class extends vt{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new Gd(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let m=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!m[f.item.path]||f.score>m[f.item.path].score?m[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=m[f.item.path].score}),m},Promise.resolve({})),c=Object.values(a).sort(Yn).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return Hd}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return BT}},Hd={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},BT={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};var br=class extends yr{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var WT=r(n=>{let e={embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...Hd};return n.settings.embed_blocks===!1&&e.min_chars&&(e.min_chars.disabled=!0),e},"settings_config"),O0={class:br,collection_key:"smart_blocks",settings_config:WT};var ti=require("obsidian");function De(n=""){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}r(De,"escape_html");function q0(n,e=0){let t=n.length&3,s=n.length-t,i=e,o=3432918353,a=461845907,c=0,l=0,d=0;for(;c<s;)d=n.charCodeAt(c)&255|(n.charCodeAt(c+1)&255)<<8|(n.charCodeAt(c+2)&255)<<16|(n.charCodeAt(c+3)&255)<<24,c+=4,l=d,l=Qn(l,o),l=Fh(l,15),l=Qn(l,a),i^=l,i=Fh(i,13),i=i*5+3864292196|0;switch(l=0,t){case 3:l^=(n.charCodeAt(c+2)&255)<<16;case 2:l^=(n.charCodeAt(c+1)&255)<<8;case 1:l^=n.charCodeAt(c)&255,l=Qn(l,o),l=Fh(l,15),l=Qn(l,a),i^=l;break}return i^=n.length,i=GT(i),i|0}r(q0,"murmur_hash_32");function oe(n,e=0){return(q0(n,e)>>>0).toString(36)}r(oe,"murmur_hash_32_alphanumeric");function Qn(n,e){return(n&65535)*e+((n>>>16)*e<<16)|0}r(Qn,"multiply_32");function Fh(n,e){return n<<e|n>>>32-e}r(Fh,"rotate_left_32");function GT(n){return n^=n>>>16,n=Qn(n,2246822507),n^=n>>>13,n=Qn(n,3266489909),n^=n>>>16,n|0}r(GT,"fmix_32");function he(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(he,"camel_case_to_snake_case");function Bh(n){let e=Date.now(),t=n<1e12?n*1e3:n,s=e-t,i=s<0,o=Math.floor(Math.abs(s)/1e3),a=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60},{label:"second",seconds:1}];for(let c of a){let l=Math.floor(o/c.seconds);if(l>=1){let d=`${l} ${c.label}${l>1?"s":""}`;return i?`in ${d}`:`${d} ago`}}return"just now"}r(Bh,"convert_to_time_ago");function st(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&($0(e[t])&&$0(n[t])?st(n[t],e[t]):n[t]=e[t]);return n}r(st,"deep_merge");function $0(n){return n&&typeof n=="object"&&!Array.isArray(n)}r($0,"is_plain_object");function Is(n=[],e=[]){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,i=0,o=1e-8;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],i+=e[a]*e[a];return s=Math.sqrt(s),i=Math.sqrt(i),s<o||i<o?0:t/(s*i)}r(Is,"cos_sim");function Ae(n,e,t=null){if(!e)return"";let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);return o&&typeof o[i]=="function"?o[i].bind(o):o?o[i]:void 0}r(Ae,"get_by_path");function Se(n,e,t,s=null){let i=e.split(".");s&&i.unshift(s);let o=i.pop(),a=i.reduce((c,l)=>((!c[l]||typeof c[l]!="object")&&(c[l]={}),c[l]),n);a[o]=t}r(Se,"set_by_path");function Uh(n,e,t=null){let s=e.split(".");t&&s.unshift(t);let i=s.pop(),o=s.reduce((a,c)=>a&&a[c],n);o&&delete o[i]}r(Uh,"delete_by_path");function Wh(n){if(!n||n.length===0)return null;let e=n.length,t=n[0].length,s=new Float64Array(t);for(let i=0;i<e;i++){let o=n[i];for(let a=0;a<t;a++)s[a]+=o[a]}for(let i=0;i<t;i++)s[i]/=e;return Array.from(s)}r(Wh,"compute_centroid");function Gh(n){if(!n||n.length===0)return null;if(n.length===1)return n[0];let e=n.length,t=n[0].length,s=new Float64Array(e);for(let a=0;a<e-1;a++){let c=n[a];for(let l=a+1;l<e;l++){let d=n[l],_=0;for(let p=0;p<t;p++){let f=c[p]-d[p];_+=f*f}let m=Math.sqrt(_);s[a]+=m,s[l]+=m}}let i=0,o=s[0];for(let a=1;a<e;a++)s[a]<o&&(o=s[a],i=a);return n[i]}r(Gh,"compute_medoid");var Jd=class{static{r(this,"SettingGroupPolyfill")}constructor(e){this.components=[],this.groupEl=e.createDiv("setting-group"),this.headerEl=this.groupEl.createDiv("setting-item setting-item-heading"),this.headerInnerEl=this.headerEl.createDiv("setting-item-name"),this.controlEl=this.headerEl.createDiv("setting-item-control"),this.listEl=this.groupEl.createDiv("setting-items")}setHeading(e){this.headerInnerEl.setText(e)}addSetting(e){let t=new ti.Setting(this.listEl);return this.components.push(t),e(t),t}addClass(e){this.groupEl.addClass(e)}};function si(n,e,t,s={}){let{default_group_name:i="Settings"}=s;n=T0(n,e);let o=Object.entries(n||{}).reduce((c,[l,d])=>{let _=d.group||i;return c[_]||(c[_]={}),c[_][l]=d,c},{[i]:{}});return Object.entries(o).sort(([c],[l])=>c===i?-1:l===i?1:0).filter(([,c])=>Object.keys(c).length>0).map(([c,l])=>{let d=t.createDiv(),_={...s,...s.group_params?.[c]||{}};return HT(c,e,l,d,_)})}r(si,"render_settings_config");function HT(n,e,t,s,i={}){let o;try{let l=require("obsidian");l.SettingGroup?o=l.SettingGroup:o=Jd}catch{o=Jd}t=T0(t,e);let{heading_btn:a=null}=i,c=new o(s);if(a&&typeof a=="object")if(Array.isArray(a))for(let l of a)j0(c,e,l);else j0(c,e,a);c.setHeading(n);for(let[l,d]of Object.entries(t)){if(!d||typeof d!="object"){console.warn(`Invalid setting config for ${l}:`,d);continue}let _=d.scope_class==="pro-setting",m=!!e.env?.is_pro;c.addSetting(p=>{switch(d.name&&p.setName(d.name),p.setClass(l.replace(/[^a-zA-Z0-9]/g,"-")),d.type&&p.setClass(`setting-type-${d.type}`),d.description&&p.setDesc(d.description),d.type){case"button":p.addButton(f=>{f.setButtonText(d.name||"Run"),f.onClick(async y=>{typeof d.callback=="function"&&await ei(p,y,d.callback,{scope:e})})});break;case"toggle":p.addToggle(f=>{f.setValue(Ae(e.settings,l)||!1),f.onChange(y=>{Se(e.settings,l,y),typeof d.callback=="function"&&ei(p,y,d.callback,{scope:e})})});break;case"text":p.addText(f=>{f.setValue(String(Ae(e.settings,l)||"")),f.onChange(y=>{Se(e.settings,l,y)})});break;case"number":p.addText(f=>{f.setValue(String(Ae(e.settings,l)||"")),f.inputEl.setAttribute("type","number"),f.onChange(y=>{let g=Number(y);isNaN(g)||Se(e.settings,l,g),typeof d.callback=="function"&&ei(p,g,d.callback,{scope:e})})});break;case"dropdown":p.addDropdown(f=>{let y=d.options_callback;typeof y=="function"&&y.call(e,e).forEach(v=>{let k=v.label||v.name||v.value;f.addOption(v.value,k)}),f.setValue(Ae(e.settings,l)||""),f.onChange(g=>{Se(e.settings,l,g),typeof d.callback=="function"&&ei(p,g,d.callback,{scope:e})})});break;case"textarea":p.addTextArea(f=>{f.setValue(String(Ae(e.settings,l)||"")),f.onChange(y=>{if(_&&!m){new ti.Notice("Nice try! This is a PRO feature. Please upgrade to access this setting.");return}Se(e.settings,l,y)}),_&&!m&&f.setDisabled(!0)});break;case"slider":p.addSlider(f=>{let y=d.min||0,g=d.max||100,v=d.step||1;f.setLimits(y,g,v),f.setValue(Ae(e.settings,l)||y),f.setDynamicTooltip(),f.onChange(k=>{Se(e.settings,l,k),typeof d.callback=="function"&&ei(p,k,d.callback,{scope:e})})});break;case"heading":p.setHeading();break;case"html":d.value&&p.descEl.replaceChildren(document.createRange().createContextualFragment(d.value));break;default:console.warn(`Unsupported setting type for ${l}:`,d.type);break}d.scope_class&&p.settingEl.addClass(d.scope_class)})}return c}r(HT,"render_settings_group");function j0(n,e,t){let s=n.controlEl.createEl("button",{cls:""});t.btn_icon&&(0,ti.setIcon)(s,t.btn_icon),t.btn_text&&s.setText(t.btn_text),t.label&&s.setAttr("aria-label",t.label),s.addEventListener("click",async i=>{typeof t.callback=="function"?await ei(null,i,t.callback,{scope:e}):console.warn("No callback defined for heading button")}),n.controlEl.appendChild(s)}r(j0,"render_heading_button");async function ei(n,e,t,s={}){let{scope:i=null}=s;return i?await t.call(i,e,n):await t(e,n)}r(ei,"handle_config_callback");function T0(n,e){try{typeof n=="function"&&(n=n(e))}catch(t){console.error("Error evaluating settings_config function:",t),n={error:{name:"Error",description:`Failed to load settings. ${t.message} (logged to console)`}}}return n}r(T0,"ensure_settings_config");var N0=require("obsidian");function Jt(n){n.settings||(n.settings={}),n.settings.smart_sources||(n.settings.smart_sources={});let e=n.settings.smart_sources;return e.folder_exclusions||(e.folder_exclusions=""),e.file_exclusions||(e.file_exclusions=""),e}r(Jt,"ensure_smart_sources_settings");function Kt(n=""){return n.split(",").map(e=>e.trim()).filter(Boolean)}r(Kt,"parse_exclusions_csv");function Kd(n,e){let t=(e??"").trim();if(!t)return n||"";let s=Kt(n);return s.includes(t)||s.push(t),s.join(",")}r(Kd,"add_exclusion");function Vd(n,e){let t=(e??"").trim();return t?Kt(n).filter(i=>i!==t).join(","):n?.trim()||""}r(Vd,"remove_exclusion");var Xd=class extends N0.FuzzySuggestModal{static{r(this,"ExcludedFoldersFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a folder to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Jt(this.env),t=Kt(e.folder_exclusions);return(this.env.smart_sources?.fs?.folder_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Jt(this.env);t.folder_exclusions=Kd(t.folder_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Jt(this.env),t=Kt(e.folder_exclusions),s=this.modalEl.querySelector(".sc-excluded-folders-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-folders-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded folders"),!t.length){s.createEl("p").setText("No folders excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-folder-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-folder-btn"}).addEventListener("click",()=>{e.folder_exclusions=Vd(e.folder_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};var P0=require("obsidian");var Yd=class extends P0.Modal{static{r(this,"ExcludedSourcesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Excluded Sources"),this.contentEl.addClass("excluded-sources-modal"),this.render_excluded_list()}async render_excluded_list(){this.contentEl.empty();let e=this.contentEl.createEl("ul"),t=this.env.smart_sources.excluded_file_paths,s=this.app.vault.getMarkdownFiles().filter(o=>o.path.length>200).map(o=>o.path);for(let o of t)e.createEl("li").setText(o);this.contentEl.createEl("hr"),this.contentEl.createEl("h3",{text:"Paths too long to import into Smart Environment"});let i=this.contentEl.createEl("ul",{cls:"too-long-exclusions"});for(let o of s)i.createEl("li").setText(o)}};async function JT(n,e={}){return`
<div class="sources-settings">
</div>
`}r(JT,"build_html");async function I0(n,e={}){let t=await JT.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return KT.call(this,n,i,e),i}r(I0,"render");async function KT(n,e,t={}){si({folder_exclusions:Jh,view_exclusions:Kh,re_import_sources:Vh},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",Hh(n,e))),this.attach_disposer(e,i),e}r(KT,"post_process");function Hh(n,e){return async t=>{if(t.collection_key!=="embedding_models")return;let s=e.querySelector(".re-import-sources");s.classList.add("env-setting-highlight");let i=s.querySelector(".reimport-notice")?s.querySelector(".reimport-notice"):s.createEl("div",{cls:"reimport-notice env-setting-note"});i.textContent="Embedding model changed. Please re-import your sources to update their embeddings.",s.appendChild(i),n.events.once("sources:reimported",()=>{s.classList.remove("env-setting-highlight"),i.remove()})}}r(Hh,"highlight_reset_data");var Jh={type:"button",name:"Manage excluded folders",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",callback:r(async function(n,e){let t=this,s=new Xd(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")},Kh={type:"button",name:"View all exclusions",description:"View all excluded sources.",btn_text:"Show",callback:r(async function(n,e){let t=this;new Yd(t.main.app,t).open()},"callback")},Vh={type:"button",name:"Reset data",description:"Clear sources data and re-import.",btn_text:"Re-import sources",callback:r(async function(n,e){let t=this,s=e.controlEl,i=s.createEl("div",{cls:"sc-inline-confirm-row"}),o=s.querySelector("button");o.style.display="none",i.setText("Are you sure you want to clear all sources data? This cannot be undone.");let a=i.createEl("button",{text:"Cancel"}),c=i.createEl("button",{text:"Re-import",cls:"mod-warning"});c.addEventListener("click",async l=>{a.style.display="none",c.textContent="Re-importing...",c.disabled=!0;let d=l.target.closest(".sc-inline-confirm-row");await t.smart_sources.run_clear_all();let _=Date.now();t.smart_sources.unload(),t.smart_blocks.unload(),await t.init_collections(),await t.load_collections(),await t.smart_sources.process_embed_queue();let m=Date.now();t.events?.emit("sources:reimported",{time_ms:m-_}),t.main.notices?.show("reload_sources",{time_ms:m-_}),d.style.display="none",o.style.display="inline-block",c.textContent="Yes",c.disabled=!1}),a.addEventListener("click",l=>{i.style.display="none",o.style.display="inline-block"},{once:!0})},"callback")};var M0=require("obsidian");var ni=class extends M0.FuzzySuggestModal{static{r(this,"ExcludedFilesFuzzy")}constructor(e,t){super(e),this.env=t,this.setPlaceholder("Select a file to exclude...")}open(e){this.callback=e,super.open(),this.render_excluded_list()}getItems(){let e=Jt(this.env),t=Kt(e.file_exclusions);return(this.env.smart_sources?.fs?.file_paths||[]).filter(i=>!t.includes(i))}getItemText(e){return e}onChooseItem(e){if(this.prevent_close=!0,!e)return;let t=Jt(this.env);t.file_exclusions=Kd(t.file_exclusions,e),this.render_excluded_list(),this.updateSuggestions(),this.callback?.()}render_excluded_list(){if(!this.modalEl)return;let e=Jt(this.env),t=Kt(e.file_exclusions),s=this.modalEl.querySelector(".sc-excluded-files-header");if(s||(s=this.modalEl.createEl("div",{cls:"sc-excluded-files-header"}),this.modalEl.prepend(s)),s.empty(),s.createEl("h3").setText("Excluded files"),!t.length){s.createEl("p").setText("No files excluded yet.");return}let o=s.createEl("ul");t.forEach(a=>{let c=o.createEl("li",{cls:"excluded-file-item"});c.setText(a+"  "),c.createEl("button",{text:"(x)",cls:"remove-excluded-file-btn"}).addEventListener("click",()=>{e.file_exclusions=Vd(e.file_exclusions,a),this.env.update_exclusions?.(),this.render_excluded_list(),this.updateSuggestions()})})}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}};async function VT(n,e={}){return`
<div class="sources-pro-settings">
</div>
`}r(VT,"build_html");async function L0(n,e={}){let t=await VT.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return XT.call(this,n,i,e),i}r(L0,"render");async function XT(n,e,t={}){si({folder_exclusions:Jh,file_exclusions:YT,view_exclusions:Kh,re_import_wait_time:{type:"number",name:"Re-import wait time",description:"Time in seconds to wait before re-importing a file after modification.",scope_class:"pro-setting"},"smart_blocks.embed_blocks":{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Embedding allows more granular results in semantic lookups.",scope_class:"pro-setting"},"smart_sources.min_chars":{name:"Minimum length to embed (Sources)",type:"number",description:"Minimum number of characters a source must have to be embedded.",scope_class:"pro-setting"},"smart_blocks.min_chars":{name:"Minimum length to embed (Blocks)",type:"number",description:"Minimum number of characters a block must have to be embedded.",scope_class:"pro-setting"},re_import_sources:Vh},n,e,{default_group_name:"Sources",heading_btn:{btn_icon:"help-circle",callback:r((o,a)=>{window.open("https://smartconnections.app/smart-environment/settings/?utm_source=source-settings","_external")},"callback")}});let i=[];return i.push(n.events?.on("model:changed",Hh(n,e))),this.attach_disposer(e,i),e}r(XT,"post_process");var YT={type:"button",name:"Manage excluded files",description:"Manage the list of folders excluded from processing.",btn_text:"Manage folders",scope_class:"pro-setting",callback:r(async function(n,e){let t=this,s=new ni(t.main.app,t),i=r(()=>{t.update_exclusions()},"selection_callback");s.open(i)},"callback")};async function ZT(n,e={}){return`
<div class="setting-component pro-setting">
<div class="setting-item">
<div class="info setting-item-info">
<div class="setting-item-name">Excluded files</div>
<div class="setting-item-description">Manage files to exclude from the environment.</div>
</div>
<div class="control setting-item-control">
<button class="sc-add-excluded-file-btn" type="button">Edit excluded files</button>
</div>
</div>
</div>
`}r(ZT,"build_html");async function z0(n,e={}){let t=await ZT.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return QT.call(this,n,i,e),i}r(z0,"render");async function QT(n,e,t={}){let s=e.querySelector(".sc-add-excluded-file-btn");return s&&s.addEventListener("click",()=>{new ni(n.main.app,n).open(()=>{n.update_exclusions()})}),e}r(QT,"post_process");var Zd={collections:{bases_caches:p0,chat_completion_models:f0,ranking_models:b0,smart_blocks:O0},item_types:{ChatCompletionModel:Ns,RankingModel:Ps},items:{chat_completion_model:{class:Ns},ranking_model:{class:Ps}},modules:{},components:{settings_env_sources:{render:L0},settings_sources_file_exclusions:{render:z0}},actions:{}};function Qd(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(Qd,"collection_instance_name_from");function Ms(n={},e={}){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&(D0(e[t])&&D0(n[t])?Ms(n[t],e[t]):n[t]=e[t]);return n}r(Ms,"deep_merge");function D0(n){return n&&typeof n=="object"&&!Array.isArray(n)}r(D0,"is_plain_object");function R0(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(R0,"create_uid");function F0(n=""){return n.replace(/([A-Z])/g,e=>`_${e.toLowerCase()}`).replace(/^_/,"").replace(/2$/,"")}r(F0,"camel_case_to_snake_case");function e_(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>e_(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>e_(n[o],e[o],t))}return n===e}r(e_,"deep_equal");function B0(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(B0,"get_item_display_name");function t_(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let b of Reflect.ownKeys(u)){let j=Object.getOwnPropertyDescriptor(u,b);if(!j)continue;let x={...j};"value"in x&&s(x.value)&&(x.value=d(x.value));try{Object.defineProperty(h,b,x)}catch{h[b]=x.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let b=!1;for(let j of h){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x){let $=x.value;if(c($)){b=!0;continue}if(s($)){if(_($)){b=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return b},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),b=new Map;for(let j of Reflect.ownKeys(u)){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x&&_(x.value)){b.set(j,d(x.value));continue}try{Object.defineProperty(h,j,m(x))}catch{h[j]=x.value}}}return{global_source:h,scoped_sources:b}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),v=Object.create(null),k=r((u,h,b=[])=>{if(!u||!h)return;let j=new Set([...l,...b]);for(let x of Reflect.ownKeys(u)){if(j.has(x))continue;let $=Object.getOwnPropertyDescriptor(u,x);if($)try{Object.defineProperty(h,x,$)}catch{h[x]=$.value}}},"copy_metadata"),w=r(u=>{let h=new u(n),b=h.action||h.run||h.execute||h.call;if(i(b)){let j=b.bind(h);return k(u,j),k(h,j),j.instance=h,j}return k(u,h),h},"instantiate_class"),q=r(u=>{if(o(u))return w(u);if(a(u)){let h=u.action.bind(n);return k(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return k(u,h),h}return s(u)?d(u):u},"bind_or_clone"),E=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),S=r((u,h,b)=>(u[h]=b,b),"cache_result"),C=r((u,h)=>{let b=E();return b&&g(b,h)?S(u,h,q(b[h])):g(f,h)?S(u,h,q(f[h])):S(u,h,void 0)},"compute_and_cache"),O=r(()=>{let u=E(),h=new Set(Reflect.ownKeys(v));for(let b of Reflect.ownKeys(f))h.add(b);if(u)for(let b of Reflect.ownKeys(u))h.add(b);return Array.from(h)},"union_keys"),A=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(v,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:C(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let b=E();return b&&g(b,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return A(u,h);let b=E();if(b&&g(b,h)||g(f,h))return g(u,h)||C(u,h),A(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,b)=>"value"in b?(u[h]=b.value,!0):!1,"defineProperty"),set:r((u,h,b)=>(u[h]=b,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(t_,"create_actions_proxy");var Ls=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&Ms(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return R0(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return Ms(s,t),!e_(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=t_(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Qd(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),Qd(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),F0(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return B0(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var eN=Object.getPrototypeOf(async function(){}).constructor,zs=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof eN?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return Ms(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=t_(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var s_=class extends Ls{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var _e=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var n_=class extends _e{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var i_=class extends _e{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var U0=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var o_=class extends _e{static{r(this,"ImageContextItemAdapter")}static detect(e){return U0.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var r_=class extends _e{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var Xh=class extends zs{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},vr={version:1,class:Xh,collection_key:"context_items",item_type:s_,context_item_adapters:{BlockContextItemAdapter:n_,SourceContextItemAdapter:i_,ImageContextItemAdapter:o_,PdfContextItemAdapter:r_}};var W0=P(require("node:fs/promises"),1),G0=P(require("node:fs"),1),a_=P(require("node:path"),1);var c_=class extends _e{static{r(this,"ExternalContextItemAdapter")}static detect(e){return e.startsWith("external:")?"external":!1}get path(){return this.item.key.replace(/^external(-folder)?:/,"")}async get_text(){let t=(this.item.env?.smart_context_plugin?.app||window.app).vault.adapter.basePath,s=a_.default.join(t,this.path);try{return await W0.default.readFile(s,"utf8")}catch(i){return console.error(`ExternalContextItemAdapter: Error reading file at ${s}`,i),{error:`Error reading file at ${this.path}: ${i.message}`}}}async open(){let t=(this.item.env?.smart_context_plugin?.app||window.app).vault.adapter.basePath,s=a_.default.join(t,this.path);tN(s)}get exists(){let e=this.item.env.smart_context_plugin.app.vault.adapter.basePath,t=a_.default.join(e,this.path);return G0.default.existsSync(t)}};function tN(n){try{let{shell:e}=window.require("electron");e.openPath(n)}catch(e){console.error("shell.openPath failed",e)}}r(tN,"open_external");var l_=/!\[\[\s*([^\]\|#]+\.base)\s*(#[^\]\|]+)?\s*(?:\|\s*[^\]]*)?\s*\]\]/g,sN=r(n=>Object.values(n.data?.outlinks||{}).some(e=>e.target.includes(".base")),"has_base_outlink"),nN=r((n,e={})=>{let{file_path:t,cache:s}=e;return!n||!s||!t||(l_.lastIndex=0,!l_.test(n))?n:(l_.lastIndex=0,n.replace(l_,(i,o,a="")=>{let c=`${t}#${o}${a}`;return s?.[c]?.markdown_table?.trim?.()||i}))},"render_bases_embeds"),d_=class extends _e{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){let e=await this.ref?.read();if(!e)return"MISSING SOURCE";let t=this.env?.bases_caches?.items;return!sN(this.ref)||!t?e:nN(e,{file_path:this.ref?.path||this.item.key,cache:t})}async open(e=null){this.ref.actions.source_open(e)}};vr.context_item_adapters.SourceContextItemAdapter=d_;vr.version=2;vr.context_item_adapters.ExternalContextItemAdapter=c_;var H0=vr;var __=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=kr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},kr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var u_=class extends __{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=wr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},wr=class extends kr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var J0={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},m_=class extends u_{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=p_;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},p_=class extends wr{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,v=new g(this.env,d);v._queue_load=!1,v.loaded_at=Date.now(),f.set(v)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return J0[s]&&(s=J0[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};function Yh(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():K0(a)?n[o]=Yh(K0(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(Yh,"ajson_merge");function K0(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(K0,"is_object");var V0={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function iN(n){let e=!1,[t,...s]=n.split(":");return V0[t]&&(t=V0[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(iN,"_parse_ajson_key");var xr=class extends m_{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:v}=iN(p),k=`${y}:${g}`;f?(i[k]=f,(v||k!==p)&&(delete i[p],t=!0)):(delete i[k],(v||k!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=Yh(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}};function X0(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(X0,"filter_redundant_context_items");var Er=class extends Ls{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e){!e||!this.data?.context_items?.[e]||(this.data.context_items[e].folder?this.data.context_items[e].exclude=!0:delete this.data.context_items[e],this.queue_save(),this.emit_event("context:updated",{removed_key:e}))}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this.on_event("context:updated",()=>{this._context_items=null})}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return X0(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var ii=class extends zs{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var oN={class:ii,data_adapter:xr,item_type:Er};var h_=oN;var Zh=class extends ii{static{r(this,"SmartContexts")}async process_load_queue(){await super.process_load_queue(),Object.entries(this.items).forEach(([e,t])=>{e.endsWith("#codeblock")&&t.delete()}),this.process_save_queue()}};h_.class=Zh;h_.version="3.0.0";var Y0=h_;var Z0=`.sc-context-codeblock-container {\r
background-color: var(--code-background);\r
.cb-actions {\r
display: flex;\r
align-items: center;\r
gap: 8px;\r
padding: 8px;\r
width: 100%;\r
}\r
.cb-actions > .sc-codeblock-help {\r
margin-left: auto; /* justifty at the end */\r
margin-right: var(--size-4-8);\r
}\r
}`;var Q0=require("obsidian");function aN(n,e={}){return`<div>
<div class="sc-context-codeblock-container">
<div class="cb-actions">
<button class="sc-add-external" type="button">Edit context</button>
<button class="sc-copy-clipboard" type="button" style="display:none;">Copy to clipboard</button>
<div class="cb-meta"></div>
<button class="sc-codeblock-help"></button>
</div>
</div>
</div>`}r(aN,"build_html");async function eE(n,e={}){this.apply_style_sheet(Z0);let t=aN.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".sc-context-codeblock-container");return cN.call(this,n,i,e),i}r(eE,"render");async function cN(n,e,t={}){let s=e.querySelector(".cb-meta"),i=r(async()=>{this.empty(s),s.appendChild(await n.env.render_component("smart_context_meta",n,{...t}))},"render_ctx_meta");e.querySelector(".sc-add-external").addEventListener("click",()=>{n.emit_event("context_selector:open",{default_suggest_action_keys:["context_suggest_external"]})});let a=e.querySelector(".sc-copy-clipboard");n.has_context_items&&(a.style.display="inline-block",a.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()}));let c=e.querySelector(".sc-codeblock-help");(0,Q0.setIcon)(c,"help-circle"),c.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/codeblock/?utm_source=codeblock-help","_external")}),i();let l=[];return l.push(n.on_event("context:updated",async()=>{i()})),this.attach_disposer(e,l),e}r(cN,"post_process");function lN(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(lN,"build_html");async function tE(n,e={}){let t=lN(),i=this.create_doc_fragment(t).firstElementChild;return dN.call(this,n,i,e),i}r(tE,"render");async function dN(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o),yp(n,o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),_h(n,a),_N(n,a),uN(n,a),uh(n,a),mh(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(dN,"post_process");var sE="3.0.0";function _N(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.setAttribute("aria-label","Copies an image with copiled media to clipboard"),t.textContent="Copy media",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard({with_media:!0})})}r(_N,"render_btn_copy_text");function uN(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.setAttribute("aria-label","Copies text to clipboard"),t.textContent="Copy text",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard({with_media:!1})})}r(uN,"render_btn_copy_with_media");var Re=require("obsidian");async function oE(n={}){let e=this.context_items.filter(n.filter);if(!e.length){this.emit_event("notification:warning",{message:"No context items to copy."}),new Re.Notice("No context items to copy.");return}let t=await this.get_text(n),s=typeof t=="string"?t:String(t??""),i={item_count:e.length,char_count:s.length};if(!n.with_media){if(!await Sr(s)){this.emit_event("notification:error",{message:"Failed to copy context to clipboard."}),new Re.Notice("Failed to copy context to clipboard.");return}Ar(i),this.emit_event("context:copied");return}let o=[];try{o=await this.get_media(n),Array.isArray(o)||(o=[])}catch(d){console.error("context_copy_to_clipboard: get_media failed",d),o=[]}let a=yN(s,o);if(!o.length){if(!await Sr(a)){this.emit_event("notification:error",{message:"Failed to copy context (text-only) to clipboard."}),new Re.Notice("Failed to copy context (text-only) to clipboard.");return}Ar({...i,char_count:a.length}),this.emit_event("context:copied");return}if(typeof document>"u"||!document.createElement){if(console.warn("copy_to_clipboard(with_media): no DOM/canvas available; falling back to text-only"),!await Sr(a)){this.emit_event("notification:error",{message:"Failed to copy context (text-only) to clipboard."}),new Re.Notice("Failed to copy context (text-only) to clipboard.");return}Ar({...i,char_count:a.length}),this.emit_event("context:copied");return}let c;try{c=await mN(o)}catch(d){if(console.error("copy_to_clipboard(with_media): failed to build context canvas",d),!await Sr(a)){this.emit_event("notification:error",{message:"Failed to copy context (text-only) to clipboard."}),new Re.Notice("Failed to copy context (text-only) to clipboard.");return}Ar({...i,char_count:a.length}),this.emit_event("context:copied");return}if(!await fN(c,a)){this.emit_event("notification:error",{message:"Failed to copy context image to clipboard."}),new Re.Notice("Failed to copy context image to clipboard.");return}Ar({...i,char_count:a.length}),this.emit_event("context:copied"),this.emit_event("context:copied_with_media")}r(oE,"copy_to_clipboard");async function mN(n){let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("Canvas 2D context not available");let s=24,i=1200,o=18,a='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',c='bold 13px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';e.width=i,e.height=s*2+o*2;let{image_entries:l,other_entries:d}=await hN(n),_=l.length>0||d.length>0,m=0;_&&(m=o+d.length*o);let p=null;l.length>0&&(t.font=a,p=pN(l,{canvas_width:i,padding:s,heading_height:m,line_height:o,ctx:t,base_font:a}));let f;p?f=p.total_height:_?f=s+m+s:f=s*2+o,e.height=Math.max(f,s*2+o),t.fillStyle="#ffffff",t.fillRect(0,0,e.width,e.height),t.fillStyle="#000000",t.textBaseline="top";let y=s;if(_){t.font=c,t.fillText("Attachments",s,y),y+=o,t.font=a;for(let g of d){let k=`- ${Qh(g.key||g.name||"",80)} (${g.mime_type})`;t.fillText(k,s,y),y+=o}}if(p&&p.placements&&p.placements.length>0){t.font=a;for(let g of p.placements){let{entry:v,x:k,label_y:w,image_y:q,width:E,height:S,label_lines:C}=g;for(let O=0;O<C.length;O+=1){let A=w+O*o;t.fillText(C[O],k,A)}v.image&&E>0&&S>0&&t.drawImage(v.image,k,q,E,S)}}return e}r(mN,"build_context_canvas");function nE(n,e){let s=n.natural_width||n.image?.naturalWidth||n.image?.width||e,i=n.natural_height||n.image?.naturalHeight||n.image?.height||e*.75;if(!(s>0)||!(i>0))return{width:Math.max(1,Math.floor(e)),height:Math.max(1,Math.floor(e*.75))};let o=Math.min(1,e/s),a=Math.max(1,Math.floor(s*o)),c=Math.max(1,Math.floor(i*o));return{width:a,height:c}}r(nE,"compute_scaled_dimensions");function pN(n,e){let{canvas_width:t,padding:s,heading_height:i,line_height:o,ctx:a,base_font:c}=e||{};if(!Array.isArray(n)||n.length===0||!a)return null;let l=16,d=16,_=t-s*2,m=220,p=n.length;if(!(_>0))return null;let f=Math.max(1,Math.floor((_+l)/(m+l))),y=Math.min(p,f,6),g=s+i;a.font=c||a.font||"12px monospace",a.textBaseline="top";let v=4,k=null;for(let C=1;C<=y;C+=1){let O=Math.floor((_-(C-1)*l)/C);if(!(O>0))continue;let A=new Array(C).fill(0);for(let j of n){let x=nE(j,O),$=j.key||j.name||"image",T=Qh($,80),{height:N}=iE(a,T,x.width,o,v),Y=0;for(let H=1;H<C;H+=1)A[H]<A[Y]&&(Y=H);A[Y]+=N+x.height+d}let u=Math.max(0,...A),h=g+u+s,b=Math.abs(h-t);(!k||b<k.diff||b===k.diff&&h<k.total_height)&&(k={cols:C,cell_width:O,gap_x:l,row_gap:d,top_y:g,image_area_height:u,total_height:h,diff:b})}if(!k)return null;let w=[],q=new Array(k.cols).fill(0);for(let C of n){let O=nE(C,k.cell_width),A=C.key||C.name||"image",u=Qh(A,80),{lines:h,height:b}=iE(a,u,O.width,o,v),j=0;for(let H=1;H<k.cols;H+=1)q[H]<q[j]&&(j=H);let x=q[j],T=s+j*(k.cell_width+k.gap_x)+Math.floor((k.cell_width-O.width)/2),N=k.top_y+x,Y=N+b;w.push({entry:C,col:j,x:T,label_y:N,image_y:Y,width:O.width,height:O.height,label_lines:h}),q[j]+=b+O.height+k.row_gap}let E=Math.max(0,...q),S=Math.ceil(p/k.cols);return{cols:k.cols,rows:S,cell_width:k.cell_width,gap_x:k.gap_x,row_gap:k.row_gap,top_y:k.top_y,image_area_height:E,total_height:k.top_y+E+s,placements:w}}r(pN,"compute_best_image_layout");async function hN(n){let e=[],t=[],s=[],i=1;for(let o of n||[]){if(!o||typeof o!="object")continue;let a=typeof o.url=="string"?o.url:"";if(!a)continue;let c=aE(a)||"application/octet-stream",l=typeof o.key=="string"?o.key:"",d=o.name||cE(l,c)||`attachment-${i}`,_=l||d,m=c.startsWith("image/");if((c==="application/pdf"||o.type==="pdf_url")&&a.startsWith("data:")){s.push((async()=>{try{if(typeof Re.loadPdfJs!="function")throw new Error("loadPdfJs not available");let g=await(0,Re.loadPdfJs)(),k=await rE(a).arrayBuffer(),w=new Uint8Array(k),q=await g.getDocument({data:w}).promise,E=q.numPages||0;if(!E)throw new Error("PDF has no pages");for(let C=1;C<=E;C+=1)try{let O=await q.getPage(C),A=O.getViewport({scale:1.5}),u=document.createElement("canvas"),h=u.getContext("2d");if(!h)throw new Error("Canvas 2D context not available for PDF");u.width=A.width,u.height=A.height,await O.render({canvasContext:h,viewport:A}).promise;let b=u.toDataURL("image/png"),j=new Image;j.src=b;let x=E>1?` (p${C})`:"",$={key:_+x,name:d+x,mime_type:c,url:b,image:j,natural_width:u.width,natural_height:u.height};e.push($),await new Promise(T=>{j.onload=()=>T(),j.onerror=()=>{let N=e.indexOf($);N!==-1&&e.splice(N,1),T()}})}catch(O){console.warn("normalize_media_for_canvas: failed to render PDF page",C,_,O)}e.some(C=>!C||!C.key?!1:C.key===_?!0:C.key.startsWith(_+" (p"))||t.push({key:_,name:d,mime_type:c})}catch(g){console.warn("normalize_media_for_canvas: failed to render PDF via loadPdfJs",g),t.push({key:_,name:d,mime_type:c})}})()),i+=1;continue}if(!m||!a.startsWith("data:")){t.push({key:_,name:d,mime_type:c}),i+=1;continue}let f=new Image;f.src=a;let y={key:_,name:d,mime_type:c,url:a,image:f,natural_width:0,natural_height:0};e.push(y),i+=1,s.push(new Promise(g=>{f.onload=()=>{try{y.natural_width=f.naturalWidth||f.width||0,y.natural_height=f.naturalHeight||f.height||0}catch{let k=e.indexOf(y);k!==-1&&e.splice(k,1),t.push({key:_,name:d,mime_type:c})}g()},f.onerror=()=>{let v=e.indexOf(y);v!==-1&&e.splice(v,1),t.push({key:_,name:d,mime_type:c}),g()}}))}return await Promise.all(s),{image_entries:e,other_entries:t}}r(hN,"normalize_media_for_canvas");async function fN(n,e){if(!n)return!1;try{if(typeof navigator<"u"&&navigator.clipboard&&typeof navigator.clipboard.write=="function"&&typeof ClipboardItem<"u"){let t=await gN(n);if(t){let s={[t.type]:t};typeof Blob<"u"&&(s["text/plain"]=new Blob([e],{type:"text/plain"}));let i=new ClipboardItem(s);return await navigator.clipboard.write([i]),!0}}}catch(t){console.warn("copy_canvas_with_fallback: navigator.clipboard.write failed",t)}try{if(typeof window<"u"&&typeof window.require=="function"){let t=n.toDataURL("image/png"),{clipboard:s,nativeImage:i}=window.require("electron");if(s&&i){let o=i.createFromDataURL(t);return typeof s.write=="function"?s.write({image:o,text:e}):typeof s.writeImage=="function"&&(s.writeImage(o),typeof s.writeText=="function"&&s.writeText(e)),!0}}}catch(t){console.warn("copy_canvas_with_fallback: electron clipboard.write failed",t)}return await Sr(e)}r(fN,"copy_canvas_with_fallback");function gN(n){return new Promise((e,t)=>{if(!n)return t(new Error("Canvas is null"));if(typeof n.toBlob=="function"){n.toBlob(s=>{s?e(s):t(new Error("canvas.toBlob returned null"))},"image/png");return}try{let s=n.toDataURL("image/png"),i=rE(s);e(i)}catch(s){t(s)}})}r(gN,"get_canvas_blob");function rE(n){let e=/^data:([^;]+);base64,(.+)$/.exec(n);if(!e)throw new Error("Invalid data URL");let t=e[1],s=e[2],i="";if(typeof atob=="function")i=atob(s);else if(typeof Buffer<"u")i=Buffer.from(s,"base64").toString("binary");else throw new Error("No base64 decoder available");let o=i.length,a=new Uint8Array(o);for(let c=0;c<o;c++)a[c]=i.charCodeAt(c);return new Blob([a],{type:t})}r(rE,"data_url_to_blob");async function Sr(n){try{if(typeof navigator<"u"&&navigator.clipboard&&typeof navigator.clipboard.writeText=="function")return await navigator.clipboard.writeText(n),!0}catch(e){console.warn("copy_text_to_clipboard: navigator.clipboard.writeText failed",e)}try{if(typeof window<"u"&&typeof window.require=="function"){let{clipboard:e}=window.require("electron");if(e&&typeof e.writeText=="function")return e.writeText(n),!0}}catch(e){console.warn("copy_text_to_clipboard: electron.clipboard.writeText failed",e)}try{if(typeof document<"u"){let e=document.createElement("textarea");e.value=n,e.style.position="fixed",e.style.opacity="0",e.style.pointerEvents="none",document.body.appendChild(e),e.focus(),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}}catch(e){console.warn('copy_text_to_clipboard: execCommand("copy") failed',e)}return!1}r(Sr,"copy_text_to_clipboard");function yN(n,e){let t=[];t.push(n.trimEnd()),t.push(""),t.push("Attachments:");let s=!1;for(let i of e||[]){if(!i||typeof i!="object")continue;let o=typeof i.url=="string"?i.url:"",a=o&&aE(o)||"file",c=i.key||i.name||cE(i.key,a)||"attachment";t.push(`- ${c} (${a})`),s=!0}return s||t.pop(),t.push(""),t.join(`
`)}r(yN,"build_plaintext_with_media");function aE(n){if(typeof n!="string")return null;let e=/^data:([^;]+);base64,/i.exec(n);return e?e[1]:null}r(aE,"extract_mime_type_from_data_url");function cE(n,e){if(typeof n=="string"&&n.trim()){let s=n.split(/[\\/]/),i=s[s.length-1];if(i)return i}return`context.${e.includes("/")?e.split("/")[1]:"bin"}`}r(cE,"derive_name_from_key");function Qh(n,e){let t=String(n??"");if(t.length<=e)return t;if(e<=3)return t.slice(0,e);let s=Math.floor((e-3)/2);return t.slice(0,s)+"..."+t.slice(t.length-s)}r(Qh,"truncate_middle");function iE(n,e,t,s,i=4){let o=String(e??"");if(!o)return{lines:[""],height:s};if(!(t>0))return{lines:[o],height:s};let a=[],c=0,l=o.length;for(;c<l&&a.length<i;){let _=c,m=-1;for(;_<l;){let p=o[_];(p===" "||p==="	"||p==="/"||p==="\\"||p==="-")&&(m=_+1);let f=o.slice(c,_+1);if(n.measureText(f).width>t){if(m>c){let g=o.slice(c,m).trimEnd();g&&a.push(g),c=m}else{let g=o.slice(c,_).trimEnd();g?(a.push(g),c=_):(a.push(o.slice(c,_+1)),c=_+1)}break}_+=1}if(_>=l){let p=o.slice(c).trimEnd();p&&a.push(p),c=l}}if(c<l&&a.length>=i){let _=a.length-1,m=a[_],p="...",f=m+p,y=n.measureText(f).width;if(y<=t)a[_]=f;else{for(;m.length>1&&y>t;)m=m.slice(0,-1),f=m+p,y=n.measureText(f).width;a[_]=f}}return a.length||a.push(o),{lines:a,height:a.length*s}}r(iE,"wrap_text_lines");function Ar(n){let t=`Copied to clipboard! (${`${n.item_count} file(s)`})`;if(n){let s=n.char_count<1e5?n.char_count:`~${Math.round(n.char_count/1e3)}k`;if(t+=`, ${s} chars`,n.exclusions){let i=Object.values(n.exclusions).reduce((o,a)=>o+a,0);i>0&&(t+=`, ${i} section(s) excluded`)}}new Re.Notice(t)}r(Ar,"show_stats_notice");var lE=2;var fe=P(require("path"),1),ef=P(require("fs"),1);var uE=require("obsidian");var mE="Add external sources",tf=5,sf=1e4,bN=[".git","node_modules","package-lock.json",".obsidian",".smart-env"],vN=new Set(bN),kN=3e4,wN=10,Vt=new Map,xN=3e4,EN=10,dE=new WeakMap;function AN(n){let e=Vt.get(n);return e?Date.now()-e.ts>kN?(Vt.delete(n),null):(Vt.delete(n),Vt.set(n,e),e.items):null}r(AN,"get_listing_cache");function SN(n,e){for(Vt.set(n,{ts:Date.now(),items:e});Vt.size>wN;){let t=Vt.keys().next().value;Vt.delete(t)}}r(SN,"set_listing_cache");function pE(n){let e=dE.get(n);if(e)return e;let t=new Map;return dE.set(n,t),t}r(pE,"get_ctx_suggestion_cache");function CN(n,e){let t=pE(n),s=t.get(e);return s?Date.now()-s.ts>xN?(t.delete(e),null):(t.delete(e),t.set(e,s),s.suggestions):null}r(CN,"get_suggestions_cache");function ON(n,e,t){let s=pE(n);for(s.set(e,{ts:Date.now(),suggestions:t});s.size>EN;){let i=s.keys().next().value;s.delete(i)}}r(ON,"set_suggestions_cache");function _E(n,e){let t=n&&n!=="."?n.replace(/\\/g,"/"):"",s=e?e.replace(/\\/g,"/"):"";return t?s?`${t}/${s}`:t:s}r(_E,"join_rel_paths");function qN(n,e,t=0,s=tf,i=!0,o="",a=sf){let c=[];if(t>s)return c;let l=i&&t===0?`${fe.default.normalize(n)}::${fe.default.normalize(e)}::${s}::${a}`:null;if(l){let p=AN(l);if(p)return p}let d=[{dir_path:n,rel_dir:o}],_=t;for(;d.length>0;){let p=[];for(let{dir_path:f,rel_dir:y}of d){let g;try{g=ef.default.readdirSync(f,{withFileTypes:!0})}catch{continue}for(let v of g){if(vN.has(v.name))continue;let k=fe.default.join(f,v.name),w=y?`${y}/${v.name}`:v.name,q=v.isDirectory();!q&&!nl(k)||(c.push({fullPath:k,relativePath:w,isDirectory:q,depth:_+1}),q&&_+1<=s&&p.push({dir_path:k,rel_dir:w}))}}if(c.length>=a){console.log("Too many results, stopping at depth: ",{dir_depth:_,current_level:d,items_length:c.length});break}if(d=p,_+=1,_>s)break}if(!i)return c;let m=c.sort((p,f)=>p.isDirectory&&!f.isDirectory?-1:!p.isDirectory&&f.isDirectory?1:p.depth!==f.depth?p.depth-f.depth:p.relativePath===f.relativePath?0:p.relativePath<f.relativePath?-1:1);return l&&SN(l,m),m}r(qN,"list_dir_files_to_depth");function $N(n,e=tf,t=sf){return qN(n,n,0,e,!0,"",t)}r($N,"get_external_items");function jN(n,e){let t=n.env?.plugin?.app||window.app;return(0,uE.normalizePath)(t.vault.adapter.basePath)}r(jN,"resolve_vault_path");function Cr(n={}){let e=this||{},t=typeof n.max_depth=="number"?n.max_depth:tf,s=typeof n.max_results=="number"?n.max_results:sf,i=jN(e,n);if(!i)return[];let o=n.scope||fe.default.dirname(i);if(!o)return[];let a=fe.default.normalize(i),c=a.endsWith(fe.default.sep)?a.slice(0,-1):a,l=fe.default.normalize(o),d=l.endsWith(fe.default.sep)?l.slice(0,-1):l,_=`${c}::${d}::${t}::${s}`,m=CN(e,_);if(m)return m;let p=$N(o,t,s),f=`${c}${fe.default.sep}`,y=_E(fe.default.relative(c,d),""),g=[],v={key:"up",display:".. (parent folder)",select_action:r(()=>{let q=fe.default.dirname(o),E={...n,scope:q};return Cr.call(e,E)},"select_action")};g.push(v);for(let q of p){if(q.fullPath===c)continue;let E;if(q.fullPath.startsWith(f)?E=q.fullPath.slice(f.length).replace(/\\/g,"/"):E=_E(y,q.relativePath),!E||!q.relativePath)continue;let S=`external:${E}`,C=q.relativePath,O={vault_path:i,relativePath:q.relativePath,vault_relative_path:E,fullPath:q.fullPath,isDirectory:q.isDirectory,show_path:C,is_external:!0,path:S,key:S},A={key:S,display:C||E,item:O};q.isDirectory?(A.icon="folder",A.select_action=({modal:u})=>(u?.inputEl&&(u.inputEl.value=""),w(q)),A.arrow_right_action=({modal:u})=>(u?.inputEl&&(u.inputEl.value=""),w(q)),A.arrow_left_action=()=>k(),A.mod_select_action=()=>{e.add_items(ol(q.fullPath,i,[".*"]))}):A.select_action=()=>{let u=ef.default.statSync(O.fullPath);O.size=u.size,O.mtime=u.mtimeMs,e.add_item(O)},g.push(A)}return ON(e,_,g),g;function k(){let q=fe.default.join(o,".."),E={...n,scope:q};return Cr.call(e,E)}r(k,"goto_parent_folder");function w(q){let E=q.fullPath,S={...n,scope:E};return Cr.call(e,S)}r(w,"show_folder")}r(Cr,"context_suggest_external");var hE={collections:{context_items:H0,smart_contexts:Y0},item_types:{},items:{},modules:{},components:{context_codeblock:{render:eE},smart_context_actions:{render:tE,version:sE}},actions:{context_copy_to_clipboard:{action:oE,version:lE},context_suggest_external:{action:Cr,display_name:mE}}};var TN={modals:{context_selector:{default_suggest_action_keys:["context_suggest_blocks","context_suggest_external"]}}},fE=gt(Qc,gt(Zd,gt(hE,TN)));var Ct=require("obsidian");var f_=class{static{r(this,"SmartEventsAdapter")}constructor(e){this.instance=e,this.handlers=Object.create(null)}on(e,t){}once(e,t){}off(e,t){}emit(e,t){}};var g_=class extends f_{static{r(this,"DefaultEventsAdapter")}constructor(e){super(e),this._next_id=1}on(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:t};return i.push(o),()=>this.off_entry(s,o.id)}once(e,t=()=>{}){let s=e==="*"?"*":e,i=this.handlers[s]||(this.handlers[s]=[]),o={id:this._next_id++,cb:null},a=r((c,l)=>{this.off_entry(s,o.id),t(c,l)},"wrapper");return o.cb=a,i.push(o),()=>this.off_entry(s,o.id)}off(e,t){let s=this.handlers[e];if(!(!s||!t)){for(let i=s.length-1;i>=0;i--)if(s[i].cb===t){s.splice(i,1);break}}}off_entry(e,t){let s=this.handlers[e];if(!s)return;let i=s.findIndex(o=>o.id===t);i!==-1&&s.splice(i,1)}emit(e,t={}){if(e==="*")throw new Error('emit("*") is not allowed; "*" is reserved for wildcard listeners.');let s=this.handlers[e],i=this.handlers["*"];if(!s&&!i)return;let o=s?[...s]:[],a=i?[...i]:[];for(let c=0;c<o.length;c++)o[c].cb(t,e);for(let c=0;c<a.length;c++)a[c].cb(t,e)}};var Ds=class n{static{r(this,"SmartEvents")}constructor(e,t={}){e.create_env_getter(this),this.opts=t}static create(e,t={}){let s=new n(e,t);return Object.getOwnPropertyDescriptor(e,"events")||Object.defineProperty(e,"events",{get:r(()=>s,"get")}),s}get adapter(){return this._adapter||(this._adapter=this.opts.adapter_class?new this.opts.adapter_class(this):new g_(this)),this._adapter}on(e,t=s=>{}){return this.adapter.on(e,t)}once(e,t=s=>{}){return this.adapter.once(e,t)}off(e,t=s=>{}){return this.adapter.off(e,t)}emit(e,t={}){let s={...t};return s.at===void 0&&(s.at=Date.now()),Object.freeze(s),this.adapter.emit(e,s)}};async function NN(n,e={}){let t=Object.entries(n.settings_config).map(([o,a])=>(a.setting||(a.setting=o),this.render_setting_html(a))).join(`
`),s=Object.entries(n.collections).map(([o,a])=>`<div data-smart-settings="${o}"></div>`).join(`
`);return`
<div class="">
${t}
${s}
</div>
`}r(NN,"build_html");async function gE(n,e={}){let t=await NN.call(this,n,e),s=this.create_doc_fragment(t);return await PN.call(this,n,s,e)}r(gE,"render");async function PN(n,e,t={}){await this.render_setting_components(e,{scope:n});let s=e.querySelectorAll("[data-smart-settings]");for(let i of s){let o=i.dataset.smartSettings;await n[o].render_settings(i)}return e}r(PN,"post_process");var y_=class{static{r(this,"SmartSettings")}constructor(e,t={}){this.main=e,this.opts=t,this._fs=null,this._settings={},this._saved=!1,this.save_timeout=null,this.save_delay_ms=typeof t.save_delay_ms=="number"?t.save_delay_ms:1e3}static async create(e,t={}){let s=new this(e,t);return await s.load(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}static create_sync(e,t={}){let s=new this(e,t);return s.load_sync(),e.smart_settings=s,Object.defineProperty(e,"settings",{get(){return s.settings},set(i){s.settings=i}}),s}get settings(){return IN(this._settings,e=>{this.emit_settings_changed(e),this.schedule_save()})}set settings(e){this._settings=e}schedule_save(){this.save_timeout&&clearTimeout(this.save_timeout),this.save_timeout=setTimeout(()=>{this.save(this._settings),this.save_timeout=null},this.save_delay_ms)}emit_settings_changed(e){let t=this.resolve_events_bus();t?.emit&&t.emit("settings:changed",MN(e))}resolve_events_bus(){return this.opts.events?this.opts.events:typeof this.opts.emit=="function"?{emit:this.opts.emit}:this.main?.events?this.main.events:this.main?.env?.events?this.main.env.events:null}async save(e=this._settings){typeof this.opts.save=="function"?await this.opts.save(e):await this.main.save_settings(e)}async load(){typeof this.opts.load=="function"?this._settings=await this.opts.load():this._settings=await this.main.load_settings()}load_sync(){typeof this.opts.load=="function"?this._settings=this.opts.load():this._settings=this.main.load_settings()}};function IN(n,e){let t=new WeakMap,s=new WeakMap,i=r((a,c)=>{if(!of(a)||s.has(a))return a;if(t.has(a))return t.get(a);let l=o(a,c);return t.set(a,l),s.set(l,a),l},"wrap_value"),o=r((a,c)=>new Proxy(a,{set(l,d,_){let m=[...c,d],p=nf(l[d]),f=nf(_);return l[d]=i(_,m),LN(p,f)&&e({type:"set",path:m,value:f,previous_value:p}),!0},get(l,d){let _=l[d];return i(_,[...c,d])},deleteProperty(l,d){if(!Object.prototype.hasOwnProperty.call(l,d))return!0;let _=[...c,d],m=nf(l[d]);return delete l[d],e({type:"delete",path:_,previous_value:m}),!0}}),"create_proxy");return i(n,[])}r(IN,"observe_object");function MN(n){let e=Array.isArray(n.path)?n.path:[];return{type:n.type,path:e,path_string:e.join("."),value:n.value,previous_value:n.previous_value}}r(MN,"build_settings_changed_event");function nf(n){if(!of(n))return n;if(typeof structuredClone=="function")try{return structuredClone(n)}catch{}try{return JSON.parse(JSON.stringify(n))}catch{return n}}r(nf,"snapshot_value");function LN(n,e){return yE(n)!==yE(e)}r(LN,"has_changed");function yE(n){if(n===void 0)return"undefined";if(Number.isNaN(n))return"number:NaN";if(n===1/0)return"number:Infinity";if(n===-1/0)return"number:-Infinity";if(!of(n))return`${typeof n}:${String(n)}`;try{return`object:${JSON.stringify(n)}`}catch{return`object:${String(n)}`}}r(yE,"serialize_value");function of(n){return typeof n=="object"&&n!==null}r(of,"is_observable");function bE(n){return n.collections||(n.collections={}),n.modules||(n.modules={}),n.items||(n.items={}),Object.entries(n.collections).forEach(([e,t])=>{typeof t=="function"&&(n.collections[e]={class:t});let s=he(e);s!==e&&(n.collections[s]=n.collections[e],delete n.collections[e]),n.collections[s].collection_key||(n.collections[s].collection_key=s),t.item_type&&(n.items[t.item_type.key||he(t.item_type.name)]={class:t.item_type})}),Object.entries(n.modules).forEach(([e,t])=>{typeof t=="function"&&(n.modules[e]={class:t});let s=he(e);s!==e&&(n.modules[s]=n.modules[e],delete n.modules[e])}),n.item_types||(n.item_types={}),n.items||(n.items={}),Object.entries(n.item_types).forEach(([e,t])=>{if(typeof t=="function"){let s=he(e);n.items[s]={class:t,actions:{},...n.items[s]||{}}}}),n}r(bE,"normalize_opts");function zN(n){if(!n||typeof n!="object")return!1;let e=Object.getPrototypeOf(n);return e===Object.prototype||e===null}r(zN,"is_plain_object");function b_(n){if(Array.isArray(n))return n.map(e=>b_(e));if(zN(n)){let e={};for(let[t,s]of Object.entries(n))e[t]=b_(s);return e}return n}r(b_,"deep_clone_config");function oi(n,e){let t=vE(n),s=vE(e),i=Math.max(t.parts.length,s.parts.length);for(let o=0;o<i;o++){let a=t.parts[o]!==void 0?t.parts[o]:0,c=s.parts[o]!==void 0?s.parts[o]:0;if(a>c)return 1;if(a<c)return-1}return t.type===s.type?0:t.type==="semver"&&s.type!=="semver"?1:s.type==="semver"&&t.type!=="semver"?-1:t.type==="number"&&s.type==="none"?t.parts[0]===0?0:1:s.type==="number"&&t.type==="none"?s.parts[0]===0?0:-1:0}r(oi,"compare_versions");function vE(n){if(n==null)return{type:"none",parts:[0,0,0]};if(typeof n=="number"){if(!Number.isFinite(n))return{type:"none",parts:[0,0,0]};let e=Math.floor(n),t=Math.floor((n-e)*10);return{type:"number",parts:[e,t,0]}}if(typeof n=="string"){let e=n.trim();if(!e)return{type:"none",parts:[0,0,0]};let s=e.split(".").map(i=>{let o=i.match(/^\d+/);if(!o)return 0;let a=Number.parseInt(o[0],10);return Number.isNaN(a)?0:a});for(;s.length<3;)s.push(0);return{type:"semver",parts:s}}return{type:"none",parts:[0,0,0]}}r(vE,"normalize_version_value");function Or(n){return n===null||typeof n!="object"||Array.isArray(n)||n instanceof Function||n instanceof Date?!1:Object.getPrototypeOf(n)===Object.prototype}r(Or,"is_plain_object");function xt(n,e,t=[]){if(!Or(n)||!Or(e)||t.includes(e))return n;t.push(e);for(let s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(e,s))continue;let i=e[s];if(Array.isArray(n[s])&&Array.isArray(i))for(let o of i)if(typeof o=="function"){let a=o.name;n[s].some(l=>typeof l=="function"&&l.name===a)||n[s].push(o)}else(o===null||["string","number","boolean","undefined"].includes(typeof o))&&n[s].includes(o)||n[s].push(o);else Or(i)?(Or(n[s])||(n[s]={}),xt(n[s],i,[...t])):Object.prototype.hasOwnProperty.call(n,s)||(n[s]=i)}return n}r(xt,"deep_merge_no_overwrite");function Et(n,e){let t=n.version,s=e.version;for(let[i,o]of Object.entries(e)){if(i==="collections"&&o&&typeof o=="object"){n.collections||(n.collections={});for(let[a,c]of Object.entries(o)){let l=n.collections[a];if(!l){n.collections[a]={...c};continue}let d=c&&c.version!==void 0?c.version:c?.class?.version,_=l&&l.version!==void 0?l.version:l?.class?.version;if(oi(d,_)>0){let p={...c};xt(p,l),n.collections[a]=p}else xt(l,c)}continue}if(["actions","collections","components","item_types","modules"].includes(i)&&o&&typeof o=="object"){n[i]||(n[i]={});for(let[a,c]of Object.entries(o)){if(!n[i][a]){n[i][a]={...c};continue}let l=n[i][a],d=c&&c.version,_=l&&l.version;oi(d,_)>0?(n[i][a]=c,n[i][a].version=d||-1):xt(l,c)}continue}Array.isArray(o)?Array.isArray(n[i])?o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set([...n[i],...o])):n[i]=[...n[i],...o]:o.length>0&&(typeof o[0]=="string"||typeof o[0]=="number"||typeof o[0]=="boolean")?n[i]=Array.from(new Set(o)):n[i]=[...o]:o&&typeof o=="object"?(n[i]||(n[i]={}),xt(n[i],o)):n[i]=o}return n}r(Et,"merge_env_config");function kE(n={}){let{file_exclusions:e,folder_exclusions:t,excluded_headings:s}=n;return(e!==void 0||t!==void 0||s!==void 0)&&(n.smart_sources=n.smart_sources||{},e!==void 0&&e.length&&e!=="Untitled"&&(!n.smart_sources?.file_exclusions?.length||n.smart_sources?.file_exclusions==="Untitled")&&(n.smart_sources.file_exclusions=e),t!==void 0&&t.length&&!n.smart_sources.folder_exclusions?.length&&(n.smart_sources.folder_exclusions=t),s!==void 0&&s.length&&!n.smart_sources.excluded_headings?.length&&(n.smart_sources.excluded_headings=s)),delete n.file_exclusions,delete n.folder_exclusions,delete n.excluded_headings,n}r(kE,"migrate_exclusion_settings_2025_08_22");var DN=typeof globalThis<"u"?globalThis:Function("return this")(),qr=class{static{r(this,"SmartEnv")}static version="2.2.7";scope_name="smart_env";static global_ref=DN;global_ref=this.constructor.global_ref;constructor(e={}){this.state="init",this._components={},this.collections={},this.load_timeout=null,this._collections_version_signature=null,this._events=Ds.create(this,FN(this.config?.modules?.smart_events)),e.primary_main_key&&(this.primary_main_key=e.primary_main_key)}get config(){let e=this.compute_collections_version_signature();if(this._config&&e===this._collections_version_signature)return this._config;this._collections_version_signature=e,this._config={};let t=Object.entries(this.smart_env_configs).sort(([s])=>this.primary_main_key&&s===this.primary_main_key?-1:0);for(let[s,i]of t){if(!i?.main){console.warn(`SmartEnv: '${s}' unloaded, skipping`),delete this.smart_env_configs[s];continue}if(!i?.opts){console.warn(`SmartEnv: '${s}' opts missing, skipping`);continue}Et(this._config,b_(bE(i.opts)))}return this._config}compute_collections_version_signature(){let e=[];for(let t of Object.values(this.smart_env_configs)){let{opts:s}=t||{};if(s)for(let[i,o]of Object.entries(s.collections||{})){let a=o?.class,c=typeof a?.version=="number"?a.version:0;e.push(`${i}:${c}`)}}return e.sort().join("|")}get env_start_wait_time(){return typeof this.config.env_start_wait_time=="number"?this.config.env_start_wait_time:5e3}static get global_env(){return this.global_ref.smart_env}static set global_env(e){this.global_ref.smart_env=e}static get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}get mains(){return Object.keys(this.global_ref.smart_env_configs||{})}static get should_reload(){return!this.global_env||this.global_env.state==="loaded"||typeof this.global_env?.constructor?.version>"u"?!0:oi(this.version,this.global_env.constructor?.version)>0?(console.warn("SmartEnv: Reloading environment because of version mismatch",`${this.version} > ${this.global_env.constructor.version}`),!0):!1}static get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}get smart_env_configs(){return this.global_ref.smart_env_configs||(this.global_ref.smart_env_configs={}),this.global_ref.smart_env_configs}to_json(){return Object.fromEntries(Object.entries(this).filter(([,e])=>typeof e?.collection_key<"u").map(([e,t])=>[e,RN(t)]))}static wait_for(e={}){return new Promise(t=>{if(e.main){let s=setInterval(()=>{this.global_env&&this.global_env[e.main]&&(clearInterval(s),t(this.global_env))},1e3)}else{let s=setInterval(()=>{this.global_env&&this.global_env.state==="loaded"&&(clearInterval(s),t(this.global_env))},100)}})}static async create(e,t){if(!e||typeof e!="object")throw new TypeError("SmartEnv: Invalid main object provided");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,this.add_main(e,t),this.should_reload){let s={};this.global_env&&oi(this.version,this.global_env.constructor?.version||0)>0&&(s.primary_main_key=he(e.constructor.name)),this.global_env?.load_timeout&&clearTimeout(this.global_env.load_timeout),this.global_env=new this(s);let i=this.global_ref;i.all_envs||(i.all_envs=[]),i.all_envs.push(this.global_env)}return clearTimeout(this.global_env.load_timeout),this.global_env.load_timeout=setTimeout(async()=>{await this.global_env.load(),this.global_env.load_timeout=null},this.global_env.env_start_wait_time),this.global_env}static add_main(e,t=null){this.global_env&&(this.global_env._config=null,this.global_env._collections_version_signature=null);let s=he(e.constructor.name);this.smart_env_configs[s]={main:e,opts:t},this.create_env_getter(e)}static create_env_getter(e){Object.defineProperty(e,"env",{configurable:!0,get:r(()=>this.global_env,"get")})}create_env_getter(e){this.constructor.create_env_getter(e)}async load(){this.state="loading",await this.fs.load_files(),this.settings||await y_.create(this),this.config.default_settings&&xt(this.settings,this.config.default_settings),kE(this.settings),this.smart_settings.save(),await this.init_collections();for(let[e,{main:t,opts:s}]of Object.entries(this.smart_env_configs))this[e]=t;await this.ready_to_load_collections(),await this.load_collections(),this.state="loaded"}async init_collections(e=this.config){for(let t of Object.keys(e.collections||{})){let s=e.collections[t]?.class;s&&(s.default_settings&&xt(this.settings,{[t]:s.default_settings}),typeof s.init=="function"&&(await s.init(this,{...e.collections[t]}),this.collections[t]="init"))}}async ready_to_load_collections(){}async load_collections(e=this.collections){let t=Object.keys(e||{}).sort((s,i)=>{let o=this.config.collections?.[s]?.load_order||0,a=this.config.collections?.[i]?.load_order||0;return o-a});for(let s of t){let i=Date.now();typeof this[s]?.process_load_queue=="function"&&(await this[s].process_load_queue(),this[s].load_time_ms=Date.now()-i,this.collections[s]="loaded",console.log(`Loaded ${this[s].collection_key} in ${this[s].load_time_ms}ms`))}}static unload_main(e){let t=he(e.constructor.name);this.smart_env_configs[t]=null,delete this.smart_env_configs[t]}unload_main(e){this.constructor.unload_main(e)}save(){for(let e of Object.keys(this.collections))this[e].process_save_queue?.()}init_module(e,t={}){let s=this.opts.modules[e];return s?(t={...s,class:null,...t},new s.class(t)):console.warn(`SmartEnv: module ${e} not found`)}get notices(){if(!this._notices){let e=this.config.modules.smart_notices.class;this._notices=new e(this,{adapter:this.config.modules.smart_notices.adapter})}return this._notices}get settings_template(){return this.opts.components?.smart_env?.settings||gE}async render_settings(e=this.settings_container){if((!this.settings_container||e!==this.settings_container)&&(this.settings_container=e),!e)throw new Error("Container is required");let t=await this.render_component("settings",this,{});return this.smart_view.empty(e),e.appendChild(t),t}async render_component(e,t,s={}){let i=this.get_component(e,t);return i?await i(t,s):(console.warn(`SmartEnv: component ${e} not found for scope ${t.constructor.name}`),this.smart_view.create_doc_fragment(`<div class="smart-env-component-not-found">
<h1>Component Not Found</h1>
<p>The component ${e} was not found for scope ${t.constructor.name}.</p>
</div>`))}get_component(e,t){let s=t.collection_key??t.scope_name,i=s?`${s}-${e}`:e;if(!this._components[i])try{if(this.opts.components[s]?.[e]){let o=this.opts.components[s][e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else if(this.opts.components[e]){let o=this.opts.components[e],a=o.render||o;this._components[i]=a.bind(this.init_module("smart_view"))}else console.warn(`SmartEnv: component ${e} not found for scope ${s}`)}catch(o){console.error("Error getting component",o),console.log(`scope_name: ${s}; component_key: ${e}; this.opts.components: ${Object.keys(this.opts.components||{}).join(", ")}; this.opts.components[scope_name]: ${Object.keys(this.opts.components[s]||{}).join(", ")}`)}return this._components[i]}get settings_config(){return{}}get global_prop(){return this.opts.global_prop??"smart_env"}get item_types(){return this.config.item_types}get fs_module_config(){return this.opts.modules.smart_fs}get fs(){return this.smart_fs||(this.smart_fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.opts.env_path||""})),this.smart_fs}get env_data_dir(){let e=this.fs.file_paths?.filter(s=>s.endsWith("smart_env.json"))||[],t=".smart-env";if(e.length>0)if(e.length>1){let s=e.map(i=>{let o=i.split("/").slice(-2,-1)[0];return{dir:o,count:this.fs.file_paths.filter(a=>a.includes(o)).length}});t=s.reduce((i,o)=>o.count>i.count?o:i,s[0]).dir}else t=e[0].split("/").slice(-2,-1)[0];return t}get data_fs(){return this._fs||(this._fs=new this.fs_module_config.class(this,{adapter:this.fs_module_config.adapter,fs_path:this.data_fs_path})),this._fs}get data_fs_path(){return this._data_fs_path||(this._data_fs_path=(this.opts.env_path+(this.opts.env_path?this.opts.env_path.includes("\\")?"\\":"/":"")+this.env_data_dir).replace(/\\\\/g,"\\").replace(/\/\//g,"/")),this._data_fs_path}async save_settings(e){this._saved=!1,await this.data_fs.exists("")||await this.data_fs.mkdir(""),await this.data_fs.write("smart_env.json",JSON.stringify(e,null,2)),this._saved=!0}async load_settings(){await this.data_fs.exists("smart_env.json")||await this.save_settings({});let e=JSON.parse(JSON.stringify(this.config.default_settings||{}));if(st(e,JSON.parse(await this.data_fs.read("smart_env.json"))),this._saved=!0,this.fs.auto_excluded_files){let t=e.smart_sources.file_exclusions.split(",").map(s=>s.trim()).filter(Boolean);e.smart_sources.file_exclusions=[...t,...this.fs.auto_excluded_files].filter((s,i,o)=>o.indexOf(s)===i).join(",")}return e}async update_exclusions(){this.smart_sources._fs=null,await this.smart_sources.init_fs()}get smart_view(){return this._smart_view||(this._smart_view=this.init_module("smart_view")),this._smart_view}get collections_loaded(){return this.state==="loaded"}get main(){return this.smart_env_configs[this.mains[0]]?.main}get ejs(){return this.opts.ejs}get templates(){return this.opts.templates}get views(){return this.opts.views}get opts(){return this.config}get plugin(){return this.main}};function RN(n){return{items:Object.fromEntries(Object.entries(n.items||{}).map(([e,t])=>[e,t.data]))}}r(RN,"collection_to_plain");function FN(n){if(!n)return{};if(typeof n=="function")return{adapter_class:n};let e=n.adapter_class||n.adapter;return e?{adapter_class:e}:{}}r(FN,"build_events_opts");function BN(n,{case_sensitive:e,extended_glob:t,windows_paths:s}){let i=WN(n,t),o=UN(i,s),a=e?"":"i";return new RegExp(`^${o}$`,a)}r(BN,"create_regex");function UN(n,e){return e?n.replace(/\\\//g,"[\\\\/]").replace(/\\\\\\/g,"[\\\\/]"):n}r(UN,"adjust_for_windows_paths");function WN(n,e){let t=!1,s=0,i="";for(let o=0;o<n.length;o++){let a=n[o];switch(a){case"\\":o+1<n.length?(i+=`\\${n[o+1]}`,o++):i+="\\\\";break;case"/":i+="\\/";break;case"[":t||n.indexOf("]",o+1)===-1?i+="\\[":(t=!0,n[o+1]==="!"?(i+="[^",o++):i+="[");break;case"]":t?(t=!1,i+="]"):i+="\\]";break;case"{":t||n.indexOf("}",o+1)===-1?i+="\\{":(s++,i+="(");break;case"}":!t&&s>0?(s--,i+=")"):i+="\\}";break;case",":!t&&s>0?i+="|":i+=",";break;case"*":t?i+="\\*":o+1<n.length&&n[o+1]==="*"?(i+=".*",o++):i+="[^/]*";break;case"?":t?i+="\\?":i+="[^/]";break;case"(":case")":case"+":case"|":case"^":case"$":case".":i+=`\\${a}`;break;default:i+=a;break}}return t&&(i+="]",t=!1),e&&(i=i.replace(/\\\+\\\((.*?)\\\)/g,"($1)+").replace(/\\\@\\\((.*?)\\\)/g,"($1)").replace(/\\\!\\\((.*?)\\\)/g,"(?!$1).*").replace(/\\\?\\\((.*?)\\\)/g,"($1)?").replace(/\\\*\\\((.*?)\\\)/g,"($1)*")),i}r(WN,"glob_to_regex_pattern");function wE(n,e={}){let s={...{case_sensitive:!0,extended_glob:!1,windows_paths:!1},...e};return n===""?/^$/:n==="*"&&!s.windows_paths?/^[^/]+$/:n==="**"&&!s.windows_paths?/^.+$/:BN(n,s)}r(wE,"glob_to_regex");function xE(n,e){let t=[];for(let s=0;s<n.length;s++){let i=e.toLowerCase().split(""),o=!0,a=0,c=n[s],l=c.toLowerCase();for(let d=0;d<i.length;d++){let _=l.substring(a).indexOf(i[d]);if(_>=0)a+=_+1;else{o=!1;break}}o&&t.push({name:c,distance:a})}return t.sort((s,i)=>s.distance-i.distance),t.map(s=>s.name)}r(xE,"fuzzy_search");var v_=class{static{r(this,"SmartFs")}constructor(e,t={}){if(this.env=e,this.opts=t,this.fs_path=t.fs_path||t.env_path||"",!t.adapter)throw new Error("SmartFs requires an adapter");this.adapter=new t.adapter(this),this.excluded_patterns=[],Array.isArray(t.exclude_patterns)&&t.exclude_patterns.forEach(s=>this.add_ignore_pattern(s)),this.folders={},this.files={},this.file_paths=[],this.folder_paths=[],this.auto_excluded_files=[]}async refresh(){this.files={},this.file_paths=[],this.folders={},this.folder_paths=[],await this.init()}async init(){await this.load_exclusions(),await this.load_files()}async load_files(){let e=await this.list_recursive();this.file_paths=[],this.folder_paths=[],e.forEach(t=>{t.type==="file"?(this.files[t.path]=t,this.file_paths.push(t.path)):t.type==="folder"&&(this.folders[t.path]=t,this.folder_paths.push(t.path))})}include_file(e){let t=this.adapter.get_file(e);return this.files[t.path]=t,this.file_paths.push(t.path),t}async load_exclusions(){let e=".gitignore";await this.adapter.exists(e)&&!this.env.settings.skip_excluding_gitignore&&(await this.adapter.read(e,"utf-8")).split(`
`).filter(i=>!i.startsWith("#")).filter(Boolean).forEach(i=>this.add_ignore_pattern(i)),this.add_ignore_pattern(".**"),this.add_ignore_pattern("**/.**"),this.add_ignore_pattern("**/.*/**"),this.add_ignore_pattern("**/*.ajson")}add_ignore_pattern(e,t={}){this.excluded_patterns.push(wE(e.trim(),t))}is_excluded(e){try{return e.includes("#")?!0:this.excluded_patterns.length?this.excluded_patterns.some(t=>t.test(e)):!1}catch(t){throw console.error(`Error checking if path is excluded: ${t.message}`),console.error("Path: ",e),t}}has_excluded_patterns(e){return e.some(t=>this.is_excluded(t))}pre_process(e){if(this.has_excluded_patterns(e))throw new Error(`Path is excluded: ${e.find(t=>this.is_excluded(t))}`);return e}post_process(e){return this.adapter.post_process?this.adapter.post_process(e):(Array.isArray(e)&&(e=e.filter(t=>typeof t=="string"?!this.is_excluded(t):typeof t=="object"&&t.path?!this.is_excluded(t.path):!0)),e)}async use_adapter(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=await this.adapter[e](...t,...s);return this.post_process(i)}use_adapter_sync(e,t,...s){if(!this.adapter[e])throw new Error(`Method ${e} not found in adapter`);t=this.pre_process(t??[]);let i=this.adapter[e](...t,...s);return this.post_process(i)}async append(e,t){return await this.use_adapter("append",[e],t)}async mkdir(e,t={recursive:!0}){return await this.use_adapter("mkdir",[e],t)}async exists(e){return await this.use_adapter("exists",[e])}exists_sync(e){return this.use_adapter_sync("exists_sync",[e])}async list(e="/"){return await this.use_adapter("list",[e])}async list_recursive(e="/"){return await this.use_adapter("list_recursive",[e])}async list_files(e="/"){return await this.use_adapter("list_files",[e])}async list_files_recursive(e="/"){return await this.use_adapter("list_files_recursive",[e])}async list_folders(e="/"){return await this.use_adapter("list_folders",[e])}async list_folders_recursive(e="/"){return await this.use_adapter("list_folders_recursive",[e])}async read(e,t="utf-8"){try{return await this.adapter.read(e,t)}catch(s){return console.warn("Error during read: "+s.message,e),s.code==="ENOENT"?null:{error:s.message}}}async remove(e){return await this.use_adapter("remove",[e])}async remove_dir(e,t=!1){return await this.use_adapter("remove_dir",[e],t)}async rename(e,t){await this.use_adapter("rename",[e,t]),await this.refresh()}async stat(e){return await this.use_adapter("stat",[e])}async write(e,t){try{await this.adapter.write(e,t)}catch(s){throw console.error("Error during write:",s),s}}get_link_target_path(e,t){if(this.adapter.get_link_target_path)return this.adapter.get_link_target_path(e,t);if(!this.file_paths)return console.warn("get_link_target_path: file_paths not found");let s=this.file_paths.filter(i=>i.includes(e));return xE(s,e)[0]}get sep(){return this.adapter.sep||"/"}get_full_path(e=""){return this.adapter.get_full_path(e)}get base_path(){return this.adapter.get_base_path()}};var GN=P(require("obsidian"),1);var k_=class{static{r(this,"ObsidianFsAdapter")}constructor(e){this.smart_fs=e,this.obsidian=GN,this.obsidian_app=e.env.main.app,this.obsidian_adapter=e.env.main.app.vault.adapter}get fs_path(){return this.smart_fs.fs_path}get_file(e){let t={};return t.path=e.replace(/\\/g,"/").replace(this.smart_fs.fs_path,"").replace(/^\//,""),t.type="file",t.extension=t.path.split(".").pop().toLowerCase(),t.name=t.path.split("/").pop(),t.basename=t.name.split(".").shift(),Object.defineProperty(t,"stat",{get:r(()=>{let s=this.obsidian_app.vault.getAbstractFileByPath(e);return s?{ctime:s.stat.ctime,mtime:s.stat.mtime,size:s.stat.size,isDirectory:r(()=>s instanceof this.obsidian.TFolder,"isDirectory"),isFile:r(()=>s instanceof this.obsidian.TFile,"isFile")}:null},"get")}),t}async append(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.append(e,t)}async mkdir(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.mkdir(e)}async exists(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.exists(e)}exists_sync(e){return!!this.obsidian_app.vault.getAbstractFileByPath(e)}async list(e,t={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e.includes(".")){let{files:i}=await this.obsidian_adapter.list(e);return i.map(a=>{this.smart_fs.fs_path&&(a=a.replace(this.smart_fs.fs_path,"").slice(1));let c=a.split("/").pop();return{basename:c.split(".")[0],extension:c.split(".").pop().toLowerCase(),name:c,path:a}})}return this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{let o=i.path.lastIndexOf("/");return!(o===-1&&e!==""||i.path.slice(0,o)!==e)})}async list_recursive(e,t={}){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),this.obsidian_app.vault.getAllLoadedFiles().filter(i=>{if(i.path.length>200)return this.smart_fs.auto_excluded_files.push(i.path),!1;if(e!==""&&!i.path.startsWith(e))return!1;if(i instanceof this.obsidian.TFile){if(t.type==="folder")return!1;i.type="file"}else if(i instanceof this.obsidian.TFolder){if(t.type==="file")return!1;delete i.basename,delete i.extension,i.type="folder"}return this.smart_fs.fs_path&&(i.path=i.path.replace(this.smart_fs.fs_path,"").slice(1)),!0})}async list_files(e){return await this.list(e,{type:"file"})}async list_files_recursive(e){return await this.list_recursive(e,{type:"file"})}async list_folders(e){return await this.list(e,{type:"folder"})}async list_folders_recursive(e){return await this.list_recursive(e,{type:"folder"})}async read(e,t,s={}){if(e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t==="utf-8"){if(!s.no_cache){let o=this.obsidian_app.vault.getFileByPath(e);if(o)return await this.obsidian_app.vault.cachedRead(o)}return await this.obsidian_adapter.read(e)}if(t==="base64"){let o=await this.obsidian_adapter.readBinary(e,"base64");return this.obsidian.arrayBufferToBase64(o)}return await this.obsidian_adapter.readBinary(e)}async rename(e,t){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),t.startsWith(this.fs_path)||(t=this.fs_path+"/"+t),await this.obsidian_adapter.rename(e,t)}async remove(e){e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);try{return await this.obsidian_adapter.remove(e)}catch(t){console.warn(`Error removing file: ${e}`,t)}}async remove_dir(e,t=!1){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.rmdir(e,t)}async stat(e){return e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e),await this.obsidian_adapter.stat(e)}async write(e,t){t||(t=""),e.startsWith(this.fs_path)||(e=this.fs_path+"/"+e);let s=e.split("/").slice(0,-1).join("/");return await this.exists(s)||(await this.mkdir(s),console.log(`Created folder: ${s}`)),await this.obsidian_adapter.write(e,t)}get_link_target_path(e,t){return this.obsidian_app.metadataCache.getFirstLinkpathDest(e,t)?.path}get_base_path(){return this.obsidian_adapter.basePath}get_full_path(e=""){let t=e.includes("/")?"/":"\\";return this.get_base_path()+t+e}register_source_watchers(e){if(this._source_watchers_registered)return this._source_watchers_registered;let t=this.smart_fs.env?.main;if(!t?.registerEvent)return console.warn("ObsidianFsAdapter: Unable to register source watchers without plugin context"),!1;let{app:s}=t,i=r((o,a)=>{!a?.path&&!a?.item_key||this.smart_fs.env.events?.emit(o,{collection_key:e.collection_key,item_key:a.item_key||a.path,...a})},"emit_event");return t.registerEvent(s.vault.on("create",o=>{i("sources:created",{path:o.path,event_source:"obsidian:vault.create"})})),t.registerEvent(s.vault.on("modify",o=>{i("sources:modified",{path:o.path,event_source:"obsidian:vault.modify"})})),t.registerEvent(s.vault.on("rename",(o,a)=>{i("sources:renamed",{path:o.path,old_path:a,event_source:"obsidian:vault.rename"})})),t.registerEvent(s.vault.on("delete",o=>{i("sources:deleted",{path:o.path,event_source:"obsidian:vault.delete"})})),t.registerEvent(s.workspace.on("editor-change",(o,a)=>{let c=a?.file;c&&i("sources:modified",{path:c.path,event_source:"obsidian:workspace.editor-change"})})),this._source_watchers_registered=!0,!0}};function w_(n){let e=document.createRange();e.selectNodeContents(n),e.deleteContents()}r(w_,"empty");var EE=(()=>{let n=new Map;return(e,t)=>{let s=t.trim(),i=n.get(s);i||(i=document.createElement("template"),i.innerHTML=s,n.set(s,i)),e.replaceChildren(i.content.cloneNode(!0))}})();var AE=r((n,e)=>{let s=document.createRange().createContextualFragment(e.trim());n.replaceChildren(s)},"replace_with_fragment");var HN=/<(td|th|tr|thead|tbody|tfoot|caption|col|colgroup|option|optgroup|li|dt|dd|source|track)\b/i,x_=r((n,e)=>{let t=e.trim();(HN.test(t)?AE:EE)(n,t)},"safe_inner_html");var E_=new WeakMap,A_=new WeakMap,S_=class{static{r(this,"SmartView")}static version=.1;constructor(e={}){this.opts=e,this._adapter=null}async render_setting_components(e,t={}){let s=e.querySelectorAll(".setting-component"),i=[];for(let o of s)i.push(this.render_setting_component(o,t));return await Promise.all(i),e}create_doc_fragment(e){return document.createRange().createContextualFragment(e)}get adapter(){if(!this._adapter){if(!this.opts.adapter)throw new Error("No adapter provided to SmartView. Provide a 'smart_view.adapter' in env config.");let e=this.opts.adapter;this._adapter=new e(this)}return this._adapter}get_icon_html(e){return this.adapter.get_icon_html(e)}async render_setting_component(e,t={}){return await this.adapter.render_setting_component(e,t)}async render_markdown(e,t=null){return await this.adapter.render_markdown(e,t)}get_by_path(e,t,s=null){return Ae(e,t,s)}set_by_path(e,t,s,i=null){Se(e,t,s,i)}delete_by_path(e,t,s=null){Uh(e,t,s)}escape_html(e){return De(e)}render_setting_html(e){if(e.type==="html")return e.value;let t=Object.entries(e).map(([s,i])=>s.includes("class")?"":typeof i=="number"?`data-${s.replace(/_/g,"-")}=${i}`:`data-${s.replace(/_/g,"-")}="${i}"`).join(`
`);return`<div class="setting-component${e.scope_class?" "+e.scope_class:""}"
data-setting="${e.setting}"
${t}
></div>`}async render_settings(e,t={}){let i=Object.entries(typeof e=="function"?await e(t.scope):e).map(([a,c])=>(c.setting||(c.setting=a),this.render_setting_html(c))).join(`
`),o=this.create_doc_fragment(`<div>${i}</div>`);return await this.render_setting_components(o,t)}add_settings_listeners(e,t=document){if(!t||typeof t.querySelectorAll!="function")return;t.querySelectorAll("[data-smart-setting]").forEach(i=>{let o=i.dataset.smartSetting;if(!o||A_.has(i))return;let a=r(()=>{let c;if(i instanceof HTMLInputElement)if(i.type==="checkbox")c=i.checked;else if(i.type==="radio")if(i.checked)c=i.value;else return;else c=i.value;else i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement?c=i.value:c=i.value??i.textContent;this.set_by_path(e.settings,o,c)},"handler");A_.set(i,a),i.addEventListener("change",a),i instanceof HTMLElement&&this.attach_disposer(i,()=>{let c=A_.get(i);c&&(i.removeEventListener("change",c),A_.delete(i))})})}apply_style_sheet(e){if(typeof e=="string"){let t=oe(e);if(document.getElementById(`style-sheet-${t}`))return;let s=document.createElement("style");s.id=`style-sheet-${t}`,s.textContent=e,document.head.appendChild(s);return}if("adoptedStyleSheets"in Document.prototype)document.adoptedStyleSheets=[...document.adoptedStyleSheets,e];else{let t=document.createElement("style");e.cssRules&&(t.textContent=Array.from(e.cssRules).map(s=>s.cssText).join(`
`)),document.head.appendChild(t)}}empty(e){w_(e)}safe_inner_html(e,t){x_(e,t)}attach_disposer(e,t){if(!e)return;let s=e.ownerDocument,i=s&&s.defaultView,o=i&&i.MutationObserver;if(!s||!i||!o||!s.body)return;let a;if(typeof t=="function")a=[t];else if(Array.isArray(t))a=t.filter(l=>typeof l=="function");else{console.warn("[smart-view] attach_disposer called with invalid disposer");return}if(!a.length){console.warn("[smart-view] attach_disposer called with no valid disposer functions");return}let c=E_.get(e);c||(c={dispose_fns:new Set,observer:null,has_been_in_dom:!1,disposed:!1},E_.set(e,c)),c.disposed&&(c.disposed=!1,c.has_been_in_dom=!1);for(let l of a)c.dispose_fns.add(l);if(!c.observer){let l=new o(()=>{if(s.body.contains(e)){c.has_been_in_dom=!0;return}if(!(!c.has_been_in_dom||c.disposed)){c.disposed=!0;try{for(let _ of c.dispose_fns)try{_()}catch(m){console.error("[smart-view] disposer error",m)}}finally{try{l.disconnect()}catch{}E_.get(e)===c&&E_.delete(e)}}});c.observer=l,l.observe(s.body,{childList:!0,subtree:!0})}}};var C_=class{static{r(this,"SmartViewAdapter")}constructor(e){this.main=e}get setting_class(){throw new Error("setting_class() not implemented")}get_icon_html(e){throw new Error("get_icon_html() not implemented")}async render_markdown(e,t=null){throw new Error("render_markdown() not implemented")}open_url(e){throw new Error("open_url() not implemented")}handle_folder_select(e,t,s,i){throw new Error("handle_folder_select not implemented")}handle_file_select(e,t,s,i){throw new Error("handle_file_select not implemented")}pre_change(e,t,s){}post_change(e,t,s){}revert_setting(e,t,s){console.warn("revert_setting() not implemented")}get setting_renderers(){return{text:this.render_text_component,string:this.render_text_component,password:this.render_password_component,number:this.render_number_component,dropdown:this.render_dropdown_component,toggle:this.render_toggle_component,textarea:this.render_textarea_component,textarea_array:this.render_textarea_array_component,button:this.render_button_component,remove:this.render_remove_component,folder:this.render_folder_select_component,"text-file":this.render_file_select_component,file:this.render_file_select_component,slider:this.render_slider_component,html:this.render_html_component,button_with_confirm:this.render_button_with_confirm_component,json:this.render_json_component,array:this.render_array_component}}async render_setting_component(e,t={}){this.empty(e);let s=e.dataset.setting,i=t.scope||this.main.main,o=t.settings_scope||null;try{let a=e.dataset.value??this.main.get_by_path(i.settings,s,o);typeof a>"u"&&typeof e.dataset.default<"u"&&(a=e.dataset.default,typeof a=="string"&&(a=a.toLowerCase()==="true"?!0:a==="false"?!1:a),this.main.set_by_path(i.settings,s,a,o));let c=this.setting_renderers[e.dataset.type];if(!c)return console.warn(`Unsupported setting type: ${e.dataset.type}`),e;let l=c.call(this,e,s,a,i,o);if(e.dataset.name&&l.setName(e.dataset.name),e.dataset.description){let d=this.main.create_doc_fragment(`<span>${e.dataset.description}</span>`);l.setDesc(d)}return e.dataset.tooltip&&l.setTooltip(e.dataset.tooltip),this.add_button_if_needed(l,e,s,i),this.handle_disabled_and_hidden(e),e}catch(a){console.error(JSON.stringify({path:s,elm:e},null,2)),console.error(JSON.stringify(a,null,2))}}render_dropdown_component(e,t,s,i,o){let a=new this.setting_class(e),c;return a.addDropdown(l=>{e.dataset.required&&l.selectEl.setAttribute("required",!0);let d=e.dataset.optionsCallback?this.main.get_by_path(i,e.dataset.optionsCallback):null;typeof d=="function"?(console.log(`getting options callback: ${e.dataset.optionsCallback}`),Promise.resolve(d()).then(_=>{_.forEach(m=>{let p=l.addOption(m.value,m.label??m.name??m.value);p.selected=m.value===s,_.length===1&&p.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)})):((!c||!c.length)&&(c=this.get_dropdown_options(e)),c.forEach(_=>{let m=l.addOption(_.value,_.label??_.name??_.value);m.selected=_.value===s,c.length===1&&m.selected&&l.selectEl.classList.add("dropdown-no-options")}),l.setValue(s)),l.onChange(_=>{this.handle_on_change(t,_,e,i,o)})}),a}render_text_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;e.dataset.button?a.addButton(d=>{d.setButtonText(e.dataset.button),d.onClick(async()=>this.handle_on_change(t,c.getValue(),e,i))}):c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d.trim(),e,i,o),2e3)})}),a}render_password_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="password",c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_number_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addText(c=>{c.inputEl.type="number",c.setPlaceholder(e.dataset.placeholder||""),typeof s<"u"&&(c.inputEl.value=parseInt(s)),c.inputEl.min=e.dataset.min||0,e.dataset.max&&(c.inputEl.max=e.dataset.max);let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,parseInt(d),e,i,o),2e3)})}),a}render_toggle_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addToggle(c=>{let l=s??!1;typeof l=="string"&&(l=l.toLowerCase()==="true"),c.setValue(l),c.onChange(async d=>this.handle_on_change(t,d,e,i,o))}),a}render_textarea_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(s||"");let l;c.onChange(async d=>{clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_textarea_array_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addTextArea(c=>{c.setPlaceholder(e.dataset.placeholder||""),c.setValue(Array.isArray(s)?s.join(`
`):s||"");let l;c.onChange(async d=>{d=d.split(`
`).map(_=>_.trim()).filter(_=>_),clearTimeout(l),l=setTimeout(()=>this.handle_on_change(t,d,e,i,o),2e3)})}),a}render_button_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name),c.onClick(async()=>{if(!(e.dataset.confirm&&!confirm(e.dataset.confirm))&&(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback)){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_remove_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addButton(c=>{c.setButtonText(e.dataset.btnText||e.dataset.name||"Remove"),c.onClick(async()=>{if(this.main.delete_by_path(i.settings,t,o),e.dataset.callback){let l=this.main.get_by_path(i,e.dataset.callback);l&&l(t,s,e,i,o)}})}),a}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFolderSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_folder_select(t,s,e,i)}),c.inputEl.querySelector("input").addEventListener("change",l=>{let d=l.target.value;this.handle_on_change(t,d,e,i,o)})}),a}render_file_select_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addFileSelect(c=>{c.setPlaceholder(e.dataset.placeholder||""),s&&c.setValue(s),c.inputEl.closest("div").addEventListener("click",()=>{this.handle_file_select(t,s,e,i,o)})}),a}render_slider_component(e,t,s,i,o){let a=new this.setting_class(e);return a.addSlider(c=>{let l=parseFloat(e.dataset.min)||0,d=parseFloat(e.dataset.max)||100,_=parseFloat(e.dataset.step)||1,m=typeof s<"u"?parseFloat(s):l;c.setLimits(l,d,_),c.setValue(m),c.onChange(p=>{let f=parseFloat(p);this.handle_on_change(t,f,e,i,o)})}),a}render_html_component(e,t,s,i){return this.safe_inner_html(e,s),e}render_array_component(e,t,s,i,o){let a=new this.setting_class(e),c=Array.isArray(s)?[...s]:[],l=document.createElement("div");l.className="array-items-container";let d=r(()=>{l.innerHTML="",c.forEach((y,g)=>{let v=document.createElement("div");v.className="array-item-row";let k=document.createElement("input");k.type="text",k.value=y,k.placeholder="Value";let w=document.createElement("button");w.textContent="\u2715",w.title="Remove",k.addEventListener("change",()=>{c[g]=k.value,f()}),w.addEventListener("click",()=>{c.splice(g,1),d(),f()}),v.appendChild(k),v.appendChild(w),l.appendChild(v)})},"render_items"),_=document.createElement("div");_.className="array-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Value";let p=document.createElement("button");p.textContent="+",p.title="Add value",p.addEventListener("click",()=>{let y=m.value.trim();y&&(c.push(y),m.value="",d(),f())}),_.appendChild(m),_.appendChild(p),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let f=r(()=>{this.handle_on_change(t,[...c],e,i,o)},"trigger_change");return d(),e.appendChild(a.settingEl),a}render_json_component(e,t,s,i,o){try{let a=new this.setting_class(e),c=typeof s=="object"&&s!==null?{...s}:{},l=document.createElement("div");l.className="json-pairs-container";let d=r(()=>{l.innerHTML="",Object.entries(c).forEach(([g,v],k)=>{let w=document.createElement("div");w.className="json-pair-row";let q=document.createElement("input");q.type="text",q.value=g,q.placeholder="Property";let E=document.createElement("input");E.type="text",E.value=v,E.placeholder="Value";let S=document.createElement("button");S.textContent="\u2715",S.title="Remove",q.addEventListener("change",()=>{let C=q.value.trim();C&&C!==g&&(c[C]=c[g],delete c[g],d(),y())}),E.addEventListener("change",()=>{c[q.value]=E.value,y()}),S.addEventListener("click",()=>{delete c[q.value],d(),y()}),w.appendChild(q),w.appendChild(E),w.appendChild(S),l.appendChild(w)})},"renderPairs"),_=document.createElement("div");_.className="json-add-row";let m=document.createElement("input");m.type="text",m.placeholder="Property";let p=document.createElement("input");p.type="text",p.placeholder="Value";let f=document.createElement("button");f.textContent="+",f.title="Add property",f.addEventListener("click",()=>{let g=m.value.trim();!g||g in c||(c[g]=p.value,m.value="",p.value="",d(),y())}),_.appendChild(m),_.appendChild(p),_.appendChild(f),a.controlEl.appendChild(l),a.controlEl.appendChild(_);let y=r(()=>{this.handle_on_change(t,{...c},e,i,o)},"triggerChange");return d(),e.appendChild(a.settingEl),a}catch(a){console.error(a)}}add_button_if_needed(e,t,s,i){t.dataset.btn&&e.addButton(o=>{o.setButtonText(t.dataset.btn),(t.dataset.btnCallback||t.dataset.btnHref||t.dataset.callback||t.dataset.href)&&o.inputEl.addEventListener("click",a=>{t.dataset.btnCallback&&typeof i[t.dataset.btnCallback]=="function"?t.dataset.btnCallbackArg?i[t.dataset.btnCallback](t.dataset.btnCallbackArg):i[t.dataset.btnCallback](s,null,e,i):t.dataset.btnHref?this.open_url(t.dataset.btnHref):t.dataset.callback&&typeof this.main.get_by_path(i,t.dataset.callback)=="function"?this.main.get_by_path(i,t.dataset.callback)(s,null,e,i):t.dataset.href?this.open_url(t.dataset.href):console.error("No callback or href found for button.")}),(t.dataset.btnDisabled||t.dataset.disabled&&t.dataset.btnDisabled!=="false")&&(o.inputEl.disabled=!0)})}handle_disabled_and_hidden(e){e.dataset.disabled&&e.dataset.disabled!=="false"&&(e.classList.add("disabled"),e.querySelector("input, select, textarea, button").disabled=!0),e.dataset.hidden&&e.dataset.hidden!=="false"&&(e.style.display="none")}get_dropdown_options(e){return Object.entries(e.dataset).reduce((t,[s,i])=>{if(!s.startsWith("option"))return t;let[o,a]=i.split("|");return t.push({value:o,name:a||o}),t},[])}handle_on_change(e,t,s,i,o){if(this.pre_change(e,t,s,i),s.dataset.validate&&!this[s.dataset.validate](e,t,s,i)){s.querySelector(".setting-item").style.border="2px solid red",this.revert_setting(e,s,i);return}if(this.main.set_by_path(i.settings,e,t,o),s.dataset.callback){let a=this.main.get_by_path(i,s.dataset.callback);a&&a(e,t,s,i)}this.post_change(e,t,s,i)}render_button_with_confirm_component(e,t,s,i){let o=new this.setting_class(e);return o.addButton(a=>{a.setButtonText(e.dataset.btnText||e.dataset.name),e.appendChild(this.main.create_doc_fragment(`
<div class="sc-inline-confirm-row" style="
display: none;
">
<span style="margin-right: 10px;">
${e.dataset.confirm||"Are you sure?"}
</span>
<span class="sc-inline-confirm-row-buttons">
<button class="sc-inline-confirm-yes">Yes</button>
<button class="sc-inline-confirm-cancel">Cancel</button>
</span>
</div>
`));let c=e.querySelector(".sc-inline-confirm-row"),l=c.querySelector(".sc-inline-confirm-yes"),d=c.querySelector(".sc-inline-confirm-cancel");a.onClick(async()=>{c.style.display="block",e.querySelector(".setting-item").style.display="none"}),l.addEventListener("click",async()=>{if(e.dataset.href&&this.open_url(e.dataset.href),e.dataset.callback){let _=this.main.get_by_path(i,e.dataset.callback);_&&_(t,s,e,i)}e.querySelector(".setting-item").style.display="block",c.style.display="none"}),d.addEventListener("click",()=>{c.style.display="none",e.querySelector(".setting-item").style.display="block"})}),o}empty(e){w_(e)}safe_inner_html(e,t){x_(e,t)}};var nt=require("obsidian");var O_=class extends C_{static{r(this,"SmartViewObsidianAdapter")}get setting_class(){return nt.Setting}open_url(e){window.open(e)}async render_file_select_component(e,t,s){return super.render_text_component(e,t,s)}async render_markdown(e,t){let s=t.env.smart_connections_plugin?.connections_view||new nt.Component;if(!t)return console.warn("Scope required for rendering markdown in Obsidian adapter");let i=this.main.create_doc_fragment("<div><div class='inner'></div></div>"),o=i.querySelector(".inner");try{await nt.MarkdownRenderer.render(t.env.plugin.app,e,o,t?.file_path||"",s)}catch(a){console.warn("Error rendering markdown in Obsidian adapter",a)}return i}get_icon_html(e){return(0,nt.getIcon)(e).outerHTML}is_mod_event(e){return nt.Keymap.isModEvent(e)}render_folder_select_component(e,t,s,i,o){let a=new this.setting_class(e),c=i.env.plugin.app.vault.getAllFolders().sort((l,d)=>l.path.localeCompare(d.path));return a.addDropdown(l=>{e.dataset.required&&l.inputEl.setAttribute("required",!0),l.addOption("","No folder selected"),c.forEach(d=>{l.addOption(d.path,d.path)}),l.onChange(d=>{this.handle_on_change(t,d,e,i,o)}),l.setValue(s)}),a}};function q_(n){return n.endsWith("Item")?n.replace(/Item$/,"").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase():n.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase().replace(/y$/,"ie")+"s"}r(q_,"collection_instance_name_from");function SE(n){let e=JSON.stringify(n),t=0;if(e.length===0)return t;for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t,t<0&&(t=t*-1)}return t.toString()+e.length}r(SE,"create_uid");function $_(n,e,t=new WeakMap){if(n===e)return!0;if(n===null||e===null||n===void 0||e===void 0||typeof n!=typeof e||Array.isArray(n)!==Array.isArray(e))return!1;if(Array.isArray(n))return n.length!==e.length?!1:n.every((s,i)=>$_(s,e[i],t));if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);let s=Object.keys(n),i=Object.keys(e);return s.length!==i.length?!1:s.every(o=>$_(n[o],e[o],t))}return n===e}r($_,"deep_equal");function j_(n,e){return e?n.split("/").join(" > ").replace(".md",""):n.split("/").pop().replace(".md","")}r(j_,"get_item_display_name");function T_(n,e){let t=e||{},s=r(u=>typeof u=="object"&&u!==null&&!Array.isArray(u),"is_plain_object"),i=r(u=>typeof u=="function","is_function"),o=r(u=>i(u)&&/^class\s/.test(Function.prototype.toString.call(u)),"is_class_export"),a=r(u=>s(u)&&i(u.action),"is_action_object"),c=r(u=>i(u)||a(u)||o(u),"is_action_candidate"),l=new Set(["length","name","prototype"]),d=r(u=>{if(!s(u))return u;let h=Object.create(Object.getPrototypeOf(u)||null);for(let b of Reflect.ownKeys(u)){let j=Object.getOwnPropertyDescriptor(u,b);if(!j)continue;let x={...j};"value"in x&&s(x.value)&&(x.value=d(x.value));try{Object.defineProperty(h,b,x)}catch{h[b]=x.value}}return h},"clone_with_descriptors"),_=r(u=>{if(!s(u)||a(u))return!1;let h=Reflect.ownKeys(u);if(h.length===0)return!1;let b=!1;for(let j of h){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x){let $=x.value;if(c($)){b=!0;continue}if(s($)){if(_($)){b=!0;continue}return!1}if(typeof $>"u")continue;return!1}return!1}}return b},"should_bucket_actions"),m=r(u=>{if(!u)return u;if(!("value"in u))return{...u};let h=s(u.value)?d(u.value):u.value;return{...u,value:h}},"clone_descriptor"),p=r(u=>{let h=Object.create(null),b=new Map;for(let j of Reflect.ownKeys(u)){let x=Object.getOwnPropertyDescriptor(u,j);if(x){if("value"in x&&_(x.value)){b.set(j,d(x.value));continue}try{Object.defineProperty(h,j,m(x))}catch{h[j]=x.value}}}return{global_source:h,scoped_sources:b}},"build_sources"),{global_source:f,scoped_sources:y}=p(t),g=r((u,h)=>Object.prototype.hasOwnProperty.call(u,h),"has_own"),v=Object.create(null),k=r((u,h,b=[])=>{if(!u||!h)return;let j=new Set([...l,...b]);for(let x of Reflect.ownKeys(u)){if(j.has(x))continue;let $=Object.getOwnPropertyDescriptor(u,x);if($)try{Object.defineProperty(h,x,$)}catch{h[x]=$.value}}},"copy_metadata"),w=r(u=>{let h=new u(n),b=h.action||h.run||h.execute||h.call;if(i(b)){let j=b.bind(h);return k(u,j),k(h,j),j.instance=h,j}return k(u,h),h},"instantiate_class"),q=r(u=>{if(o(u))return w(u);if(a(u)){let h=u.action.bind(n);return k(u,h,["action"]),h}if(i(u)){let h=u.bind(n);return k(u,h),h}return s(u)?d(u):u},"bind_or_clone"),E=r(()=>{let u=n?.constructor?.key;if(typeof u>"u"||u===null)return null;let h=y.get(u);return h&&s(h)?h:null},"scope_actions_for"),S=r((u,h,b)=>(u[h]=b,b),"cache_result"),C=r((u,h)=>{let b=E();return b&&g(b,h)?S(u,h,q(b[h])):g(f,h)?S(u,h,q(f[h])):S(u,h,void 0)},"compute_and_cache"),O=r(()=>{let u=E(),h=new Set(Reflect.ownKeys(v));for(let b of Reflect.ownKeys(f))h.add(b);if(u)for(let b of Reflect.ownKeys(u))h.add(b);return Array.from(h)},"union_keys"),A=r((u,h)=>({configurable:!0,enumerable:!0,value:u[h]}),"descriptor_for");return new Proxy(v,{get:r((u,h)=>h===Symbol.toStringTag?"ActionsProxy":h in u?u[h]:C(u,h),"get"),has:r((u,h)=>{if(h in u)return!0;let b=E();return b&&g(b,h)?!0:g(f,h)},"has"),ownKeys:r(()=>O(),"ownKeys"),getOwnPropertyDescriptor:r((u,h)=>{if(g(u,h))return A(u,h);let b=E();if(b&&g(b,h)||g(f,h))return g(u,h)||C(u,h),A(u,h)},"getOwnPropertyDescriptor"),defineProperty:r((u,h,b)=>"value"in b?(u[h]=b.value,!0):!1,"defineProperty"),set:r((u,h,b)=>(u[h]=b,!0),"set"),deleteProperty:r((u,h)=>(g(u,h)&&delete u[h],!0),"deleteProperty")})}r(T_,"create_actions_proxy");var re=class n{static{r(this,"CollectionItem")}static version=.002;static get defaults(){return{data:{}}}constructor(e,t=null){e.create_env_getter(this),this.config=this.env?.config,this.merge_defaults(),t&&st(this.data,t),this.data.class_name||(this.data.class_name=this.collection.item_class_name)}static load(e,t){let s=new this(e,t);return s.init(),s}merge_defaults(){let e=this.constructor;for(;e;){for(let t in e.defaults){let s=e.defaults[t];typeof s=="object"?this[t]={...s,...this[t]}:this[t]=this[t]===void 0?s:this[t]}e=Object.getPrototypeOf(e)}}get_key(){return SE(this.data)}update_data(e){let t=this.sanitize_data(e),s={...this.data};return st(s,t),!$_(this.data,s)?(this.data=s,!0):!1}sanitize_data(e){return e instanceof n?e.ref:Array.isArray(e)?e.map(t=>this.sanitize_data(t)):typeof e=="object"&&e!==null?Object.keys(e).reduce((t,s)=>(t[s]=this.sanitize_data(e[s]),t),{}):e}init(e){}queue_save(){this._queue_save=!0}async save(){try{await this.data_adapter.save_item(this),this.init()}catch(e){this._queue_save=!0,console.error(e,e.stack)}}queue_load(){this._queue_load=!0}async load(){try{await this.data_adapter.load_item(this),this.init()}catch(e){this._load_error=e,this.on_load_error(e)}}on_load_error(e){this.queue_load()}validate_save(){return!(!this.key||this.key.trim()===""||this.key==="undefined")}delete(){this.deleted=!0,this.queue_save()}filter(e={}){let{exclude_key:t,exclude_keys:s=t?[t]:[],exclude_key_starts_with:i,exclude_key_starts_with_any:o,exclude_key_includes:a,exclude_key_includes_any:c,exclude_key_ends_with:l,exclude_key_ends_with_any:d,key_ends_with:_,key_starts_with:m,key_starts_with_any:p,key_includes:f,key_includes_any:y}=e;return!(s?.includes(this.key)||i&&this.key.startsWith(i)||o&&o.some(g=>this.key.startsWith(g))||a&&this.key.includes(a)||c&&c.some(g=>this.key.includes(g))||l&&this.key.endsWith(l)||d&&d.some(g=>this.key.endsWith(g))||_&&!this.key.endsWith(_)||m&&!this.key.startsWith(m)||p&&!p.some(g=>this.key.startsWith(g))||f&&!this.key.includes(f)||y&&!y.some(g=>this.key.includes(g)))}filter_and_score(e={}){return this.filter(e.filter)===!1?null:this.score(e)}score(e={}){let t=this.actions[e.score_algo_key];if(typeof t!="function")throw new Error(`Missing score action: ${e.score_algo_key}`);return{...t(e)||{},item:this}}parse(){}get actions(){return this._actions||(this._actions=T_(this,{...this.env.config.actions||{},...this.env.opts.items?.[this.item_type_key]?.actions||{}})),this._actions}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),q_(e)}get collection_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),q_(e)}get collection(){return this.env[this.collection_key]}get key(){return this.data?.key||this.get_key()}get item_type_key(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),he(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,item_key:this.key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}once_event(e,t){return this.env.events?.once(e,s=>{s?.item_key&&s.item_key!==this.key||t(s)})}get data_adapter(){return this.collection.data_adapter}get data_fs(){return this.collection.data_fs}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]={}),this.env.settings[this.collection_key]}set settings(e){this.env.settings[this.collection_key]=e,this.env.smart_settings.save()}get ref(){return{collection_key:this.collection_key,key:this.key}}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}get name(){return j_(this.key,this.env.settings.smart_view_filter?.show_full_path)}};var JN=Object.getPrototypeOf(async function(){}).constructor,ae=class{static{r(this,"Collection")}static version=.001;constructor(e,t={}){e.create_env_getter(this),this.opts=t,t.collection_key&&(this.collection_key=t.collection_key),this.env[this.collection_key]=this,this.config=this.env.config,this.items={},this.loaded=null,this._loading=!1,this.load_time_ms=null,this.settings_container=null}static async init(e,t={}){e[this.collection_key]=new this(e,t),await e[this.collection_key].init(),e.collections[this.collection_key]="init"}static get collection_key(){let e=this.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}async init(){}create_or_update(e={}){let t=this.find_by(e),s=t||new this.item_type(this.env);s._queue_save=!t;let i=s.update_data(e);return!t&&!s.validate_save()?s:(t||this.set(s),t&&!i?t:s.init instanceof JN?new Promise(o=>{s.init(e).then(()=>o(s))}):(s.init(e),s))}find_by(e){if(e.key)return this.get(e.key);let t=new this.item_type(this.env),s=JSON.parse(JSON.stringify(e,t.sanitize_data(e)));return st(t.data,s),t.key?this.get(t.key):null}filter(e={}){if(typeof e=="function")return Object.values(this.items).filter(e);let t=[],{first_n:s}=e;for(let i of Object.values(this.items)){if(s&&t.length>=s)break;i.filter(e)&&t.push(i)}return t}list(e){return this.filter(e)}get(e){return this.items[e]}get_many(e=[]){return Array.isArray(e)?e.map(t=>this.get(t)).filter(Boolean):(console.error("get_many called with non-array keys:",e),[])}get_rand(e=null){if(e){let s=this.filter(e);return s[Math.floor(Math.random()*s.length)]}let t=this.keys;return this.items[t[Math.floor(Math.random()*t.length)]]}set(e){if(!e.key)throw new Error("Item must have a key property");this.items[e.key]=e}update_many(e=[],t={}){this.get_many(e).forEach(s=>s.update_data(t))}clear(){this.items={}}get collection_key(){return this._collection_key?this._collection_key:this.constructor.collection_key}set collection_key(e){this._collection_key=e}get data_adapter(){if(!this._data_adapter){let e=this.get_adapter_class("data");this._data_adapter=new e(this)}return this._data_adapter}get_adapter_class(e){let t=this.env.opts.collections?.[this.collection_key],s=e+"_adapter",i=t?.[s]??this.env.opts.collections?.smart_collections?.[s];if(typeof i=="function")return i;if(typeof i?.collection=="function")return i.collection;throw new Error(`No '${e}' adapter class found for ${this.collection_key} or smart_collections`)}get data_dir(){return this.collection_key}get data_fs(){return this.env.data_fs}get item_class_name(){let e=this.constructor.name;return e.match(/\d$/)&&(e=e.slice(0,-1)),e.endsWith("ies")?e.slice(0,-3)+"y":e.endsWith("s")?e.slice(0,-1):e+"Item"}get item_name(){return this.item_class_name.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}get item_type(){return this._item_type||(this._item_type=this.resolve_item_type()),this._item_type}resolve_item_type(){let e=[this.env.config?.items?.[this.item_name],this.opts.item_type,this.env.item_types?.[this.item_class_name]].filter(Boolean).sort((t,s)=>{let i=t?.class?.version||t.version||0;return(s?.class?.version||s.version||0)-i});if(e.length===0)throw new Error(`No item_type found for collection '${this.collection_key}' with item_name '${this.item_name}' or class_name '${this.item_class_name}'`);return e[0].class||e[0]}get keys(){return Object.keys(this.items)}get adapter(){return this.data_adapter}async process_save_queue(e={}){e.force&&Object.values(this.items).forEach(t=>t._queue_save=!0),await this.data_adapter.process_save_queue(e)}async save(e={}){await this.process_save_queue(e)}async process_load_queue(){await this.data_adapter.process_load_queue()}get settings_config(){return this.process_settings_config({})}process_settings_config(e,t=""){let s=r(i=>t&&!i.includes(`${t}.`)?`${t}.${i}`:i,"add_prefix");return Object.entries(e).reduce((i,[o,a])=>{let c={...a};if(c.conditional){if(!c.conditional(this))return i;delete c.conditional}c.callback&&(c.callback=s(c.callback)),c.btn_callback&&(c.btn_callback=s(c.btn_callback)),c.options_callback&&(c.options_callback=s(c.options_callback));let l=s(this.process_setting_key(o));return i[l]=c,i},{})}process_setting_key(e){return e}get default_settings(){return{}}get settings(){return this.env.settings[this.collection_key]||(this.env.settings[this.collection_key]=this.default_settings),this.env.settings[this.collection_key]}unload(){this.clear(),this.unloaded=!0,this.env.collections[this.collection_key]=null}show_process_notice(e,t={}){this.debounce_process_notice||(this.debounce_process_notice={}),this.debounce_process_notice[e]=setTimeout(()=>{this.debounce_process_notice[e]=null,this.env.notices?.show(e,{collection_key:this.collection_key,...t})},1e3)}clear_process_notice(e){this.debounce_process_notice?.[e]?(clearTimeout(this.debounce_process_notice[e]),this.debounce_process_notice[e]=null):this.env.notices?.remove(e)}emit_event(e,t={}){this.env.events?.emit(e,{collection_key:this.collection_key,...t})}on_event(e,t){return this.env.events?.on(e,s=>{s?.collection_key&&s.collection_key!==this.collection_key||t(s)})}get actions(){if(this.constructor.key||(this.constructor.key=this.collection_key),!this._actions){let e={...this.env?.config?.actions||{},...this.env?.config?.collections?.[this.collection_key]?.actions||{},...this.env?.opts?.collections?.[this.collection_key]?.actions||{},...this.opts?.actions||{}};this._actions=T_(this,e)}return this._actions}refresh_actions(){return this._actions=null,this.actions}queue_save(){this._debounce_queue_save&&clearTimeout(this._debounce_queue_save),this._debounce_queue_save=setTimeout(()=>{this.process_save_queue()},750)}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render_settings(e=this.settings_container,t={}){return await this.render_collection_settings(e,t)}async render_collection_settings(e=this.settings_container,t={}){e&&(!this.settings_container||this.settings_container!==e)?this.settings_container=e:e||(e=this.env.smart_view.create_doc_fragment("<div></div>")),this.env.smart_view.safe_inner_html(e,`<div class="sc-loading">Loading ${this.collection_key} settings...</div>`);let s=await this.env.render_component("settings",this,t);return this.env.smart_view.empty(e),e.appendChild(s),e}};var N_=class{static{r(this,"EntitiesVectorAdapter")}constructor(e){this.collection=e}async nearest(e,t={}){throw new Error("EntitiesVectorAdapter.nearest() not implemented")}async furthest(e,t={}){throw new Error("EntitiesVectorAdapter.furthest() not implemented")}async embed_batch(e){throw new Error("EntitiesVectorAdapter.embed_batch() not implemented")}async process_embed_queue(e){throw new Error("EntitiesVectorAdapter.process_embed_queue() not implemented")}},P_=class{static{r(this,"EntityVectorAdapter")}constructor(e){this.item=e}async get_vec(){throw new Error("EntityVectorAdapter.get_vec() not implemented")}async set_vec(e){throw new Error("EntityVectorAdapter.set_vec() not implemented")}async delete_vec(){throw new Error("EntityVectorAdapter.delete_vec() not implemented")}};function I_(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.min===Number.POSITIVE_INFINITY){let{minScore:s,minObj:i}=CE(n.results);n.min=s,n.minResult=i}}else if(e.score>n.min){n.results.add(e),n.results.delete(n.minResult);let{minScore:s,minObj:i}=CE(n.results);n.min=s,n.minResult=i}}r(I_,"results_acc");function qE(n,e,t=10){if(n.results.size<t){if(n.results.add(e),n.results.size===t&&n.max===Number.NEGATIVE_INFINITY){let{maxScore:s,maxObj:i}=OE(n.results);n.max=s,n.maxResult=i}}else if(e.score<n.max){n.results.add(e),n.results.delete(n.maxResult);let{maxScore:s,maxObj:i}=OE(n.results);n.max=s,n.maxResult=i}}r(qE,"furthest_acc");function CE(n){let e=Number.POSITIVE_INFINITY,t=null;for(let s of n)s.score<e&&(e=s.score,t=s);return{minScore:e,minObj:t}}r(CE,"find_min");function OE(n){let e=Number.NEGATIVE_INFINITY,t=null;for(let s of n)s.score>e&&(e=s.score,t=s);return{maxScore:e,maxObj:t}}r(OE,"find_max");function Fe(n,e){let s=n.score-e.score;return Math.abs(s)<1e-9?0:s>0?-1:1}r(Fe,"sort_by_score");function M_(n,e){return Fe(n,e)}r(M_,"sort_by_score_descending");function $E(n,e){return Fe(n,e)*-1}r($E,"sort_by_score_ascending");var L_=class extends N_{static{r(this,"DefaultEntitiesVectorAdapter")}constructor(e){super(e),this._is_processing_embed_queue=!1,this._reset_embed_queue_stats()}async nearest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to nearest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Is(e,a.vec)};return I_(o,c,s),o},{min:0,results:new Set});return Array.from(i.results).sort(M_)}async furthest(e,t={}){if(!e||!Array.isArray(e))throw new Error("Invalid vector input to furthest()");let{limit:s=50}=t,i=this.collection.filter(t).reduce((o,a)=>{if(!a.vec)return o;let c={item:a,score:Is(e,a.vec)};return qE(o,c,s),o},{max:0,results:new Set});return Array.from(i.results).sort($E)}async embed_batch(e){if(!this.collection.embed_model)throw new Error("No embed_model found in collection for embedding");await Promise.all(e.map(s=>s.get_embed_input())),(await this.collection.embed_model.embed_batch(e)).forEach((s,i)=>{let o=e[i];o.vec=s.vec,o.data.last_embed=o.data.last_read,s.tokens!==void 0&&(o.tokens=s.tokens),o.emit_event("item:embedded")})}async process_embed_queue(){if(this._is_processing_embed_queue){console.log("process_embed_queue is already running, skipping concurrent call.");return}this._is_processing_embed_queue=!0;try{this.collection.embed_model.is_loaded||await this.collection.embed_model.load()}catch{this.collection.emit_event("embed_model:load_failed"),this.notices?.show("Failed to load embed_model");return}try{let e=Date.now();console.log(`Getting embed queue for ${this.collection.collection_key}...`),await new Promise(s=>setTimeout(s,1));let t=this.collection.embed_queue;if(this._reset_embed_queue_stats(),this.collection.embed_model_key==="None"){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!this.collection.embed_model){console.log(`Smart Connections: No active embedding model for ${this.collection.collection_key}, skipping embedding`);return}if(!t.length){console.log(`Smart Connections: No items in ${this.collection.collection_key} embed queue`);return}console.log(`Time spent getting embed queue: ${Date.now()-e}ms`),console.log(`Processing ${this.collection.collection_key} embed queue: ${t.length} items`);for(let s=0;s<t.length;s+=this.collection.embed_model.batch_size){if(this.is_queue_halted){this.is_queue_halted=!1;break}this._show_embed_progress_notice(t.length);let i=t.slice(s,s+this.collection.embed_model.batch_size);await Promise.all(i.map(o=>o.get_embed_input()));try{let o=Date.now();await this.embed_batch(i),this.total_time+=Date.now()-o}catch(o){o&&o.message&&o.message.includes("API key not set")&&this.halt_embed_queue_processing(`API key not set for ${this.collection.embed_model_key}
Please set the API key in the settings.`),console.error(o),console.error(`Error processing ${this.collection.collection_key} embed queue: `+JSON.stringify(o||{},null,2))}i.forEach(o=>{o.embed_hash=o.read_hash,o._queue_save=!0}),this.embedded_total+=i.length,this.total_tokens+=i.reduce((o,a)=>o+(a.tokens||0),0),this.embedded_total-this.last_save_total>1e3&&(this.last_save_total=this.embedded_total,await this.collection.process_save_queue(),this.collection.block_collection&&(console.log(`Saving ${this.collection.block_collection.collection_key} block collection`),await this.collection.block_collection.process_save_queue()))}this._show_embed_completion_notice(t.length),await this.collection.process_save_queue(),this.collection.block_collection&&await this.collection.block_collection.process_save_queue()}finally{this._is_processing_embed_queue=!1}}get should_show_embed_progress_notice(){return Date.now()-(this.last_notice_time??0)>3e4?!0:this.embedded_total-this.last_notice_embedded_total>=100}_show_embed_progress_notice(e){e<100||this.should_show_embed_progress_notice&&(this.last_notice_time=Date.now(),this.last_notice_embedded_total=this.embedded_total,this.collection.emit_event("embedding:progress_reported",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_progress",{progress:this.embedded_total,total:e,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}_show_embed_completion_notice(){this.notices?.remove("embedding_progress"),this.embedded_total>100&&(this.collection.emit_event("embedding:completed",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_complete",{total_embeddings:this.embedded_total,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}))}halt_embed_queue_processing(e=null){this.is_queue_halted=!0,console.log("Embed queue processing halted"),this.notices?.remove("embedding_progress"),this.collection.emit_event("embedding:paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key}),this.notices?.show("embedding_paused",{progress:this.embedded_total,total:this.collection._embed_queue.length,tokens_per_second:this._calculate_embed_tokens_per_second(),model_name:this.collection.embed_model_key})}resume_embed_queue_processing(e=0){console.log("resume_embed_queue_processing"),this.notices?.remove("embedding_paused"),setTimeout(()=>{this.embedded_total=0,this.process_embed_queue()},e)}_calculate_embed_tokens_per_second(){let e=this.total_time/1e3;return Math.round(this.total_tokens/(e||1))}_reset_embed_queue_stats(){this.collection._embed_queue=[],this.embedded_total=0,this.is_queue_halted=!1,this.last_save_total=0,this.last_notice_embedded_total=0,this.total_tokens=0,this.total_time=0}get notices(){return this.collection.env.notices}},z_=class extends P_{static{r(this,"DefaultEntityVectorAdapter")}get data(){return this.item.data}async get_vec(){return this.vec}async set_vec(e){this.vec=e}async delete_vec(){this.item.data?.embeddings?.[this.item.embed_model_key]&&delete this.item.data.embeddings[this.item.embed_model_key].vec}get vec(){return this.item.data?.embeddings?.[this.item.embed_model_key]?.vec}set vec(e){this.item.data.embeddings||(this.item.data.embeddings={}),this.item.data.embeddings[this.item.embed_model_key]||(this.item.data.embeddings[this.item.embed_model_key]={}),this.item.data.embeddings[this.item.embed_model_key].vec=e}};var KN="---frontmatter---",jE=r(n=>Array.isArray(n)?n.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):typeof n=="string"?(n.includes(",")?n.split(","):[n]).map(t=>t.trim()).filter(t=>t.length>0):[],"to_array"),VN=r((n,e={})=>({...n.env.settings.smart_view_filter||{},...e,entity:n}),"merge_settings_with_params"),XN=r(n=>{let e={...n};return typeof e.limit<"u"&&delete e.limit,e.filter&&(e.filter={...e.filter},typeof e.filter.limit<"u"&&delete e.filter.limit),e},"remove_limit_fields"),YN=r(n=>{if(!n.exclude_frontmatter_blocks)return n;let e={...n},t=Array.isArray(e.exclude_key_ends_with_any)?[...e.exclude_key_ends_with_any]:[];return t.push(KN),e.exclude_key_ends_with_any=t,e},"apply_frontmatter_exclusion"),ZN=r((n,e)=>{if(!e)return n;let t={...n},s=Array.isArray(t.exclude_key_starts_with_any)?[...t.exclude_key_starts_with_any]:[];typeof t.exclude_key_starts_with=="string"&&(s.push(t.exclude_key_starts_with),delete t.exclude_key_starts_with);let i=e.source_key||e.key;if(i&&s.push(i),t.exclude_inlinks&&Array.isArray(e.inlinks)&&e.inlinks.length&&(s=[...s,...e.inlinks]),t.exclude_outlinks&&Array.isArray(e.outlinks)&&e.outlinks.length&&(s=[...s,...e.outlinks.map(o=>o.key)]),s.length&&(t.exclude_key_starts_with_any=s),t.exclude_filter){let o=jE(t.exclude_filter),a=Array.isArray(t.exclude_key_includes_any)?[...t.exclude_key_includes_any]:[];t.exclude_key_includes_any=[...a,...o]}if(t.include_filter){let o=jE(t.include_filter),a=Array.isArray(t.key_includes_any)?[...t.key_includes_any]:[];t.key_includes_any=[...a,...o]}return t},"append_entity_filters"),rf=r((n,e={})=>{let t=VN(n,e),s=XN(t),i=YN(s);return ZN(i,n)},"create_find_connections_filter_opts");async function ri(n={}){let e=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||10,t=rf(this,n);n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit;let s=this.key+oe(JSON.stringify({...t,entity:null}));if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[s]){let i=(await this.nearest(t)).sort(Fe).slice(0,e);this.connections_to_cache(s,i)}return this.connections_from_cache(s)}r(ri,"find_connections");ri.action_type="connections";var Rs=class extends re{static{r(this,"SmartEntity")}constructor(e,t={}){super(e,t),this.entity_adapter=new z_(this)}static get defaults(){return{data:{path:null,last_embed:{hash:null},embeddings:{}}}}get vector_adapter(){return this._vector_adapter||(this._vector_adapter=new this.collection.opts.vector_adapter.item(this)),this._vector_adapter}init(){super.init(),(!this.vec||!this.vec.length)&&(this.vec=null,this.queue_embed()),Object.entries(this.data.embeddings||{}).forEach(([e,t])=>{e!==this.embed_model_key&&(this.data.embeddings[e]=null,delete this.data.embeddings[e])})}queue_embed(){this._queue_embed=!0}async nearest(e={}){return await this.collection.nearest_to(this,e)}async get_embed_input(e=null){}get embed_input(){return this._embed_input?this._embed_input:this.get_embed_input()}async find_connections(e={}){return await this.actions.find_connections(e)}connections_from_cache(e){return this.env.connections_cache[e]}connections_to_cache(e,t){this.env.connections_cache[e]=t}get read_hash(){return this.data.last_read?.hash}set read_hash(e){this.data.last_read||(this.data.last_read={}),this.data.last_read.hash=e}get embedding_data(){return this.data.embeddings[this.embed_model_key]||(this.data.embeddings[this.embed_model_key]={}),this.data.embeddings[this.embed_model_key]}get last_embed(){return this.embedding_data.last_embed||(this.embedding_data.last_embed={},this.data.last_embed&&(this.embedding_data.last_embed=this.data.last_embed,delete this.data.last_embed,this.queue_save())),this.embedding_data.last_embed}get embed_hash(){return this.last_embed?.hash}set embed_hash(e){this.embedding_data.last_embed||(this.embedding_data.last_embed={}),this.embedding_data.last_embed.hash=e}get embed_link(){return`![[${this.path}]]`}get embed_model_key(){return this.collection.embed_model_key}get embed_model(){return this.collection.embed_model}get should_embed(){return this.size>(this.settings?.min_chars||300)}set error(e){this.data.embeddings[this.embed_model_key].error=e}get tokens(){return this.last_embed?.tokens}set tokens(e){this.last_embed.tokens=e}get vec(){return this.entity_adapter.vec}set vec(e){this.entity_adapter.vec=e,this._queue_embed=!1,this._embed_input=null,this.queue_save()}remove_embeddings(){this.data.embeddings=null,this.queue_save()}get_key(){return this.data.key||this.data.path}get path(){return this.data.path}get is_unembedded(){return!this.vec||!this.embed_hash||this.embed_hash!==this.read_hash}};var Fs=class extends ae{static{r(this,"SmartEntities")}constructor(e,t){super(e,t),this.entities_vector_adapter=new L_(this),this.model_instance_id=null,this._embed_queue=[]}async unload(){typeof this.embed_model?.unload=="function"&&this.embed_model.unload(),super.unload()}get embed_model_key(){return this.embed_model?.model_key}get embed_model(){if(this.env.embedding_models.default)return this.env.embedding_models.default.instance;throw new Error("DEPRECATED SMART ENVIRONMENT LOADED: UPDATE SMART PLUGINS.")}set embed_model(e){this.env._embed_model=e}reload_embed_model(){console.log("reload_embed_model"),this.embed_model.unload(),this.env._embed_model=null}async nearest_to(e,t={}){return await this.nearest(e.vec,t)}async nearest(e,t={}){return e?await this.entities_vector_adapter.nearest(e,t):(console.warn("nearest: no vec"),[])}async furthest(e,t={}){return e?await this.entities_vector_adapter.furthest(e,t):console.warn("furthest: no vec")}get file_name(){return this.collection_key+"-"+this.embed_model_key.split("/").pop()}async lookup(e={}){let{hypotheticals:t=[]}=e;if(!t?.length)return{error:"hypotheticals is required"};if(!this.embed_model)return{error:"Embedding search is not enabled."};let s=await this.embed_model.embed_batch(t.map(l=>({embed_input:l}))),i=e.filter?.limit||e.k||this.env.settings.lookup_k||10;e.filter?.limit&&delete e.filter.limit;let o={...this.env.chats?.current?.scope||{},...e.filter||{}},a=await s.reduce(async(l,d,_)=>{let m=await l;return(await this.nearest(d.vec,o)).forEach(f=>{!m[f.item.path]||f.score>m[f.item.path].score?m[f.item.path]={key:f.item.key,score:f.score,item:f.item,hypothetical_i:_}:f.score=m[f.item.path].score}),m},Promise.resolve({})),c=Object.values(a).sort(Fe).slice(0,i);return console.log(`Found and returned ${c.length} ${this.collection_key}.`),c}get settings_config(){return TE}async render_settings(e=this.settings_container,t={}){e=await this.render_collection_settings(e,t);let s=await this.env.render_component("settings",this.embed_model,t);return e.appendChild(s),e}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get embed_queue(){return this._embed_queue?.length||(console.time("Building embed queue"),this._embed_queue=Object.values(this.items).filter(e=>e._queue_embed||e.is_unembedded&&e.should_embed),console.timeEnd("Building embed queue")),this._embed_queue}async process_embed_queue(){await this.entities_vector_adapter.process_embed_queue()}async embed_model_changed(){await this.unload(),await this.init(),this.render_settings(),await this.process_load_queue()}get connections_filter_config(){return QN}},TE={min_chars:{name:"Minimum length",type:"number",description:"Minimum length of entity to embed (in characters).",placeholder:"Enter number ex. 300",default:300}},QN={"smart_view_filter.show_full_path":{name:"Show full path",type:"toggle",description:"Turning on will include the folder path in the connections results."},"smart_view_filter.results_limit":{name:"Results limit",type:"number",description:"Adjust the number of connections displayed in the connections view (default 20).",default:20},"smart_view_filter.exclude_inlinks":{name:"Exclude inlinks (backlinks)",type:"toggle",description:"Exclude notes that already link to the current note from the connections results."},"smart_view_filter.exclude_outlinks":{name:"Exclude outlinks",type:"toggle",description:"Exclude notes that are already linked from within the current note from appearing in the connections results."},"smart_view_filter.include_filter":{name:"Include filter",type:"text",description:"Notes must match this value in their file/folder path. Matching notes will be included in the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_filter":{name:"Exclude filter",type:"text",description:"Notes must *not* match this value in their file/folder path. Matching notes will be *excluded* from the connections results. Separate multiple values with commas."},"smart_view_filter.exclude_blocks_from_source_connections":{name:"Hide blocks in results",type:"toggle",description:"Show only sources in the connections results (no blocks)."}};async function af(n={}){let e=this.env.settings.smart_view_filter,t=n.exclude_blocks_from_source_connections??e?.exclude_blocks_from_source_connections??!1,s=n.filter?.limit||n.limit||this.env.settings.smart_view_filter?.results_limit||20,i;this.block_collection.settings.embed_blocks&&!t?i=[]:i=await ri.call(this,n);let o=rf(this,n);if(n.filter?.limit&&delete n.filter.limit,n.limit&&delete n.limit,!t){let a=this.key+oe(JSON.stringify({...o,entity:null}))+"_blocks";if(this.env.connections_cache||(this.env.connections_cache={}),!this.env.connections_cache[a]){let c=(await this.env.smart_blocks.nearest(this.vec,o)).sort(Fe).slice(0,s);this.connections_to_cache(a,c)}i=[...i,...this.connections_from_cache(a)].sort(Fe).slice(0,s)}return i}r(af,"find_connections");af.action_type="connections";var ai=class extends Rs{static{r(this,"SmartSource")}static get defaults(){return{data:{last_read:{hash:null,mtime:0},embeddings:{}},_embed_input:null,_queue_load:!0}}init(){super.init(),this.data.blocks||this.queue_import()}queue_import(){this._queue_import=!0}async import(){this._queue_import=!1;try{await this.source_adapter?.import(),this.emit_event("sources:imported")}catch(e){e.code==="ENOENT"?(console.log(`Smart Connections: Deleting ${this.path} data because it no longer exists on disk`),this.delete()):(console.warn("Smart Connections: Error during import: re-queueing import",e),this.queue_import())}}async parse_content(e=null){let t=this.env?.opts?.collections?.smart_sources?.content_parsers||[];for(let s of t)await s(this,e);this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks}async find_connections(e={}){return await this.actions.find_connections(e)}async get_embed_input(e=null){if(typeof this._embed_input=="string"&&this._embed_input.length)return this._embed_input;if(e||(e=await this.read()),!e)return console.warn("SmartSource.get_embed_input: No content available for embedding: "+this.path),"";if(this.excluded_lines.length){let o=e.split(`
`);this.excluded_lines.forEach(a=>{let{start:c,end:l}=a;for(let d=c;d<=l;d++)o[d]=""}),e=o.filter(a=>a.length).join(`
`)}let t=this.path.split("/").join(" > ").replace(".md",""),s=this.collection.embed_model.model.data.max_tokens||500,i=Math.floor(s*3.7);return this._embed_input=`${t}:
${e}`.substring(0,i),this._embed_input}open(){this.env.smart_connections_plugin.open_note(this.path)}get_block_by_line(e){return Object.entries(this.data.blocks||{}).reduce((t,[s,i])=>{if(t)return t;if(i[0]<=e&&i[1]>=e){let o=this.block_collection.get(this.key+s);if(o?.vec)return o}return t},null)}async has_source_file(){return await this.fs.exists(this.path)}async search(e={}){let{keywords:t,type:s="any",limit:i}=e;if(!t||!Array.isArray(t))return console.warn("Entity.search: keywords not set or is not an array"),0;if(i&&this.collection.search_results_ct>=i)return 0;let o=t.map(_=>_.toLowerCase()),a=await this.read();if(!a||typeof a!="string"||!a.length)return a.mime_type?console.warn(`Entity.search: No content available for searching: ${this.path}, mime_type: ${a.mime_type}`):console.warn(`Entity.search: No content available for searching: ${this.path}, content: ${a?JSON.stringify(a):"empty"}`),0;let c=a.toLowerCase(),l=this.path.toLowerCase(),d=o.filter(_=>l.includes(_)||c.includes(_));return s==="all"?d.length===o.length?d.length:0:d.length}use_source_adapter(e,...t){if(!this.source_adapter){console.warn(`No source adapter available for ${this.key}. Cannot use method ${e}.`);return}if(typeof this.source_adapter[e]!="function"){console.warn(`Source adapter for ${this.key} does not implement method ${e}.`);return}return this.source_adapter[e](...t)}async append(e){await this.use_source_adapter("append",e),await this.import()}async update(e,t={}){try{await this.use_source_adapter("update",e,t),await this.import()}catch(s){console.error(`Error during update for ${this.key}:`,s)}}async read(e={}){try{return await this.use_source_adapter("read",e)||""}catch(t){return console.error(`Error during reading ${this.key} (returning empty string)`,t),""}}async remove(){try{await this.use_source_adapter("remove")}catch(e){console.error(`Error during remove for ${this.key}:`,e)}}async move_to(e){try{await this.use_source_adapter("move_to",e)}catch(t){console.error(`Error during move for ${this.key}:`,t)}}async merge(e,t={}){try{await this.use_source_adapter("merge",e,t),await this.import()}catch(s){console.error(`Error during merge for ${this.key}:`,s)}}on_load_error(e){super.on_load_error(e),e.code==="ENOENT"&&(this._queue_load=!1,this.queue_import())}get block_collection(){return this.env.smart_blocks}get block_vecs(){return this.blocks.map(e=>e.vec).filter(e=>e)}get blocks(){return this.data.blocks?this.block_collection.get_many(Object.keys(this.data.blocks).map(e=>this.key+e)):[]}get excluded(){return this.fs.is_excluded(this.path)}get excluded_lines(){return this.blocks.filter(e=>e.excluded).map(e=>e.lines)}get fs(){return this.collection.fs}get file(){return this.fs.files[this.path]}get file_name(){return this.path.split("/").pop()}get file_path(){return this.path}get file_type(){return this._ext||(this._ext=this.collection.get_extension_for_path(this.path)||"md"),this._ext}get mtime(){return this.file?.stat?.mtime||0}get size(){return this.source_adapter?.size||0}get last_import(){return this.data?.last_import}get last_import_mtime(){return this.last_import?.mtime||0}get last_import_size(){return this.last_import?.size||0}get inlinks(){return Object.keys(this.collection.links?.[this.path]||{})}get is_media(){return this.source_adapter.is_media||!1}get is_gone(){return!this.file}get last_read(){return this.data.last_read}get metadata(){return this.data.metadata}get outdated(){return this.source_adapter.outdated}get outlinks(){return(this.data.outlinks||[]).map(e=>{let t=e?.target||e;return typeof t!="string"||t.startsWith("http")?null:{key:this.fs.get_link_target_path(t,this.file_path),embedded:e.embedded||!1}}).filter(e=>e)}get path(){return this.data.path||this.data.key}get source_adapters(){return this.collection.source_adapters}get source_adapter(){if(this._source_adapter)return this._source_adapter;if(this.source_adapters[this.file_type])this._source_adapter=new this.source_adapters[this.file_type](this);else for(let e of Object.values(this.source_adapters))if(typeof e.detect_type=="function"&&e.detect_type(this)){this._source_adapter=new e(this);break}return this._source_adapter}get mean_block_vec(){return this._mean_block_vec&&(this._mean_block_vec=Wh(this.block_vecs)),this._mean_block_vec}get median_block_vec(){return this._median_block_vec&&(this._median_block_vec=Gh(this.block_vecs)),this._median_block_vec}async _read(){return await this.source_adapter._read()}async destroy(){await this.remove()}async _update(e){await this.source_adapter.update(e)}get t_file(){return this.fs.files[this.path]}},NE={class:ai,actions:{find_connections:af}};var $r=class extends Fs{static{r(this,"SmartSources")}constructor(e,t={}){super(e,t),this.search_results_ct=0,this._excluded_headings=null,this.env_event_unsubscribers=[],this.sources_re_import_queue={},this.sources_re_import_timeout=null,this.sources_re_import_halted=!1}async init(){await super.init(),await this.init_items(),this.register_env_event_listeners(),this.register_source_watchers()}register_env_event_listeners(){if(this.unregister_env_event_listeners(),!this.env?.events)return;let e=[["sources:created",t=>this.handle_source_created(t)],["sources:modified",t=>this.handle_source_modified(t)],["sources:renamed",t=>this.handle_source_renamed(t)],["sources:deleted",t=>this.handle_source_deleted(t)]];this.env_event_unsubscribers=e.map(([t,s])=>this.env.events.on(t,s)).filter(Boolean)}unregister_env_event_listeners(){if(Array.isArray(this.env_event_unsubscribers))for(;this.env_event_unsubscribers.length;){let e=this.env_event_unsubscribers.pop();try{e?.()}catch(t){console.warn("SmartSources: Failed to unregister env event listener",t)}}}should_handle_event(e={}){let{collection_key:t}=e;return!(t&&t!==this.collection_key)}get_event_path(e={}){return e.item_key||e.path||e.new_path}handle_source_created(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t)return;let s=this.init_file_path(t)||this.get(t);if(!s){console.warn("SmartSources: Unable to initialize source on create event",e);return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_modified(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);if(!t||this.fs.is_excluded(t))return;let s=this.get(t);if(s||(s=this.init_file_path(t)),!s){console.warn("SmartSources: Unable to resolve source on modify event",{key:t,event:e});return}this.queue_source_re_import(s,{event_source:e.event_source})}handle_source_renamed(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e),s=e.old_path||e.from;if(!t&&!s||(s&&this.items[s]&&(this.items[s]?.delete?.(),delete this.items[s],this.rename_debounce_timeout&&clearTimeout(this.rename_debounce_timeout),this.rename_debounce_timeout=setTimeout(()=>{this.process_save_queue(),this.rename_debounce_timeout=null},1e3)),!t))return;let i=this.get(t);if(i||(i=this.init_file_path(t)),!i){console.warn("SmartSources: Unable to initialize source on rename event",e);return}this.queue_source_re_import(i,{event_source:e.event_source})}handle_source_deleted(e={}){if(!this.should_handle_event(e))return;let t=this.get_event_path(e);t&&(delete this.items[t],this.sources_re_import_queue[t]&&delete this.sources_re_import_queue[t])}register_source_watchers(){let e=this.fs?.adapter;!e||typeof e.register_source_watchers!="function"||this._source_watchers_registered||(this._source_watchers_registered=e.register_source_watchers(this))}queue_source_re_import(e,t={}){e?.key&&(this.sources_re_import_queue[e.key]||(e.data.last_import={at:0,hash:null,mtime:0,size:0},this.sources_re_import_queue[e.key]={source:e,event_meta:t},this.debounce_re_import_queue()))}debounce_re_import_queue(){if(this.sources_re_import_halted=!0,this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),!Object.keys(this.sources_re_import_queue||{}).length){this.sources_re_import_timeout=null;return}let t=typeof this.env?.settings?.re_import_wait_time=="number"?this.env.settings.re_import_wait_time:13;this.sources_re_import_timeout=setTimeout(()=>this.run_re_import(),t*1e3)}async run_re_import(){this.sources_re_import_halted=!1;let e=Object.entries(this.sources_re_import_queue||{});if(!e.length){this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null;return}for(let[t,{source:s}]of e){if(await s.import(),this._embed_queue||(this._embed_queue=[]),s.should_embed&&this._embed_queue.push(s),this.block_collection?.settings?.embed_blocks)for(let i of s.blocks||[])(i._queue_embed||i.should_embed&&i.is_unembedded)&&(this._embed_queue.push(i),i._queue_embed=!0);if(delete this.sources_re_import_queue[t],this.sources_re_import_halted){this.debounce_re_import_queue();break}}if(this._embed_queue?.length){let t=Date.now();await this.process_embed_queue(),console.log(`Processed embed queue in ${Date.now()-t}ms`)}this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null}async init_items(){this.emit_event("source:initial_scan_started"),this.show_process_notice("initial_scan");for(let e of Object.values(this.source_adapters))typeof e.init_items=="function"&&await e.init_items(this);this.clear_process_notice("initial_scan"),this.emit_event("source:initial_scan_completed"),this.notices?.show("done_initial_scan",{collection_key:this.collection_key})}init_file_path(e){if(!this.get_extension_for_path(e))return;if(this.fs.is_excluded(e)){console.warn(`File ${e} is excluded from processing.`);return}if(this.fs.files[e]||this.fs.include_file(e),this.items[e])return this.items[e];let s=new this.item_type(this.env,{path:e});return this.items[e]=s,s.queue_import(),s.queue_load(),s}get_extension_for_path(e){if(!e)return;let t=e.split(".");if(t.length<2)return;let s;for(t.shift();t.length;){let i=t.join(".").toLowerCase();if(this.source_adapters[i])return i;s=t.shift()}return s}build_links_map(){let e=Date.now();this.links={};for(let s of Object.values(this.items))for(let i of s.outlinks)this.links[i.key]||(this.links[i.key]={}),this.links[i.key][s.key]={...i,key:void 0};let t=Date.now();return console.log(`Time spent building links: ${t-e}ms`),this.links}async create(e,t){await this.fs.write(e,t),await this.fs.refresh();let s=await this.create_or_update({path:e});return await s.import(),s}async search(e={}){let{keywords:t,limit:s,...i}=e;if(!t)return console.warn("search_filter.keywords not set"),[];this.search_results_ct=0;let o=this.filter(i),a=[];for(let c=0;c<o.length;c+=10){let l=o.slice(c,c+10),d=await Promise.all(l.map(async _=>{try{let m=await _.search(e);return m?(this.search_results_ct++,{item:_,score:m}):null}catch(m){return console.error(`Error searching item ${_.id||"unknown"}:`,m),null}}));a.push(...d.filter(Boolean))}return a.sort((c,l)=>l.score-c.score).map(c=>c.item)}async lookup(e={}){let t=e.filter?.limit||e.k||this.env.settings.lookup_k||10;if(e.filter?.limit&&delete e.filter.limit,e.collection){let i=this.env[e.collection];if(i&&i.lookup){delete e.collection,e.skip_blocks=!0;let o=await i.lookup(e);return o.error?(console.warn(o.error),[]):o.slice(0,t)}}let s=await super.lookup(e);return s.error?(console.warn(s.error),[]):(this.block_collection?.settings?.embed_blocks&&!e.skip_blocks&&(s=[...s,...await this.block_collection.lookup(e)].sort(Fe)),s.slice(0,t))}async process_load_queue(){await super.process_load_queue(),this.collection_key==="smart_sources"&&this.env.smart_blocks&&Object.values(this.env.smart_blocks.items).forEach(e=>e.init()),this.block_collection&&(this.block_collection.loaded=Object.keys(this.block_collection.items).length),this.opts.prevent_import_on_load||await this.process_source_import_queue(this.opts),this.build_links_map(),this.block_collection.cleanup_blocks()}async process_source_import_queue(e={}){let{process_embed_queue:t=!0,force:s=!1}=e;s&&Object.values(this.items).forEach(o=>o._queue_import=!0);let i=Object.values(this.items).filter(o=>o._queue_import);if(console.log("import_queue "+i.length),i.length){let o=Date.now();for(let a=0;a<i.length;a+=100)this.notices?.show("import_progress",{progress:a,total:i.length}),await Promise.all(i.slice(a,a+100).map(c=>c.import()));setTimeout(()=>{this.notices?.remove("import_progress")},1e3),this.notices?.show("done_import",{count:i.length,time_in_seconds:(Date.now()-o)/1e3})}else this.notices?.show("no_import_queue");this.build_links_map(),t?await this.process_embed_queue():console.log("skipping process_embed_queue"),await this.process_save_queue(),await this.block_collection?.process_save_queue(),this.emit_event("sources:import_completed")}get source_adapters(){if(!this._source_adapters){let t=Object.entries(this.env.opts.collections?.[this.collection_key]?.source_adapters||{}).reduce((s,[i,o])=>(o.extensions?o.extensions?.forEach(a=>s[a]=o):typeof o.detect_type=="function"&&(s[i]=o),s),{});Object.keys(t).length&&(this._source_adapters=t)}return this._source_adapters}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get current_note(){return this.get(this.env.smart_connections_plugin.app.workspace.getActiveFile().path)}get fs(){return this._fs||(this._fs=new this.env.opts.modules.smart_fs.class(this.env,{adapter:this.env.opts.modules.smart_fs.adapter,fs_path:this.env.opts.env_path||"",exclude_patterns:this.excluded_patterns||[]})),this._fs}get settings_config(){return{...super.settings_config,...this.process_settings_config(eP),...Object.entries(this.source_adapters).reduce((t,[s,i])=>{if(t[i])return t;let o=this.items[Object.keys(this.items).find(c=>c.endsWith(s))],a=new i(o||new this.item_type(this.env,{}));return a.settings_config&&(t[i.name]={type:"html",value:`<h4>${i.name} adapter</h4>`},t={...t,...a.settings_config}),t},{})}}get block_collection(){return this.env.smart_blocks}get embed_queue(){if(!this._embed_queue.length)try{let e=this.block_collection.settings.embed_blocks;this._embed_queue=Object.values(this.items).reduce((t,s)=>((s._queue_embed||s.should_embed&&s.is_unembedded)&&t.push(s),e&&s.blocks.forEach(i=>{(i._queue_embed||i.should_embed&&i.is_unembedded)&&t.push(i)}),t),[])}catch(e){console.error("Error getting embed queue:",e)}return this._embed_queue}async run_clear_all(){this.notices?.show("clearing_all"),await this.data_adapter.clear_all(),this.clear(),this.block_collection.clear(),this._fs=null,await this.init_fs(),await this.init_items(),this._excluded_headings=null,Object.values(this.items).forEach(e=>{e.queue_import(),e.queue_embed(),e.loaded_at=Date.now()+9999999999}),this.notices?.remove("clearing_all"),this.notices?.show("done_clearing_all"),await this.process_source_import_queue()}async init_fs(e={}){let{force_refresh:t=!1}=e;t&&await this.env.fs.refresh(),await this.fs.load_exclusions(),this.fs.file_paths=this.fs.post_process(this.env.fs.file_paths),this.fs.files=this.fs.file_paths.reduce((s,i)=>(s[i]=this.env.fs.files[i],s),{}),this.fs.folder_paths=this.fs.post_process(this.env.fs.folder_paths),this.fs.folders=this.fs.folder_paths.reduce((s,i)=>(s[i]=this.env.fs.folders[i],s),{})}get excluded_patterns(){return[...this.file_exclusions?.map(e=>`${e}**`)||[],...(this.folder_exclusions||[]).map(e=>`${e}**`),this.env.env_data_dir+"/**"]}get file_exclusions(){let e=this.env.settings?.smart_sources?.file_exclusions;return e?.length?e.split(",").map(t=>t.trim()):[]}get folder_exclusions(){let e=this.env.settings?.smart_sources?.folder_exclusions;return e?.length?e.split(",").map(t=>(t=t.trim(),t===""||t==="/"?!1:t.endsWith("/")?t:t+"/")).filter(Boolean):[]}get excluded_headings(){if(!this._excluded_headings){let e=this.env.settings?.smart_sources?.excluded_headings;this._excluded_headings=e?.length?e.split(",").map(t=>t.trim()):[]}return this._excluded_headings}get included_files(){let e=Object.keys(this.source_adapters);return this.fs.file_paths.filter(t=>e.some(s=>t.endsWith(s))&&!this.fs.is_excluded(t)).length}get excluded_file_paths(){return this.env.fs.file_paths.filter(e=>this.fs.is_excluded(e))}get total_files(){return this.fs.file_paths.filter(e=>e.endsWith(".md")||e.endsWith(".canvas")).length}unload(){this.unregister_env_event_listeners(),this.sources_re_import_timeout&&clearTimeout(this.sources_re_import_timeout),this.sources_re_import_timeout=null,this.sources_re_import_queue={},super.unload()}get data_dir(){return"multi"}},eP={};var D_=class{static{r(this,"CollectionDataAdapter")}constructor(e){this.collection=e,this.env=e.env}ItemDataAdapter=jr;create_item_adapter(e){if(!this.ItemDataAdapter)throw new Error("No item_adapter_class specified and create_item_adapter not overridden.");return new this.ItemDataAdapter(e)}async load_item(e){throw new Error("Not implemented")}async save_item(e){throw new Error("Not implemented")}async delete_item(e){throw new Error("Not implemented")}async process_load_queue(){throw new Error("Not implemented")}async process_save_queue(){throw new Error("Not implemented")}async load_item_if_updated(e){await this.create_item_adapter(e).load_if_updated()}async clear_all(){throw new Error("Not implemented")}},jr=class{static{r(this,"ItemDataAdapter")}constructor(e){this.item=e}async load(){throw new Error("Not implemented")}async save(e=null){throw new Error("Not implemented")}async delete(){throw new Error("Not implemented")}get data_path(){throw new Error("Not implemented")}get collection_adapter(){return this.item.collection.data_adapter}get env(){return this.item.env}async load_if_updated(){throw new Error("Not implemented")}};var R_=class extends D_{static{r(this,"FileCollectionDataAdapter")}ItemDataAdapter=Tr;get fs(){return this.collection.data_fs||this.collection.env.data_fs}async clear_all(){await this.fs.remove_dir(this.collection.data_dir,!0)}},Tr=class extends jr{static{r(this,"FileItemDataAdapter")}get fs(){return this.item.collection.data_fs||this.item.collection.env.data_fs}get data_path(){throw new Error("Not implemented")}async load_if_updated(){let e=this.data_path;if(await this.fs.exists(e)){let t=this.item.loaded_at||0;(await this.fs.stat(e)).mtime>t+60*1e3&&(console.log(`Smart Collections: Re-loading item ${this.item.key} because it has been updated on disk`),await this.load())}}};var PE={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"},Yt=class extends R_{static{r(this,"AjsonMultiFileCollectionDataAdapter")}ItemDataAdapter=At;async load_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).load()}async save_item(e){let t=this.collection.get(e);if(!t)return;await this.create_item_adapter(t).save()}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=Object.values(this.collection.items).filter(i=>i._queue_load);if(!e.length){this.collection.clear_process_notice("loading_collection");return}let t=Date.now();console.log(`Loading ${this.collection.collection_key}: ${e.length} items from disk`);let s=100;for(let i=0;i<e.length;i+=s){let o=e.slice(i,i+s);await Promise.all(o.map(a=>this.create_item_adapter(a).load().catch(l=>{console.warn(`Error loading item ${a.key}`,l),a.queue_load()})))}console.log(`Loaded ${this.collection.collection_key} from disk in ${Date.now()-t}ms`),this.collection.loaded=e.length,this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}get_item_data_path(e){return[this.collection.data_dir||"multi",this.fs?.sep||"/",this.get_data_file_name(e)+".ajson"].join("")}get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}get_item_ajson(e){let t=e.collection_key,s=e.key,i=e.deleted?"null":JSON.stringify(e.data);return`${JSON.stringify(`${t}:${s}`)}: ${i},`}},At=class extends Tr{static{r(this,"AjsonMultiFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){try{let e=await this.fs.adapter.read(this.data_path,"utf-8",{no_cache:!0});if(!e){this.item.queue_import();return}let{rewrite:t,file_data:s}=this._parse(e);t&&(s.length?await this.fs.write(this.data_path,s):await this.fs.remove(this.data_path));let i=this.item.data.last_import?.at||0;i&&this.item.init_file_mtime>i&&this.item.queue_import()}catch{this.item.queue_import()}}_parse(e){try{let t=!1;if(!e.length)return!1;e=e.trim();let s=e.split(`
`).length,i="{"+e.slice(0,-1)+"}",o=JSON.parse(i),a=Object.entries(o);for(let c=0;c<a.length;c++){let[l,d]=a[c];if(!d){delete o[l],t=!0;continue}let{collection_key:_,item_key:m,changed:p}=this._parse_ajson_key(l);p&&(t=!0,o[_+":"+m]=d,delete o[l]);let f=this.env[_];if(!f)continue;let y=f.get(m);if(d.key||(d.key=m),y)y.data=d,y._queue_load=!1,y.loaded_at=Date.now();else{let g=f.item_type,v=new g(this.env,d);v._queue_load=!1,v.loaded_at=Date.now(),f.set(v)}}return(t||s>a.length)&&(t=!0),{rewrite:t,file_data:t?Object.entries(o).map(([c,l])=>`${JSON.stringify(c)}: ${JSON.stringify(l)},`).join(`
`):null}}catch(t){return e.split(`
`).some(s=>!s.endsWith(","))?(console.warn("fixing trailing comma error"),e=e.split(`
`).map(s=>s.endsWith(",")?s:s+",").join(`
`),this._parse(e)):(console.warn("Error parsing JSON:",t),{rewrite:!0,file_data:null})}}_parse_ajson_key(e){let t,[s,...i]=e.split(":");return PE[s]&&(s=PE[s],t=!0),{collection_key:s,item_key:i.join(":"),changed:t}}async save(e=0){try{let t=this.get_item_ajson();await this.fs.append(this.data_path,`
`+t),this.item._queue_save=!1}catch(t){if(t.code==="ENOENT"&&e<1){let s=this.collection_adapter.collection.data_dir;return await this.fs.exists(s)||await this.fs.mkdir(s),await this.save(e+1)}console.warn("Error saving item",this.data_path,this.item.key,t)}}get_item_ajson(){return this.collection_adapter.get_item_ajson(this.item)}};var Nr=class extends Yt{static{r(this,"AjsonMultiFileSourcesDataAdapter")}ItemDataAdapter=cf},cf=class extends At{static{r(this,"AjsonMultiFileSourceDataAdapter")}};var F_=class{static{r(this,"SourceContentAdapter")}constructor(e){this.item=e}async import(){this.throw_not_implemented("import")}async create(){this.throw_not_implemented("create")}async update(){this.throw_not_implemented("update")}async read(){this.throw_not_implemented("read")}async remove(){this.throw_not_implemented("remove")}get data(){return this.item.data}create_hash(e){return oe(e)}get settings(){return this.item.env.settings.smart_sources[this.adapter_key]}get adapter_key(){return IE(this.constructor.name)}static get adapter_key(){return IE(this.name)}get fs(){return this.item.collection.fs}get env(){return this.item.env}};function IE(n){return n[0].toLowerCase()+n.slice(1).replace(/([A-Z])/g,"_$1").toLowerCase()}r(IE,"to_snake");function B_(n,e={}){let{start_index:t=1,line_keys:s=!1}=e,i=n.split(`
`),o=e.list_key_word_len||10,a={},c=[],l={},d={},_={},m={},p=[],f={},y=null,g=null,v=!1,k=!1,w="#",q=!1,E=[],S=null;_[w]=0;for(let O=0;O<i.length;O++){let A=O+t,u=i[O],h=u.trim();if(h==="---"){if(!k&&A===1){k=!0,v=!0,l["#---frontmatter---"]=[A,null];continue}else if(v){v=!1,l["#---frontmatter---"][1]=A;continue}}if(v)continue;if(!q&&/^[-*+]\s+\[(?: |x|X)\]/.test(h)&&(p.push(A),/^[-*+]\s+\[ \]/.test(h)&&(f.incomplete||(f.incomplete={all:[],top:[]}),f.incomplete.all.push(A)),/^[-*+]\s+\[ \]/.test(u)&&f.incomplete.top.push(A)),h.startsWith("```")){if(q=!q,q&&!S?S=A:!q&&S&&(E.push([S,A]),S=null),!g){let x=c.length>0?c[c.length-1].key:w;if(x===w&&!l[w]&&(l[w]=[A,null]),x===w)g={key:w,start_line:A},(l[w][1]===null||l[w][1]<A)&&(l[w][1]=null);else{_[x]===void 0&&(_[x]=0),_[x]+=1;let $=_[x],T=`${x}#{${$}}`;l[T]=[A,null],g={key:T,start_line:A}}}continue}let b=h.match(/^(#{1,6})\s*(.+)$/);if(b&&!q){let x=b[1].length,$=b[2].trim();for(;c.length>0&&c[c.length-1].level>=x;){let Z=c.pop();l[Z.key][1]===null&&(l[Z.key][1]=A-1)}c.length===0&&l[w]&&l[w][1]===null&&(l[w][1]=A-1),g&&(l[g.key][1]===null&&(l[g.key][1]=A-1),g=null),y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null);let T="",N=0;if(c.length>0?(T=c[c.length-1].key,N=c[c.length-1].level):(T="",N=0),c.length===0)d[$]=(d[$]||0)+1,d[$]>1&&($+=`[${d[$]}]`);else{m[T]||(m[T]={}),m[T][$]=(m[T][$]||0)+1;let Z=m[T][$];Z>1&&($+=`#{${Z}}`)}let Y=x-N,H="#".repeat(Y),$e=T+H+$;l[$e]=[A,null],_[$e]=0,c.push({level:x,title:$,key:$e});continue}let j=u.match(/^(\s*)([-*]|\d+\.) (.+)$/);if(j&&!q){if(j[1].length===0){y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null),g&&g.key!==w&&(l[g.key][1]===null&&(l[g.key][1]=A-1),g=null);let $=c.length>0?c[c.length-1].key:w;$===w&&!l[w]&&(l[w]=[A,null]),_[$]===void 0&&(_[$]=0),_[$]+=1;let T=_[$],N;if(s){let Y=j[3].replace(/^\[(?: |x|X)\]\s*/,""),H=tP(Y,o);N=`${$}#${H}`}else N=`${$}#{${T}}`;l[N]=[A,null],y={key:N,start_line:A};continue}if(y)continue}if(h!==""&&!g){y&&(l[y.key][1]===null&&(l[y.key][1]=A-1),y=null);let x=c.length>0?c[c.length-1].key:w;if(x===w)l[w]||(l[w]=[A,null]),(l[w][1]===null||l[w][1]<A)&&(l[w][1]=null),g={key:w,start_line:A};else{_[x]===void 0&&(_[x]=0),_[x]+=1;let $=_[x],T=`${x}#{${$}}`;l[T]=[A,null],g={key:T,start_line:A}}}}let C=i.length;for(;c.length>0;){let O=c.pop();l[O.key][1]===null&&(l[O.key][1]=C+t-1)}y&&(l[y.key][1]===null&&(l[y.key][1]=C+t-1),y=null),g&&(l[g.key][1]===null&&(l[g.key][1]=C+t-1),g=null),l[w]&&l[w][1]===null&&(l[w][1]=C+t-1);for(let O in l)a[O]=l[O];return{blocks:a,task_lines:p,tasks:f,codeblock_ranges:E}}r(B_,"parse_markdown_blocks");function tP(n,e=3){return n.split(/\s+/).sort((s,i)=>i.length-s.length).slice(0,e).sort((s,i)=>n.indexOf(s)-n.indexOf(i)).join(" ")}r(tP,"get_longest_words_in_order");var Zt=class extends F_{static{r(this,"FileSourceContentAdapter")}static async init_items(e){if(!e.fs_items_initialized){e._fs=null,await e.fs.init(),await e.init_fs();for(let t of Object.values(e.fs.files)){let s=e.init_file_path(t.path);s&&(s.init_file_mtime=t.stat.mtime)}e.fs_items_initialized=Date.now()}}get fs(){return this.item.collection.fs}get file_path(){return this.item.file_path}async create(e=null){e||(e=this.item.data.content||""),await this.fs.write(this.file_path,e)}async update(e){await this.fs.write(this.file_path,e)}async read(){let e=await this.fs.read(this.file_path);return this.data.last_read={hash:this.create_hash(e||""),at:Date.now()},e}async remove(){await this.fs.remove(this.file_path)}async move_to(e){if(!e)throw new Error("Invalid entity reference for move_to operation");let t=await this.read(),s=!1;if(typeof e=="string"){let i=this.item.collection.get(e);i&&(e=i,s=!0)}else s=!0;return s?await e.append(t):e=await this.item.collection.create(e,t),this.item.key!==e.key?(await this.remove(),this.item.delete()):console.log(`did not delete ${this.item.key} because it was moved to ${e.key}`),e}async merge(e,t={}){let{mode:s="append_blocks"}=t,{blocks:i,task_lines:o}=B_(e);if(typeof i!="object"||Array.isArray(i))throw console.warn("merge error: Expected an object from parse_markdown_blocks, but received:",i),new Error("merge error: parse_markdown_blocks did not return an object as expected.");let{new_blocks:a,new_with_parent_blocks:c,changed_blocks:l,same_blocks:d}=await this.get_changes(i,e);for(let _ of a)await this.append(_.content);for(let _ of c)await this.item.block_collection.get(_.parent_key).append(_.content);for(let _ of l){let m=this.item.block_collection.get(_.key);s==="replace_blocks"?await m.update(_.content):await m.append(_.content)}}async get_changes(e,t){let s=[],i=[],o=[],a=[],c=this.source.data.blocks||{};for(let[l,d]of Object.entries(e)){let _=!!c[l],m=`${this.source.key}${l}`,p=get_line_range(t,d[0],d[1]);if(!_){s.push({key:m,state:"new",content:p});continue}let f,y=l.split("#"),g;for(;!f&&y.length>0;)y.pop(),g=y.join("#"),f=!!c[g];if(f){i.push({key:m,parent_key:`${this.source.key}${g}`,state:"new",content:p});continue}let v=this.item.block_collection.get(m);if(await this.create_hash(p)!==v.last_read?.hash){o.push({key:m,state:"changed",content:p});continue}a.push({key:m,state:"same",content:p})}return{new_blocks:s,new_with_parent_blocks:i,changed_blocks:o,same_blocks:a}}async append(e){let s=[await this.read(),"",e].join(`
`).trim();await this.update(s)}get size(){return this.item.file?.stat?.size||0}};function ci(n){let e=[],t=/\[([^\]]+?)\]\(([^)]+?)\)/g,s=/\[\[([^\|\]]+?)(?:\|([^\]]+?))?\]\]/g,i=r(c=>{let l=c.trim();if(/^[a-zA-Z][\w+\-.]*:\/\//.test(l))return l;try{return decodeURIComponent(l)}catch{return l.replace(/%20/gi," ")}},"normalise_target"),o=r(c=>c<=0?!1:n[c-1]==="!","is_embedded"),a;for(;(a=t.exec(n))!==null;){let c=a[1],l=i(a[2]),d=n.slice(0,a.index).split(`
`).length,_=o(a.index),m={title:c,target:l,line:d};_&&(m.embedded=!0),e.push(m)}for(;(a=s.exec(n))!==null;){let c=a[1],l=a[2]||c,d=i(c),_=n.slice(0,a.index).split(`
`).length,m=o(a.index),p={title:l,target:d,line:_};m&&(p.embedded=!0),e.push(p)}return e.sort((c,l)=>c.line-l.line||c.target.localeCompare(l.target))}r(ci,"get_markdown_links");function U_({source:n,links:e=[],cache:t}={}){if(!n||!Array.isArray(e)||!e.length)return[];let s=t||n?.env?.bases_caches?.items;if(!s)return[];let i=n?.key||n?.path;return i?e.flatMap(o=>{if(!o?.embedded)return[];if(typeof o.target!="string"||!o.target.includes(".base"))return[];let a=`${i}#${o.target}`,c=s?.[a]?.markdown_table;if(!c)return[];let l=ci(c);return l.length?l.map(d=>({...d,line:o.line,bases_row:d.line-2})):[]}):[]}r(U_,"get_bases_cache_links");function lf(n){let e=n.trim();if(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);let t=e.toLowerCase();return t==="true"?!0:t==="false"?!1:!isNaN(e)&&e!==""?Number(e):e}r(lf,"parse_value");function sP(n){let e=n.split(/\r?\n/),t={},s=0;for(;s<e.length;){let i=e[s];if(s++,!i.trim()||i.trim().startsWith("#"))continue;let o=i.match(/^([^:]+)\s*:\s*(.*)$/);if(!o)continue;let a=o[1].trim(),c=o[2].trim();if(c===">"||c==="|"){let l=[];for(;s<e.length;){let _=e[s];if(!/^\s+/.test(_)||_.trim().startsWith("#"))break;l.push(_.replace(/^\s+/,"")),s++}let d=l.join(`
`);t[a]=lf(d)}else if(c===""){let l=[],d=!1;for(;s<e.length;){let _=e[s];if(!_.trim().startsWith("- "))break;let m=_.trim().slice(2);l.push(lf(m)),s++,d=!0}d?t[a]=l:t[a]=""}else t[a]=lf(c)}return t}r(sP,"parse_yaml_block");function ME(n){if(!n.startsWith("---"))return{frontmatter:{},body:n};let e=n.split(/\r?\n/),t=-1;for(let l=1;l<e.length;l++)if(e[l].trim()==="---"){t=l;break}if(t===-1)return{frontmatter:{},body:n};let i=e.slice(1,t).join(`
`),o=sP(i),c=e.slice(t+1).join(`
`);return{frontmatter:o,body:c}}r(ME,"parse_frontmatter");var LE=r((n="")=>{let e=/(?<!\w)#([\w/-]+)/g,t=new Set,s;for(;(s=e.exec(n))!==null;)t.add(`#${s[1]}`);return[...t]},"get_markdown_tags");var Pr=class extends Zt{static{r(this,"MarkdownSourceContentAdapter")}static extensions=["md","txt"];async import(){if(!this.can_import)return;if(!this.outdated){this.item.blocks.forEach(i=>{i.vec||i.queue_embed()});return}let e=await this.read();if(!e||(this.item.vec||(this.item.data.last_import=null),this.data.last_import?.hash===this.data.last_read?.hash&&this.data.blocks))return;this.data.blocks=null,await this.parse_content(e),await this.item.parse_content(e);let{mtime:t,size:s}=this.item.file.stat;this.data.last_import={mtime:t,size:s,at:Date.now(),hash:this.data.last_read.hash},this.item.loaded_at=Date.now(),this.item.queue_save(),this.item.should_embed&&this.item.queue_embed()}async parse_content(e){let t=await this.get_links(e);this.data.outlinks=t;let s=await this.get_metadata(e);this.data.metadata=s}async get_links(e=null){if(e||(e=await this.read()),!e)return;let t=ci(e),s=U_({source:this.item,links:t});return[...t,...s]}async get_metadata(e=null){if(e||(e=await this.read()),!e)return;let{frontmatter:t,body:s}=ME(e),i=new Set,o=t.tags;return typeof o=="string"&&(o=o.replace(/[\[\]]/g,"").split(",").map(a=>a.trim()).filter(Boolean)),Array.isArray(o)&&o.forEach(a=>i.add(a.startsWith("#")?a:`#${a}`)),LE(s).forEach(a=>i.add(a)),i.size&&(t.tags=[...i]),t}get can_import(){return this.item.file?this.item.size>(this.settings?.max_import_size||3e5)?(console.warn(`MarkdownSourceContentAdapter: Skipping large file: ${this.file_path}`),!1):!0:(console.warn(`MarkdownSourceContentAdapter: Skipping missing-file: ${this.file_path}`),!1)}get should_import(){return this.outdated}get outdated(){try{if(!this.data.last_import)if(this.data.mtime&&this.data.size&&this.data.hash)this.data.last_import={mtime:this.data.mtime,size:this.data.size,at:Date.now(),hash:this.data.hash},delete this.data.mtime,delete this.data.size,delete this.data.hash;else return!0;return this.data.last_read.at>this.data.last_import.at&&this.data.last_import?.hash!==this.data.last_read?.hash||this.data.last_import.mtime<this.item.mtime&&(!this.data.last_import.size||Math.abs(this.data.last_import.size-this.item.size)/(this.data.last_import.size||1)>.01)}catch(e){return console.warn(`MarkdownSourceContentAdapter: error getting should_import for ${this.file_path}: ${e}`),!0}}};var Qt=require("obsidian");function nP(n,e=[]){let t=new Set;return typeof n=="string"&&(n=n.replace(/[\[\]]/g,"").split(",").map(s=>s.trim()).filter(Boolean)),Array.isArray(n)&&n.forEach(s=>t.add(s.startsWith("#")?s:`#${s}`)),e.forEach(({tag:s})=>t.add(s)),[...t]}r(nP,"merge_tags");var Bs=class extends Pr{static{r(this,"ObsidianMarkdownSourceContentAdapter")}async get_metadata(){let t=this.item.env.main.app.metadataCache.getFileCache(this.item.file)||{},s=nP(t.frontmatter?.tags,t.tags);return t.frontmatter?(s.length&&(t.frontmatter.tags=s),t.frontmatter):s.length?{tags:s}:void 0}async read(e={}){let t=await super.read(e);if(!e.render_output)return t;let s=this.item.env.main.app;if(!s||!Qt.MarkdownRenderer||!Qt.htmlToMarkdown)return console.warn("Obsidian environment not found; cannot render markdown."),t;let i=document.createElement("div");await Qt.MarkdownRenderer.render(s,t,i,this.item.path,new Qt.Component);let o=i.innerHTML,a=1e4,c=0,l=0,d=!0;for(;l<7;)if(await new Promise(m=>setTimeout(m,100)),d=o!==i.innerHTML,o=i.innerHTML,d?l=0:l++,c+=100,c>a){console.warn("ObsidianMarkdownSourceContentAdapter: Timeout waiting for markdown to render.");break}return(0,Qt.htmlToMarkdown)(i)}};var W_=class extends Zt{static{r(this,"BasesSourceContentAdapter")}static extensions=["base"];async import(){}};var G_=class extends Zt{static{r(this,"CanvasSourceContentAdapter")}static extensions=["canvas"];async import(){}};var H_=class extends Bs{static{r(this,"ExcalidrawSourceContentAdapter")}static extensions=["excalidraw.md"];is_media=!0;async read(e={}){let t=await super.read(e),s="# Text Elements",i="# Drawing",o=t.indexOf(s),a=t.indexOf(i);if(o===-1||a===-1)return console.warn("Excalidraw file does not contain expected sections. File: "+this.item.key),this.item.data.last_read.size=0,"";let l=t.slice(o+s.length,a).trim().split(`
`).map(d=>d.trim()==="%%"||d.trim()==="#"?"":d.replace(/\^[a-z0-9]+$/i,"").trim()).filter(Boolean).join(`
`);return this.item.data.last_read.size=l.length,l}get size(){return this.item.data?.last_read?.size?this.item.data.last_read.size:this.file?.stat?.size||0}};function zE(n,e){let[t,...s]=n.split("#").filter(Boolean),i=j_(t,e);if(e)return[i,...s].join(" > ");let o=s.findLast(a=>a&&a[0]!=="{");return[i,o].join(" > ")}r(zE,"get_block_display_name");var li=class extends Rs{static{r(this,"SmartBlock")}static get defaults(){return{data:{text:null,length:0,last_read:{hash:null,at:0}},_embed_input:""}}get block_adapter(){return this._block_adapter||(this._block_adapter=new this.collection.opts.block_adapters.md(this)),this._block_adapter}init(){this.settings.embed_blocks&&super.init()}queue_embed(){this._queue_embed=this.should_embed,this.source?.queue_embed()}queue_import(){this.source?.queue_import()}async get_embed_input(e=null){return(typeof this._embed_input!="string"||!this._embed_input.length)&&(e||(e=await this.read()),this._embed_input=this.breadcrumbs+`
`+e),this._embed_input}async read(){try{return await this.block_adapter.read()}catch(e){if(e.message.includes("BLOCK NOT FOUND"))return'BLOCK NOT FOUND (run "Prune" to remove)';throw e}}async append(e){await this.block_adapter.append(e),this.queue_save()}async update(e,t={}){await this.block_adapter.update(e,t),this.queue_save()}async remove(){await this.block_adapter.remove(),this.queue_save()}async move_to(e){await this.block_adapter.move_to(e),this.queue_save()}get_display_name(e={}){return this.block_adapter?.get_display_name(e)}get breadcrumbs(){return this.key.split("/").join(" > ").split("#").slice(0,-1).join(" > ").replace(".md","")}get excluded(){let e=this.path.split("#").slice(1);return this.source_collection.excluded_headings.some(t=>e.includes(t))?!0:this.source?.excluded}get file_path(){return this.source?.file_path}get file_type(){return this.source.file_type}get folder(){return this.path.split("/").slice(0,-1).join("/")}get embed_link(){return`![[${this.link}]]`}get has_lines(){return this.lines&&this.lines.length===2}get is_block(){return this.key.includes("#")}get is_gone(){return!this.source?.file||!this.source?.data?.blocks?.[this.sub_key]}get last_read(){return this.data.last_read}get sub_key(){return"#"+this.key.split("#").slice(1).join("#")}get lines(){return this.data.lines}get line_start(){return this.lines?.[0]}get line_end(){return this.lines?.[1]}get link(){if(/^.*page\s*(\d+).*$/i.test(this.sub_key)){let e=this.sub_key.match(/^.*page\s*(\d+).*$/i)[1];return`${this.source.path}#page=${e}`}else return this.source?.path||"MISSING SOURCE"}get next_block(){if(!this.data.lines)return null;let e=this.data.lines[1]+1;return this.source.blocks?.find(t=>e===t.data?.lines?.[0])}get outlinks(){return this.source.outlinks}get path(){return this.key}get should_embed(){try{if(this.settings?.min_chars&&this.size<this.settings.min_chars)return!1;let e=this.line_start+1,t=this.line_end,{has_line_start:s,has_line_end:i}=Object.entries(this.source?.data?.blocks||{}).reduce((o,[a,c])=>(a.startsWith(this.sub_key+"#")&&(c[0]===e&&(o.has_line_start=a),c[1]===t&&(o.has_line_end=a)),o),{has_line_start:null,has_line_end:null});return!(s&&i&&this.collection.get(this.source_key+s)?.should_embed&&this.collection.get(this.source_key+i)?.should_embed)}catch(e){console.error(e,e.stack),console.error(`Error getting should_embed for ${this.key}: `+JSON.stringify(e||{},null,2))}}get size(){return this.data.size}get source(){return this.source_collection.get(this.source_key)}get source_collection(){return this.env.smart_sources}get source_key(){return this.key.split("#")[0]}get sub_blocks(){return this.source?.blocks?.filter(e=>e.key.startsWith(this.key+"#")&&e.line_start>this.line_start&&e.line_end<=this.line_end)||[]}get excluded_lines(){return this.source.excluded_lines}get file(){return this.source.file}get is_media(){return this.source.is_media}get mtime(){return this.source.mtime}get name(){return zE(this.key,this.env.settings.smart_view_filter?.show_full_path)}get note(){return this.source}get note_key(){return this.key.split("#")[0]}},DE={class:li,actions:{find_connections:ri}};var Ir=class extends Fs{static{r(this,"SmartBlocks")}init(){}get fs(){return this.env.smart_sources.fs}get embed_model(){return this.source_collection?.embed_model}get embed_model_key(){return this.source_collection?.embed_model_key}get expected_blocks_ct(){return Object.values(this.source_collection.items).reduce((e,t)=>e+=Object.keys(t.data.blocks||{}).length,0)}get notices(){return this.env.smart_connections_plugin?.notices||this.env.main?.notices}get settings_config(){return this.process_settings_config({embed_blocks:{name:"Embed blocks",type:"toggle",description:"Blocks represent parts/sections of notes. Get more granular results.",default:!0},...super.settings_config})}render_settings(e,t={}){return this.render_collection_settings(e,t)}get data_dir(){return"multi"}get source_collection(){return this.env.smart_sources}async process_embed_queue(){}async process_load_queue(){}async prune(){throw"Not implemented: prune"}build_links_map(){throw"Not implemented: build_links_map"}async refresh(){throw"Not implemented: refresh"}async search(){throw"Not implemented: search"}async run_refresh(){throw"Not implemented: run_refresh"}async run_force_refresh(){throw"Not implemented: run_force_refresh"}async cleanup_blocks(){let e=Object.values(this.items).filter(t=>t.is_gone);console.log(`Removing ${e.length} expired blocks`),e.forEach(t=>t.delete()),await this.process_save_queue(),e.forEach(t=>{delete this.items[t.key]}),this.emit_event("blocks:cleaned",{expired_blocks_ct:e.length})}};var J_=class extends Yt{static{r(this,"AjsonMultiFileBlocksDataAdapter")}ItemDataAdapter=df;get_data_file_name(e){return e.split("#")[0].replace(/[\s\/\.]/g,"_").replace(".md","")}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(i=>i._queue_save);console.log(`Saving ${this.collection.collection_key}: ${e.length} items`);let t=Date.now(),s=Object.entries(e.reduce((i,o)=>{let a=this.get_item_data_path(o.key);return i[a]=i[a]||[],i[a].push(o),i},{}));for(let i=0;i<s.length;i++){let[o,a]=s[i];await this.fs.append(o,a.map(c=>this.get_item_ajson(c)).join(`
`)+`
`),a.forEach(c=>c._queue_save=!1)}console.log(`Saved ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}process_load_queue(){console.log(`Skipping loading ${this.collection.collection_key}...`)}},df=class extends At{static{r(this,"AjsonMultiFileBlockDataAdapter")}};var K_=class{static{r(this,"BlockContentAdapter")}constructor(e){this.item=e}async read(){throw new Error("Not implemented")}async append(e){throw new Error("Not implemented")}async update(e,t={}){throw new Error("Not implemented")}async remove(){throw new Error("Not implemented")}async move_to(e){throw new Error("Not implemented")}get_display_name(e){throw new Error("Not implemented")}get data(){return this.item.data}async update_last_read(e){this.data.last_read={hash:this.create_hash(e),at:Date.now()}}create_hash(e){return oe(e)}};function V_(n,e,t){return n.split(`
`).slice(e-1,t).join(`
`)}r(V_,"get_line_range");var di=class extends K_{static{r(this,"MarkdownBlockContentAdapter")}async read(){let e=await this.item.source?.read();if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let t=this._extract_block(e);return this.update_last_read(t),t}async append(e){let t=await this.item.source.read(),{line_start:s,line_end:i}=this.item;if(!s||!i)throw new Error(`Cannot append to block ${this.item.key}: invalid line references.`);let o=t.split(`
`);o.splice(i,0,"",e);let a=o.join(`
`);await this.item.source._update(a),await this._reparse_source()}async update(e,t={}){let s=await this.item.source.read(),{line_start:i,line_end:o}=this.item;if(!i||!o)throw new Error(`Cannot update block ${this.item.key}: invalid line references.`);let a=s.split(`
`),l=[...a.slice(0,i-1),...e.split(`
`),...a.slice(o)].join(`
`);await this.item.source._update(l),await this._reparse_source()}async remove(){let e=await this.item.source.read(),{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`Cannot remove block ${this.item.key}: invalid line references.`);let i=e.split(`
`),a=[...i.slice(0,t-1),...i.slice(s)].join(`
`);await this.item.source._update(a),await this._reparse_source()}async move_to(e){let t=await this.read();await this.remove();let s=e.includes("#"),i=s?e.split("#")[0]:e,o=this.item.env.smart_sources.get(i);if(!o){await this.item.env.smart_sources.create(i,t);return}if(s){let a=this.item.env.smart_blocks.get(e);a?await a.append(t):await o.append(t)}else await o.append(t)}_extract_block(e){if(!e)return console.warn(`BLOCK NOT FOUND: ${this.item.key} has no source content.`),"";let{line_start:t,line_end:s}=this.item;if(!t||!s)throw new Error(`BLOCK NOT FOUND: ${this.item.key} has invalid line references.`);return V_(e,t,s)}async _reparse_source(){await this.item.source.import()}get_display_name(e={}){if(!this.item?.key)return"";if(e.show_full_path??!0)return this.item.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=this.item.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),this.item.lines&&s.push(`Lines: ${this.item.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}};var _i=class{static{r(this,"SmartModel")}scope_name="smart_model";static defaults={};constructor(e={}){this.opts=e,this.validate_opts(e),this.state="unloaded",this._adapter=null,this.data=e}async initialize(){this.load_adapter(this.adapter_name),await this.load()}validate_opts(e){if(!e.adapters)throw new Error("opts.adapters is required");if(!e.settings)throw new Error("opts.settings is required")}get settings(){return this.opts.settings||(this.opts.settings={...this.constructor.defaults}),this.opts.settings}get adapter_name(){let e=this.opts.adapter||this.settings.adapter||Object.keys(this.adapters)[0];return(!e||!this.adapters[e])&&(console.warn(`Platform "${e}" not supported`),e=Object.keys(this.adapters)[0]),e}get models(){return this.adapter.models}get default_model_key(){return this.adapter.constructor.defaults.default_model}get model_key(){return this.opts.model_key||this.settings.model_key||this.default_model_key}async load(){this.set_state("loading");try{this.adapter?.is_loaded||await this.invoke_adapter_method("load")}catch(e){throw this.set_state("unloaded"),this.reload_model_timeout||(this.reload_model_timeout=setTimeout(async()=>{this.reload_model_timeout=null,await this.load(),this.set_state("loaded"),this.env?.events?.emit("model:loaded",{model_key:this.model_key}),this.notices?.show("Loaded model: "+this.model_key)},6e4)),new Error(`Failed to load model: ${e.message}`)}this.set_state("loaded")}async unload(){this.adapter?.is_loaded&&(this.set_state("unloading"),await this.invoke_adapter_method("unload"),this.set_state("unloaded"))}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}get adapters(){return this.opts.adapters||{}}async load_adapter(e){if(this.set_adapter(e),!this._adapter.loaded){this.set_state("loading");try{await this.invoke_adapter_method("load"),this.set_state("loaded")}catch(t){throw this.set_state("unloaded"),new Error(`Failed to load adapter: ${t.message}`)}}}set_adapter(e){let t=this.adapters[e];if(!t)throw new Error(`Adapter "${e}" not found.`);this._adapter?.constructor.name.toLowerCase()!==e.toLowerCase()&&(this._adapter=new t(this))}get adapter(){let e=this.adapter_name;if(!e)throw new Error("Adapter not set for model.");return this._adapter||this.load_adapter(e),this._adapter}ensure_adapter_ready(e){if(!this.adapter)throw new Error("No adapter loaded.");if(typeof this.adapter[e]!="function")throw new Error(`Adapter does not implement method: ${e}`)}async invoke_adapter_method(e,...t){return this.ensure_adapter_ready(e),await this.adapter[e](...t)}get_platforms_as_options(){return Object.entries(this.adapters).map(([e,t])=>({value:e,name:t.defaults.description||e}))}get settings_config(){return this.process_settings_config({adapter:{name:"Model Platform",type:"dropdown",description:"Select a model platform to use with Smart Model.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed",default:"default"}})}process_settings_config(e,t=null){return Object.entries(e).reduce((s,[i,o])=>{let a=(t?t+".":"")+this.process_setting_key(i);return s[a]=o,s},{})}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}re_render_settings(){typeof this.opts.re_render_settings=="function"?this.opts.re_render_settings():console.warn("re_render_settings is not a function (must be passed in model opts)")}reload_model(){typeof this.opts.reload_model=="function"?this.opts.reload_model():console.warn("reload_model is not a function (must be passed in model opts)")}adapter_changed(){this.reload_model(),this.re_render_settings()}model_changed(){this.reload_model(),this.re_render_settings()}};var Mr=class extends _i{static{r(this,"SmartEmbedModel")}scope_name="smart_embed_model";static defaults={adapter:"transformers"};constructor(e={}){super(e)}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){return await this.invoke_adapter_method("embed_batch",e)}get batch_size(){return this.adapter.batch_size||1}get settings_config(){let e={adapter:{name:"Embedding model platform",type:"dropdown",description:"Select an embedding model platform. The default 'transformers' utilizes built-in local models.",options_callback:"get_platforms_as_options",callback:"adapter_changed",default:this.constructor.defaults.adapter},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[ADAPTER\]/g,this.adapter_name)}get_embedding_model_options(){return Object.entries(this.models).map(([e,t])=>({value:e,name:e}))}};var ui=class{static{r(this,"SmartModelAdapter")}constructor(e){this.model=e,this.state="unloaded"}async load(){this.set_state("loaded")}unload(){this.set_state("unloaded")}get settings(){return this.model.settings}get model_key(){return this.model.model_key}get models(){let e=this.model.data.provider_models;return typeof e=="object"&&Object.keys(e||{}).length>0?e:{}}async get_models(e=!1){throw new Error("get_models not implemented")}get_models_as_options(){let e=this.models;return Object.keys(e||{}).length?Object.entries(e).map(([t,s])=>({value:t,name:s.name||t})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}set_state(e){if(!["unloaded","loading","loaded","unloading"].includes(e))throw new Error(`Invalid state: ${e}`);this.state=e}get is_loading(){return this.state==="loading"}get is_loaded(){return this.state==="loaded"}get is_unloading(){return this.state==="unloading"}get is_unloaded(){return this.state==="unloaded"}};var Us=class extends ui{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var it=class{static{r(this,"SmartHttpRequest")}constructor(e={}){if(this.opts=e,!e.adapter)throw new Error("HttpRequestAdapter is required");this.adapter=new e.adapter(this)}async request(e,t=!1){return await this.adapter.request(e,t)}};var mi=class{static{r(this,"SmartHttpRequestAdapter")}constructor(e){this.main=e}async request(e){throw new Error("request not implemented")}},pi=class{static{r(this,"SmartHttpResponseAdapter")}constructor(e){this.response=e}async headers(){throw new Error("headers not implemented")}async json(){throw new Error("json not implemented")}async status(){throw new Error("status not implemented")}async text(){throw new Error("text not implemented")}};var hi=class extends mi{static{r(this,"SmartHttpObsidianRequestAdapter")}async request(e,t=!1){let s;try{if(!this.main.opts.obsidian_request_url)throw new Error("obsidian_request_url is required in SmartHttp constructor opts");if(s=await this.main.opts.obsidian_request_url({...e,throw:t}),t&&s.status===400)throw new Error("Obsidian request failed");return new _f(s)}catch(i){return console.error("Error in SmartHttpObsidianRequestAdapter.request():"),console.error(JSON.stringify(e,null,2)),console.error(s),console.error(i),null}}},_f=class extends pi{static{r(this,"SmartHttpObsidianResponseAdapter")}async status(){return this.response.status}async json(){return await this.response.json}async text(){return await this.response.text}async headers(){return this.response.headers}};var Ws=class extends mi{static{r(this,"SmartHttpRequestFetchAdapter")}async request(e){let{url:t,...s}=e,i=await fetch(t,s);return new uf(i)}},uf=class extends pi{static{r(this,"SmartHttpResponseFetchAdapter")}async headers(){return this.response.headers}async json(){return this._json||(this._json=await this.response.json()),this._json}async status(){return this.response.status}async text(){return this._text||(this._text=await this.response.text()),this._text}};var UE=P(BE(),1);var _P=Object.defineProperty,uP=r((n,e,t)=>e in n?_P(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),mP=r((n,e,t)=>(uP(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function pP(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(pP,"bytePairMerge");function hP(n,e){return n.length===1?[e.get(n.join(","))]:pP(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(hP,"bytePairEncode");function fP(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(fP,"escapeRegex");var pf=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=UE.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=pf.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=pf.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let m=d?.index??n.length;for(let f of n.substring(l,m).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...hP(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},Y_=pf;mP(Y_,"specialTokenRegex",n=>new RegExp(n.map(e=>fP(e)).join("|"),"g"));async function GE(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await WE(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await WE(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(GE,"fetch_json_cached");async function WE(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(WE,"do_fetch");function ff(n){if(n===null)return!0;let e=typeof n;return e==="string"||e==="number"||e==="boolean"?!0:Array.isArray(n)?n.every(ff):e==="object"?Object.values(n).every(ff):!1}r(ff,"is_json_compatible");function Z_(n,e){let t={};for(let[s,i]of Object.entries(n))e.includes(s)||ff(i)&&(t[s]=i);return t}r(Z_,"extract_json_details");function Lr(n){return Object.keys(n).length===0}r(Lr,"is_empty_object");function gP(n,e){return Lr(n)?e:Lr(e)?n:{...n,...e}}r(gP,"merge_details");function hf(n){let e=n.message;if(typeof e=="string"){let t=e.trim();if(t.length>0)return t}return null}r(hf,"get_message_from_object");function X(n,e=null){if(Array.isArray(n)&&n.length>0)return X(n[0],e);if(n==null)return{message:"Unknown error",details:null,http_status:e};if(typeof n=="string")return{message:n,details:null,http_status:e};if(n instanceof Error){let t=(n.message||"").trim()||"Unknown error",s=Z_(n,["message"]);return{message:t,details:Lr(s)?null:s,http_status:e}}if(typeof n=="object"){let t=n;if("error"in t&&t.error!=null){let i=t.error;if(typeof i=="object"){let o=i,a=hf(o),c=Z_(o,["message"]),l=Z_(t,["message","error"]),d=gP(l,c);return{message:a||hf(t)||"Unknown error",details:Lr(d)?null:d,http_status:e}}return X(i)}let s=hf(t);if(s){let i=Z_(t,["message"]);return{message:s,details:Lr(i)?null:i,http_status:e}}}return{message:"Unknown error",details:null,http_status:e}}r(X,"normalize_error");var yP="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",rt=class extends Us{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return Be}get res_adapter(){return Ue}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new it({adapter:Ws})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:X(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await GE(yP,"cl100k_base.json");this.tiktoken=new Y_(e)}},Be=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},Ue=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Q_=class extends rt{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return gf}get res_adapter(){return yf}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},gf=class extends Be{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},yf=class extends Ue{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var eu=class extends Us{static{r(this,"SmartEmbedMessageAdapter")}constructor(e){super(e),this.message_queue={},this.message_id=0,this.connector=null,this.message_prefix=`msg_${Math.random().toString(36).substr(2,9)}_`}async _send_message(e,t){return new Promise((s,i)=>{let o=`${this.message_prefix}${this.message_id++}`;this.message_queue[o]={resolve:s,reject:i},this._post_message({method:e,params:t,id:o})})}_handle_message_result(e,t,s){e.startsWith(this.message_prefix)&&(t?.model_loaded&&(console.log("model loaded"),this.state="loaded",this.model.model_loaded=!0,this.model.load_result=t),this.message_queue[e]&&(s?this.message_queue[e].reject(new Error(s)):this.message_queue[e].resolve(t),delete this.message_queue[e]))}async count_tokens(e){return this._send_message("count_tokens",{input:e})}async embed_batch(e){if(e=e.filter(i=>i.embed_input?.length>0),!e.length)return[];let t=e.map(i=>({embed_input:i.embed_input})),s=await this._send_message("embed_batch",{inputs:t});return e.map((i,o)=>(i.vec=s[o].vec,i.tokens=s[o].tokens,i))}_post_message(e){throw new Error("_post_message must be implemented by subclass")}};var tu=class extends eu{static{r(this,"SmartEmbedIframeAdapter")}constructor(e){super(e),this.iframe=null,this.origin=window.location.origin,this.iframe_id="smart_embed_iframe"}async load(){let e=document.getElementById(this.iframe_id);e&&e.remove(),this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.id=this.iframe_id,document.body.appendChild(this.iframe),window.addEventListener("message",this._handle_message.bind(this)),this.iframe.srcdoc=`
<html>
<body>
<script type="module">
${this.connector}
window.addEventListener('message', async (event) => {
if (event.origin !== '${this.origin}' || event.data.iframe_id !== '${this.iframe_id}') return console.log('message ignored (listener)', event);
const response = await process_message(event.data);
window.parent.postMessage({ ...response, iframe_id: '${this.iframe_id}' }, '${this.origin}');
});
</script>
</body>
</html>
`,await new Promise(s=>this.iframe.onload=s);let t={model_key:this.model.model_key,adapters:null,settings:null,batch_size:this.batch_size,use_gpu:this.use_gpu};return await this._send_message("load",t),new Promise(s=>{let i=r(()=>{this.model.model_loaded?s():setTimeout(i,100)},"check_model_loaded");i()})}_post_message(e){this.iframe.contentWindow.postMessage({...e,iframe_id:this.iframe_id},this.origin)}_handle_message(e){if(e.origin!==this.origin||e.data.iframe_id!==this.iframe_id)return;let{id:t,result:s,error:i}=e.data;this._handle_message_result(t,s,i)}};var HE=`var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

var SmartModelAdapter = class {
/**
* Create a SmartModelAdapter instance.
* @param {SmartModel} model - The parent SmartModel instance
*/
constructor(model2) {
this.model = model2;
this.state = "unloaded";
}
/**
* Load the adapter.
* @async
* @returns {Promise<void>}
*/
async load() {
this.set_state("loaded");
}
/**
* Unload the adapter.
* @returns {void}
*/
unload() {
this.set_state("unloaded");
}
/**
* Get all settings.
* @returns {Object} All settings
*/
get settings() {
return this.model.settings;
}
/**
* Get the current model key.
* @returns {string} Current model identifier
*/
get model_key() {
return this.model.model_key;
}
/**
* Get the models.
* @returns {Object} Map of model objects
*/
get models() {
const models = this.model.data.provider_models;
if (typeof models === "object" && Object.keys(models || {}).length > 0) return models;
else {
return {};
}
}
/**
* Get available models from the API.
* @abstract
* @param {boolean} [refresh=false] - Whether to refresh cached models
* @returns {Promise<Object>} Map of model objects
*/
async get_models(refresh = false) {
throw new Error("get_models not implemented");
}
/**
* Get available models as dropdown options synchronously.
* @returns {Array<Object>} Array of model options.
*/
get_models_as_options() {
const models = this.models;
if (!Object.keys(models || {}).length) {
this.get_models(true);
return [{ value: "", name: "No models currently available" }];
}
return Object.entries(models).map(([id, model2]) => ({ value: id, name: model2.name || id })).sort((a, b) => a.name.localeCompare(b.name));
}
/**
* Set the adapter's state.
* @deprecated should be handled in SmartModel (only handle once)
* @param {('unloaded'|'loading'|'loaded'|'unloading')} new_state - The new state
* @throws {Error} If the state is invalid
*/
set_state(new_state) {
const valid_states = ["unloaded", "loading", "loaded", "unloading"];
if (!valid_states.includes(new_state)) {
throw new Error(\`Invalid state: \${new_state}\`);
}
this.state = new_state;
}
get is_loading() {
return this.state === "loading";
}
get is_loaded() {
return this.state === "loaded";
}
get is_unloading() {
return this.state === "unloading";
}
get is_unloaded() {
return this.state === "unloaded";
}
};

var SmartEmbedAdapter = class extends SmartModelAdapter {
/**
* Count tokens in input text
* @abstract
* @param {string} input - Text to tokenize
* @returns {Promise<Object>} Token count result
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async count_tokens(input) {
throw new Error("count_tokens method not implemented");
}
/**
* Generate embeddings for single input
* @abstract
* @param {string|Object} input - Text to embed
* @returns {Promise<Object>} Embedding result
* @property {number[]} vec - Embedding vector
* @property {number} tokens - Number of tokens in input
* @throws {Error} If not implemented by subclass
*/
async embed(input) {
if (typeof input === "string") input = { embed_input: input };
return (await this.embed_batch([input]))[0];
}
/**
* Generate embeddings for multiple inputs
* @abstract
* @param {Array<string|Object>} inputs - Texts to embed
* @returns {Promise<Array<Object>>} Array of embedding results
* @property {number[]} vec - Embedding vector for each input
* @property {number} tokens - Number of tokens in each input
* @throws {Error} If not implemented by subclass
*/
async embed_batch(inputs) {
throw new Error("embed_batch method not implemented");
}
get settings_config() {
return {
"[ADAPTER].model_key": {
name: "Embedding model",
type: "dropdown",
description: "Select an embedding model.",
options_callback: "adapter.get_models_as_options",
callback: "model_changed",
default: this.constructor.defaults.default_model
}
};
}
get dims() {
return this.model.data.dims;
}
get max_tokens() {
return this.model.data.max_tokens;
}
get batch_size() {
return this.model.data.batch_size || 1;
}
};
/**
* @override in sub-class with adapter-specific default configurations
* @property {string} id - The adapter identifier
* @property {string} description - Human-readable description
* @property {string} type - Adapter type ("API")
* @property {string} endpoint - API endpoint
* @property {string} adapter - Adapter identifier
* @property {string} default_model - Default model to use
*/
__publicField(SmartEmbedAdapter, "defaults", {});

var transformers_defaults = {
adapter: "transformers",
description: "Transformers (Local, built-in)",
default_model: "TaylorAI/bge-micro-v2",
models: transformers_models
};
var DEVICE_CONFIGS = {
webgpu_fp16: {
device: "webgpu",
dtype: "fp16",
quantized: false
},
webgpu_fp32: {
device: "webgpu",
dtype: "fp32",
quantized: false
},
webgpu_q8: {
device: "webgpu",
dtype: "q8",
quantized: true
},
webgpu_q4: {
device: "webgpu",
dtype: "q4",
quantized: true
},
webgpu_q4f16: {
device: "webgpu",
dtype: "q4f16",
quantized: true
},
webgpu_bnb4: {
device: "webgpu",
dtype: "bnb4",
quantized: true
},
wasm_q8: {
dtype: "q8",
quantized: true
},
wasm_q4: {
dtype: "q4",
quantized: true
},
wasm_auto: {
quantized: false
}
};
var is_webgpu_available = async () => {
if (!("gpu" in navigator)) return false;
const adapter = await navigator.gpu.requestAdapter();
if (!adapter) return false;
return true;
};
var SmartEmbedTransformersAdapter = class extends SmartEmbedAdapter {
/**
* @param {import("../smart_embed_model.js").SmartEmbedModel} model
*/
constructor(model2) {
super(model2);
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.has_gpu = false;
}
/**
* Load the underlying transformers pipeline with WebGPU \u2192 WASM fallback.
* @returns {Promise<void>}
*/
async load() {
this.has_gpu = await is_webgpu_available();
try {
if (this.loading) {
console.warn("[Transformers v2] load already in progress, waiting...");
while (this.loading) {
await new Promise((resolve) => setTimeout(resolve, 100));
}
} else {
this.loading = true;
if (this.pipeline) {
this.loaded = true;
this.loading = false;
return;
}
await this.load_transformers_with_fallback();
this.loading = false;
this.loaded = true;
console.log(\`[Transformers v2] model loaded using \${this.active_config_key}\`, this);
}
} catch (e) {
this.loading = false;
this.loaded = false;
console.error("[Transformers v2] load failed", e);
throw e;
}
}
/**
* Unload the pipeline and free resources.
* @returns {Promise<void>}
*/
async unload() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while disposing pipeline", err);
}
this.pipeline = null;
this.tokenizer = null;
this.active_config_key = null;
this.loaded = false;
}
/**
* Available models \u2013 reuses the v1 transformers model catalog.
* @returns {Object}
*/
get models() {
return transformers_models;
}
/**
* Maximum tokens per input.
* @returns {number}
*/
get max_tokens() {
return this.model.data.max_tokens || 512;
}
/**
* Effective batch size.
* Prefers small deterministic batches when not explicitly configured.
* @returns {number}
*/
get batch_size() {
const configured = this.model.data.batch_size;
if (configured && configured > 0) return configured;
return this.gpu_enabled ? 16 : 8;
}
get gpu_enabled() {
if (this.has_gpu) {
const explicit = typeof this.model.data.use_gpu === "boolean" ? this.model.data.use_gpu : null;
if (explicit === false) return false;
return true;
} else {
return false;
}
}
/**
* Initialize transformers pipeline with WebGPU \u2192 WASM fallback.
* @private
* @returns {Promise<void>}
*/
async load_transformers_with_fallback() {
const { pipeline, env, AutoTokenizer } = await import("@huggingface/transformers");
env.allowLocalModels = false;
if (typeof env.useBrowserCache !== "undefined") {
env.useBrowserCache = true;
}
let last_error = null;
const CONFIG_LIST_ORDER = Object.keys(DEVICE_CONFIGS);
const try_create = async (config_key) => {
const pipe = await pipeline("feature-extraction", this.model_key, DEVICE_CONFIGS[config_key]);
return pipe;
};
for (const config of CONFIG_LIST_ORDER) {
if (this.pipeline) break;
if (config.includes("gpu") && !this.gpu_enabled) {
console.warn(\`[Transformers v2: \${config}] skipping \${config} as GPU is disabled\`);
continue;
}
try {
console.log(\`[Transformers v2] trying to load pipeline on \${config}\`);
this.pipeline = await try_create(config);
this.active_config_key = config;
break;
} catch (err) {
console.warn(\`[Transformers v2: \${config}] failed to load pipeline on \${config}\`, err);
last_error = err;
}
}
if (this.pipeline) {
console.log(\`[Transformers v2: \${this.active_config_key}] pipeline initialized using \${this.active_config_key}\`);
} else {
throw last_error || new Error("Failed to initialize transformers pipeline");
}
this.tokenizer = await AutoTokenizer.from_pretrained(this.model_key);
}
/**
* Count tokens in input text.
* @param {string} input
* @returns {Promise<{tokens:number}>}
*/
async count_tokens(input) {
if (!this.tokenizer) {
await this.load();
}
const { input_ids } = await this.tokenizer(input);
return { tokens: input_ids.data.length };
}
/**
* Generate embeddings for multiple inputs.
* @param {Array<Object>} inputs
* @returns {Promise<Array<Object>>}
*/
async embed_batch(inputs) {
if (!this.pipeline) {
await this.load();
}
const filtered_inputs = inputs.filter((item) => item.embed_input && item.embed_input.length > 0);
if (!filtered_inputs.length) return [];
const results = [];
for (let i = 0; i < filtered_inputs.length; i += this.batch_size) {
const batch = filtered_inputs.slice(i, i + this.batch_size);
const batch_results = await this._process_batch(batch);
results.push(...batch_results);
}
return results;
}
/**
* Process a single batch \u2013 with per-item retry on failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _process_batch(batch_inputs) {
const prepared = await Promise.all(
batch_inputs.map((item) => this._prepare_input(item.embed_input))
);
const embed_inputs = prepared.map((p) => p.text);
const tokens = prepared.map((p) => p.tokens);
try {
const resp = await this.pipeline(embed_inputs, { pooling: "mean", normalize: true });
return batch_inputs.map((item, i) => {
const vec = Array.from(resp[i].data).map((val) => Math.round(val * 1e8) / 1e8);
item.vec = vec;
item.tokens = tokens[i];
return item;
});
} catch (err) {
console.error("[Transformers v2] batch embed failed \\u2013 retrying items individually", err);
return await this._retry_items_individually(batch_inputs);
}
}
/**
* Prepare a single input by truncating to max_tokens if necessary.
* @private
* @param {string} embed_input
* @returns {Promise<{text:string,tokens:number}>}
*/
async _prepare_input(embed_input) {
let { tokens } = await this.count_tokens(embed_input);
if (tokens <= this.max_tokens) {
return { text: embed_input, tokens };
}
let truncated = embed_input;
while (tokens > this.max_tokens && truncated.length > 0) {
const pct = this.max_tokens / tokens;
const max_chars = Math.floor(truncated.length * pct * 0.9);
truncated = truncated.slice(0, max_chars);
const last_space = truncated.lastIndexOf(" ");
if (last_space > 0) {
truncated = truncated.slice(0, last_space);
}
tokens = (await this.count_tokens(truncated)).tokens;
}
return { text: truncated, tokens };
}
/**
* Retry each item individually after a batch failure.
* @private
* @param {Array<Object>} batch_inputs
* @returns {Promise<Array<Object>>}
*/
async _retry_items_individually(batch_inputs) {
await this._reset_pipeline_after_error();
const results = [];
for (const item of batch_inputs) {
try {
const prepared = await this._prepare_input(item.embed_input);
const resp = await this.pipeline(prepared.text, { pooling: "mean", normalize: true });
const vec = Array.from(resp[0].data).map((val) => Math.round(val * 1e8) / 1e8);
results.push({
...item,
vec,
tokens: prepared.tokens
});
} catch (single_err) {
console.error("[Transformers v2] single item embed failed \\u2013 skipping", single_err);
results.push({
...item,
vec: [],
tokens: 0,
error: single_err.message
});
}
}
return results;
}
/**
* Reset pipeline after a failure \u2013 falling back to WASM if needed.
* @private
* @returns {Promise<void>}
*/
async _reset_pipeline_after_error() {
try {
if (this.pipeline) {
if (typeof this.pipeline.destroy === "function") {
this.pipeline.destroy();
} else if (typeof this.pipeline.dispose === "function") {
this.pipeline.dispose();
}
}
} catch (err) {
console.warn("[Transformers v2] error while resetting pipeline", err);
}
this.pipeline = null;
await this.load_transformers_with_fallback();
}
/**
* V2 intentionally exposes only model selection in the settings UI.
* @returns {Object}
*/
get settings_config() {
return super.settings_config;
}
};
__publicField(SmartEmbedTransformersAdapter, "defaults", transformers_defaults);
var transformers_models = {
"TaylorAI/bge-micro-v2": {
"id": "TaylorAI/bge-micro-v2",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-micro-v2",
"description": "Local, 512 tokens, 384 dim (recommended)",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-xs": {
"id": "Snowflake/snowflake-arctic-embed-xs",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed XS",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-s": {
"id": "Snowflake/snowflake-arctic-embed-s",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"Snowflake/snowflake-arctic-embed-m": {
"id": "Snowflake/snowflake-arctic-embed-m",
"batch_size": 1,
"dims": 768,
"max_tokens": 512,
"name": "Snowflake Arctic Embed Medium",
"description": "Local, 512 tokens, 768 dim",
"adapter": "transformers"
},
"TaylorAI/gte-tiny": {
"id": "TaylorAI/gte-tiny",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "GTE-tiny",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"onnx-community/embeddinggemma-300m-ONNX": {
"id": "onnx-community/embeddinggemma-300m-ONNX",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "EmbeddingGemma-300M",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
},
"Mihaiii/Ivysaur": {
"id": "Mihaiii/Ivysaur",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "Ivysaur",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"andersonbcdefg/bge-small-4096": {
"id": "andersonbcdefg/bge-small-4096",
"batch_size": 1,
"dims": 384,
"max_tokens": 4096,
"name": "BGE-small-4K",
"description": "Local, 4,096 tokens, 384 dim",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-base-zh": {
"id": "Xenova/jina-embeddings-v2-base-zh",
"batch_size": 1,
"dims": 768,
"max_tokens": 8192,
"name": "Jina-v2-base-zh-8K",
"description": "Local, 8,192 tokens, 768 dim, Chinese/English bilingual",
"adapter": "transformers"
},
"Xenova/jina-embeddings-v2-small-en": {
"id": "Xenova/jina-embeddings-v2-small-en",
"batch_size": 1,
"dims": 512,
"max_tokens": 8192,
"name": "Jina-v2-small-en",
"description": "Local, 8,192 tokens, 512 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1.5": {
"id": "nomic-ai/nomic-embed-text-v1.5",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text-v1.5",
"description": "Local, 8,192 tokens, 768 dim",
"adapter": "transformers"
},
"Xenova/bge-small-en-v1.5": {
"id": "Xenova/bge-small-en-v1.5",
"batch_size": 1,
"dims": 384,
"max_tokens": 512,
"name": "BGE-small",
"description": "Local, 512 tokens, 384 dim",
"adapter": "transformers"
},
"nomic-ai/nomic-embed-text-v1": {
"id": "nomic-ai/nomic-embed-text-v1",
"batch_size": 1,
"dims": 768,
"max_tokens": 2048,
"name": "Nomic-embed-text",
"description": "Local, 2,048 tokens, 768 dim",
"adapter": "transformers"
}
};

var model = null;
async function process_message(data) {
const { method, params, id, iframe_id } = data;
try {
let result;
switch (method) {
case "init":
console.log("init");
break;
case "load":
const model_params = { data: params, ...params };
console.log("load", { model_params });
model = new SmartEmbedTransformersAdapter(model_params);
await model.load();
result = { model_loaded: true, model_config_key: model.active_config_key };
break;
case "embed_batch":
if (!model) throw new Error("Model not loaded");
result = await model.embed_batch(params.inputs);
break;
case "count_tokens":
if (!model) throw new Error("Model not loaded");
result = await model.count_tokens(params);
break;
default:
throw new Error(\`Unknown method: \${method}\`);
}
return { id, result, iframe_id };
} catch (error) {
console.error("Error processing message:", error);
return { id, error: error.message, iframe_id };
}
}
process_message({ method: "init" });
`;var JE={adapter:"transformers",description:"Transformers (Local, built-in)",default_model:"TaylorAI/bge-micro-v2",models:bf};var bf={"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-s":{id:"Snowflake/snowflake-arctic-embed-s",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-m":{id:"Snowflake/snowflake-arctic-embed-m",batch_size:1,dims:768,max_tokens:512,name:"Snowflake Arctic Embed Medium",description:"Local, 512 tokens, 768 dim",adapter:"transformers"},"TaylorAI/gte-tiny":{id:"TaylorAI/gte-tiny",batch_size:1,dims:384,max_tokens:512,name:"GTE-tiny",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"onnx-community/embeddinggemma-300m-ONNX":{id:"onnx-community/embeddinggemma-300m-ONNX",batch_size:1,dims:768,max_tokens:2048,name:"EmbeddingGemma-300M",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"},"Mihaiii/Ivysaur":{id:"Mihaiii/Ivysaur",batch_size:1,dims:384,max_tokens:512,name:"Ivysaur",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"andersonbcdefg/bge-small-4096":{id:"andersonbcdefg/bge-small-4096",batch_size:1,dims:384,max_tokens:4096,name:"BGE-small-4K",description:"Local, 4,096 tokens, 384 dim",adapter:"transformers"},"Xenova/jina-embeddings-v2-base-zh":{id:"Xenova/jina-embeddings-v2-base-zh",batch_size:1,dims:768,max_tokens:8192,name:"Jina-v2-base-zh-8K",description:"Local, 8,192 tokens, 768 dim, Chinese/English bilingual",adapter:"transformers"},"Xenova/jina-embeddings-v2-small-en":{id:"Xenova/jina-embeddings-v2-small-en",batch_size:1,dims:512,max_tokens:8192,name:"Jina-v2-small-en",description:"Local, 8,192 tokens, 512 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1.5":{id:"nomic-ai/nomic-embed-text-v1.5",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text-v1.5",description:"Local, 8,192 tokens, 768 dim",adapter:"transformers"},"Xenova/bge-small-en-v1.5":{id:"Xenova/bge-small-en-v1.5",batch_size:1,dims:384,max_tokens:512,name:"BGE-small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"nomic-ai/nomic-embed-text-v1":{id:"nomic-ai/nomic-embed-text-v1",batch_size:1,dims:768,max_tokens:2048,name:"Nomic-embed-text",description:"Local, 2,048 tokens, 768 dim",adapter:"transformers"}},KE={},vf={};var fi=class extends tu{static{r(this,"SmartEmbedTransformersIframeAdapter")}static defaults=JE;constructor(e){super(e),this.connector=HE.replace("@huggingface/transformers","https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.0"),console.log("transformers iframe connector",this.model)}get settings_config(){return{...super.settings_config,...KE}}get_models(){return Promise.resolve(this.models)}get models(){return bf}};var su=class extends rt{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return kf}get res_adapter(){return wf}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of vP(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},kf=class extends Be{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},wf=class extends Ue{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},bP=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),vP=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(bP)},"filter_embedding_models");var nu=class extends rt{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return xf}get res_adapter(){return Ef}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},xf=class extends Be{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},Ef=class extends Ue{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};function kP(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(kP,"parse_lm_studio_models");var iu=class extends rt{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return Af}get res_adapter(){return Sf}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return kP(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},Af=class extends Be{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},Sf=class extends Ue{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var zr=class extends _i{static{r(this,"SmartChatModel")}scope_name="smart_chat_model";static defaults={adapter:"openai"};constructor(e={}){super(e)}get models(){return this.adapter.models}get can_stream(){return this.adapter.constructor.defaults.streaming}async complete(e){let t=await this.invoke_adapter_method("complete",e);if(t.error)throw X(t.error);return t}async stream(e,t={}){return await this.invoke_adapter_method("stream",e,t)}stop_stream(){this.invoke_adapter_method("stop_stream")}async count_tokens(e){return await this.invoke_adapter_method("count_tokens",e)}async test_api_key(){await this.invoke_adapter_method("test_api_key"),this.re_render_settings()}get default_model_key(){return this.adapter.constructor.defaults.default_model}get settings(){return this.opts.settings}get settings_config(){let e={adapter:{name:"Chat Model Platform",type:"dropdown",description:"Select a platform/provider for chat models.",options_callback:"get_platforms_as_options",is_scope:!0,callback:"adapter_changed"},...this.adapter.settings_config||{}};return this.process_settings_config(e)}process_setting_key(e){return e.replace(/\[CHAT_ADAPTER\]/g,this.adapter_name)}};var ou=class{static{r(this,"SmartStreamer")}constructor(e,t={}){let{method:s="GET",headers:i={},body:o=null,withCredentials:a=!1}=t;this.url=e,this.method=s,this.headers=i,this.body=o,this.withCredentials=a,this.listeners={},this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.last_event_id="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.chunk_accumulator="",this.chunk_splitting_regex=t.chunk_splitting_regex||/(\r\n|\n|\r)/g}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].includes(t)||this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t),this.listeners[e].length===0&&delete this.listeners[e])}dispatchEvent(e){if(!e)return!0;e.source=this;let t="on"+e.type;return Object.prototype.hasOwnProperty.call(this,t)&&(this[t].call(this,e),e.defaultPrevented)?!1:(this.listeners[e.type]&&this.listeners[e.type].forEach(s=>(s(e),!e.defaultPrevented)),!0)}stream(){this.#e(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this.#n.bind(this)),this.xhr.addEventListener("load",this.#i.bind(this)),this.xhr.addEventListener("readystatechange",this.#r.bind(this)),this.xhr.addEventListener("error",this.#t.bind(this)),this.xhr.addEventListener("abort",this.#o.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.last_event_id&&this.xhr.setRequestHeader("Last-Event-ID",this.last_event_id),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.body)}end(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this.#e(this.CLOSED))}#e(e){let t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}#t(e){let t=new CustomEvent("error");try{let s=JSON.parse(e.currentTarget.response);typeof s=="object"?t.data=s:t.data=e.currentTarget.response}catch{t.data=e.currentTarget.response}this.dispatchEvent(t),this.end()}#o(e){let t=new CustomEvent("abort");this.end()}#n(e){if(!this.xhr)return;if(this.xhr.status!==200){this.#t(e);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this.#e(this.OPEN));let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=t.split(this.chunk_splitting_regex);s.forEach((i,o)=>{i.trim().length===0?this.chunk&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""):(this.chunk+=i,o===s.length-1&&this.xhr.readyState===XMLHttpRequest.DONE&&(this.dispatchEvent(this.#s(this.chunk.trim())),this.chunk=""))})}#i(e){this.#n(e),this.dispatchEvent(this.#s(this.chunk)),this.chunk=""}#s(e){if(!e)return console.log("no chunk");let t=new CustomEvent("message");return t.data=e,t.last_event_id=this.last_event_id,t}#r(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this.#e(this.CLOSED)}};var ru=class extends ui{static{r(this,"SmartChatModelAdapter")}static defaults={};constructor(e){super(e),this.smart_chat=e,this.main=e}async complete(e){throw new Error("complete not implemented")}async count_tokens(e){throw new Error("count_tokens not implemented")}async stream(e,t={}){throw new Error("stream not implemented")}async test_api_key(){throw new Error("test_api_key not implemented")}refresh_models(){console.log("refresh_models"),this.get_models(!0)}get settings_config(){return{"[CHAT_ADAPTER].model_key":{name:"Chat Model",type:"dropdown",description:"Select a chat model.",options_callback:"adapter.get_models_as_options",callback:"reload_model",default:this.constructor.defaults.default_model},"[CHAT_ADAPTER].refresh_models":{name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"}}}};var gi={},es={data:null,fetched_at:0},U=class extends ru{static{r(this,"SmartChatModelApiAdapter")}constructor(e){super(e),this.model_data_loaded_at=0}get req_adapter(){return W}get res_adapter(){return L}get http_adapter(){return this._http_adapter||(this.model.http_adapter?this._http_adapter=this.model.http_adapter:this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new it({adapter:Ws})),this._http_adapter}get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"Enter your API key for the chat model platform.",callback:"test_api_key",is_scope:!0}}}async count_tokens(e){throw new Error("count_tokens not implemented")}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method,headers:{Authorization:`Bearer ${this.api_key}`}}}async get_enriched_model_data(){let e=this.constructor.models_dev_key||this.constructor.key;await this.get_models_dev_index();let t=es.data[e]||{},s=r(a=>a.limit?.context||1e4,"get_limit_i"),i=r(a=>a.limit?.output||1e4,"get_limit_o"),o=r(a=>a.modalities?.input?.includes("image")||!1,"get_multimodal");if(Object.keys(this.model_data||{}).length>0)for(let[a,c]of Object.entries(this.model_data)){let l=t?.models?.[c.id];l&&(this.model_data[a].models_dev=l,this.model_data[a].name=l.name||c.name,this.model_data[a].max_input_tokens=s(l),this.model_data[a].max_output_tokens=i(l),this.model_data[a].multimodal=o(l),this.model_data[a].cost=l.cost)}else for(let[a,c]of Object.entries(t?.models||{}))this.model_data[a]={...c,model_name:c.name,description:c.name,max_input_tokens:s(c),max_output_tokens:i(c),multimodal:o(c)};return this.model_data}valid_model_data(){return typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&Date.now()-this.model_data_loaded_at<3600*1e3}async get_models(e=!1){if(!e&&this.valid_model_data())return this.model_data;if(this.api_key){let t;try{t=await this.http_adapter.request(this.models_request_params),this.model_data=this.parse_model_data(await t.json())}catch(s){console.error("Failed to fetch model data:",{error:s,response:t})}}return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data&&(this.model.data.provider_models=this.model_data),this.valid_model_data()&&typeof this.model.re_render_settings=="function"?setTimeout(()=>{this.model.re_render_settings()},100):console.warn("Invalid model data, not re-rendering settings"),this.model_data}parse_model_data(e){throw new Error("parse_model_data not implemented")}async complete(e){let s=new this.req_adapter(this,{...e,stream:!1}).to_platform(),i=await this.http_adapter.request(s);if(!i)return null;let o=new this.res_adapter(this,await i.json());try{return o.to_openai()}catch(a){let c=X(a?.data||a);return console.error("Error in SmartChatModelApiAdapter.complete():",{normalized_error:c,error:a}),console.error(i),c}}async stream(e,t={}){let i=new this.req_adapter(this,e).to_platform(!0);return this.streaming_chunk_splitting_regex&&(i.chunk_splitting_regex=this.streaming_chunk_splitting_regex),await new Promise((o,a)=>{try{this.active_stream=new ou(this.endpoint_streaming,i);let c=new this.res_adapter(this);this.active_stream.addEventListener("message",async l=>{if(this.is_end_of_stream(l)){await c.handle_chunk(l.data),this.stop_stream();let d=c.to_openai();t.done&&await t.done(d),o(d);return}try{let d=c.handle_chunk(l.data);t.chunk&&await t.chunk({...c.to_openai(),raw:d})}catch(d){let _=X({...l.data,...d});console.error("Error processing stream chunk:",{e:l,error:d,normalized_error:_}),t.error&&t.error(_),this.stop_stream(),a(_)}}),this.active_stream.addEventListener("error",l=>{console.error("Stream error:",l);let d=X(l?.data||l);t.error&&t.error(d),this.stop_stream(),a(d)}),this.active_stream.stream()}catch(c){console.error("Failed to start stream:",c);let l=X(c?.data||c);t.error&&t.error(l),this.stop_stream(),a(l)}})}is_end_of_stream(e){return e.data==="data: [DONE]"}stop_stream(){this.active_stream&&(this.active_stream.end(),this.active_stream=null)}get api_key(){return this.model.api_key||this.main.opts.api_key}get models_endpoint(){return this.constructor.defaults.models_endpoint}get models_endpoint_method(){return"POST"}get endpoint(){return this.constructor.defaults.endpoint}get endpoint_streaming(){return this.constructor.defaults.endpoint_streaming||this.endpoint}get max_output_tokens(){return this.model.data.max_output_tokens||3e3}async get_models_dev_index(e=3600*1e3){let t=Date.now();if(es?.data&&t-es?.fetched_at<e)return es.data;try{let s={url:"https://models.dev/api.json",method:"GET",headers:{"Content-Type":"application/json"}},o=await(await this.http_adapter.request(s)).json();return es.data=o,es.fetched_at=t,console.log({MODELS_DEV_CACHE:es}),o}catch(s){return console.warn("models.dev fetch failed; continuing without enrichment",s),es.data||[]}}get_models_as_options(){return Object.keys(this.model_data||{}).length?Object.entries(this.model_data).map(([e,t])=>({value:e,name:t.name||e})).sort((e,t)=>e.name.localeCompare(t.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}get model_data(){return gi[this.constructor.key]||(gi[this.constructor.key]={}),gi[this.constructor.key]}set model_data(e){gi[this.constructor.key]||(gi[this.constructor.key]={}),gi[this.constructor.key]=e}},W=class{static{r(this,"SmartChatModelRequestAdapter")}constructor(e,t={}){this.adapter=e,this._req=t}get messages(){return this._req.messages||[]}get model_id(){return this._req.model||this.adapter.model.model_key||this.adapter.model.data.id}get temperature(){return this._req.temperature}get max_tokens(){return this._req.max_tokens||this.adapter.max_output_tokens}get stream(){return this._req.stream}get tools(){return this._req.tools||null}get tool_choice(){return this._req.tool_choice||null}get frequency_penalty(){return this._req.frequency_penalty}get presence_penalty(){return this._req.presence_penalty}get top_p(){return this._req.top_p}get_headers(){let e={"Content-Type":"application/json",...this.adapter.constructor.defaults.headers||{}},t=this.adapter.constructor.defaults.api_key_header;return t!=="none"&&(t?e[t]=this.adapter.api_key:this.adapter.api_key&&(e.Authorization=`Bearer ${this.adapter.api_key}`)),e}to_platform(e=!1){return this.to_openai(e)}to_openai(e=!1){let t={messages:this._transform_messages_to_openai(),model:this.model_id,temperature:this.temperature,stream:e,...this.tools&&{tools:this._transform_tools_to_openai()}};return t.tools?.length>0&&this.tool_choice&&this.tool_choice!=="none"&&(t.tool_choice=this.tool_choice),this.model_id?.startsWith("o1-")&&(t.messages=t.messages.filter(s=>s.role!=="system"),delete t.temperature),typeof this._req.top_p=="number"&&(t.top_p=this._req.top_p),typeof this._req.presence_penalty=="number"&&(t.presence_penalty=this._req.presence_penalty),typeof this._req.frequency_penalty=="number"&&(t.frequency_penalty=this._req.frequency_penalty),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_openai(){return this.messages.map(e=>this._transform_single_message_to_openai(e))}_transform_single_message_to_openai(e){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}_transform_tools_to_openai(){return this.tools.map(e=>({type:e.type,function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}},L=class{static{r(this,"SmartChatModelResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}constructor(e,t,s=null){this.adapter=e,this._res=t||this.constructor.platform_res,this.status=s}get id(){return this._res.id||null}get object(){return this._res.object||null}get created(){return this._res.created||null}get choices(){return this._res.choices||[]}get tool_call(){return this.message.tool_calls?.[0]||null}get tool_name(){return this.tool_call?.tool_name||null}get tool_call_content(){return this.tool_call?.parameters||null}get usage(){return this._res.usage||null}get error(){return this._res.error||null}to_openai(){return this.error?{error:X(this.error,this.status)}:{id:this.id,object:this.object,created:this.created,choices:this._transform_choices_to_openai(),usage:this._transform_usage_to_openai(),raw:this._res}}handle_chunk(e){if(e==="data: [DONE]"||(e=JSON.parse(e.split("data: ")[1]||"{}"),Object.keys(e).length===0))return;this._res.choices[0]||this._res.choices.push({message:{index:0,role:"assistant",content:""}}),this._res.id||(this._res.id=e.id);let t;if(e.choices?.[0]?.delta?.content){let s=e.choices[0].delta.content;t=s,this._res.choices[0].message.content+=s}return e.choices?.[0]?.delta?.tool_calls&&(this._res.choices[0].message.tool_calls||(this._res.choices[0].message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.choices[0].delta.tool_calls[0].id&&(this._res.choices[0].message.tool_calls[0].id+=e.choices[0].delta.tool_calls[0].id),e.choices[0].delta.tool_calls[0].function.name&&(this._res.choices[0].message.tool_calls[0].function.name+=e.choices[0].delta.tool_calls[0].function.name),e.choices[0].delta.tool_calls[0].function.arguments&&(this._res.choices[0].message.tool_calls[0].function.arguments+=e.choices[0].delta.tool_calls[0].function.arguments)),t}_transform_choices_to_openai(){return this.choices.map(e=>({index:e.index,message:this._transform_message_to_openai(e.message),finish_reason:this._get_openai_finish_reason(e.finish_reason)}))}_transform_message_to_openai(e={}){let t={role:this._get_openai_role(e.role),content:this._get_openai_content(e)};return e.name&&(t.name=e.name),e.tool_calls&&(t.tool_calls=this._transform_tool_calls_to_openai(e.tool_calls)),e.image_url&&(t.image_url=e.image_url),t}_get_openai_role(e){return e}_get_openai_content(e){return e.content}_get_openai_finish_reason(e){return e}_transform_usage_to_openai(){return this.usage}_transform_tool_calls_to_openai(e){return e.map(t=>({id:t.id,type:t.type,function:{name:t.function.name,arguments:t.function.arguments}}))}};var Dr=class extends U{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return Rr}res_adapter=Fr;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},Rr=class extends W{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},Fr=class extends L{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:X(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var wP=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Hs=class extends U{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=Cf;parse_model_data(e){return e.data.filter(t=>!wP.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:xP(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function xP(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(xP,"get_max_input_tokens");var Cf=class extends L{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Br=class extends Hs{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var yi=class extends U{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Ur;res_adapter=Wr;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Ur=class extends W{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Wr=class extends L{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:X(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}},Gr=class extends yi{static{r(this,"SmartChatModelGeminiAdapter")}static key="gemini";static defaults={description:"Gemini (SWITCH TO **GOOGLE** ADAPTER)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"}};var Hr=class extends U{static{r(this,"SmartChatModelOpenRouterAdapter")}static key="open_router";static models_dev_key="openrouter";static defaults={description:"Open Router",type:"API",endpoint:"https://openrouter.ai/api/v1/chat/completions",streaming:!0,adapter:"OpenRouter",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"mistralai/mistral-7b-instruct:free",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys"};get req_adapter(){return Of}get res_adapter(){return qf}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}get models_request_params(){return{url:this.models_endpoint,method:"GET"}}parse_model_data(e){if(e.data&&(e=e.data),e.error)throw new Error(e.error);return e.reduce((t,s)=>(t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_length,name:s.name,description:s.name,long_desc:s.description,multimodal:s.architecture.modality==="multimodal",raw:s},t),{})}},Of=class extends W{static{r(this,"SmartChatModelOpenRouterRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}_get_openai_content(e){return e.role==="user"&&Array.isArray(e.content)&&e.content.every(t=>t.type==="text")?e.content.map(t=>t.text).join(`
`):e.content}},qf=class extends L{static{r(this,"SmartChatModelOpenRouterResponseAdapter")}static get platform_res(){return{id:"",object:"chat.completion",created:0,model:"",choices:[],usage:{}}}to_platform(){return this.to_openai()}get object(){return"chat.completion"}get error(){if(!this._res.error)return null;let e=this._res.error;return e.message||(e.message=""),this._res.error.metadata?.raw&&(typeof this._res.error.metadata.raw=="string"?e.message+=`

${this._res.error.metadata.raw}`:e.message+=`

${JSON.stringify(this._res.error.metadata.raw,null,2)}`),e.message.startsWith("No cookie auth")&&(e.suggested_action="Ensure your Open Router API key is set correctly."),e}};var Jr=class extends U{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Kr}get res_adapter(){return Vr}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Kr=class extends W{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},Vr=class extends L{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var Xr=class extends U{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=Yr;res_adapter=Zr;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},Yr=class extends W{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},Zr=class extends L{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:X(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var $f={openai:{req:W,res:L},anthropic:{req:Rr,res:Fr},gemini:{req:Ur,res:Wr},lm_studio:{req:Kr,res:Vr},ollama:{req:Yr,res:Zr}},Qr=class extends U{static{r(this,"SmartChatModelCustomAdapter")}static key="custom";static defaults={description:"Custom API (Local or Remote, OpenAI format)",type:"API",api_adapter:"openai"};get req_adapter(){let e=this.model.data.api_adapter||"openai",t=$f[e];return t&&t.req?t.req:W}get res_adapter(){let e=this.model.data.api_adapter||"openai",t=$f[e];return t&&t.res?t.res:L}get endpoint(){let e=this.model.data.protocol||"http",t=this.model.data.hostname||"localhost",s=this.model.data.port?`:${this.model.data.port}`:"",i=this.model.data.path||"";return i&&!i.startsWith("/")&&(i=`/${i}`),`${e}://${t}${s}${i}`}get_adapters_as_options(){return Object.keys($f).map(e=>({value:e,name:e}))}get settings_config(){return{"[CHAT_ADAPTER].api_adapter":{name:"API Adapter",type:"dropdown",description:"Pick a built-in or external adapter to parse request/response data.",options_callback:r(()=>{this.get_adapters_as_options()},"options_callback"),default:"openai"},"[CHAT_ADAPTER].id":{name:"Model Name",type:"text",description:"Enter the model name for your endpoint if needed."},"[CHAT_ADAPTER].protocol":{name:"Protocol",type:"text",description:"e.g. http or https"},"[CHAT_ADAPTER].hostname":{name:"Hostname",type:"text",description:"e.g. localhost or some.remote.host"},"[CHAT_ADAPTER].port":{name:"Port",type:"number",description:"Port number or leave blank"},"[CHAT_ADAPTER].path":{name:"Path",type:"text",description:"Path portion of the URL (leading slash optional)"},"[CHAT_ADAPTER].streaming":{name:"Streaming",type:"toggle",description:"Enable streaming if your API supports it."},"[CHAT_ADAPTER].max_input_tokens":{name:"Max Input Tokens",type:"number",description:"Max number of tokens your model can handle in the prompt."},"[CHAT_ADAPTER].api_key":{name:"API Key",type:"password",description:"If your service requires an API key, add it here."}}}};var ea=class extends U{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return jf}get res_adapter(){return Tf}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},jf=class extends W{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},Tf=class extends L{static{r(this,"SmartChatModelGroqResponseAdapter")}};var ta=class extends U{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return W}get res_adapter(){return L}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var sa=class extends U{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Nf}get res_adapter(){return Pf}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Nf=class extends W{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Pf=class extends L{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var Zf=require("obsidian");function VE(n,e){let{blocks:t,task_lines:s,tasks:i,codeblock_ranges:o}=B_(e),a=n.data.last_read?.at||Date.now();for(let[c,l]of Object.entries(t)){let d=n.key+c,_=n.block_collection.get(d),m=V_(e,l[0],l[1]);if(_&&_.lines[0]===l[0]&&_.lines[1]===l[1]&&_.size===m.length&&_.vec)continue;let p=ci(m),f=U_({source:n,links:p}),y={key:d,lines:l,size:m.length,outlinks:[...p,...f],last_read:{at:a,hash:oe(m)}};if(!_||_?.data.last_read?.hash!==y.last_read.hash){let g=new n.block_collection.item_type(n.env,y);n.block_collection.set(g)}else _.data={..._.data,...y}}EP(n,t,s,i,o);for(let c of n.blocks)c.vec||c.queue_embed()}r(VE,"parse_blocks");function EP(n,e,t=[],s={},i={}){let o=new Set(Object.keys(e).map(c=>n.key+c)),a=n.blocks;for(let c=0;c<a.length;c++)o.has(a[c].key)||(a[c].deleted=!0,a[c].queue_save());n.data.blocks=e,n.data.task_lines=t,n.data.tasks=s,n.data.codeblock_ranges=i,n.queue_save()}r(EP,"clean_and_update_source_blocks");function If(n,e){if(e===null)return null;if(e===void 0)return n;if(typeof e!="object")return e;(typeof n!="object"||n===null)&&(n={});let t=Object.keys(e),s=t.length;for(let i=0;i<s;i++){let o=t[i],a=e[o],c=n[o];Array.isArray(a)?n[o]=a.slice():XE(a)?n[o]=If(XE(c)?c:{},a):a!==void 0&&(n[o]=a)}return n}r(If,"ajson_merge");function XE(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}r(XE,"is_object");var YE={SmartSource:"smart_sources",SmartNote:"smart_sources",SmartBlock:"smart_blocks",SmartDirectory:"smart_directories"};function AP(n){let e=!1,[t,...s]=n.split(":");return YE[t]&&(t=YE[t],e=!0),{collection_key:t,item_key:s.join(":"),changed:e}}r(AP,"_parse_ajson_key");var ts=class extends Yt{static{r(this,"AjsonSingleFileCollectionDataAdapter")}get_item_data_path(e){let t=(this.collection?.collection_key||"collection")+".ajson",s=this.fs?.sep||"/";return[this.collection.data_dir||"data",t].join(s)}async process_load_queue(){this.collection.emit_event("collection:load_started"),this.collection.show_process_notice("loading_collection"),await this.fs.exists(this.collection.data_dir)||await this.fs.mkdir(this.collection.data_dir);let e=this.get_item_data_path();if(!await this.fs.exists(e)){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){for(let o of Object.values(this.collection.items))o._queue_load&&o.queue_import?.();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_halted");return}let{rewrite:s,file_data:i}=this.parse_single_file_ajson(t);s&&(i.length?await this.fs.write(e,i):await this.fs.remove(e));for(let o of Object.values(this.collection.items))o._queue_load=!1,o.loaded_at=Date.now();this.collection.clear_process_notice("loading_collection"),this.collection.emit_event("collection:load_completed")}parse_single_file_ajson(e){let t=!1,s=e.trim().split(`
`).filter(Boolean),i={},o=0;for(let c=0;c<s.length;c++){let l=s[c].trim();l.endsWith(",")||(t=!0);let _="{"+l.replace(/,$/,"")+"}";try{let m=JSON.parse(_),[p,f]=Object.entries(m)[0],{collection_key:y,item_key:g,changed:v}=AP(p),k=`${y}:${g}`;f?(i[k]=f,(v||k!==p)&&(delete i[p],t=!0)):(delete i[k],(v||k!==p)&&delete i[p],t=!0)}catch(m){console.warn("parse error for line: ",l,m),t=!0}o++}for(let[c,l]of Object.entries(i)){let[d,..._]=c.split(":"),m=_.join(":"),p=this.collection.env[d];if(!p)continue;let f=p.get(m);if(f)f.data=If(f.data,l);else{let y=p.item_type;f=new y(this.env,l),p.set(f)}f.loaded_at=Date.now(),f._queue_load=!1,l.key||(l.key=m)}o>Object.keys(i).length&&(t=!0);let a=[];for(let[c,l]of Object.entries(i))a.push(`${JSON.stringify(c)}: ${JSON.stringify(l)},`);return{rewrite:t,file_data:a.join(`
`)}}async process_save_queue(){this.collection.emit_event("collection:save_started"),this.collection.show_process_notice("saving_collection");let e=Object.values(this.collection.items).filter(o=>o._queue_save),t=Date.now(),s=50;for(let o=0;o<e.length;o+=s){let a=e.slice(o,o+s);await Promise.all(a.map(c=>this.create_item_adapter(c).save().catch(d=>{console.warn(`Error saving item ${c.key}`,d),c.queue_save()})))}let i=Object.values(this.collection.items).filter(o=>o.deleted);i.length&&i.forEach(o=>{delete this.collection.items[o.key]}),console.log(`Saved (single-file) ${this.collection.collection_key} in ${Date.now()-t}ms`),this.collection.clear_process_notice("saving_collection"),this.collection.emit_event("collection:save_completed")}},Mf=class extends At{static{r(this,"AjsonSingleFileItemDataAdapter")}get data_path(){return this.collection_adapter.get_item_data_path(this.item.key)}async load(){let e=this.data_path;if(!await this.fs.exists(e)){this.item.queue_import?.();return}try{let t=await this.fs.read(e,"utf-8",{no_cache:!0});if(!t){this.item.queue_import?.();return}let{rewrite:s}=this.collection_adapter.parse_single_file_ajson(t)}catch(t){console.warn(`Error loading single-file item ${this.item.key}`,t),this.item.queue_import?.()}}},na={collection:ts,item:Mf};var ia=class extends re{static{r(this,"SmartComponent")}static key="smart_component";static collection_key="smart_components";collection_key="smart_components";get_key(){if(this.data?.key)return this.data.key;let e=this.scope_key,t=this.component_key,s=Number.isFinite(this.data?.version)?this.data.version:0,i=this.data?.hash||"nohash",o=[];return!t.includes(e)&&e!=="global"&&o.push(e),o.push(t),`${o.join("_").replace(/\./g,"_")}#${[s,i].join("#")}`}get scope_key(){return this.data?.scope_key}get component_key(){return this.data?.component_key}get component_adapter(){return this._component_adapter}async render(e,t={}){if(!this.component_adapter)throw new Error(`SmartComponent: adapter missing for ${this.component_key}`);return await this.component_adapter.render(e,t)}};function SP(n=[]){let e=n.filter(Boolean).map(i=>i.toString()),t=e.pop();return{scope_key:e.length?e.join("."):"global",component_key:t}}r(SP,"parse_component_properties");async function CP(n,e){let{scope_key:t,component_key:s}=SP(n);if(!s)return null;let i=typeof e=="function"?e:e?.render,o=typeof i?.version=="number"?i.version:0,a=await oe(i.toString());return{scope_key:t,component_key:s,version:o,hash:a}}r(CP,"build_component_data");var au=class{static{r(this,"SmartComponentAdapter")}constructor(e,t){this.item=e,this.module=t,this.item.env.create_env_getter(this)}static should_use_adapter(e){return!0}static async register_component(e,t,s){if(!this.should_use_adapter(s))return null;let i=await CP(t,s);if(!i)return null;let o=await e.create_or_update({...i});return o?(o._component_module=s,o._component_adapter=new this(o,s),o):null}async render(e,t){throw new Error("render() not implemented")}};var cu=class extends au{static{r(this,"SmartViewComponentAdapter")}static should_use_adapter(e){return typeof e=="function"||typeof e?.render=="function"}get smart_view(){return this._smart_view||(this._smart_view=this.env.init_module("smart_view")),this._smart_view}async render(e,t={}){let s=typeof this.module=="function"?this.module:this.module?.render;if(typeof s!="function")throw new Error("SmartViewComponentAdapter: render() missing on module");return await s.call(this.smart_view,e,t)}};function ZE(n,e=[],t=[]){return!n||typeof n!="object"||Object.entries(n).forEach(([s,i])=>{let o=[...e,s];if(i){if(typeof i=="function"||typeof i?.render=="function"){t.push({properties:o,module:i});return}typeof i=="object"&&ZE(i,o,t)}}),t}r(ZE,"flatten_components_config");var lu=class extends ae{static{r(this,"SmartComponents")}static key="smart_components";static collection_key="smart_components";collection_key="smart_components";async init(){await this.load_components_from_config()}get component_adapters(){return Array.isArray(this.opts?.component_adapters)?this.opts.component_adapters:this.opts?.component_adapters&&typeof this.opts.component_adapters=="object"?Object.values(this.opts.component_adapters):this.constructor.default_component_adapters||[]}async load_components_from_config(){let e=ZE(this.env.config?.components||{});for(let t of e)await this.register_component(t.properties,t.module)}async register_component(e,t){for(let s of this.component_adapters){let i=await s.register_component(this,e,t);if(i)return i}return null}async render_component(e,t,s={}){let i=this.filter(a=>a.key.startsWith(e+"#")?!0:a.component_key===e).sort((a,c)=>{let l=a.scope_key===t.key?1:0;return(c.scope_key===t.key?1:0)-l});if(i.length===0)throw new Error(`SmartComponents: no component found for key ${e}`);return await i[0].render(t,s)}},QE={class:lu,item_type:ia,data_adapter:na,component_adapters:{SmartViewComponentAdapter:cu}};var e1=QE;function t1(n=[]){let e=new Set;for(let{key:t}of n)t.includes("#")||e.add(t);return n.filter(({key:t})=>{if(!t.includes("#"))return!0;let s=t.split("#")[0];return!e.has(s)})}r(t1,"filter_redundant_context_items");var oa=class extends re{static{r(this,"SmartContext")}static version=1;static get defaults(){return{data:{key:"",context_items:{},context_opts:{}}}}queue_save(){super.queue_save(),this.collection.queue_save()}add_item(e,t={}){let{emit_updated:s=!0}=t,i;typeof e=="object"?i=e.key||e.path:i=e;let o=this.data.context_items[i],a={d:0,at:Date.now(),...o||{},...typeof e=="object"?e:{}};if(!i)return console.error("SmartContext: add_item called with invalid item",e);this.data.context_items[i]=a,this.queue_save(),s&&this.emit_event("context:updated",{add_item:i})}add_items(e){Array.isArray(e)||(e=[e]),e.forEach(t=>this.add_item(t,{emit_updated:!1})),this.emit_event("context:updated",{added_items:e.map(t=>typeof t=="object"?t.key||t.path:t)})}remove_item(e){!e||!this.data?.context_items?.[e]||(this.data.context_items[e].folder?this.data.context_items[e].exclude=!0:delete this.data.context_items[e],this.queue_save(),this.emit_event("context:updated",{removed_key:e}))}clear_all(){this.data.context_items={},this.queue_save(),this.emit_event("context:updated",{cleared:!0})}get context_item_keys(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).map(([e,t])=>e)}get key(){return this.data.key||(this.data.key=Date.now().toString()),this.data.key}get has_context_items(){return Object.keys(this.data.context_items||{}).length>0}get name(){return this.data.name}set name(e){if(typeof e!="string")throw new TypeError("Name must be a string");let t=!this.data.name||String(this.data.name).trim().length===0;this.data.name=e,t?this.emit_event("context:named"):this.emit_event("context:renamed",{name:e}),this.queue_save()}get size(){let e=0;return this.get_context_items().forEach(s=>{s.size&&(e+=s.size)}),e}get item_count(){return Object.entries(this.data?.context_items||{}).filter(([e,t])=>!t.exclude).length}async get_text(e={}){let t=[],s=this.context_items.filter(e.filter).sort((o,a)=>o.data.d-a.data.d);console.log("get_text context_items",s);for(let o of s){if(o.is_media)continue;let a=await o.get_text();typeof a=="string"?t.push(a):this.emit_get_text_error(o,a)}let i=t.join(`
`);return typeof this.actions.context_merge_template=="function"?await this.actions.context_merge_template(i,{context_items:s}):i}async get_media(e={}){let t=this.context_items.filter(e.filter),s=[];for(let i of t){if(!i.is_media)continue;let o=await i.get_base64();o.error?this.emit_get_media_error(i,o):s.push(o)}return s}get context_items(){if(!this._context_items){let e=this.env.config.collections.context_items,t=e.class;this._context_items=new t(this.env,{...e,class:null}),this._context_items.load_from_data(this.data.context_items||{}),this.on_event("context:updated",()=>{this._context_items=null})}return this._context_items}emit_get_text_error(e,t){this.emit_event("notification:error",{message:`Context item did not return text: ${e.key}`,...t&&typeof t=="object"?t:{}})}emit_get_media_error(e,t){this.emit_event("notification:error",{message:`Context item did not return media: ${e.key}`,...t&&typeof t=="object"?t:{}})}get_context_items(e=this.context_item_keys){return t1(e.map(t=>this.get_context_item(t)).filter(Boolean))}get_context_item(e){let t=this.env.context_items.get(e);return t||this.env.context_items.new_item({key:e,...this.data.context_items[e]||{}})}get_ref(e){return this.collection.get_ref(e)}get_item_keys_by_depth(e){return Object.keys(this.data.context_items).filter(t=>{let s=this.data.context_items[t].d;return s===e||typeof s>"u"&&e===0})}};var du=class extends ae{static{r(this,"SmartContexts")}static version=.1;new_context(e={},t={}){let s=new this.item_type(this.env,e);return Array.isArray(t.add_items)&&s.add_items(t.add_items),this.set(s),s.queue_save(),s.emit_event("context:created"),s}static get default_settings(){return{template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"}}get settings_config(){return{...this.env.config.actions.context_merge_template?.settings_config||{}}}get_ref(e){return(e.includes("#")?this.env.smart_blocks:this.env.smart_sources).get(e)}};var OP={class:du,data_adapter:ts,item_type:oa};var s1=OP;var _u=class extends re{static{r(this,"ContextItem")}get collection_key(){return"context_items"}get context_type_adapter(){if(!this._context_type_adapter){let e=this.collection.context_item_adapters.find(t=>t.detect(this.key,this.data));if(!e)throw new Error(`No context item adapter found for key: ${this.key}`);this._context_type_adapter=new e(this)}return this._context_type_adapter}get exists(){return this.context_type_adapter.exists}async get_text(){let e=await this.context_type_adapter.get_text();return typeof e!="string"?e:typeof this.actions.context_item_merge_template=="function"?await this.actions.context_item_merge_template(e):e}async get_base64(){return this.is_media?await this.context_type_adapter.get_base64():{error:`Context item is not media type: ${this.key}`}}async open(e=null){return await this.context_type_adapter.open(e)}get is_media(){return this.context_type_adapter.is_media||!1}get item_ref(){return this.context_type_adapter.ref||null}get size(){return this.data.size||this.context_type_adapter.size||0}get mtime(){return this.data.mtime||this.context_type_adapter.mtime||null}};var at=class{static{r(this,"ContextItemAdapter")}constructor(e){this.item=e}static detect(e,t={}){return!1}get env(){return this.item.env}get exists(){return!0}get size(){return 0}async get_text(){}async open(){}};var uu=class extends at{static{r(this,"BlockContextItemAdapter")}static order=6;static detect(e){return e.includes("#")}get ref(){return this.env.smart_blocks.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get mtime(){return this.ref?.mtime||null}get size(){return this.ref?.size||0}async get_text(){let e=this.ref;return e?await e.read():{error:"Block not found"}}async open(e=null){this.ref.actions.source_open(e)}};var mu=class extends at{static{r(this,"SourceContextItemAdapter")}static order=7;static detect(e){return!0}get ref(){return this.env.smart_sources.get(this.item.key)}get inlinks(){return this.ref.inlinks||[]}get outlinks(){return this.ref.outlinks||[]}get exists(){return!!(this.ref&&!this.ref.is_gone)}get size(){return this.ref?.size||0}get mtime(){return this.ref?.mtime||null}async get_text(){return await this.ref?.read()||"MISSING SOURCE"}async open(e=null){this.ref.actions.source_open(e)}};var n1=/\.(png|jpe?g|gif|bmp|webp|svg|ico|mp4)$/i;var pu=class extends at{static{r(this,"ImageContextItemAdapter")}static detect(e){return n1.test(e)?"image":!1}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}get is_media(){return!0}async get_base64(){let e=this.item.key.split(".").pop().toLowerCase();try{let t=await this.item.env.fs.read(this.item.key,"base64"),s=`data:image/${e};base64,${t}`;return{type:"image_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:s}}catch(t){return console.warn(`Failed to convert image ${this.item.key} to base64`,t),{error:`Failed to convert image to base64: ${t.message}`}}}};var hu=class extends at{static{r(this,"PdfContextItemAdapter")}static detect(e){return e.endsWith(".pdf")?"pdf":!1}async add_to_snapshot(e){e.pdfs||(e.pdfs=[]),e.pdfs.push(this.item.key)}get is_media(){return!0}async get_base64(){try{let t=`data:application/pdf;base64,${await this.item.env.fs.read(this.item.key,"base64")}`;return{type:"pdf_url",key:this.item.key,name:this.item.key.split(/[\\/]/).pop(),url:t}}catch(e){return console.warn(`Failed to convert PDF ${this.item.key} to base64`,e),{error:`Failed to convert PDF to base64: ${e.message}`}}}get exists(){return this.item.env.smart_sources.fs.exists_sync(this.item.key)}};var Lf=class extends ae{static{r(this,"ContextItems")}async load(){console.log("ContextItems: load called")}static version=1;get context_item_adapters(){return this._context_item_adapters||(this._context_item_adapters=Object.values(this.opts.context_item_adapters).sort((e,t)=>{let s=e.order||0,i=t.order||0;return s-i})),this._context_item_adapters}new_item(e){let t=new this.item_type(this.env,e);return this.set(t),t}process_load_queue(){}get settings_config(){return{...this.env.config.actions.context_item_merge_template?.settings_config||{}}}get_adapter_class(e,t){return this.context_item_adapters.find(s=>s.detect(e,t))}static get default_settings(){return{template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"}}load_from_data(e){delete this.items,this.items={};let t=Object.entries(e||{});for(let s=0;s<t.length;s++){let[i,o]=t[s];o.exclude||this.new_item({key:i,...o})}}},i1={version:1,class:Lf,collection_key:"context_items",item_type:_u,context_item_adapters:{BlockContextItemAdapter:uu,SourceContextItemAdapter:mu,ImageContextItemAdapter:pu,PdfContextItemAdapter:hu}};function o1(n={},e){let t=(n.ct||0)+1,s=n.first_at??e;return{ct:t,first_at:s,last_at:e}}r(o1,"next_log_stats");var bi=class extends re{static{r(this,"EventLog")}static version=.002;static get defaults(){return{data:{key:null,ct:0,first_at:null,last_at:null}}}init(e){}};var qP={"collection:save_started":!0,"collection:save_completed":!0},zf=class extends ae{static{r(this,"EventLogs")}static version=.003;constructor(e,t={}){super(e,t),this.session_events=[],this.notification_status=null}static create(e,t={}){let s=new this(e,t);return s.init(),s}get item_type(){return bi}init(){this.env?.events||Ds.create(this.env),this._unsub_wildcard&&this._unsub_wildcard(),this._unsub_wildcard=this.env.events.on("*",(e,t)=>{this.on_any_event(t,e)})}on_any_event(e,t){if(!qP[e]){this.session_events.push({event_key:e,event:t}),e==="notification:error"?this.notification_status="error":e==="notification:warning"&&this.notification_status!=="error"?this.notification_status="warning":e==="notification:attention"&&!this.notification_status&&(this.notification_status="attention");try{if(typeof e!="string")return;let s=Date.now(),i=this.get(e);i||(i=new bi(this.env,{key:e}),this.set(i),this.emit_event("event_log:first",{first_of_event_key:e}));let o=o1({ct:i.data.ct,first_at:i.data.first_at,last_at:i.data.last_at},s);i.data={...i.data,...o},t.event_source&&(i.data.event_sources||(i.data.event_sources={}),i.data.event_sources[t.event_source]||(i.data.event_sources[t.event_source]=0),i.data.event_sources[t.event_source]++),i.queue_save(),this.queue_save()}catch(s){console.error("[EventLogs] record failure",e,s)}}}unload(){return this._save_timer&&(clearTimeout(this._save_timer),this._save_timer=null),typeof this._unsub_wildcard=="function"&&(this._unsub_wildcard(),this._unsub_wildcard=null),super.unload()}},r1={class:zf,collection_key:"event_logs",data_adapter:ts,item_type:bi};var Js=require("obsidian");var fu=class extends Js.FuzzySuggestModal{static{r(this,"SmartFuzzySuggestModal")}constructor(e){let t=e.env,s=t.plugin,i=s.app;super(i),this.app=i,t.create_env_getter(this),this.plugin=s,this.item_or_collection=e,this.emptyStateText="No suggestions available"}static get modal_type(){return"smart-fuzzy-suggest"}static get display_text(){return"Smart Fuzzy Suggest"}static get event_domain(){return`${this.modal_type}`}static get command_id(){return this.modal_type}static open(e,t){let s=this,i=new s(e,t);return i.open(t),i}static register_modal(e){let t=this,s=e?.env,i={...s.config.modals?.[this.modal_key]||{},class:null};console.log(`Registering modal: ${this.display_text}`,{modal_config:i,Modal:t});let o=r((l={})=>{let d=t.resolve_item_from_payload(s,l);return t.open(d,{...i,...l})},"open_handler"),a=[s?.events?.on?.(`${t.event_domain}:open`,o)],c=r(()=>{a.forEach(l=>typeof l=="function"&&l())},"dispose_all");return typeof e.register=="function"&&e.register(()=>c()),{event_domain:t.event_domain}}static resolve_item_from_payload(e,t){return e?.[t.collection_key]?.items?.[t.item_key]}open(e={}){super.open(),this.modalEl.addEventListener("keydown",t=>{t.key==="Enter"&&this.selectActiveSuggestion(t);let s=this.inputEl.selectionStart===this.inputEl.value.length;if(t.target!==this.inputEl||!this.inputEl.value||s||Js.Keymap.isModEvent(t)){if(t.key==="ArrowLeft"){this.use_arrow_left=!0,this.selectActiveSuggestion(t);return}if(t.key==="ArrowRight"&&(s||t.target!==this.inputEl||!this.inputEl.value)){t.preventDefault(),this.use_mod_select=!0,this.use_arrow_right=!0,this.selectActiveSuggestion(t);return}}})}getItems(){return this.get_suggestions()}getItemText(e){return e.display}filter_suggestions(e){return e}get_suggestions(){return this.suggestions?.length&&(this.suggestions=this.filter_suggestions(this.suggestions),this.suggestions.length>0)?this.suggestions:this.default_suggest_action_keys?.length?this.default_suggest_action_keys.length===1?(this.update_suggestions(this.default_suggest_action_keys[0]),[]):this.get_suggest_scopes():[]}get_suggest_scopes(){return this.default_suggest_action_keys.map(e=>{let t=this.env.config.actions[e];if(!t)return null;let s=t.display_name||e;return{select_action:r(()=>{this.update_suggestions(e)},"select_action"),key:e,display:s}}).filter(Boolean)}async update_suggestions(e){if(typeof e=="string"&&(e=this.item_or_collection.actions[e]),typeof e=="function"){let t=await e({modal:this});console.log("Suggestion action result",t),Array.isArray(t)&&t.length&&(this.suggestions=t)}else Array.isArray(e)&&(this.suggestions=e);Array.isArray(this.suggestions)&&this.suggestions.length?this.updateSuggestions():(this.env.events.emit("notification:error",{message:"Invalid suggestion action"}),console.warn("Invalid suggestion action",e))}get default_suggest_action_keys(){return Array.isArray(this.params?.default_suggest_action_keys)?this.params.default_suggest_action_keys:this.env.config.modals[this.modal_key]?.default_suggest_action_keys||[]}renderSuggestion(e,t){if(super.renderSuggestion(e,t),e.item.icon){t.addClass("sc-modal-suggestion-has-icon");let s=t.createEl("span");(0,Js.setIcon)(s,e.item.icon)}return t}onChooseSuggestion(e,t,...s){this.prevent_close=!0;let i=e.item,o=this.use_arrow_left,a=this.use_arrow_right,c=Js.Keymap.isModifier(t,"Mod")||this.use_mod_select;if(this.use_arrow_right=!1,this.use_mod_select=!1,this.use_arrow_left=!1,o)if(typeof i.arrow_left_action=="function")this.handle_choose_action(i,"arrow_left_action");else{this.last_input_value&&(this.inputEl.value=this.last_input_value,setTimeout(()=>{let l=this.inputEl.value.length;this.inputEl.setSelectionRange(l,l)},0),this.last_input_value=null),this.suggestions=null,this.params.default_suggest_action_keys=null,this.updateSuggestions();return}else a&&typeof i.arrow_right_action=="function"?this.handle_choose_action(i,"arrow_right_action"):c&&typeof i.mod_select_action=="function"?this.handle_choose_action(i,"mod_select_action"):typeof i.select_action=="function"?this.handle_choose_action(i,"select_action"):this.env.events.emit("notification:warning",{selection_display:i.display,message:"No action defined for this suggestion"})}async handle_choose_action(e,t){let s=e[t],i=await s({modal:this});Array.isArray(i)&&i.length?this.suggestions=i:Array.isArray(i)&&this.env.events.emit("notification:info",{message:"No suggestions returned from action"});let o=this.chooser.values.findIndex(a=>a.item?.display===e.display);setTimeout(()=>{this.updateSuggestions(),o!==-1&&this.chooser.setSelectedItem(o)},100)}close(){setTimeout(()=>{this.prevent_close||super.close(),this.prevent_close=!1},10)}onClose(){this.item_or_collection.emit_event(`${this.constructor.event_domain}:closed`)}};var $Se=require("obsidian");var gu=class extends fu{static{r(this,"ContextModal")}static get modal_type(){return"context_selector"}static get display_text(){return"Context Selector"}static get event_domain(){return"context_selector"}static get command_id(){return this.modal_type}static get modal_key(){return"context_selector"}get modal_key(){return"context_selector"}constructor(e,t={}){super(e),this.params={...t},this.smart_context=e,this.setInstructions([{command:"Enter",purpose:"Add to context"},{command:"\u2192 / \u2190",purpose:"Toggle block view"},{command:"Esc",purpose:"Close"}])}open(e={}){this.params={...this.params,...e},super.open(),this.render(this.params)}async render(e=this.params){this.modalEl.style.display="flex",this.modalEl.style.flexDirection="column",this.modalEl.style.height="100%",this.modalEl.prepend(await this.env.smart_components.render_component("smart_context_item",this.smart_context,e))}filter_suggestions(e){return e.filter(t=>!(t.key&&this.smart_context?.data?.context_items[t.key]))}};var a1=require("obsidian");var yu=class extends a1.Modal{static{r(this,"NotificationsFeedModal")}constructor(e,t){super(e),this.env=t}async onOpen(){this.titleEl.setText("Smart Env notifications"),this.contentEl.empty();let e=await this.env.smart_components.render_component("notifications_feed",this.env);this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};var vu=require("obsidian");var $P="https://smartconnections.app/smart-environment/milestones/?utm_source=milestones_modal_help",bu=class extends vu.Modal{static{r(this,"MilestonesModal")}constructor(e,t){super(e),this.env=t}async onOpen(){jP(this.titleEl,this.env),this.contentEl.empty();let e=await this.env.smart_components.render_component("milestones",this.env,{});this.contentEl.appendChild(e)}onClose(){this.contentEl.empty()}};function jP(n,e){if(!n)return;n.empty(),n.classList.add("sc-milestones-modal__title");let t=document.createElement("div");t.className="sc-milestones-modal__title-row";let s=document.createElement("div");s.className="sc-milestones-modal__title-text",s.textContent="Smart Milestones";let i=document.createElement("button");i.type="button",i.className="sc-milestones-modal__help-btn",i.setAttribute("aria-label","Open Smart Milestones help"),i.setAttribute("title","Help"),TP(i),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{e?.events?.emit?.("milestones:help",{})}catch{}window.open($P,"_external")}),t.appendChild(s),t.appendChild(i),n.appendChild(t)}r(jP,"render_milestones_modal_title");function TP(n){NP(n,["circle-help","help-circle","help","info"])||(n.textContent="?")}r(TP,"render_help_icon");function NP(n,e){if(!n)return!1;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,vu.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return!0}return!1}r(NP,"set_icon_with_fallback");var c1={is_obsidian_vault:!0,smart_blocks:{embed_blocks:!0,min_chars:200},smart_sources:{min_chars:200,embed_model:{adapter:"transformers",transformers:{model_key:"TaylorAI/bge-micro-v2"}},excluded_headings:"",file_exclusions:"Untitled",folder_exclusions:""},language:"en",re_import_wait_time:13,smart_chat_threads:{chat_model:{adapter:"ollama",ollama:{}}},smart_notices:{},smart_view_filter:{expanded_view:!1,render_markdown:!0,show_full_path:!1},version:"",new_user:!0,models:{embedding_platform:"transformers",chat_completion_platform:"open_router"}};var ra=class extends re{static{r(this,"Model")}static get defaults(){return{data:{api_key:"",provider_key:"",model_key:""}}}get_key(){return this.data.key||(this.data.created_at=Date.now(),this.data.key=`${this.data.provider_key}#${this.data.created_at}`),this.data.key}get provider_key(){return this.data.provider_key}get env_config(){return this.collection.env_config}get provider_config(){return this.env_config.providers?.[this.provider_key]||{}}get ProviderAdapterClass(){return this.provider_config.class}get instance(){if(!this._instance){if(!this.ProviderAdapterClass)return this.collection.new_model({provider_key:this.collection.default_provider_key}).instance;let e=this.ProviderAdapterClass;this._instance=new e(this),this._instance.load(),this.once_event("model:changed",()=>{this._instance.unload?.(),this._instance=null})}return this._instance}async count_tokens(e){return this.instance.count_tokens(e)}get api_key(){return this.data.api_key}create_settings_proxy(e){if(!e||typeof e!="object")return e;this._settings_proxy_map||(this._settings_proxy_map=new WeakMap);let t=this._settings_proxy_map.get(e);if(t)return t;let s=this,i={get(a,c,l){let d=Reflect.get(a,c,l);return d&&typeof d=="object"?s.create_settings_proxy(d):d},set(a,c,l,d){let _=a[c],m=Reflect.set(a,c,l,d);return _!==l&&s.debounce_save(),m},deleteProperty(a,c){let l=Object.prototype.hasOwnProperty.call(a,c),d=Reflect.deleteProperty(a,c);return l&&s.debounce_save(),d}},o=new Proxy(e,i);return this._settings_proxy_map.set(e,o),o}debounce_save(e=100){this.emit_event("model:changed"),this._debounce_save_timeout&&clearTimeout(this._debounce_save_timeout),this._debounce_save_timeout=setTimeout(()=>{this.queue_save(),this.collection.process_save_queue(),this._debounce_save_timeout=null},e)}async get_model_key_options(){let e=await this.instance.get_models();return Object.entries(e).map(([t,s])=>({label:s.name||t,value:s.key||t})).sort((t,s)=>t.label.toLowerCase().includes("free")&&!s.label.toLowerCase().includes("free")?-1:!t.label.toLowerCase().includes("free")&&s.label.toLowerCase().includes("free")?1:t.label.localeCompare(s.label))}model_changed(e,t,s){if(e==="model_key"){this.data.model_key=t;let i=this.data.provider_models?.[this.data.model_key]||{},o=this.ProviderAdapterClass.defaults||{};delete this.data.test_passed,this.data={...this.data,...o,...i}}["api_key","meta.name"].includes(e)||this.emit_event("model:changed")}async test_model(){}get display_name(){return this.data.meta?.name||`${this.data.provider_key} - ${this.data.model_key}`}get settings_config(){return{provider_key:{type:"html",value:`<p><strong>Provider:</strong> ${this.data.provider_key}</p>`},"meta.name":{type:"text",name:"Name",description:"A friendly name for this model configuration."},model_key:{type:"dropdown",name:"Model",description:"The model to use from the selected provider.",options_callback:"get_model_key_options",callback:"model_changed"},...Object.fromEntries(Object.entries(this.provider_config.settings_config||{}).map(([e,t])=>[e,{...t,callback:t.callback||"model_changed"}]))}}delete_model(){this.delete(),this.debounce_save()}get settings(){return this.create_settings_proxy(this.data)}get model_key(){return this.data.model_key}get opts(){return this.settings}};var ku=class extends ae{static{r(this,"Models")}model_type="Model type";new_model(e={}){if(!e.provider_key)throw new Error("provider_key is required to create a new model");let t=this.filter(i=>i.provider_key===e.provider_key).sort((i,o)=>o.data.created_at-i.data.created_at)[0];t&&!e.api_key&&t.data.api_key&&(e.api_key=t.data.api_key);let s=new this.item_type(this.env,{...e});return this.set(s),this.settings.default_model_key=s.key,this.emit_event("model:changed"),s.queue_save(),s}get default_provider_key(){throw new Error("default_provider_key not implemented")}get default_model_key(){if(!this.settings.default_model_key||!this.get(this.settings.default_model_key)||this.get(this.settings.default_model_key).deleted){let t=this.filter(s=>!s.deleted).sort((s,i)=>i.data.created_at-s.data.created_at)[0];if(t)this.settings.default_model_key=t.key;else{let s=this.new_model({provider_key:this.default_provider_key});s.queue_save(),this.process_save_queue(),this.settings.default_model_key=s.key}}return this.settings.default_model_key}get default(){return this.get(this.default_model_key)}get env_config(){return this.env.config.collections[this.collection_key]}get_model_key_options(){return this.filter(e=>!e.deleted&&e.ProviderAdapterClass).map(e=>({label:e.data.meta?.name||`${e.provider_key} - ${e.data.model_key}`,value:e.key}))}};function l1(n){return{default_model_key:{type:"dropdown",name:`Default ${n.model_type.toLowerCase()} model`,description:`Used as the default ${n.model_type.toLowerCase()} model when no other is specified.`,options_callback:r(()=>n.get_model_key_options(),"options_callback"),callback:r(async(e,t)=>{n.emit_event("model:changed")},"callback")}}}r(l1,"settings_config");var Ks=class extends ra{static{r(this,"EmbeddingModel")}static get defaults(){return{data:{api_key:"",provider_key:"transformers",model_key:"TaylorAI/bge-micro-v2",dims:384,max_tokens:512}}}async embed(e){return typeof e=="string"&&(e=[{embed_input:e}]),(await this.embed_batch(e))[0]}async embed_batch(e){return this.instance.embed_batch(e)}async test_model(){try{let e=await this.embed("test input"),t=e&&!e?.error;return this.data.test_passed=t,this.debounce_save(),{success:t,response:e}}catch(e){return this.data.test_passed=!1,{error:e.message||String(e)}}}};var Df=class extends ku{static{r(this,"EmbeddingModels")}model_type="Embedding";get default_provider_key(){return"transformers"}};var PP={class:Df,data_dir:"embedding_models",collection_key:"embedding_models",data_adapter:na,item_type:Ks,providers:{},settings_config:l1},Rf=PP;var Ff=class extends fi{static{r(this,"TransformersIframeEmbeddingModelAdapter")}constructor(e){super(e)}get models(){return{"TaylorAI/bge-micro-v2":{id:"TaylorAI/bge-micro-v2",batch_size:1,dims:384,max_tokens:512,name:"BGE-micro-v2 (fastest)",description:"Local, 512 tokens, 384 dim (recommended)",adapter:"transformers"},"Snowflake/snowflake-arctic-embed-xs":{id:"Snowflake/snowflake-arctic-embed-xs",batch_size:1,dims:384,max_tokens:512,name:"Snowflake Arctic Embed XS (fast)",description:"Local, 512 tokens, 384 dim",adapter:"transformers"},"Xenova/multilingual-e5-small":{id:"Xenova/multilingual-e5-small",batch_size:1,dims:384,max_tokens:512,name:"Multilingual E5 Small",description:"Local, 512 tokens, 384 dim",adapter:"transformers"}}}},d1={class:Ff,settings_config:vf};Rf.providers={transformers:d1};var _1=Rf;var ss=class extends re{static{r(this,"LookupList")}static key="lookup_list";static get defaults(){return{data:{}}}async pre_process(e){typeof this.actions.lookup_list_pre_process=="function"&&await this.actions.lookup_list_pre_process(e)}async get_results(e={}){await this.pre_process(e);let t=this.filter_and_score(e);return this.should_post_process&&(t=await this.post_process(t,e)),this.emit_event("lookup:get_results"),t}filter_and_score(e={}){let t=this.env[e.results_collection_key]||this.env[this.collection.results_collection_key],s=[],{results:i}=Object.values(t.items).reduce((a,c)=>{let l=c.filter_and_score(e);return l?.score?(I_(a,l,e.limit||20),a):(l?.error&&s.push(l.error),a)},{min:0,results:new Set}),o=Array.from(i).sort(M_);if(!o.length)return o;for(;!o.some(a=>a.score>.5);)o.forEach(a=>a.score*=2);return o}async post_process(e,t={}){return e}get should_post_process(){return this.settings.lookup_post_process&&this.settings.lookup_post_process!=="none"}get item(){return this}};var u1={results_collection_key:{name:"Lookup results type",type:"dropdown",description:"Choose whether results should be sources or blocks.",option_1:"smart_sources|Sources",option_2:"smart_blocks|Blocks",options_callback:r(n=>{let e=[{value:"smart_sources",name:"Sources"}];return n.env.smart_blocks&&e.push({value:"smart_blocks",name:"Blocks"}),e},"options_callback")}},Bf=class extends ae{static{r(this,"LookupLists")}static get default_settings(){return{results_collection_key:"smart_blocks",score_algo_key:"similarity",results_limit:20}}static version=.01;new_item({query:e,filter:t}){if(!e||typeof e!="string"||!e.trim())throw new Error("LookupLists.new_item requires a non-empty query string.");let s=IP(new Date),i=oe(e),o=`${s}+${i}`;if(this.items[o])return this.items[o];let a=new ss(this.env,{key:o,query:e,filter:t});return this.set(a),a}get settings_config(){return{...u1}}process_load_queue(){}get results_collection_key(){let e=this.settings?.results_collection_key;return this.env.collections?.[e]?e:"smart_sources"}};function IP(n){let e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${e}-${t}-${s}`}r(IP,"format_ymd");var m1={class:Bf,collection_key:"lookup_lists",item_type:ss,settings_config:u1};function aa(n){return n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}r(aa,"format_collection_name");async function MP(n,e={}){let t=Object.entries(n.settings_config).map(([i,o])=>(o.setting||(o.setting=i),this.render_setting_html(o))).join(`
`);return`<div><div class="collection-settings-container"><div class="source-settings collection-settings">
<h2>${aa(n.collection_key)}</h2>
${t}
</div></div></div>`}r(MP,"build_html");async function p1(n,e={}){let t=await MP.call(this,n,e),s=this.create_doc_fragment(t);return await this.render_setting_components(s,{scope:n}),e.settings_container?(this.empty(e.settings_container),e.settings_container.appendChild(s.querySelector(".collection-settings"))):n.settings_container=s.querySelector(".collection-settings-container"),n.settings_container}r(p1,"render");var vi=require("obsidian");function h1(n,e,t,s,i={}){let o=t?.plugin?.app||window.app;e.addEventListener("mouseover",async a=>{if(vi.Keymap.isModEvent(a)){let c=t.smart_blocks.get(s),l=await c?.read();if(l){let d=new vi.HoverPopover(n,e),_=t.smart_view.create_doc_fragment(`<div class="markdown-embed is-loaded">
<div class="markdown-embed-content node-insert-event">
<div class="markdown-preview-view markdown-rendered node-insert-event show-indentation-guide allow-fold-headings allow-fold-lists">
<div class="markdown-preview-sizer markdown-preview-section">
</div>
</div>
</div>
</div>`);d.hoverEl.classList.add("smart-block-popover"),d.hoverEl.appendChild(_);let m=d.hoverEl.querySelector(".markdown-preview-sizer");vi.MarkdownRenderer.render(o,l,m,"/",d);let p=i.event_key_domain||"block";c.emit_event(`${p}:hover_preview`)}}})}r(h1,"register_block_hover_popover");var f1=require("obsidian");function g1(n,e,t={}){let s=e.env?.plugin?.app||window.app;e.key.indexOf("{")===-1?n.addEventListener("mouseover",i=>{let o=e.key.replace(/#$/,"");if(s.workspace.trigger("hover-link",{event:i,source:"smart-connections-view",hoverParent:n.parentElement,targetEl:n,linktext:o}),f1.Keymap.isModEvent(i)){let a=t.event_key_domain||e.collection_key||"item";e.emit_event(`${a}:hover_preview`)}}):h1(n.parentElement,n,e.env,e.key)}r(g1,"register_item_hover_popover");var b1=require("obsidian");function LP(n){let e=typeof n=="number"?n:Number.parseFloat(n);return Number.isFinite(e)?Number.parseFloat(e.toFixed(2)).toString():null}r(LP,"format_score");function zP(n){let e=typeof n=="number"?n:Number.parseFloat(n);if(!Number.isFinite(e)||e<0)return null;let t=["B","KB","MB","GB"],s=e,i=0;for(;s>=1024&&i<t.length-1;)s/=1024,i+=1;let o=s>=10||Number.isInteger(s)?0:1;return`${Number.parseFloat(s.toFixed(o)).toString()} ${t[i]}`}r(zP,"format_size");function y1(n,e){return n?`<span class="${e}">${n}</span>`:""}r(y1,"build_badge_html");function DP(n,e={}){let t;if(n.item_ref)if(n.item_ref.key.includes("#")){let c=n.item_ref.key.split("/").pop().split("#").filter(Boolean),l=c.pop(),d=[];l&&l.startsWith("{")&&(d.push(c.pop()),d.push(n.item_ref.lines.join("-")),t=d.join(" > Lines: "))}else t=n.item_ref.key.split("/").pop();else t=n.key.split("/").pop();let s=LP(n?.data?.score),i=zP(n?.size||n?.data?.size),o=y1(s,"sc-context-item-score"),a=y1(i,"sc-context-item-size");return`<span class="sc-context-item-leaf">
<span class="sc-context-item-remove" data-path="${n.key}">\xD7</span>
${o}
<span class="sc-context-item-name">${t||n.key}</span>
${a}
</span>`}r(DP,"build_html");async function v1(n,e={}){let t=DP(n,e),i=this.create_doc_fragment(t).firstElementChild;return RP.call(this,n,i,e),i}r(v1,"render");async function RP(n,e,t={}){let s=n.env,i=e.querySelector(".sc-context-item-remove");if(i&&i.addEventListener("click",a=>{let d=a.currentTarget.closest("[data-context-key]")?.getAttribute("data-context-key");s.smart_contexts.get(d).remove_item(n.key)}),n.item_ref){let a=e.querySelector(".sc-context-item-name");a.setAttribute("title",`Hold ${b1.Platform.isMacOS?"\u2318":"Ctrl"} to preview`),g1(a,n.item_ref)}return e.querySelector(".sc-context-item-name").addEventListener("click",a=>{n.open(a)}),e}r(RP,"post_process");async function FP(n,e={}){let t=[];t.push("<h2>Collections</h2>");let s=Object.keys(n.collections).filter(i=>["smart_sources","smart_blocks"].includes(i)).sort((i,o)=>i==="smart_sources"||i==="smart_blocks"?-1:o==="smart_sources"||o==="smart_blocks"?1:i.localeCompare(o));for(let i of s){let o=n[i];if(!o||!o.items){t.push(`
<div class="sc-collection-stats">
<h3>${aa(i)}</h3>
<p>No valid items.</p>
</div>
`);continue}let a=UP(o,i);t.push(a)}return`
<div class="sc-env-stats-container">
${t.join(`
`)}
</div>
`}r(FP,"build_html");async function k1(n,e={}){let t=await FP.call(this,n,e),s=this.create_doc_fragment(t);return await BP.call(this,n,s,e)}r(k1,"render");async function BP(n,e,t={}){return e}r(BP,"post_process");function UP(n,e){let t=Object.values(n.items).length,s=aa(e),i=n.env.collections[e];if(i!=="loaded")return`
<div class="sc-collection-stats">
<h3>${s}</h3>
<p>Not loaded yet (${t} items known).</p>
</div>
`;let o=n.load_time_ms?`<p>Load time: ${n.load_time_ms}ms</p>`:"",a=`<p>State: ${i}</p>`,c=WP(n,s,t),l="";return typeof n.process_embed_queue=="function"&&(l=GP(n,t)),`
<div class="sc-collection-stats">
<h3>${s}</h3>
${l}
${c}
${o}
${a}
</div>
`}r(UP,"generate_collection_stats");function WP(n,e,t,s){return`
<p><strong>Total:</strong> ${t}</p>
`}r(WP,"get_generic_collection_stats");function GP(n,e){if(!Object.values(n.items).filter(a=>a.vec).length)return"<p>No items embedded</p>";let s=Object.values(n.items).reduce((a,c)=>(c.should_embed?a.should_embed+=1:a.should_not_embed+=1,c.vec&&(a.embedded+=1),c.should_embed&&!c.vec&&(a.missing_embed+=1),!c.should_embed&&c.vec&&(a.extraneous_embed+=1),a),{should_embed:0,embedded:0,missing_embed:0,extraneous_embed:0,should_not_embed:0}),i=s.embedded/s.should_embed*100;return`<p><strong>Embedding coverage:</strong> ${Math.round(i)}% (${s.embedded} / ${s.should_embed})</p>`+(s.missing_embed?`<p><strong>Missing embeddings:</strong> ${s.missing_embed}</p>`:"")+(s.extraneous_embed?`<p><strong>Extraneous embeddings:</strong> ${s.extraneous_embed}</p>`:"")+(s.should_not_embed?`<p><strong>Other items (e.g. less than minimum length to embed):</strong> ${s.should_not_embed}</p>`:"")}r(GP,"calculate_embed_coverage");var w1=require("obsidian");function HP(n,e={}){return'<div class="smart-form-dropdown-component"></div>'}r(HP,"build_html");async function Uf(n,e={}){let t=HP.call(this,n,e),s=this.create_doc_fragment(t);return await JP.call(this,n,s,e)}r(Uf,"render");async function JP(n,e,t={}){if(!n)return e.textContent="Error: scope is required for dropdown component.",e;let s=n.settings;if(!s||typeof s!="object")return e.textContent="Error: scope.settings{} is required for dropdown component.",e;let i=t.setting_key;if(!i)return e.textContent="Error: setting_key is required for dropdown component.",e;let o=t.options;if(!Array.isArray(o)||o.length===0)return e.textContent="Error: options[] is required for dropdown component.",e;let a=new w1.Setting(e);t.label&&typeof a.setName=="function"&&a.setName(t.label),t.description&&typeof a.setDesc=="function"&&a.setDesc(t.description),t.tooltip&&typeof a.setTooltip=="function"&&a.setTooltip(t.tooltip);let c=Ae(s,i)??"",l=null;a.addDropdown(_=>{console.log({dropdown:_,current_value:c,scope:n,options:o}),l=_.selectEl,t.required&&l.setAttribute("required","true"),o.forEach(m=>{_.addOption(m.value,m.label)}),l.childNodes.forEach(m=>{m.value===c&&(m.selected=!0),o.find(p=>p.value===m.value)?.disabled&&(m.disabled=!0)}),l&&(l.value=c)});let d=r(()=>{let _=l.value;typeof t.on_change=="function"?t.on_change(_,{scope:n,setting_key:i,select_el:l,container:e}):Se(n.settings,i,_)},"handler");return l.addEventListener("change",d),this.attach_disposer(l,()=>{l.removeEventListener("change",d)}),e}r(JP,"post_process");Uf.version=.2;var x1=require("obsidian");function KP(n,e={}){return`<div class="wrapper">
<div id="lean-coffee-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner">
<strong>Community Lean Coffee</strong>
</div>
</div>
<div class="callout-content">
<p dir="auto">
<span>Ask questions. Bring challenges. Request features. Show workflows. Be ready to share.</span>
<br>
<i>Join the next <a href="https://lu.ma/calendar/cal-ZJtdnzAdURyouM7" target="_external">Community Lean Coffee</a> meeting.</i> Unable to attend? Submit a question <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqOtTjksMwg1BOuGNCncpMQ_QT-wcd-3AgZGIe3A_isut5aQ/viewform?usp=dialog" target="_external">here</a> \u{1F334}
</p>
</div>
</div>
</div>`}r(KP,"build_html");function E1(n,e={}){let t=KP.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#lean-coffee-callout"),o=i.querySelector(".callout-icon"),a=(0,x1.getIcon)("smart-chat");return a&&(this.empty(o),o.appendChild(a)),VP.call(this,n,i,e),i}r(E1,"render");function VP(n,e){}r(VP,"post_process");var A1=`.sc-events-checklist {\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
padding: var(--size-4-2);\r
\r
.sc-events-checklist__header {\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__title {\r
margin: 0;\r
font-size: var(--h2-size);\r
}\r
\r
.sc-events-checklist__summary {\r
font-size: var(--font-ui-small);\r
color: var(--text-normal);\r
font-variant-numeric: tabular-nums;\r
\r
padding: 0.15em 0.6em;\r
border-radius: 999px;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
white-space: nowrap;\r
}\r
\r
.sc-events-checklist__hint {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
text-align: right;\r
}\r
\r
.sc-events-checklist__progress {\r
height: 6px;\r
border-radius: 999px;\r
overflow: hidden;\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
}\r
\r
.sc-events-checklist__progress-fill {\r
height: 100%;\r
width: var(--sc-events-checklist-progress, 0%);\r
background-color: var(--color-green, var(--interactive-accent));\r
}\r
\r
.sc-events-checklist__group {\r
border-top: 1px solid var(--background-modifier-border);\r
padding-top: var(--size-4-3);\r
}\r
\r
.sc-events-checklist__group-title {\r
margin: 0 0 var(--size-4-2) 0;\r
font-size: var(--h3-size);\r
\r
display: flex;\r
align-items: baseline;\r
justify-content: space-between;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-events-checklist__group-name {\r
display: inline-flex;\r
align-items: center;\r
min-width: 0;\r
}\r
\r
.sc-events-checklist__group-count {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
white-space: nowrap;\r
font-variant-numeric: tabular-nums;\r
flex: 0 0 auto;\r
}\r
\r
/*\r
Group completion badge:\r
- shows only when every item in the group is checked\r
- uses :has() (no JS needed)\r
- avoids false positives on empty groups by requiring at least one item\r
*/\r
.sc-events-checklist__group:has(.sc-events-checklist__item):not(:has(.sc-events-checklist__item[data-checked='false'])) {\r
.sc-events-checklist__group-name::after {\r
content: "DONE";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.5em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.65em;\r
font-weight: 700;\r
letter-spacing: 0.12em;\r
text-transform: uppercase;\r
\r
/* theme vars (with safe fallback) */\r
color: var(--color-green, var(--text-accent));\r
background-color: var(--background-secondary);\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.25);\r
transform: translateY(-0.03em);\r
}\r
}\r
\r
.sc-events-checklist__items {\r
list-style: none;\r
padding: 0;\r
margin: 0;\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-2-2);\r
}\r
\r
.sc-events-checklist__item {\r
display: flex;\r
flex-direction: column;\r
gap: 2px;\r
padding: 6px 8px;\r
border-radius: var(--radius-s);\r
\r
cursor: pointer;\r
border: 1px solid transparent;\r
\r
transition:\r
background-color 120ms ease,\r
border-color 120ms ease,\r
transform 120ms ease;\r
\r
&:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
}\r
\r
&:active {\r
transform: translateY(1px);\r
}\r
\r
&:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
}\r
\r
.sc-events-checklist__label {\r
display: flex;\r
align-items: flex-start;\r
gap: var(--size-2-2);\r
cursor: pointer;\r
}\r
\r
.sc-events-checklist__icon {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-top: 2px;\r
width: 18px;\r
height: 18px;\r
flex: 0 0 auto;\r
color: var(--text-muted);\r
\r
svg {\r
width: 18px;\r
height: 18px;\r
}\r
}\r
\r
.sc-events-checklist__milestone {\r
line-height: 1.3;\r
user-select: text;\r
cursor: text;\r
}\r
\r
.sc-events-checklist__item[data-checked='true'] {\r
.sc-events-checklist__icon {\r
color: var(--color-green, var(--text-accent));\r
}\r
\r
.sc-events-checklist__milestone {\r
color: var(--text-normal);\r
}\r
}\r
}\r
\r
/* 1) Host elements that should get a PRO badge */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone {\r
position: relative; /* safe default, keeps ::after anchored */\r
}\r
\r
/* 2) The PRO badge itself */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone::after {\r
content: "PRO";\r
\r
/* layout */\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
margin-left: 0.4em;\r
padding: 0.08em 0.55em;\r
border-radius: 999px;\r
white-space: nowrap;\r
vertical-align: middle;\r
\r
/* typography */\r
font-size: 0.7em;\r
font-weight: 600;\r
letter-spacing: 0.14em;\r
text-transform: uppercase;\r
line-height: 1;\r
\r
/* color system: only Obsidian variables */\r
background-color: var(--interactive-accent);\r
background-image: linear-gradient(\r
135deg,\r
var(--interactive-accent),\r
var(--interactive-accent-hover)\r
);\r
color: var(--text-on-accent, var(--background-primary));\r
border: 1px solid var(--background-modifier-border);\r
\r
/* subtle separation & depth, theme-aware */\r
box-shadow:\r
0 0 0 1px var(--background-primary),\r
0 1px 3px rgba(0, 0, 0, 0.35);\r
transform: translateY(-0.03em);\r
}\r
\r
/* 3) Interactive refinement: follow Obsidian's accent hover behavior */\r
.sc-events-checklist__label.pro-milestone > .sc-events-checklist__milestone:hover::after {\r
background-color: var(--interactive-accent-hover);\r
filter: brightness(1.05);\r
}\r
\r
/* Milestones modal: title row help icon */\r
.sc-milestones-modal__title {\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-row {\r
display: flex;\r
align-items: center;\r
gap: var(--size-4-2);\r
width: 100%;\r
}\r
\r
.sc-milestones-modal__title-text {\r
min-width: 0;\r
}\r
\r
.sc-milestones-modal__help-btn {\r
display: inline-flex;\r
align-items: center;\r
justify-content: center;\r
\r
width: 28px;\r
height: 28px;\r
padding: 0;\r
border-radius: var(--radius-s);\r
\r
background: transparent;\r
border: 1px solid transparent;\r
color: var(--text-muted);\r
\r
cursor: pointer;\r
}\r
\r
.sc-milestones-modal__help-btn svg {\r
width: 18px;\r
height: 18px;\r
}\r
\r
.sc-milestones-modal__help-btn:hover {\r
background: var(--background-modifier-hover);\r
border-color: var(--background-modifier-border);\r
color: var(--text-normal);\r
}\r
\r
.sc-milestones-modal__help-btn:active {\r
transform: translateY(1px);\r
}\r
\r
.sc-milestones-modal__help-btn:focus-visible {\r
outline: 2px solid var(--interactive-accent);\r
outline-offset: 2px;\r
background: var(--background-modifier-hover);\r
border-color: var(--interactive-accent);\r
}\r
`;var j1=require("obsidian");var S1=require("obsidian");var YP={"connections:installed":{ids:["smart-connections"]},"connections_pro:installed":{ids:["smart-connections"],require_pro_name:!0},"context:installed":{ids:["smart-context"]},"context_pro:installed":{ids:["smart-context"],require_pro_name:!0},"chat:installed":{ids:["smart-chatgpt","smart-chat"]},"chat_pro:installed":{ids:["smart-chat"],require_pro_name:!0}};function C1(n){n.events.on("event_log:first",e=>{let t=e?.first_of_event_key;if(typeof t=="string"&&t in ca){let s=document.createDocumentFragment(),i="You achieved a new Smart Milestone \u{1F389}",o=document.createElement("p");o.textContent=i,s.appendChild(o);let a=document.createElement("p");a.textContent=`\u2705 ${ca[t].milestone}`,a.style.color="var(--color-green)",a.style.fontStyle="italic",s.appendChild(a);let c=document.createElement("button");c.textContent="View milestones",c.addEventListener("click",()=>{n.open_milestones_modal()}),s.appendChild(c),new S1.Notice(s,7e3)}})}r(C1,"register_first_of_event_notifications");function wu(n,e){let t=QP(n,e);return!!(t===!0||n?.event_logs?.items?.[e])}r(wu,"check_if_event_emitted");var ca={"sources:import_completed":{group:"Environment",milestone:"Initial vault import completed (all sources discovered).",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#sources"},"embedding:completed":{group:"Environment",milestone:"Initial embedding completed, you are ready to make connections!",link:"https://smartconnections.app/smart-environment/settings/?utm_source=milestones#embedding-models"},"connections:installed":{group:"Connections",milestone:"Installed Smart Connections (core plugin).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones"},"connections:opened":{group:"Connections",milestone:"Opened the connections view.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#quick-start"},"connections:drag_result":{group:"Connections",milestone:"Dragged a Smart Connections result into a note to create a link.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#drag-link"},"connections:open_result":{group:"Connections",milestone:"Opened a Smart Connections result from the UI (list item or inline popover).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:sent_to_context":{group:"Connections",milestone:"Sent Connections results to Smart Context (turn discovery into a context pack).",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#send-to-context"},"connections:copied_list":{group:"Connections",milestone:"Copied Connections results as a list of links.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#copy-list"},"connections:hover_preview":{group:"Connections",milestone:"Previewed a connection by holding cmd/ctrl while hovering the result.",link:"https://smartconnections.app/smart-connections/list-feature/?utm_source=milestones#core-interactions"},"connections:open_random":{group:"Connections",milestone:"Opened a random connection from Smart Connections.",link:"https://smartconnections.app/smart-connections/getting-started/?utm_source=milestones#open-a-random-connection"},"connections_pro:installed":{group:"Connections Pro",milestone:"Installed Smart Connections Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#connections-pro",is_pro:!0},"lookup:hover_preview":{group:"Lookup",milestone:"Previewed a Smart Lookup result by holding cmd/ctrl while hovering.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:get_results":{group:"Lookup",milestone:"Submitted a lookup query (started a semantic search).",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones"},"lookup:drag_result":{group:"Lookup",milestone:"Dragged a Smart Lookup result into a note to create a link.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"lookup:open_result":{group:"Lookup",milestone:"Opened a Lookup result.",link:"https://smartconnections.app/smart-connections/lookup/?utm_source=milestones#understanding-results"},"context:created":{group:"Context",milestone:"First context created!",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#quick-start"},"context:copied":{group:"Context",milestone:"Copied context to clipboard.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-current"},"context_selector:open":{group:"Context",milestone:"Opened the Context Builder selector modal.",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#open-builder"},"context:named":{group:"Context",milestone:"Named a Smart Context (created a reusable saved context).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:renamed":{group:"Context",milestone:"Renamed a Smart Context (increased clarity).",link:"https://smartconnections.app/smart-context/builder/?utm_source=milestones#save-reuse"},"context:copied_with_media":{group:"Context Pro",milestone:"Copied context with media (images/PDF pages) for multimodal workflows.",link:"https://smartconnections.app/smart-context/clipboard/?utm_source=milestones#copy-modes",is_pro:!0},"context_pro:installed":{group:"Context Pro",milestone:"Installed Smart Context Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#context-pro",is_pro:!0},"chat:installed":{group:"Chat",milestone:"Installed Smart ChatGPT.",link:"https://smartconnections.app/smart-chat/?utm_source=milestones"},"chat_codeblock:saved_thread":{group:"Chat",milestone:"Started a chat in a Smart Chat codeblock (opened the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#quick-start"},"completion:completed":{group:"Chat Pro",milestone:"Received the first Smart Chat response (a completion finished).",link:"https://smartconnections.app/smart-chat/api-integration/?utm_source=milestones#quick-start",is_pro:!0},"chat_codeblock:marked_done":{group:"Chat",milestone:"Marked the chat thread as done (closed the loop).",link:"https://smartconnections.app/smart-chat/codeblock/?utm_source=milestones#chat-inbox"},"chat_pro:installed":{group:"Chat Pro",milestone:"Installed Smart Chat Pro.",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones#chat-pro",is_pro:!0},smart_plugins_oauth_completed:{group:"Pro",milestone:"Connected account (enabled Pro plugins).",link:"https://smartconnections.app/pro-plugins/?utm_source=milestones"},"inline_connections:show":{group:"Connections Pro",milestone:"Opened inline connections in-note (used the inline workflow).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:open_result":{group:"Connections Pro",milestone:"Opened an inline connections result (navigated from discovery to source).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0},"inline_connections:drag_result":{group:"Connections Pro",milestone:"Inserted an inline link from an inline connection (converted discovery into a durable link).",link:"https://smartconnections.app/smart-connections/inline/?utm_source=milestones",is_pro:!0}},ZP=["Environment","Connections","Lookup","Context","Chat","Pro","Connections Pro","Context Pro","Chat Pro"];function O1(n){let e=Object.entries(n||{}).reduce((o,[a,c])=>{let l=c?.group||"Other";return o[l]||(o[l]=[]),o[l].push({event_key:a,group:l,milestone:c?.milestone||"",...c}),o},{}),t=Object.keys(e),s=ZP.reduce((o,a,c)=>(o[a]=c,o),{});return t.sort((o,a)=>{let c=Object.prototype.hasOwnProperty.call(s,o),l=Object.prototype.hasOwnProperty.call(s,a);return c&&l?s[o]-s[a]:c?-1:l?1:o.localeCompare(a)}).map(o=>{let a=(e[o]||[]).slice();return{group:o,items:a}})}r(O1,"derive_events_checklist_groups");function QP(n,e){let t=YP[e];if(!t)return null;let s=n?.plugin?.app?.plugins?.manifests||{},i=Array.isArray(t.ids)?t.ids:[];for(let o of i){let a=s[o];if(a&&!(t.require_pro_name&&!eI(a)))return!0}return!1}r(QP,"resolve_plugin_install_event");function eI(n){let e=n?.name;return typeof e!="string"?!1:e.toLowerCase().includes("pro")}r(eI,"is_pro_manifest");function tI(n,e={}){let t=O1(ca),s=t.reduce((c,l)=>{let d=l.items.reduce((_,m)=>_+(wu(n,m.event_key)?1:0),0);return c+d},0),i=t.reduce((c,l)=>c+l.items.length,0),o=i>0?Math.round(s/i*100):0,a=t.map(c=>{let l=c.items.reduce((m,p)=>m+(wu(n,p.event_key)?1:0),0),d=c.items.length,_=c.items.map(m=>{let p=wu(n,m.event_key)===!0;return nI(m,{checked:p})}).join(`
`);return`
<section class="sc-events-checklist__group" data-group="${De(c.group)}">
<h3 class="sc-events-checklist__group-title">
<span class="sc-events-checklist__group-name">${De(c.group)}</span>
<span class="sc-events-checklist__group-count" aria-label="Group completion">${l.toString()} / ${d.toString()}</span>
</h3>
<ul class="sc-events-checklist__items">
${_}
</ul>
</section>
`}).join(`
`);return`
<div
class="sc-events-checklist"
data-component="events_checklist"
style="--sc-events-checklist-progress: ${o.toString()}%;"
>
<div class="sc-events-checklist__header">
<div class="sc-events-checklist__summary" aria-label="Checklist completion">
${s.toString()} / ${i.toString()}
</div>
<div class="sc-events-checklist__hint" aria-hidden="true">
Click a milestone to open docs
</div>
</div>

<div
class="sc-events-checklist__progress"
role="progressbar"
aria-label="Overall progress"
aria-valuenow="${s.toString()}"
aria-valuemin="0"
aria-valuemax="${i.toString()}"
title="${De(`${o.toString()}% complete`)}"
>
<div class="sc-events-checklist__progress-fill" aria-hidden="true"></div>
</div>

<div class="sc-events-checklist__body">
${a}
</div>
</div>
`}r(tI,"build_html");async function T1(n,e={}){this.apply_style_sheet(A1);let t=tI.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return sI.call(this,n,i,e),i}r(T1,"render");async function sI(n,e,t={}){return iI(e),oI(e),e}r(sI,"post_process");function nI(n,e){let t=e.checked===!0,s=t?"true":"false",i=typeof n.link=="string"?n.link:"",o=t?"Completed":"Incomplete",a=`Open docs: ${n.milestone||n.event_key||"milestone"} (${o})`;return`
<li
class="sc-events-checklist__item"
data-event-key="${De(n.event_key)}"
data-link="${De(i)}"
data-checked="${s}"
tabindex="0"
role="button"
aria-label="${De(a)}"
>
<div class="sc-events-checklist__label${n.is_pro?" pro-milestone":""}">
<span class="sc-events-checklist__icon" aria-hidden="true"></span>
<span class="sc-events-checklist__milestone">${De(n.milestone)}</span>
</div>
</li>
`}r(nI,"build_item_html");function iI(n){n&&n.getAttribute("data-links-enabled")!=="true"&&(n.setAttribute("data-links-enabled","true"),n.addEventListener("click",e=>{let t=$1(n,e);if(!t)return;let s=window.getSelection();s&&s.toString().length>0||q1(t)}),n.addEventListener("keydown",e=>{let t=e&&e.key;if(t!=="Enter"&&t!==" ")return;let s=$1(n,e);s&&(e.preventDefault(),q1(s))}))}r(iI,"attach_item_link_listeners");function q1(n){let e=cI(n);typeof e=="string"&&e.length>0&&window.open(e,"_external")}r(q1,"open_item_link");function oI(n){if(!n)return;Array.from(n.querySelectorAll(".sc-events-checklist__item")).forEach(t=>{let s=t.getAttribute("data-checked")==="true",i=t.querySelector(".sc-events-checklist__icon");i&&rI(i,s)})}r(oI,"render_item_state_icons");function rI(n,e){aI(n,e?["circle-check","check-circle","check"]:["circle","circle-dashed","dot"])}r(rI,"set_item_icon");function aI(n,e){if(!n)return;let t=Array.isArray(e)?e:[];for(let s of t)if(!(typeof s!="string"||s.length===0)){n.textContent="";try{(0,j1.setIcon)(n,s)}catch{continue}if(n.querySelector("svg"))return}}r(aI,"set_icon_with_fallback");function $1(n,e){let t=e&&e.target;if(!t||typeof t.closest!="function")return null;let s=t.closest(".sc-events-checklist__item");return!s||!n.contains(s)?null:s}r($1,"get_item_el_from_event");function cI(n){let e=n.getAttribute("data-link");if(typeof e=="string"&&e.length>0)return e;let t=n.getAttribute("data-event-key");if(typeof t!="string"||t.length===0)return"";let s=ca[t];return!s||typeof s.link!="string"?"":s.link}r(cI,"get_item_link");function lI(){return`<div>
<button class="copy-all-notifications-btn">Copy All Notifications</button>
<div class="smart-env-notifications-feed"></div>
</div>`}r(lI,"build_html");async function N1(n,e={}){let t=this.create_doc_fragment(lI()),s=t.firstElementChild;return dI.call(this,n,s,e),t}r(N1,"render");async function dI(n,e,t={}){let s=e.querySelector(".smart-env-notifications-feed");this.empty(s);let i=Array.isArray(n.event_logs.session_events)?[...n.event_logs.session_events]:[];if(!i.length){let a=s.ownerDocument.createElement("p");a.className="smart-env-notifications-empty",a.textContent="No Smart Env notifications yet.",s.appendChild(a);return}i.slice(-100).reverse().forEach(a=>{uI(s,a)});let o=e.querySelector(".copy-all-notifications-btn");o.addEventListener("click",()=>{let a=s.textContent;navigator.clipboard.writeText(a).then(()=>{o.textContent="Copied!",setTimeout(()=>{o.textContent="Copy All Notifications"},2e3)})})}r(dI,"post_process");function _I(n){let[e,t]=n.event_key.split(":");return e==="notification"?t:t==="error"?"error":"info"}r(_I,"get_level");function uI(n,e){let t=n.ownerDocument.createElement("div");t.className="smart-env-notification",t.dataset.level=_I(e),n.appendChild(t);let s=n.ownerDocument.createElement("div");s.className="smart-env-notification__meta";let i=typeof e.event.at=="number"?e.event.at:Date.now();s.textContent=`${e.event.collection_key?e.event.collection_key+" - ":""}${e.event_key} - ${mI(i)}
`,t.appendChild(s);let o=Object.entries(e.event).filter(([a,c])=>!["at","collection_key"].includes(a)).map(([a,c])=>`  ${a}: ${typeof c=="string"?c:JSON.stringify(c)}`).join(`
`);if(o.trim().length){t.style.cursor="pointer";let a=n.ownerDocument.createElement("pre");a.className="smart-env-notification__message",a.textContent=o,a.textContent+=`

`,a.style.display="none",t.appendChild(a),t.addEventListener("click",()=>{a.style.display==="none"?a.style.display="block":a.style.display="none"})}else s.textContent+=`
`}r(uI,"append_entry");function mI(n){let e=Date.now(),t=Math.floor((e-n)/1e3);if(t<60)return`${t} seconds ago`;let s=Math.floor(t/60);if(s<60)return`${s} minutes ago`;let i=Math.floor(s/60);return i<24?`${i} hours ago`:`${Math.floor(i/24)} days ago`}r(mI,"to_time_ago");var St=require("obsidian");var la=require("obsidian");function da(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(da,"get_smart_server_url");function pI(){if(typeof window?.require=="function")try{return window.require("zlib")}catch{}return null}r(pI,"try_get_zlib");function hI(n){let e=pI();if(!e)throw new Error("zlib not available (maybe Obsidian mobile?).");let t=Buffer.from(n),s=e.inflateRawSync(t);return new Uint8Array(s.buffer,s.byteOffset,s.length)}r(hI,"inflate_deflate_data");async function _a(n){let e=new DataView(n),t=0,s=e.byteLength,i=[],o=null;for(;t+4<=s;){let a=e.getUint32(t,!0);if(a===33639248||a===134695760||a!==67324752)break;t+=4;let c=e.getUint16(t,!0),l=e.getUint16(t+2,!0),d=e.getUint16(t+4,!0);t+=6;let _=e.getUint32(t,!0);t+=4;let m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0);t+=12;let y=e.getUint16(t,!0),g=e.getUint16(t+2,!0);t+=4;let v=new Uint8Array(n.slice(t,t+y)),k=new TextDecoder("utf-8").decode(v);t+=y,t+=g;let w=(l&8)!==0,q=t,E;if(!w)E=q+p;else{let O=q,A=!1;for(;O+4<=s;){let u=e.getUint32(O,!0);if(u===134695760||u===67324752||u===33639248){A=!0;break}O++}E=A?O:s}if(E>s)break;let S=new Uint8Array(n.slice(q,E));if(t=E,w&&t+4<=s)if(e.getUint32(t,!0)===134695760&&(t+=4),t+12<=s)m=e.getUint32(t,!0),p=e.getUint32(t+4,!0),f=e.getUint32(t+8,!0),t+=12;else break;let C;if(d===0)C=S;else if(d===8)C=hI(S);else continue;if(i.push({fileName:k,data:C}),k.toLowerCase().endsWith("manifest.json")&&!k.includes("/"))try{o=JSON.parse(new TextDecoder("utf-8").decode(C))}catch{}}return{files:i,pluginManifest:o}}r(_a,"parse_zip_into_files");function xu(n,e="Response"){if(!n||n.byteLength<4)throw new Error(`${e} returned too few bytes, not a valid ZIP.`);if(new DataView(n).getUint32(0,!0)!==67324752){let s=new TextDecoder().decode(new Uint8Array(n));throw new Error(`${e} did not return a valid ZIP. Text:
${s}`)}return n}r(xu,"validate_zip_buffer");async function ua(n,e,t){let s=typeof n.writeBinary=="function";await n.exists(e)||await n.mkdir(e);for(let{fileName:i,data:o}of t){let a=e+"/"+i;if(s)await n.writeBinary(a,o);else{let c=btoa(String.fromCharCode(...o));await n.write(a,c)}}}r(ua,"write_files_with_adapter");function Eu(n,e){if(!e||e==="unknown")return!1;let t=n.replace(/[^\d.]/g,""),s=e.replace(/[^\d.]/g,""),i=t.split(".").map(Number),o=s.split(".").map(Number);for(let a=0;a<Math.max(i.length,o.length);a++){let c=i[a]||0,l=o[a]||0;if(l>c)return!0;if(l<c)return!1}return!1}r(Eu,"is_server_version_newer");async function Au(n,e){let t=await(0,la.requestUrl)({url:`${da()}/plugin_download`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(t.status!==200)throw new Error(`plugin_download error ${t.status}: ${t.text}`);return xu(t.arrayBuffer,"Smart Plugins server")}r(Au,"fetch_plugin_zip");async function P1(n,e=la.requestUrl){console.log(`[smart_plugins] download plugin from URL: ${n}`);let t=await e({url:n,method:"GET",headers:{Accept:"application/zip"}});if(t.status&&t.status!==200)throw new Error(`Download error ${t.status}: ${t.text||""}`);return xu(t.arrayBuffer,"Download")}r(P1,"fetch_zip_from_url");async function I1(n,e,t=la.requestUrl){let s=await t({url:`${da()}/plugin_readme`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({repo:n})});if(s.status!==200)throw new Error(`plugin_readme error ${s.status}: ${s.text}`);return s.json.readme}r(I1,"fetch_plugin_readme");async function M1(n,e){await n.plugins.enablePlugin(e),n.plugins.enabledPlugins.add(e),n.plugins.requestSaveConfig(),n.plugins.loadManifests()}r(M1,"enable_plugin");function Su(n){return`${(n?.vault?.getName?.()||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}_smart_plugins_oauth_`}r(Su,"get_oauth_storage_prefix");async function Cu(n){let e=await(0,la.requestUrl)({url:`${da()}/plugin_list`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({})});if(e.status!==200)throw new Error(`plugin_list error ${e.status}: ${e.text}`);return e.json}r(Cu,"fetch_server_plugin_list");var L1=`.get-core-link {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
}\r
.core-installed-text {\r
text-wrap: nowrap;\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
}\r
\r
.pro-plugins-list {\r
display: flex;\r
flex-direction: column;\r
row-gap: var(--size-4-3);\r
margin-top: var(--size-5);\r
}\r
\r
.pro-plugins-list-item {\r
display: flex;\r
align-items: center;\r
padding: 0.75em 0;\r
border-top: 1px solid var(--background-modifier-border);\r
row-gap: var(--size-4-3);\r
}\r
\r
.pro-plugins-container > .setting-group {\r
.setting-item-name.pro-heading {\r
font-size: var(--h1-size);\r
}\r
&> p {\r
padding: 0 var(--size-4-4);\r
}\r
\r
}\r
\r
.smart-plugins-login .setting-item {\r
gap: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual {\r
margin-top: var(--size-4-3);\r
}\r
\r
.smart-plugins-login-manual-instructions {\r
font-size: var(--font-ui-small);\r
color: var(--text-muted);\r
margin-bottom: var(--size-2-2);\r
}\r
\r
.smart-plugins-login-manual-controls {\r
display: flex;\r
gap: var(--size-2-2);\r
align-items: center;\r
}\r
\r
.smart-plugins-login-manual-input {\r
flex: 1;\r
min-width: 240px;\r
font-size: var(--font-ui-small);\r
}\r
`;var gI='<a href="https://smartconnections.app/core-plugins/" target="_external">Core plugins</a> provide essential functionality and a "just works" experience. <a href="https://smartconnections.app/pro-plugins/" target="_external">Pro plugins</a> enable advanced configuration and features for Obsidian AI experts.',yI='All Pro plugins include advanced configurations and additional model providers. Pro users get priority support via email. <a href="https://smartconnections.app/introducing-pro-plugins/" target="_external">Learn more</a> about Pro plugins.';function bI(){return[{name:"Chat Pro",description:"Configure chat to use Local and Cloud API providers (Ollama, LM Studio, OpenAI, Gemini, Anthropic, Open Router, and more).",core_id:"smart-chatgpt",url:"https://smartconnections.app/smart-chat/"},{name:"Connections Pro",description:"More opportunities for connections. Graph view for visualizing. Inline and footer views (great for mobile!). Configurable algorithms and additional embedding model providers.",core_id:"smart-connections",url:"https://smartconnections.app/smart-connections/"},{name:"Context Pro",description:"Advanced tools for context engineering. Utilize Bases, images, and external sources (great for coders!) in your contexts.",core_id:"smart-context",url:"https://smartconnections.app/smart-context/"}]}r(bI,"derive_fallback_plugins");function vI(n,e={}){return`
<div class="pro-plugins-container setting-item-heading">
<div class="setting-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name pro-heading">Pro plugins</div>
<div class="setting-item-control">
<section class="smart-plugins-login"></section>
</div>
</div>
<p>${gI}</p>
<div class="setting-items pro-plugins-list">
</div>
<p>${yI}</p>
</div>
</div>
`}r(vI,"build_html");async function z1(n,e={}){this.apply_style_sheet(L1);let t=vI.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return await kI.call(this,n,i,e),i}r(z1,"render");async function kI(n,e,t={}){let i=(n.plugin||null)?.app||window.app,o=Su(i),a=e.querySelector(".smart-plugins-login"),c=e.querySelector(".pro-plugins-list"),l=bI(),d=0,_="",m=null,p=r(E=>{if(!a||!E)return;(!m||!m.isConnected)&&(m=document.createElement("div"),m.classList.add("smart-plugins-login-manual"),a.appendChild(m)),m.innerHTML="";let S=document.createElement("div");S.classList.add("smart-plugins-login-manual-instructions"),S.textContent="If the login page did not open, copy this link and paste it into your browser to open the login page:",m.appendChild(S);let C=document.createElement("div");C.classList.add("smart-plugins-login-manual-controls"),m.appendChild(C);let O=document.createElement("input");O.classList.add("smart-plugins-login-manual-input"),O.type="text",O.value=E,O.readOnly=!0,O.addEventListener("focus",()=>O.select()),C.appendChild(O);let A=document.createElement("button");A.classList.add("mod-cta"),A.textContent="Copy",A.addEventListener("click",async()=>{await xI(E)?new St.Notice("Copied login link to clipboard."):new St.Notice("Copy failed. Please select and copy the link manually.")}),C.appendChild(A)},"render_manual_login_link"),f=r(async()=>{let E={},{manifests:S}=i.plugins;for(;Object.keys(S).length===0;)S=i.plugins.manifests,await new Promise(C=>setTimeout(C,100));for(let C in S){if(!Object.prototype.hasOwnProperty.call(S,C))continue;let{name:O,version:A}=S[C];E[C]={name:O,version:A}}return E},"get_installed_info"),y=r(async()=>{d++,d>=2&&_&&p(_),n&&typeof n.initiate_smart_plugins_oauth=="function"&&(_=wI()),new St.Notice("Please complete the login in your browser.")},"initiate_oauth_login"),g=r(()=>{if(this.empty(a),m=null,!(localStorage.getItem(o+"token")||"")){new St.Setting(a).setName("Connect account").setDesc("Log in with the key provided in your Pro welcome email.").addButton(O=>{O.setButtonText("Login"),O.onClick(async()=>{await y()})});return}let S=new St.Setting(a);S.setDesc("Signed in to Smart Plugins Pro account."),S.addButton(C=>{C.setButtonText("Logout"),C.onClick(()=>{localStorage.removeItem(o+"token"),localStorage.removeItem(o+"refresh"),new St.Notice("Logged out of Smart Plugins"),g(),w()})})},"render_oauth_login_section"),v=r(async()=>{if(this.empty(c),!(!c||l.length===0))for(let E of l){let S=await n.smart_components.render_component("pro_plugins_list_item",E,{env:n,app:i,installed_map:{}});c.appendChild(S)}},"render_fallback_plugin_list"),k=r(()=>{let E=new St.Setting(a).setName("Subscription Expired").setDesc("Your Smart Connections Pro subscription has expired. Please update your subscription to retain access to Pro plugins.");E.addButton(S=>{S.setButtonText("Get Pro"),S.onClick(()=>{window.open("https://smartconnections.app/subscribe/","_external")})}),E.addButton(S=>{S.setButtonText("Update subscription"),S.onClick(()=>{window.open("https://smartconnections.app/subscription-update/","_external")})}),E.addButton(S=>{S.setButtonText("Refresh"),S.onClick(()=>{n.events.emit("pro_plugins:refresh")})})},"add_update_sub_to_login_section"),w=r(async()=>{this.empty(c);let E=localStorage.getItem(o+"token")||"";if(!E){await v();return}try{let S=await f(),C=await Cu(E),{list:O=[],unauthorized:A=[],sub_exp:u}=C;if(typeof u=="number"&&u<Date.now()){k(),await v();return}if(!Array.isArray(O)||O.length===0){await v();return}for(let h of O){let b=await n.smart_components.render_component("pro_plugins_list_item",h,{env:n,app:i,token:E,installed_map:S,on_installed:w});c.appendChild(b)}}catch(S){console.error("[pro-plugins:list] Failed to fetch plugin list:",S),c.textContent="Error fetching plugin list. Check console."}},"render_plugin_list_section"),q=r(async()=>{g(),await w()},"render_smart_plugins");return n.events.on("smart_plugins_oauth_completed",()=>{q()}),await q(),e}r(kI,"post_process");function wI(){console.log("initiate_smart_plugins_oauth");let n=Math.random().toString(36).slice(2),e=encodeURIComponent("obsidian://smart-plugins/callback"),t=`${da()}/oauth?client_id=smart-plugins-op&redirect_uri=${e}&state=${n}`;return window.open(t,"_external"),t}r(wI,"initiate_smart_plugins_oauth");var xI=r(async n=>{if(!n)return!1;try{if(navigator?.clipboard?.writeText)return await navigator.clipboard.writeText(n),!0}catch{}try{let e=document.createElement("textarea");e.value=n,e.setAttribute("readonly","true"),e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();let t=document.execCommand("copy");return document.body.removeChild(e),!!t}catch{}return!1},"copy_to_clipboard");var ue=require("obsidian");var EI="https://smartconnections.app/pro-plugins/";function AI(n,e={}){return'<div class="pro-plugins-list-item"></div>'}r(AI,"build_html");function SI(n){return!n||!n.repo}r(SI,"is_fallback_item");function CI(n,e){let t=n.repo,s=n.version||"unknown",i=n.manifest_id||t.replace("/","_"),o=e?.version||null,a=e?.name||n.name||t,c=`Server version: ${s}`,l="Install",d=!1;return o&&(c+=` | Installed version: ${o}`,Eu(o,s)?l="Update":(l="Installed",d=!0)),n.description&&(c+=`
${n.description}`),{plugin_id:i,display_name:a,desc:c,button_label:l,is_disabled:d,server_version:s,local_version:o}}r(CI,"compute_display_state");async function D1(n,e={}){let t=AI(n,e),i=this.create_doc_fragment(t).firstElementChild;return await OI.call(this,n,i,e),i}r(D1,"render");async function OI(n,e,t={}){let{app:s,token:i,installed_map:o={},on_installed:a}=t;if(SI(n)){let m=new ue.Setting(e).setName(n.name||"Pro plugin").setDesc(n.description||"Login to unlock Pro plugins.");if(n.core_id)if(s.plugins.manifests[n.core_id]){let p=document.createElement("i");p.classList.add("core-installed-text"),p.textContent="Core installed!",m.controlEl.appendChild(p)}else{let p=document.createElement("a");p.setAttribute("href",`obsidian://show-plugin?id=${n.core_id}`),p.setAttribute("target","_external"),p.textContent="Install Core",p.style.marginLeft="10px",p.classList.add("get-core-link"),m.controlEl.appendChild(p)}return m.addButton(p=>{p.setButtonText("Get Pro"),p.onClick(()=>{window.open(EI,"_external")})}),m.addButton(p=>{p.setButtonText("Learn more"),p.onClick(()=>{window.open(n.url,"_external")})}),e}let c=n.manifest_id||n.repo.replace("/","_"),l=o[c]||null,d=CI(n,l),_=new ue.Setting(e).setName(d.display_name).setDesc(d.desc);return _.addButton(m=>{m.setButtonText(d.button_label),m.setDisabled(d.is_disabled),m.onClick(()=>$I(n,{app:s,token:i,on_installed:a}))}),_.addButton(m=>{m.setButtonText("Docs"),n.docs_url?m.onClick(()=>window.open(n.docs_url,"_external")):m.onClick(()=>jI(n,{app:s,token:i,display_name:d.display_name}))}),e}r(OI,"post_process");var qI=r(async(n,e)=>{let t=typeof n.resolve_download_url=="function"?await n.resolve_download_url():n.download_url;if(t)return P1(t);if(!e)throw new Error("Login required to install this plugin.");return Au(n.repo,e)},"download_plugin_zip"),$I=r(async(n,e={})=>{let{app:t,token:s,on_installed:i}=e;try{new ue.Notice(`Installing "${n.repo}" ...`);let o=await qI(n,s),{files:a,pluginManifest:c}=await _a(o),l=n.plugin_id,d=`${t.vault.configDir}/plugins/${l}`;await ua(t.vault.adapter,d,a),await t.plugins.loadManifests();let _=c?.id||n.manifest_id||l;t.plugins.enabledPlugins.has(_)&&await t.plugins.disablePlugin(_),await M1(t,_),new ue.Notice(`${n.repo} installed successfully.`),typeof i=="function"&&await i()}catch(o){console.error("[pro-plugins:list_item] Install error:",o),new ue.Notice(`Install failed: ${o.message}`)}},"install_plugin"),jI=r(async(n,e={})=>{let{app:t,token:s,display_name:i}=e;try{let o=await I1(n.repo,s),a=new ue.Modal(t);a.setTitle(i||n.name||n.repo),await ue.MarkdownRenderer.render(t,o,a.contentEl,"",new ue.Component),a.open()}catch(o){console.error("[pro-plugins:list_item] Failed to load README:",o),new ue.Notice("Failed to load README")}},"show_plugin_readme");var R1=require("obsidian");var Vs=class extends R1.Modal{static{r(this,"SmartModelModal")}constructor(e,t={}){let s=e.env.plugin.app||window.app;super(s),this.model=e,this.collection=this.model.collection,this.env=this.model.env,this.params=t}onOpen(){this.titleEl.setText("Edit model"),this.contentEl.addClass("smart-model-modal"),this.render_form()}onClose(){this.contentEl.empty(),typeof this.params.on_close=="function"&&this.params.on_close()}async render_form(){let e=this.contentEl;e.empty();let t=this.model,s=await this.env.smart_components.render_component("settings_model_actions",t,{on_before_new:r(async()=>{this.close()},"on_before_new"),on_after_delete:r(async()=>{this.close()},"on_after_delete")});e.appendChild(s);let i=t.settings_config,o=await this.env.smart_view.render_settings(i,{scope:t});e.appendChild(o);let a=e.createEl("button",{text:"Test model"}),c=e.createDiv({cls:"model-test-container"});a.addEventListener("click",async()=>{await this.run_test(c,t)}),this.params.test_on_open&&await this.run_test(c,t)}async run_test(e,t){e.empty();let s=e.createEl("pre",{cls:"model-test-result",text:"Testing..."});e.appendChild(s);let i=await t.test_model();s.textContent=JSON.stringify(i,null,2)}};var F1=`.model-settings .model-info {\r
border-radius: var(--radius-m);\r
padding: 1rem;\r
margin-bottom: 1rem;\r
background-color: var(--background-secondary);\r
pre {\r
margin: 0;\r
font-size: 0.9rem;\r
}\r
.test-result-icon {\r
vertical-align: middle;\r
margin-left: 0.5rem;\r
}\r
.test-result-icon[data-icon="square-check-big"]{\r
color: var(--color-green);\r
}\r
.test-result-icon[data-icon="circle-x"]{\r
color: var(--color-red);\r
}\r
}\r
\r
.smart-model-modal{\r
pre, .model-note {\r
user-select: text;\r
}\r
}`;var B1=require("obsidian");function NI(n,e){let t=[`Provider: ${n.data.provider_key}`,`Model: ${n.data.model_key||"**MISSING - EDIT & SELECT MODEL**"}`];return`<div class="model-info">
<div class="smart-env-settings-header">
<b>Current: ${n.display_name} <span class="test-result-icon" data-icon="${W1(n)}"></span></b>
<div>
<button class="edit-model">Edit</button>
<button class="test-model">Test</button>
</div>
</div>
<pre>${t.join(`
`)}</pre>
</div>`}r(NI,"build_html");async function U1(n,e){this.apply_style_sheet(F1);let s=this.create_doc_fragment(NI.call(this,n,e)).firstElementChild;return PI.call(this,n,s,e),s}r(U1,"render");async function PI(n,e,t){let s=e.querySelector(".edit-model"),i=e.querySelector(".test-model"),o=e.querySelector(".test-result-icon");return(0,B1.setIcon)(o,W1(n)),s.addEventListener("click",()=>{new Vs(n).open()}),i.addEventListener("click",()=>{new Vs(n,{test_on_open:!0}).open()}),e}r(PI,"post_process");function W1(n){switch(n.data.test_passed){case!0:return"square-check-big";case!1:return"circle-x";default:return"square"}}r(W1,"get_test_result_icon_name");var H1=require("obsidian");var G1={chat_completion_models:[{label:"Open Router (cloud)",value:"open_router"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"google",disabled:!0},{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0},{label:"PRO: xAI Grok (cloud)",value:"xai",disabled:!0},{label:"PRO: Anthropic Claude (cloud)",value:"anthropic",disabled:!0},{label:"PRO: Deepseek (cloud)",value:"deepseek",disabled:!0},{label:"PRO: Azure OpenAI (cloud)",value:"azure",disabled:!0}],embedding_models:[{label:"Transformers (easy, local, built-in)",value:"transformers"},{label:"PRO: LM Studio (local, requires LM Studio app)",value:"lm_studio",disabled:!0},{label:"PRO: Ollama (local, requires Ollama app)",value:"ollama",disabled:!0},{label:"PRO: OpenAI (cloud)",value:"openai",disabled:!0},{label:"PRO: Google Gemini (cloud)",value:"gemini",disabled:!0},{label:"PRO: Open Router (cloud)",value:"open_router",disabled:!0}],ranking_models:[{label:"PRO: Cohere (cloud)",value:"cohere",disabled:!0}]};function Ou(n,e,t={}){let s=(G1[n.collection_key]||[]).map(i=>({...i,disabled:!n.env_config.providers[i.value]}));if(s.length===0)e.target.tagName.toLowerCase()==="button"&&(e.target.disabled=!0,e.title="No providers available to create new models.");else{let i=new H1.Menu;s.forEach(o=>{i.addItem(a=>{a.setTitle(o.label),o.disabled&&a.setDisabled(!0),a.onClick(async()=>{typeof t.on_before_new=="function"&&await t.on_before_new();let c=n.new_model({provider_key:o.value}),l=r(async()=>{},"on_new_close");new Vs(c,{on_close:l}).open()})})}),i.showAtMouseEvent(e)}}r(Ou,"show_new_model_menu");function II(n,e){return`<div class="model-settings" data-model-type="${n.collection_key}">
<div class="global-settings"></div>
</div>`}r(II,"build_html");async function J1(n,e){let s=this.create_doc_fragment(II.call(this,n,e)).firstElementChild;return MI.call(this,n,s,e),s}r(J1,"render");async function MI(n,e,t){let s=[],i=r(async o=>{this.empty(e);let[a]=si(n.env_config.settings_config,n,e,{default_group_name:`${n.model_type} models`,heading_btn:{btn_text:"+ New",callback:r((c,l)=>{Ou(n,c)},"callback")}});n.env.smart_components.render_component("settings_env_model",o,{}).then(c=>{a.listEl.appendChild(c)})},"render_current_model_info");i(n.default),s.push(n.on_event("settings:changed",async o=>{let a=`${n.collection_key}.default_model_key`;o.path_string===a&&await i(n.default)})),s.push(n.on_event("model:changed",async()=>{await i(n.default)})),this.attach_disposer(e,s)}r(MI,"post_process");function LI(n,e){return`<div class="env-model-types">
${[n.embedding_models,n.chat_completion_models,n.ranking_models].filter(Boolean).map(i=>`<div data-collection-key="${i.collection_key}"></div>`).join(`
`)}
</div>`}r(LI,"build_html");async function K1(n,e){let s=this.create_doc_fragment(LI(n,e)).firstElementChild;return zI.call(this,n,s,e),s}r(K1,"render");async function zI(n,e,t){let s=e.querySelectorAll("div[data-collection-key]");for(let i of s){let o=i.getAttribute("data-collection-key"),a=n[o];n.smart_components.render_component("settings_env_model_type",a).then(c=>{this.empty(i),i.appendChild(c)})}return e}r(zI,"post_process");function DI(n,e={}){return`<div class="smart-model-modal-actions">
<button class="new-model-btn">New</button>
<button class="delete-model-btn">Delete</button>
<div class="confirm-delete-container" style="display:none;">
<span>Are you sure?</span>
<button class="confirm-delete-yes-btn">Yes</button>
<button class="confirm-delete-no-btn">No</button>
</div>
</div>`}r(DI,"build_html");async function V1(n,e={}){let s=this.create_doc_fragment(DI(n,e)).firstElementChild;return RI.call(this,n,s,e),s}r(V1,"render");async function RI(n,e,t={}){e.querySelector(".new-model-btn").addEventListener("click",async l=>{let d=t.on_before_new,_={};typeof d=="function"&&(_.on_before_new=d),Ou(n.collection,l,_)});let i=e.querySelector(".delete-model-btn"),o=e.querySelector(".confirm-delete-container"),a=e.querySelector(".confirm-delete-yes-btn"),c=e.querySelector(".confirm-delete-no-btn");return i.addEventListener("click",async()=>{o.style.display=""}),c.addEventListener("click",async()=>{o.style.display="none"}),a.addEventListener("click",async()=>{await n.delete_model(),typeof t.on_after_delete=="function"&&t.on_after_delete()}),e}r(RI,"post_process");async function FI(n,e={}){let t=`<div class="settings-group">
<div class="setting-item setting-item-heading">
<div class="setting-item-name">Muted notices</div>
</div>
<div class="setting-items">
`;if(Object.keys(n.notices.settings?.muted||{}).length)for(let s in n.notices.settings?.muted)t+=`<div class="muted-notice setting-item" data-notice="${s}" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
<div class="setting-item-info">
<div class="setting-item-name">
${s}
</div>
</div>
<div class="setting-item-control">
<button class="unmute-button">Unmute</button>
</div>
</div>`;else t+='<div class="setting-item"><div class="setting-item-info"><div class="setting-item-name">No muted notices.</div></div></div>';return t+="</div>",t}r(FI,"build_html");async function X1(n,e={}){let t=await FI.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return BI.call(this,n,i,e),i}r(X1,"render");async function BI(n,e,t={}){e.querySelectorAll(".unmute-button").forEach(i=>{i.addEventListener("click",()=>{let o=i.closest(".muted-notice"),a=o.dataset.notice;n.notices.settings.muted[a]=!1,delete n.notices.settings.muted[a],o.remove()})})}r(BI,"post_process");var Y1=`.sc-env-settings-container {
margin: 1rem 0;
}

.smart-env-settings-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.toggle-env-settings-btn {
cursor: pointer;
}


.setting-group .setting-items .setting-item.env-setting-highlight {
border: 1px solid var(--interactive-accent);
background-color: var(--interactive-hover);
padding: 0.5rem;
margin: 0.5rem 0;
}

.settings-group {
.setting-item {
border-top: none;
}
}

.sc-inline-confirm-row {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 0.5rem;
}
`;async function WI(n,e={}){return`<div class="smart-env-settings-container">
<div class="sources-container">
<h1>Sources</h1>
</div>
<div class="models-container">
<h1>Models</h1>
</div>
<div class="notifications-container">
<h1>Notifications</h1>
</div>
</div>`}r(WI,"build_html");async function Z1(n,e={}){this.apply_style_sheet(Y1);let t=await WI.call(this,n,e),i=this.create_doc_fragment(t).firstElementChild;return GI.call(this,n,i,e),i}r(Z1,"render");async function GI(n,e,t={}){let s=e.querySelector(".models-container"),i=e.querySelector(".sources-container"),o=e.querySelector(".notifications-container");return Wf.call(this,"settings_env_sources",n,i),Wf.call(this,"settings_env_models",n,s),Wf.call(this,"settings_notifications",n,o),e}r(GI,"post_process");function Wf(n,e,t){if(e.config.components[n]){let s=this.create_doc_fragment(`<div data-component="${n}"></div>`).firstElementChild;t.appendChild(s),e.smart_components.render_component(n,e).then(i=>{this.empty(s),s.appendChild(i)})}}r(Wf,"render_if_available");var Q1=require("obsidian");function HI(){return`
<div class="sc-context-actions">
<div class="sc-context-actions-left">
</div>
<div class="sc-context-actions-right">
</div>
</div>
`}r(HI,"build_html");async function eA(n,e={}){let t=HI(),i=this.create_doc_fragment(t).firstElementChild;return JI.call(this,n,i,e),i}r(eA,"render");async function JI(n,e,t={}){let s=r(()=>{let o=e.querySelector(".sc-context-actions-left");this.empty(o);let a=e.querySelector(".sc-context-actions-right");this.empty(a),KI(n,a),VI(n,a),XI(n,a),YI(n,a)},"render_ctx_actions");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(JI,"post_process");function KI(n,e){let t=document.createElement("button");t.type="button",t.className="sc-add-context-btn",t.textContent="Add context",e.appendChild(t),t.addEventListener("click",()=>{n.emit_event("context_selector:open")})}r(KI,"render_btn_open_selector");function VI(n,e){let t=document.createElement("button");t.type="button",t.className="sc-copy-clipboard",t.textContent="Copy to clipboard",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",async()=>{n.actions.context_copy_to_clipboard()})}r(VI,"render_btn_copy_context");function XI(n,e){let t=document.createElement("button");t.type="button",t.className="sc-clear-context-btn",t.textContent="Clear",n.has_context_items||(t.style.display="none"),e.appendChild(t),t.addEventListener("click",()=>{n.clear_all(),n.emit_event("context:cleared")})}r(XI,"render_btn_clear_context");function YI(n,e){let t=document.createElement("button");t.type="button",t.className="sc-help-btn",t.setAttribute("aria-label","Learn more"),e.appendChild(t),(0,Q1.setIcon)(t,"help-circle"),t.addEventListener("click",()=>{window.open("https://smartconnections.app/smart-context/builder/?utm_source=context-selector-modal","_external"),n.emit_event("context_selector:help")})}r(YI,"render_btn_help");var tA=`/* Modal view adjustments */\r
.modal-container .sc-context-view {\r
max-height: 60%;\r
display: flex;\r
flex-direction: column;\r
.sc-context-view-body {\r
overflow: auto;\r
}\r
.sc-add-context-btn {\r
display: none;\r
}\r
.sc-context-view-header {\r
padding: var(--size-4-2);\r
}\r
.sc-context-actions {\r
display: flex;\r
justify-content: space-between;\r
}\r
.sc-context-actions-right {\r
display: flex;\r
gap: var(--size-4-2);\r
}\r
\r
.sc-context-view-body {\r
padding: var(--size-4-2);\r
}\r
\r
.sc-context-view-footer {\r
padding: var(--size-4-2);\r
}\r
\r
}\r
\r
/* make hover popover work in builder modal */\r
.hover-popover {\r
z-index: 100;\r
}\r
`;var ma=require("obsidian");async function qu(n){try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(n);else if(ma.Platform.isMobile)new ma.Notice("Unable to copy text: no valid method found.");else{let{clipboard:e}=require("electron");e.writeText(n)}}catch(e){console.error("Failed to copy text:",e),new ma.Notice("Failed to copy.")}}r(qu,"copy_to_clipboard");function QI(n,e={}){return`<div>
<div class="sc-context-view" data-context-key="${n.data.key}">
<div class="sc-context-view-header">
<div class="sc-context-actions"></div>
</div>
<div class="sc-context-view-body">
<div class="sc-context-tree"></div>
</div>
<div class="sc-context-view-footer">
<div class="sc-context-meta"></div>
</div>
</div>
</div>`}r(QI,"build_html");async function sA(n,e={}){let t=QI(n,e);this.apply_style_sheet(tA);let i=this.create_doc_fragment(t).querySelector(".sc-context-view");return e4.call(this,n,i,e),i}r(sA,"render");async function e4(n,e,t={}){let s=[],i=r(async()=>{let l=e.querySelector(".sc-context-view-header");n.env.smart_components.render_component("smart_context_actions",n,t).then(m=>{this.empty(l),l.appendChild(m)});let d=e.querySelector(".sc-context-view-body");n.env.smart_components.render_component("smart_context_tree",n,t).then(m=>{this.empty(d),d.appendChild(m)});let _=e.querySelector(".sc-context-view-footer");n.env.smart_components.render_component("smart_context_meta",n,t).then(m=>{this.empty(_),_.appendChild(m)})},"render_children"),o=n.env.plugin,a=o?.app||window.app;return(o?.registerDomEvent?.bind(o)||((l,d,_)=>l.addEventListener(d,_)))(e,"contextmenu",l=>{if(l.preventDefault(),l.stopPropagation(),!a)return;let d=new Menu(a);d.addItem(_=>_.setTitle("Copy link tree").setIcon("copy").onClick(async()=>{let m=t4(e);await qu(m)})),d.showAtMouseEvent(l)}),await i(),s.push(n.on_event("context:updated",i)),this.attach_disposer(e,s),e}r(e4,"post_process");function t4(n){let e=[],t=r((s,i)=>{let o=s.dataset.path;if(!o)return;let a=o.replace(/^external:/,"").replace(/^selection:/,""),c=s.querySelector(":scope > .sc-tree-label")?.textContent?.trim()||"";if(s.classList.contains("file")){let l=a.split("/").pop().replace(/\.md$/,"");e.push(`${"	".repeat(i)}- [[${l}]]`)}else s.classList.contains("dir")&&e.push(`${"	".repeat(i)}- ${c}`);s.querySelectorAll(":scope > ul > li").forEach(l=>t(l,i+1))},"walk");return n.querySelectorAll(":scope > ul > li").forEach(s=>t(s,0)),e.join(`
`)}r(t4,"tree_dom_to_wikilinks");function s4(n){return Math.ceil((n||0)/4)}r(s4,"estimate_tokens");function n4(){return`
<div class="sc-context-meta" aria-live="polite"></div>
`}r(n4,"build_html");async function nA(n,e={}){let t=n4(),i=this.create_doc_fragment(t).firstElementChild;return i4.call(this,n,i,e),i}r(nA,"render");async function i4(n,e,t={}){let s=r(()=>{if(n?.has_context_items){let o=n.size||0,a=s4(o);e.textContent=`\u2248 ${o.toLocaleString()} chars \xB7 ${a.toLocaleString()} tokens`}else e.textContent="No context items selected"},"render_meta");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(i4,"post_process");function iA(n,e,t=""){let{key:s,path:i,name:o,is_file:a}=n,c=t.trim()!=="",l="",d="",_="";s||(s=i),(e.has(s)||c)&&(l=`<span class="sc-tree-remove" data-path="${s}">\xD7</span>`),e.has(s)&&!s.startsWith("external:../")&&(d=`<span class="sc-tree-connections" data-path="${s}" title="Connections for ${o}"></span>`,_=`<span class="sc-tree-links" data-path="${s}" title="Links for ${o}"></span>`);let m=["sc-tree-label"];return n.exists===!1&&m.push("missing"),`<li data-path="${s}" class="sc-tree-item ${a?"file":"dir"}${s.startsWith("external:")?" sc-external":""}">
${a?l:""}
<span class="${m.join(" ")}">${o}</span>
${d}
${_}
${t}
</li>`}r(iA,"build_tree_item");function oA(n){let e=o4(n),t=new Set(n.map(i=>i.key||i.path));return rA(e,t)}r(oA,"build_tree_html");function o4(n=[]){let e=r(o=>{let a=/#\{\d+\}$/u,c=o,l=null,d=null,_=!1,m=c.match(a);m&&(l=m[0],c=c.slice(0,-l.length),_=!0);let p=c.indexOf("##");p!==-1&&(d=c.slice(p),c=c.slice(0,p),_=!0);let f=[];if(c){let y="",g=!1;for(let v=0;v<c.length;v++)!g&&c.slice(v,v+2)==="[["?(g=!0,y+="[[",v++):g&&c.slice(v,v+2)==="]]"?(g=!1,y+="]]",v++):!g&&c[v]==="/"?(f.push(y),y=""):y+=c[v];y&&f.push(y)}return d&&f.push(d),l&&f.push(l),{segments:f,has_block:_}},"split_path_segments"),t={name:"",children:{},selected:!1},s=r((o,a)=>a.some(c=>o.startsWith(`${c}/`)),"is_redundant"),i=n.filter(o=>!(o.key.includes("#")?o.key.split("#")[0]:o.key).match(/\.[a-zA-Z0-9]+$/u)).map(o=>o.key);for(let{key:o,exists:a}of n){if(s(o,i.filter(m=>m!==o)))continue;let{segments:c,has_block:l}=e(o),d=t,_="";c.forEach((m,p)=>{if(_=_?`${_}/${m}`:m,m.startsWith("external:.."))return;let f=p===c.length-1,y=f&&l;d.children[m]||(d.children[m]={name:m,path:y?o:_,children:y?[]:{},selected:!1,is_file:y||f&&m.includes(".")}),d=d.children[m],f&&(d.selected=!0,d.exists=a)})}return t}r(o4,"build_path_tree");function rA(n,e){return!n.children||!Object.keys(n.children).length?"":`<ul>${Object.values(n.children).sort((s,i)=>s.is_file!==i.is_file?s.is_file?1:-1:s.name.localeCompare(i.name)).map(s=>iA(s,e,rA(s,e))).join("")}</ul>`}r(rA,"tree_to_html");var aA=`.sc-context-tree {\r
ul {\r
padding-inline-start: 1.7rem;\r
}\r
li:has(> .sc-context-item-leaf > .sc-context-item-remove) {\r
list-style-type: none;\r
}\r
.sc-context-item-remove:hover {\r
font-weight: bold;\r
filter: brightness(1.8);\r
}\r
.sc-context-item-remove {\r
padding: 0 0.2rem;\r
margin-left: -1.4rem;\r
}\r
}\r
.sc-context-item-leaf {\r
cursor: pointer;\r
}\r
.sc-context-item-score,\r
.sc-context-item-size {\r
display: inline-block;\r
min-width: 4.5ch;\r
height: 1.7em;\r
line-height: 1.7em;\r
text-align: center;\r
font-weight: 600 !important;\r
font-size: 0.8em !important;\r
color: var(--nav-item-color) !important;\r
background: var(--background-modifier-hover);\r
border-radius: 6px;\r
padding: 0 0.4em;\r
margin-right: 0.35em;\r
}\r
.sc-context-item-size {\r
min-width: 0;\r
}`;function a4(n,e={}){return`
<div class="sc-context-tree" data-context-key="${n.data.key}"></div>
`}r(a4,"build_html");async function cA(n,e={}){this.apply_style_sheet(aA);let t=a4(n,e),i=this.create_doc_fragment(t).firstElementChild;return c4.call(this,n,i,e),i}r(cA,"render");async function c4(n,e,t={}){let s=r(()=>{let o=n.env,a=n.context_items.filter(t.filter),c=oA(a),l=this.create_doc_fragment(c);this.empty(e),e.appendChild(l);for(let d=0;d<a.length;d++){let _=a[d],m=e.querySelector(`.sc-tree-item[data-path="${_.key}"]`);if(!m){console.warn(`Smart Context: Could not find tree item for path: ${_.key}`);continue}o.smart_components.render_component("context_item_leaf",_).then(p=>{this.empty(m),m.appendChild(p)})}},"render_tree_leaves");s();let i=[];return i.push(n.on_event("context:updated",s)),this.attach_disposer(e,i),e}r(c4,"post_process");var lA=`.source-inspector {\r
background-color: var(--background-secondary-alt);\r
margin: var(--size-4-3) 0;\r
padding: var(--size-4-3);\r
border-radius: var(--radius-m);\r
}\r
\r
.source-inspector-blocks-container {\r
margin-top: var(--size-4-2);\r
display: flex;\r
flex-direction: column;\r
gap: var(--size-4-3);\r
}\r
\r
.source-inspector-blocks-container blockquote {\r
margin-left: var(--size-4-3);\r
padding-left: var(--size-4-3);\r
border-left: 2px solid var(--text-faint);\r
}\r
`;function d4(n,e={}){return`<div>
<div class="source-inspector-source-info">
<button class="source-inspector-show-data-btn" type="button">Show source data</button>
<div class="source-inspector-source-data" style="display:none; margin: 0.5em 0;">
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;"></pre>
</div>
</div>
<div class="smart-chat-message source-inspector">
<h2>Blocks</h2>
<div class="source-inspector-blocks-container"></div>
</div>
</div>`}r(d4,"build_html");async function dA(n,e={}){let t=d4(n,e),s=this.create_doc_fragment(t);return this.apply_style_sheet(lA),await _4.call(this,n,s,e),s}r(dA,"render");async function _4(n,e,t={}){let s=e.querySelector(".source-inspector .source-inspector-blocks-container");if(!s)return e;let i=e.querySelector(".source-inspector-source-info"),o=e.querySelector(".source-inspector-show-data-btn"),a=e.querySelector(".source-inspector-source-data"),c=a?.querySelector("pre");o&&a&&c&&o.addEventListener("click",()=>{a.style.display==="none"?(c.textContent=JSON.stringify(n.data,null,2),a.style.display="",o.textContent="Hide source data"):(a.style.display="none",o.textContent="Show source data")});let l=n.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',d=n.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',_=this.create_doc_fragment(`<p>${l} | ${d}</p>`);if(i.appendChild(_),!n||!n.blocks||n.blocks.length===0)return this.safe_inner_html(s,"<p>No blocks</p>"),e;let m=n.blocks.sort((p,f)=>p.line_start-f.line_start);for(let p of m){let y=`${p.sub_key.split("#").join(" > ")} (${p.size} chars; lines: ${p.line_start}-${p.line_end})`,g=p.should_embed?'<span style="color: green;">should embed</span>':'<span style="color: orange;">embedding skipped</span>',v=p.vec?'<span style="color: green;">vectorized</span>':'<span style="color: orange;">not vectorized</span>',k="",w="";try{let E=await p.read();k=E.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;"),w=(await p.get_embed_input(E)).replace(/</g,"&lt;").replace(/>/g,"&gt;")}catch(E){console.error("[source_inspector] Error reading block:",E),k='<em style="color:red;">Error reading block content</em>'}let q=this.create_doc_fragment(`
<p>
${y}<br>
${g} | ${v}
</p>
<details class="source-inspector-embed-input">
<summary>Embed input</summary>
<pre style="max-height:300px; overflow:auto; background:#222; color:#fff; padding:0.5em; border-radius:4px;">${w}</pre>
</details>
<blockquote>${k}</blockquote>
<hr>
`);s.appendChild(q)}return e}r(_4,"post_process");var hA=require("obsidian");var ki=require("obsidian");var _A=require("obsidian");var $u=class extends _A.Modal{static{r(this,"SmartNoteInspectModal")}constructor(e,t){super(e.app),this.smart_connections_plugin=e,this.entity=t}get env(){return this.smart_connections_plugin.env}onOpen(){this.titleEl.innerText=this.entity.key,this.render()}async render(){this.contentEl.empty();let e=await this.env.render_component("source_inspector",this.entity);this.contentEl.appendChild(e)}};var uA=require("obsidian");var ju=class extends uA.Modal{static{r(this,"EnvStatsModal")}constructor(e,t){super(e),this.env=t}onOpen(){this.titleEl.setText("Smart Environment"),this.contentEl.empty(),this.contentEl.createEl("p",{text:"Loading stats..."}),setTimeout(this.render.bind(this),100)}async render(){let e=await this.env.render_component("env_stats",this.env);this.contentEl.empty(),e?this.contentEl.appendChild(e):this.contentEl.createEl("p",{text:"Failed to load stats."})}};function mA(n,e,t={}){let{Menu:s=ki.Menu}=t,i=n.main,o=r(a=>{a.preventDefault(),a.stopPropagation();let c=new s(i.app);c.addItem(l=>l.setTitle("Inspect active note").setIcon("search").onClick(async()=>{let d=i.app.workspace.getActiveFile();if(!d){new ki.Notice("No active note found");return}let _=n.smart_sources?.get(d.path);if(!_){new ki.Notice("Active note is not indexed by Smart Environment");return}new $u(i,_).open()})),c.addItem(l=>l.setTitle("Show stats").setIcon("chart-pie").onClick(()=>{new ju(i.app,n).open()})),c.addItem(l=>l.setTitle("Export data").setIcon("download").onClick(()=>{n.export_json(),new ki.Notice("Smart Env exported")})),c.addItem(l=>l.setTitle("Milestones").setIcon("flag").onClick(()=>{n.open_milestones_modal()})),c.addItem(l=>l.setTitle("Notifications").setIcon("bell").onClick(()=>{n.open_notifications_feed_modal()})),c.addSeparator(),c.addItem(l=>l.setTitle("Learn about Community Supporters").setIcon("hand-heart").onClick(()=>{window.open("https://smartconnections.app/community-supporters/?utm_source=status-bar","_external")})),c.showAtPosition({x:a.pageX,y:a.pageY})},"on_context_menu");return i.registerDomEvent(e,"contextmenu",o),o}r(mA,"register_status_bar_context_menu");var pA=`.status-bar-item:has(.smart-env-status-container) {
padding: 0 0.5em;

&:hover {
background-color: var(--background-modifier-hover);
}
&> .smart-env-status-container {
display: flex;
align-items: center;
gap: 0.5em;
text-decoration: none;
color: var(--status-bar-text-color);
}
}

.smart-env-status-indicator {
width: 0.6em;
height: 0.6em;
border-radius: 999px;
background-color: var(--interactive-accent);
opacity: 0;
transform: scale(0.3);
transition: opacity 150ms ease, transform 150ms ease;
}
.smart-env-status-indicator[data-level='info'] {
background-color: var(--interactive-accent);
}
.smart-env-status-indicator[data-level='attention'] {
background-color: var(--color-yellow);
}
.smart-env-status-indicator[data-level='warning'] {
background-color: var(--color-orange);
}
.smart-env-status-indicator[data-level='error'] {
background-color: var(--color-red);
}

.smart-env-status-indicator[data-count] {
opacity: 1;
transform: scale(1);
}

.smart-env-notifications-feed {
display: flex;
flex-direction: column;
padding: 0.5rem 0;
gap: 0.42rem;
}

.smart-env-notifications-empty {
margin: 0;
color: var(--text-muted);
}

.smart-env-notification {
font-size: var(--font-smaller);
display: flex;
flex-direction: column;
border-left: 3px solid var(--interactive-accent);
padding-left: 0.75rem;
}

.smart-env-notification[data-level='attention'] {
border-color: var(--color-yellow);
}

.smart-env-notification[data-level='warning'] {
border-color: var(--color-orange);
}

.smart-env-notification[data-level='error'] {
border-color: var(--color-red);
}

.smart-env-notification__message {
margin: 0;
font-weight: 500;
white-space: pre-wrap;
}

.smart-env-notification__meta {
color: var(--text-muted);
padding: 0.37rem 0;
}

.status-bar-mobile {
position: var(--status-bar-position);
bottom: 0;
border-radius: 0 8px 0 0;
border-style: solid;
border-width: 1px;
border-color: var(--status-bar-border-color);
background-color: var(--status-bar-background);
color: var(--status-bar-text-color);
font-size: var(--status-bar-font-size);
min-height: 18px;
padding: var(--size-4-1);
user-select: none;
z-index: var(--layer-status-bar);
font-variant-numeric: tabular-nums;
&> .smart-env-status-container {
padding: 5px 5px 5px 0;
}
}

/* footer view on mobile */
.embedded-backlinks > .status-bar-mobile {
position: relative;
border-style: none;
}`;function m4(){return`
<a
class="smart-env-status-container"
role="button"
title="Smart Environment status"
aria-label="Smart Environment status"
tabindex="0"
>
<span class="smart-env-status-icon" aria-hidden="true"></span>
<span class="smart-env-status-msg" aria-live="polite"></span>
<span
class="smart-env-status-indicator"
title="Open notifications"
aria-label="Open notifications feed"
role="button"
tabindex="0"
></span>
</a>
`}r(m4,"build_html");async function fA(n,e={}){this.apply_style_sheet(pA);let s=this.create_doc_fragment(m4()).firstElementChild;return p4.call(this,n,s,e),s}r(fA,"render");function p4(n,e,t={}){let s=e?.querySelector?.(".smart-env-status-icon"),i=e?.querySelector?.(".smart-env-status-indicator"),o=e?.querySelector?.(".smart-env-status-msg"),a=n.is_pro?"Pro":n.constructor?.version,c=r(()=>n.event_logs?.session_events?.length||0,"get_session_event_count"),l=r(()=>Object.keys(n.smart_sources.sources_re_import_queue||{}).length,"get_embed_queue"),d=r(()=>{let f=l(),y=`Smart Env${a?" "+a:""}`,g="Smart Environment status",v=c(),k=n.event_logs?.notification_status||"info";f>0&&(y=`Embed now (${f})`,g="Click to re-import.",k="attention"),s&&(0,hA.setIcon)(s,"smart-connections"),i&&(i._click_handler||(i._click_handler=w=>{w.stopPropagation(),n.open_notifications_feed_modal?.()},i.addEventListener("click",i._click_handler)),v>0?i.dataset.count=String(v):delete i.dataset.count,k?i.dataset.level=String(k):delete i.dataset.level),o.setText?.(y),e.setAttribute?.("title",g),e.removeAttribute?.("href"),e.removeAttribute?.("target"),e._click_handler||(e._click_handler=w=>{if(l()>0)w.preventDefault(),w.stopPropagation(),o?.setText?.("Embedding..."),n.run_re_import?.();else{let E=new MouseEvent("contextmenu",w);e.dispatchEvent?.(E)}},e.addEventListener("click",e._click_handler))},"render_status_elm");mA(n,e),d();let _=null,m=r(()=>{_&&clearTimeout(_),_=setTimeout(()=>{d(),_=null},100)},"debounce_refresh_status_bar"),p=[];p.push(n.events.on("*",m)),this.attach_disposer(e,p)}r(p4,"post_process");var gA=require("obsidian");function h4(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>Become a Supporter</strong></div>
</div>
<div class="callout-content">
<p>Try early &amp; experimental features:
<ul>
<li><b>Smart Connections Early Release:</b>
<ul>
<li>Inline block connections</li>
<li>Footer connections view</li>
<li>Connections re-ranking</li>
</ul>
</li>
<li><b>Smart Context Early Release:</b>
<ul>
<li>Named contexts</li>
<li>External sources: include code from external repositories</li>
<li>Context codeblocks: embed context in notes ("My most valuable workflow" - \u{1F334} Brian)</li>
</ul>
</li>
<li><b>Smart Editor:</b>
<ul>
<li>Generate &amp; review changes</li>
</ul>
</li>
<li><em>Be the first to know what's coming next!</em></li>
</ul>
</p>
<p>Access the Supporter Community Campfire Chat:
<ul>
<li>Supporter-only private discussions</li>
<li>Share workflows</li>
<li>Get priority help &amp; support</li>
</ul>
</p>
<p>Guaranteed seat in the Community Lean Coffee meetings.</p>
<p><i>Your support shapes the future of ${t}.</i></p>
<p>
<strong>Fuel the circle of empowerment.</strong> <a href="https://smartconnections.app/community-supporters?utm_source=obsidian-${t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}" class="button" target="_external">Become a Supporter</a>
</p>
</div>
</div>
</div>`}r(h4,"build_html");function yA(n,e={}){let t=h4.call(this,n,e),i=this.create_doc_fragment(t).querySelector(".wrapper");return f4.call(this,n,i,e),i}r(yA,"render");async function f4(n,e){let t=e.querySelector(".callout-icon"),s=(0,gA.getIcon)("hand-heart");s&&(this.empty(t),t.appendChild(s));let i=n.app.vault.getName().toLowerCase().replace(/[^a-z0-9]/g,"_")+"_smart_plugins_oauth_";!!localStorage.getItem(i+"token")&&(e.querySelector("#footer-callout").style.display="none"),await this.render_setting_components(e,{scope:n.env})}r(f4,"post_process");var bA=require("obsidian");function g4(n,e={}){let{plugin_name:t=n.manifest.name}=e;return`<div class="wrapper">
<div id="footer-callout" data-callout-metadata="" data-callout-fold="" data-callout="info" class="callout" style="mix-blend-mode: unset;">
<div class="callout-title" style="align-items: center;">
<div class="callout-icon">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-info">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</div>
<div class="callout-title-inner"><strong>User Agreement</strong></div>
</div>
<div class="callout-content">
<p>By using ${t} you agree to share how it helps you with at least one other person \u{1F60A}\u{1F334}</p>
</div>
</div>
</div>`}r(g4,"build_html");function vA(n,e={}){let t=g4.call(this,n,e),i=this.create_doc_fragment(t).querySelector("#footer-callout"),o=i.querySelector(".callout-icon"),a=(0,bA.getIcon)("smart-connections");return a&&(this.empty(o),o.appendChild(a)),y4.call(this,n,i,e),i}r(vA,"render");function y4(n,e){}r(y4,"post_process");var Gf=require("obsidian");async function kA(n={}){let e=this.context_items.filter(n.filter);if(!e.length)return this.emit_event("notification:warning",{message:"No context items to copy."}),new Gf.Notice("No context items to copy.");let t=await this.get_text(n);await qu(t);let s=b4({item_count:e.length,char_count:t.length,max_depth:n.max_depth,exclusions:n.exclusions});this.emit_event("context:copied"),new Gf.Notice(s)}r(kA,"copy_to_clipboard");function b4(n={}){let e=Number.isFinite(n.item_count)?n.item_count:0,t=Number.isFinite(n.char_count)?n.char_count:0,s=[];s.push(`${e} file(s)`),s.push(`${v4(t)} chars`),Number.isFinite(n.max_depth)&&s.push(`depth\u2264${n.max_depth}`);let i=k4(n.exclusions);return i>0&&s.push(`${i} section(s) excluded`),`Copied to clipboard! (${s.join(", ")})`}r(b4,"format_stats_message");function v4(n){return Number.isFinite(n)?n>=1e5?`~${Math.round(n/1e3)}k`:n.toLocaleString():"0"}r(v4,"format_char_count");function k4(n){return n?Object.values(n).reduce((e,t)=>{let s=Number.isFinite(t)?t:0;return e+s},0):0}r(k4,"sum_exclusions");var w4="xml_structured",Nu={xml_structured:{label:"XML-style (default)",context_template_before:`<context>
{{FILE_TREE}}`,context_template_after:"</context>",item_template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}" depth="{{LINK_DEPTH}}">',item_template_after:"</item>"},markdown_headings:{label:"Markdown headings",context_template_before:"{{FILE_TREE}}",context_template_after:"",item_template_before:["## {{KEY}}","Updated: {{TIME_AGO}} | Depth: {{LINK_DEPTH}}","````{{EXT}}"].join(`
`),item_template_after:"````\n"},json_structured:{label:"JSON structured",context_template_before:`{
"context": {`,context_template_after:`  }
}`,item_template_before:'    "{{KEY}}": { "name": "{{ITEM_NAME}}", "updated": "{{TIME_AGO}}", "depth": {{LINK_DEPTH}}, "content": ',item_template_after:"    },",json_stringify:!0},custom:{label:"Custom (PRO)"}},wA=r((n={})=>{let e=n.template_preset||w4;return Nu[e]?e:"custom"},"get_preset_key"),Tu=r((n,e,t,s)=>{let i=wA(n),o=Nu[i],a=n?.[s];return i!=="custom"&&o&&typeof o[t]=="string"?o[t]:i==="custom"&&typeof a=="string"?a:e?.[s]},"get_template_value");function Pu(){return Object.entries(Nu).map(([n,e])=>({value:n,label:e.label||n}))}r(Pu,"get_template_preset_options");function xA(n={},e={}){return{template_before:Tu(n,e,"context_template_before","template_before"),template_after:Tu(n,e,"context_template_after","template_after")}}r(xA,"get_context_templates");function EA(n={},e={}){let t=wA(n),s=Nu[t],i=t==="custom"&&typeof n.json_stringify=="boolean";return{...s&&typeof s=="object"?s:{},...i?{json_stringify:n.json_stringify}:{},template_before:Tu(n,e,"item_template_before","template_before"),template_after:Tu(n,e,"item_template_after","template_after")}}r(EA,"get_item_templates");var x4=r((n="")=>{if(typeof n!="string"||n.trim().length===0)return"";let[e]=n.split(/[\\/]/).slice(-1),[t,...s]=(e||"").split("#"),i=t.includes(".")?t.slice(0,t.lastIndexOf(".")):t;return s.length>0?`${i}#${s.join("#")}`:i},"derive_item_name_from_key"),E4=r(n=>x4(n.key),"get_item_name");async function AA(n,e={}){let t={KEY:this.key,ITEM_NAME:E4(this),TIME_AGO:Bh(this.mtime)||"Missing",LINK_DEPTH:this.data.d||"0",EXT:this.item_ref?.file_type||""},s=r(async c=>{let l=/{{([\w_]+)}}/g,d=(c.match(l)||[]).length;for(let _=0;_<d;_++)c=c.replace(/{{(\w+)}}/g,(m,p)=>t[p]||"");return c},"replace_vars"),i=EA(this.settings,Hf);(e.json_stringify||i.json_stringify)&&(n=JSON.stringify(n));let o=await s(i.template_before),a=await s(i.template_after);return["",o,n,a,""].join(`
`)}r(AA,"merge_template");var SA={template_preset:{group:"Item templates",type:"dropdown",name:"Select template",description:"Wraps each context item with a pre-configured template.",options_callback:r(()=>Pu(),"options_callback")},template_before:{group:"Item templates",type:"textarea",name:"Template Before",description:"Template to wrap before the context item content.",scope_class:"pro-setting"},template_after:{group:"Item templates",type:"textarea",name:"Template After",description:"Template to wrap after the context item content.",scope_class:"pro-setting"},item_explanation:{type:"html",group:"Item templates",value:`
<b>Available variables:</b>
<ul>
<li><code>{{KEY}}</code> - Full path of the item</li>
<li><code>{{ITEM_NAME}}</code> - Source file or block name without folder path or file extension</li>
<li><code>{{TIME_AGO}}</code> - Time since the item was last modified</li>
<li><code>{{LINK_DEPTH}}</code> - Depth level of the item</li>
<li><code>{{EXT}}</code> - File extension of the item</li>
</ul>
`},json_stringify:{group:"Item templates",type:"toggle",name:"JSON Stringify",description:"Convert the item content to a JSON string (forces full content into single line in quotes).",scope_class:"pro-setting"}},Hf={template_preset:"xml_structured",template_before:'<item loc="{{KEY}}" at="{{TIME_AGO}}">',template_after:"</item>"};function wi(n=[]){if(!Array.isArray(n)||n.length===0)return"";let e={};for(let t of n){let s=A4(t),i=t.split("/").filter(Boolean),o=e;for(let a=0;a<i.length;a++){let c=i[a];a===i.length-1?s?o[c]=o[c]??{__isExplicitFolder:!0}:o[c]=null:o=o[c]??={}}}return Iu(e),CA(e).trimEnd()}r(wi,"build_file_tree_string");function A4(n){return typeof n=="string"&&n.endsWith("/")}r(A4,"is_folder_path");function Iu(n){if(!(!n||typeof n!="object"))for(let e of Object.keys(n)){let t=n[e];if(t&&typeof t=="object"){if(t.__isExplicitFolder){delete t.__isExplicitFolder,Iu(t);continue}let s=Object.keys(t);if(s.length===1&&t[s[0]]!==null&&!t[s[0]].__isExplicitFolder){let i=`${e}/${s[0]}`;n[i]=t[s[0]],delete n[e],Iu(n[i])}else Iu(t)}}}r(Iu,"compress_single_child_dirs");function CA(n,e=""){let t="",s=Object.entries(n).sort((i,o)=>{let a=i[1]!==null,c=o[1]!==null;return a&&!c?-1:!a&&c?1:i[0].localeCompare(o[0])});return s.forEach(([i,o],a)=>{let c=a===s.length-1,l=c?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";o===null?t+=`${e}${l}${i}
`:(t+=`${e}${l}${i}/
`,t+=CA(o,e+(c?"    ":"\u2502   ")))}),t}r(CA,"build_tree_string");async function OA(n,e={}){let t=e.context_items||[],s={FILE_TREE:r(()=>wi(t.map(l=>l.key)),"FILE_TREE")},i=r(async l=>{let d=(l.match(/{{(\w+)}}/g)||[]).length;for(let _=0;_<d;_++)l=l.replace(/{{(\w+)}}/gi,(m,p)=>s[p]?.()||"");return l},"replace_vars"),o=xA(this.settings,Jf),a=await i(o.template_before),c=await i(o.template_after);return[a,n,c].join(`
`)}r(OA,"merge_template");var qA={template_preset:{type:"dropdown",group:"Context templates",name:"Select template",description:"Wraps the full context with a pre-configured template.",options_callback:r(()=>Pu(),"options_callback")},template_before:{type:"textarea",group:"Context templates",name:"Template Before",description:"Template to wrap before the context.",scope_class:"pro-setting"},template_after:{type:"textarea",group:"Context templates",name:"Template After",description:"Template to wrap after the context.",scope_class:"pro-setting"},context_explanation:{type:"html",group:"Context templates",value:`<b>Available variables:</b>
<ul>
<li><code>{{FILE_TREE}}</code> - Shows hierarchical view of all files</li>
</ul>
`}},Jf={template_preset:"xml_structured",template_before:`<context>
{{FILE_TREE}}`,template_after:"</context>"};function pa(n={}){let e=[];return n.source_key?e=this.env.smart_sources.get(n.source_key).blocks:e=Object.values(this.env.smart_blocks.items),e.sort((t,s)=>{let i=Array.isArray(t.lines)&&t.lines.length?t.lines[0]:1/0,o=Array.isArray(s.lines)&&s.lines.length?s.lines[0]:1/0;return i-o}).map(t=>({key:t.key,display:S4(t,{show_full_path:!1}),select_action:r(()=>{this.add_item(t.key)},"select_action")}))}r(pa,"context_suggest_blocks");function S4(n,e={}){if(!n?.key)return"";if(e.show_full_path??!0)return n.key.replace(/#/g," > ").replace(/\//g," > ");let s=[],[i,...o]=n.key.split("#"),a=i.split("/").pop();if(s.push(a),o.length){let c=o[o.length-1];c.startsWith("{")&&c.endsWith("}")?(o.pop(),s.push(o.pop()),n.lines&&s.push(`Lines: ${n.lines.join("-")}`)):s.push(o.pop())}return s.filter(Boolean).join(" > ")}r(S4,"get_block_display_name");var $A="Add blocks";function jA(n={}){return Object.values(this.env.smart_sources.items).map(t=>({key:t.key,display:t.key,select_action:r(()=>{this.add_item(t.key)},"select_action"),mod_select_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",pa.call(this,{source_key:t.key})),"mod_select_action"),arrow_right_action:r(({modal:s})=>(s.last_input_value=s.inputEl.value,s.inputEl.value="",pa.call(this,{source_key:t.key})),"arrow_right_action")}))}r(jA,"context_suggest_sources");var TA="Add sources";async function Mu(n){let e=n.query;if(!e||typeof e!="string"||e.trim().length===0)throw new Error("Invalid or empty query provided to lookup list.");let t=this.env.smart_sources.embed_model;if(!t)throw new Error("No embed model available in environment for lookup list.");let s=await t.embed(e);return n.to_item={...s},n.score_algo_key||(n.score_algo_key="similarity"),n}r(Mu,"pre_process");function Kf(n){return this.vec?n.to_item?.vec?{score:Is(this.vec||[],n.to_item.vec||[])}:{score:null,error:"Missing params.to_item.vec"}:{score:null,error:`Missing this.vec for ${this.key}`}}r(Kf,"similarity");Kf.action_type="score";var Vf="Cosine Similarity",Xf="Ranks by cosine similarity between the current note and candidates.",NA={similarity_algo_description:{group:"Score algorithm",type:"html",name:`${Vf} algorithm`,value:`${Xf}`}};var Yf=require("obsidian");async function PA(n,e=null){try{let s=n.env.obsidian_app,i=n.key;i.endsWith("#")&&(i=i.slice(0,-1));let o;if(i.includes("#")){let[c]=i.split("#");o=s.metadataCache.getFirstLinkpathDest(c,"")}else o=s.metadataCache.getFirstLinkpathDest(i,"");if(!o){console.warn(`[open_note] Unable to resolve file for ${i}`);return}let a;if(e){let c=Yf.Keymap.isModEvent(e),l=Yf.Keymap.isModifier(e,"Alt");c&&l?a=s.workspace.splitActiveLeaf("vertical"):c?a=s.workspace.getLeaf(!0):a=s.workspace.getMostRecentLeaf()}else a=s.workspace.getMostRecentLeaf();if(await a.openFile(o),typeof n?.line_start=="number"){let{editor:c}=a.view,l={line:n.line_start,ch:0};c.setCursor(l),c.scrollIntoView({to:l,from:l},!0)}n.emit_event("sources:opened",{event_source:"open_source method"})}catch(t){console.error("Error in open_source:",t),n.emit_event("notification:error",{message:t.message,event_source:"open_source method"})}}r(PA,"open_source");async function IA(n=null){await PA(this,n)}r(IA,"source_open");var MA={collections:{embedding_models:_1,lookup_lists:m1},item_types:{EmbeddingModel:Ks,LookupList:ss},items:{embedding_model:{class:Ks},lookup_list:{class:ss}},modules:{},components:{collection_settings:{render:p1},context_item_leaf:{render:v1},env_stats:{render:k1},form_dropdown:{render:Uf},lean_coffee_callout:{render:E1},milestones:{render:T1},notifications_feed:{render:N1},pro_plugins_list:{render:z1},pro_plugins_list_item:{render:D1},settings_env_model:{render:U1},settings_env_model_type:{render:J1},settings_env_models:{render:K1},settings_env_sources:{render:I0},settings_model_actions:{render:V1},settings_notifications:{render:X1},settings_smart_env:{render:Z1},smart_context_actions:{render:eA},smart_context_item:{render:sA},smart_context_meta:{render:nA},smart_context_tree:{render:cA},source_inspector:{render:dA},status_bar:{render:fA},supporter_callout:{render:yA},user_agreement_callout:{render:vA}},actions:{context_copy_to_clipboard:{action:kA},context_item_merge_template:{action:AA,settings_config:SA,default_settings:Hf},context_merge_template:{action:OA,settings_config:qA,default_settings:Jf},context_suggest_blocks:{action:pa,display_name:$A},context_suggest_sources:{action:jA,display_name:TA},lookup_list_pre_process:{action:Mu,pre_process:Mu},similarity:{action:Kf,settings_config:NA,display_name:Vf,display_description:Xf},source_open:{action:IA}}};var LA={env_path:"",modules:{smart_fs:{class:v_,adapter:k_},smart_view:{class:S_,adapter:O_},smart_embed_model:{class:Mr,adapters:{transformers:fi,openai:Q_,ollama:su,gemini:nu,lm_studio:iu}},smart_chat_model:{class:zr,adapters:{anthropic:Dr,azure:Br,custom:Qr,google:yi,gemini:Gr,groq:ea,lm_studio:Jr,ollama:Xr,open_router:Hr,openai:Hs,xai:ta,deepseek:sa},http_adapter:new it({adapter:hi,obsidian_request_url:Zf.requestUrl})},http_adapter:{class:it,adapter:hi,obsidian_request_url:Zf.requestUrl}},collections:{context_items:i1,event_logs:r1,smart_components:e1,smart_contexts:s1,smart_sources:{collection_key:"smart_sources",class:$r,data_adapter:Nr,source_adapters:{md:Bs,txt:Bs,"excalidraw.md":H_,base:W_,canvas:G_},content_parsers:[VE],process_embed_queue:!0,load_order:100},smart_blocks:{collection_key:"smart_blocks",class:Ir,data_adapter:J_,block_adapters:{md:di,txt:di,"excalidraw.md":di}}},item_types:{SmartSource:ai,SmartBlock:li},items:{smart_source:NE,smart_block:DE},default_settings:c1,modals:{context_selector:{class:gu,default_suggest_action_keys:["context_suggest_sources"]},milestones_modal:{class:bu},notifications_feed_modal:{class:yu}}};Et(LA,MA);var zA=LA;var Lu=require("obsidian");function DA(){(0,Lu.addIcon)("smart-chat",`<defs>
<symbol id="smart-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<path d="M2 4c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v11c0 1.1-.9 2-2 2h-8l-5 4v-4H4c-1.1 0-2-.9-2-2Z" stroke-width="2"></path>
<path d="M7 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M15.2 8c.5.3 1.3.3 1.8 0" stroke-width="2"></path>
<path d="M8 11.5c1 .8 2.5 1.2 4 1.2s3-.4 4-1.2" stroke-width="2"></path>
</symbol>
</defs>
<use href="#smart-chat-icon" />`)}r(DA,"add_smart_chat_icon");function RA(){(0,Lu.addIcon)("smart-connections",`<path d="M50,20 L80,40 L80,60 L50,100" stroke="currentColor" stroke-width="4" fill="none"/>
<path d="M30,50 L55,70" stroke="currentColor" stroke-width="5" fill="none"/>
<circle cx="50" cy="20" r="9" fill="currentColor"/>
<circle cx="80" cy="40" r="9" fill="currentColor"/>
<circle cx="80" cy="70" r="9" fill="currentColor"/>
<circle cx="50" cy="100" r="9" fill="currentColor"/>
<circle cx="30" cy="50" r="9" fill="currentColor"/>`)}r(RA,"add_smart_connections_icon");function FA(){(0,Lu.addIcon)("smart-lookup",`<defs>
<clipPath id="sc-in-search-clip" clipPathUnits="userSpaceOnUse">
<circle cx="11" cy="11" r="8"></circle>
</clipPath>
<symbol id="smart-lookup-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
<g clip-path="url(#sc-in-search-clip)">
<path d="M10.3,5.4 L14.5,8.2 L14.5,11.0 L10.3,16.6" stroke="currentColor" stroke-width="0.56" fill="none"></path>
<path d="M7.5,9.6 L11.0,12.4" stroke="currentColor" stroke-width="0.7" fill="none"></path>
<circle cx="10.3" cy="5.4" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="8.2" r="0.3" fill="currentColor"></circle>
<circle cx="14.5" cy="12.4" r="0.3" fill="currentColor"></circle>
<circle cx="10.3" cy="16.6" r="0.3" fill="currentColor"></circle>
<circle cx="7.5" cy="9.6" r="0.3" fill="currentColor"></circle>
</g>
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.3-4.3"></path>
</symbol>
</defs>
<use href="#smart-lookup-icon" />`)}r(FA,"add_smart_lookup_icon");var BA=require("obsidian");var zu={item_excluded:{en:"Cannot show Smart Connections for excluded entity: {{entity_key}}"},load_env:{en:"Mobile detected: to prevent performance issues, click to load Smart Environment when ready.",button:{en:"Load Smart Env",callback:r(n=>{n.load(!0)},"callback")},timeout:1e4},missing_entity:{en:"No entity found for key: {{key}}"},notice_muted:{en:"Notice muted"},new_version_available:{en:"A new version is available! (v{{version}})",timeout:15e3,button:{en:"Release notes",callback:r(n=>{window.open("https://github.com/brianpetro/obsidian-smart-connections/releases","_blank")},"callback")}},new_early_access_version_available:{en:"A new early access version is available! (v{{version}})"},supporter_key_required:{en:"Supporter license key required for early access update"},revert_to_stable_release:{en:'Click "Check for Updates" in the community plugins tab and complete the update for Smart Connections to finish reverting to the stable release.',timeout:0},action_installed:{en:'Installed action "{{name}}"'},action_install_error:{en:'Error installing action "{{name}}": {{error}}',timeout:0},embed_model_not_loaded:{en:"Embed model not loaded. Please wait for the model to load and try again."},embed_search_text_failed:{en:"Failed to embed search text."},error_in_embedding_search:{en:"Error in embedding search. See console for details."},copied_to_clipboard:{en:"Message: {{content}} copied successfully."},copy_failed:{en:"Unable to copy message to clipboard."},copied_chatgpt_url_to_clipboard:{en:"ChatGPT URL copied to clipboard."},loading_collection:{en:"Loading {{collection_key}}..."},done_loading_collection:{en:"{{collection_key}} loaded."},saving_collection:{en:"Saving {{collection_key}}..."},initial_scan:{en:"[{{collection_key}}] Starting initial scan...",timeout:0},done_initial_scan:{en:"[{{collection_key}}] Initial scan complete.",timeout:3e3},pruning_collection:{en:"Pruning {{collection_key}}..."},done_pruning_collection:{en:"Pruned {{count}} items from {{collection_key}}."},embedding_progress:{en:`Embedding progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Pause",callback:r(n=>{console.log("pausing"),n.smart_sources.entities_vector_adapter.halt_embed_queue_processing()},"callback")},timeout:0},embedding_complete:{en:"Embedding complete. {{total_embeddings}} embeddings created. {{tokens_per_second}} tokens/sec using {{model_name}}",timeout:0},embedding_paused:{en:`Embedding paused. Progress: {{progress}} / {{total}}
{{tokens_per_second}} tokens/sec using {{model_name}}`,button:{en:"Resume",callback:r(n=>{n.smart_sources.entities_vector_adapter.resume_embed_queue_processing(100)},"callback")},timeout:0},embedding_error:{en:"Error embedding: {{error}}",timeout:0},import_progress:{en:"Importing... {{progress}} / {{total}} sources",timeout:0},done_import:{en:"Import complete. {{count}} sources imported in {{time_in_seconds}}s",timeout:0},no_import_queue:{en:"No items in import queue"},clearing_all:{en:"Clearing all data...",timeout:0},done_clearing_all:{en:"All data cleared and reimported",timeout:3e3},image_extracting:{en:"Extracting text from Image(s)",timeout:0},pdf_extracting:{en:"Extracting text from PDF(s)",timeout:0},insufficient_settings:{en:"Insufficient settings for {{key}}, missing: {{missing}}",timeout:0},unable_to_init_source:{en:"Unable to initialize source: {{key}}",timeout:0},reload_sources:{en:"Reloaded sources in {{time_ms}}ms"}};function C4(n){for(let e of Object.keys(n)){let t=n[e];typeof t.create!="function"&&(t.create=function(s={}){let i=this.en??e;for(let[c,l]of Object.entries(s))i=i.replace(new RegExp(`{{${c}}}`,"g"),String(l));let o;!s.button&&this.button?o={text:typeof this.button.en=="string"?this.button.en:"OK",callback:typeof this.button.callback=="function"?this.button.callback:()=>{}}:o=s.button;let a=s.timeout??this.timeout??5e3;return{text:i,button:o,timeout:a,confirm:s.confirm,immutable:s.immutable}})}return n}r(C4,"define_default_create_methods");var ha=class{static{r(this,"SmartNotices")}constructor(e,t={}){e?.create_env_getter(this),this.active={},this.adapter=t.adapter||this.env.config.modules.smart_notices.adapter,C4(zu)}get settings(){return this.env?.settings?.smart_notices||(this.env.settings.smart_notices={}),this.env?.settings?.smart_notices?.muted||(this.env.settings.smart_notices.muted={}),this.env?.settings?.smart_notices}show(e,t={}){let s=null;typeof t=="string"?s=t:t=t||{};let i=this._normalize_notice_key(e);if(this.settings?.muted?.[i]){t.confirm?.callback&&t.confirm.callback();return}let o=zu[e],a={text:s||e,timeout:t.timeout??5e3,button:t.button,immutable:t.immutable,confirm:t.confirm};if(o?.create){let l=o.create({...t});a.text=s||l.text,a.timeout=l.timeout,a.button=l.button,a.immutable=l.immutable,a.confirm=l.confirm}let c=this._build_fragment(i,a.text,a);return this.active[i]?.noticeEl?.isConnected?this.active[i].setMessage(c,a.timeout):this._render_notice(i,c,a)}_normalize_notice_key(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_")}_render_notice(e,t,{timeout:s}){return this.active[e]=new this.adapter(t,s),this.active[e]}_build_fragment(e,t,{button:s,confirm:i,immutable:o}){let a=document.createDocumentFragment();a.createEl("p",{cls:"sc-notice-head",text:`[Smart Env v${this.env.constructor.version}]`});let c=a.createEl("p",{cls:"sc-notice-content",text:t}),l=a.createEl("div",{cls:"sc-notice-actions"});return i?.text&&typeof i.callback=="function"&&this._add_button(i,l),s?.text&&typeof s.callback=="function"&&this._add_button(s,l),o||this._add_mute_button(e,l),a}_add_button(e,t){let s=document.createElement("button");this.env.smart_view.safe_inner_html(s,e.text),s.addEventListener("click",i=>{e.stay_open&&(i.preventDefault(),i.stopPropagation()),e.callback?.(this.env)}),t.appendChild(s)}_add_mute_button(e,t){let s=document.createElement("button");(0,BA.setIcon)(s,"bell-off"),s.addEventListener("click",()=>{this.settings.muted||(this.settings.muted={}),this.settings.muted[e]=!0,zu["notice muted"]&&this.show("notice muted",null,{timeout:2e3})}),t.appendChild(s)}unload(){for(let e in this.active)this.remove(e)}remove(e){let t=this._normalize_notice_key(e);this.active[t]?.hide(),delete this.active[t]}};var UA=require("obsidian");var O4=require("obsidian");function Du(){return typeof window<"u"&&window.SMART_SERVER_URL_OVERRIDE?window.SMART_SERVER_URL_OVERRIDE:"https://connect.smartconnections.app"}r(Du,"get_smart_server_url");var q4="smart-plugins-op",$4="smart-plugins-op-secret";function j4({access_token:n,refresh_token:e},t){localStorage.setItem(t+"token",n),e&&localStorage.setItem(t+"refresh",e)}r(j4,"set_local_storage_token");async function WA(n,e){let t=N4(e.app.vault.getName()),s=`${Du()}/auth/oauth_exchange2`,i=await(0,UA.requestUrl)({url:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:q4,client_secret:$4,code:n})});if(i.status!==200)throw new Error(`OAuth exchange error ${i.status} ${i.text}`);let{access_token:o,refresh_token:a}=i.json;if(!o)throw new Error("No access_token in response");j4({access_token:o,refresh_token:a},t)}r(WA,"exchange_code_for_tokens");var T4="_smart_plugins_oauth_";function N4(n){return`${String(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")}${T4}`}r(N4,"build_oauth_storage_prefix");function GA(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>i.endsWith("/")?i:i+"/");let s=wi([...new Set(t)]);return n.replace(/{{\s*folder_tree\s*}}/gi,s)}r(GA,"replace_folder_tree_var");function HA(n){let t=this.smart_sources?.fs?.folder_paths??[];t=t.map(i=>(i.split("/")[0]||"")+"/");let s=wi([...new Set(t)]);return n.replace(/{{\s*folders_top\s*}}/gi,s)}r(HA,"replace_folders_top_var");function JA(n){console.log("replace_recent_n_var",n);let e=this;return n.replace(/{{\s*recent_(\d+)\s*}}/gi,(t,s)=>{let i=parseInt(s,10)||0,o=Object.values(e.smart_sources?.fs?.files??{}).sort((a,c)=>c.stat.mtime-a.stat.mtime).slice(0,i).map(a=>a.path).join(`
- `);return console.log("replace_recent_n_var",i,o),o?`
- ${o}`:""}).trim()}r(JA,"replace_recent_n_var");function KA(n){let t=this.app?.metadataCache?.getTags?.()||{},s=Object.keys(t).map(i=>i.replace("#","")).join(`
- `);return n.replace(/{{\s*(?:vault_tags|tags)\s*}}/gi,`
- ${s}
`).trim()}r(KA,"replace_vault_tags_var");function VA(n){n.register(e=>/{{\s*folder_tree\s*}}/i.test(e),GA,"{{ folder_tree }}"),n.register(e=>/{{\s*folders_top\s*}}/i.test(e),HA,"{{ folders_top }}"),n.register(e=>/{{\s*(?:tags|vault_tags)\s*}}/i.test(e),KA,"{{ tags }}"),n.register(e=>/{{\s*recent_(\d+)\s*}}/i.test(e),JA,"{{ recent_10 }}")}r(VA,"register_completion_variable_adapter_replacements");async function ct({app:n,plugin_ids:e=[]}={}){if(!n)return;let t=n.vault?.adapter;for(let s of e)await P4(n.plugins,s)&&console.warn(`Disabled legacy plugin: ${s}`),await I4(t,s)&&console.warn(`Removed legacy plugin: ${s}`)}r(ct,"remove_smart_plugins_plugin");async function P4(n,e){if(!(!n||!(n.plugins?.[e]||n.enabledPlugins?.has?.(e)||n.manifests&&e in n.manifests)))return n.plugins?.[e]&&await n.unloadPlugin?.(e),n.disablePluginAndSave&&await n.disablePluginAndSave(e),n.enabledPlugins?.has?.(e)&&n.enabledPlugins.delete(e),n.manifests&&e in n.manifests&&delete n.manifests[e],await n.loadManifests?.(),!0}r(P4,"disable_plugin_if_present");async function I4(n,e){if(!n?.exists)return;let t=`.obsidian/plugins/${e}`;if(await n.exists(t)){if(n.rmdir){await n.rmdir(t,!0);return}if(n.list&&n.remove){let i=[t];for(;i.length;){let o=i.pop(),a=await n.list(o);for(let c of a?.files||[])await n.remove(`${o}/${c}`);for(let c of a?.folders||[])i.push(`${o}/${c}`)}return await n.remove(t),!0}}}r(I4,"remove_plugin_folder");var xi=class extends qr{static{r(this,"SmartEnv")}static async create(e,t){if(!e)throw new Error("SmartEnv.create: 'plugin' parameter is required.");if(!t)throw new Error("SmartEnv.create: 'env_config' parameter is required.");if(t.version=this.version,DA(),RA(),FA(),window.smart_env&&!window.smart_env.constructor.version){let i="Detected ancient SmartEnv. Removing it to prevent issues with new plugins. Make sure your Smart Plugins are up-to-date!";console.warn(i),new Ct.Notice(i,0),window.smart_env=null}let s=Et(t,zA);return s.env_path="",await super.create(e,s)}async load(e=!1){if(this.run_migrations(),!Ct.Platform.isMobile&&!this.plugin.app.workspace.protocolHandlers.has("smart-plugins/callback")&&this.plugin.registerObsidianProtocolHandler("smart-plugins/callback",async i=>{await this.handle_smart_plugins_oauth_callback(i)}),Ct.Platform.isMobile&&!e){let i=this.smart_view.create_doc_fragment("<div><p>Smart Environment loading deferred on mobile.</p><button>Load Environment</button></div>");i.querySelector("button").addEventListener("click",this.load.bind(this,!0)),new Ct.Notice(i,0);return}await super.load(),this.smart_sources?.register_source_watchers?.(this.smart_sources);let t=this.main;t.registerEvent(t.app.workspace.on("active-leaf-change",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i.view?.file?.path;this.emit_source_opened(o,"active-leaf-change")})),t.registerEvent(t.app.workspace.on("file-open",i=>{this.smart_sources?.debounce_re_import_queue?.();let o=i?.path;this.emit_source_opened(o,"file-open")})),this._config.collections.smart_completions?.completion_adapters?.SmartCompletionVariableAdapter&&VA(this._config.collections.smart_completions.completion_adapters.SmartCompletionVariableAdapter),this._config.modals.context_selector.class.register_modal(this.main),this.register_status_bar(),C1(this)}emit_source_opened(e,t=null){if(this._current_opened_source===e)return;let s=this.smart_sources.get(e);s&&(this._current_opened_source=e,s.emit_event("sources:opened",{event_source:t}))}queue_source_re_import(e){this.smart_sources?.queue_source_re_import?.(e)}debounce_re_import_queue(){this.smart_sources?.debounce_re_import_queue?.()}async run_re_import(){await this.smart_sources?.run_re_import?.()}register_status_bar(){this.main?.app?.statusBar?.containerEl?.querySelector?.(".smart-env-status-container")?.closest?.(".status-bar-item")?.remove?.(),this.status_elm=this.main.addStatusBarItem(),this.smart_components?.render_component("status_bar",this).then(t=>{this.status_elm.empty?.(),this.status_elm.appendChild(t)})}get notices(){return this._notices||(this._notices=new ha(this,{adapter:Ct.Notice})),this._notices}initiate_smart_plugins_oauth(){console.log("initiate_smart_plugins_oauth");let e=Math.random().toString(36).slice(2),t=encodeURIComponent("obsidian://smart-plugins/callback"),s=`${Du()}/oauth?client_id=smart-plugins-op&redirect_uri=${t}&state=${e}`;return window.open(s,"_external"),s}async handle_smart_plugins_oauth_callback(e){let t=e.code;if(!t){new Ct.Notice("No OAuth code provided in URL. Login failed.");return}try{await WA(t,this.plugin),this.events.emit("smart_plugins_oauth_completed")}catch(s){console.error("OAuth callback error",s),new Ct.Notice(`OAuth callback error: ${s.message}`)}}export_json(e="smart_env.json"){let t=JSON.stringify(this.to_json(),null,2);return typeof document<"u"&&M4(t,e),t}async ready_to_load_collections(){await new Promise(e=>setTimeout(e,3e3)),await this.wait_for_obsidian_sync()}async wait_for_obsidian_sync(){for(;this.obsidian_is_syncing;)if(console.log("Smart Connections: Waiting for Obsidian Sync to finish"),await new Promise(e=>setTimeout(e,1e3)),!this.plugin)throw new Error("Plugin disabled while waiting for obsidian sync, reload required.")}get obsidian_is_syncing(){let e=this.plugin?.app?.internalPlugins?.plugins?.sync?.instance;return!e||e?.syncStatus.startsWith("Uploading")||e?.syncStatus.startsWith("Fully synced")?!1:e?.syncing}get obsidian_app(){return this.plugin?.app??window.app}open_notifications_feed_modal(){let e=this.config.modals.notifications_feed_modal.class;new e(this.obsidian_app,this).open()}open_milestones_modal(){let e=this.config.modals.milestones_modal.class;new e(this.obsidian_app,this).open()}run_migrations(){ct({app:this.plugin.app,plugin_ids:["smart-plugins"]}),ct({app:this.plugin.app,plugin_ids:["smart-editor"]}),ct({app:this.plugin.app,plugin_ids:["smart-sources"]}),ct({app:this.plugin.app,plugin_ids:["smart-claude"]}),ct({app:this.plugin.app,plugin_ids:["smart-gemini"]}),ct({app:this.plugin.app,plugin_ids:["smart-deepseek"]}),ct({app:this.plugin.app,plugin_ids:["smart-perplexity"]}),ct({app:this.plugin.app,plugin_ids:["smart-grok"]}),ct({app:this.plugin.app,plugin_ids:["smart-aistudio"]})}};function M4(n,e){let t=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}r(M4,"download_json");var z4=require("obsidian");var L4=require("obsidian");var XA=require("obsidian");var Ru=class extends Gt{static{r(this,"SmartEmbedAdapter")}static defaults={};async count_tokens(e){throw new Error("count_tokens method not implemented")}async embed(e){return typeof e=="string"&&(e={embed_input:e}),(await this.embed_batch([e]))[0]}async embed_batch(e){throw new Error("embed_batch method not implemented")}get settings_config(){return{"[ADAPTER].model_key":{name:"Embedding model",type:"dropdown",description:"Select an embedding model.",options_callback:"adapter.get_models_as_options",callback:"model_changed",default:this.constructor.defaults.default_model}}}get dims(){return this.model.data.dims}get max_tokens(){return this.model.data.max_tokens}get batch_size(){return this.model.data.batch_size||1}};var eS=P(QA(),1);var H4=Object.defineProperty,J4=r((n,e,t)=>e in n?H4(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,"__defNormalProp"),K4=r((n,e,t)=>(J4(n,typeof e!="symbol"?e+"":e,t),t),"__publicField");function V4(n,e){let t=Array.from({length:n.length},(s,i)=>({start:i,end:i+1}));for(;t.length>1;){let s=null;for(let i=0;i<t.length-1;i++){let o=n.slice(t[i].start,t[i+1].end),a=e.get(o.join(","));a!=null&&(s==null||a<s[0])&&(s=[a,i])}if(s!=null){let i=s[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}r(V4,"bytePairMerge");function X4(n,e){return n.length===1?[e.get(n.join(","))]:V4(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}r(X4,"bytePairEncode");function Y4(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}r(Y4,"escapeRegex");var eg=class{static{r(this,"_Tiktoken")}specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((s,i)=>{let[o,a,...c]=i.split(" "),l=Number.parseInt(a,10);return c.forEach((d,_)=>s[d]=l+_),s},{});for(let[s,i]of Object.entries(t)){let o=eS.default.toByteArray(s);this.rankMap.set(o.join(","),i),this.textMap.set(i,o)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((s,[i,o])=>(s[o]=this.textEncoder.encode(i),s),{})}encode(n,e=[],t="all"){let s=new RegExp(this.patStr,"ug"),i=eg.specialTokenRegex(Object.keys(this.specialTokens)),o=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),c=new Set(t==="all"?Object.keys(this.specialTokens).filter(d=>!a.has(d)):t);if(c.size>0){let d=eg.specialTokenRegex([...c]),_=n.match(d);if(_!=null)throw new Error(`The text contains a special token that is not allowed: ${_[0]}`)}let l=0;for(;;){let d=null,_=l;for(;i.lastIndex=_,d=i.exec(n),!(d==null||a.has(d[0]));)_=d.index+1;let m=d?.index??n.length;for(let f of n.substring(l,m).matchAll(s)){let y=this.textEncoder.encode(f[0]),g=this.rankMap.get(y.join(","));if(g!=null){o.push(g);continue}o.push(...X4(y,this.rankMap))}if(d==null)break;let p=this.specialTokens[d[0]];o.push(p),l=d.index+d[0].length}return o}decode(n){let e=[],t=0;for(let o=0;o<n.length;++o){let a=n[o],c=this.textMap.get(a)??this.inverseSpecialTokens[a];c!=null&&(e.push(c),t+=c.length)}let s=new Uint8Array(t),i=0;for(let o of e)s.set(o,i),i+=o.length;return this.textDecoder.decode(s)}},Bu=eg;K4(Bu,"specialTokenRegex",n=>new RegExp(n.map(e=>Y4(e)).join("|"),"g"));async function sS(n,e=n){if(typeof window<"u"&&typeof window.document<"u"){let d=window.localStorage.getItem(e);if(d)return JSON.parse(d);let _=await tS(n);return window.localStorage.setItem(e,JSON.stringify(_)),_}let s=await import("node:fs/promises"),i=await import("node:path"),o=await import("node:os"),a=i.join(o.homedir(),".cache","smart-embed-model"),c=i.join(a,e);try{let d=await s.readFile(c,"utf8");return JSON.parse(d)}catch{}let l=await tS(n);return await s.mkdir(a,{recursive:!0}),await s.writeFile(c,JSON.stringify(l),"utf8"),l}r(sS,"fetch_json_cached");async function tS(n){let e=await fetch(n);if(!e.ok)throw new Error(`failed to download ${n} \u2013 ${e.status}`);return await e.json()}r(tS,"do_fetch");var Z4="https://raw.githubusercontent.com/brianpetro/jsbrains/refs/heads/main/smart-embed-model/cl100k_base.json",qe=class extends Ru{static{r(this,"SmartEmbedModelApiAdapter")}get req_adapter(){return ge}get res_adapter(){return ye}get endpoint(){return this.model.data.endpoint}get http_adapter(){return this._http_adapter||(this.model.opts.http_adapter?this._http_adapter=this.model.opts.http_adapter:this._http_adapter=new kt({adapter:wt})),this._http_adapter}get api_key(){return this.model.data.api_key}async count_tokens(e){throw new Error("count_tokens not implemented")}estimate_tokens(e){return typeof e=="object"&&(e=JSON.stringify(e)),Math.ceil(e.length/3.7)}async embed_batch(e){if(!this.api_key)throw new Error("API key not set");if(e=e.filter(l=>l.embed_input?.length>0),e.length===0)return console.log("Empty batch (or all items have empty embed_input)"),[];let t=await Promise.all(e.map(l=>this.prepare_embed_input(l.embed_input))),i=new this.req_adapter(this,t).to_platform(),o=await this.request(i);if(!o)return console.error("No response received for embedding request."),[];if(o.error)return[o];let c=new this.res_adapter(this,o).to_openai();return c?e.map((l,d)=>(l.vec=c[d].vec,l.tokens=c[d].tokens,l)):(console.error("Failed to parse embeddings."),[])}async prepare_embed_input(e){throw new Error("prepare_embed_input not implemented")}prepare_request_headers(){let e={"Content-Type":"application/json"};return this.api_key&&(e.Authorization=`Bearer ${this.api_key}`),e}async request(e,t=0){try{e.throw=!1;let s=await this.http_adapter.request({url:this.endpoint,...e}),i=await this.get_resp_json(s);return i.error?{error:ce(i,s.status())}:i}catch(s){return console.warn("Request error:",s),await this.handle_request_err(s,e,t)}}async handle_request_err(e,t,s){if(e.status===429&&s<3){let i=Math.pow(s+1,2);return console.log(`Retrying request (429) in ${i} seconds...`),await new Promise(o=>setTimeout(o,1e3*i)),await this.request(t,s+1)}return console.error(e),null}async get_resp_json(e){return typeof e.json=="function"?await e.json():await e.json}async validate_api_key(){let e=await this.embed_batch([{embed_input:"test"}]);return Array.isArray(e)&&e.length>0&&e[0].vec!==null}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}async load_tiktoken(){let e=await sS(Z4,"cl100k_base.json");this.tiktoken=new Bu(e)}},ge=class{static{r(this,"SmartEmbedModelRequestAdapter")}constructor(e,t){this.adapter=e,this.embed_inputs=t}get model_id(){return this.adapter.model.data.model_key}get model_dims(){return this.adapter.model.data.dims}get_headers(){return this.adapter.prepare_request_headers()}to_platform(){return{method:"POST",headers:this.get_headers(),body:JSON.stringify(this.prepare_request_body())}}prepare_request_body(){throw new Error("prepare_request_body not implemented")}},ye=class{static{r(this,"SmartEmbedModelResponseAdapter")}constructor(e,t){this.adapter=e,this.response=t}to_openai(){return this.parse_response()}parse_response(){throw new Error("parse_response not implemented")}};var Uu=class extends qe{static{r(this,"GeminiEmbedModelAdapter")}static defaults={adapter:"gemini",description:"Google Gemini (API)",default_model:"gemini-embedding-001",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",dims:768,max_tokens:2048,batch_size:50};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return tg}get res_adapter(){return sg}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"Google API Key for Gemini embeddings",type:"password",description:"Required for Gemini embedding models",placeholder:"Enter Google API Key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"gemini-embedding-001":{id:"gemini-embedding-001",batch_size:50,dims:768,max_tokens:2048,name:"Gemini Embedding",description:"API, 2,048 tokens, 768 dim",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents",adapter:"gemini"}}}prepare_request_headers(){return{"Content-Type":"application/json","x-goog-api-key":this.api_key}}backoff_wait_time=5e3;backoff_factor=1;async embed_batch(e,t=0){if(smart_env.smart_sources.entities_vector_adapter.is_queue_halted)throw new Error("Embedding queue halted during backoff wait due to rate limit errors.");let s=e.map(o=>this.estimate_tokens(o.embed_input)),i=await super.embed_batch(e);if(i[0].error&&i[0].error.details&&i[0].error.details.code===429){if(console.warn("Rate limit error detected in Gemini embed_batch response.",i),t>3)throw console.error("Max retries reached for rate limit errors."),new Error("Max retries reached for rate limit errors.");console.warn(i[0].error.message);let o=i[0].error.details?.details?.find(a=>a.retryDelay);if(o.retryDelay){let a=parseInt(o.retryDelay)*1e3*2;return console.warn(`Using server-specified retry delay of ${a} ms`),await new Promise(c=>setTimeout(c,a)),await this.embed_batch(e,t+1)}else return this.backoff_factor+=1,console.warn(`Rate limit exceeded, backing off for ${this.backoff_wait_time*this.backoff_factor} ms`),await new Promise(a=>setTimeout(a,this.backoff_wait_time*this.backoff_factor)),await this.embed_batch(e,t+1)}else if(i[0].error)throw console.error("Error in Gemini embed_batch response:",i[0].error),new Error(`Gemini embed_batch error: ${i[0].error.message}`);return i.forEach((o,a)=>{o.tokens=s[a]}),console.log("Gemini embed_batch response:",i),i}},tg=class extends ge{static{r(this,"SmartEmbedGeminiRequestAdapter")}get model_id(){return`models/${this.adapter.model.data.model_key}`}prepare_request_body(){return{requests:this.embed_inputs.map(t=>{let[s,...i]=t.split(`
`),o=i.join(`
`).trim()||"";return o.length?{model:this.model_id,content:{parts:[{text:o}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT",title:s}:{model:this.model_id,content:{parts:[{text:s}]},outputDimensionality:this.model_dims,taskType:"RETRIEVAL_DOCUMENT"}})}}},sg=class extends ye{static{r(this,"SmartEmbedGeminiResponseAdapter")}parse_response(){let e=this.response;return console.log("Gemini response:",e),!e||!e.embeddings||!e.embeddings[0].values?(console.error("Invalid Gemini embedding response format",e),[]):e.embeddings.map((t,s)=>!t.values||t.values.length===0?(console.warn(`No values for embedding at index ${s}`),{vec:[],tokens:0}):{vec:t.values,tokens:null})}};var ng=class extends Uu{static{r(this,"GoogleGeminiEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},Q4={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."},gemini_note:{name:"Note about using Gemini Embeddings API",type:"html",value:'<p class="model-note"><b>WARNING: Gemini rate-limiting:</b> Google imposes strict rate limits on the Gemini Embeddings API. Smart Environment will attempt to retry. Retry details can be found in the developer console logs. Consistent rate limit errors may prevent all items from being properly embedded. Restarting Obsidian will attempt to re-embed any failed items. If you continue to experience issues, try disabling blocks to reduce the number of embeddings required by your Smart Environment.</p>'}},nS={class:ng,settings_config:Q4};function eM(n,e="lm_studio"){return n.object!=="list"||!Array.isArray(n.data)?{_:{id:"No models found."}}:(console.log("LM Studio models",n),n.data.filter(t=>t.id&&t.type==="embeddings").reduce((t,s)=>(t[s.id]={id:s.id,model_name:s.id,max_tokens:s.loaded_context_length||512,description:`LM Studio model: ${s.id}`,adapter:e},t),{}))}r(eM,"parse_lm_studio_models");var Wu=class extends qe{static{r(this,"LmStudioEmbedModelAdapter")}static key="lm_studio";static defaults={description:"LM Studio",type:"API",host:"http://localhost:1234",endpoint:"/api/v0/embeddings",models_endpoint:"/api/v0/models",default_model:"",streaming:!1,api_key:"na",batch_size:10,max_tokens:512};get req_adapter(){return ig}get res_adapter(){return og}get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get settings_config(){let e={...super.settings_config};return delete e["[ADAPTER].api_key"],e["[ADAPTER].refresh_models"]={name:"Refresh Models",type:"button",description:"Refresh the list of available models.",callback:"adapter.refresh_models"},e["[ADAPTER].current_model"]={type:"html",value:`<p>Embedding Model Max Tokens: ${this.max_tokens} (may be configured in LM Studio)</p>`},e["[ADAPTER].batch_size"]={name:"Embedding Batch Size",type:"number",description:"Number of embeddings to process in parallel. Adjusting this may improve performance.",value:this.batch_size,default:this.constructor.defaults.batch_size},e["[ADAPTER].cors_note"]={name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"},e}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET"})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}parse_model_data(e){return eM(e,this.constructor.key)}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}refresh_models(){console.log("refresh_models"),this.get_models(!0)}async embed_batch(e){let t=e.map(i=>this.estimate_tokens(i.embed_input)),s=await super.embed_batch(e);return s.forEach((i,o)=>{i.tokens=t[o]}),s}},ig=class extends ge{static{r(this,"LmStudioEmbedModelRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},og=class extends ye{static{r(this,"LmStudioEmbedModelResponseAdapter")}parse_response(){let e=this.response;return!e||!e.data?(console.error("Invalid response format",e),[]):e.data.map(t=>({vec:t.embedding,tokens:null}))}};var rg=class extends Wu{static{r(this,"LmStudioEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},iS={class:rg};var Gu=class extends qe{static{r(this,"SmartEmbedOllamaAdapter")}static defaults={description:"Ollama (Local)",type:"API",host:"http://localhost:11434",endpoint:"/api/embed",models_endpoint:"/api/tags",api_key:"na",streaming:!1,max_tokens:512,signup_url:null,batch_size:30,models:{}};get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}async load(){await this.get_models(),await super.load()}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?null:c}get max_tokens(){return this.model.data.max_tokens||this.constructor.defaults.max_tokens}get req_adapter(){return ag}get res_adapter(){return cg}async get_models(e=!1){if(!this.model_data||e){let t=await this.http_adapter.request({url:this.models_endpoint,method:"GET"});if(t.ok===!1)throw new Error(`Failed to fetch models list: ${t.statusText}`);let s=await t.json(),i=[];for(let a of sM(s.models||[])){let c=await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:a.name})});i.push({...await c.json(),name:a.name})}let o=this.parse_model_data(i);return this.model_data=o,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),o}return this.model_data}get_models_as_options(){let e=this.model_data;return Object.keys(e||{}).length?Object.values(e).map(t=>({value:t.id,name:t.name||t.id})).sort((t,s)=>t.name.localeCompare(s.name)):(this.get_models(!0),[{value:"",name:"No models currently available"}])}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):(this.model_data=e.reduce((t,s)=>{let i=s.model_info||{},o=Object.entries(i).find(([c])=>c.includes("context_length"))?.[1],a=Object.entries(i).find(([c])=>c.includes("embedding_length"))?.[1];return t[s.name]={model_name:s.name,id:s.name,multimodal:!1,max_tokens:o||this.max_tokens,dims:a,description:s.description||`Model: ${s.name}`},t},{}),this._models=this.model_data,this.model_data):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get models(){return typeof this._models=="object"&&Object.keys(this._models||{}).length>0?this._models:{}}get settings_config(){let e=super.settings_config;return delete e["[ADAPTER].api_key"],e["[ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}},ag=class extends ge{static{r(this,"SmartEmbedModelOllamaRequestAdapter")}to_platform(){let e={model:this.model_id,input:this.embed_inputs};return{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}get_headers(){return{"Content-Type":"application/json"}}},cg=class extends ye{static{r(this,"SmartEmbedModelOllamaResponseAdapter")}to_openai(){let e=this.response;if(!e||!e.embeddings)return console.error("Invalid response format from Ollama:",e),[];let t=Math.ceil(e.prompt_eval_count/this.adapter.batch_size);return e.embeddings.map(i=>({vec:i,tokens:t}))}parse_response(){return this.to_openai()}},tM=r(n=>["embed","embedding","bge"].some(e=>n.name.toLowerCase().includes(e)),"is_embedding_model"),sM=r(n=>{if(!Array.isArray(n))throw new TypeError("models must be an array");return n.filter(tM)},"filter_embedding_models");var lg=class extends Gu{static{r(this,"OllamaEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},nM={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},oS={class:lg,settings_config:nM};var Hu=class extends qe{static{r(this,"SmartEmbedOpenRouterAdapter")}static key="open_router";static defaults={description:"OpenRouter (Embeddings)",type:"API",adapter:"OpenRouterEmbeddings",endpoint:"https://openrouter.ai/api/v1/embeddings",models_endpoint:"https://openrouter.ai/api/v1/models",default_model:"text-embedding-3-small",signup_url:"https://accounts.openrouter.ai/sign-up?redirect_url=https%3A%2F%2Fopenrouter.ai%2Fkeys",streaming:!1,api_key:null,batch_size:50,max_tokens:8191};get req_adapter(){return dg}get res_adapter(){return _g}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenRouter API key for embeddings",type:"password",description:"Required for OpenRouter embedding models.",placeholder:"Enter OpenRouter API key"}}}async count_tokens(e){return{tokens:this.estimate_tokens(e)}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}get models_endpoint(){return this.constructor.defaults.models_endpoint}async get_models(e=!1){if(!e&&this.model.data.provider_models)return this.model.data.provider_models;if(!this.api_key){console.warn("[SmartEmbedOpenRouterAdapter] API key missing; cannot fetch models from OpenRouter.");let t=this.constructor.defaults.default_model,s={[t]:{id:t,model_name:t,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=s,s}try{let s=await(await this.http_adapter.request({url:this.models_endpoint,method:"GET",headers:{Authorization:`Bearer ${this.api_key}`}})).json(),i=this.parse_model_data(s);return this.model.data.provider_models=i,this.model.re_render_settings(),i}catch(t){if(console.error("[SmartEmbedOpenRouterAdapter] Failed to fetch models:",t),this.model.data.provider_models)return this.model.data.provider_models;let s=this.constructor.defaults.default_model,i={[s]:{id:s,model_name:s,description:"OpenRouter embedding model",max_tokens:this.max_tokens,adapter:this.constructor.key}};return this.model.data.provider_models=i,i}}parse_model_data(e){let t=[];if(Array.isArray(e?.data))t=e.data;else if(Array.isArray(e))t=e;else return console.error("[SmartEmbedOpenRouterAdapter] Invalid model data format from OpenRouter:",e),{_:{id:"No models found."}};let s={};for(let i of t){let o=i.id||i.name;o&&iM(o)&&(s[o]={id:o,model_name:o,max_tokens:i.context_length||this.max_tokens,description:i.name||i.description||`Model: ${o}`,adapter:this.constructor.key})}return Object.keys(s).length?s:{_:{id:"No embedding models found."}}}},dg=class extends ge{static{r(this,"SmartEmbedOpenRouterRequestAdapter")}prepare_request_body(){return{model:this.model_id,input:this.embed_inputs}}},_g=class extends ye{static{r(this,"SmartEmbedOpenRouterResponseAdapter")}parse_response(){let e=this.response;if(!e||!Array.isArray(e.data))return console.error("[SmartEmbedOpenRouterResponseAdapter] Invalid embedding response format:",e),[];let t=null;return e.usage?.total_tokens&&e.data.length>0&&(t=e.usage.total_tokens/e.data.length),e.data.map(s=>({vec:s.embedding||s.data||[],tokens:t}))}},iM=r(n=>{let e=String(n||"").toLowerCase();return!!(e.split(/[-:/_]/).some(s=>["embed","embedding","bge"].includes(s))||e.includes("text-embedding"))},"is_embedding_model");var ug=class extends Hu{static{r(this,"OpenRouterEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},rS={class:ug};var Ju=class extends qe{static{r(this,"SmartEmbedOpenAIAdapter")}static defaults={adapter:"openai",description:"OpenAI (API)",default_model:"text-embedding-3-small",endpoint:"https://api.openai.com/v1/embeddings"};async count_tokens(e){return this.tiktoken||await this.load_tiktoken(),{tokens:this.tiktoken.encode(e).length}}async prepare_embed_input(e){if(typeof e!="string")throw new TypeError("embed_input must be a string");if(e.length===0)return console.log("Warning: prepare_embed_input received an empty string"),null;let{tokens:t}=await this.count_tokens(e);return t<=this.max_tokens?e:await this.trim_input_to_max_tokens(e,t)}async trim_input_to_max_tokens(e,t){let s=(t-this.max_tokens)/t,i=Math.floor(e.length*(1-s)),o=e.slice(0,i),a=o.lastIndexOf(" ");a>0&&(o=o.slice(0,a));let c=await this.prepare_embed_input(o);return c===null?(console.log("Warning: prepare_embed_input resulted in an empty string after trimming"),null):c}get req_adapter(){return mg}get res_adapter(){return pg}get max_tokens(){return this.model.data.max_tokens||8191}get settings_config(){return{...super.settings_config,"[ADAPTER].api_key":{name:"OpenAI API key for embeddings",type:"password",description:"Required for OpenAI embedding models.",placeholder:"Enter OpenAI API key"}}}get_models(){return Promise.resolve(this.models)}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},mg=class extends ge{static{r(this,"SmartEmbedOpenAIRequestAdapter")}prepare_request_body(){let e={model:this.model_id,input:this.embed_inputs};return this.model_id.startsWith("text-embedding-3")&&(e.dimensions=this.model_dims),e}},pg=class extends ye{static{r(this,"SmartEmbedOpenAIResponseAdapter")}parse_response(){let e=this.response;if(!e||!e.data||!e.usage)return console.error("Invalid response format",e),[];let t=e.usage.total_tokens/e.data.length;return e.data.map(s=>({vec:s.embedding,tokens:t}))}};var hg=class extends Ju{static{r(this,"OpenAIEmbeddingModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}get batch_size(){return 30}get models(){return{"text-embedding-3-small":{id:"text-embedding-3-small",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Text-3 Small",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-3-large":{id:"text-embedding-3-large",batch_size:50,dims:3072,max_tokens:8191,name:"OpenAI Text-3 Large",description:"API, 8,191 tokens, 3,072 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"},"text-embedding-ada-002":{id:"text-embedding-ada-002",batch_size:50,dims:1536,max_tokens:8191,name:"OpenAI Ada",description:"API, 8,191 tokens, 1,536 dim",endpoint:"https://api.openai.com/v1/embeddings",adapter:"openai"}}}},oM={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},dimensions:{name:"Embedding Dimensions",type:"dropdown",description:"Select the number of dimensions for the embeddings (only for text-embedding-3 models).",option_1:"256|256 (equivalent to ada using 'large' model)",option_2:"512|512 (equivalent to ada using 'small' model)",option_3:"1536|1536",option_4:"3072|3072 (uses >10X more RAM/storage than 256)",default:"512"}},aS={class:hg,settings_config:oM};var Ku=class extends G{static{r(this,"SmartChatModelAnthropicAdapter")}static key="anthropic";static defaults={description:"Anthropic Claude",type:"API",endpoint:"https://api.anthropic.com/v1/messages",streaming:!0,api_key_header:"x-api-key",headers:{"anthropic-version":"2023-06-01","anthropic-beta":"tools-2024-04-04","anthropic-dangerous-direct-browser-access":!0},adapter:"Anthropic",models_endpoint:!1,default_model:"claude-opus-4-1-20250805",signup_url:"https://console.anthropic.com/login?returnTo=%2Fsettings%2Fkeys"};get req_adapter(){return fg}res_adapter=gg;async get_models(){try{return this.model_data=await this.get_enriched_model_data(),this.model_data_loaded_at=Date.now(),this.model.data.provider_models=this.model_data,setTimeout(()=>{this.model.re_render_settings()},100),this.model_data}catch{return this.anthropic_models}}is_end_of_stream(e){return e.data.includes("message_stop")}get anthropic_models(){return{"claude-opus-4-1-20250805":{name:"Claude Opus 4.1 (2025-08-05)",id:"claude-opus-4-1-20250805",model_name:"claude-opus-4-1-20250805",description:"Anthropic Claude Opus 4.1 snapshot (2025-08-05)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-opus-4-20250514":{name:"Claude Opus 4 (2025-05-14)",id:"claude-opus-4-20250514",model_name:"claude-opus-4-20250514",description:"Anthropic Claude Opus 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:32e3,multimodal:!0},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4 (2025-05-14)",id:"claude-sonnet-4-20250514",model_name:"claude-sonnet-4-20250514",description:"Anthropic Claude Sonnet 4 snapshot (2025-05-14)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet (latest)",id:"claude-3-7-sonnet-latest",model_name:"claude-3-7-sonnet-latest",description:"Anthropic Claude 3.7 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet (2025-02-19)",id:"claude-3-7-sonnet-20250219",model_name:"claude-3-7-sonnet-20250219",description:"Anthropic Claude 3.7 Sonnet snapshot (2025-02-19)",max_input_tokens:2e5,max_output_tokens:64e3,multimodal:!0},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet (latest)",id:"claude-3-5-sonnet-latest",model_name:"claude-3-5-sonnet-latest",description:"Anthropic Claude 3.5 Sonnet (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet (2024-10-22)",id:"claude-3-5-sonnet-20241022",model_name:"claude-3-5-sonnet-20241022",description:"Anthropic Claude 3.5 Sonnet snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192,multimodal:!0},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku (latest)",id:"claude-3-5-haiku-latest",model_name:"claude-3-5-haiku-latest",description:"Anthropic Claude 3.5 Haiku (rolling-latest)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku (2024-10-22)",id:"claude-3-5-haiku-20241022",model_name:"claude-3-5-haiku-20241022",description:"Anthropic Claude 3.5 Haiku snapshot (2024-10-22)",max_input_tokens:2e5,max_output_tokens:8192},"claude-3-opus-latest":{name:"Claude 3 Opus (latest)",id:"claude-3-opus-latest",model_name:"claude-3-opus-latest",description:"Anthropic Claude 3 Opus (rolling-latest)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-opus-20240229":{name:"Claude 3 Opus (2024-02-29)",id:"claude-3-opus-20240229",model_name:"claude-3-opus-20240229",description:"Anthropic Claude 3 Opus snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet (2024-02-29)",id:"claude-3-sonnet-20240229",model_name:"claude-3-sonnet-20240229",description:"Anthropic Claude 3 Sonnet snapshot (2024-02-29)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0},"claude-3-haiku-20240307":{name:"Claude 3 Haiku (2024-03-07)",id:"claude-3-haiku-20240307",model_name:"claude-3-haiku-20240307",description:"Anthropic Claude 3 Haiku snapshot (2024-03-07)",max_input_tokens:2e5,max_output_tokens:4096,multimodal:!0}}}},fg=class extends J{static{r(this,"SmartChatModelAnthropicRequestAdapter")}to_platform(e=!1){return this.to_anthropic(e)}to_anthropic(e=!1){return this.anthropic_body={model:this.model_id,max_tokens:this.max_tokens,temperature:this.temperature,stream:e},this.anthropic_body.messages=this._transform_messages_to_anthropic(),this.tools&&(this.anthropic_body.tools=this._transform_tools_to_anthropic()),this.tool_choice&&(this.anthropic_body.tool_choice=this.tool_choice==="auto"?{type:"auto"}:{type:"tool",name:this.tool_choice.function.name}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(this.anthropic_body)}}_transform_messages_to_anthropic(){let e=[];for(let t of this.messages)if(t.role==="system")this.anthropic_body.system?this.anthropic_body.system+=`

`:this.anthropic_body.system="",this.anthropic_body.system+=Array.isArray(t.content)?t.content.map(s=>s.text).join(`
`):t.content;else if(t.role==="tool"){let s={role:"user",content:[{type:"tool_result",tool_use_id:t.tool_call_id,content:t.content}]};e.push(s)}else{let s={role:this._get_anthropic_role(t.role),content:this._get_anthropic_content(t.content)};t.tool_calls?.length>0&&(s.content=this._transform_tool_calls_to_content(t.tool_calls)),e.push(s)}return e}_transform_tool_calls_to_content(e){return e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)}))}_get_anthropic_role(e){return{function:"assistant",tool:"user"}[e]||e}_get_anthropic_content(e){return Array.isArray(e)?e.map(t=>t.type==="text"?{type:"text",text:t.text}:t.type==="image_url"?{type:"image",source:{type:"base64",media_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{type:"document",source:{type:"base64",media_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t):e}_transform_tools_to_anthropic(){if(this.tools)return this.tools.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}},gg=class extends B{static{r(this,"SmartChatModelAnthropicResponseAdapter")}static get platform_res(){return{content:[],id:"",model:"",role:"assistant",stop_reason:null,stop_sequence:null,type:"message",usage:{input_tokens:0,output_tokens:0}}}to_openai(){return this.error?{error:ce(this.error,this.status)}:{id:this._res.id,object:"chat.completion",created:Date.now(),choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.stop_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:"",tool_calls:[]};if(Array.isArray(this._res.content))for(let t of this._res.content)t.type==="text"?e.content+=(e.content?`

`:"")+t.text:t.type==="tool_use"&&e.tool_calls.push({id:t.id,type:"function",function:{name:t.name,arguments:JSON.stringify(t.input)}});else e.content=this._res.content;return e.tool_calls.length===0&&delete e.tool_calls,e}_get_openai_finish_reason(e){return{end_turn:"stop",max_tokens:"length",tool_use:"function_call"}[e]||e}_transform_usage_to_openai(){return this._res.usage?{prompt_tokens:this._res.usage.input_tokens||0,completion_tokens:this._res.usage.output_tokens||0,total_tokens:(this._res.usage.input_tokens||0)+(this._res.usage.output_tokens||0)}:{prompt_tokens:0,completion_tokens:0,total_tokens:0}}handle_chunk(e){if(!e.startsWith("data: "))return;e=JSON.parse(e.slice(6)),this._res.content.length||(this._res.content=[{type:"text",text:""}]),e.message?.id&&(this._res.id=e.message.id),e.message?.model&&(this._res.model=e.message.model),e.message?.role&&(this._res.role=e.message.role);let t;if(e.delta?.type==="text_delta"){let s=e.delta?.text;t=s,this._res.content[0].text+=s}return e.delta?.stop_reason&&(this._res.stop_reason=e.delta.stop_reason),e.usage&&(this._res.usage={...this._res.usage,...e.usage}),t}};var yg=class extends Ku{static{r(this,"AnthropicChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},rM={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."}},cS={class:yg,settings_config:rM};var aM=["text-","davinci","babbage","ada","curie","dall-e","whisper","omni","tts","gpt-4o-mini-tts","computer-use","codex","gpt-4o-transcribe","gpt-4o-mini-transcribe","gpt-4o-mini-realtime","gpt-4o-realtime","o4-mini-deep-research","o3-deep-research","gpt-image"],Ei=class extends G{static{r(this,"SmartChatModelOpenaiAdapter")}static key="openai";static defaults={description:"OpenAI",type:"API",endpoint:"https://api.openai.com/v1/chat/completions",streaming:!0,models_endpoint:"https://api.openai.com/v1/models",default_model:"gpt-5-nano",signup_url:"https://platform.openai.com/api-keys"};res_adapter=bg;parse_model_data(e){return e.data.filter(t=>!aM.some(s=>t.id.startsWith(s))&&!t.id.includes("-instruct")).reduce((t,s)=>{let i={model_name:s.id,id:s.id,multimodal:!0,max_input_tokens:cM(s.id)};return t[s.id]=i,t},{})}models_endpoint_method="GET";async test_api_key(){return(await this.get_models()).length>0}get settings_config(){let e=super.settings_config;return e["[CHAT_ADAPTER].open_ai_note"]={name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."},e}};function cM(n){return n.startsWith("gpt-4.1")?1e6:n.startsWith("o")?2e5:n.startsWith("gpt-5")?4e5:n.startsWith("gpt-4o")||n.startsWith("gpt-4.5")||n.startsWith("gpt-4-turbo")?128e3:n.startsWith("gpt-4")?8192:n.startsWith("gpt-3")?16385:8e3}r(cM,"get_max_input_tokens");var bg=class extends B{static{r(this,"SmartChatModelOpenaiResponseAdapter")}};var Vu=class extends Ei{static{r(this,"SmartChatModelAzureAdapter")}static key="azure";static defaults={description:"Azure OpenAI",type:"API",adapter:"AzureOpenAI",streaming:!0,api_key_header:"api-key",azure_resource_name:"",azure_deployment_name:"",azure_api_version:"2024-10-01-preview",default_model:"gpt-35-turbo",signup_url:"https://learn.microsoft.com/azure/cognitive-services/openai/quickstart?tabs=command-line",models_endpoint:"https://{azure_resource_name}.openai.azure.com/openai/deployments?api-version={azure_api_version}"};get settings_config(){return{...super.settings_config,"[CHAT_ADAPTER].azure_resource_name":{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},"[CHAT_ADAPTER].azure_deployment_name":{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},"[CHAT_ADAPTER].azure_api_version":{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}}}get endpoint(){let{azure_resource_name:e,azure_deployment_name:t,azure_api_version:s}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments/${t}/chat/completions?api-version=${s}`}get endpoint_streaming(){return this.endpoint}get models_endpoint(){let{azure_resource_name:e,azure_api_version:t}=this.model.data;return`https://${e}.openai.azure.com/openai/deployments?api-version=${t}`}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No deployments found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,raw:s,description:`Model: ${s.model}, Status: ${s.status}`,max_input_tokens:4e3};return t}};var vg=class extends Vu{static{r(this,"AzureChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},lM={api_key:{name:"API Key",type:"password",description:"Enter your Anthropic API key."},azure_resource_name:{name:"Azure Resource Name",type:"text",description:"The name of your Azure OpenAI resource (e.g. 'my-azure-openai').",default:""},azure_deployment_name:{name:"Azure Deployment Name",type:"text",description:"The name of your specific model deployment (e.g. 'gpt35-deployment').",default:""},azure_api_version:{name:"Azure API Version",type:"text",description:"The API version for Azure OpenAI (e.g. '2024-10-01-preview').",default:"2024-10-01-preview"}},lS={class:vg,settings_config:lM};var Xu=class extends G{static{r(this,"SmartChatModelCohereAdapter")}static key="cohere";static defaults={description:"Cohere Command-R",type:"API",endpoint:"https://api.cohere.ai/v1/chat",streaming:!1,adapter:"Cohere",models_endpoint:"https://api.cohere.ai/v1/models",default_model:"command-r",signup_url:"https://dashboard.cohere.com/welcome/register?redirect_uri=%2Fapi-keys"};get req_adapter(){return kg}get res_adapter(){return wg}async count_tokens(e){let t={url:`${this.endpoint}/tokenize`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.api_key}`},body:JSON.stringify({text:typeof e=="string"?e:JSON.stringify(e)})};return(await this.http_adapter.request(t)).json.tokens.length}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("command-")).reduce((t,s)=>(t[s.name]={model_name:s.name,id:s.name,max_input_tokens:s.context_length,tokenizer_url:s.tokenizer_url,finetuned:s.finetuned,description:`Max input tokens: ${s.context_length}, Finetuned: ${s.finetuned}`,raw:s},t),{})}},kg=class extends J{static{r(this,"SmartChatModelCohereRequestAdapter")}to_platform(){return this.to_cohere()}to_cohere(){let e={model:this.model_id,message:this._get_latest_user_message(),chat_history:this._transform_messages_to_cohere_chat_history(),max_tokens:this.max_tokens,temperature:this.temperature,stream:this.stream,...this.tools&&{tools:this._transform_tools_to_cohere()},...this._req.tool_choice&&{tool_choice:this._req.tool_choice},...this._req.preamble&&{preamble:this._req.preamble},...this._req.conversation_id&&{conversation_id:this._req.conversation_id},...this._req.connectors&&{connectors:this._req.connectors},...this._req.documents&&{documents:this._req.documents}};return this._req.response_format&&(e.response_format={type:this._req.response_format.type,...this._req.response_format.schema&&{schema:this._req.response_format.schema}}),{url:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(e)}}_get_latest_user_message(){if(this.messages.some(t=>Array.isArray(t.content)&&t.content.some(s=>s.type==="image_url")))throw new Error("Cohere API does not support image input");let e=this.messages.filter(t=>t.role==="user");return e[e.length-1]?.content||""}_transform_messages_to_cohere_chat_history(){return this.messages.slice(0,-1).map(e=>({role:this._get_cohere_role(e.role),message:this._get_cohere_content(e.content)}))}_get_cohere_role(e){return{system:"SYSTEM",user:"USER",assistant:"CHATBOT",function:"CHATBOT"}[e]||e.toUpperCase()}_get_cohere_content(e){if(Array.isArray(e)){for(let t of e)if(t.type==="image_url")throw new Error("Cohere API does not support image input");return e.map(t=>t.type==="text"?t.text:JSON.stringify(t)).join(`
`)}return e}_transform_tools_to_cohere(){return this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}},wg=class extends B{static{r(this,"SmartChatModelCohereResponseAdapter")}to_openai(){if(this._res.message)throw new Error(this._res.message);return{id:this._res.generation_id||"cohere_"+Date.now(),object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._get_openai_finish_reason(this._res.finish_reason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){let e={role:"assistant",content:this._res.text||""};return this._res.citations&&(e.citations=this._res.citations),this._res.documents&&(e.documents=this._res.documents),this._res.search_queries&&(e.search_queries=this._res.search_queries),this._res.search_results&&(e.search_results=this._res.search_results),e}_get_openai_finish_reason(e){return{COMPLETE:"stop",MAX_TOKENS:"length",ERROR:"error",STOP_SEQUENCE:"stop"}[e]||"stop"}_transform_usage_to_openai(){return!this._res.meta||!this._res.meta.billed_units?{prompt_tokens:null,completion_tokens:null,total_tokens:null}:{prompt_tokens:this._res.meta.billed_units.input_tokens||null,completion_tokens:this._res.meta.billed_units.output_tokens||null,total_tokens:(this._res.meta.billed_units.input_tokens||0)+(this._res.meta.billed_units.output_tokens||0)}}};var xg=class extends Xu{static{r(this,"CohereChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},dM={api_key:{name:"API Key",type:"password",description:"Enter your Cohere API key."}},dS={class:xg,settings_config:dM};var Yu=class extends G{static{r(this,"SmartChatModelDeepseekAdapter")}static key="deepseek";static defaults={description:"DeepSeek",type:"API",endpoint:"https://api.deepseek.com/chat/completions",streaming:!0,adapter:"DeepSeek",models_endpoint:"https://api.deepseek.com/models",default_model:"deepseek-base",signup_url:"https://deepseek.com/signup"};get req_adapter(){return Eg}get res_adapter(){return Ag}get models_endpoint_method(){return"GET"}parse_model_data(e){if(!e?.data||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_size||8192,description:s.description||s.name||s.id,raw:s};return t}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}is_end_of_stream(e){return e?.data?e.data.includes('"done":true')||e.data.includes("[DONE]"):!1}},Eg=class extends J{static{r(this,"SmartChatModelDeepseekRequestAdapter")}to_platform(e=!1){return this.to_openai(e)}},Ag=class extends B{static{r(this,"SmartChatModelDeepseekResponseAdapter")}};var Sg=class extends Yu{static{r(this,"DeepseekChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},_M={api_key:{name:"API Key",type:"password",description:"Enter your Deepseek API key."}},_S={class:Sg,settings_config:_M};var Zu=class extends G{static{r(this,"SmartChatModelGoogleAdapter")}static key="google";static defaults={description:"Google (Gemini)",type:"API",api_key_header:"none",endpoint:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:generateContent",endpoint_streaming:"https://generativelanguage.googleapis.com/v1beta/models/MODEL_NAME:streamGenerateContent",streaming:!0,adapter:"Gemini",models_endpoint:"https://generativelanguage.googleapis.com/v1beta/models",default_model:"gemini-1.5-pro",signup_url:"https://ai.google.dev/"};streaming_chunk_splitting_regex=/(\r\n|\n|\r){2}/g;req_adapter=Cg;res_adapter=Og;async count_tokens(e){let t={url:`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:countTokens?key=${this.api_key}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.prepare_token_count_body(e))};return(await this.http_adapter.request(t)).json.totalTokens}prepare_token_count_body(e){if(typeof e=="string")return{contents:[{parts:[{text:e}]}]};if(Array.isArray(e))return{contents:e.map(t=>this.transform_message_for_token_count(t))};if(typeof e=="object")return{contents:[this.transform_message_for_token_count(e)]};throw new Error("Invalid input for count_tokens")}transform_message_for_token_count(e){return{role:e.role==="assistant"?"model":e.role,parts:Array.isArray(e.content)?e.content.map(t=>t.type==="text"?{text:t.text}:t.type==="image_url"?{inline_data:{mime_type:t.image_url.url.split(";")[0].split(":")[1],data:t.image_url.url.split(",")[1]}}:t):[{text:e.content}]}}get endpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:generateContent?key=${this.api_key}`}get endpoint_streaming(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.model_key}:streamGenerateContent?key=${this.api_key}`}get models_endpoint(){return`${this.constructor.defaults.models_endpoint}?key=${this.api_key}`}get models_endpoint_method(){return"GET"}get models_request_params(){return{url:this.models_endpoint,method:this.models_endpoint_method}}parse_model_data(e){return e.models.filter(t=>t.name.startsWith("models/gemini")).reduce((t,s)=>{let i={model_name:s.name.split("/").pop(),id:s.name.split("/").pop(),max_input_tokens:s.inputTokenLimit,max_output_tokens:s.maxOutputTokens,description:s.description,multimodal:s.name.includes("vision")||s.description.includes("multimodal"),raw:s};return t[s.name.split("/").pop()]=i,t},{})}is_end_of_stream(e){return e.data.includes('"finishReason"')}},Cg=class extends J{static{r(this,"SmartChatModelGeminiRequestAdapter")}to_platform(e=!1){return this.to_gemini(e)}to_gemini(e=!1){let t={contents:this._transform_messages_to_gemini(),generationConfig:{temperature:this.temperature,maxOutputTokens:this.max_tokens,topK:this._req.topK||1,topP:this._req.topP||1,stopSequences:this._req.stop||[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};return this.tools&&(t.tools=this._transform_tools_to_gemini()),t.tools&&this.tool_choice!=="none"&&(t.tool_config=this._transform_tool_choice_to_gemini()),{url:e?this.adapter.endpoint_streaming:this.adapter.endpoint,method:"POST",headers:this.get_headers(),body:JSON.stringify(t)}}_transform_messages_to_gemini(){let e=[],t="";for(let s of this.messages)s.role==="system"?t+=s.content+`
`:e.push({role:this._get_gemini_role(s.role),parts:this._transform_content_to_gemini(s.content)});return t&&e.unshift({role:"user",parts:[{text:t.trim()}]}),e}_get_gemini_role(e){return{user:"user",assistant:"model",function:"model"}[e]||e}_transform_content_to_gemini(e){return Array.isArray(e)?e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){let s=t.image_url.url.split(";")[0].split(":")[1];return s==="image/jpg"&&(s="image/jpeg"),{inline_data:{mime_type:s,data:t.image_url.url.split(",")[1]}}}return t.type==="file"&&t.file?.filename?.toLowerCase().endsWith(".pdf")&&t.file?.file_data?{inline_data:{mime_type:"application/pdf",data:t.file.file_data.split(",")[1]}}:t}):[{text:e}]}_transform_tools_to_gemini(){return[{function_declarations:this.tools.map(e=>({name:e.function.name,description:e.function.description,parameters:e.function.parameters}))}]}_transform_tool_choice_to_gemini(){return{function_calling_config:{mode:"ANY",allowed_function_names:this.tools.map(e=>e.function.name)}}}},Og=class extends B{static{r(this,"SmartChatModelGeminiResponseAdapter")}static get platform_res(){return{candidates:[{content:{parts:[{text:""}],role:""},finishReason:""}],promptFeedback:{},usageMetadata:{}}}to_openai(){if(this.error)return{error:ce(this.error,this.status)};let e=this._res.candidates[0];return this._res.id||(this._res.id="gemini-"+Date.now().toString()),{id:this._res.id,object:"chat.completion",created:Date.now(),model:this.adapter.model_key,choices:[{index:0,message:e?.content?this._transform_message_to_openai(e.content):"",finish_reason:this._get_openai_finish_reason(e.finishReason)}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(e){let t={role:"assistant",content:e.parts.filter(i=>i.text).map(i=>i.text).join("")},s=e.parts.find(i=>i.functionCall);return s&&(t.tool_calls=[{type:"function",function:{name:s.functionCall.name,arguments:JSON.stringify(s.functionCall.args)}}]),t}_get_openai_finish_reason(e){return{STOP:"stop",MAX_TOKENS:"length",SAFETY:"content_filter",RECITATION:"content_filter",OTHER:"null"}[e]||e.toLowerCase()}_transform_usage_to_openai(){return this._res.usageMetadata?{prompt_tokens:this._res.usageMetadata.promptTokenCount||null,completion_tokens:this._res.usageMetadata.candidatesTokenCount||null,total_tokens:this._res.usageMetadata.totalTokenCount||null}:{prompt_tokens:null,completion_tokens:null,total_tokens:null}}handle_chunk(e){let t=e.trim();["[",","].includes(t[0])&&(t=t.slice(1)),["]",","].includes(t[t.length-1])&&(t=t.slice(0,-1));let s=JSON.parse(t),i;if(s.candidates?.[0]?.content?.parts?.[0]?.text?.length){let o=s.candidates[0].content.parts[0].text;i=o,this._res.candidates[0].content.parts[0].text+=o}return s.candidates?.[0]?.content?.role?.length&&(this._res.candidates[0].content.role=s.candidates[0].content.role),s.candidates?.[0]?.finishReason?.length&&(this._res.candidates[0].finishReason+=s.candidates[0].finishReason),s.promptFeedback&&(this._res.promptFeedback={...this._res.promptFeedback||{},...s.promptFeedback}),s.usageMetadata&&(this._res.usageMetadata={...this._res.usageMetadata||{},...s.usageMetadata}),s.candidates?.[0]?.content?.parts?.[0]?.functionCall&&(this._res.candidates[0].content.parts[0].functionCall||(this._res.candidates[0].content.parts[0].functionCall={name:"",args:{}}),this._res.candidates[0].content.parts[0].functionCall.name+=s.candidates[0].content.parts[0].functionCall.name,s.candidates[0].content.parts[0].functionCall.args&&Object.entries(s.candidates[0].content.parts[0].functionCall.args).forEach(([o,a])=>{this._res.candidates[0].content.parts[0].functionCall.args[o]||(this._res.candidates[0].content.parts[0].functionCall.args[o]=""),this._res.candidates[0].content.parts[0].functionCall.args[o]+=a})),i}};var qg=class extends Zu{static{r(this,"GoogleChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},uM={api_key:{name:"API Key",type:"password",description:"Enter your Google Gemini API key."}},uS={class:qg,settings_config:uM};var Qu=class extends G{static{r(this,"SmartChatModelGroqAdapter")}static key="groq";static defaults={description:"Groq",type:"API",endpoint:"https://api.groq.com/openai/v1/chat/completions",streaming:!0,adapter:"Groq",models_endpoint:"https://api.groq.com/openai/v1/models",default_model:"llama3-8b-8192",signup_url:"https://groq.com"};get req_adapter(){return $g}get res_adapter(){return jg}get models_endpoint_method(){return"GET"}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={model_name:s.id,id:s.id,max_input_tokens:s.context_window||8192,description:`Owned by: ${s.owned_by}, context: ${s.context_window}`,multimodal:s.id.includes("vision")};return t}},$g=class extends J{static{r(this,"SmartChatModelGroqRequestAdapter")}_get_openai_content(e){return["assistant","tool"].includes(e.role)&&Array.isArray(e.content)?e.content.map(t=>typeof t=="string"?t:t?.text?t.text:"").join(`
`):e.content}},jg=class extends B{static{r(this,"SmartChatModelGroqResponseAdapter")}};var Tg=class extends Qu{static{r(this,"GroqChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},mM={api_key:{name:"API Key",type:"password",description:"Enter your Groq API key."}},mS={class:Tg,settings_config:mM};var em=class extends G{static{r(this,"SmartChatModelLmStudioAdapter")}static key="lm_studio";static defaults={description:"LM Studio (OpenAI\u2011compatible)",type:"API",endpoint:"http://localhost:1234/v1/chat/completions",streaming:!0,adapter:"LM_Studio_OpenAI_Compat",models_endpoint:"http://localhost:1234/v1/models",default_model:"",signup_url:"https://lmstudio.ai/docs/api/openai-api",api_key:"no api key required"};get req_adapter(){return Ng}get res_adapter(){return Pg}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],{...e,"[CHAT_ADAPTER].cors_instructions":{name:"CORS required",type:"html",value:"<p>Before you can use LM Studio you must <strong>Enable CORS</strong> inside LM Studio \u2192 Developer \u2192 Settings</p>"}}}parse_model_data(e){if(e.object!=="list"||!Array.isArray(e.data))return{_:{id:"No models found."}};let t={};for(let s of e.data)t[s.id]={id:s.id,model_name:s.id,description:`LM Studio model: ${s.id}`,multimodal:!1};return t}get models_endpoint_method(){return"get"}async count_tokens(e){let t=typeof e=="string"?e:JSON.stringify(e);return Math.ceil(t.length/4)}async test_api_key(){return!0}get api_key(){return"no api key required"}},Ng=class extends J{static{r(this,"SmartChatModelLmStudioRequestAdapter")}to_platform(e=!1){let t=this.to_openai(e),s=JSON.parse(t.body);if(this.tool_choice?.function?.name){let i=s.messages[s.messages.length-1];typeof i.content=="string"&&(i.content=[{type:"text",text:i.content}]),i.content.push({type:"text",text:`Use the "${this.tool_choice.function.name}" tool.`}),s.tool_choice="required"}else s.tool_choice&&typeof s.tool_choice=="object"&&(s.tool_choice="auto");return t.body=JSON.stringify(s),t}},Pg=class extends B{static{r(this,"SmartChatModelLmStudioResponseAdapter")}};var Ig=class extends em{static{r(this,"LmStudioChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},pM={},pS={class:Ig,settings_config:pM};var tm=class extends G{static{r(this,"SmartChatModelOllamaAdapter")}static key="ollama";static defaults={description:"Ollama (Local)",type:"API",api_key:"na",host:"http://localhost:11434",endpoint:"/api/chat",models_endpoint:"/api/tags",streaming:!0};req_adapter=Mg;res_adapter=Lg;get host(){return this.model.data.host||this.constructor.defaults.host}get endpoint(){return`${this.host}${this.constructor.defaults.endpoint}`}get models_endpoint(){return`${this.host}${this.constructor.defaults.models_endpoint}`}get model_show_endpoint(){return`${this.host}/api/show`}get models_endpoint_method(){return"GET"}async get_models(e=!1){if(!e&&typeof this.model_data=="object"&&Object.keys(this.model_data||{}).length>0&&this.model_data_loaded_at&&time_now-this.model_data_loaded_at<3600*1e3)return this.model_data;try{let s=await(await this.http_adapter.request(this.models_request_params)).json(),i=[];for(let o of s.models){let c=await(await this.http_adapter.request({url:this.model_show_endpoint,method:"POST",body:JSON.stringify({model:o.name})})).json();i.push({...c,name:o.name})}return this.model_data=this.parse_model_data(i),await this.get_enriched_model_data(),this.model.data.provider_models=this.model_data,typeof this.model.re_render_settings=="function"&&this.model.re_render_settings(),this.model_data_loaded_at=Date.now(),this.model_data}catch(t){return console.error("Failed to fetch model data:",t),{_:{id:`Failed to fetch models from ${this.model.adapter_name}`}}}}parse_model_data(e){return Array.isArray(e)?e.length===0?(this.model_data={no_models_available:{id:"no_models_available",name:"No models currently available"}},this.model_data):e.reduce((t,s)=>{if(s.name.includes("embed"))return t;let i={model_name:s.name,id:s.name,multimodal:!1,max_input_tokens:Object.entries(s.model_info).find(o=>o[0].includes(".context_length"))[1]};return t[s.name]=i,t},{}):(this.model_data={},console.error("Invalid model data format from Ollama:",e),{})}get settings_config(){let e=super.settings_config;return delete e["[CHAT_ADAPTER].api_key"],e["[CHAT_ADAPTER].host"]={name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:this.constructor.defaults.host},e}is_end_of_stream(e){return e.data.includes('"done_reason"')}},Mg=class extends J{static{r(this,"SmartChatModelOllamaRequestAdapter")}to_platform(e=!1){let t={model:this.model_id,messages:this._transform_messages_to_ollama(),options:this._transform_parameters_to_ollama(),stream:e||this.stream};return this.tools&&(t.tools=this._transform_functions_to_tools(),this.tool_choice?.function?.name&&(t.messages[t.messages.length-1].content+=`

Use the "${this.tool_choice.function.name}" tool.`,t.format="json")),{url:this.adapter.endpoint,method:"POST",body:JSON.stringify(t)}}_transform_messages_to_ollama(){return this.messages.map(e=>{let t={role:e.role,content:this._transform_content_to_ollama(e.content)},s=this._extract_images_from_content(e.content);return s.length>0&&(t.images=s.map(i=>i.replace(/^data:image\/[^;]+;base64,/,""))),t})}_transform_content_to_ollama(e){return Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text).join(`
`):e}_extract_images_from_content(e){return Array.isArray(e)?e.filter(t=>t.type==="image_url").map(t=>t.image_url.url):[]}_transform_functions_to_tools(){return this.tools}_transform_parameters_to_ollama(){let e={};return this.max_tokens&&(e.num_predict=this.max_tokens),this.temperature&&(e.temperature=this.temperature),this.top_p&&(e.top_p=this.top_p),this.frequency_penalty&&(e.frequency_penalty=this.frequency_penalty),this.presence_penalty&&(e.presence_penalty=this.presence_penalty),e}},Lg=class extends B{static{r(this,"SmartChatModelOllamaResponseAdapter")}static get platform_res(){return{model:"",created_at:null,message:{role:"",content:""},total_duration:0,load_duration:0,prompt_eval_count:0,prompt_eval_duration:0,eval_count:0,eval_duration:0}}to_openai(){return this.error?{error:ce(this.error,this.status)}:{id:this._res.created_at,object:"chat.completion",created:Date.now(),model:this._res.model,choices:[{index:0,message:this._transform_message_to_openai(),finish_reason:this._res.done_reason}],usage:this._transform_usage_to_openai()}}_transform_message_to_openai(){return{role:this._res.message.role,content:this._res.message.content,tool_calls:this._res.message.tool_calls}}_transform_usage_to_openai(){return{prompt_tokens:this._res.prompt_eval_count||0,completion_tokens:this._res.eval_count||0,total_tokens:(this._res.prompt_eval_count||0)+(this._res.eval_count||0)}}handle_chunk(e){e=JSON.parse(e||"{}"),e.created_at&&!this._res.created_at&&(this._res.created_at=e.created_at);let t;if(e.message?.content){let s=e.message.content;t=s,this._res.message.content+=s}return e.message?.role&&(this._res.message.role=e.message.role),e.model&&(this._res.model=e.model),e.message?.tool_calls&&(this._res.message.tool_calls||(this._res.message.tool_calls=[{id:"",type:"function",function:{name:"",arguments:""}}]),e.message.tool_calls[0].id&&(this._res.message.tool_calls[0].id+=e.message.tool_calls[0].id),e.message.tool_calls[0].function.name&&(this._res.message.tool_calls[0].function.name+=e.message.tool_calls[0].function.name),e.message.tool_calls[0].function.arguments&&(typeof e.message.tool_calls[0].function.arguments=="string"?this._res.message.tool_calls[0].function.arguments+=e.message.tool_calls[0].function.arguments:this._res.message.tool_calls[0].function.arguments=e.message.tool_calls[0].function.arguments)),t}};var zg=class extends tm{static{r(this,"OllamaChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},hM={host:{name:"Ollama host",type:"text",description:"Enter the host for your Ollama instance",default:"http://localhost:11434"}},hS={class:zg,settings_config:hM};var Dg=class extends Ei{static{r(this,"OpenAIChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},fM={api_key:{name:"API Key",type:"password",description:"Enter your OpenAI API key."},openai_note:{name:"Note about using OpenAI",type:"html",value:"<b>OpenAI models:</b> Some models require extra verification steps in your OpenAI account for them to appear in the model list."}},fS={class:Dg,settings_config:fM};var sm=class extends G{static{r(this,"SmartChatModelXaiAdapter")}static key="xai";static defaults={description:"xAI Grok",type:"API",adapter:"xAI_Grok",endpoint:"https://api.x.ai/v1/chat/completions",streaming:!0,models_endpoint:"https://api.x.ai/v1/models",default_model:"grok-3-mini-beta",signup_url:"https://ide.x.ai"};get req_adapter(){return J}get res_adapter(){return B}get models_endpoint_method(){return"GET"}parse_model_data(e={}){return(e.data||e.models||[]).reduce((s,i)=>{let o=i.id||i.name;return s[o]={id:o,model_name:o,description:i.description||`context: ${i.context_length||"n/a"}`,max_input_tokens:i.context_length||128e3,multimodal:!!i.modality&&i.modality.includes("vision"),raw:i},s},{})}};var Rg=class extends sm{static{r(this,"XaiChatCompletionModelAdapter")}constructor(e){super(e)}get http_adapter(){if(!this._http_adapter){let e=this.model.env.config.modules.http_adapter.class,t={...this.model.env.config.modules.http_adapter,class:void 0};this._http_adapter=new e(t)}return this._http_adapter}},gM={api_key:{name:"API Key",type:"password",description:"Enter your xAI API key."}},gS={class:Rg,settings_config:gM};var yS={collections:{embedding_models:{providers:{gemini:nS,lm_studio:iS,ollama:oS,open_router:rS,openai:aS}},chat_completion_models:{providers:{anthropic:cS,azure:lS,cohere:dS,deepseek:_S,google:uS,groq:mS,lm_studio:pS,ollama:hS,open_router:Ld,openai:fS,xai:gS}}}};var Ai=require("obsidian");async function Fg(n){let e=n.plugin?.app||window.app,t=Su(e),s=(typeof localStorage<"u"?localStorage.getItem(t+"token"):"")||"";if(!s){console.warn("[smart_plugins] No OAuth token found; skipping Smart Plugins auto\u2011update."),nm("Smart Plugins: connect your Smart Plugins account to keep using Pro plugins.");let i=t+"auth_misses",o=parseInt(localStorage.getItem(i)||"0",10);return localStorage.setItem(i,(o+1).toString()),{updated:[],skipped:[],checked:0}}try{let i=await vM(e);console.log("[smart_plugins] Built installed plugins map:",i);let o=await Cu(s);console.log("[smart_plugins] Fetched server plugin list:",o);let a=Array.isArray(o.list)?o.list:[],c=Array.isArray(o.unauthorized)?o.unauthorized:[],l=o.sub_exp,d=typeof l=="number"&&l<Date.now(),_=[],m=[],p=[];if(d){if(c.length){console.log("[smart_plugins] Subscription expired; handling unauthorized plugins.",{unauthorized_list:c});for(let w of c){if(!i[w.plugin_id]){p.push(w.plugin_id);continue}if(w.core_repo)await yM(e,w)&&m.push(w.plugin_id);else{await kM(e,w.plugin_id)&&_.push(w.plugin_id);continue}}}let k={updated:[],skipped:[],checked:0,removed:_,replaced:m,not_installed:p,unauthorized_count:c.length,sub_exp:l||null};return console.log({update_result:k}),k}let f=a.length,y=[];for(let k of a){if(!k||!k.repo)continue;let w=k.version||"unknown",q=(k.manifest_id||k.repo.replace("/","_")).trim(),E=i[q];!E||!E.version||Eu(E.version,w)&&y.push({item:k,plugin_id:q,local_version:E.version,server_version:w})}if(!y.length)return{updated:[],skipped:[],checked:f};let g=[],v=[];for(let k of y){let{item:w,plugin_id:q,local_version:E,server_version:S}=k;try{let C=await Au(w.repo,s),{files:O,pluginManifest:A}=await _a(C),u=A.id,h=`${e.vault.configDir}/plugins/${u}`;await ua(e.vault.adapter,h,O),g.push(`${w.repo}@${S}`)}catch(C){console.error("[smart_plugins] Failed to auto\u2011update plugin:",{repo:w.repo,plugin_id:q,local_version:E,server_version:S,error:C}),v.push(w.repo)}}if(g.length){let k=g.length===1?"":"s";nm(`Smart Plugins: updated ${g.length} plugin${k}. Please restart Obsidian to apply updates.`)}else v.length||nm("Smart Plugins: no updates applied.");return{updated:g,skipped:v,checked:f}}catch(i){return console.error("[smart_plugins] update_installed_smart_plugins error:",i),nm("Smart Plugins: failed to check for updates. See console for details."),{updated:[],skipped:[],checked:0}}}r(Fg,"update_installed_smart_plugins");async function yM(n,e){let t=await(0,Ai.requestUrl)({url:`https://api.github.com/repos/${e.core_repo}/releases/latest`,method:"GET"}),s=t?.json||{};if(!(s?.tag_name||null))return console.error("[smart_plugins] Failed to get latest core plugin version from GitHub:",{core_repo:e.core_repo,response:t}),null;try{let o=s?.assets?.find(m=>m.name.endsWith(".zip"))?.browser_download_url||null;if(!o)return console.error("[smart_plugins] Failed to find core plugin zip asset in GitHub release:",{core_repo:e.core_repo,release:s}),null;let a=await bM(o),{files:c,pluginManifest:l}=await _a(a),d=e.plugin_id,_=`${n.vault.configDir}/plugins/${d}`;return await ua(n.vault.adapter,_,c),!0}catch(o){return console.error("[smart_plugins] Failed to install core plugin:",{core_repo:e.core_repo,error:o}),null}}r(yM,"replace_pro_with_core");async function bM(n){console.log(`[smart_plugins] download plugin from URL: ${n}`);let e=await(0,Ai.requestUrl)({url:n,method:"GET",headers:{Accept:"application/zip"}});if(e.status&&e.status!==200)throw new Error(`Download error ${e.status}: ${e.text||""}`);return xu(e.arrayBuffer,"Download")}r(bM,"fetch_zip_from_public_url");async function vM(n){let e={},t=n.plugins;if(!t)return e;await t.loadManifests();let s=t.manifests||{};for(let i in s){if(!Object.prototype.hasOwnProperty.call(s,i))continue;let o=s[i]||{};e[i]={id:o.id||i,name:o.name||i,version:o.version||""}}return e}r(vM,"build_installed_plugins_map");function nm(n){try{typeof Ai.Notice=="function"?new Ai.Notice(n):console.log("[smart_plugins]",n)}catch(e){console.log("[smart_plugins] notice error",e,n)}}r(nm,"show_notice");async function kM(n,e){let t=n?.vault?.adapter;if(!t)return!1;let s=`${n.vault.configDir}/plugins/${e}`,i=`${s}/main.js`,o=`${s}/manifest.json`;try{return await t.exists(i)&&await t.remove(i),await t.exists(o)&&await t.remove(o),!0}catch(a){console.error("[smart_plugins] Failed to remove main.js for unauthorized plugin",{plugin_id:e,error:a})}return!1}r(kM,"remove_main_js_for_plugin");var Si=class n extends xi{static{r(this,"SmartEnv")}static version="2.3.8";is_pro=!0;async load(e=!1){await super.load(e),n.wait_for({loaded:!0}).then(async()=>{console.warn("[smart_env] Checking for Smart Plugins updates..."),Fg(this),this._registered_refresh_event||(this._registered_refresh_event=!0,this.events.on("pro_plugins:refresh",async()=>{console.warn("[smart_env] Refreshing Smart Plugins list..."),Fg(this)}))})}},_Pe=Si.version;var qPe=Et(Zd,yS);var im=require("obsidian");function bS(n){return{select_ext:{id:"external-file-codeblock",name:"External source file context codeblock",editorCheckCallback:r((e,t,s)=>{if(n.app.isMobile)return e||new im.Notice("This command is only available on desktop."),!1;if(!e){let o=s.file?.path+"#codeblock",a=n.env.smart_contexts;(a.get(o)||a.new_context({key:o})).emit_event("context_selector:open",{default_suggest_action_keys:["context_suggest_external"]});let l=/```smart-context[\s\S]*?```/g,d=t.getValue();if(!l.test(d)){let _=t.getCursor();t.replaceRange("\n```smart-context\n\n```\n",_)}}return!0},"editorCheckCallback")},copy_current:{id:"copy-current-note-with-depth",name:"Copy current to clipboard (with media)",editorCheckCallback:r((e,t,s)=>{let i=s.file?.path;if(!i)return!1;let o=n.env.smart_sources.get(i);if(!o)return!1;let a=n.env.config.modals?.copy_context_modal?.class;return a?(e||o.actions.source_get_context().then(c=>{if(!c){n.env.events.emit("notification:error",{message:"Failed to build context for current note."}),new im.Notice("Failed to build context for current note.");return}let l=n.env.smart_contexts.get(i+"#codeblock");l&&(c=n.env.smart_contexts.new_context({key:i+"#combined_copy",context_items:{...c.data.context_items,...l.data.context_items}})),new a(c,{with_media:!0}).open()}),!0):!1},"editorCheckCallback")},copy_current_no_media:{id:"copy-current-note-with-depth-text-only",name:"Copy current to clipboard (text only)",editorCheckCallback:r((e,t,s)=>{let i=s.file?.path;if(!i)return!1;let o=n.env.smart_sources.get(i);if(!o)return!1;let a=n.env.config.modals?.copy_context_modal?.class;return a?(e||o.actions.source_get_context().then(c=>{if(!c){n.env.events.emit("notification:error",{message:"Failed to build context for current note."}),new im.Notice("Failed to build context for current note.");return}let l=n.env.smart_contexts.get(i+"#codeblock");l&&(c=n.env.smart_contexts.new_context({key:i+"#combined_copy",context_items:{...c.data.context_items,...l.data.context_items}})),new a(c).open()}),!0):!1},"editorCheckCallback")}}}r(bS,"pro_commands");var xM=xo,om=class extends xM{static{r(this,"SmartContextPlugin")}SmartEnv=Si;onload(){this.app.workspace.onLayoutReady(this.initialize.bind(this)),this.SmartEnv.create(this,fE)}get commands(){return{...super.commands,...bS(this)}}register_commands(){super.register_commands(),Ok(this)}};

const smart_hash_id='b2733ca5b6f933e6d9270fdb1236c755672735a5f45434f868109ef5865bd421';